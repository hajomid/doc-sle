<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Security Guide | openSUSE Leap 42.3</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" /><link rel="stylesheet" type="text/css" href="static/css/brand.css" /><meta name="generator" content="DAPS 2.4.0 using openSUSE XSL Stylesheets 2.0.8 (based on DocBook XSL Stylesheets 1.78.1)" /><meta name="product-name" content="openSUSE Leap" /><meta name="product-number" content="42.3" /><meta name="book-title" content="Security Guide" /><meta name="description" content="Introduces basic concepts of system security, covering both local and network security aspects. Shows how to use the product inherent security software like AppArmor or the auditing system that reliably collects information about any security-relevant events." /><meta name="tracker-url" content="https://bugzilla.opensuse.org/enter_bug.cgi" /><meta name="tracker-type" content="bsc" /><meta name="tracker-bsc-assignee" content="fs@suse.com" /><meta name="tracker-bsc-component" content="Documentation" /><meta name="tracker-bsc-product" content="openSUSE Distribution" /><meta name="tracker-bsc-version" content="Leap 42.2" /><script type="text/javascript">

var protocol = window.location.protocol.toLowerCase();
if ( protocol != 'file:' ) {
  var agent = navigator.userAgent.toLowerCase();
  var wanted = ( protocol == 'https:') ? 'https' : 'http';
  var file = 'fonts.css';
  document.write('<link rel="stylesheet" type="text/css" href="' + wanted + '://static.opensuse.org/fonts/'+ file +'"></link>');
}
else {
   document.write('<link rel="stylesheet" type="text/css" href="static/css/fonts-onlylocal.css"></link>');
}

</script><noscript><link rel="stylesheet" type="text/css" href="http://static.opensuse.org/fonts/fonts.css" /></noscript><script src="static/js/jquery-1.10.2.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft single offline js-off"><div id="_outer-wrap"><div id="_white-bg"><div id="_header"><div id="_logo"><img src="static/images/logo.png" alt="Logo" /></div><div class="crumbs inactive"><a class="single-crumb" href="#book.security" accesskey="c"><span class="single-contents-icon"></span>Security Guide</a><div class="bubble-corner active-contents"></div></div><div class="clearme"></div></div></div><div id="_fixed-header-wrap" class="inactive"><div id="_fixed-header"><div class="crumbs inactive"><a class="single-crumb" href="#book.security" accesskey="c"><span class="single-contents-icon"></span>Show Contents: Security Guide</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="clearme"></div></div><div class="clearme"></div></div><div class="active-contents bubble"><div class="bubble-container"><div id="_bubble-toc"><ol><li class="inactive"><a href="#preface.security"><span class="number"> </span><span class="name">About This Guide</span></a></li><li class="inactive"><a href="#cha.security"><span class="number">1 </span><span class="name">Security and Confidentiality</span></a></li><li class="inactive"><a href="#part.auth"><span class="number">I </span><span class="name">Authentication</span></a><ol><li class="inactive"><a href="#cha.pam"><span class="number">2 </span><span class="name">Authentication with PAM</span></a></li><li class="inactive"><a href="#cha.nis"><span class="number">3 </span><span class="name">Using NIS</span></a></li><li class="inactive"><a href="#cha.security.auth"><span class="number">4 </span><span class="name">Setting Up Authentication Servers and Clients Using YaST</span></a></li><li class="inactive"><a href="#cha.security.ldap"><span class="number">5 </span><span class="name">LDAP—A Directory Service</span></a></li><li class="inactive"><a href="#cha.security.kerberos"><span class="number">6 </span><span class="name">Network Authentication with Kerberos</span></a></li><li class="inactive"><a href="#cha.security.ad"><span class="number">7 </span><span class="name">Active Directory Support</span></a></li></ol></li><li class="inactive"><a href="#part.local_security"><span class="number">II </span><span class="name">Local Security</span></a><ol><li class="inactive"><a href="#cha.security.yast_security"><span class="number">8 </span><span class="name">Configuring Security Settings with YaST</span></a></li><li class="inactive"><a href="#cha.security.policykit"><span class="number">9 </span><span class="name">Authorization with PolKit</span></a></li><li class="inactive"><a href="#cha.security.acls"><span class="number">10 </span><span class="name">Access Control Lists in Linux</span></a></li><li class="inactive"><a href="#cha.security.cryptofs"><span class="number">11 </span><span class="name">Encrypting Partitions and Files</span></a></li><li class="inactive"><a href="#cha.certstore"><span class="number">12 </span><span class="name">Certificate Store</span></a></li><li class="inactive"><a href="#cha.aide"><span class="number">13 </span><span class="name">Intrusion Detection with AIDE</span></a></li></ol></li><li class="inactive"><a href="#part.network_security"><span class="number">III </span><span class="name">Network Security</span></a><ol><li class="inactive"><a href="#cha.xauth"><span class="number">14 </span><span class="name">X Window System and X Authentication</span></a></li><li class="inactive"><a href="#cha.ssh"><span class="number">15 </span><span class="name">SSH: Secure Network Operations</span></a></li><li class="inactive"><a href="#cha.security.firewall"><span class="number">16 </span><span class="name">Masquerading and Firewalls</span></a></li><li class="inactive"><a href="#cha.security.vpnserver"><span class="number">17 </span><span class="name">Configuring a VPN Server</span></a></li><li class="inactive"><a href="#cha.security.yast_ca"><span class="number">18 </span><span class="name">Managing X.509 Certification</span></a></li></ol></li><li class="inactive"><a href="#part.apparmor"><span class="number">IV </span><span class="name">Confining Privileges with <span class="phrase">AppArmor</span></span></a><ol><li class="inactive"><a href="#cha.apparmor.intro"><span class="number">19 </span><span class="name">Introducing <span class="phrase">AppArmor</span></span></a></li><li class="inactive"><a href="#cha.apparmor.start"><span class="number">20 </span><span class="name">Getting Started</span></a></li><li class="inactive"><a href="#cha.apparmor.concept"><span class="number">21 </span><span class="name">Immunizing Programs</span></a></li><li class="inactive"><a href="#cha.apparmor.profiles"><span class="number">22 </span><span class="name">Profile Components and Syntax</span></a></li><li class="inactive"><a href="#cha.apparmor.repos"><span class="number">23 </span><span class="name"><span class="phrase">AppArmor</span> Profile Repositories</span></a></li><li class="inactive"><a href="#cha.apparmor.yast"><span class="number">24 </span><span class="name">Building and Managing Profiles with YaST</span></a></li><li class="inactive"><a href="#cha.apparmor.commandline"><span class="number">25 </span><span class="name">Building Profiles from the Command Line</span></a></li><li class="inactive"><a href="#cha.apparmor.hat"><span class="number">26 </span><span class="name">Profiling Your Web Applications Using ChangeHat</span></a></li><li class="inactive"><a href="#cha.apparmor.pam"><span class="number">27 </span><span class="name">Confining Users with <code class="systemitem">pam_apparmor</code></span></a></li><li class="inactive"><a href="#cha.apparmor.managing"><span class="number">28 </span><span class="name">Managing Profiled Applications</span></a></li><li class="inactive"><a href="#cha.apparmor.support"><span class="number">29 </span><span class="name">Support</span></a></li><li class="inactive"><a href="#cha.apparmor.glossary"><span class="number">30 </span><span class="name"><span class="phrase">AppArmor</span> Glossary</span></a></li></ol></li><li class="inactive"><a href="#part.selinux"><span class="number">V </span><span class="name">SELinux</span></a><ol><li class="inactive"><a href="#cha.selinux"><span class="number">31 </span><span class="name">Configuring SELinux</span></a></li></ol></li><li class="inactive"><a href="#part.audit"><span class="number">VI </span><span class="name"><em class="citetitle ">The Linux Audit Framework</em></span></a><ol><li class="inactive"><a href="#cha.audit.comp"><span class="number">32 </span><span class="name">Understanding Linux Audit</span></a></li><li class="inactive"><a href="#cha.audit.setup"><span class="number">33 </span><span class="name">Setting Up the Linux Audit Framework</span></a></li><li class="inactive"><a href="#cha.audit.scenarios"><span class="number">34 </span><span class="name">Introducing an Audit Rule Set</span></a></li><li class="inactive"><a href="#cha.audit.moreinfo"><span class="number">35 </span><span class="name">Useful Resources</span></a></li></ol></li><li class="inactive"><a href="#idm140712064319152"><span class="number">A </span><span class="name">GNU Licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_toc-bubble-wrap"></div><div id="_content" class="draft "><div class="documentation"><div xml:lang="en" class="book" id="book.security" lang="en"><div class="titlepage"><div><h6 class="version-info"><span class="productname"><span class="productname"><span class="phrase">openSUSE Leap</span></span></span> <span class="productnumber"><span class="productnumber"><span class="phrase">42.3</span></span></span></h6><div><h1 class="title"><em class="citetitle ">Security Guide</em></h1></div><div class="abstract "><p> Introduces basic concepts of system security,
     covering both local and network security aspects. Shows how to use
     the product inherent security software like <span class="phrase">AppArmor</span> or the auditing system
     that reliably collects information about any
     security-relevant events. </p></div><div class="date"><span class="imprint-label">Publication Date: </span>
        April 24, 2018

      </div></div></div><div class="toc"><dl><dt><span class="preface"><a href="#preface.security"><span class="name">About This Guide</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#idm140712085808944"><span class="name">Available Documentation</span></a></span></dt><dt><span class="sect1"><a href="#idm140712085033936"><span class="name">Feedback</span></a></span></dt><dt><span class="sect1"><a href="#idm140712072167728"><span class="name">Documentation Conventions</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security"><span class="number">1 </span><span class="name">Security and Confidentiality</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.overview"><span class="number">1.1 </span><span class="name">Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.passwords"><span class="number">1.2 </span><span class="name">Passwords</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.integrity"><span class="number">1.3 </span><span class="name">System Integrity</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.file_access"><span class="number">1.4 </span><span class="name">File Access</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.network"><span class="number">1.5 </span><span class="name">Networking</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vulnerabilities"><span class="number">1.6 </span><span class="name">Software Vulnerabilities</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.malware"><span class="number">1.7 </span><span class="name">Malware</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.tips"><span class="number">1.8 </span><span class="name">Important Security Tips</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.general.report"><span class="number">1.9 </span><span class="name">Reporting Security Issues</span></a></span></dt></dl></dd><dt><span class="part"><a href="#part.auth"><span class="number">I </span><span class="name">Authentication</span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.pam"><span class="number">2 </span><span class="name">Authentication with PAM</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.pam.whatis"><span class="number">2.1 </span><span class="name">What is PAM?</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.files"><span class="number">2.2 </span><span class="name">Structure of a PAM Configuration File</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.format"><span class="number">2.3 </span><span class="name">The PAM Configuration of sshd</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.conf"><span class="number">2.4 </span><span class="name">Configuration of PAM Modules</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.pam-config"><span class="number">2.5 </span><span class="name">Configuring PAM Using pam-config</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.manual-config"><span class="number">2.6 </span><span class="name">Manually Configuring PAM</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.info"><span class="number">2.7 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.nis"><span class="number">3 </span><span class="name">Using NIS</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.nis.server"><span class="number">3.1 </span><span class="name">Configuring NIS Servers</span></a></span></dt><dt><span class="sect1"><a href="#sec.nis.client"><span class="number">3.2 </span><span class="name">Configuring NIS Clients</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.auth"><span class="number">4 </span><span class="name">Setting Up Authentication Servers and Clients Using YaST</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.auth.yast"><span class="number">4.1 </span><span class="name">Configuring an Authentication Server with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.auth.yast.client"><span class="number">4.2 </span><span class="name">Configuring an Authentication Client with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.auth.sssd"><span class="number">4.3 </span><span class="name">SSSD</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.ldap"><span class="number">5 </span><span class="name">LDAP—A Directory Service</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.ldap.vs_nis"><span class="number">5.1 </span><span class="name">LDAP versus NIS</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.tree"><span class="number">5.2 </span><span class="name">Structure of an LDAP Directory Tree</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.yast.client"><span class="number">5.3 </span><span class="name">Configuring an LDAP Client with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.yast.usergr"><span class="number">5.4 </span><span class="name">Configuring LDAP Users and Groups in YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.slapd"><span class="number">5.5 </span><span class="name">Manually Configuring an LDAP Server</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.data"><span class="number">5.6 </span><span class="name">Manually Administering LDAP Data</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.info"><span class="number">5.7 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.kerberos"><span class="number">6 </span><span class="name">Network Authentication with Kerberos</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.kerberos.overview"><span class="number">6.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.terms"><span class="number">6.2 </span><span class="name">Kerberos Terminology</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.how"><span class="number">6.3 </span><span class="name">How Kerberos Works</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.users"><span class="number">6.4 </span><span class="name">User View of Kerberos</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.admin"><span class="number">6.5 </span><span class="name">Installing and Administering Kerberos</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.yast.client"><span class="number">6.6 </span><span class="name">Setting up Kerberos using <span class="guimenu">LDAP and Kerberos Client</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.nfs"><span class="number">6.7 </span><span class="name">Kerberos and NFS</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.info"><span class="number">6.8 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.ad"><span class="number">7 </span><span class="name">Active Directory Support</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.ad.integrate"><span class="number">7.1 </span><span class="name">Integrating Linux and Active Directory Environments</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.background"><span class="number">7.2 </span><span class="name">Background Information for Linux Active Directory Support</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.config"><span class="number">7.3 </span><span class="name">Configuring a Linux Client for Active Directory</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.login"><span class="number">7.4 </span><span class="name">Logging In to an Active Directory Domain</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.passwd"><span class="number">7.5 </span><span class="name">Changing Passwords</span></a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#part.local_security"><span class="number">II </span><span class="name">Local Security</span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.security.yast_security"><span class="number">8 </span><span class="name">Configuring Security Settings with YaST</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.yast_security.overview"><span class="number">8.1 </span><span class="name"><span class="guimenu">Security Overview</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.predefined_configs"><span class="number">8.2 </span><span class="name"><span class="guimenu">Predefined Security Configurations</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.password"><span class="number">8.3 </span><span class="name"><span class="guimenu">Password Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.boot"><span class="number">8.4 </span><span class="name"><span class="guimenu">Boot Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.login"><span class="number">8.5 </span><span class="name"><span class="guimenu">Login Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.user"><span class="number">8.6 </span><span class="name"><span class="guimenu">User Addition</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.misc"><span class="number">8.7 </span><span class="name"><span class="guimenu">Miscellaneous Settings</span></span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.policykit"><span class="number">9 </span><span class="name">Authorization with PolKit</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.policykit.oview"><span class="number">9.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.types"><span class="number">9.2 </span><span class="name">Authorization Types</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.query"><span class="number">9.3 </span><span class="name">Querying Privileges</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.change.modify_config"><span class="number">9.4 </span><span class="name">Modifying Configuration Files</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.change.defaults"><span class="number">9.5 </span><span class="name">Restoring the Default Privileges</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.acls"><span class="number">10 </span><span class="name">Access Control Lists in Linux</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.acls.traditional"><span class="number">10.1 </span><span class="name">Traditional File Permissions</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.intro"><span class="number">10.2 </span><span class="name">Advantages of ACLs</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.defs"><span class="number">10.3 </span><span class="name">Definitions</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.handle"><span class="number">10.4 </span><span class="name">Handling ACLs</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.future"><span class="number">10.5 </span><span class="name">ACL Support in Applications</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.info"><span class="number">10.6 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.cryptofs"><span class="number">11 </span><span class="name">Encrypting Partitions and Files</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.cryptofs.y2"><span class="number">11.1 </span><span class="name">Setting Up an Encrypted File System with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.cryptofs.gpg"><span class="number">11.2 </span><span class="name">Encrypting Files with GPG</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.certstore"><span class="number">12 </span><span class="name">Certificate Store</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.certstore.activate"><span class="number">12.1 </span><span class="name">Activating Certificate Store</span></a></span></dt><dt><span class="sect1"><a href="#sec.certstore.import"><span class="number">12.2 </span><span class="name">Importing Certificates</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.aide"><span class="number">13 </span><span class="name">Intrusion Detection with AIDE</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.aide.why"><span class="number">13.1 </span><span class="name">Why Use AIDE?</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.setup"><span class="number">13.2 </span><span class="name">Setting Up an AIDE Database</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.check"><span class="number">13.3 </span><span class="name">Local AIDE Checks</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.independent"><span class="number">13.4 </span><span class="name">System Independent Checking</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.more"><span class="number">13.5 </span><span class="name">For More Information</span></a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#part.network_security"><span class="number">III </span><span class="name">Network Security</span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.xauth"><span class="number">14 </span><span class="name">X Window System and X Authentication</span></a></span></dt><dt><span class="chapter"><a href="#cha.ssh"><span class="number">15 </span><span class="name">SSH: Secure Network Operations</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.ssh.programm"><span class="number">15.1 </span><span class="name"><code class="command">ssh</code>—Secure Shell</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.copy"><span class="number">15.2 </span><span class="name"><code class="command">scp</code>—Secure Copy</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.sftp"><span class="number">15.3 </span><span class="name"><code class="command">sftp</code>—Secure File Transfer</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.sshdserver"><span class="number">15.4 </span><span class="name">The SSH Daemon (<code class="systemitem">sshd</code>)</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.authentic"><span class="number">15.5 </span><span class="name">SSH Authentication Mechanisms</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.port-forwarding"><span class="number">15.6 </span><span class="name">Port Forwarding</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ssh.moreinfo"><span class="number">15.7 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.firewall"><span class="number">16 </span><span class="name">Masquerading and Firewalls</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.firewall.iptables"><span class="number">16.1 </span><span class="name">Packet Filtering with iptables</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.masq"><span class="number">16.2 </span><span class="name">Masquerading Basics</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.fw"><span class="number">16.3 </span><span class="name">Firewalling Basics</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.firewalld"><span class="number">16.4 </span><span class="name"><code class="systemitem">firewalld</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.info"><span class="number">16.5 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.vpnserver"><span class="number">17 </span><span class="name">Configuring a VPN Server</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.vpn.overview"><span class="number">17.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.simplest"><span class="number">17.2 </span><span class="name">Setting Up a Simple Test Scenario</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.ca"><span class="number">17.3 </span><span class="name">Setting Up Your VPN Server Using a Certificate Authority</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yastvpn"><span class="number">17.4 </span><span class="name">Setting Up a VPN Server or Client Using YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.moreinfo"><span class="number">17.5 </span><span class="name">For More Information</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.security.yast_ca"><span class="number">18 </span><span class="name">Managing X.509 Certification</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.security.yast_ca.intro"><span class="number">18.1 </span><span class="name">The Principles of Digital Certification</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_ca.module"><span class="number">18.2 </span><span class="name">YaST Modules for CA Management</span></a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#part.apparmor"><span class="number">IV </span><span class="name">Confining Privileges with <span class="phrase">AppArmor</span></span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.apparmor.intro"><span class="number">19 </span><span class="name">Introducing <span class="phrase">AppArmor</span></span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#idm140712067753712"><span class="number">19.1 </span><span class="name"><span class="phrase">AppArmor</span> Components</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.intro.background"><span class="number">19.2 </span><span class="name">Background Information on <span class="phrase">AppArmor</span> Profiling</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.start"><span class="number">20 </span><span class="name">Getting Started</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.start.install"><span class="number">20.1 </span><span class="name">Installing <span class="phrase">AppArmor</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.enable"><span class="number">20.2 </span><span class="name">Enabling and Disabling <span class="phrase">AppArmor</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.choose"><span class="number">20.3 </span><span class="name">Choosing Applications to Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.build"><span class="number">20.4 </span><span class="name">Building and Modifying Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.update"><span class="number">20.5 </span><span class="name">Updating Your Profiles</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.concept"><span class="number">21 </span><span class="name">Immunizing Programs</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.concept.tools"><span class="number">21.1 </span><span class="name">Introducing the <span class="phrase">AppArmor</span> Framework</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.determine"><span class="number">21.2 </span><span class="name">Determining Programs to Immunize</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.cron"><span class="number">21.3 </span><span class="name">Immunizing <code class="systemitem">cron</code> Jobs</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.network"><span class="number">21.4 </span><span class="name">Immunizing Network Applications</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.profiles"><span class="number">22 </span><span class="name">Profile Components and Syntax</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.profiles.parts"><span class="number">22.1 </span><span class="name">Breaking an <span class="phrase">AppArmor</span> Profile into Its Parts</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.types"><span class="number">22.2 </span><span class="name">Profile Types</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.includes"><span class="number">22.3 </span><span class="name">Include Statements</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.capabilities"><span class="number">22.4 </span><span class="name">Capability Entries (POSIX.1e)</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.nac"><span class="number">22.5 </span><span class="name">Network Access Control</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.glob"><span class="number">22.6 </span><span class="name">Profile Names, Flags, Paths, and Globbing</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.perm"><span class="number">22.7 </span><span class="name">File Permission Access Modes</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.exec"><span class="number">22.8 </span><span class="name">Execute Modes</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.rlimit"><span class="number">22.9 </span><span class="name">Resource Limit Control</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.audit"><span class="number">22.10 </span><span class="name">Auditing Rules</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.repos"><span class="number">23 </span><span class="name"><span class="phrase">AppArmor</span> Profile Repositories</span></a></span></dt><dt><span class="chapter"><a href="#cha.apparmor.yast"><span class="number">24 </span><span class="name">Building and Managing Profiles with YaST</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.yast.add"><span class="number">24.1 </span><span class="name">Manually Adding a Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.edit"><span class="number">24.2 </span><span class="name">Editing Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.del"><span class="number">24.3 </span><span class="name">Deleting a Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.manage"><span class="number">24.4 </span><span class="name">Managing <span class="phrase">AppArmor</span></span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.commandline"><span class="number">25 </span><span class="name">Building Profiles from the Command Line</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.commandline.status"><span class="number">25.1 </span><span class="name">Checking the <span class="phrase">AppArmor</span> Status</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.build"><span class="number">25.2 </span><span class="name">Building <span class="phrase">AppArmor</span> Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.add"><span class="number">25.3 </span><span class="name">Adding or Creating an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.edit"><span class="number">25.4 </span><span class="name">Editing an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.unload"><span class="number">25.5 </span><span class="name">Unloading Unknown <span class="phrase">AppArmor</span> Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.del"><span class="number">25.6 </span><span class="name">Deleting an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.profiling"><span class="number">25.7 </span><span class="name">Two Methods of Profiling</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.filenames"><span class="number">25.8 </span><span class="name">Important File Names and Directories</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.hat"><span class="number">26 </span><span class="name">Profiling Your Web Applications Using ChangeHat</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.hat.config"><span class="number">26.1 </span><span class="name">Configuring Apache for <code class="systemitem">mod_apparmor</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.hat.apache.managing"><span class="number">26.2 </span><span class="name">Managing ChangeHat-Aware Applications</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.pam"><span class="number">27 </span><span class="name">Confining Users with <code class="systemitem">pam_apparmor</code></span></a></span></dt><dt><span class="chapter"><a href="#cha.apparmor.managing"><span class="number">28 </span><span class="name">Managing Profiled Applications</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.managing.react"><span class="number">28.1 </span><span class="name">Reacting to Security Event Rejections</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.managing.maintain"><span class="number">28.2 </span><span class="name">Maintaining Your Security Profiles</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.support"><span class="number">29 </span><span class="name">Support</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.apparmor.support.updating"><span class="number">29.1 </span><span class="name">Updating <span class="phrase">AppArmor</span> Online</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.man"><span class="number">29.2 </span><span class="name">Using the Man Pages</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.info"><span class="number">29.3 </span><span class="name">For More Information</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.trouble"><span class="number">29.4 </span><span class="name">Troubleshooting</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.bugs"><span class="number">29.5 </span><span class="name">Reporting Bugs for <span class="phrase">AppArmor</span></span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.apparmor.glossary"><span class="number">30 </span><span class="name"><span class="phrase">AppArmor</span> Glossary</span></a></span></dt></dl></dd><dt><span class="part"><a href="#part.selinux"><span class="number">V </span><span class="name">SELinux</span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.selinux"><span class="number">31 </span><span class="name">Configuring SELinux</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.selinux.why"><span class="number">31.1 </span><span class="name">Why Use SELinux?</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.policy"><span class="number">31.2 </span><span class="name">Policy</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.install"><span class="number">31.3 </span><span class="name">Installing SELinux Packages and Modifying GRUB 2</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.compilepolicy"><span class="number">31.4 </span><span class="name">SELinux Policy</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.configure"><span class="number">31.5 </span><span class="name">Configuring SELinux</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.manage"><span class="number">31.6 </span><span class="name">Managing SELinux</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.troubleshoot"><span class="number">31.7 </span><span class="name">Troubleshooting</span></a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#part.audit"><span class="number">VI </span><span class="name"><em class="citetitle ">The Linux Audit Framework</em></span></a></span></dt><dd><dl><dt><span class="chapter"><a href="#cha.audit.comp"><span class="number">32 </span><span class="name">Understanding Linux Audit</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.audit.bigpicture"><span class="number">32.1 </span><span class="name">Introducing the Components of Linux Audit</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auditd"><span class="number">32.2 </span><span class="name">Configuring the Audit Daemon</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auditctl"><span class="number">32.3 </span><span class="name">Controlling the Audit System Using <code class="command">auditctl</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.rules"><span class="number">32.4 </span><span class="name">Passing Parameters to the Audit System</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aureport"><span class="number">32.5 </span><span class="name">Understanding the Audit Logs and Generating Reports</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.ausearch"><span class="number">32.6 </span><span class="name">Querying the Audit Daemon Logs with <code class="command">ausearch</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.autrace"><span class="number">32.7 </span><span class="name">Analyzing Processes with <code class="command">autrace</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auviz"><span class="number">32.8 </span><span class="name">Visualizing Audit Data</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.audisp"><span class="number">32.9 </span><span class="name">Relaying Audit Event Notifications</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.audit.setup"><span class="number">33 </span><span class="name">Setting Up the Linux Audit Framework</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.audit.choose"><span class="number">33.1 </span><span class="name">Determining the Components to Audit</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.config"><span class="number">33.2 </span><span class="name">Configuring the Audit Daemon</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.syscall"><span class="number">33.3 </span><span class="name">Enabling Audit for System Calls</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aurules"><span class="number">33.4 </span><span class="name">Setting Up Audit Rules</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aurepo"><span class="number">33.5 </span><span class="name">Configuring Audit Reports</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.viz"><span class="number">33.6 </span><span class="name">Configuring Log Visualization</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.audit.scenarios"><span class="number">34 </span><span class="name">Introducing an Audit Rule Set</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#sec.audit.scenbasic"><span class="number">34.1 </span><span class="name">Adding Basic Audit Configuration Parameters</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenauconf"><span class="number">34.2 </span><span class="name">Adding Watches on Audit Log Files and Configuration Files</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenfs"><span class="number">34.3 </span><span class="name">Monitoring File System Objects</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scensecurity"><span class="number">34.4 </span><span class="name">Monitoring Security Configuration Files and Databases</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenmisc"><span class="number">34.5 </span><span class="name">Monitoring Miscellaneous System Calls</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenipc"><span class="number">34.6 </span><span class="name">Filtering System Call Arguments</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenkeys"><span class="number">34.7 </span><span class="name">Managing Audit Event Records Using Keys</span></a></span></dt></dl></dd><dt><span class="chapter"><a href="#cha.audit.moreinfo"><span class="number">35 </span><span class="name">Useful Resources</span></a></span></dt></dl></dd><dt><span class="appendix"><a href="#idm140712064319152"><span class="number">A </span><span class="name">GNU Licenses</span></a></span></dt><dd><dl><dt><span class="sect1"><a href="#idm140712064314512"><span class="number">A.1 </span><span class="name">GNU Free Documentation License</span></a></span></dt></dl></dd></dl></div><div class="list-of-figures"><div class="toc-title">List of Figures</div><dl><dt><span class="figure"><a href="#fig.inst.nisserver1"><span class="number">3.1 </span><span class="name">NIS Server Setup</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.nis.master"><span class="number">3.2 </span><span class="name">Master Server Setup</span></a></span></dt><dt><span class="figure"><a href="#fig.inst.nisserver2"><span class="number">3.3 </span><span class="name">Changing the Directory and Synchronizing Files for a NIS Server</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.nis.maps"><span class="number">3.4 </span><span class="name">NIS Server Maps Setup</span></a></span></dt><dt><span class="figure"><a href="#fig.inst.nisserver3"><span class="number">3.5 </span><span class="name">Setting Request Permissions for a NIS Server</span></a></span></dt><dt><span class="figure"><a href="#fig.inst.nisclient"><span class="number">3.6 </span><span class="name">Setting Domain and Address of a NIS Server</span></a></span></dt><dt><span class="figure"><a href="#fig.auth.y2.wizard.general.settings"><span class="number">4.1 </span><span class="name">YaST Authentication Server Configuration</span></a></span></dt><dt><span class="figure"><a href="#fig.auth.y2.wizard.db.settings"><span class="number">4.2 </span><span class="name">YaST LDAP Server—New Database</span></a></span></dt><dt><span class="figure"><a href="#fig.auth.y2.wizard.kerberos.yes"><span class="number">4.3 </span><span class="name">YaST Kerberos Authentication</span></a></span></dt><dt><span class="figure"><a href="#fig.auth.y2.server.cfg"><span class="number">4.4 </span><span class="name">YaST Editing Authentication Server Configuration</span></a></span></dt><dt><span class="figure"><a href="#fig.auth.y2.server.db.cfg"><span class="number">4.5 </span><span class="name">YaST Authentication Server Database Configuration</span></a></span></dt><dt><span class="figure"><a href="#fig.ldap.tree"><span class="number">5.1 </span><span class="name">Structure of an LDAP Directory</span></a></span></dt><dt><span class="figure"><a href="#fig.yast2.ldapkerberos.ldap"><span class="number">5.2 </span><span class="name"><span class="guimenu">LDAP and Kerberos Client</span> Window</span></a></span></dt><dt><span class="figure"><a href="#fig.netw.kerb"><span class="number">6.1 </span><span class="name">Kerberos Network Topology</span></a></span></dt><dt><span class="figure"><a href="#fig.yast2.ldapkerberos.kerberos"><span class="number">6.2 </span><span class="name"><span class="guimenu">LDAP and Kerberos Client</span> Window</span></a></span></dt><dt><span class="figure"><a href="#fig.ad.schema"><span class="number">7.1 </span><span class="name">Schema of Winbind-based Active Directory Authentication</span></a></span></dt><dt><span class="figure"><a href="#fig.security.logonmanagement"><span class="number">7.2 </span><span class="name">Main Window of <span class="guimenu">User Logon Management</span></span></a></span></dt><dt><span class="figure"><a href="#fig.security.logonmanagement.enroll"><span class="number">7.3 </span><span class="name">Enrolling into a Domain</span></a></span></dt><dt><span class="figure"><a href="#fig.security.logonmanagement.configure"><span class="number">7.4 </span><span class="name">Configuration Window of <span class="guimenu">User Logon Management</span></span></a></span></dt><dt><span class="figure"><a href="#fig.ad.smbclient"><span class="number">7.5 </span><span class="name">Determining Windows Domain Membership</span></a></span></dt><dt><span class="figure"><a href="#fig.ad.join1"><span class="number">7.6 </span><span class="name">Providing Administrator Credentials</span></a></span></dt><dt><span class="figure"><a href="#fig.yast_security.overview"><span class="number">8.1 </span><span class="name">YaST Security Center and Hardening: Security Overview</span></a></span></dt><dt><span class="figure"><a href="#fig.acls.map.mini"><span class="number">10.1 </span><span class="name">Minimum ACL: ACL Entries Compared to Permission Bits</span></a></span></dt><dt><span class="figure"><a href="#fig.acls.map.ext"><span class="number">10.2 </span><span class="name">Extended ACL: ACL Entries Compared to Permission Bits</span></a></span></dt><dt><span class="figure"><a href="#fig.fire.table"><span class="number">16.1 </span><span class="name">iptables: A Packet's Possible Paths</span></a></span></dt><dt><span class="figure"><a href="#fig.vpn.scenario-routed-1"><span class="number">17.1 </span><span class="name">Routed VPN</span></a></span></dt><dt><span class="figure"><a href="#fig.vpn.scenario-briged-1"><span class="number">17.2 </span><span class="name">Bridged VPN - Scenario 1</span></a></span></dt><dt><span class="figure"><a href="#fig.vpn.scenario-briged-2"><span class="number">17.3 </span><span class="name">Bridged VPN - Scenario 2</span></a></span></dt><dt><span class="figure"><a href="#fig.vpn.scenario-briged-3"><span class="number">17.4 </span><span class="name">Bridged VPN - Scenario 3</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.ca.ca_basic"><span class="number">18.1 </span><span class="name">YaST CA Module—Basic Data for a Root CA</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.ca.usage"><span class="number">18.2 </span><span class="name">YaST CA Module—Using a CA</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.ca.cert"><span class="number">18.3 </span><span class="name">Certificates of a CA</span></a></span></dt><dt><span class="figure"><a href="#fig.yast.ca.extensions"><span class="number">18.4 </span><span class="name">YaST CA Module—Extended Settings</span></a></span></dt><dt><span class="figure"><a href="#idm140712066210080"><span class="number">25.1 </span><span class="name"><code class="command">aa-notify Message in GNOME</code></span></a></span></dt><dt><span class="figure"><a href="#idm140712066081408"><span class="number">26.1 </span><span class="name">Adminer Login Page</span></a></span></dt><dt><span class="figure"><a href="#fig.packages.yast"><span class="number">31.1 </span><span class="name">Selecting all SELinux Packages in YaST</span></a></span></dt><dt><span class="figure"><a href="#fig.audit.components"><span class="number">32.1 </span><span class="name">Introducing the Components of Linux Audit</span></a></span></dt><dt><span class="figure"><a href="#fig.audit.mkgraph"><span class="number">32.2 </span><span class="name">Flow Graph—Program versus System Call Relationship</span></a></span></dt><dt><span class="figure"><a href="#fig.audit.mkbar"><span class="number">32.3 </span><span class="name">Bar Chart—Common Event Types</span></a></span></dt></dl></div><div class="list-of-tables"><div class="toc-title">List of Tables</div><dl><dt><span class="table"><a href="#tab.ldap.schema"><span class="number">5.1 </span><span class="name">Commonly Used Object Classes and Attributes</span></a></span></dt><dt><span class="table"><a href="#tab.entrytype"><span class="number">10.1 </span><span class="name">ACL Entry Types</span></a></span></dt><dt><span class="table"><a href="#tab.mask"><span class="number">10.2 </span><span class="name">Masking Access Permissions</span></a></span></dt><dt><span class="table"><a href="#tab.aide.options"><span class="number">13.1 </span><span class="name">Important AIDE Check Boxes</span></a></span></dt><dt><span class="table"><a href="#idm140712068746272"><span class="number">15.1 </span><span class="name"></span></a></span></dt><dt><span class="table"><a href="#tab.security.firewall.sysconfigports"><span class="number">16.1 </span><span class="name">Important Sysconfig Variables for Static Port Configuration</span></a></span></dt><dt><span class="table"><a href="#tab.yast.ca.intro.x509"><span class="number">18.1 </span><span class="name">X.509v3 Certificate</span></a></span></dt><dt><span class="table"><a href="#tab.yast.ca.intro.crl"><span class="number">18.2 </span><span class="name">X.509 Certificate Revocation List (CRL)</span></a></span></dt><dt><span class="table"><a href="#tab.yast.ca.ldap.password"><span class="number">18.3 </span><span class="name">Passwords during LDAP Export</span></a></span></dt><dt><span class="table"><a href="#idm140712065932192"><span class="number">29.1 </span><span class="name">Man Pages: Sections and Categories</span></a></span></dt><dt><span class="table"><a href="#tab.audit.auditctl"><span class="number">32.1 </span><span class="name">Audit Status Flags</span></a></span></dt></dl></div><div class="list-of-examples"><div class="toc-title">List of Examples</div><dl><dt><span class="example"><a href="#dat.pam.sshd"><span class="number">2.1 </span><span class="name">PAM Configuration for sshd (<code class="filename">/etc/pam.d/sshd</code>)</span></a></span></dt><dt><span class="example"><a href="#dat.pam.common-auth"><span class="number">2.2 </span><span class="name">Default Configuration for the <code class="literal">auth</code> Section (<code class="filename">common-auth</code>)</span></a></span></dt><dt><span class="example"><a href="#dat.pam.common-account"><span class="number">2.3 </span><span class="name">Default Configuration for the <code class="literal">account</code> Section (<code class="filename">common-account</code>)</span></a></span></dt><dt><span class="example"><a href="#dat.pam.common-password"><span class="number">2.4 </span><span class="name">Default Configuration for the <code class="literal">password</code> Section (<code class="filename">common-password</code>)</span></a></span></dt><dt><span class="example"><a href="#dat.pam.common-session"><span class="number">2.5 </span><span class="name">Default Configuration for the <code class="literal">session</code> Section (<code class="filename">common-session</code>)</span></a></span></dt><dt><span class="example"><a href="#dat.pam.pamenv"><span class="number">2.6 </span><span class="name">pam_env.conf</span></a></span></dt><dt><span class="example"><a href="#aus.ldap.schema.help"><span class="number">5.1 </span><span class="name">Excerpt from schema.core</span></a></span></dt><dt><span class="example"><a href="#dat.ldap.ldif"><span class="number">5.2 </span><span class="name">An LDIF File</span></a></span></dt><dt><span class="example"><a href="#aus.ldap.addentry"><span class="number">5.3 </span><span class="name">ldapadd with example.ldif</span></a></span></dt><dt><span class="example"><a href="#aus.ldap.addtux"><span class="number">5.4 </span><span class="name">LDIF Data for Tux</span></a></span></dt><dt><span class="example"><a href="#aus.ldap.ldif.tux"><span class="number">5.5 </span><span class="name">Modified LDIF File tux.ldif</span></a></span></dt><dt><span class="example"><a href="#ex.security.firewall.nfscallback"><span class="number">16.1 </span><span class="name">callback port configuration for the <code class="literal">nfs</code> kernel module in <code class="filename">/etc/modprobe.d/60-nfs.conf</code></span></a></span></dt><dt><span class="example"><a href="#ex.security.firewall.newrpcservice"><span class="number">16.2 </span><span class="name">Commands to Define a new <code class="systemitem">firewalld</code> RPC Service for NFS</span></a></span></dt><dt><span class="example"><a href="#ex.vpn.serv-config"><span class="number">17.1 </span><span class="name">VPN Server Configuration File</span></a></span></dt><dt><span class="example"><a href="#idm140712068107424"><span class="number">17.2 </span><span class="name">VPN Client Configuration File</span></a></span></dt><dt><span class="example"><a href="#ex.unconfined"><span class="number">20.1 </span><span class="name">Output of <code class="command">aa-unconfined</code></span></a></span></dt><dt><span class="example"><a href="#ex.apparmor.commandline.profiling.summary.genprof.learn"><span class="number">25.1 </span><span class="name">Learning Mode Exception: Controlling Access to Specific Resources</span></a></span></dt><dt><span class="example"><a href="#ex.apparmor.commandline.profiling.summary.genprof.perms"><span class="number">25.2 </span><span class="name">Learning Mode Exception: Defining Permissions for an Entry</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.con.set"><span class="number">31.1 </span><span class="name">Security Context Settings Using <code class="command">ls -Z</code></span></a></span></dt><dt><span class="example"><a href="#ex.selnx.sestatus"><span class="number">31.2 </span><span class="name">Verifying that SELinux is functional</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.ls.bool"><span class="number">31.3 </span><span class="name">Getting a List of Booleans and Verifying Policy Access</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.fcon"><span class="number">31.4 </span><span class="name">Getting File Context Information</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.def.con"><span class="number">31.5 </span><span class="name">The default context for directories in the root directory</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.set.proc"><span class="number">31.6 </span><span class="name">Showing SELinux settings for processes with <code class="command">ps Zaux</code></span></a></span></dt><dt><span class="example"><a href="#ex.selnx.semanage"><span class="number">31.7 </span><span class="name">Viewing Default File Contexts</span></a></span></dt><dt><span class="example"><a href="#ex.selnx.li.auditlog"><span class="number">31.8 </span><span class="name">Example Lines from <code class="filename">/etc/audit/audit.log</code></span></a></span></dt><dt><span class="example"><a href="#idm140712065434672"><span class="number">31.9 </span><span class="name">Analyzing Audit Messages</span></a></span></dt><dt><span class="example"><a href="#idm140712065426480"><span class="number">31.10 </span><span class="name">Viewing Which Lines Deny Access</span></a></span></dt><dt><span class="example"><a href="#idm140712065420896"><span class="number">31.11 </span><span class="name">Creating a Policy Module Allowing an Action Previously Denied</span></a></span></dt><dt><span class="example"><a href="#ex.auditctl.status"><span class="number">32.1 </span><span class="name">Example output of <code class="command">auditctl</code> <code class="option">-s</code></span></a></span></dt><dt><span class="example"><a href="#ex.audit.rules.sysparam"><span class="number">32.2 </span><span class="name">Example Audit Rules—Audit System Parameters</span></a></span></dt><dt><span class="example"><a href="#ex.audit.rules.fs"><span class="number">32.3 </span><span class="name">Example Audit Rules—File System Auditing</span></a></span></dt><dt><span class="example"><a href="#ex.audit.rules.syscall"><span class="number">32.4 </span><span class="name">Example Audit Rules—System Call Auditing</span></a></span></dt><dt><span class="example"><a href="#ex.audit.ruledel"><span class="number">32.5 </span><span class="name">Deleting Audit Rules and Events</span></a></span></dt><dt><span class="example"><a href="#idm140712065083760"><span class="number">32.6 </span><span class="name">Listing Rules with <code class="command">auditctl</code> <code class="option">-l</code></span></a></span></dt><dt><span class="example"><a href="#ex.audit.aureport.logtrail"><span class="number">32.7 </span><span class="name">A Simple Audit Event—Viewing the Audit Log</span></a></span></dt><dt><span class="example"><a href="#ex.audit.aureport.sshd"><span class="number">32.8 </span><span class="name">An Advanced Audit Event—Login via SSH</span></a></span></dt><dt><span class="example"><a href="#idm140712064720208"><span class="number">32.9 </span><span class="name">Example /etc/audisp/audispd.conf</span></a></span></dt><dt><span class="example"><a href="#idm140712064695200"><span class="number">32.10 </span><span class="name">Example /etc/audisp/plugins.d/syslog.conf</span></a></span></dt></dl></div><div><div class="legalnotice" id="idm140712072113776"><p>
  Copyright © 2006–
2018

  SUSE LLC and contributors. All rights reserved.
 </p><p>
  Permission is granted to copy, distribute and/or modify this document under
  the terms of the GNU Free Documentation License, Version 1.2 or (at your
  option) version 1.3; with the Invariant Section being this copyright notice
  and license. A copy of the license version 1.2 is included in the section
  entitled <span class="quote">“<span class="quote">GNU Free Documentation License</span>”</span>.
 </p><p>
  For SUSE trademarks, see
  <a class="link" href="http://www.suse.com/company/legal/" target="_blank">http://www.suse.com/company/legal/</a>. All other
  third-party trademarks are the property of their respective owners. Trademark
  symbols (®, ™ etc.) denote trademarks of SUSE and its affiliates.
  Asterisks (*) denote third-party trademarks.
 </p><p>
  All information found in this book has been compiled with utmost attention to
  detail. However, this does not guarantee complete accuracy. Neither SUSE LLC,
  its affiliates, the authors nor the translators shall be held liable for
  possible errors or the consequences thereof.
 </p></div></div><div class="preface " id="preface.security"><div class="titlepage"><div><div><h1 class="title"><span class="number"> </span><span class="name">About This Guide</span> <a title="Permalink" class="permalink" href="#preface.security">#</a></h1><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_intro.xml</li><li><span class="ds-label">ID: </span>preface.security</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#idm140712085808944"><span class="name">Available Documentation</span></a></span></dt><dt><span class="sect1"><a href="#idm140712085033936"><span class="name">Feedback</span></a></span></dt><dt><span class="sect1"><a href="#idm140712072167728"><span class="name">Documentation Conventions</span></a></span></dt></dl></div></div><p>
  This manual introduces the basic concepts of system security on
  <span class="productname"><span class="phrase">openSUSE Leap</span></span>. It covers extensive documentation about the
  authentication mechanisms available on Linux, such as NIS or LDAP. It
  deals with aspects of local security like access control lists,
  encryption and intrusion detection. In the network security part you
  learn how to secure computers with firewalls and masquerading, and how
  to set up virtual private networks (VPN). This manual shows how to use
  security software like <span class="phrase">AppArmor</span> (which lets you specify per program which
  files the program may read, write, and execute) or the auditing system
  that collects information about security-relevant events.
 </p><div class="sect1 " id="idm140712085808944"><div class="titlepage"><div><div><h2 class="title" id="idm140712085808944"><span class="number">1 </span><span class="name">Available Documentation</span> <a title="Permalink" class="permalink" href="#idm140712085808944">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>common_intro_available_doc_i.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><div id="idm140712072145792" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Online Documentation and Latest Updates</h6><p>
   Documentation for our products is available at
   <span class="phrase"><a class="link" href="http://doc.opensuse.org/" target="_blank">http://doc.opensuse.org/</a></span>, where you can also
   find the latest updates, and browse or download the documentation in various formats.
   
  </p></div><p>
  In addition, the product documentation
  is usually available in your installed system under
  <code class="filename">/usr/share/doc/manual</code>.
 </p><p>
  The following documentation is available for this product:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712085812576"><span class="term "><span class="intraxref">Book “<em class="citetitle ">Start-Up</em>”</span>
   </span></dt><dd><p>
     This manual will see you through your
     initial contact with <span class="productname"><span class="phrase">openSUSE® Leap</span></span>. Check out the various parts of this manual to learn how to install, use and enjoy your system.
    </p></dd><dt id="idm140712085087408"><span class="term "><span class="intraxref">Book “<em class="citetitle ">Reference</em>”</span>
   </span></dt><dd><p>
     Covers system administration tasks like maintaining,
     monitoring and customizing an initially installed system.
    </p></dd><dt id="idm140712082956992"><span class="term "><span class="intraxref">Book “<em class="citetitle ">Virtualization Guide</em>”</span>
   </span></dt><dd><p>
     Describes virtualization technology in
    general, and introduces libvirt—the unified interface to
    virtualization—and detailed information on specific
    hypervisors.
    </p></dd><dt id="idm140712072168992"><span class="term "><span class="intraxref">Book “<em class="citetitle ">AutoYaST Guide</em>”</span>
   </span></dt><dd><p>
     AutoYaST is a system for unattended mass deployment <span class="productname"><span class="phrase">openSUSE Leap</span></span>
     systems using an AutoYaST
     profile containing installation and configuration data. The manual
     guides you through the basic steps of auto-installation: preparation,
     installation, and configuration.
    </p></dd><dt id="idm140712084730304"><span class="term "><a class="xref" href="#book.security" title="Security Guide"><em class="citetitle ">Security Guide</em></a>
   </span></dt><dd><p>
     Introduces basic concepts of system security,
     covering both local and network security aspects. Shows how to use
     the product inherent security software like <span class="phrase">AppArmor</span> or the auditing system
     that reliably collects information about any
     security-relevant events.
    </p></dd><dt id="idm140712085037392"><span class="term "><span class="intraxref">Book “<em class="citetitle ">System Analysis and Tuning Guide</em>”</span>
   </span></dt><dd><p>
     An administrator's guide for problem detection,
     resolution and optimization. Find how to inspect and optimize your system
     by means of monitoring tools and how to efficiently manage
     resources. Also contains an overview of common problems and solutions and
     of additional help and documentation resources.
    </p></dd><dt id="idm140712082645216"><span class="term "><span class="intraxref">Book “<em class="citetitle ">GNOME User Guide</em>”</span>
   </span></dt><dd><p>
     Introduces the GNOME desktop of <span class="productname"><span class="phrase">openSUSE Leap</span></span>. It
     guides you through using and configuring the desktop and helps you
     perform key tasks. It is intended mainly for end users who want to make
     efficient use of GNOME as their default desktop.
    </p></dd></dl></div></div><div class="sect1 " id="idm140712085033936"><div class="titlepage"><div><div><h2 class="title" id="idm140712085033936"><span class="number">2 </span><span class="name">Feedback</span> <a title="Permalink" class="permalink" href="#idm140712085033936">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>common_intro_feedback_i.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><p>
  Several feedback channels are available:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712094818752"><span class="term ">Bug Reports</span></dt><dd><p>
     To report bugs for <span class="productname"><span class="phrase">openSUSE Leap</span></span>, go to
     <a class="link" href="https://bugzilla.opensuse.org/" target="_blank">https://bugzilla.opensuse.org/</a>, log in, and
     click <span class="guimenu">New</span>.
    </p></dd><dt id="idm140712085035904"><span class="term ">Mail</span></dt><dd><p>
     For feedback on the documentation of this product, you can also send a
     mail to <code class="literal">doc-team@suse.com</code>. Make sure to include the
     document title, the product version and the publication date of the
     documentation. To report errors or suggest enhancements, provide a concise
     description of the problem and refer to the respective section number and
     page (or URL).
    </p></dd></dl></div></div><div class="sect1 " id="idm140712072167728"><div class="titlepage"><div><div><h2 class="title" id="idm140712072167728"><span class="number">3 </span><span class="name">Documentation Conventions</span> <a title="Permalink" class="permalink" href="#idm140712072167728">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>common_intro_typografie_i.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><p>
  The following notices and typographical conventions are used in this
  documentation:
 </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    <code class="filename">/etc/passwd</code>: directory names and file names
   </p></li><li class="listitem "><p>
    <em class="replaceable ">PLACEHOLDER</em>: replace
    <em class="replaceable ">PLACEHOLDER</em> with the actual value
   </p></li><li class="listitem "><p>
    <code class="envar">PATH</code>: the environment variable PATH
   </p></li><li class="listitem "><p>
    <code class="command">ls</code>, <code class="option">--help</code>: commands, options, and
    parameters
   </p></li><li class="listitem "><p>
    <code class="systemitem">user</code>: users or groups
   </p></li><li class="listitem "><p>
    <span class="package">package name</span>
    : name of a package
   </p></li><li class="listitem "><p>
    <span class="keycap">Alt</span>, <span class="keycap">Alt</span><span class="key-connector">–</span><span class="keycap">F1</span>: a key to press or a key combination; keys
    are shown in uppercase as on a keyboard
   </p></li><li class="listitem "><p>
    <span class="guimenu">File</span>, <span class="guimenu">File</span> › <span class="guimenu">Save
    As</span>: menu items, buttons
   </p></li><li class="listitem "><p>
    <span class="emphasis"><em>Dancing Penguins</em></span> (Chapter
    <span class="emphasis"><em>Penguins</em></span>, ↑Another Manual): This is a reference
    to a chapter in another manual.
   </p></li><li class="listitem "><p>
    Commands that must be run with <code class="systemitem">root</code> privileges. Often you can also
    prefix these commands with the <code class="command">sudo</code> command to run them
    as non-privileged user.
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">command</code>
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">command</code></pre></div></li><li class="listitem "><p>
    Commands that can be run by non-privileged users.
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">command</code></pre></div></li><li class="listitem "><p>
    Notices
   </p><div id="idm140712071918912" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Warning Notice</h6><p>
     Vital information you must be aware of before proceeding. Warns you about
     security issues, potential loss of data, damage to hardware, or physical
     hazards.
    </p></div><div id="idm140712071917408" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Important Notice</h6><p>
     Important information you should be aware of before proceeding.
    </p></div><div id="idm140712071916096" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Note Notice</h6><p>
     Additional information, for example about differences in software
     versions.
    </p></div><div id="idm140712071914672" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Tip Notice</h6><p>
     Helpful information, like a guideline or a piece of practical advice.
    </p></div></li></ul></div></div></div><div class="chapter " id="cha.security"><div class="titlepage"><div><div><h1 class="title"><span class="number">1 </span><span class="name">Security and Confidentiality</span> <a title="Permalink" class="permalink" href="#cha.security">#</a></h1><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_preface.xml</li><li><span class="ds-label">ID: </span>cha.security</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712071909040">#</a></h6></div><p>
    This chapter introduces basic concepts of computer security.
    Threats and basic mitigation techniques are described. The chapter
    also provides references to other chapters, guides and websites with
    further information.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.overview"><span class="number">1.1 </span><span class="name">Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.passwords"><span class="number">1.2 </span><span class="name">Passwords</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.integrity"><span class="number">1.3 </span><span class="name">System Integrity</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.file_access"><span class="number">1.4 </span><span class="name">File Access</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.network"><span class="number">1.5 </span><span class="name">Networking</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vulnerabilities"><span class="number">1.6 </span><span class="name">Software Vulnerabilities</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.malware"><span class="number">1.7 </span><span class="name">Malware</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.tips"><span class="number">1.8 </span><span class="name">Important Security Tips</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.general.report"><span class="number">1.9 </span><span class="name">Reporting Security Issues</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.overview"><div class="titlepage"><div><div><h2 class="title" id="sec.security.overview"><span class="number">1.1 </span><span class="name">Overview</span> <a title="Permalink" class="permalink" href="#sec.security.overview">#</a></h2></div></div></div><p>
   One main characteristics of Linux is its ability to handle multiple
   users at the same time (multiuser) and to allow these users to
   simultaneously perform tasks (multitasking) on the same computer.
   To users, there is no difference between working with data stored
   locally and data stored in the network.
  </p><p>
   Due to the multiuser capability, data from different users has to be
   stored separately to guarantee security and privacy. Also important
   is the ability to keep data available in spite of a lost or otherwise
   damaged data medium, for example a hard disk.
  </p><p>
   This chapter is primarily focused on confidentiality and privacy. But
   a comprehensive security concept includes a regularly updated,
   workable, and tested backup. Without a backup, restoring data after
   it has been tampered with or after a hardware failure is very hard.
  </p><p>
   Use a <span class="emphasis"><em>defense-in-depth</em></span> approach to security:
   Assume that no single threat mitigation can fully protect your
   systems and data, but multiple layers of defense will make an attack
   much harder. Components of a defense-in-depth strategy can be the
   following:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Hashing passwords (for example with PBKDF2, bcrypt, or scrypt) and
     salting them
    </p></li><li class="listitem "><p>Encrypting data (for example with AES)</p></li><li class="listitem "><p>Logging, monitoring and intrusion detection</p></li><li class="listitem "><p>Firewall</p></li><li class="listitem "><p>Antivirus scanner</p></li><li class="listitem "><p>Defined and documented emergency procedures</p></li><li class="listitem "><p>Backups</p></li><li class="listitem "><p>Physical security</p></li><li class="listitem "><p>Audits, security scans and intrusion tests</p></li></ul></div><p>
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> includes software that addresses the requirements of
   the list above. The following sections provide starting points for
   securing your system.
  </p></div><div class="sect1 " id="sec.security.passwords"><div class="titlepage"><div><div><h2 class="title" id="sec.security.passwords"><span class="number">1.2 </span><span class="name">Passwords</span> <a title="Permalink" class="permalink" href="#sec.security.passwords">#</a></h2></div></div></div><p>
   On a Linux system, only hashes of passwords are stored. Hashes are
   one-way algorithms that make it easy to encrypt data. At the same
   time, hash algorithms make it very hard to compute the original
   secret from the hash.
  </p><p>
   The hashes are stored in the file <code class="filename">/etc/shadow</code>,
   which cannot be read by normal users. Because restoring passwords is
   possible with powerful computers, hashed passwords should not be
   visible to regular users.
  </p><p>
   The <span class="emphasis"><em>National Institute of Standards and
   Technology</em></span> (<span class="emphasis"><em>NIST</em></span>) publishes a
   guideline for passwords, which is available at <a class="link" href="https://pages.nist.gov/800-63-3/sp800-63b.html#sec5" target="_blank">https://pages.nist.gov/800-63-3/sp800-63b.html#sec5</a>
  </p><p>
   For details about how to set a password policy, see <a class="xref" href="#sec.security.yast_security.password" title="8.3. Password Settings">Section 8.3, “<span class="guimenu">Password Settings</span>”</a>. For general
   information about authentication on Linux, see <a class="xref" href="#part.auth" title="Part I. Authentication">Part I, “Authentication”</a>.
  </p></div><div class="sect1 " id="sec.security.integrity"><div class="titlepage"><div><div><h2 class="title" id="sec.security.integrity"><span class="number">1.3 </span><span class="name">System Integrity</span> <a title="Permalink" class="permalink" href="#sec.security.integrity">#</a></h2></div></div></div><p>
   If it is possible to physically access a computer, the firmware and
   boot process can be manipulated to gain access as soon as an
   authorized person boots the machine. While not all computers can be locked
   into inaccessible rooms, your first step should be physically locking the
   server room.
  </p><p>
   Consider taking the following additional measures:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Configure your system so it cannot be booted from a removable
     device, either by removing the drives entirely or by setting a
     UEFI password and configuring the UEFI to allow booting from a
     hard disk only.
    </p></li><li class="listitem "><p>
     To make the boot procedure more tamper-resistant, enable the UEFI
     <span class="emphasis"><em>secure boot</em></span> feature.
     For more information about Secure Boot, see <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 14 “UEFI (Unified Extensible Firmware Interface)”</span>.
    </p></li><li class="listitem "><p>
     Linux systems are started by a boot loader that usually allows
     passing additional options to the booted kernel. You can prevent others
     from using such parameters during boot by setting an additional
     password for the boot loader. This is crucial to system
     security. Not only does the kernel itself run with <code class="systemitem">root</code>
     permissions, but it is also the first authority to grant
     <code class="systemitem">root</code> permissions at system start-up.
    </p><p>
     For more information about setting a password in the boot loader, see
     <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 12 “The Boot Loader GRUB 2”, Section 12.2.6 “Setting a Boot Password”</span>.
    </p></li><li class="listitem "><p>
     Enable hard disk encryption. For more information, see
     <a class="xref" href="#cha.security.cryptofs" title="Chapter 11. Encrypting Partitions and Files">Chapter 11, <em>Encrypting Partitions and Files</em></a>.
    </p></li><li class="listitem "><p>
     Use AIDE to detect any changes in your system configuration. For
     more information, see <a class="xref" href="#cha.aide" title="Chapter 13. Intrusion Detection with AIDE">Chapter 13, <em>Intrusion Detection with AIDE</em></a>.
    </p></li></ul></div></div><div class="sect1 " id="sec.security.file_access"><div class="titlepage"><div><div><h2 class="title" id="sec.security.file_access"><span class="number">1.4 </span><span class="name">File Access</span> <a title="Permalink" class="permalink" href="#sec.security.file_access">#</a></h2></div></div></div><p>
   Because of the <span class="emphasis"><em>everything is a file</em></span> approach in
   Linux, file permissions are important for controlling access to most
   resources. This means that using file permissions, you can define
   access to regular files and directories as well as hardware devices.
   By default, most hardware devices are only accessible for
   <code class="systemitem">root</code>. However, some devices, for example serial ports, can be
   accessible for normal users.
  </p><p>
   As a general rule, always work with the most restrictive privileges
   possible for a given task. For example, it is definitely not
   necessary to be <code class="systemitem">root</code> to read or write e-mail. If the mail
   program has a bug, this bug could be exploited for an attack that
   acts with exactly the permissions of the program at the time of the
   attack. By following the above rule, minimize the possible damage.
  </p><p>
   For details, see <a class="xref" href="#sec.security.acls.traditional" title="10.1. Traditional File Permissions">Section 10.1, “Traditional File Permissions”</a> and
   <a class="xref" href="#sec.security.acls.intro" title="10.2. Advantages of ACLs">Section 10.2, “Advantages of ACLs”</a>.
  </p><p>
   <span class="phrase">AppArmor</span> <span class="phrase">and SELinux allow</span> you to set constrains for applications and
   users. For details, see <a class="xref" href="#part.apparmor" title="Part IV. Confining Privileges with AppArmor">Part IV, “Confining Privileges with <span class="phrase">AppArmor</span>”</a><span class="phrase"> and <a class="xref" href="#part.selinux" title="Part V. SELinux">Part V, “SELinux”</a></span>.
  </p><p>
   If there is a chance that hard disks can be accessed outside of the
   installed operating system, for example by booting a live system or
   removing the hardware, encrypt the data. <span class="productname"><span class="phrase">openSUSE Leap</span></span> allows you to
   encrypt partitions containing data and the operating system. For
   details, see <a class="xref" href="#cha.security.cryptofs" title="Chapter 11. Encrypting Partitions and Files">Chapter 11, <em>Encrypting Partitions and Files</em></a>.
  </p></div><div class="sect1 " id="sec.security.network"><div class="titlepage"><div><div><h2 class="title" id="sec.security.network"><span class="number">1.5 </span><span class="name">Networking</span> <a title="Permalink" class="permalink" href="#sec.security.network">#</a></h2></div></div></div><p>
   Securing network services is a crucial task. Aim to secure
   as many layers of the <span class="emphasis"><em>OSI model</em></span> as possible.
  </p><p>
   All communication should be authenticated and encrypted with
   up-to-date cryptographic algorithms on the transport or application
   layer. Use a Virtual Private Network (VPN) as an additional secure
   layer on physical networks.
  </p><p>
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> provides many options for securing your network:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Use <code class="command">openssl</code> to create X509 certificates. These certificates can be
     used for encryption and authentication of many services.
     You can set up your own <span class="emphasis"><em>certificate authority</em></span>
     (<span class="emphasis"><em>CA</em></span>) and use it as a source of trust in your
     network. For details, see <code class="command">man openssl</code>.
    </p></li><li class="listitem "><p>
     Usually, at least parts of networks are exposed to the public
     internet. Reduce attack surfaces by closing ports with firewall
     rules and by uninstalling or at least disabling not required
     services. For details, see <a class="xref" href="#cha.security.firewall" title="Chapter 16. Masquerading and Firewalls">Chapter 16, <em>Masquerading and Firewalls</em></a>.
    </p></li><li class="listitem "><p>
     Use OpenVPN to secure communication channels over insecure
     physical networks. For details, see <a class="xref" href="#cha.security.vpnserver" title="Chapter 17. Configuring a VPN Server">Chapter 17, <em>Configuring a VPN Server</em></a>.
    </p></li><li class="listitem "><p>
     Use strong authentication for network services. For details, see
     <a class="xref" href="#part.auth" title="Part I. Authentication">Part I, “Authentication”</a>.
    </p></li></ul></div></div><div class="sect1 " id="sec.security.vulnerabilities"><div class="titlepage"><div><div><h2 class="title" id="sec.security.vulnerabilities"><span class="number">1.6 </span><span class="name">Software Vulnerabilities</span> <a title="Permalink" class="permalink" href="#sec.security.vulnerabilities">#</a></h2></div></div></div><p>
   Software vulnerabilities are issues in software that can be
   exploited to obtain unauthorized access or misuse systems.
   Vulnerabilities are especially critical if they affect remote
   services, such as HTTP servers. Computer systems are very complex,
   therefore, they always include certain vulnerabilities.
  </p><p>
   When such issues become known, they must usually be fixed in the
   software by software developers. The resulting update must then be
   installed by system administrators in a timely and safe manner on
   affected systems.
  </p><p>
   Vulnerabilities are usually announced on centralized
   databases, for example the <span class="emphasis"><em>National Vulnerability
   Database</em></span>, which is maintained by the US government.
   You can subscribe to feeds to stay informed about newly
   discovered vulnerabilities. In some cases the problems induced by
   the bugs can be mitigated until a software update is provided.
   Vulnerabilities are assigned a <span class="emphasis"><em>Common Vulnerabilities
   and Exposures</em></span> (<span class="emphasis"><em>CVE</em></span>) number and a
   <span class="emphasis"><em>Common Vulnerability Scoring System</em></span>
   (<span class="emphasis"><em>CVSS</em></span>) score. The score helps identifying
   the severity of vulnerabilities.
  </p><p>
   SUSE provides a feed of security advisories. It is available at
   <a class="link" href="https://www.suse.com/en-us/support/update/" target="_blank">https://www.suse.com/en-us/support/update/</a>.
   There is also a list of security updates by CVE number available at
   <a class="link" href="https://www.suse.com/en-us/security/cve/" target="_blank">https://www.suse.com/en-us/security/cve/</a>.
  </p><p>
   In general, administrators should be prepared for severe
   vulnerabilities in their systems. This includes hardening all
   computers as far as possible. Also, we recommend to have predefined
   procedures in place for quickly installing updates for severe
   vulnerabilities.
  </p><p>
   To reduce the damage of possible attacks, use restrictive file
   permissions. See <a class="xref" href="#sec.security.acls.traditional" title="10.1. Traditional File Permissions">Section 10.1, “Traditional File Permissions”</a>.
   SUSE provides a guide to harden <span class="productname"><span class="phrase">openSUSE Leap</span></span>.
  </p><p>
   Other useful links:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <a class="link" href="http://lists.opensuse.org/opensuse-security-announce/" target="_blank">http://lists.opensuse.org/opensuse-security-announce/</a>,
     mailing list with openSUSE security announcements.
    </p></li><li class="listitem "><p>
     <a class="link" href="https://nvd.nist.gov/home" target="_blank">https://nvd.nist.gov/home</a>, the National
     Vulnerability Database
    </p></li><li class="listitem "><p>
     <a class="link" href="https://cve.mitre.org/" target="_blank">https://cve.mitre.org/</a>, MITRE's CVE database
    </p></li><li class="listitem "><p><a class="link" href="https://www.bsi.bund.de/DE/Service/Aktuell/Cert_Bund_Meldungen/cert_bund_meldungen_node.html" target="_blank">https://www.bsi.bund.de/DE/Service/Aktuell/Cert_Bund_Meldungen/cert_bund_meldungen_node.html</a>, <span class="emphasis"><em>German Federal Office for Information
    Security</em></span> vulnerability feed</p></li><li class="listitem "><p>
    <a class="link" href="https://www.first.org/cvss/" target="_blank">https://www.first.org/cvss/</a>, Information about the Common Vulnerability Scoring System
    </p></li></ul></div></div><div class="sect1 " id="sec.security.malware"><div class="titlepage"><div><div><h2 class="title" id="sec.security.malware"><span class="number">1.7 </span><span class="name">Malware</span> <a title="Permalink" class="permalink" href="#sec.security.malware">#</a></h2></div></div></div><p>
   <span class="emphasis"><em>Malware</em></span> is software that is intended to
   interrupt the normal functioning of a computer or steal data. This
   includes viruses, worms, ransomware or rootkits. Sometimes malware
   uses software vulnerabilities to attack a computer. However, in many
   cases it is accidentally executed by a user, especially when
   installing third-party software from unknown sources. <span class="productname"><span class="phrase">openSUSE Leap</span></span>
   provides an extensive list of programs (packages) in its download
   repositories. This reduces the need to download third-party
   software. All packages provided by SUSE are signed. The package
   manager of <span class="productname"><span class="phrase">openSUSE Leap</span></span> checks the signatures of packages after the
   download to verify their integrity.
  </p><p>
   The command <code class="command">rpm</code> <code class="option">--checksig
   <em class="replaceable ">RPM_FILE</em></code> shows whether the
   checksum and the signature of a package is correct.
   You can find the signing key on the first DVD of <span class="productname"><span class="phrase">openSUSE Leap</span></span> and
   on most key servers worldwide.
  </p><p>
   You can use the ClamAV antivirus software to detect malware on your
   system. ClamAV can be integrated into several services, for example
   mail servers or HTTP proxies. This can be used to filter malware
   before it arrives at the user.
  </p><p>
   Restrictive user privileges can reduce the risk for of accidental
   code execution.
  </p></div><div class="sect1 " id="sec.security.tips"><div class="titlepage"><div><div><h2 class="title" id="sec.security.tips"><span class="number">1.8 </span><span class="name">Important Security Tips</span> <a title="Permalink" class="permalink" href="#sec.security.tips">#</a></h2></div></div></div><p>
   The following tips are a quick summary of the sections above:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Stay informed about the latest security issues. Get and install
     the updated packages recommended by security announcements as
     quickly as possible.
    </p></li><li class="listitem "><p>
     Avoid using <code class="systemitem">root</code> privileges whenever possible. Set
     restrictive file permissions.
    </p></li><li class="listitem "><p>
     Only use encrypted protocols for network communication.
    </p></li><li class="listitem "><p>
     Disable any network services you do not absolutely require.
    </p></li><li class="listitem "><p>
     Conduct regular security audits. For example, scan your network for
     open ports.
    </p></li><li class="listitem "><p>
     Monitor the integrity of files on your systems with
     <code class="literal">AIDE</code> (Advanced Intrusion Detection
     Environment).
    </p></li><li class="listitem "><p>
     Take proper care when installing any third-party software.
    </p></li><li class="listitem "><p>
     Check all your backups regularly.
    </p></li><li class="listitem "><p>
     Check your log files, for example with logwatch.
    </p></li><li class="listitem "><p>
     Configure the firewall to block all ports that are not explicitly
     whitelisted.
    </p></li><li class="listitem "><p>
     Design your security measures to be redundant.
    </p></li><li class="listitem "><p>
     Use encryption where possible, for example for hard disks of mobile
     computers.
    </p></li></ul></div></div><div class="sect1 " id="sec.security.general.report"><div class="titlepage"><div><div><h2 class="title" id="sec.security.general.report"><span class="number">1.9 </span><span class="name">Reporting Security Issues</span> <a title="Permalink" class="permalink" href="#sec.security.general.report">#</a></h2></div></div></div><p>
   If you discover a security-related problem, first check the
   available update packages. If no update is available, write an
   e-mail to &lt;<a class="email" href="mailto:security@suse.de">security@suse.de</a>&gt;. Include a detailed
   description of the problem and the version number of the package
   concerned. We encourage to encrypt e-mails with GPG.
  </p><p>
   You can find a current version of the SUSE GPG key on
   <a class="link" href="https://www.suse.com/support/security/contact/" target="_blank">https://www.suse.com/support/security/contact/</a>.
  </p></div></div><div class="part" id="part.auth"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part I </span><span class="name">Authentication </span><a title="Permalink" class="permalink" href="#part.auth">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.pam"><span class="number">2 </span><span class="name">Authentication with PAM</span></a></span></dt><dd class="toc-abstract"><p>
    Linux uses PAM (pluggable authentication modules) in the authentication
    process as a layer that mediates between user and application. PAM
    modules are available on a systemwide basis, so they can be requested by
    any application. This chapter describes how the modular authentication
    mechanism works and how it is configured.
   </p></dd><dt><span class="chapter"><a href="#cha.nis"><span class="number">3 </span><span class="name">Using NIS</span></a></span></dt><dd class="toc-abstract"><p>
    When multiple Unix systems in a network access common resources,
    it becomes imperative that all user and group identities are the same
    for all machines in that network. The network should be transparent to
    users: their environments should not vary, regardless of which machine
    they are actually using. This can be done by means of NIS and NFS
    services. NFS distributes file systems over a network and is discussed
    in <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 22 “Sharing File Systems with NFS”</span>.
   </p><p>
    NIS (Network Information Service) can be described as a database-like
    service that provides access to the contents of
    <code class="filename">/etc/passwd</code>, <code class="filename">/etc/shadow</code>, and
    <code class="filename">/etc/group</code> across networks. NIS can also be used
    for other purposes (making the contents of files like
    <code class="filename">/etc/hosts</code> or <code class="filename">/etc/services</code>
    available, for example), but this is beyond the scope of this
    introduction. People often refer to NIS as <span class="emphasis"><em>YP</em></span>,
    because it works like the network's <span class="quote">“<span class="quote">yellow pages.</span>”</span>
        </p></dd><dt><span class="chapter"><a href="#cha.security.auth"><span class="number">4 </span><span class="name">Setting Up Authentication Servers and Clients Using YaST</span></a></span></dt><dd class="toc-abstract"><p>
    The Authentication Server is based on LDAP and optionally Kerberos. On
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> you can configure it with a YaST wizard.
   </p><p>
    For more information about LDAP, see
    <a class="xref" href="#cha.security.ldap" title="Chapter 5. LDAP—A Directory Service">Chapter 5, <em>LDAP—A Directory Service</em></a>, and about Kerberos, see
    <a class="xref" href="#cha.security.kerberos" title="Chapter 6. Network Authentication with Kerberos">Chapter 6, <em>Network Authentication with Kerberos</em></a>.
   </p></dd><dt><span class="chapter"><a href="#cha.security.ldap"><span class="number">5 </span><span class="name">LDAP—A Directory Service</span></a></span></dt><dd class="toc-abstract"><p>
    The Lightweight Directory Access Protocol (LDAP) is a set of protocols
    designed to access and maintain information directories. LDAP can be
    used for user and group management, system configuration management,
    address management, and more. This chapter provides a basic
    understanding of how OpenLDAP works.
   </p></dd><dt><span class="chapter"><a href="#cha.security.kerberos"><span class="number">6 </span><span class="name">Network Authentication with Kerberos</span></a></span></dt><dd class="toc-abstract"><p>
    Kerberos is a network authentication protocol which also provides
    encryption. This chapter describes how to set up Kerberos and integrate
    services like LDAP and NFS.
   </p></dd><dt><span class="chapter"><a href="#cha.security.ad"><span class="number">7 </span><span class="name">Active Directory Support</span></a></span></dt><dd class="toc-abstract"><p>Active Directory* (AD) is a directory-service based on LDAP, Kerberos, and other services. It is used by Microsoft* Windows* to manage resources, services, and people. In a Microsoft Windows network, Active Directory provides information about these objects, restricts access to them, and enforces po…</p></dd></dl></div><div class="chapter " id="cha.pam"><div class="titlepage"><div><div><h2 class="title"><span class="number">2 </span><span class="name">Authentication with PAM</span> <a title="Permalink" class="permalink" href="#cha.pam">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_pam.xml</li><li><span class="ds-label">ID: </span>cha.pam</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712072008992">#</a></h6></div><p>
    Linux uses PAM (pluggable authentication modules) in the authentication
    process as a layer that mediates between user and application. PAM
    modules are available on a systemwide basis, so they can be requested by
    any application. This chapter describes how the modular authentication
    mechanism works and how it is configured.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.pam.whatis"><span class="number">2.1 </span><span class="name">What is PAM?</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.files"><span class="number">2.2 </span><span class="name">Structure of a PAM Configuration File</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.format"><span class="number">2.3 </span><span class="name">The PAM Configuration of sshd</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.struc.conf"><span class="number">2.4 </span><span class="name">Configuration of PAM Modules</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.pam-config"><span class="number">2.5 </span><span class="name">Configuring PAM Using pam-config</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.manual-config"><span class="number">2.6 </span><span class="name">Manually Configuring PAM</span></a></span></dt><dt><span class="sect1"><a href="#sec.pam.info"><span class="number">2.7 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.pam.whatis"><div class="titlepage"><div><div><h2 class="title" id="sec.security.pam.whatis"><span class="number">2.1 </span><span class="name">What is PAM?</span> <a title="Permalink" class="permalink" href="#sec.security.pam.whatis">#</a></h2></div></div></div><p>
   System administrators and programmers often want to restrict access to
   certain parts of the system or to limit the use of certain functions of
   an application. Without PAM, applications must be adapted every time a
   new authentication mechanism, such as LDAP, Samba, or Kerberos, is
   introduced. However, this process is time-consuming and
   error-prone. One way to avoid these drawbacks is to separate applications
   from the authentication mechanism and delegate authentication to
   centrally managed modules. Whenever a newly required authentication
   scheme is needed, it is sufficient to adapt or write a suitable
   <span class="emphasis"><em>PAM module</em></span> for use by the program in question.
  </p><p>
   The PAM concept consists of:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <span class="emphasis"><em>PAM modules</em></span>, which are a set of shared libraries
     for a specific authentication mechanism.
    </p></li><li class="listitem "><p>
     A <span class="emphasis"><em>module stack</em></span> with of one or more PAM modules.
    </p></li><li class="listitem "><p>
     A PAM-aware <span class="emphasis"><em>service</em></span> which needs authentication by
     using a module stack or PAM modules. Usually a service is a familiar
     name of the corresponding application, like <code class="command">login</code> or
     <code class="command">su</code>. The service name <code class="literal">other</code> is a
     reserved word for default rules.
    </p></li><li class="listitem "><p>
     <span class="emphasis"><em>Module arguments</em></span>, with which the execution of a
     single PAM module can be influenced.
    </p></li><li class="listitem "><p>
     A mechanism evaluating each <span class="emphasis"><em>result</em></span> of a single PAM
     module execution. A positive value executes the next PAM module. The
     way a negative value is dealt with depends on the configuration:
     <span class="quote">“<span class="quote">no influence, proceed</span>”</span> up to <span class="quote">“<span class="quote">terminate
     immediately</span>”</span> and anything in between are valid options.
    </p></li></ul></div></div><div class="sect1 " id="sec.pam.struc.files"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.struc.files"><span class="number">2.2 </span><span class="name">Structure of a PAM Configuration File</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.files">#</a></h2></div></div></div><p>
   PAM can be configured in two ways:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712071990944"><span class="term ">File based configuration (<code class="filename">/etc/pam.conf</code>)</span></dt><dd><p>
      The configuration of each service is stored in
      <code class="filename">/etc/pam.conf</code>. However, for maintenance and
      usability reasons, this configuration scheme is not used in
      <span class="productname"><span class="phrase">openSUSE Leap</span></span>.
     </p></dd><dt id="idm140712071987072"><span class="term ">Directory based configuration (<code class="filename">/etc/pam.d/</code>)</span></dt><dd><p>
      Every service (or program) that relies on the PAM mechanism has its
      own configuration file in the <code class="filename">/etc/pam.d/</code>
      directory. For example, the service for
      <code class="systemitem">sshd</code> can be found in the
      <code class="filename">/etc/pam.d/sshd</code> file.
     </p></dd></dl></div><p>
   The files under <code class="filename">/etc/pam.d/</code> define the PAM modules
   used for authentication. Each file consists of lines, which define a
   service, and each line consists of a maximum of four components:
  </p><div class="verbatim-wrap"><pre class="screen"><em class="replaceable ">TYPE</em>  <em class="replaceable ">CONTROL</em>
 <em class="replaceable ">MODULE_PATH</em>  <em class="replaceable ">MODULE_ARGS</em></pre></div><p>
   The components have the following meaning:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712071134768"><span class="term "><em class="replaceable ">TYPE</em>
    </span></dt><dd><p>
      Declares the type of the service. PAM modules are processed as stacks.
      Different types of modules have different purposes. For example, one
      module checks the password, another verifies the location from which
      the system is accessed, and yet another reads user-specific settings.
      PAM knows about four different types of modules:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712071132496"><span class="term "><code class="literal">auth</code>
       </span></dt><dd><p>
         Check the user's authenticity, traditionally by querying a
         password. However, this can also be achieved with a
         chip card or through biometrics (for example, fingerprints or iris
         scan).
        </p></dd><dt id="idm140712071130208"><span class="term "><code class="literal">account</code>
       </span></dt><dd><p>
         Modules of this type check if the user has general permission to
         use the requested service. As an example, such a check should be
         performed to ensure that no one can log in with the user name of an
         expired account.
        </p></dd><dt id="idm140712071127888"><span class="term "><code class="literal">password</code>
       </span></dt><dd><p>
         The purpose of this type of module is to enable the change of an
         authentication token. Usually this is a password.
        </p></dd><dt id="idm140712071125680"><span class="term "><code class="literal">session</code>
       </span></dt><dd><p>
         Modules of this type are responsible for managing and configuring
         user sessions. They are started before and after authentication to
         log login attempts and configure the user's specific environment
         (mail accounts, home directory, system limits, etc.).
        </p></dd></dl></div></dd><dt id="idm140712071122832"><span class="term "><em class="replaceable ">CONTROL</em>
    </span></dt><dd><p>
      Indicates the behavior of a PAM module. Each module can have the
      following control flags:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712071120688"><span class="term "><code class="literal">required</code>
       </span></dt><dd><p>
         A module with this flag must be successfully processed before the
         authentication may proceed. After the failure of a module with the
         <code class="literal">required</code> flag, all other modules with the same
         flag are processed before the user receives a message about the
         failure of the authentication attempt.
        </p></dd><dt id="idm140712071117856"><span class="term "><code class="literal">requisite</code>
       </span></dt><dd><p>
         Modules having this flag must also be processed successfully, in
         much the same way as a module with the <code class="literal">required</code>
         flag. However, in case of failure a module with this flag gives
         immediate feedback to the user and no further modules are
         processed. In case of success, other modules are subsequently
         processed, like any modules with the <code class="literal">required</code>
         flag. The <code class="literal">requisite</code> flag can be used as a basic
         filter checking for the existence of certain conditions that are
         essential for a correct authentication.
        </p></dd><dt id="idm140712071113936"><span class="term "><code class="literal">sufficient</code>
       </span></dt><dd><p>
         After a module with this flag has been successfully processed, the
         requesting application receives an immediate message about the
         success and no further modules are processed, provided there was no
         preceding failure of a module with the <code class="literal">required</code>
         flag. The failure of a module with the
         <code class="literal">sufficient</code> flag has no direct consequences, in
         the sense that any subsequent modules are processed in their
         respective order.
        </p></dd><dt id="idm140712071110608"><span class="term "><code class="literal">optional</code>
       </span></dt><dd><p>
         The failure or success of a module with this flag does not have any
         direct consequences. This can be useful for modules that are only
         intended to display a message (for example, to tell the user that
         mail has arrived) without taking any further action.
        </p></dd><dt id="idm140712071108240"><span class="term "><code class="literal">include</code>
       </span></dt><dd><p>
         If this flag is given, the file specified as argument is inserted
         at this place.
        </p></dd></dl></div></dd><dt id="idm140712071105584"><span class="term "><em class="replaceable ">MODULE_PATH</em>
    </span></dt><dd><p>
      Contains a full file name of a PAM module. It does not need to be
      specified explicitly, as long as the module is located in the default
      directory <code class="filename">/lib/security</code> (for all 64-bit platforms
      supported by <span class="productname"><span class="phrase">openSUSE® Leap</span></span>, the directory is
      <code class="filename">/lib64/security</code>).
     </p></dd><dt id="idm140712071101296"><span class="term "><em class="replaceable ">MODULE_ARGS</em>
    </span></dt><dd><p>
      Contains a space-separated list of options to influence the behavior
      of a PAM module, such as <code class="option">debug</code> (enables debugging) or
      <code class="option">nullok</code> (allows the use of empty passwords).
     </p></dd></dl></div><p>
   In addition, there are global configuration files for PAM modules under
   <code class="filename">/etc/security</code>, which define the exact behavior of
   these modules (examples include <code class="filename">pam_env.conf</code> and
   <code class="filename">time.conf</code>). Every application that uses a PAM module
   actually calls a set of PAM functions, which then process the information
   in the various configuration files and return the result to the
   requesting application.
  </p><p>
   To simplify the creation and maintenance of PAM modules, common default
   configuration files for the types <code class="literal">auth</code>,
   <code class="literal">account</code>, <code class="literal">password</code>, and
   <code class="literal">session</code> modules have been introduced. These are
   retrieved from every application's PAM configuration. Updates to the
   global PAM configuration modules in <code class="filename">common-*</code> are
   thus propagated across all PAM configuration files without requiring the
   administrator to update every single PAM configuration file.
  </p><p>
   The global PAM configuration files are maintained using the
   <code class="command">pam-config</code> tool. This tool automatically adds new
   modules to the configuration, changes the configuration of existing ones
   or deletes modules (or options) from the configurations. Manual
   intervention in maintaining PAM configurations is minimized or no longer
   required.
  </p><div id="idm140712071091712" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: 64-Bit and 32-Bit Mixed Installations</h6><p>
    When using a 64-bit operating system, it is possible to also include a
    runtime environment for 32-bit applications. In this case, make sure
    that you also install the 32-bit version of the PAM modules.
   </p></div></div><div class="sect1 " id="sec.pam.struc.format"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.struc.format"><span class="number">2.3 </span><span class="name">The PAM Configuration of sshd</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.format">#</a></h2></div></div></div><p>
   Consider the PAM configuration of sshd as an example:
  </p><div class="example" id="dat.pam.sshd"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.1: </span><span class="name">PAM Configuration for sshd (<code class="filename">/etc/pam.d/sshd</code>) </span><a title="Permalink" class="permalink" href="#dat.pam.sshd">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">#%PAM-1.0 <span id="co.security.pam.sshd.pam-line"></span><span class="callout">1</span>
auth     requisite      pam_nologin.so                              <span id="co.security.pam.sshd.pam_nologin"></span><span class="callout">2</span>
auth     include        common-auth                                 <span id="co.security.pam.sshd.common-auth"></span><span class="callout">3</span>
account  requisite      pam_nologin.so                              <a class="xref" href="#co.security.pam.sshd.pam_nologin"><span class="callout">2</span></a>
account  include        common-account                              <a class="xref" href="#co.security.pam.sshd.common-auth"><span class="callout">3</span></a>
password include        common-password                             <a class="xref" href="#co.security.pam.sshd.common-auth"><span class="callout">3</span></a>
session  required       pam_loginuid.so                             <span id="co.security.pam.sshd.pam_loginuid"></span><span class="callout">4</span>
session  include        common-session                              <a class="xref" href="#co.security.pam.sshd.common-auth"><span class="callout">3</span></a>
session  optional       pam_lastlog.so   silent noupdate showfailed <span id="co.security.pam.sshd.lastlog"></span><span class="callout">5</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.pam-line"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
      Declares the version of this configuration file for PAM 1.0. This is
      merely a convention, but could be used in the future to check the
      version.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.pam_nologin"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
      Checks, if <code class="filename">/etc/nologin</code> exists. If it does, no
      user other than <code class="systemitem">root</code> may log
      in.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.common-auth"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
      Refers to the configuration files of four module types:
      <code class="filename">common-auth</code>, <code class="filename">common-account</code>,
      <code class="filename">common-password</code>, and
      <code class="filename">common-session</code>. These four files hold the default
      configuration for each module type.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.pam_loginuid"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
      Sets the login uid process attribute for the process that was
      authenticated.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.lastlog"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
      Displays information about the last login of a user.
     </p></td></tr></table></div></div></div><p>
   By including the configuration files instead of adding each module
   separately to the respective PAM configuration, you automatically get an
   updated PAM configuration when an administrator changes the defaults.
   Formerly, you needed to adjust all configuration files manually for all
   applications when changes to PAM occurred or a new application was
   installed. Now the PAM configuration is made with central configuration
   files and all changes are automatically inherited by the PAM
   configuration of each service.
  </p><p>
   The first include file (<code class="filename">common-auth</code>) calls three
   modules of the <code class="literal">auth</code> type:
   <code class="systemitem">pam_env.so</code>,
   <code class="systemitem">pam_gnome_keyring.so</code> and
   <code class="systemitem">pam_unix.so</code>. See
   <a class="xref" href="#dat.pam.common-auth" title="Default Configuration for the auth Section (common-auth)">Example 2.2, “Default Configuration for the <code class="literal">auth</code> Section (<code class="filename">common-auth</code>)”</a>.
  </p><div class="example" id="dat.pam.common-auth"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.2: </span><span class="name">Default Configuration for the <code class="literal">auth</code> Section (<code class="filename">common-auth</code>) </span><a title="Permalink" class="permalink" href="#dat.pam.common-auth">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">auth  required  pam_env.so                   <span id="co.security.pam.sshd.pam_env"></span><span class="callout">1</span>
auth  optional  pam_gnome_keyring.so         <span id="co.security.pam.sshd.gnome"></span><span class="callout">2</span>
auth  required  pam_unix.so  try_first_pass <span id="co.security.pam.sshd.pam_unix"></span><span class="callout">3</span></pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.pam_env"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     <code class="systemitem">pam_env.so</code> loads
     <code class="filename">/etc/security/pam_env.conf</code> to set the environment
     variables as specified in this file. It can be used to set the
     <code class="envar">DISPLAY</code> variable to the correct value, because the
     <code class="systemitem">pam_env</code> module knows about the
     location from which the login is taking place.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.gnome"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     <code class="systemitem">pam_gnome_keyring.so</code> checks
     the user's login and password against the GNOME key ring
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.security.pam.sshd.pam_unix"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     <code class="systemitem">pam_unix</code> checks the user's
     login and password against <code class="filename">/etc/passwd</code> and
     <code class="filename">/etc/shadow</code>.
    </p></td></tr></table></div><p>
   The whole stack of <code class="literal">auth</code> modules is processed before
   <code class="systemitem">sshd</code> gets any feedback about
   whether the login has succeeded. All modules of the stack having the
   <code class="literal">required</code> control flag must be processed successfully
   before <code class="systemitem">sshd</code> receives a message
   about the positive result. If one of the modules is not successful, the
   entire module stack is still processed and only then is
   <code class="systemitem">sshd</code> notified about the negative
   result.
  </p><p>
   When all modules of the <code class="literal">auth</code> type have been
   successfully processed, another include statement is processed, in this
   case, that in <a class="xref" href="#dat.pam.common-account" title="Default Configuration for the account Section (common-account)">Example 2.3, “Default Configuration for the <code class="literal">account</code> Section (<code class="filename">common-account</code>)”</a>.
   <code class="filename">common-account</code> contains only one module,
   <code class="literal">pam_unix</code>. If <code class="literal">pam_unix</code> returns the
   result that the user exists, sshd receives a message announcing this
   success and the next stack of modules (<code class="literal">password</code>) is
   processed, shown in <a class="xref" href="#dat.pam.common-password" title="Default Configuration for the password Section (common-password)">Example 2.4, “Default Configuration for the <code class="literal">password</code> Section (<code class="filename">common-password</code>)”</a>.
  </p><div class="example" id="dat.pam.common-account"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.3: </span><span class="name">Default Configuration for the <code class="literal">account</code> Section (<code class="filename">common-account</code>) </span><a title="Permalink" class="permalink" href="#dat.pam.common-account">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">account  required  pam_unix.so  try_first_pass</pre></div></div></div><div class="example" id="dat.pam.common-password"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.4: </span><span class="name">Default Configuration for the <code class="literal">password</code> Section (<code class="filename">common-password</code>) </span><a title="Permalink" class="permalink" href="#dat.pam.common-password">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">password  requisite  pam_cracklib.so
password  optional   pam_gnome_keyring.so  use_authtok
password  required   pam_unix.so  use_authtok nullok shadow try_first_pass</pre></div></div></div><p>
   Again, the PAM configuration of
   <code class="systemitem">sshd</code> involves only an include
   statement referring to the default configuration for
   <code class="literal">password</code> modules located in
   <code class="filename">common-password</code>. These modules must successfully be
   completed (control flags <code class="literal">requisite</code> and
   <code class="literal">required</code>) whenever the application requests the change
   of an authentication token.
  </p><p>
   Changing a password or another authentication token requires a security
   check. This is achieved with the <code class="filename">pam_cracklib</code>
   module. The <code class="filename">pam_unix</code> module used afterward carries
   over any old and new passwords from <code class="filename">pam_cracklib</code>, so
   the user does not need to authenticate again after changing the password.
   This procedure makes it impossible to circumvent the checks carried out
   by <code class="filename">pam_cracklib</code>. Whenever the
   <code class="literal">account</code> or the <code class="literal">auth</code> type are
   configured to complain about expired passwords, the
   <code class="literal">password</code> modules should also be used.
  </p><div class="example" id="dat.pam.common-session"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.5: </span><span class="name">Default Configuration for the <code class="literal">session</code> Section (<code class="filename">common-session</code>) </span><a title="Permalink" class="permalink" href="#dat.pam.common-session">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">session  required  pam_limits.so
session  required  pam_unix.so  try_first_pass
session  optional  pam_umask.so
session  optional  pam_systemd.so
session  optional  pam_gnome_keyring.so auto_start only_if=gdm,gdm-password,lxdm,lightdm
session  optional  pam_env.so</pre></div></div></div><p>
   As the final step, the modules of the <code class="literal">session</code> type
   (bundled in the <code class="filename">common-session</code> file) are called to
   configure the session according to the settings for the user in question.
   The <code class="filename">pam_limits</code> module loads the file
   <code class="filename">/etc/security/limits.conf</code>, which may define limits
   on the use of certain system resources. The <code class="filename">pam_unix</code>
   module is processed again. The <code class="filename">pam_umask</code> module can
   be used to set the file mode creation mask. Since this module carries the
   <code class="literal">optional</code> flag, a failure of this module would not
   affect the successful completion of the entire session module stack. The
   <code class="literal">session</code> modules are called a second time when the user
   logs out.
  </p></div><div class="sect1 " id="sec.pam.struc.conf"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.struc.conf"><span class="number">2.4 </span><span class="name">Configuration of PAM Modules</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.conf">#</a></h2></div></div></div><p>
   Some PAM modules are configurable. The configuration files are
   located in <code class="filename">/etc/security</code>. This section briefly
   describes the configuration files relevant to the sshd
   example—<code class="filename">pam_env.conf</code> and
   <code class="filename">limits.conf</code>.
  </p><div class="sect2 " id="sec.pam.struc.conf.pamenv"><div class="titlepage"><div><div><h3 class="title" id="sec.pam.struc.conf.pamenv"><span class="number">2.4.1 </span><span class="name">pam_env.conf</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.conf.pamenv">#</a></h3></div></div></div><p>
    <code class="filename">pam_env.conf</code> can be used to define a standardized
    environment for users that is set whenever the
    <code class="systemitem">pam_env</code> module is called. With it, preset
    environment variables using the following syntax:
   </p><div class="verbatim-wrap"><pre class="screen"><em class="replaceable ">VARIABLE</em>  [DEFAULT=<em class="replaceable ">VALUE</em>]  [OVERRIDE=<em class="replaceable ">VALUE</em>]</pre></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712071018656"><span class="term "><em class="replaceable ">VARIABLE</em>
     </span></dt><dd><p>
       Name of the environment variable to set.
      </p></dd><dt id="idm140712071016544"><span class="term "><code class="systemitem">[DEFAULT=&lt;value&gt;]</code>
     </span></dt><dd><p>
       Default <em class="replaceable ">VALUE</em> the administrator wants to
       set.
      </p></dd><dt id="idm140712071013984"><span class="term "><code class="systemitem">[OVERRIDE=&lt;value&gt;]</code>
     </span></dt><dd><p>
       Values that may be queried and set by
       <code class="systemitem">pam_env</code>, overriding the default value.
      </p></dd></dl></div><p>
    A typical example of how <code class="systemitem">pam_env</code> can be used is
    the adaptation of the <code class="envar">DISPLAY</code> variable, which is changed
    whenever a remote login takes place. This is shown in
    <a class="xref" href="#dat.pam.pamenv" title="pam_env.conf">Example 2.6, “pam_env.conf”</a>.
   </p><div class="example" id="dat.pam.pamenv"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 2.6: </span><span class="name">pam_env.conf </span><a title="Permalink" class="permalink" href="#dat.pam.pamenv">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">REMOTEHOST  DEFAULT=localhost          OVERRIDE=@{PAM_RHOST}
DISPLAY     DEFAULT=${REMOTEHOST}:0.0  OVERRIDE=${DISPLAY}</pre></div></div></div><p>
    The first line sets the value of the <code class="envar">REMOTEHOST</code> variable
    to <code class="literal">localhost</code>, which is used whenever
    <code class="filename">pam_env</code> cannot determine any other value. The
    <code class="envar">DISPLAY</code> variable in turn contains the value of
    <code class="envar">REMOTEHOST</code>. Find more information in the comments in
    <code class="filename">/etc/security/pam_env.conf</code>.
   </p></div><div class="sect2 " id="sec.pam.struc.conf.pammount"><div class="titlepage"><div><div><h3 class="title" id="sec.pam.struc.conf.pammount"><span class="number">2.4.2 </span><span class="name">pam_mount.conf.xml</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.conf.pammount">#</a></h3></div></div></div><p>
    The purpose of <code class="systemitem">pam_mount</code> is to mount user home
    directories during the login process, and to unmount them during logout
    in an environment where a central file server keeps all the home
    directories of users. With this method, it is not necessary to mount a
    complete <code class="filename">/home</code> directory where all the user home
    directories would be accessible. Instead, only the home directory of the
    user who is about to log in, is mounted.
   </p><p>
    After installing <code class="systemitem">pam_mount</code>, a template for
    <code class="filename">pam_mount.conf.xml</code> is available in
    <code class="filename">/etc/security</code>. The description of the various
    elements can be found in the manual page <code class="command">man 5
    pam_mount.conf</code>.
   </p><p>
    A basic configuration of this feature can be done with YaST. Select
    <span class="guimenu">Network Settings</span> › <span class="guimenu">Windows Domain
    Membership</span> › <span class="guimenu">Expert Settings</span> to
    add the file server; see <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 21 “Samba”, Section 21.5 “Configuring Clients”</span>.
   </p></div><div class="sect2 " id="sec.pam.struc.pamlimits"><div class="titlepage"><div><div><h3 class="title" id="sec.pam.struc.pamlimits"><span class="number">2.4.3 </span><span class="name">limits.conf</span> <a title="Permalink" class="permalink" href="#sec.pam.struc.pamlimits">#</a></h3></div></div></div><p>
    System limits can be set on a user or group basis in
    <code class="filename">limits.conf</code>, which is read by the
    <code class="systemitem">pam_limits</code> module. The file allows you to set
    hard limits, which may not be exceeded, and soft limits, which
    may be exceeded temporarily. For more information about the syntax and
    the options, see the comments in
    <code class="filename">/etc/security/limits.conf</code>.
   </p></div></div><div class="sect1 " id="sec.pam.pam-config"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.pam-config"><span class="number">2.5 </span><span class="name">Configuring PAM Using pam-config</span> <a title="Permalink" class="permalink" href="#sec.pam.pam-config">#</a></h2></div></div></div><p>
   The <code class="command">pam-config</code> tool helps you configure the global PAM
   configuration files (<code class="filename">/etc/pam.d/common-*</code>) and
   several selected application configurations. For a list of supported
   modules, use the <code class="command">pam-config --list-modules</code> command.
   Use the <code class="command">pam-config</code> command to maintain your PAM
   configuration files. Add new modules to your PAM configurations, delete
   other modules or modify options to these modules. When changing global
   PAM configuration files, no manual tweaking of the PAM setup for
   individual applications is required.
  </p><p>
   A simple use case for <code class="command">pam-config</code> involves the
   following:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p><span class="formalpara-title">Auto-generate a fresh Unix-style PAM configuration. </span>
      Let pam-config create the simplest possible setup which you can extend
      later on. The <code class="command">pam-config --create</code> command creates a
      simple Unix authentication configuration. Pre-existing configuration
      files not maintained by pam-config are overwritten, but backup copies
      are kept as <code class="literal">*.pam-config-backup</code>.
     </p></li><li class="step "><p><span class="formalpara-title">Add a new authentication method. </span>
      Adding a new authentication method (for example, LDAP) to your stack
      of PAM modules comes down to a simple <code class="command">pam-config --add
      --ldap</code> command. LDAP is added wherever appropriate across
      all <code class="filename">common-*-pc</code> PAM configuration files.
     </p></li><li class="step "><p><span class="formalpara-title">Add debugging for test purposes. </span>
      To make sure the new authentication procedure works as planned, turn
      on debugging for all PAM-related operations. The <code class="command">pam-config
      --add --ldap-debug</code> turns on debugging for LDAP-related PAM
      operations. Find the debugging output in the <code class="systemitem">systemd</code> journal (see
      <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 11 “<code class="command">journalctl</code>: Query the <code class="systemitem">systemd</code> Journal”</span>).
     </p></li><li class="step "><p><span class="formalpara-title">Query your setup. </span>
      Before you finally apply your new PAM setup, check if it contains all
      the options you wanted to add. The <code class="command">pam-config --query
      --</code> <em class="replaceable ">MODULE</em> lists both the type and
      the options for the queried PAM module.
     </p></li><li class="step "><p><span class="formalpara-title">Remove the debug options. </span>
      Finally, remove the debug option from your setup when you are entirely
      satisfied with the performance of it. The <code class="command">pam-config --delete
      --ldap-debug</code> command turns off debugging for LDAP
      authentication. In case you had debugging options added for other
      modules, use similar commands to turn these off.
     </p></li></ol></div></div><p>
   For more information on the <code class="command">pam-config</code> command and the
   options available, refer to the manual page of
   <code class="command">pam-config(8)</code>.
  </p></div><div class="sect1 " id="sec.pam.manual-config"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.manual-config"><span class="number">2.6 </span><span class="name">Manually Configuring PAM</span> <a title="Permalink" class="permalink" href="#sec.pam.manual-config">#</a></h2></div></div></div><p>
   If you prefer to manually create or maintain your PAM configuration
   files, make sure to disable <code class="command">pam-config</code> for these
   files.
  </p><p>
   When you create your PAM configuration files from scratch using the
   <code class="command">pam-config --create</code> command, it creates symbolic links
   from the <code class="filename">common-<em class="replaceable ">*</em></code> to the
   <code class="filename">common-<em class="replaceable ">*</em>-pc</code> files.
   <code class="command">pam-config</code> only modifies the
   <code class="filename">common-<em class="replaceable ">*</em>-pc</code> configuration
   files. Removing these symbolic links effectively disables pam-config,
   because pam-config only operates on the
   <code class="filename">common-<em class="replaceable ">*</em>-pc</code> files and
   these files are not put into effect without the symbolic links.
  </p><div id="idm140712070963616" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Include <code class="filename">pam_systemd.so</code> into Configuration</h6><p>
    If you are creating your own PAM configuration, make sure to include
    a <code class="literal">session  optional  pam_systemd.so</code>. Not including
    the <code class="literal">pam_systemd.so</code> can cause problems with
    <code class="systemitem">systemd</code> task limits. For details, refer to the man page of
    <code class="literal">pam_systemd.so</code>.
   </p></div></div><div class="sect1 " id="sec.pam.info"><div class="titlepage"><div><div><h2 class="title" id="sec.pam.info"><span class="number">2.7 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.pam.info">#</a></h2></div></div></div><p>
   In the <code class="filename">/usr/share/doc/packages/pam</code> directory after
   installing the <code class="systemitem">pam-doc</code> package, find the
   following additional documentation:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070956560"><span class="term ">READMEs</span></dt><dd><p>
      In the top level of this directory, there is the
      <code class="filename">modules</code> subdirectory holding README files about
      the available PAM modules.
     </p></dd><dt id="idm140712070954208"><span class="term ">The Linux-PAM System Administrators' Guide</span></dt><dd><p>
      This document comprises everything that the system administrator
      should know about PAM. It discusses a range of topics, from the syntax
      of configuration files to the security aspects of PAM.
     </p></dd><dt id="idm140712070952192"><span class="term ">The Linux-PAM Module Writers' Manual</span></dt><dd><p>
      This document summarizes the topic from the developer's point of view,
      with information about how to write standard-compliant PAM modules.
     </p></dd><dt id="idm140712070950240"><span class="term ">The Linux-PAM Application Developers' Guide</span></dt><dd><p>
      This document comprises everything needed by an application developer
      who wants to use the PAM libraries.
     </p></dd><dt id="idm140712070948304"><span class="term ">The PAM Manual Pages</span></dt><dd><p>
      PAM in general and the individual modules come with manual
      pages that provide a good overview of the functionality of all the
      components.
     </p></dd></dl></div></div></div><div class="chapter " id="cha.nis"><div class="titlepage"><div><div><h2 class="title"><span class="number">3 </span><span class="name">Using NIS</span> <a title="Permalink" class="permalink" href="#cha.nis">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_nis.xml</li><li><span class="ds-label">ID: </span>cha.nis</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712070943296">#</a></h6></div><p>
    When multiple Unix systems in a network access common resources,
    it becomes imperative that all user and group identities are the same
    for all machines in that network. The network should be transparent to
    users: their environments should not vary, regardless of which machine
    they are actually using. This can be done by means of NIS and NFS
    services. NFS distributes file systems over a network and is discussed
    in <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 22 “Sharing File Systems with NFS”</span>.
   </p><p>
    NIS (Network Information Service) can be described as a database-like
    service that provides access to the contents of
    <code class="filename">/etc/passwd</code>, <code class="filename">/etc/shadow</code>, and
    <code class="filename">/etc/group</code> across networks. NIS can also be used
    for other purposes (making the contents of files like
    <code class="filename">/etc/hosts</code> or <code class="filename">/etc/services</code>
    available, for example), but this is beyond the scope of this
    introduction. People often refer to NIS as <span class="emphasis"><em>YP</em></span>,
    because it works like the network's <span class="quote">“<span class="quote">yellow pages.</span>”</span>
        </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.nis.server"><span class="number">3.1 </span><span class="name">Configuring NIS Servers</span></a></span></dt><dt><span class="sect1"><a href="#sec.nis.client"><span class="number">3.2 </span><span class="name">Configuring NIS Clients</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.nis.server"><div class="titlepage"><div><div><h2 class="title" id="sec.nis.server"><span class="number">3.1 </span><span class="name">Configuring NIS Servers</span> <a title="Permalink" class="permalink" href="#sec.nis.server">#</a></h2></div></div></div><p>
   To distribute NIS information across networks, either install one single
   server (a <span class="emphasis"><em>master</em></span>) that serves all clients, or NIS
   slave servers requesting this information from the master and relaying it
   to their respective clients.
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     To configure just one NIS server for your network, proceed with
     <a class="xref" href="#sec.nis.server.master" title="3.1.1. Configuring a NIS Master Server">Section 3.1.1, “Configuring a NIS Master Server”</a>.
    </p></li><li class="listitem "><p>
     If your NIS master server needs to export its data to slave servers,
     set up the master server as described in
     <a class="xref" href="#sec.nis.server.master" title="3.1.1. Configuring a NIS Master Server">Section 3.1.1, “Configuring a NIS Master Server”</a> and set up slave servers in the
     subnets as described in <a class="xref" href="#sec.nis.server.slave" title="3.1.2. Configuring a NIS Slave Server">Section 3.1.2, “Configuring a NIS Slave Server”</a>.
    </p></li></ul></div><div class="sect2 " id="sec.nis.server.master"><div class="titlepage"><div><div><h3 class="title" id="sec.nis.server.master"><span class="number">3.1.1 </span><span class="name">Configuring a NIS Master Server</span> <a title="Permalink" class="permalink" href="#sec.nis.server.master">#</a></h3></div></div></div><p>
    To manage the NIS Server functionality with YaST, install the <code class="systemitem">yast2-nis-server</code> package by running the <code class="command">zypper in yast2-nis-server</code> command as root. To configure a NIS master server for your network, proceed as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start <span class="guimenu">YaST</span> › <span class="guimenu">Network
      Services</span> › <span class="guimenu">NIS Server</span>.
     </p></li><li class="step "><p>
      If you need just one NIS server in your network or if this server is
      to act as the master for further NIS slave servers, select
      <span class="guimenu">Install and Set Up NIS Master Server</span>. YaST
      installs the required packages.
     </p><div id="idm140712070921840" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Already Installed NIS Server Software</h6><p>
       If NIS server software is already installed on your machine, initiate
       the creation of a NIS master server by clicking <span class="guimenu">Create NIS
       Master Server</span>.
      </p></div><div class="figure" id="fig.inst.nisserver1"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_nis1_no_nis_installed_kde.png"><img src="images/yast2_nis1_no_nis_installed_kde.png" width="" alt="NIS Server Setup" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.1: </span><span class="name">NIS Server Setup </span><a title="Permalink" class="permalink" href="#fig.inst.nisserver1">#</a></h6></div></div></li><li class="step "><p>
      Determine basic NIS setup options:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Enter the NIS domain name.
       </p></li><li class="step "><p>
        Define whether the host should also be a NIS client (enabling users
        to log in and access data from the NIS server) by selecting
        <span class="guimenu">This Host is also a NIS Client</span>.
       </p></li><li class="step "><p>
        If your NIS server needs to act as a master server to NIS slave
        servers in other subnets, select <span class="guimenu">Active Slave NIS Server
        Exists</span>.
       </p><p>
        The option <span class="guimenu">Fast Map Distribution</span> is only useful
        with <span class="guimenu">Active Slave NIS Servers
        Exist</span>. It speeds up the transfer of maps to the slaves.
       </p></li><li class="step "><p>
        Select <span class="guimenu">Allow Changes to Passwords</span> to allow users
        in your network (both local users and those managed through the NIS
        server) to change their passwords on the NIS server (with the
        command <code class="command">yppasswd</code>). This makes the options
        <span class="guimenu">Allow Changes to GECOS Field</span> and <span class="guimenu">Allow
        Changes to Login Shell</span> available. <span class="quote">“<span class="quote">GECOS</span>”</span>
        means that the users can also change their names and address
        settings with the command <code class="command">ypchfn</code>.
        <span class="quote">“<span class="quote">Shell</span>”</span> allows users to change their default shell with
        the command <code class="command">ypchsh</code> (for example, to switch from
        Bash to sh). The new shell must be one of the predefined entries in
        <code class="filename">/etc/shells</code>.
       </p></li><li class="step "><p>
        Select <span class="guimenu">Open Port in Firewall</span> to have YaST
        adapt the firewall settings for the NIS server.
       </p><div class="figure" id="fig.yast.nis.master"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_nis_master_kde.png"><img src="images/yast2_nis_master_kde.png" width="" alt="Master Server Setup" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.2: </span><span class="name">Master Server Setup </span><a title="Permalink" class="permalink" href="#fig.yast.nis.master">#</a></h6></div></div></li><li class="step "><p>
        Leave this dialog with <span class="guimenu">Next</span> or click
        <span class="guimenu">Other Global Settings</span> to make additional
        settings.
       </p><p>
        <span class="guimenu">Other Global Settings</span> include changing the source
        directory of the NIS server (<code class="filename">/etc</code> by default).
        In addition, passwords can be merged here. The setting should be
        <span class="guimenu">Yes</span> to create the user database from the system
        authentication files <code class="filename">/etc/passwd</code>,
        <code class="filename">/etc/shadow</code>, and
        <code class="filename">/etc/group</code>. Also, determine the smallest user
        and group ID that should be offered by NIS. Click
        <span class="guimenu">OK</span> to confirm your settings and return to the
        previous screen.
       </p><div class="figure" id="fig.inst.nisserver2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_inst_nisserver2_kde.png"><img src="images/yast2_inst_nisserver2_kde.png" width="" alt="Changing the Directory and Synchronizing Files for a NIS Server" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.3: </span><span class="name">Changing the Directory and Synchronizing Files for a NIS Server </span><a title="Permalink" class="permalink" href="#fig.inst.nisserver2">#</a></h6></div></div></li></ol></li><li class="step "><p>
      If you previously enabled <span class="guimenu">Active Slave NIS Server
      Exists</span>, enter the host names used as slaves and click
      <span class="guimenu">Next</span>. If no slave servers exist, this configuration
      step is skipped.
     </p></li><li class="step "><p>
      Continue to the dialog for the database configuration. Specify the
      <span class="emphasis"><em>NIS Server Maps</em></span>, the partial databases to
      transfer from the NIS server to the client. The default settings are
      usually adequate. Leave this dialog with <span class="guimenu">Next</span>.
     </p></li><li class="step "><p>
      Check which maps should be available and click <span class="guimenu">Next</span>
      to continue.
     </p><div class="figure" id="fig.yast.nis.maps"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_nis_maps_kde.png"><img src="images/yast2_nis_maps_kde.png" width="" alt="NIS Server Maps Setup" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.4: </span><span class="name">NIS Server Maps Setup </span><a title="Permalink" class="permalink" href="#fig.yast.nis.maps">#</a></h6></div></div></li><li class="step "><p>
      Determine which hosts are allowed to query the NIS server. You can
      add, edit, or delete hosts by clicking the appropriate button. Specify
      from which networks requests can be sent to the NIS server. Normally,
      this is your internal network. In this case, there should be the
      following two entries:
     </p><div class="verbatim-wrap"><pre class="screen">255.0.0.0     127.0.0.0
0.0.0.0       0.0.0.0</pre></div><p>
      The first entry enables connections from your own host, which is the
      NIS server. The second one allows all hosts to send requests to the
      server.
     </p><div class="figure" id="fig.inst.nisserver3"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_nis_hosts_kde.png"><img src="images/yast2_nis_hosts_kde.png" width="" alt="Setting Request Permissions for a NIS Server" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.5: </span><span class="name">Setting Request Permissions for a NIS Server </span><a title="Permalink" class="permalink" href="#fig.inst.nisserver3">#</a></h6></div></div></li><li class="step "><p>
      Click <span class="guimenu">Finish</span> to save your changes and exit the
      setup.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.nis.server.slave"><div class="titlepage"><div><div><h3 class="title" id="sec.nis.server.slave"><span class="number">3.1.2 </span><span class="name">Configuring a NIS Slave Server</span> <a title="Permalink" class="permalink" href="#sec.nis.server.slave">#</a></h3></div></div></div><p>
    To configure additional NIS <span class="emphasis"><em>slave servers</em></span> in your
    network, proceed as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start <span class="guimenu">YaST</span> › <span class="guimenu">Network
      Services</span> › <span class="guimenu">NIS Server</span>.
     </p></li><li class="step "><p>
      Select <span class="guimenu">Install and Set Up NIS Slave Server</span> and
      click <span class="guimenu">Next</span>.
     </p><div id="idm140712070854288" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
       If NIS server software is already installed on your machine, initiate
       the creation of a NIS slave server by clicking <span class="guimenu">Create NIS
       Slave Server</span>.
      </p></div></li><li class="step "><p>
      Complete the basic setup of your NIS slave server:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Enter the NIS domain.
       </p></li><li class="step "><p>
        Enter host name or IP address of the master server.
       </p></li><li class="step "><p>
        Set <span class="guimenu">This Host is also a NIS Client</span> if you want to
        enable user logins on this server.
       </p></li><li class="step "><p>
        Adapt the firewall settings with <span class="guimenu">Open Ports in
        Firewall</span>.
       </p></li><li class="step "><p>
        Click <span class="guimenu">Next</span>.
       </p></li></ol></li><li class="step "><p>
      Enter the hosts that are allowed to query the NIS server. You can add,
      edit, or delete hosts by clicking the appropriate button. Specify all
      networks from which requests can be sent to the NIS server. If it
      applies to all networks, use the following configuration:
     </p><div class="verbatim-wrap"><pre class="screen">255.0.0.0     127.0.0.0
0.0.0.0       0.0.0.0</pre></div><p>
      The first entry enables connections from your own host, which is the
      NIS server. The second one allows all hosts with access to the same
      network to send requests to the server.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Finish</span> to save changes and exit the setup.
     </p></li></ol></div></div></div></div><div class="sect1 " id="sec.nis.client"><div class="titlepage"><div><div><h2 class="title" id="sec.nis.client"><span class="number">3.2 </span><span class="name">Configuring NIS Clients</span> <a title="Permalink" class="permalink" href="#sec.nis.client">#</a></h2></div></div></div><p>
   To use NIS on a workstation, do the following:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start <span class="guimenu">YaST</span> › <span class="guimenu">Network
     Services</span> › <span class="guimenu">NIS Client</span>.
    </p></li><li class="step "><p>
     Activate the <span class="guimenu">Use NIS</span> button.
    </p></li><li class="step "><p>
     Enter the NIS domain. This is usually a domain name given by your
     administrator or a static IP address received by DHCP.
     <span class="phrase">For information about DHCP, see
     <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 20 “DHCP”</span>.</span>
    </p><div class="figure" id="fig.inst.nisclient"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_inst_nisclient.png"><img src="images/yast2_inst_nisclient.png" width="" alt="Setting Domain and Address of a NIS Server" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 3.6: </span><span class="name">Setting Domain and Address of a NIS Server </span><a title="Permalink" class="permalink" href="#fig.inst.nisclient">#</a></h6></div></div></li><li class="step "><p>
     Enter your NIS servers and separate their addresses by spaces. If you
     do not know your NIS server, click <span class="guimenu">Find</span> to let
     YaST search for any NIS servers in your domain. Depending on the
     size of your local network, this may be a time-consuming process.
     <span class="guimenu">Broadcast</span> asks for a NIS server in the local network
     after the specified servers fail to respond.
    </p></li><li class="step "><p>
     Depending on your local installation, you may also want to activate the
     automounter. This option also installs additional software if required.
    </p></li><li class="step "><p>
     If you do not want other hosts to be able to query which server your
     client is using, go to the <span class="guimenu">Expert</span> settings and
     disable <span class="guimenu">Answer Remote Hosts</span>. By checking
     <span class="guimenu">Broken Server</span>, the client is enabled to receive
     replies from a server communicating through an unprivileged port. For
     further information, see
     <code class="command">man</code> <code class="option">ypbind</code>.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Finish</span> to save them and return to the
     YaST control center. Your client is now configured with NIS.
    </p></li></ol></div></div></div></div><div class="chapter " id="cha.security.auth"><div class="titlepage"><div><div><h2 class="title"><span class="number">4 </span><span class="name">Setting Up Authentication Servers and Clients Using YaST</span> <a title="Permalink" class="permalink" href="#cha.security.auth">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_auth.xml</li><li><span class="ds-label">ID: </span>cha.security.auth</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712070816000">#</a></h6></div><p>
    The Authentication Server is based on LDAP and optionally Kerberos. On
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> you can configure it with a YaST wizard.
   </p><p>
    For more information about LDAP, see
    <a class="xref" href="#cha.security.ldap" title="Chapter 5. LDAP—A Directory Service">Chapter 5, <em>LDAP—A Directory Service</em></a>, and about Kerberos, see
    <a class="xref" href="#cha.security.kerberos" title="Chapter 6. Network Authentication with Kerberos">Chapter 6, <em>Network Authentication with Kerberos</em></a>.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.auth.yast"><span class="number">4.1 </span><span class="name">Configuring an Authentication Server with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.auth.yast.client"><span class="number">4.2 </span><span class="name">Configuring an Authentication Client with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.auth.sssd"><span class="number">4.3 </span><span class="name">SSSD</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.auth.yast"><div class="titlepage"><div><div><h2 class="title" id="sec.security.auth.yast"><span class="number">4.1 </span><span class="name">Configuring an Authentication Server with YaST</span> <a title="Permalink" class="permalink" href="#sec.security.auth.yast">#</a></h2></div></div></div><div class="sect2 " id="sec.security.auth.yast.init"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.yast.init"><span class="number">4.1.1 </span><span class="name">Initial Configuration of an Authentication Server</span> <a title="Permalink" class="permalink" href="#sec.security.auth.yast.init">#</a></h3></div></div></div><p>
    To set up an authentication server for user account data, make sure the
    <code class="systemitem">yast2-auth-server</code>,
    <code class="systemitem">openldap2</code>,
    <code class="systemitem">krb5-server</code>, and
    <code class="systemitem">krb5-client</code> packages are installed; YaST will
    remind you and install them if one of these packages is missing. For
    Kerberos support, the <code class="systemitem">krb5-plugin-kdb-ldap</code>
    package is required.
   </p><p>
    The first part of the Authentication Server configuration with YaST is
    setting up an LDAP server, then you can enable Kerberos.
   </p><div class="procedure " id="idm140712070804640"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 4.1: </span><span class="name">Authentication Server Configuration with YaST </span><a title="Permalink" class="permalink" href="#idm140712070804640">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST as <code class="systemitem">root</code> and select <span class="guimenu">Network
      Services</span> › <span class="guimenu">Authentication Server</span> to invoke the configuration wizard.
     </p></li><li class="step "><p>
      Configure the <span class="guimenu">Global Settings</span> of your LDAP server
      (you can change these settings later)—see
      <a class="xref" href="#fig.auth.y2.wizard.general.settings" title="YaST Authentication Server Configuration">Figure 4.1, “YaST Authentication Server Configuration”</a>:
     </p><div class="figure" id="fig.auth.y2.wizard.general.settings"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_wizard_general_settings.png"><img src="images/yast2_auth_wizard_general_settings.png" width="" alt="YaST Authentication Server Configuration" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 4.1: </span><span class="name">YaST Authentication Server Configuration </span><a title="Permalink" class="permalink" href="#fig.auth.y2.wizard.general.settings">#</a></h6></div></div><ol type="a" class="substeps "><li class="step "><p>
        Set LDAP to be started.
       </p></li><li class="step "><p>
        If the LDAP server should announce its services via SLP, check
        <span class="guimenu">Register at an SLP Daemon</span>.
       </p></li><li class="step "><p>
        Configure <span class="guimenu">Firewall Settings</span>.
       </p></li><li class="step "><p>
        Click <span class="guimenu">Next</span>.
       </p></li></ol></li><li class="step "><p>
      Select the server type: <span class="guimenu">Stand-alone server</span>,
      <span class="guimenu">Master server in a replication setup</span>, or
      <span class="guimenu">Replica (slave) server</span>.
     </p></li><li class="step "><p>
      Select security options (<span class="guimenu">TLS Settings</span>).
     </p><p>
      It is strongly recommended to <span class="guimenu">Enable TLS</span>. For more
      information, see <a class="xref" href="#proc.auth.server.config" title="Editing Authentication Server Configuration">Procedure 4.2, “Editing Authentication Server Configuration”</a>,
      <a class="xref" href="#step.auth.server.config.tls" title="Step 4">Step 4</a>.
     </p><div id="idm140712070782144" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Authentication Without Encryption</h6><p>
        When using authentication without enabling transport encryption
        using TLS, the password will be transmitted in the clear.
       </p></div><p>
      Also consider using LDAP over SSL with certificates.
     </p></li><li class="step "><p>
      Confirm <span class="guimenu">Basic Database Settings</span> with entering an
      <span class="guimenu">LDAP Administrator Password</span> and then clicking
      <span class="guimenu">Next</span>—see
      <a class="xref" href="#fig.auth.y2.wizard.db.settings" title="YaST LDAP Server—New Database">Figure 4.2, “YaST LDAP Server—New Database”</a>.
     </p><div class="figure" id="fig.auth.y2.wizard.db.settings"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_wizard_db_settings.png"><img src="images/yast2_auth_wizard_db_settings.png" width="" alt="YaST LDAP Server—New Database" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 4.2: </span><span class="name">YaST LDAP Server—New Database </span><a title="Permalink" class="permalink" href="#fig.auth.y2.wizard.db.settings">#</a></h6></div></div></li><li class="step "><p>
      In the <span class="guimenu">Kerberos Authentication</span> dialog, decide
      whether to enable Kerberos authentication or not (you can change these
      settings later)—see
      <a class="xref" href="#fig.auth.y2.wizard.kerberos.yes" title="YaST Kerberos Authentication">Figure 4.3, “YaST Kerberos Authentication”</a>.
     </p><div class="figure" id="fig.auth.y2.wizard.kerberos.yes"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_wizard_kerberos_yes.png"><img src="images/yast2_auth_wizard_kerberos_yes.png" width="" alt="YaST Kerberos Authentication" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 4.3: </span><span class="name">YaST Kerberos Authentication </span><a title="Permalink" class="permalink" href="#fig.auth.y2.wizard.kerberos.yes">#</a></h6></div></div></li><li class="step "><p>
      Choose whether Kerberos support is needed or not. If you enable it,
      also specify your <span class="guimenu">Realm</span>. Then confirm with
      <span class="guimenu">Next</span>.
     </p><ol type="a" class="substeps "><li class="step "><p>
        The <span class="guimenu">Advanced Configuration</span> allows you to specify
        various aspects such as <span class="guimenu">Maximum ticket life time</span>
        or ports to use.
       </p></li></ol></li><li class="step "><p>
      Finally, check the <span class="guimenu">Authentication Server Configuration
      Summary</span> and click <span class="guimenu">Finish</span> to exit the
      configuration wizard.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.security.auth.yast.edit"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.yast.edit"><span class="number">4.1.2 </span><span class="name">Editing an Authentication Server Configuration with YaST</span> <a title="Permalink" class="permalink" href="#sec.security.auth.yast.edit">#</a></h3></div></div></div><p>
    For changes or additional configuration start the Authentication Server
    module again and in the left pane expand <span class="guimenu">Global
    Settings</span> to make subentries visible—see
    <a class="xref" href="#fig.auth.y2.server.cfg" title="YaST Editing Authentication Server Configuration">Figure 4.4, “YaST Editing Authentication Server Configuration”</a>:
   </p><div class="figure" id="fig.auth.y2.server.cfg"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_server_cfg.png"><img src="images/yast2_auth_server_cfg.png" width="" alt="YaST Editing Authentication Server Configuration" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 4.4: </span><span class="name">YaST Editing Authentication Server Configuration </span><a title="Permalink" class="permalink" href="#fig.auth.y2.server.cfg">#</a></h6></div></div><div class="procedure " id="proc.auth.server.config"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 4.2: </span><span class="name">Editing Authentication Server Configuration </span><a title="Permalink" class="permalink" href="#proc.auth.server.config">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      With <span class="guimenu">Log Level Settings</span>, configure the degree of
      logging activity (verbosity) of the LDAP server. From the predefined
      list, select or deselect logging options according to your needs. The
      more options are enabled, the larger your log files grow.
     </p></li><li class="step "><p>
      Configure which connection types the server should offer under
      <span class="guimenu">Allow/Disallow Features</span>. Choose from:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070744944"><span class="term ">LDAPv2 Bind Requests</span></dt><dd><p>
         This option enables connection requests (bind requests) from
         clients using the previous version of the protocol (LDAPv2).
        </p></dd><dt id="idm140712070743024"><span class="term ">Anonymous Bind When Credentials Not Empty</span></dt><dd><p>
         Normally, the LDAP server denies any authentication attempts with
         empty credentials, that is, a distinguished name (DN) or a password.
         However, enabling this option
         makes it possible to connect with a password and no DN to establish
         an anonymous connection.
        </p></dd><dt id="idm140712070740896"><span class="term ">Unauthenticated Bind When DN Not Empty</span></dt><dd><p>
         Enabling this option makes it possible to connect without
         authentication (anonymously) using a distinguished name (DN) but no
         password.
        </p></dd><dt id="idm140712070738928"><span class="term ">Unauthenticated Update Options to Process</span></dt><dd><p>
         Enabling this option allows non-authenticated (anonymous) update
         operations. Access is restricted according to ACLs and other rules.
        </p></dd></dl></div></li><li class="step "><p>
      <span class="guimenu">Allow/Disallow Features</span> also lets you configure the
      server flags. Choose from:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070735120"><span class="term ">Disable Acceptance of Anonymous Bind Requests</span></dt><dd><p>
         The server will no longer accept anonymous bind requests. Note,
         that this does not generally prohibit anonymous directory access.
        </p></dd><dt id="idm140712070733152"><span class="term ">Disable Simple Bind Authentication</span></dt><dd><p>
         Completely disable Simple Bind authentication.
        </p></dd><dt id="idm140712070731296"><span class="term ">Disable Forcing Session to Anonymous Status upon StartTLS Operation Receipt</span></dt><dd><p>
         The server will no longer force an authenticated connection back to
         the anonymous state when receiving the StartTLS operation.
        </p></dd><dt id="idm140712070729296"><span class="term ">Disallow the StartTLS Operation if Authenticated</span></dt><dd><p>
         The server will disallow the StartTLS operation on already
         authenticated connections.
        </p></dd></dl></div></li><li class="step " id="step.auth.server.config.tls"><p>
      To configure secure communication between client and server, proceed
      with <span class="guimenu">TLS Settings</span>:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Activate <span class="guimenu">Enable TLS</span> to enable TLS and SSL
        encryption of the client/server communication.
       </p></li><li class="step "><p>
        Either <span class="guimenu">Import Certificate</span> by specifying the exact
        path to its location or enable the <span class="guimenu">Use Common Server
        Certificate</span>. If the <span class="guimenu">Use Common Server
        Certificate</span> is not available, because it has not been
        created during installation, go for <span class="guimenu">Launch CA Management
        Module</span> first—for more information, see
        <a class="xref" href="#sec.security.yast_ca.module" title="18.2. YaST Modules for CA Management">Section 18.2, “YaST Modules for CA Management”</a>.
       </p></li></ol></li></ol></div></div><p>


    Add Schema files to be included in the server's configuration by
    selecting <span class="guimenu">Schema Files</span> in the left part of the
    dialog. The default selection of schema files applies to the server
    providing a source of YaST user account data.
   </p><p>
    YaST allows to add traditional Schema files (usually with a name
    ending in <code class="literal">.schema</code>) or LDIF files containing Schema
    definitions in OpenLDAP's LDIF Schema format.
   </p><div class="figure" id="fig.auth.y2.server.db.cfg"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_server_db_cfg.png"><img src="images/yast2_auth_server_db_cfg.png" width="" alt="YaST Authentication Server Database Configuration" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 4.5: </span><span class="name">YaST Authentication Server Database Configuration </span><a title="Permalink" class="permalink" href="#fig.auth.y2.server.db.cfg">#</a></h6></div></div><p>
    To configure the databases managed by your LDAP server, proceed as
    follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Select the <span class="guimenu">Databases</span> item in the left part of the
      dialog.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Add Database</span> to add a new database.
     </p></li><li class="step "><p>
      Specify the requested data:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070707328"><span class="term "><span class="guimenu">Base DN</span>
       </span></dt><dd><p>
         Enter the base DN (distinguished name) of your LDAP server.
        </p></dd><dt id="idm140712070705184"><span class="term "><span class="guimenu">Administrator DN</span>
       </span></dt><dd><p>
         Enter the DN of the administrator in charge of the server. If you
         check <span class="guimenu">Append Base DN</span>, only provide the
         <code class="literal">cn</code> of the administrator and the system fills in
         the rest automatically.
        </p></dd><dt id="idm140712070702048"><span class="term ">LDAP Administrator Password</span></dt><dd><p>
         Enter the password for the database administrator.
        </p></dd><dt id="idm140712070700192"><span class="term ">Use This Database as the Default for OpenLDAP Clients</span></dt><dd><p>
         For convenience, check this option if wanted.
        </p></dd></dl></div></li><li class="step "><p>
      In the next dialog, configure replication settings.
     </p></li><li class="step "><p>
      In the next dialog, enable enforcement of password policies to provide
      extra security to your LDAP server:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Check <span class="guimenu">Enable Password Policies</span> to be able to
        specify a password policy.
       </p></li><li class="step "><p>
        Activate <span class="guimenu">Hash Clear Text Passwords</span> to have clear
        text passwords be hashed before they are written to the database
        whenever they are added or modified.
       </p></li><li class="step "><p>
        <span class="guimenu">Disclose "Account Locked" Status</span> provides a
        relevant error message for bind requests to locked accounts.
       </p><div id="idm140712070691472" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Locked Accounts in Security Sensitive Environments</h6><p>
         Do not use the <span class="guimenu">Disclose "Account Locked" Status</span>
         option if your environment is sensitive to security issues, because
         the <span class="quote">“<span class="quote">Locked Account</span>”</span> error message provides
         security-sensitive information that can be exploited by a potential
         attacker.
        </p></div></li><li class="step "><p>
        Enter the DN of the default policy object. To use a DN other than
        the one suggested by YaST, enter your choice. Otherwise, accept
        the default settings.
       </p></li></ol></li><li class="step "><p>
      Complete the database configuration by clicking
      <span class="guimenu">Finish</span>.
     </p></li></ol></div></div><p>
    If you have not opted for password policies, your server is ready to run
    at this point. If you have chosen to enable password policies, proceed
    with the configuration of the password policy in detail. If you have
    chosen a password policy object that does not yet exist, YaST creates
    one:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Enter the LDAP server password. In the navigation tree below
      <span class="guimenu">Databases</span> expand your database object and activate
      the <span class="guimenu">Password Policy Configuration</span> item.
     </p></li><li class="step "><p>
      Make sure <span class="guimenu">Enable Password Policies</span> is activated.
      Then click <span class="guimenu">Edit Policy</span>.
     </p></li><li class="step "><p>
      Configure the password change policies:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Determine the number of passwords stored in the password history.
        Saved passwords may not be reused by the user.
       </p></li><li class="step "><p>
        Determine if users can change their passwords and if
        they will need to change their passwords after a reset by the
        administrator. Require the old password for password changes
        (optional).
       </p></li><li class="step "><p>
        Determine whether and to what extent passwords should be subject to
        quality checking. Set the minimum password length that must be met
        before a password is valid. If you select <span class="guimenu">Accept
        Uncheckable Passwords</span>, users are allowed to use encrypted
        passwords, even though the quality checks cannot be performed. If
        you opt for <span class="guimenu">Only Accept Checked Passwords</span> only
        those passwords that pass the quality tests are accepted as valid.
       </p></li></ol></li><li class="step "><p>
      Configure the password time-limit policies:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Determine the minimum password time-limit (the time that needs to
        pass between two valid password changes) and the maximum password
        time limit.
       </p></li><li class="step "><p>
        Determine the time between a password expiration warning and the
        actual password expiration.
       </p></li><li class="step "><p>
        Set the number of postponement uses of an expired password before
        the password expires permanently.
       </p></li></ol></li><li class="step "><p>
      Configure the lockout policies:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Enable password locking.
       </p></li><li class="step "><p>
        Determine the number of bind failures that trigger a password lock.
       </p></li><li class="step "><p>
        Determine the duration of the password lock.
       </p></li><li class="step "><p>
        Determine the length of time that password failures are kept in the
        cache before they are purged.
       </p></li></ol></li><li class="step "><p>
      Apply your password policy settings with <span class="guimenu">OK</span>.
     </p></li></ol></div></div><p>
    To edit a previously created database, select its base DN in the tree to
    the left. In the right part of the window, YaST displays a dialog
    similar to the one used for the creation of a new database (with the
    main difference that the base DN entry is grayed out and cannot be
    changed).
   </p><p>
    After leaving the Authentication Server configuration by selecting
    <span class="guimenu">Finish</span>, you are ready to go with a basic working
    configuration for your Authentication Server. To fine-tune this setup,
    use OpenLDAP's dynamic configuration back-end.
   </p><p>

    The OpenLDAP's dynamic configuration back-end stores the configuration
    in an LDAP database. That database consists of a set of
    <code class="literal">.ldif</code> files in
    <code class="filename">/etc/openldap/slapd.d</code>. There is no need to access
    these files directly. To access the settings you can either use the
    YaST Authentication Server module (the
    <code class="systemitem">yast2-auth-server</code> package) or an LDAP client
    such as <code class="command">ldapmodify</code> or <code class="command">ldapsearch</code>.
    For more information on the dynamic configuration of OpenLDAP, see the
    <span class="quote">“<span class="quote">OpenLDAP Administration Guide</span>”</span>.
   </p></div><div class="sect2 " id="sec.security.auth.yast.ldap_users"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.yast.ldap_users"><span class="number">4.1.3 </span><span class="name">Editing LDAP Users and Groups</span> <a title="Permalink" class="permalink" href="#sec.security.auth.yast.ldap_users">#</a></h3></div></div></div><p>
    For editing LDAP users and groups with YaST, see
    <a class="xref" href="#sec.security.ldap.yast.usergr" title="5.4. Configuring LDAP Users and Groups in YaST">Section 5.4, “Configuring LDAP Users and Groups in YaST”</a>.
   </p></div></div><div class="sect1 " id="sec.security.auth.yast.client"><div class="titlepage"><div><div><h2 class="title" id="sec.security.auth.yast.client"><span class="number">4.2 </span><span class="name">Configuring an Authentication Client with YaST</span> <a title="Permalink" class="permalink" href="#sec.security.auth.yast.client">#</a></h2></div></div></div><p>
   YaST allows setting up authentication to clients using different
   modules:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">User Logon Management</span>. </span>
    Use both an identity service (usually LDAP) and a user authentication
    service (usually Kerberos). This option is based on SSSD and in the
    majority of cases is best suited for joining Active Directory domains.
   </p><p>
   This module is described in
   <a class="xref" href="#sec.security.ad.sssd" title="7.3.2.  Joining Active Directory Using User Logon Management">Section 7.3.2, “
    Joining Active Directory Using
    <span class="guimenu">User Logon Management</span>
   ”</a>.
  </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Windows Domain Membership</span>. </span>
    Join an Active Directory (which entails use of Kerberos and LDAP). This option is
    based on <code class="command">winbind</code> and is best suited for joining an
    Active Directory domain if support for NTLM or cross-forest trusts is necessary.
   </p><p>
   This module is described in
   <a class="xref" href="#sec.security.ad.winbind" title="7.3.3.  Joining Active Directory Using Windows Domain Membership">Section 7.3.3, “
    Joining Active Directory Using
    <span class="guimenu">Windows Domain Membership</span>
   ”</a>.
  </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">LDAP and Kerberos Authentication</span>. </span>
    Allows setting up LDAP identities and Kerberos authentication
    independently from each other and provides fewer options. While this
    module also uses SSSD, it is not as well suited for connecting to Active Directory
    as the previous two options.
   </p><p>
   This module is described in:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     LDAP: <a class="xref" href="#sec.security.ldap.yast.client" title="5.3. Configuring an LDAP Client with YaST">Section 5.3, “Configuring an LDAP Client with YaST”</a>
    </p></li><li class="listitem "><p>
     Kerberos: <a class="xref" href="#sec.security.kerberos.yast.client" title="6.6. Setting up Kerberos using LDAP and Kerberos Client">Section 6.6, “Setting up Kerberos using <span class="guimenu">LDAP and Kerberos Client</span>”</a>
    </p></li></ul></div></li></ul></div></div><div class="sect1 " id="sec.security.auth.sssd"><div class="titlepage"><div><div><h2 class="title" id="sec.security.auth.sssd"><span class="number">4.3 </span><span class="name">SSSD</span> <a title="Permalink" class="permalink" href="#sec.security.auth.sssd">#</a></h2></div></div></div><p>
   Two of the YaST modules are based on SSSD: <span class="guimenu">User Logon
   Management</span> and <span class="guimenu">LDAP and Kerberos
   Authentication</span>.
  </p><p>
   SSSD stands for System Security Services Daemon. SSSD talks to remote
   directory services that provide user data and provides various
   authentication methods, such as LDAP, Kerberos, or Active Directory (AD). It also
   provides an NSS (Name Service Switch) and PAM (Pluggable Authentication
   Module) interface.
  </p><p>
   SSSD can locally cache user data and then allow users to use the data,
   even if the real directory service is (temporarily) unreachable.
  </p><div class="sect2 " id="sec.security.auth.sssd.status"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.sssd.status"><span class="number">4.3.1 </span><span class="name">Checking the Status</span> <a title="Permalink" class="permalink" href="#sec.security.auth.sssd.status">#</a></h3></div></div></div><p>
    After running one of the YaST authentication modules, you can check
    whether SSSD is running with:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">systemctl status sssd</code>
sssd.service - System Security Services Daemon
   Loaded: loaded (/usr/lib/systemd/system/sssd.service; enabled)
   Active: active (running) since Thu 2015-10-23 11:03:43 CEST; 5s ago
   [...]</pre></div></div><div class="sect2 " id="sec.security.auth.sssd.cache"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.sssd.cache"><span class="number">4.3.2 </span><span class="name">Caching</span> <a title="Permalink" class="permalink" href="#sec.security.auth.sssd.cache">#</a></h3></div></div></div><p>
    To allow logging in when the authentication back-end is unavailable, SSSD
    will use its cache even if it was invalidated. This happens until the
    back-end is available again.
   </p><p>
    To invalidate the cache, run <code class="command">sss_cache -E</code> (the
    command <code class="command">sss_cache</code> is part of the package
    <span class="package">sssd-tools</span>).
   </p><p>
    To completely remove the SSSD cache, run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">systemctl stop sssd</code>
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">rm -f /var/lib/sss/db/*</code>
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">systemctl start sssd</code></pre></div></div><div class="sect2 " id="sec.security.auth.sssd.more"><div class="titlepage"><div><div><h3 class="title" id="sec.security.auth.sssd.more"><span class="number">4.3.3 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.auth.sssd.more">#</a></h3></div></div></div><p>
    For more information, see the SSSD man
    pages <code class="literal">sssd.conf</code> (<code class="command">man
    sssd.conf</code>) and <code class="literal">sssd</code> (<code class="command">man
    sssd</code>). There are also man pages for most SSSD modules.
   </p></div></div></div><div class="chapter " id="cha.security.ldap"><div class="titlepage"><div><div><h2 class="title"><span class="number">5 </span><span class="name">LDAP—A Directory Service</span> <a title="Permalink" class="permalink" href="#cha.security.ldap">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_ldap.xml</li><li><span class="ds-label">ID: </span>cha.security.ldap</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712070617184">#</a></h6></div><p>
    The Lightweight Directory Access Protocol (LDAP) is a set of protocols
    designed to access and maintain information directories. LDAP can be
    used for user and group management, system configuration management,
    address management, and more. This chapter provides a basic
    understanding of how OpenLDAP works.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.ldap.vs_nis"><span class="number">5.1 </span><span class="name">LDAP versus NIS</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.tree"><span class="number">5.2 </span><span class="name">Structure of an LDAP Directory Tree</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.yast.client"><span class="number">5.3 </span><span class="name">Configuring an LDAP Client with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.yast.usergr"><span class="number">5.4 </span><span class="name">Configuring LDAP Users and Groups in YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.slapd"><span class="number">5.5 </span><span class="name">Manually Configuring an LDAP Server</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.data"><span class="number">5.6 </span><span class="name">Manually Administering LDAP Data</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ldap.info"><span class="number">5.7 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><p>
  In a network environment, it is crucial to keep important information
  structured and to serve it quickly. A directory service keeps information
  available in a well-structured and searchable form.
 </p><p>
  Ideally, a central server stores the data in a directory and distributes
  it to all clients using a well-defined protocol. The structured data allow
  a wide range of applications to access them. A central repository reduces
  the necessary administrative effort. The use of an open and standardized
  protocol like LDAP ensures that as many client applications as
  possible can access such information.
 </p><p>
  A directory in this context is a type of database optimized for quick and
  effective reading and searching:
 </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    To make multiple concurrent reading accesses possible, the number of
    updates is usually very low. The number of read and write accesses is
    often limited to a few users with administrative privileges. In
    contrast, conventional databases are optimized for accepting the largest
    possible data volume in a short time.
   </p></li><li class="listitem "><p>
    When static data is administered, updates of the existing data sets are
    very rare. When working with dynamic data, especially when data sets
    like bank accounts or accounting are concerned, the consistency of the
    data is of primary importance. If an amount should be subtracted from
    one place to be added to another, both operations must happen
    concurrently, within one <span class="emphasis"><em>transaction</em></span>, to ensure
    balance over the data stock. Traditional relational databases usually
    have a very strong focus on data consistency, such as the referential
    integrity support of transactions. Conversely, short-term
    inconsistencies are usually acceptable in LDAP directories. LDAP
    directories often do not have the same strong consistency requirements
    as relational databases.
   </p></li></ul></div><p>
  The design of a directory service like LDAP is not laid out to support
  complex update or query mechanisms. All applications are guaranteed to
  access this service quickly and easily.
 </p><div class="sect1 " id="sec.security.ldap.vs_nis"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.vs_nis"><span class="number">5.1 </span><span class="name">LDAP versus NIS</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.vs_nis">#</a></h2></div></div></div><p>
   Unix system administrators traditionally use NIS (Network Information
   Service) for name resolution and data distribution in a network. The
   configuration data contained in the files <code class="filename">group</code>,
   <code class="filename">hosts</code>, <code class="filename">mail</code>,
   <code class="filename">netgroup</code>, <code class="filename">networks</code>,
   <code class="filename">passwd</code>, <code class="filename">printcap</code>,
   <code class="filename">protocols</code>, <code class="filename">rpc</code>, and
   <code class="filename">services</code> in the <code class="filename">/etc</code> directory
   is distributed to clients all over the network. These files can be
   maintained without major effort because they are simple text files. The
   handling of larger amounts of data, however, becomes increasingly
   difficult because of nonexistent structuring.
   
   NIS is only designed for Unix platforms, and is not suitable as a
   centralized data administration tool in heterogeneous networks.
  </p><p>
   Unlike NIS, the LDAP service is not restricted to pure Unix networks.
   Windows™ servers (starting with Windows 2000) support LDAP as a
   directory service. The
   application tasks mentioned above are additionally supported in non-Unix
   systems.
  </p><p>
   The LDAP principle can be applied to any data structure that needs to be
   centrally administered. A few application examples are:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Replacement for the NIS service
    </p></li><li class="listitem "><p>
     Mail routing (postfix)
    </p></li><li class="listitem "><p>
     Address books for mail clients, like Mozilla Thunderbird, Evolution,
     and Outlook
    </p></li><li class="listitem "><p>
     Administration of zone descriptions for a BIND 9 name server
    </p></li><li class="listitem "><p>
     User authentication with Samba in heterogeneous networks
    </p></li></ul></div><p>
   This list can be extended because LDAP is extensible, unlike NIS. The
   clearly-defined hierarchical structure of the data simplifies the
   administration of large amounts of data, as it can be searched more
   easily.
  </p></div><div class="sect1 " id="sec.security.ldap.tree"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.tree"><span class="number">5.2 </span><span class="name">Structure of an LDAP Directory Tree</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.tree">#</a></h2></div></div></div><p>
   To get background knowledge on how an LDAP server works and how the data
   is stored, it is vital to understand the way the data is organized on the
   server and how this structure enables LDAP to provide fast access to the
   data. To successfully operate an LDAP setup, you also need to be familiar
   with some basic LDAP terminology. This section introduces the basic
   layout of an LDAP directory tree and provides the basic terminology used
   with regard to LDAP. Skip this introductory section if you already have
   some LDAP background knowledge and only want to learn how to set up an
   LDAP environment in <span class="productname"><span class="phrase">openSUSE Leap</span></span>.<span class="phrase"> Read on at

   <a class="xref" href="#sec.security.ldap.slapd" title="5.5. Manually Configuring an LDAP Server">Section 5.5, “Manually Configuring an LDAP Server”</a>.</span>
  </p><p>
   An LDAP directory has a tree structure. All entries (called objects) of
   the directory have a defined position within this hierarchy. This
   hierarchy is called the <span class="emphasis"><em>directory information tree</em></span>
   (DIT). The complete path to the desired entry, which unambiguously
   identifies it, is called the <span class="emphasis"><em>distinguished name</em></span> or
   DN. A single node along the path to this entry is called
   <span class="emphasis"><em>relative distinguished name</em></span> or RDN.
  </p><p>
   The relations within an LDAP directory tree become more evident in the
   following example, shown in <a class="xref" href="#fig.ldap.tree" title="Structure of an LDAP Directory">Figure 5.1, “Structure of an LDAP Directory”</a>.
  </p><div class="figure" id="fig.ldap.tree"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ldap_tree.png"><img src="images/ldap_tree.png" width="" alt="Structure of an LDAP Directory" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 5.1: </span><span class="name">Structure of an LDAP Directory </span><a title="Permalink" class="permalink" href="#fig.ldap.tree">#</a></h6></div></div><p>
   The complete diagram is a fictional directory information tree. The
   entries on three levels are depicted. Each entry corresponds to one box
   in the image. The complete, valid <span class="emphasis"><em>distinguished name</em></span>
   for the fictional employee <code class="systemitem">Geeko
   Linux</code>, in this case, is <code class="literal">cn=Geeko
   Linux,ou=doc,dc=example,dc=com</code>. It is composed by adding the
   RDN <code class="literal">cn=Geeko Linux</code> to the DN of the preceding entry
   <code class="literal">ou=doc,dc=example,dc=com</code>.
  </p><p>
   The types of objects that can be stored in the DIT are globally
   determined following a <span class="emphasis"><em>Schema</em></span>. The type of an object
   is determined by the <span class="emphasis"><em>object class</em></span>. The object class
   determines what attributes the relevant object must or can be assigned.
   The Schema, therefore, must contain definitions of all object classes and
   attributes used in the desired application scenario. There are a few
   common Schemas (see RFC 2252 and 2256). The LDAP RFC defines a few
   commonly used Schemas (see for example, RFC4519). Additionally, Schemas
   are available for many other use cases (for example, Samba or NIS
   replacement). It is, however, possible to create custom Schemas or to use
   multiple Schemas complementing each other (if this is required by the
   environment in which the LDAP server should operate).
  </p><p>
   <a class="xref" href="#tab.ldap.schema" title="Commonly Used Object Classes and Attributes">Table 5.1, “Commonly Used Object Classes and Attributes”</a> offers a small overview of the object
   classes from <code class="filename">core.schema</code> and
   <code class="filename">inetorgperson.schema</code> used in the example, including
   required attributes (Req. Attr.) and valid attribute values.

  </p><div class="table" id="tab.ldap.schema"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 5.1: </span><span class="name">Commonly Used Object Classes and Attributes </span><a title="Permalink" class="permalink" href="#tab.ldap.schema">#</a></h6></div><div class="table-contents"><table summary="Commonly Used Object Classes and Attributes" border="1"><colgroup><col class="c1" /><col class="c2" /><col class="c3" /><col class="c4" /></colgroup><thead><tr><th>
       <p>
        Object Class
       </p>
      </th><th>
       <p>
        Meaning
       </p>
      </th><th>
       <p>
        Example Entry
       </p>
      </th><th>
       <p>
        Req. Attr.
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        <code class="literal">dcObject</code>
       </p>
      </td><td>
       <p>
        <span class="emphasis"><em>domainComponent</em></span> (name components of the domain)
       </p>
      </td><td>
       <p>
        example
       </p>
      </td><td>
       <p>
        dc
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">organizationalUnit</code>
       </p>
      </td><td>
       <p>
        <span class="emphasis"><em>organizationalUnit</em></span> (organizational unit)
       </p>
      </td><td>
       <p>
        doc
       </p>
      </td><td>
       <p>
        ou
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">inetOrgPerson</code>
       </p>
      </td><td>
       <p>
        <span class="emphasis"><em>inetOrgPerson</em></span> (person-related data for the
        intranet or Internet)
       </p>
      </td><td>
       <p>
        Geeko Linux
       </p>
      </td><td>
       <p>
        sn and cn
       </p>
      </td></tr></tbody></table></div></div><p>
   <a class="xref" href="#aus.ldap.schema.help" title="Excerpt from schema.core">Example 5.1, “Excerpt from schema.core”</a> shows an excerpt from a Schema
   directive with explanations.
  </p><div class="example" id="aus.ldap.schema.help"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 5.1: </span><span class="name">Excerpt from schema.core </span><a title="Permalink" class="permalink" href="#aus.ldap.schema.help">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">attributetype (2.5.4.11 NAME ( 'ou' 'organizationalUnitName') <span id="co.ldap.schema.core.att_type"></span><span class="callout">1</span>
       DESC 'RFC2256: organizational unit this object belongs to' <span id="co.ldap.schema.core.desc"></span><span class="callout">2</span>
       SUP name ) <span id="co.ldap.schema.core.sup"></span><span class="callout">3</span>

objectclass ( 2.5.6.5 NAME 'organizationalUnit' <span id="co.ldap.schema.core.oc"></span><span class="callout">4</span>
       DESC 'RFC2256: an organizational unit' <span id="co.ldap.schema.core.desc.oc"></span><span class="callout">5</span>
       SUP top STRUCTURAL <span id="co.ldap.schema.core.sup.oc"></span><span class="callout">6</span>
       MUST ou <span id="co.ldap.schema.core.must.oc"></span><span class="callout">7</span>
MAY (userPassword $ searchGuide $ seeAlso $ businessCategory <span id="co.ldap.schema.core.may.oc"></span><span class="callout">8</span>
  $ x121Address $ registeredAddress $ destinationIndicator
  $ preferredDeliveryMethod $ telexNumber
  $ teletexTerminalIdentifier $ telephoneNumber
  $ internationaliSDNNumber $ facsimileTelephoneNumber
  $ street $ postOfficeBox $ postalCode $ postalAddress
  $ physicalDeliveryOfficeName
  $ st $ l $ description) )
  ...</pre></div></div></div><p>
   The attribute type <code class="literal">organizationalUnitName</code> and the
   corresponding object class <code class="literal">organizationalUnit</code> serve as
   an example here.
  </p><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.att_type"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     The name of the attribute, its unique OID (<span class="emphasis"><em>object
     identifier</em></span>) (numerical), and the abbreviation of the
     attribute.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.desc"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     A brief description of the attribute with <code class="literal">DESC</code>. The
     corresponding RFC, on which the definition is based, is also mentioned
     here.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.sup"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     <code class="literal">SUP</code> indicates a superordinate attribute type to
     which this attribute belongs.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.oc"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     The definition of the object class
     <code class="literal">organizationalUnit</code> begins—the same as in
     the definition of the attribute—with an OID and the name of
     the object class.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.desc.oc"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     A brief description of the object class.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.sup.oc"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     The <code class="literal">SUP top</code> entry indicates that this object class
     is not subordinate to another object class.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.must.oc"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
     With <code class="literal">MUST</code> list all attribute types that must be used
     with an object of the type
     <code class="literal">organizationalUnit</code>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.ldap.schema.core.may.oc"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>
     With <code class="literal">MAY</code> list all attribute types that are permitted
     with this object class.
    </p></td></tr></table></div><p>
   A very good introduction to the use of Schemas can be found in the
   OpenLDAP documentation (<code class="systemitem">openldap2-doc</code>). When
   installed, find it in
   <code class="filename">/usr/share/doc/packages/openldap2/adminguide/guide.html</code>.
  </p></div><div class="sect1 " id="sec.security.ldap.yast.client"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.yast.client"><span class="number">5.3 </span><span class="name">Configuring an LDAP Client with YaST</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.yast.client">#</a></h2></div></div></div><p>
   YaST includes the module <span class="guimenu">LDAP and Kerberos Client</span>
   that helps define authentication scenarios involving either LDAP or Kerberos.
  </p><p>
   It can also be used to join Kerberos and LDAP separately. However, in
   many such cases, using this module may not be the first choice, such as
   for joining Active Directory (which uses a combination of LDAP and Kerberos). For
   more information, see <a class="xref" href="#sec.security.auth.yast.client" title="4.2. Configuring an Authentication Client with YaST">Section 4.2, “Configuring an Authentication Client with YaST”</a>.
  </p><p>
   Start the module by selecting
   <span class="guimenu">Network Services</span> › <span class="guimenu">LDAP and
   Kerberos Client</span>.
  </p><div class="figure" id="fig.yast2.ldapkerberos.ldap"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_client_config.png"><img src="images/yast2_auth_client_config.png" width="" alt="LDAP and Kerberos Client Window" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 5.2: </span><span class="name"><span class="guimenu">LDAP and Kerberos Client</span> Window </span><a title="Permalink" class="permalink" href="#fig.yast2.ldapkerberos.ldap">#</a></h6></div></div><p>
   To configure an LDAP client, follow the procedure below:
  </p><div class="procedure " id="pro.security.auth.ldap"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     In the window <span class="guimenu">LDAP and Kerberos Client</span>, click
     <span class="guimenu">Change Settings</span>.
    </p><p>
     Make sure that the tab <span class="guimenu">Use a Directory as Identity Provider
     (LDAP)</span> is chosen.
    </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_client_ldap.png"><img src="images/yast2_auth_client_ldap.png" width="" /></a></div></div></li><li class="step "><p>
     Specify one or more LDAP server URLs, host names, or IP addresses under
     <span class="guimenu">Enter LDAP server locations</span>. When specifying multiple
     addresses, separate them with spaces.
    </p></li><li class="step "><p>
     Specify the appropriate LDAP distinguished name (DN) under
     <span class="guimenu">DN of Search Base</span>. For example, a valid entry could
     be <code class="literal">dc=example,dc=com</code>.
    </p></li><li class="step "><p>
     If your LDAP server supports TLS encryption, choose the appropriate
     security option under <span class="guimenu">Secure LDAP Connection</span>.
    </p><p>
     To first ask the server whether it supports TLS encryption and be able
     to downgrade to an unencrypted connection if it does not, use
     <span class="guimenu">Secure Communication via StartTLS</span>.
    </p></li><li class="step "><p>
     Activate other options as necessary:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       You can <span class="guimenu">Allow users to authenticate via LDAP</span> and
       <span class="guimenu">Automatically Create Home Directories</span> on the local
       computer for them.
      </p></li><li class="listitem "><p>
       Use <span class="guimenu">Cache LDAP Entries For Faster Response</span> to cache
       LDAP entries locally. However, this bears the danger that entries can
       be slightly out of date.
      </p></li><li class="listitem "><p>
       Specify the types of data that should be used from the LDAP source,
       such as
       <span class="guimenu">Users</span> and <span class="guimenu">Groups</span>,
       <span class="guimenu">Super-User Commands</span>, and <span class="guimenu">Network Disk
       Locations</span> (network-shared drives that can be automatically
       mounted on request).
      </p></li><li class="listitem "><p>
       Specify the distinguished name (DN) and password of the user under
       whose name you want to bind to the LDAP directory in <span class="guimenu">DN of
       Bind User</span> and <span class="guimenu">Password of the Bind User</span>.
      </p><p>
       Otherwise, if the server supports it, you can also leave both text
       boxes empty to bind anonymously to the server.
      </p><div id="idm140712070483984" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Authentication Without Encryption</h6><p>
        When using authentication without enabling transport encryption
        using TLS or StartTLS, the password will be transmitted in the clear.
       </p></div></li></ul></div><p>
     Under <span class="guimenu">Extended Options</span>, you can additionally
     configure timeouts for BIND operations.
    </p></li><li class="step "><p>
     To check whether the LDAP connection works, click
     <span class="guimenu">Test Connection</span>.
    </p></li><li class="step "><p>
     To leave the dialog, click <span class="guimenu">OK</span>. Then wait for the
     setup to complete.
    </p><p>
     Finally, click <span class="guimenu">Finish</span>.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.security.ldap.yast.usergr"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.yast.usergr"><span class="number">5.4 </span><span class="name">Configuring LDAP Users and Groups in YaST</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.yast.usergr">#</a></h2></div></div></div><p>
   The actual registration of user and group data differs only slightly from
   the procedure when not using LDAP. The following instructions relate to
   the administration of users. The procedure for administering groups is
   analogous.
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Access the YaST user administration with <span class="guimenu">Security and Users</span> › <span class="guimenu">User and Group
     Management</span>.
    </p></li><li class="step "><p>
     Use <span class="guimenu">Set Filter</span> to limit the view of users to the
     LDAP users and enter the password for Root DN.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Add</span> to enter the user configuration. A dialog
     with four tabs opens:
    </p><ol type="a" class="substeps "><li class="step "><p>
       Specify the user's name, login name, and password in the
       <span class="guimenu">User Data</span> tab.
      </p></li><li class="step "><p>
       Check the <span class="guimenu">Details</span> tab for the group membership,
       login shell, and home directory of the new user. If necessary, change
       the default to values that better suit your needs.

      </p></li><li class="step "><p>
       Modify or accept the default <span class="guimenu">Password Settings</span>.
      </p></li><li class="step "><p>
       Enter the <span class="guimenu">Plug-Ins</span> tab, select the LDAP plug-in,
       and click <span class="guimenu">Launch</span> to configure additional LDAP
       attributes assigned to the new user.

      </p></li></ol></li><li class="step "><p>
     Click <span class="guimenu">OK</span> to apply your settings and leave the user
     configuration.
    </p></li></ol></div></div><p>
   The initial input form of user administration offers <span class="guimenu">LDAP
   Options</span>. This allows you to apply LDAP search filters to the
   set of available users. Alternatively open the module for configuring
   LDAP users and groups by selecting <span class="guimenu">LDAP User and Group
   Configuration</span>.
  </p></div><div class="sect1 " id="sec.security.ldap.slapd"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.slapd"><span class="number">5.5 </span><span class="name">Manually Configuring an LDAP Server</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.slapd">#</a></h2></div></div></div><p>
   YaST uses OpenLDAP's dynamic configuration database
   (<code class="systemitem">back-config</code>) to store the LDAP server's
   configuration. For details about the dynamic configuration back-end, see
   the <code class="systemitem">slapd-config(5)</code> man page or the OpenLDAP
   Software 2.4 Administrator's Guide located at
   <code class="filename">/usr/share/doc/packages/openldap2/guide/admin/guide.html</code>
   on your system if the <code class="systemitem">openldap2</code> package is
   installed.
  </p><div id="idm140712070455392" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Upgrading an Old OpenLDAP Installation</h6><p>
    YaST does not use <code class="filename">/etc/openldap/slapd.conf</code> to
    store the OpenLDAP configuration anymore. In case of a system upgrade, a
    copy of the original <code class="filename">/etc/openldap/slapd.conf</code> file
    will get created as
    <code class="filename">/etc/openldap/slapd.conf.YaSTsave</code>.
   </p></div><p>
   To conveniently access the configuration back-end, you use SASL external
   authentication. For example, the following <code class="command">ldapsearch</code>
   command executed as <code class="systemitem">root</code> can show the complete
   <code class="command">slapd</code> configuration:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapsearch -Y external -H ldapi:/// -b cn=config</pre></div><div id="idm140712070449552" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: LDAP Server Is Part of the Authentication Server</h6><p>
    Basic LDAP Server initialization and configuration can be done within
    the Authentication Server YaST module. For more information, see
    <a class="xref" href="#sec.security.auth.yast" title="4.1. Configuring an Authentication Server with YaST">Section 4.1, “Configuring an Authentication Server with YaST”</a>.
   </p></div><p>
    When the LDAP server is fully configured and all desired entries have
    been made according to the pattern described in
    <a class="xref" href="#sec.security.ldap.data" title="5.6. Manually Administering LDAP Data">Section 5.6, “Manually Administering LDAP Data”</a>, start the LDAP server as
    <code class="systemitem">root</code> by entering <code class="command">sudo systemctl start
    slapd</code>. To stop the server manually, enter the command
    <code class="command">sudo systemctl stop slapd</code>. Query the status of
    the running LDAP server with <code class="command">sudo systemctl status
    slapd</code>.
   </p><p>
    Use the YaST <span class="guimenu">Services Manager</span>, described in
    <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 10 “The <code class="systemitem">systemd</code> Daemon”, Section 10.4 “Managing Services with YaST”</span>, to have the server started and
    stopped automatically on system bootup and shutdown. You can also
    create the corresponding links to the start and stop scripts with the
    <code class="command">systemctl</code> commands as described
    in <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 10 “The <code class="systemitem">systemd</code> Daemon”, Section 10.2.1 “Managing Services in a Running System”</span>.
   </p></div><div class="sect1 " id="sec.security.ldap.data"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.data"><span class="number">5.6 </span><span class="name">Manually Administering LDAP Data</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.data">#</a></h2></div></div></div><p>
   OpenLDAP offers a series of tools for the administration of data in the
   LDAP directory. The four most important tools for adding to, deleting
   from, searching through and modifying the data stock are explained in
   this section.
  </p><div class="sect2 " id="sec.security.ldap.data.add"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ldap.data.add"><span class="number">5.6.1 </span><span class="name">Inserting Data into an LDAP Directory</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.data.add">#</a></h3></div></div></div><p>
    Once your LDAP server

    is correctly configured (it features appropriate entries for
    <code class="literal">suffix</code>, <code class="literal">directory</code>,
    <code class="literal">rootdn</code>, <code class="literal">rootpw</code> and
    <code class="literal">index</code>), proceed to entering records. OpenLDAP offers
    the <code class="command">ldapadd</code> command for this task. If possible, add
    the objects to the database in bundles (for practical reasons). LDAP
    can process the LDIF format (LDAP data interchange format) for this.
    An LDIF file is a simple text file that can contain an arbitrary number
    of attribute and value pairs.

    The LDIF file for creating a rough framework for the example in
    <a class="xref" href="#fig.ldap.tree" title="Structure of an LDAP Directory">Figure 5.1, “Structure of an LDAP Directory”</a> would look like the one in
    <a class="xref" href="#dat.ldap.ldif" title="An LDIF File">Example 5.2, “An LDIF File”</a>.
   </p><div id="idm140712070433392" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Encoding of LDIF Files</h6><p>

     LDAP works with UTF-8 (Unicode). Umlauts must be encoded correctly.
     Otherwise, avoid umlauts and other special characters or use
     <code class="command">iconv</code> to convert the input to UTF-8.
    </p></div><div class="example" id="dat.ldap.ldif"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 5.2: </span><span class="name">An LDIF File </span><a title="Permalink" class="permalink" href="#dat.ldap.ldif">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"># The Organization
dn: dc=example,dc=com
objectClass: dcObject
objectClass: organization
o: Example dc: example

# The organizational unit development (devel)
dn: ou=devel,dc=example,dc=com
objectClass: organizationalUnit
ou: devel

# The organizational unit documentation (doc)
dn: ou=doc,dc=example,dc=com
objectClass: organizationalUnit
ou: doc

# The organizational unit internal IT (it)
dn: ou=it,dc=example,dc=com
objectClass: organizationalUnit
ou: it</pre></div></div></div><p>
    Save the file with the <code class="filename">.ldif</code> suffix then pass it to
    the server with the following command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapadd -x -D <em class="replaceable ">DN_OF_THE_ADMINISTRATOR</em> -W -f <em class="replaceable ">FILE</em>.ldif</pre></div><p>
    <code class="literal">-x</code> switches off the authentication with SASL in this
    case. <code class="literal">-D</code> declares the user that calls the operation.
    The valid DN of the administrator is entered here, as it has been
    configured in <code class="filename">slapd.conf</code>. In the current example,
    this is <code class="literal">cn=Administrator,dc=example,dc=com</code>.
    <code class="literal">-W</code> circumvents entering the password on the command
    line (in clear text) and activates a separate password prompt.

    The <code class="literal">-f</code> option passes the file name. See the details
    of running <code class="command">ldapadd</code> in
    <a class="xref" href="#aus.ldap.addentry" title="ldapadd with example.ldif">Example 5.3, “ldapadd with example.ldif”</a>.
   </p><div class="example" id="aus.ldap.addentry"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 5.3: </span><span class="name">ldapadd with example.ldif </span><a title="Permalink" class="permalink" href="#aus.ldap.addentry">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapadd -x -D cn=Administrator,dc=example,dc=com -W -f example.ldif

Enter LDAP password:
adding new entry "dc=example,dc=com"
adding new entry "ou=devel,dc=example,dc=com"
adding new entry "ou=doc,dc=example,dc=com"
adding new entry "ou=it,dc=example,dc=com"</pre></div></div></div><p>
    The user data of individuals can be prepared in separate LDIF files.
    <a class="xref" href="#aus.ldap.addtux" title="LDIF Data for Tux">Example 5.4, “LDIF Data for Tux”</a> adds
    <code class="systemitem">Tux</code> to the new LDAP directory.
   </p><div class="example" id="aus.ldap.addtux"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 5.4: </span><span class="name">LDIF Data for Tux </span><a title="Permalink" class="permalink" href="#aus.ldap.addtux">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"># coworker Tux
dn: cn=Tux Linux,ou=devel,dc=example,dc=com
objectClass: inetOrgPerson
cn: Tux Linux
givenName: Tux
sn: Linux
mail: tux@example.com
uid: tux
telephoneNumber: +49 1234 567-8</pre></div></div></div><p>
    An LDIF file can contain an arbitrary number of objects. It is possible
    to pass directory branches (entirely or in part) to the server in one
    go, as shown in the example of individual objects. If it is necessary to
    modify some data relatively often, a fine subdivision of single objects
    is recommended.
   </p></div><div class="sect2 " id="sec.security.ldap.data.change"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ldap.data.change"><span class="number">5.6.2 </span><span class="name">Modifying Data in the LDAP Directory</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.data.change">#</a></h3></div></div></div><p>
    The tool <code class="command">ldapmodify</code> is provided for modifying the
    data stock. The easiest way to do this is to modify the corresponding
    LDIF file and pass the modified file to the LDAP server. To change the
    telephone number of colleague Tux from <code class="literal">+49 1234 567-8</code>
    to <code class="literal">+49 1234 567-10</code>, edit the LDIF file like in
    <a class="xref" href="#aus.ldap.ldif.tux" title="Modified LDIF File tux.ldif">Example 5.5, “Modified LDIF File tux.ldif”</a>.
   </p><div class="example" id="aus.ldap.ldif.tux"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 5.5: </span><span class="name">Modified LDIF File tux.ldif </span><a title="Permalink" class="permalink" href="#aus.ldap.ldif.tux">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"># coworker Tux
dn: cn=Tux Linux,ou=devel,dc=example,dc=com
changetype: modify
replace: telephoneNumber
telephoneNumber: +49 1234 567-10</pre></div></div></div><p>
    Import the modified file into the LDAP directory with the following
    command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapmodify -x -D cn=Administrator,dc=example,dc=com -W -f tux.ldif</pre></div><p>
    Alternatively, pass the attributes to change directly to
    <code class="command">ldapmodify</code> as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start <code class="command">ldapmodify</code> and enter your password:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapmodify -x -D cn=Administrator,dc=example,dc=com -W
Enter LDAP password:</pre></div></li><li class="step "><p>
      Enter the changes while carefully complying with the syntax in the
      order presented below:
     </p><div class="verbatim-wrap"><pre class="screen">dn: cn=Tux Linux,ou=devel,dc=example,dc=com
changetype: modify
replace: telephoneNumber
telephoneNumber: +49 1234 567-10</pre></div></li></ol></div></div><p>
    For more information about <code class="command">ldapmodify</code> and its syntax,
    see the <code class="command">ldapmodify</code> man page.
   </p></div><div class="sect2 " id="sec.security.ldap.data.search"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ldap.data.search"><span class="number">5.6.3 </span><span class="name">Searching or Reading Data from an LDAP Directory</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.data.search">#</a></h3></div></div></div><p>
    OpenLDAP provides, with <code class="command">ldapsearch</code>, a command line
    tool for searching data within an LDAP directory and reading data from
    it. This is a simple query:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapsearch -x -b dc=example,dc=com "(objectClass=*)"</pre></div><p>
    The <code class="option">-b</code> option determines the search base (the section
    of the tree within which the search should be performed). In the current
    case, this is <code class="literal">dc=example,dc=com</code>. To perform a more
    finely-grained search in specific subsections of the LDAP directory (for
    example, only within the <code class="literal">devel</code> department), pass this
    section to <code class="command">ldapsearch</code> with <code class="option">-b</code>.
    <code class="option">-x</code> requests activation of simple authentication.
    <code class="literal">(objectClass=*)</code> declares that all objects contained
    in the directory should be read. This command option can be used after
    the creation of a new directory tree to verify that all entries have
    been recorded correctly and the server responds as desired. For more
    information about the use of <code class="command">ldapsearch</code>, see the
    <code class="systemitem">ldapsearch(1)</code> man page.
   </p></div><div class="sect2 " id="sec.security.ldap.data.del"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ldap.data.del"><span class="number">5.6.4 </span><span class="name">Deleting Data from an LDAP Directory</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.data.del">#</a></h3></div></div></div><p>
    Delete unwanted entries with <code class="command">ldapdelete</code>. The syntax
    is similar to that of the other commands. To delete, for example, the
    complete entry for <code class="literal">Tux Linux</code>, issue the following
    command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapdelete -x -D cn=Administrator,dc=example,dc=com -W cn=Tux \
Linux,ou=devel,dc=example,dc=com</pre></div></div></div><div class="sect1 " id="sec.security.ldap.info"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ldap.info"><span class="number">5.7 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.ldap.info">#</a></h2></div></div></div><p>
   More complex subjects (like SASL configuration or establishment of a
   replicating LDAP server that distributes the workload among multiple
   slaves) were omitted from this chapter. Find detailed information about
   both subjects in the <span class="emphasis"><em>OpenLDAP 2.4 Administrator's
   Guide</em></span>—see at
   <a class="xref" href="#list.ldap.info.adminguide">OpenLDAP 2.4 Administrator's Guide</a>.
  </p><p>
   The Web site of the OpenLDAP project offers exhaustive documentation for
   beginner and advanced LDAP users:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070386192"><span class="term ">OpenLDAP Faq-O-Matic</span></dt><dd><p>
      A detailed question and answer collection applying to the
      installation, configuration, and use of OpenLDAP. Find it at
      <a class="link" href="http://www.openldap.org/faq/data/cache/1.html" target="_blank">http://www.openldap.org/faq/data/cache/1.html</a>.
     </p></dd><dt id="idm140712070383680"><span class="term ">Quick Start Guide</span></dt><dd><p>
      Brief step-by-step instructions for installing your first LDAP server.
      Find it at
      <a class="link" href="http://www.openldap.org/doc/admin24/quickstart.html" target="_blank">http://www.openldap.org/doc/admin24/quickstart.html</a>
      or on an installed system in Section 2 of
      <code class="filename">/usr/share/doc/packages/openldap2/guide/admin/guide.html</code>.
     </p></dd><dt id="list.ldap.info.adminguide"><span class="term ">OpenLDAP 2.4 Administrator's Guide</span></dt><dd><p>
      A detailed introduction to all important aspects of LDAP
      configuration, including access controls and encryption. See
      <a class="link" href="http://www.openldap.org/doc/admin24/" target="_blank">http://www.openldap.org/doc/admin24/</a> or, on an
      installed system,
      <code class="filename">/usr/share/doc/packages/openldap2/guide/admin/guide.html</code>.
     </p></dd><dt id="idm140712070377184"><span class="term ">Understanding LDAP</span></dt><dd><p>
      A detailed general introduction to the basic principles of LDAP:
      <a class="link" href="http://www.redbooks.ibm.com/redbooks/pdfs/sg244986.pdf" target="_blank">http://www.redbooks.ibm.com/redbooks/pdfs/sg244986.pdf</a>.
     </p></dd></dl></div><p>
   Printed literature about LDAP:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <em class="citetitle ">LDAP System Administration</em> by Gerald Carter
     (ISBN 1-56592-491-6)
    </p></li><li class="listitem "><p>
     <em class="citetitle ">Understanding and Deploying LDAP Directory
     Services</em> by Howes, Smith, and Good (ISBN 0-672-32316-8)
    </p></li></ul></div><p>
   The ultimate reference material for the subject of LDAP are the
   corresponding RFCs (request for comments), 2251 to 2256.
  </p></div></div><div class="chapter " id="cha.security.kerberos"><div class="titlepage"><div><div><h2 class="title"><span class="number">6 </span><span class="name">Network Authentication with Kerberos</span> <a title="Permalink" class="permalink" href="#cha.security.kerberos">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_kerberos.xml</li><li><span class="ds-label">ID: </span>cha.security.kerberos</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712070366816">#</a></h6></div><p>
    Kerberos is a network authentication protocol which also provides
    encryption. This chapter describes how to set up Kerberos and integrate
    services like LDAP and NFS.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.kerberos.overview"><span class="number">6.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.terms"><span class="number">6.2 </span><span class="name">Kerberos Terminology</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.how"><span class="number">6.3 </span><span class="name">How Kerberos Works</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.users"><span class="number">6.4 </span><span class="name">User View of Kerberos</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.admin"><span class="number">6.5 </span><span class="name">Installing and Administering Kerberos</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.yast.client"><span class="number">6.6 </span><span class="name">Setting up Kerberos using <span class="guimenu">LDAP and Kerberos Client</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.nfs"><span class="number">6.7 </span><span class="name">Kerberos and NFS</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.kerberos.info"><span class="number">6.8 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.kerberos.overview"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.overview"><span class="number">6.1 </span><span class="name">Conceptual Overview</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.overview">#</a></h2></div></div></div><p>
   An open network provides no means of ensuring that a workstation can
   identify its users properly, except through the usual password
   mechanisms. In common installations, the user must enter the
   password each time a service inside the network is accessed. Kerberos
   provides an authentication method with which a user registers only
   once and is trusted in the complete network for the rest of the
   session. To have a secure network, the following requirements must
   be met:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Have all users prove their identity for each desired service and
     make sure that no one can take the identity of someone else.
    </p></li><li class="listitem "><p>
     Make sure that each network server also proves its identity.
     Otherwise an attacker might be able to impersonate the server and
     obtain sensitive information transmitted to the server. This
     concept is called <span class="emphasis"><em>mutual authentication</em></span>,
     because the client authenticates to the server and vice versa.
    </p></li></ul></div><p>
   Kerberos helps you meet these requirements by providing strongly
   encrypted authentication. Only the basic principles of Kerberos are
   discussed here. For detailed technical instruction, refer to the
   Kerberos documentation.
  </p></div><div class="sect1 " id="sec.security.kerberos.terms"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.terms"><span class="number">6.2 </span><span class="name">Kerberos Terminology</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.terms">#</a></h2></div></div></div><p>
   The following glossary defines some Kerberos terminology.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070355936"><span class="term ">credential</span></dt><dd><p>
      Users or clients need to present some kind of credentials that authorize
      them to request services. Kerberos knows two kinds of
      credentials—tickets and authenticators.
     </p></dd><dt id="idm140712070353968"><span class="term ">ticket</span></dt><dd><p>
      A ticket is a per-server credential used by a client to
      authenticate at a server from which it is requesting a service. It
      contains the name of the server, the client's name, the client's
      Internet address, a time stamp, a lifetime, and a random session key.
      All this data is encrypted using the server's key.
     </p></dd><dt id="idm140712070351840"><span class="term ">authenticator</span></dt><dd><p>
      Combined with the ticket, an authenticator is used to prove that the
      client presenting a ticket is really the one it claims to be. An
      authenticator is built using the client's name, the workstation's IP
      address, and the current workstation's time, all encrypted with the
      session key known only to the client and the relevant server. An
      authenticator can only be used once, unlike a ticket. A client can build
      an authenticator itself.
     </p></dd><dt id="idm140712070349584"><span class="term ">principal</span></dt><dd><p>
      A Kerberos principal is a unique entity (a user or service) to which it
      can assign a ticket. A principal consists of the following components:
     </p><div class="verbatim-wrap"><pre class="screen"><em class="replaceable ">USER</em>/<em class="replaceable ">INSTANCE</em>@<em class="replaceable ">REALM</em></pre></div><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title">primary: </span>
         The first part of the principal. In the case of users, this is
         usually the same as the user name.
        </p></li><li class="listitem "><p><span class="formalpara-title">instance <span class="emphasis"><em>(optional)</em></span>: </span>
         Additional information characterizing the
         <span class="emphasis"><em>primary</em></span>. This string is separated from the
         <span class="emphasis"><em>primary</em></span> by a <code class="literal">/</code>.
        </p><p>
       <code class="literal">tux@example.org</code> and
       <code class="literal">tux/admin@example.org</code> can both exist on the same
       Kerberos system and are treated as different principals.
       </p></li><li class="listitem "><p><span class="formalpara-title">realm: </span>
         Specifies the Kerberos realm. Normally, your realm is your domain
         name in uppercase letters.
        </p></li></ul></div></dd><dt id="idm140712070336832"><span class="term ">mutual authentication</span></dt><dd><p>
      Kerberos ensures that both client and server can be sure of each
      other's identity. They share a session key, which they can use to
      communicate securely.
     </p></dd><dt id="idm140712070334880"><span class="term ">session key</span></dt><dd><p>
      Session keys are temporary private keys generated by Kerberos. They are
      known to the client and used to encrypt the communication between the
      client and the server for which it requested and received a ticket.
     </p></dd><dt id="idm140712070332864"><span class="term ">replay</span></dt><dd><p>
      Almost all messages sent in a network can be eavesdropped, stolen, and
      resent. In the Kerberos context, this would be most dangerous if an
      attacker manages to obtain your request for a service containing your
      ticket and authenticator. The attacker could then try to resend it
      (<span class="emphasis"><em>replay</em></span>) to impersonate you. However, Kerberos
      implements several mechanisms to deal with this problem.
     </p></dd><dt id="idm140712070330240"><span class="term ">server or service</span></dt><dd><p>
      <span class="emphasis"><em>Service</em></span> is used to refer to a specific action to
      perform. The process behind this action is called a
      <span class="emphasis"><em>server</em></span>.
     </p></dd></dl></div></div><div class="sect1 " id="sec.security.kerberos.how"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.how"><span class="number">6.3 </span><span class="name">How Kerberos Works</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.how">#</a></h2></div></div></div><p>
   Kerberos is often called a third-party trusted authentication service,
   which means all its clients trust Kerberos's judgment of another client's
   identity. Kerberos keeps a database of all its users and their private
   keys.
  </p><p>
   To ensure Kerberos is working correctly, run both the authentication and
   ticket-granting server on a dedicated machine. Make sure that only the
   administrator can access this machine physically and over the network.
   Reduce the (networking) services running on it to the absolute
   minimum—do not even run
   <code class="systemitem">sshd</code>.
  </p><div class="sect2 " id="sec.security.kerberos.how.contact"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.how.contact"><span class="number">6.3.1 </span><span class="name">First Contact</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.how.contact">#</a></h3></div></div></div><p>
    Your first contact with Kerberos is quite similar to any login procedure
    at a normal networking system. Enter your user name. This piece of
    information and the name of the ticket-granting service are sent to the
    authentication server (Kerberos). If the authentication server knows
    you, it generates a random session key for further use between your
    client and the ticket-granting server. Now the authentication server
    prepares a ticket for the ticket-granting server. The ticket contains
    the following information—all encrypted with a session key only
    the authentication server and the ticket-granting server know:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The names of both, the client and the ticket-granting server
     </p></li><li class="listitem "><p>
      The current time
     </p></li><li class="listitem "><p>
      A lifetime assigned to this ticket
     </p></li><li class="listitem "><p>
      The client's IP address
     </p></li><li class="listitem "><p>
      The newly-generated session key
     </p></li></ul></div><p>
    This ticket is then sent back to the client together with the session
    key, again in encrypted form, but this time the private key of the
    client is used. This private key is only known to Kerberos and the
    client, because it is derived from your user password. Now that the
    client has received this response, you are prompted for your password.
    This password is converted into the key that can decrypt the package
    sent by the authentication server. The package is
    <span class="quote">“<span class="quote">unwrapped</span>”</span> and password and key are erased from the
    workstation's memory. As long as the lifetime given to the ticket used
    to obtain other tickets does not expire, your workstation can prove your
    identity.
   </p></div><div class="sect2 " id="sec.security.kerberos.how.request"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.how.request"><span class="number">6.3.2 </span><span class="name">Requesting a Service</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.how.request">#</a></h3></div></div></div><p>
    To request a service from any server in the network, the client
    application needs to prove its identity to the server. Therefore, the
    application generates an authenticator. An authenticator consists of the
    following components:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The client's principal
     </p></li><li class="listitem "><p>
      The client's IP address
     </p></li><li class="listitem "><p>
      The current time
     </p></li><li class="listitem "><p>
      A checksum (chosen by the client)
     </p></li></ul></div><p>
    All this information is encrypted using the session key that the client
    has already received for this special server. The authenticator and the
    ticket for the server are sent to the server. The server uses its copy
    of the session key to decrypt the authenticator, which gives it all the
    information needed about the client requesting its service, to compare
    it to that contained in the ticket. The server checks if the ticket and
    the authenticator originate from the same client.
   </p><p>
    Without any security measures implemented on the server side, this stage
    of the process would be an ideal target for replay attacks. Someone
    could try to resend a request stolen off the net some time before. To
    prevent this, the server does not accept any request with a time stamp
    and ticket received previously. In addition to that, a request with a
    time stamp differing too much from the time the request is received is
    ignored.
   </p></div><div class="sect2 " id="sec.security.kerberos.how.mutual"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.how.mutual"><span class="number">6.3.3 </span><span class="name">Mutual Authentication</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.how.mutual">#</a></h3></div></div></div><p>
    Kerberos authentication can be used in both directions. It is not only a
    question of the client being the one it claims to be. The server should
    also be able to authenticate itself to the client requesting its
    service. Therefore, it sends an authenticator itself. It adds one to the
    checksum it received in the client's authenticator and encrypts it with
    the session key, which is shared between it and the client. The client
    takes this response as a proof of the server's authenticity and they
    both start cooperating.
   </p></div><div class="sect2 " id="sec.security.kerberos.how.tgs"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.how.tgs"><span class="number">6.3.4 </span><span class="name">Ticket Granting—Contacting All Servers</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.how.tgs">#</a></h3></div></div></div><p>
    Tickets are designed to be used for one server at a time.  Therefore, you
    need to get a new ticket each time you request another service. Kerberos
    implements a mechanism to obtain tickets for individual servers. This
    service is called the <span class="quote">“<span class="quote">ticket-granting service</span>”</span>. The
    ticket-granting service is a service (like any other service mentioned
    before) and uses the same access protocols that have already been
    outlined. Any time an application needs a ticket that has not already been
    requested, it contacts the ticket-granting server.  This request consists
    of the following components:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The requested principal
     </p></li><li class="listitem "><p>
      The ticket-granting ticket
     </p></li><li class="listitem "><p>
      An authenticator
     </p></li></ul></div><p>
    Like any other server, the ticket-granting server now checks the
    ticket-granting ticket and the authenticator. If they are considered
    valid, the ticket-granting server builds a new session key to be used
    between the original client and the new server. Then the ticket for the
    new server is built, containing the following information:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The client's principal
     </p></li><li class="listitem "><p>
      The server's principal
     </p></li><li class="listitem "><p>
      The current time
     </p></li><li class="listitem "><p>
      The client's IP address
     </p></li><li class="listitem "><p>
      The newly-generated session key
     </p></li></ul></div><p>
    The new ticket has a lifetime, which is either the remaining lifetime of
    the ticket-granting ticket or the default for the service. The lesser of
    both values is assigned. The client receives this ticket and the session
    key, which are sent by the ticket-granting service. But this time the
    answer is encrypted with the session key that came with the original
    ticket-granting ticket. The client can decrypt the response without
    requiring the user's password when a new service is contacted. Kerberos
    can thus acquire ticket after ticket for the client without bothering
    the user.
   </p></div></div><div class="sect1 " id="sec.security.kerberos.users"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.users"><span class="number">6.4 </span><span class="name">User View of Kerberos</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.users">#</a></h2></div></div></div><p>
   Ideally, a user only contact with Kerberos happens during login
   at the workstation. The login process includes obtaining a
   ticket-granting ticket. At logout, a user's Kerberos tickets are
   automatically destroyed, which makes it difficult for anyone else to
   impersonate this user.
  </p><p>
   The automatic expiration of tickets can lead to a situation when a user's login session lasts longer than the maximum
   lifespan given to the ticket-granting ticket (a reasonable setting is 10
   hours). However, the user can get a new ticket-granting ticket by running
   <code class="command">kinit</code>. Enter the password again and Kerberos obtains
   access to desired services without additional authentication. To get a
   list of all the tickets silently acquired for you by Kerberos, run
   <code class="command">klist</code>.
  </p><p>
   Here is a short list of applications that use Kerberos authentication.
   These applications can be found under
   <code class="filename">/usr/lib/mit/bin</code> or
   <code class="filename">/usr/lib/mit/sbin</code> after installing the package
   <code class="systemitem">krb5-apps-clients</code>. They all have the full
   functionality of their common Unix and Linux brothers plus the additional
   bonus of transparent authentication managed by Kerberos:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <code class="command">telnet</code>,
     <code class="systemitem">telnetd</code>
    </p></li><li class="listitem "><p>
     <code class="command">rlogin</code>
    </p></li><li class="listitem "><p>
     <code class="command">rsh</code>, <code class="command">rcp</code>,
     <code class="systemitem">rshd</code>
    </p></li><li class="listitem "><p>
     <code class="command">ftp</code>, <code class="systemitem">ftpd</code>
    </p></li><li class="listitem "><p>
     <code class="command">ksu</code>
    </p></li></ul></div><p>
   You no longer need to enter your password for using these applications
   because Kerberos has already proven your identity.
   <code class="command">ssh</code>, if compiled with Kerberos support, can even
   forward all the tickets acquired for one workstation to another one. If
   you use <code class="command">ssh</code> to log in to another workstation,
   <code class="command">ssh</code> makes sure that the encrypted contents of the
   tickets are adjusted to the new situation. Simply copying tickets between
   workstations is not sufficient because the ticket contains
   workstation-specific information (the IP address). XDM and GDM offer
   Kerberos support, too. Read more about the Kerberos network applications
   in <em class="citetitle ">Kerberos V5 UNIX User's Guide</em> at
   <a class="link" href="http://web.mit.edu/kerberos" target="_blank">http://web.mit.edu/kerberos</a>.
  </p></div><div class="sect1 " id="sec.security.kerberos.admin"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.admin"><span class="number">6.5 </span><span class="name">Installing and Administering Kerberos</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin">#</a></h2></div></div></div><p>
   A Kerberos environment consists of several components. A key
   distribution center (KDC) holds the central database with all
   Kerberos-relevant data. All clients rely on the KDC for proper
   authentication across the network. Both the KDC and the clients need to
   be configured to match your setup:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070266528"><span class="term ">General Preparations</span></dt><dd><p>
      Check your network setup and make sure it meets the minimum
      requirements outlined in
      <a class="xref" href="#sec.security.kerberos.admin.top" title="6.5.1. Kerberos Network Topology">Section 6.5.1, “Kerberos Network Topology”</a>. Choose an
      appropriate realm for your Kerberos setup, see
      <a class="xref" href="#sec.security.kerberos.admin.realm" title="6.5.2. Choosing the Kerberos Realms">Section 6.5.2, “Choosing the Kerberos Realms”</a>. Carefully set up
      the machine that is to serve as the KDC and apply tight security, see
      <a class="xref" href="#sec.security.kerberos.admin.kdc" title="6.5.3. Setting Up the KDC Hardware">Section 6.5.3, “Setting Up the KDC Hardware”</a>. Set up a reliable
      time source in your network to make sure all tickets contain valid
      time stamps, see <a class="xref" href="#sec.security.kerberos.admin.time" title="6.5.4. Configuring Time Synchronization">Section 6.5.4, “Configuring Time Synchronization”</a>.
     </p></dd><dt id="idm140712070262112"><span class="term ">Basic Configuration</span></dt><dd><p>
      Configure the KDC and the clients, see
      <a class="xref" href="#sec.security.kerberos.admin.instkdc" title="6.5.5. Configuring the KDC">Section 6.5.5, “Configuring the KDC”</a> and
      <a class="xref" href="#sec.security.kerberos.admin.client" title="6.5.6. Configuring Kerberos Clients">Section 6.5.6, “Configuring Kerberos Clients”</a>. Enable remote
      administration for your Kerberos service, so you do not need physical
      access to your KDC machine, see
      <a class="xref" href="#sec.security.kerberos.admin.remote" title="6.5.7. Configuring Remote Kerberos Administration">Section 6.5.7, “Configuring Remote Kerberos Administration”</a>. Create service
      principals for every service in your realm, see
      <a class="xref" href="#sec.security.kerberos.admin.hostprinc" title="6.5.8. Creating Kerberos Service Principals">Section 6.5.8, “Creating Kerberos Service Principals”</a>.
     </p></dd><dt id="idm140712070257792"><span class="term ">Enabling Kerberos Authentication</span></dt><dd><p>
      Various services in your network can use Kerberos. To add
      Kerberos password-checking to applications using PAM, proceed as
      outlined in <a class="xref" href="#sec.security.kerberos.admin.pam" title="6.5.9. Enabling PAM Support for Kerberos">Section 6.5.9, “Enabling PAM Support for Kerberos”</a>. To
      configure SSH or LDAP with Kerberos authentication, proceed as
      outlined in <a class="xref" href="#sec.security.kerberos.admin.sshd" title="6.5.10. Configuring SSH for Kerberos Authentication">Section 6.5.10, “Configuring SSH for Kerberos Authentication”</a> and
      <a class="xref" href="#sec.security.kerberos.admin.ldap" title="6.5.11. Using LDAP and Kerberos">Section 6.5.11, “Using LDAP and Kerberos”</a>.
     </p></dd></dl></div><div class="sect2 " id="sec.security.kerberos.admin.top"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.top"><span class="number">6.5.1 </span><span class="name">Kerberos Network Topology</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.top">#</a></h3></div></div></div><p>
    Any Kerberos environment must meet the following requirements to be
    fully functional:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Provide a DNS server for name resolution across your network, so
      clients and servers can locate each other. Refer to
      <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 19 “The Domain Name System”</span> for information on DNS setup.
     </p></li><li class="listitem "><p>
      Provide a time server in your network. Using exact time stamps is
      crucial to a Kerberos setup, because valid Kerberos tickets must
      contain correct time stamps. Refer to <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 18 “Time Synchronization with NTP”</span>
      for information on NTP setup.
     </p></li><li class="listitem "><p>
      Provide a key distribution center (KDC) as the center piece of the
      Kerberos architecture. It holds the Kerberos database. Use the
      tightest possible security policy on this machine to prevent any
      attacks on this machine compromising your entire infrastructure.
     </p></li><li class="listitem "><p>
      Configure the client machines to use Kerberos authentication.
     </p></li></ul></div><p>
    The following figure depicts a simple example network with only the
    minimum components needed to build a Kerberos infrastructure. Depending
    on the size and topology of your deployment, your setup may vary.
   </p><div class="figure" id="fig.netw.kerb"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/network_kerb.png"><img src="images/network_kerb.png" width="" alt="Kerberos Network Topology" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 6.1: </span><span class="name">Kerberos Network Topology </span><a title="Permalink" class="permalink" href="#fig.netw.kerb">#</a></h6></div></div><div id="idm140712070239776" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Configuring Subnet Routing</h6><p>
     For a setup similar to the one in <a class="xref" href="#fig.netw.kerb" title="Kerberos Network Topology">Figure 6.1, “Kerberos Network Topology”</a>,
     configure routing between the two subnets (192.168.1.0/24 and
     192.168.2.0/24). Refer to
     <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 13 “Basic Networking”, Section 13.4.1.5 “Configuring Routing”</span> for more information
     on configuring routing with YaST.
    </p></div></div><div class="sect2 " id="sec.security.kerberos.admin.realm"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.realm"><span class="number">6.5.2 </span><span class="name">Choosing the Kerberos Realms</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.realm">#</a></h3></div></div></div><p>
    The domain of a Kerberos installation is called a realm and is
    identified by a name, such as <code class="literal">EXAMPLE.COM</code> or simply
    <code class="literal">ACCOUNTING</code>. Kerberos is case-sensitive, so
    <code class="literal">example.com</code> is actually a different realm than
    <code class="literal">EXAMPLE.COM</code>. Use the case you prefer. It is common
    practice, however, to use uppercase realm names.
   </p><p>
    It is also a good idea to use your DNS domain name (or a subdomain, such
    as <code class="literal">ACCOUNTING.EXAMPLE.COM</code>). As shown below, your life
    as an administrator can be much easier if you configure your Kerberos
    clients to locate the KDC and other Kerberos services via DNS. To do so,
    it is helpful if your realm name is a subdomain of your DNS domain name.
   </p><p> Unlike the DNS name space, Kerberos is not hierarchical. So if you have
   a realm named <code class="literal">EXAMPLE.COM</code> with two <span class="quote">“<span class="quote">subrealms</span>”</span> named
          <code class="literal">DEVELOPMENT</code> and
          <code class="literal">ACCOUNTING</code>, and these subordinate realms do not inherit principals from
          <code class="literal">EXAMPLE.COM</code>. Instead, you would have three
        separate realms, and you would need to configure
        cross-realm authentication for each realm, so that users from one realm to interact
        with servers or other users from another realm. </p><p>
    For the sake of simplicity, let us assume you are setting up only one
    realm for your entire organization. For the remainder of this section,
    the realm name <code class="literal">EXAMPLE.COM</code> is used in all examples.
   </p></div><div class="sect2 " id="sec.security.kerberos.admin.kdc"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.kdc"><span class="number">6.5.3 </span><span class="name">Setting Up the KDC Hardware</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.kdc">#</a></h3></div></div></div><p>
    The first thing required to use Kerberos is a machine that acts as the
    key distribution center, or KDC for short. This machine holds the entire
    Kerberos user database with passwords and all information.
   </p><p>
    The KDC is the most important part of your security
    infrastructure—if someone breaks into it, all user accounts and
    all of your infrastructure protected by Kerberos is compromised. An
    attacker with access to the Kerberos database can impersonate any
    principal in the database. Tighten security for this machine as much as
    possible:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Put the server machine into a physically secured location, such as a
      locked server room to which only a very few people have access.
     </p></li><li class="step "><p>
      Do not run any network applications on it except the KDC. This
      includes servers and clients—for example, the KDC should not
      import any file systems via NFS or use DHCP to retrieve its network
      configuration.
     </p></li><li class="step "><p>
      Install a minimal system first then check the list of installed
      packages and remove any unneeded packages. This includes servers, such
      as <code class="systemitem">inetd</code>,
      <code class="systemitem">portmap</code>, and CUPS, plus
      anything X-based. Even installing an SSH server should be considered a
      potential security risk.
     </p></li><li class="step "><p>
      No graphical login is provided on this machine as an X server is a
      potential security risk. Kerberos provides its own administration
      interface.
     </p></li><li class="step "><p>
      Configure <code class="filename">/etc/nsswitch.conf</code> to use only local
      files for user and group lookup. Change the lines for
      <code class="literal">passwd</code> and <code class="literal">group</code> to look like
      this:
     </p><div class="verbatim-wrap"><pre class="screen">passwd:         files
group:          files</pre></div><p>
      Edit the <code class="filename">passwd</code>, <code class="filename">group</code>, and
      <code class="filename">shadow</code> files in <code class="filename">/etc</code> and
      remove the lines that start with a <code class="literal">+</code> character
      (these are for NIS lookups).
     </p></li><li class="step "><p>
      Disable all user accounts except <code class="systemitem">root</code>'s account by editing
      <code class="filename">/etc/shadow</code> and replacing the hashed passwords
      with <code class="literal">*</code> or <code class="literal">!</code> characters.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.security.kerberos.admin.time"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.time"><span class="number">6.5.4 </span><span class="name">Configuring Time Synchronization</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.time">#</a></h3></div></div></div><p>
    To use Kerberos successfully, make sure that all system clocks within
    your organization are synchronized within a certain range. This is
    important because Kerberos protects against replayed credentials. An
    attacker might be able to observe Kerberos credentials on the network
    and reuse them to attack the server. Kerberos employs several defenses
    to prevent this. One of them is that it puts time stamps into its
    tickets. A server receiving a ticket with a time stamp that differs from
    the current time rejects the ticket.
   </p><p>
    Kerberos allows a certain leeway when comparing time
    stamps. However, computer clocks can be very inaccurate in keeping
    time—it is not unheard of for PC clocks to lose or gain half
    an hour during a week. For this reason, configure all hosts on the
    network to synchronize their clocks with a central time source.
   </p><p>
    A simple way to do so is by installing an NTP time server on one machine and
    having all clients synchronize their clocks with this server. Do this by
    running an NTP daemon <code class="systemitem">chronyd</code> as a client on all these machines. The KDC
    itself needs to be synchronized to the common time source as well. Because
    running an NTP daemon on this machine would be a security risk, it is
    probably a good idea to do this by running <code class="command">chronyd -q</code> via
    a cron job. To configure your machine as an NTP client, proceed as outlined
    in <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 18 “Time Synchronization with NTP”, Section 18.1 “Configuring an NTP Client with YaST”</span>.
   </p><p>
    A different way to secure the time service and still use the NTP daemon
    is to attach a hardware reference clock to a dedicated NTP server and
    an additional hardware reference clock to the KDC.
   </p><p>
    It is also possible to adjust the maximum deviation Kerberos allows when
    checking time stamps. This value (called <span class="emphasis"><em>clock
    skew</em></span>) can be set in the <code class="filename">krb5.conf</code> file
    as described in
    <a class="xref" href="#sec.security.kerberos.admin.client.clockskew" title="6.5.6.3. Adjusting the Clock Skew">Section 6.5.6.3, “Adjusting the Clock Skew”</a>.
   </p></div><div class="sect2 " id="sec.security.kerberos.admin.instkdc"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.instkdc"><span class="number">6.5.5 </span><span class="name">Configuring the KDC</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.instkdc">#</a></h3></div></div></div><p>
    This section covers the initial configuration and installation of the
    KDC, including the creation of an administrative principal. This
    procedure consists of several steps:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p><span class="formalpara-title">Install the RPMs. </span>
       On a machine designated as the KDC, install the following software
       packages: <code class="systemitem">krb5</code>,
       <code class="systemitem">krb5-server</code> and
       <code class="systemitem">krb5-client</code> packages.
      </p></li><li class="step "><p><span class="formalpara-title">Adjust the Configuration Files. </span>
       The <code class="filename">/etc/krb5.conf</code> and
       <code class="filename">/var/lib/kerberos/krb5kdc/kdc.conf</code> configuration
       files must be adjusted for your scenario. These files contain all
       information on the KDC.
      </p></li><li class="step "><p><span class="formalpara-title">Create the Kerberos Database. </span>
       Kerberos keeps a database of all principal identifiers and the secret
       keys of all principals that need to be authenticated. Refer to
       <a class="xref" href="#sec.security.kerberos.admin.kdc.database" title="6.5.5.1. Setting Up the Database">Section 6.5.5.1, “Setting Up the Database”</a> for
       details.
      </p></li><li class="step "><p><span class="formalpara-title">Adjust the ACL Files: Add Administrators. </span>
       The Kerberos database on the KDC can be managed remotely. To prevent
       unauthorized principals from tampering with the database, Kerberos
       uses access control lists. You must explicitly enable remote access
       for the administrator principal to enable them to manage the database.
       The Kerberos ACL file is located under
       <code class="filename">/var/lib/kerberos/krb5kdc/kadm5.acl</code>. Refer to
       <a class="xref" href="#sec.security.kerberos.admin.remote" title="6.5.7. Configuring Remote Kerberos Administration">Section 6.5.7, “Configuring Remote Kerberos Administration”</a> for details.
      </p></li><li class="step "><p><span class="formalpara-title">Adjust the Kerberos Database: Add Administrators. </span>
       You need at least one administrative principal to run and administer
       Kerberos. This principal must be added before starting the KDC. Refer
       to <a class="xref" href="#sec.security.kerberos.admin.kdc.princ" title="6.5.5.2. Creating a Principal">Section 6.5.5.2, “Creating a Principal”</a> for
       details.
      </p></li><li class="step "><p><span class="formalpara-title">Start the Kerberos Daemon. </span>
       After the KDC software is installed and properly configured, start
       the Kerberos daemon to provide Kerberos service for your realm. Refer
       to <a class="xref" href="#sec.security.kerberos.admin.kdc.start" title="6.5.5.3. Starting the KDC">Section 6.5.5.3, “Starting the KDC”</a> for
       details.
      </p></li><li class="step "><p><span class="formalpara-title">Create a Principal for Yourself. </span>
       You need a principal for yourself. Refer to
       <a class="xref" href="#sec.security.kerberos.admin.kdc.princ" title="6.5.5.2. Creating a Principal">Section 6.5.5.2, “Creating a Principal”</a> for details.
      </p></li></ol></div></div><div class="sect3 " id="sec.security.kerberos.admin.kdc.database"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.kdc.database"><span class="number">6.5.5.1 </span><span class="name">Setting Up the Database</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.kdc.database">#</a></h4></div></div></div><p>
     Your next step is to initialize the database where Kerberos keeps all
     information about principals. Set up the database master key, which is
     used to protect the database from accidental disclosure (in particular
     if it is backed up to tape). The master key is derived from a pass
     phrase and is stored in a file called the stash file. This is so you do
     not need to enter the password every time the KDC is restarted. Make
     sure that you choose a good pass phrase, such as a sentence from a book
     opened to a random page.
    </p><p>
     When you make tape backups of the Kerberos database
     (<code class="filename">/var/lib/kerberos/krb5kdc/principal</code>), do not back
     up the stash file (which is in
     <code class="filename">/var/lib/kerberos/krb5kdc/.k5.EXAMPLE.COM</code>).
     Otherwise, everyone able to read the tape could also decrypt the
     database. Therefore, keep a copy of the pass phrase in a safe or some
     other secure location, because you will need it to restore your
     database from backup tape after a crash.
    </p><p>
     To create the stash file and the database, run:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> kdb5_util create -r EXAMPLE.COM -s</pre></div><p>
     You will see the following output:
    </p><div class="verbatim-wrap"><pre class="screen">Initializing database '/var/lib/kerberos/krb5kdc/principal' for realm 'EXAMPLE.COM',
master key name 'K/M@EXAMPLE.COM'
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.
Enter KDC database master key:  <span id="co.kerb.kdb5.pass"></span><span class="callout">1</span>
Re-enter KDC database master key to verify:  <span id="co.kerb.kdb5.pass.repeat"></span><span class="callout">2</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.kerb.kdb5.pass"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
       Type the master password.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.kerb.kdb5.pass.repeat"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
       Type the password again.
      </p></td></tr></table></div><p>
     To verify, use the list command:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kadmin.local

<code class="prompt user">kadmin&gt; </code>listprincs</pre></div><p>
     You will see several principals in the database, which are for internal
     use by Kerberos:
    </p><div class="verbatim-wrap"><pre class="screen">K/M@EXAMPLE.COM
kadmin/admin@EXAMPLE.COM
kadmin/changepw@EXAMPLE.COM
krbtgt/EXAMPLE.COM@EXAMPLE.COM</pre></div></div><div class="sect3 " id="sec.security.kerberos.admin.kdc.princ"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.kdc.princ"><span class="number">6.5.5.2 </span><span class="name">Creating a Principal</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.kdc.princ">#</a></h4></div></div></div><p>
     Create two Kerberos principals for yourself: one normal principal for
     everyday work and one for administrative tasks relating to Kerberos.
     Assuming your login name is <code class="systemitem">exampleuserIII_plain</code>, proceed as follows:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kadmin.local

<code class="prompt user">kadmin&gt; </code>ank geeko</pre></div><p>
     You will see the following output:
    </p><div class="verbatim-wrap"><pre class="screen">geeko@EXAMPLE.COM's Password: <span id="co.kerb.geeko.pass"></span><span class="callout">1</span>
Verifying password: <span id="co.kerb.geeko.pass.repeat"></span><span class="callout">2</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.kerb.geeko.pass"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
       Type <code class="systemitem">exampleuserIII_plain</code>'s password.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.kerb.geeko.pass"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
       Type <code class="systemitem">exampleuserIII_plain</code>'s password again.
      </p></td></tr></table></div><p>
     Next, create another principal named
     <code class="literal">geeko/admin</code> by typing
     <code class="command">ank</code> <code class="option">geeko/admin</code> at
     the <code class="command">kadmin</code> prompt. The <code class="literal">admin</code>
     suffixed to your user name is a <span class="emphasis"><em>role</em></span>. Later, use
     this role when administering the Kerberos database. A user can have
     several roles for different purposes. Roles act like completely
     different accounts that have similar names.
    </p></div><div class="sect3 " id="sec.security.kerberos.admin.kdc.start"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.kdc.start"><span class="number">6.5.5.3 </span><span class="name">Starting the KDC</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.kdc.start">#</a></h4></div></div></div><p>
     Start the KDC daemon and the kadmin daemon. To start the daemons
     manually, enter:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl start krb5kdc
sudo systemctl start kadmind</pre></div><p>
     Also make sure that the services KDC (<code class="systemitem">krb5kdc</code>) and
     kadmind (<code class="systemitem">kadmind</code>) are started by
     default when the server machine is rebooted. Enable them by entering:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl enable krb5kdc kadmind</pre></div><p>
     or by using the YaST <span class="guimenu">Services Manager</span>.
    </p></div></div><div class="sect2 " id="sec.security.kerberos.admin.client"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.client"><span class="number">6.5.6 </span><span class="name">Configuring Kerberos Clients</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.client">#</a></h3></div></div></div><p>
    When the supporting infrastructure is in place (DNS, NTP) and the KDC
    has been properly configured and started, configure the client machines.
    To configure a Kerberos client, use one of the two manual approaches
    described below.
   </p><p>
     When configuring Kerberos, there are two approaches you can
     take—static configuration in the
     <code class="filename">/etc/krb5.conf</code> file or dynamic configuration with
     DNS. With DNS configuration, Kerberos applications try to locate the
     KDC services using DNS records. With static configuration, add the host
     names of your KDC server to <code class="filename">krb5.conf</code> (and update
     the file whenever you move the KDC or reconfigure your realm in other
     ways).
    </p><p>
     DNS-based configuration is generally a lot more flexible and the amount
     of configuration work per machine is a lot less. However, it requires
     that your realm name is either the same as your DNS domain or a
     subdomain of it. Configuring Kerberos via DNS also creates a
     security issue: an attacker can seriously disrupt your
     infrastructure through your DNS (by shooting down the name server,
     spoofing DNS records, etc.). However, this amounts to a denial of
     service at worst. A similar scenario applies to the static
     configuration case unless you enter IP addresses in
     <code class="filename">krb5.conf</code> instead of host names.
    </p><div class="sect3 " id="sec.security.kerberos.admin.client.stat"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.client.stat"><span class="number">6.5.6.1 </span><span class="name">Static Configuration</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.client.stat">#</a></h4></div></div></div><p>
      One way to configure Kerberos is to edit
      <code class="filename">/etc/krb5.conf</code>. The file installed by default
      contains various sample entries. Erase all of these entries before
      starting. <code class="filename">krb5.conf</code> is made up of several
      sections (stanzas), each introduced by the section name in brackets
      like <code class="literal">[this]</code>.
     </p><p>
      To configure your Kerberos clients, add the following stanza to
      <code class="filename">krb5.conf</code> (where
      <code class="systemitem">kdc.example.com</code> is the
      host name of the KDC):
     </p><div class="verbatim-wrap"><pre class="screen">[libdefaults]
        default_realm = EXAMPLE.COM

[realms]
        EXAMPLE.COM = {
                kdc = kdc.example.com
                admin_server = kdc.example.com
        }</pre></div><p>
      The <code class="literal">default_realm</code> line sets the default realm for
      Kerberos applications. If you have several realms, add additional
      statements to the <code class="literal">[realms]</code> section.
     </p><p>
      Also add a statement to this file that tells applications how to map
      host names to a realm. For example, when connecting to a remote host,
      the Kerberos library needs to know in which realm this host is
      located. This must be configured in the
      <code class="literal">[domain_realms]</code> section:
     </p><div class="verbatim-wrap"><pre class="screen">[domain_realm]
.example.com = EXAMPLE.COM
www.example.org = EXAMPLE.COM</pre></div><p>
      This tells the library that all hosts in the
      <code class="filename">example.com</code> DNS domains are in the
      <code class="filename">EXAMPLE.COM</code> Kerberos realm. In addition, one
      external host named <code class="filename">www.example.org</code> should also
      be considered a member of the <code class="filename">EXAMPLE.COM</code> realm.
     </p></div><div class="sect3 " id="sec.security.kerberos.admin.client.dns"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.client.dns"><span class="number">6.5.6.2 </span><span class="name">DNS-Based Configuration</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.client.dns">#</a></h4></div></div></div><p>
      DNS-based Kerberos configuration makes heavy use of SRV records. See
      <span class="emphasis"><em>(RFC2052) A DNS RR for specifying the location of
      services</em></span> at <a class="link" href="http://www.ietf.org" target="_blank">http://www.ietf.org</a>.
     </p><p>
      The name of an SRV record, as far as Kerberos is concerned, is always
      in the format <code class="literal">_service._proto.realm</code>, where realm is
      the Kerberos realm. Domain names in DNS are case-insensitive, so
      case-sensitive Kerberos realms would break when using this
      configuration method. <code class="literal">_service</code> is a service name
      (different names are used when trying to contact the KDC or the
      password service, for example). <code class="literal">_proto</code> can be
      either <code class="literal">_udp</code> or <code class="literal">_tcp</code>, but not all
      services support both protocols.
     </p><p>
      The data portion of SRV resource records consists of a priority value,
      a weight, a port number, and a host name. The priority defines the
      order in which hosts should be tried (lower values indicate a higher
      priority). The weight value is there to support some sort of load
      balancing among servers of equal priority. You probably do not need
      any of this, so it is okay to set these to zero.
     </p><p>
      MIT Kerberos currently looks up the following names when looking for
      services:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712070121408"><span class="term ">_kerberos</span></dt><dd><p>
         This defines the location of the KDC daemon (the authentication and
         ticket granting server). Typical records look like this:
        </p><div class="verbatim-wrap"><pre class="screen">_kerberos._udp.EXAMPLE.COM.  IN  SRV    0 0 88 kdc.example.com.
_kerberos._tcp.EXAMPLE.COM.  IN  SRV    0 0 88 kdc.example.com.</pre></div></dd><dt id="idm140712070118912"><span class="term ">_kerberos-adm</span></dt><dd><p>
         This describes the location of the remote administration service.
         Typical records look like this:
        </p><div class="verbatim-wrap"><pre class="screen">_kerberos-adm._tcp.EXAMPLE.COM. IN  SRV    0 0 749 kdc.example.com.</pre></div><p>
         Because kadmind does not support UDP, there should be no
         <code class="literal">_udp</code> record.
        </p></dd></dl></div><p>
      As with the static configuration file, there is a mechanism to inform
      clients that a specific host is in the <code class="literal">EXAMPLE.COM</code>
      realm, even if it is not part of the <code class="literal">example.com</code>
      DNS domain. This can be done by attaching a TXT record to
      <code class="literal">_kerberos.host_name</code>, as shown here:
     </p><div class="verbatim-wrap"><pre class="screen">_kerberos.www.example.org.  IN TXT "EXAMPLE.COM"</pre></div></div><div class="sect3 " id="sec.security.kerberos.admin.client.clockskew"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.client.clockskew"><span class="number">6.5.6.3 </span><span class="name">Adjusting the Clock Skew</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.client.clockskew">#</a></h4></div></div></div><p>
      The <span class="emphasis"><em>clock skew</em></span> is the tolerance for accepting
      tickets with time stamps that do not exactly match the host's system
      clock. Usually, the clock skew is set to 300 seconds (five minutes).
      This means a ticket can have a time stamp somewhere between five
      minutes behind and five minutes ahead of the server's clock.
     </p><p>
      When using NTP to synchronize all hosts, you can reduce this value to
      about one minute. The clock skew value can be set in
      <code class="filename">/etc/krb5.conf</code> like this:
     </p><div class="verbatim-wrap"><pre class="screen">[libdefaults]
        clockskew = 60</pre></div></div></div><div class="sect2 " id="sec.security.kerberos.admin.remote"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.remote"><span class="number">6.5.7 </span><span class="name">Configuring Remote Kerberos Administration</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.remote">#</a></h3></div></div></div><p>
    To be able to add and remove principals from the Kerberos database
    without accessing the KDC's console directly, tell the Kerberos
    administration server which principals are allowed to do what by editing
    <code class="filename">/var/lib/kerberos/krb5kdc/kadm5.acl</code>. The ACL
    (access control list) file allows you to specify privileges with a
    precise degree of control. For details, refer to the manual page with
    <code class="command">man</code> <code class="option">8 kadmind</code>.
   </p><p>
    For now, grant yourself the privilege to administer the database by
    putting the following line into the file:
   </p><div class="verbatim-wrap"><pre class="screen">geeko/admin              *</pre></div><p>
    Replace the user name <code class="systemitem">exampleuserIII_plain</code> with your own. Restart
    <code class="systemitem">kadmind</code> for the change to take effect.
   </p><p>
    You should now be able to perform Kerberos administration tasks remotely
    using the kadmin tool. First, obtain a ticket for your admin role and
    use that ticket when connecting to the kadmin server:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kadmin -p geeko/admin
Authenticating as principal geeko/admin@EXAMPLE.COM with password.
Password for geeko/admin@EXAMPLE.COM:
kadmin:  getprivs
current privileges: GET ADD MODIFY DELETE
kadmin:</pre></div><p>
    Using the <code class="command">getprivs</code> command, verify which privileges
    you have. The list shown above is the full set of privileges.
   </p><p>
    As an example, modify the principal <code class="systemitem">exampleuserIII_plain</code>:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kadmin -p geeko/admin
Authenticating as principal geeko/admin@EXAMPLE.COM with password.
Password for geeko/admin@EXAMPLE.COM:

kadmin:  getprinc geeko
Principal: geeko@EXAMPLE.COM
Expiration date: [never]
Last password change: Wed Jan 12 17:28:46 CET 2005
Password expiration date: [none]
Maximum ticket life: 0 days 10:00:00
Maximum renewable life: 7 days 00:00:00
Last modified: Wed Jan 12 17:47:17 CET 2005 (admin/admin@EXAMPLE.COM)
Last successful authentication: [never]
Last failed authentication: [never]
Failed password attempts: 0
Number of keys: 2
Key: vno 1, Triple DES cbc mode with HMAC/sha1, no salt
Key: vno 1, DES cbc mode with CRC-32, no salt
Attributes:
Policy: [none]

kadmin:  modify_principal -maxlife "8 hours" geeko
Principal "geeko@EXAMPLE.COM" modified.
kadmin:  getprinc geeko
Principal: geeko@EXAMPLE.COM
Expiration date: [never]
Last password change: Wed Jan 12 17:28:46 CET 2005
Password expiration date: [none]
Maximum ticket life: 0 days 08:00:00
Maximum renewable life: 7 days 00:00:00
Last modified: Wed Jan 12 17:59:49 CET 2005 (geeko/admin@EXAMPLE.COM)
Last successful authentication: [never]
Last failed authentication: [never]
Failed password attempts: 0
Number of keys: 2
Key: vno 1, Triple DES cbc mode with HMAC/sha1, no salt
Key: vno 1, DES cbc mode with CRC-32, no salt
Attributes:
Policy: [none]
kadmin:</pre></div><p>
    This changes the maximum ticket life time to eight hours. For more
    information about the <code class="command">kadmin</code> command and the options
    available, see the <code class="systemitem">krb5-doc</code> package or refer to
    the <code class="command">man</code> <code class="option">8 kadmin</code> manual page.
   </p></div><div class="sect2 " id="sec.security.kerberos.admin.hostprinc"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.hostprinc"><span class="number">6.5.8 </span><span class="name">Creating Kerberos Service Principals</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.hostprinc">#</a></h3></div></div></div><p>
    So far, only user credentials have been discussed. However,
    Kerberos-compatible services usually need to authenticate themselves to
    the client user, too. Therefore, special service principals must be
    in the Kerberos database for each service offered in the realm.
    For example, if ldap.example.com offers an LDAP service, you need a service
    principal, <code class="literal">ldap/ldap.example.com@EXAMPLE.COM</code>, to
    authenticate this service to all clients.
   </p><p>
    The naming convention for service principals is
    <code class="literal"><em class="replaceable ">SERVICE</em>/<em class="replaceable ">HOSTNAME</em>@<em class="replaceable ">REALM</em></code>,
    where <em class="replaceable ">HOSTNAME</em> is the host's fully qualified
    host name.
   </p><p>
    Valid service descriptors are:
   </p><div class="informaltable"><table border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
        <p>
         Service Descriptor
        </p>
       </th><th>
        <p>
         Service
        </p>
       </th></tr></thead><tbody><tr><td>
        <p>
         <code class="literal">host</code>
        </p>
       </td><td>
        <p>
         Telnet, RSH, SSH
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">nfs</code>
        </p>
       </td><td>
        <p>
         NFSv4 (with Kerberos support)
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">HTTP</code>
        </p>
       </td><td>
        <p>
         HTTP (with Kerberos authentication)
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">imap</code>
        </p>
       </td><td>
        <p>
         IMAP
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">pop</code>
        </p>
       </td><td>
        <p>
         POP3
        </p>
       </td></tr><tr><td>
        <p>
         <code class="literal">ldap</code>
        </p>
       </td><td>
        <p>
         LDAP
        </p>
       </td></tr></tbody></table></div><p>
    Service principals are similar to user principals, but have significant
    differences. The main difference between a user principal and a service
    principal is that the key of the former is protected by a
    password. When a user obtains a ticket-granting ticket from the
    KDC, they needs to type their password, so Kerberos can decrypt the ticket.
    It would be inconvenient for system administrators to obtain new tickets
    for the SSH daemon every eight hours or so.
   </p><p>
    Instead, the key required to decrypt the initial ticket for the service
    principal is extracted by the administrator from the KDC only once and
    stored in a local file called the <span class="emphasis"><em>keytab</em></span>. Services
    such as the SSH daemon read this key and use it to obtain new tickets
    automatically, when needed. The default keytab file resides in
    <code class="filename">/etc/krb5.keytab</code>.
   </p><p>
    To create a host service principal for <code class="literal">jupiter.example.com</code>
    enter the following commands during your kadmin session:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>kadmin -p geeko/admin
Authenticating as principal geeko/admin@EXAMPLE.COM with password.
Password for geeko/admin@EXAMPLE.COM:
kadmin:  addprinc -randkey host/jupiter.example.com
WARNING: no policy specified for host/jupiter.example.com@EXAMPLE.COM;
defaulting to no policy
Principal "host/jupiter.example.com@EXAMPLE.COM" created.</pre></div><p>
    Instead of setting a password for the new principal, the
    <code class="option">-randkey</code> flag tells <code class="command">kadmin</code> to
    generate a random key. This is used here because no user interaction is
    wanted for this principal. It is a server account for the machine.
   </p><p>
    Finally, extract the key and store it in the local keytab file
    <code class="filename">/etc/krb5.keytab</code>. This file is owned by the
    superuser, so you must be <code class="systemitem">root</code>
    to execute the next command in the kadmin shell:
   </p><div class="verbatim-wrap"><pre class="screen">kadmin:  ktadd host/jupiter.example.com
Entry for principal host/jupiter.example.com with kvno 3, encryption type Triple
DES cbc mode with HMAC/sha1 added to keytab WRFILE:/etc/krb5.keytab.
Entry for principal host/jupiter.example.com with kvno 3, encryption type DES
cbc mode with CRC-32 added to keytab WRFILE:/etc/krb5.keytab.
kadmin:</pre></div><p>
    When completed, make sure that you destroy the admin ticket obtained
    with kinit above with <code class="command">kdestroy</code>.
   </p></div><div class="sect2 " id="sec.security.kerberos.admin.pam"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.pam"><span class="number">6.5.9 </span><span class="name">Enabling PAM Support for Kerberos</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.pam">#</a></h3></div></div></div><div id="idm140712070057184" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Incomplete Configuration Locks Users Out</h6><p>
     An incomplete Kerberos configuration may completely lock you out of
     your system, including the root user. To prevent this, add the
     <code class="option">ignore_unknown_principals</code> directive to the
     <code class="option">pam_krb5</code> module <span class="emphasis"><em>after</em></span> you
     have added the <code class="option">pam_krb5</code> module to the existing
     PAM configuration files as described below.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">pam-config --add --krb5-ignore_unknown_principals</code></pre></div><p>
     This will direct the <code class="option">pam_krb5</code> module to ignore
     some errors that would otherwise cause the account phase to fail.
    </p></div><p>
    <span class="productname"><span class="phrase">openSUSE® Leap</span></span> comes with a PAM module named
    <code class="option">pam_krb5</code>, which supports Kerberos login and
    password update. This module can be used by applications such as console
    login, <code class="command">su</code>, and graphical login applications like GDM.
    That is, it can be used in all cases where the user enters a password
    and expects the authenticating application to obtain an initial Kerberos
    ticket on their behalf. To configure PAM support for Kerberos, use the
    following command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">pam-config --add --krb5</code></pre></div><p>
    The above command adds the <code class="option">pam_krb5</code> module to the
    existing PAM configuration files and makes sure it is called in the
    right order. To make precise adjustments to the way in which
    <code class="option">pam_krb5</code> is used, edit the file
    <code class="filename">/etc/krb5.conf</code> and add default applications to
    PAM. For details, refer to the manual page with
    <code class="command">man 5 pam_krb5</code>.
   </p><p>
    The <code class="option">pam_krb5</code> module was specifically not designed
    for network services that accept Kerberos tickets as part of user
    authentication. This is an entirely different matter, and is
    discussed below.
   </p></div><div class="sect2 " id="sec.security.kerberos.admin.sshd"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.sshd"><span class="number">6.5.10 </span><span class="name">Configuring SSH for Kerberos Authentication</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.sshd">#</a></h3></div></div></div><p>
    OpenSSH supports Kerberos authentication in both protocol
    version 1 and 2. In version 1, there are special
    protocol messages to transmit Kerberos tickets. Version 2 does
    not use Kerberos directly anymore, but relies on GSSAPI, the General
    Security Services API. This is a programming interface that is not
    specific to Kerberos—it was designed to hide the peculiarities
    of the underlying authentication system, be it Kerberos, a public-key
    authentication system like SPKM, or others. However, the included GSSAPI
    library only supports Kerberos.
   </p><p>
    To use sshd with Kerberos authentication, edit
    <code class="filename">/etc/ssh/sshd_config</code> and set the following options:
   </p><div class="verbatim-wrap"><pre class="screen"># These are for protocol version 1
#
# KerberosAuthentication yes
# KerberosTicketCleanup yes

# These are for version 2 - better to use this
GSSAPIAuthentication yes
GSSAPICleanupCredentials yes</pre></div><p>
    Then restart your SSH daemon using <code class="command">sudo systemctl restart
    sshd</code>.
   </p><p>
    To use Kerberos authentication with protocol version 2, enable it on the
    client side as well. Do this either in the systemwide configuration file
    <code class="filename">/etc/ssh/ssh_config</code> or on a per-user level by
    editing <code class="filename">~/.ssh/config</code>. In both cases, add the
    option <code class="literal">GSSAPIAuthentication yes</code>.
   </p><p>
    You should now be able to connect using Kerberos authentication. Use
    <code class="command">klist</code> to verify that you have a valid ticket, then
    connect to the SSH server. To force SSH protocol version 1, specify the
    <code class="literal">-1</code> option on the command line.
   </p><div id="idm140712070035232" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Additional Information</h6><p>
     The file
     <code class="filename">/usr/share/doc/packages/openssh/README.kerberos</code>
     discusses the interaction of OpenSSH and Kerberos in more detail.
    </p></div><div id="idm140712070033344" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Additional Directives for Protocol Version 2</h6><p>
     The <code class="literal">GSSAPIKeyExchange</code> mechanism (RFC 4462) is
     supported. This directive specifies how host keys are exchanged. For
     more information, see the sshd_config manual page (<code class="command">man
     sshd_config</code>).
    </p></div></div><div class="sect2 " id="sec.security.kerberos.admin.ldap"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.admin.ldap"><span class="number">6.5.11 </span><span class="name">Using LDAP and Kerberos</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.ldap">#</a></h3></div></div></div><p>
    When using Kerberos, one way to distribute the user information (such as
    user ID, groups, and home directory) in your local network is to use
    LDAP. This requires a strong authentication mechanism that prevents
    packet spoofing and other attacks. One solution is to use Kerberos for
    LDAP communication, too.
   </p><p>
    OpenLDAP implements most authentication flavors through SASL, the simple
    authentication session layer. SASL is a network protocol designed for
    authentication. The SASL implementation is cyrus-sasl, which supports
    several authentication flavors. Kerberos authentication is
    performed through GSSAPI (General Security Services API). By default,
    the SASL plug-in for GSSAPI is not installed. Install the
    <code class="systemitem">cyrus-sasl-gssapi</code> with YaST.
   </p><p>
    To enable Kerberos to bind to the OpenLDAP server, create a principal
    <code class="literal">ldap/ldap.example.com</code> and add that to the keytab.
   </p><p>
    By default, the LDAP server slapd runs as user and group
    <code class="systemitem">ldap</code>, while the keytab file is
    readable by <code class="systemitem">root</code> only.
    Therefore, either change the LDAP configuration so the server runs as
    <code class="systemitem">root</code> or make the keytab file
    readable by the group <code class="systemitem">ldap</code>.
    The latter is done automatically by the OpenLDAP start script
    (<code class="filename">/usr/lib/openldap/start</code>) if the keytab file has
    been specified in the <code class="envar">OPENLDAP_KRB5_KEYTAB</code> variable in
    <code class="filename">/etc/sysconfig/openldap</code> and the
    <code class="envar">OPENLDAP_CHOWN_DIRS</code> variable is set to
    <code class="literal">yes</code>, which is the default setting. If
    <code class="envar">OPENLDAP_KRB5_KEYTAB</code> is left empty, the default keytab
    under <code class="filename">/etc/krb5.keytab</code> is used and you must adjust
    the privileges yourself as described below.
   </p><p>
    To run slapd as <code class="systemitem">root</code>, edit
    <code class="filename">/etc/sysconfig/openldap</code>. Disable the
    <code class="systemitem">OPENLDAP_USER</code> and
    <code class="systemitem">OPENLDAP_GROUP</code> variables by putting a comment
    character in front of them.
   </p><p>
    To make the keytab file readable by group LDAP, execute
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> chgrp ldap /etc/krb5.keytab
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> chmod 640 /etc/krb5.keytab</pre></div><p>
    A third (and maybe the best) solution is to tell OpenLDAP to use a
    special keytab file. To do this, start kadmin, and enter the following
    command after you have added the principal ldap/ldap.example.com:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> ktadd -k /etc/openldap/ldap.keytab ldap/ldap.example.com@EXAMPLE.COM</pre></div><p>
    Then in the shell run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> chown ldap:ldap /etc/openldap/ldap.keytab
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> chmod 600 /etc/openldap/ldap.keytab</pre></div><p>
    To tell OpenLDAP to use a different keytab file, change the following
    variable in <code class="filename">/etc/sysconfig/openldap</code>:
   </p><div class="verbatim-wrap"><pre class="screen">OPENLDAP_KRB5_KEYTAB="/etc/openldap/ldap.keytab"</pre></div><p> Finally, restart the LDAP server using <code class="command">sudo systemctl
     restart slapd</code>. </p><div class="sect3 " id="sec.security.kerberos.admin.ldap.auth"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.ldap.auth"><span class="number">6.5.11.1 </span><span class="name">Using Kerberos Authentication with LDAP</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.ldap.auth">#</a></h4></div></div></div><p>
     You are now able to automatically use tools such as ldapsearch with
     Kerberos authentication.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ldapsearch -b ou=people,dc=example,dc=com '(uid=geeko)'

SASL/GSSAPI authentication started
SASL SSF: 56
SASL installing layers
[...]

# geeko, people, example.com
dn: uid=geeko,ou=people,dc=example,dc=com
uid: geeko
cn: Suzanne Geeko
[...]</pre></div><p>
     As you can see, <code class="command">ldapsearch</code> prints a message that it
     started GSSAPI authentication. The next message is very cryptic, but it
     shows that the <span class="emphasis"><em>security strength factor</em></span> (SSF for
     short) is 56 (The value 56 is somewhat arbitrary. Most likely it was
     chosen because this is the number of bits in a DES encryption key).
     This means that GSSAPI authentication was successful and that
     encryption is being used to protect integrity and provide
     confidentiality for the LDAP connection.
    </p><p>
     In Kerberos, authentication is always mutual. This means that not only
     have you authenticated yourself to the LDAP server, but also the LDAP
     server has authenticated itself to you. In particular, this means
     communication is with the desired LDAP server, rather than some bogus
     service set up by an attacker.
     
    </p></div><div class="sect3 " id="sec.security.kerberos.admin.ldap.acl"><div class="titlepage"><div><div><h4 class="title" id="sec.security.kerberos.admin.ldap.acl"><span class="number">6.5.11.2 </span><span class="name">Kerberos Authentication and LDAP Access Control</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.admin.ldap.acl">#</a></h4></div></div></div><p>
     There is one minor piece of the puzzle missing—how the LDAP
     server can find out that the Kerberos user
     <code class="literal">tux@EXAMPLE.COM</code> corresponds to the LDAP
     distinguished name
     <code class="literal">uid=tux,ou=people,dc=example,dc=com</code>.
     This sort of mapping must be configured manually using the
     <code class="literal">saslExpr</code> directive. In this example, the
     "authz-regexp" change in LDIF would look as follows:
    </p><div class="verbatim-wrap"><pre class="screen">dn: cn=config
add: olcAuthzRegexp
olcAuthzRegexp: uid=(.*),cn=GSSAPI,cn=auth uid=$1,ou=people,dc=example,dc=com</pre></div><p>
     All these changes can be applied via <code class="command">ldapmodify</code> on
     the command line.
    </p><p>
     When SASL authenticates a user, OpenLDAP forms a distinguished name
     from the name given to it by SASL (such as <code class="systemitem">tux</code>) and the
     name of the SASL flavor (<code class="literal">GSSAPI</code>). The result
     would be
     <code class="literal">uid=tux,cn=GSSAPI,cn=auth</code>.
    </p><p>
     If a <code class="literal">authz-regexp</code> has been configured, it checks the
     DN formed from the SASL information using the first argument as a
     regular expression. If this regular expression matches, the name is
     replaced with the second argument of the
     <code class="literal">authz-regexp</code> statement. The placeholder
     <code class="literal">$1</code> is replaced with the substring matched by the
     <code class="literal">(.*)</code> expression.
    </p><p>
     More complicated match expressions are possible. If you have a more
     complicated directory structure or a schema in which the user name is
     not part of the DN, you can even use search expressions to map the SASL
     DN to the user DN.
    </p><p>
     For more information, see the <code class="literal">slapd-config</code> man page.
    </p></div></div></div><div class="sect1 " id="sec.security.kerberos.yast.client"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.yast.client"><span class="number">6.6 </span><span class="name">Setting up Kerberos using <span class="guimenu">LDAP and Kerberos Client</span></span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.yast.client">#</a></h2></div></div></div><p>
   YaST includes the module <span class="guimenu">LDAP and Kerberos Client</span>
   that helps define authentication scenarios involving either LDAP or Kerberos.
  </p><p>
   It can also be used to join Kerberos and LDAP separately. However, in
   many such cases, using this module may not be the first choice, such as
   for joining Active Directory (which uses a combination of LDAP and Kerberos). For
   more information, see <a class="xref" href="#sec.security.auth.yast.client" title="4.2. Configuring an Authentication Client with YaST">Section 4.2, “Configuring an Authentication Client with YaST”</a>.
  </p><p>
   Start the module by selecting
   <span class="guimenu">Network Services</span> › <span class="guimenu">LDAP and
   Kerberos Client</span>.
  </p><div class="figure" id="fig.yast2.ldapkerberos.kerberos"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_client_config.png"><img src="images/yast2_auth_client_config.png" width="" alt="LDAP and Kerberos Client Window" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 6.2: </span><span class="name"><span class="guimenu">LDAP and Kerberos Client</span> Window </span><a title="Permalink" class="permalink" href="#fig.yast2.ldapkerberos.kerberos">#</a></h6></div></div><p>
   To configure a Kerberos client, follow the procedure below:
  </p><div class="procedure " id="pro.security.auth.kerberos"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     In the window <span class="guimenu">LDAP and Kerberos Client</span>, click
     <span class="guimenu">Change Settings</span>.
    </p><p>
     Choose the tab <span class="guimenu">Authentication via Kerberos</span>.
    </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/yast2_auth_client_krb5.png"><img src="images/yast2_auth_client_krb5.png" width="" alt="Tab Authentication via Kerberos" /></a></div></div></li><li class="step " id="st.kerberos.realm.add"><p>
     Click <span class="guimenu">Add Realm</span>.
    </p></li><li class="step " id="st.kerberos.realm.configure"><p>
     In the appearing dialog, specify the correct
     <span class="guimenu">Realm name</span>. Usually, the realm name is an uppercase
     version of the domain name. Additionally, you can specify the following:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       To apply mappings from the realm name to the domain name, activate
       <span class="guimenu">Map Domain Name to the Realm</span> and/or
       <span class="guimenu">Map Wildcard Domain Name to the Realm</span>.
      </p></li><li class="listitem "><p>
       You can specify the <span class="guimenu">Host Name of Administration
       Server</span>, the <span class="guimenu">Host Name of Master Key Distribution
       Server</span> and additional <span class="guimenu">Key Distribution Centers</span>.
      </p><p>
       All of these items are optional if they can be automatically
       discovered via the <code class="literal">SRV</code> and
       <code class="literal">TXT</code> records in DNS.
      </p></li><li class="listitem "><p>
       To manually map Principals to local user names, use
       <span class="guimenu">Custom Mappings of Principal Names to User Names</span>.
      </p><p>
       You can also use <code class="literal">auth_to_local</code> rules to supply such
       mappings using <span class="guimenu">Custom Rules for Mapping Principal Names to
       User Names</span>. For more information about using such rules, see
       the official documentation at
       <a class="link" href="https://web.mit.edu/kerberos/krb5-current/doc/admin/conf_files/krb5_conf.html#realms" target="_blank">https://web.mit.edu/kerberos/krb5-current/doc/admin/conf_files/krb5_conf.html#realms</a>.
      </p></li></ul></div><p>
     Continue with <span class="guimenu">OK</span>.
    </p></li><li class="step "><p>
     To add more realms, repeat from <a class="xref" href="#st.kerberos.realm.add" title="Step 2">Step 2</a>.
    </p></li><li class="step "><p>
     Enable Kerberos users logging in and creation of home directories by
     activating
     <span class="guimenu">Allow Kerberos Users to Authenticate</span> and
     <span class="guimenu">Automatically Create Home Directory</span>.
    </p></li><li class="step "><p>
     If you left empty the optional text boxes in
     <a class="xref" href="#st.kerberos.realm.configure" title="Step 3">Step 3</a>, make sure to enable
     automatic discovery of realms and key distribution centers by activating
     <span class="guimenu">Use DNS TXT Record to Discover Realms</span> and
     <span class="guimenu">Use DNS SRV Record to Discover KDC Servers</span>.
    </p></li><li class="step "><p>
     You can additionally activate the following:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       <span class="guimenu">Allow Insecure Encryption (for Windows NT)</span> allows
       the encryption types listed as weak at
       <a class="link" href="http://web.mit.edu/kerberos/krb5-current/doc/admin/conf_files/kdc_conf.html#encryption-types" target="_blank">http://web.mit.edu/kerberos/krb5-current/doc/admin/conf_files/kdc_conf.html#encryption-types</a>.
      </p></li><li class="listitem "><p>
       <span class="guimenu">Allow KDC on Other Networks to Issue Authentication
       Tickets</span> allows forwarding of tickets.
      </p></li><li class="listitem "><p>
       <span class="guimenu">Allow Kerberos-Enabled Services to Take on The Identity Of a
       User</span> allows the use of proxies between the computer of the
       user and the key distribution center.
      </p></li><li class="listitem "><p>
       <span class="guimenu">Issue Address-Less Tickets for Computers Behind
       NAT</span> allows granting tickets to users behind networks using
       network address translation.
      </p></li></ul></div></li><li class="step "><p>
     To set up allowed encryption types and define the name of the keytab
     file which lists the names of principals and their encrypted keys, use
     the <span class="guimenu">Extended Options</span>.
    </p></li><li class="step "><p>
     Finish with <span class="guimenu">OK</span> and <span class="guimenu">Finish</span>.
    </p><p>
     YaST may now install extra packages.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.security.kerberos.nfs"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.nfs"><span class="number">6.7 </span><span class="name">Kerberos and NFS</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.nfs">#</a></h2></div></div></div><p>
   Most NFS servers can export filesystems using any combination of
   the default "trust the network" form of security known as
   <code class="option">sec=sys</code>, and three different levels of Kerberos-based
   security, <code class="option">sec=krb5</code>, <code class="option">sec=krb5i</code> and
   <code class="option">sec=krb5p</code>. The <code class="option">sec</code> option is set
   as a mount option on the client. Is it often the case that NFS
   service will first be configured and used with
   <code class="option">sec=sys</code>, and then Kerberos can be imposed afterwards.
   In this case it is likely that the server will be configured to
   support both <code class="option">sec=sys</code> and one of the Kerberos levels,
   and then after all clients have transitioned, the
   <code class="option">sec=sys</code> support will be removed, thus achieving
   true security. The transition to Kerberos should be fairly transparent
   if done in an orderly manner. However there is one subtle detail of
   NFS behavior that works differently when Kerberos is used, and the
   implications of this need to be understand and possibly addressed.
   See <a class="xref" href="#sec.security.kerberos.overview.group" title="6.7.1. Group Membership">Section 6.7.1, “Group Membership”</a>.
  </p><p>
   The three Kerberos levels indicate different levels of security. With
   more security comes a need for more processor power to encrypt and
   decrypt messages. Choosing the right balance is an important
   consideration that should go in to planning a roll-out of Kerberos for
   NFS.
  </p><p>
   <code class="literal">krb5</code> provides only authentication. The server
   can know who sent a request, and the client can know that the
   server did send a reply. No security is provided for the content of
   the request or reply so an attacker with physical network access
   could transform the request or reply, or both, in arbitrary ways to
   deceive either server or client. They cannot directly read or
   change any file that the authenticated user could not read or
   change, but almost anything is theoretically
  possible.
  </p><p>
   <code class="literal">krb5i</code> adds integrity checks to all messages.
   With <code class="literal">krb5i</code>, an attacker cannot modify any
   request or reply, but they can view all the data exchanged, and so
   could discover the content of any file that is read.
  </p><p>
   <code class="literal">krb5p</code> adds privacy to the protocol. As well as
   reliable authentication and integrity checking, messages are fully
   encrypted so an attacker can only know that messages were exchanged
   between client and server, and cannot extract other information
   directly from the message. Whether information can be extracted
   from message timing is a separate question that Kerberos does not
   address.
  </p><div class="sect2 " id="sec.security.kerberos.overview.group"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.overview.group"><span class="number">6.7.1 </span><span class="name">Group Membership</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.overview.group">#</a></h3></div></div></div><p>
    The one behavioral difference between <code class="option">sec=sys</code> and
    the various Kerberos security levels that might be visible is related
    to group membership. In Unix and Linux, each filesystem access
    comes from a process which is owned by a particular user and has a
    particular group owner, and a number of supplemental groups. Access
    rights to files can vary based on the owner and the various groups.
   </p><p>
    With <code class="option">sec=sys</code>, the user-id, group-id, and a list of
    up to 16 supplemental groups are sent to the server in each
    request.
   </p><p>
    If a user is a member of more that 16 supplemental groups, the
    extra groups are lost and some files may not be accessible over NFS
    that the user would normally expect to have access to. For this
    reason, most sites that use NFS find a way to limit all users to at
    most 16 supplemental groups.
   </p><p>
    If the user runs the <code class="command">newgrp</code> command or runs a
    set-group-id program, either of which can change the list of groups
    they are a member of, these changes take effect immediately and
    provide different accesses over NFS.
   </p><p>
    With Kerberos, group information is not sent in requests at all. Only
    the user is identified (using a Kerberos "Principal"), and the server
    performs a lookup to determine the user ID and group list for that
    principal. This means that if the user is a member of more than 16
    groups, all of these group memberships will be used in determining
    file access permissions. However it also means that if the user
    changes a group-id on the client in some way, the server will not
    notice the change and will not take that it into account in
    determining access rights.
   </p><p>
    Is most cases, the improvement of having access to more groups
    brings a real benefit, and the loss of not being able to change
    groups is not noticed as it is not widely used. A site
    administrator considering the use of Kerberos should be aware of the
    difference though and ensure that it will not actually cause
    problems.
   </p></div><div class="sect2 " id="sec.security.kerberos.overview.performance"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.overview.performance"><span class="number">6.7.2 </span><span class="name">Performance and Scalability</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.overview.performance">#</a></h3></div></div></div><p>
    Using Kerberos for security requires extra CPU power for encrypting
    and decrypting messages. How much extra CPU power is required and
    whether the difference is noticeable will vary with different
    hardware and different applications. If the server or client are
    already saturating the available CPU power, it is likely that a
    performance drop will be measurable when switching from sec=sys to
    Kerberos. If there is spare CPU capacity available, it is quite
    possible that the transition will not result in any throughput
    change. The only way to be sure how much impact the use of Kerberos
    will have is to test your load on your hardware.
   </p><p>
    The only configuration options that might reduce the load will also
    reduce the quality of the protection offered.
    <code class="option">sec=krb5</code> should produce noticeably less load than
    <code class="option">sec=krb5p</code> but, as discussed above, it doesn't
    produce very strong security. Similarly it is possible to adjust
    the list of ciphers that Kerberos can choose from, and this might
    change the CPU requirement. However the defaults are carefully
    chosen and should not be changed without similar careful
    consideration.
   </p><p>
    The other possible performance issue when configuring NFS to use
    Kerberos involves availability of the Kerberos authentication servers,
    known as the KDC or Key Distribution Center.
   </p><p>
    The use of NFS adds load to such servers to the same degree that
    adding the use of Kerberos for any other services adds some load.
    Every time a given user (Kerberos principal) establishes a
    session with a service, for example by accessing files
    exported by a particular NFS server, the client needs to negotiate
    with the KDC. Once a session key has been negotiated, the client
    server can communicate without further help for many hours,
    depending on details of the Kerberos configuration, particularly the
    <code class="option">ticket_lifetime</code> setting.
   </p><p>
    The concerns most likely to affect the provisioning of Kerberos KDC
    servers are availability and peak usage.
   </p><p>
    As with other core services such as DNS, LDAP or similar
    name-lookup services, having two servers that are reasonably
    "close" to every client provides good availability for modest
    resources. Kerberos allows for multiple KDC servers with flexible
    models for database propagation, so distributing servers as needed
    around campuses, buildings, and even cabinets is fairly straight
    forward. The best mechanism to ensure each client finds a near-by
    Kerberos server is to use split-horizon DNS with each building (or
    similar) getting different details from the DNS server. If this is
    not possible, then managing the <code class="filename">/etc/krb5.conf</code>
    file to be different at different locations is a suitable
    alternative.
   </p><p>
    As access to the Kerberos KDC is infrequent, load is only likely to be
    a problem at peak times. If thousands of people all log in between
    9:00 and 9:05, then the servers will receive many more
    requests-per-minute than they might in the middle of the night. The
    load on the Kerberos server is likely to be more than that on an LDAP
    server, but not orders of magnitude more. A sensible guideline is
    to provision Kerberos replicas in the same manner that you provision
    LDAP replicas, and then monitor performance to determine if demand
    ever exceeds capacity.
   </p></div><div class="sect2 " id="sec.security.kerberos.overview.kdc"><div class="titlepage"><div><div><h3 class="title" id="sec.security.kerberos.overview.kdc"><span class="number">6.7.3 </span><span class="name">Master KDC, Multiple Domains, and Trust Relationships</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.overview.kdc">#</a></h3></div></div></div><p>
    One service of the Kerberos KDC that is not easily distributed is
    the handling of updates, such as password changes and new user
    creation. These much happen at a single master KDC.
   </p><p>
    These updates are not likely to happen with such frequency that any
    significant load will be generated, but availability could be an
    issue. It can be annoying if you want to create a new user or change
    a password, and the master KDC on the other side of the world is
    temporarily unavailable.
   </p><p>
    When an organization is geographically distributed and has a policy
    of handling administration tasks locally at each site, it can be
    beneficial to create multiple Kerberos domains, one for each
    administrative center. Each domain would then have its own master
    KDC which would be geographically local. Users in one domain can
    still get access to resources in another domain by setting up trust
    relationships between domains.
   </p><p>
    The easiest arrangement for multiple domains is to have a global
    domain (e.g. EXAMPLE.COM) and various local domains (e.g.
    ASIA.EXAMPLE.COM, EUROPE.EXAMPLE.COM, etc). If the global domain is
    configured to trust each local domain, and each local domain is
    configured to trust the global domain, then fully transitive trust
    is available between any pair of domains, and any principal can
    establish a secure connection with any service. Ensuring
    appropriate access rights to resources, for example files, provided
    by that service will be dependent on the user name lookup service
    used, and the functionality of the NFS file server, and is beyond
    the scope of this document.
   </p></div></div><div class="sect1 " id="sec.security.kerberos.info"><div class="titlepage"><div><div><h2 class="title" id="sec.security.kerberos.info"><span class="number">6.8 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.kerberos.info">#</a></h2></div></div></div><p>
   The official site of MIT Kerberos is
   <a class="link" href="http://web.mit.edu/kerberos" target="_blank">http://web.mit.edu/kerberos</a>. There, find links to
   any other relevant resource concerning Kerberos, including Kerberos
   installation, user, and administration guides.
  </p><p>
   The book <span class="emphasis"><em>Kerberos—A Network Authentication
   System</em></span> by Brian Tung (ISBN 0-201-37924-4) offers extensive
   information.
  </p></div></div><div class="chapter " id="cha.security.ad"><div class="titlepage"><div><div><h2 class="title"><span class="number">7 </span><span class="name">Active Directory Support</span> <a title="Permalink" class="permalink" href="#cha.security.ad">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_ad_support.xml</li><li><span class="ds-label">ID: </span>cha.security.ad</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.ad.integrate"><span class="number">7.1 </span><span class="name">Integrating Linux and Active Directory Environments</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.background"><span class="number">7.2 </span><span class="name">Background Information for Linux Active Directory Support</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.config"><span class="number">7.3 </span><span class="name">Configuring a Linux Client for Active Directory</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.login"><span class="number">7.4 </span><span class="name">Logging In to an Active Directory Domain</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ad.passwd"><span class="number">7.5 </span><span class="name">Changing Passwords</span></a></span></dt></dl></div></div><p>
  Active Directory* (AD) is a directory-service based on LDAP, Kerberos, and
  other services. It is used by Microsoft* Windows* to manage
  resources, services, and people. In a Microsoft Windows network, Active Directory provides
  information about these objects, restricts access to them, and enforces
  policies.
  <span class="productname"><span class="phrase">openSUSE® Leap</span></span> lets you join existing Active Directory domains and integrate your
  Linux machine into a Windows environment.
 </p><div class="sect1 " id="sec.security.ad.integrate"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ad.integrate"><span class="number">7.1 </span><span class="name">Integrating Linux and Active Directory Environments</span> <a title="Permalink" class="permalink" href="#sec.security.ad.integrate">#</a></h2></div></div></div><p>
   With a Linux client (configured as an Active Directory client) that is
   joined to an existing Active Directory domain, benefit from various
   features not available on a pure <span class="productname"><span class="phrase">openSUSE Leap</span></span> Linux client:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069890736"><span class="term ">Browsing Shared Files and Directories with SMB</span></dt><dd><p>
      GNOME Files (previously called Nautilus) supports browsing shared resources
      through SMB.
     </p></dd><dt id="idm140712069888816"><span class="term ">Sharing Files and Directories with SMB</span></dt><dd><p>
      GNOME Files supports sharing directories and files as in Windows.
     </p></dd><dt id="idm140712069886992"><span class="term ">Accessing and Manipulating User Data on the Windows Server</span></dt><dd><p>
      Through GNOME Files, users can access their Windows user data and
      can edit, create, and delete files and directories on the Windows
      server. Users can access their data without having to enter their
      password multiple times.
     </p></dd><dt id="idm140712069884912"><span class="term ">Offline Authentication</span></dt><dd><p>
      Users can log in and access their local data on the Linux
      machine even if they are offline or the Active Directory server is unavailable for
      other reasons.
     </p></dd><dt id="idm140712069882960"><span class="term ">Windows Password Change</span></dt><dd><p>
      This port of Active Directory support in Linux enforces corporate password policies
      stored in Active Directory. The display managers and console support
      password change messages and accept your input. You can even use the
      Linux <code class="command">passwd</code> command to set Windows passwords.
     </p></dd><dt id="idm140712069880448"><span class="term ">Single-Sign-On through Kerberized Applications</span></dt><dd><p>
      
      Many desktop applications are Kerberos-enabled
      (<span class="emphasis"><em>kerberized</em></span>), which means they can transparently
      handle authentication for the user without the need for password
      reentry at Web servers, proxies, groupware applications, or other
      locations.
     </p></dd></dl></div><div id="idm140712069877296" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Managing Unix Attributes from Windows Server* 2016 and Later</h6><p>
    In Windows Server 2016 and later, Microsoft has removed the role
    <span class="emphasis"><em>IDMU/NIS Server</em></span> and along with it the
    <span class="emphasis"><em>Unix Attributes</em></span> plug-in for the
    <span class="emphasis"><em>Active Directory Users and Computers</em></span> MMC snap-in.
   </p><p>
    However, Unix attributes can still be managed manually when
    <span class="guimenu">Advanced Options</span> are enabled in the
    <span class="emphasis"><em>Active Directory Users and Computers</em></span> MMC snap-in.
    For more information, see
    <a class="link" href="https://blogs.technet.microsoft.com/activedirectoryua/2016/02/09/identity-management-for-unix-idmu-is-deprecated-in-windows-server/" target="_blank">https://blogs.technet.microsoft.com/activedirectoryua/2016/02/09/identity-management-for-unix-idmu-is-deprecated-in-windows-server/</a>.
   </p><p>
    Alternatively, use the method described in
    <a class="xref" href="#pro.security.ad.join.sssd" title="Joining an Active Directory Domain Using User Logon Management">Procedure 7.1, “
     Joining an Active Directory Domain Using <span class="guimenu">User Logon Management</span>
    ”</a> to complete
    attributes on the client side (in particular, see
    <a class="xref" href="#st.security.sssd_home_dir" title="Step 6.c">Step 6.c</a>).
   </p></div><p>
   The following section contains technical background for most of the
   previously named features.
   <span class="phrase">For more information about file and
   printer sharing using Active Directory, see <span class="intraxref">Book “<em class="citetitle ">GNOME User Guide</em>”</span>.</span>
  </p></div><div class="sect1 " id="sec.security.ad.background"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ad.background"><span class="number">7.2 </span><span class="name">Background Information for Linux Active Directory Support</span> <a title="Permalink" class="permalink" href="#sec.security.ad.background">#</a></h2></div></div></div><p>
   Many system components need to interact flawlessly to integrate
   a Linux client into an existing Windows Active Directory domain. The following sections
   focus on the underlying processes of the key events in Active Directory server and
   client interaction.
  </p><p>
   To communicate with the directory service, the client needs to share at
   least two protocols with the server:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069865840"><span class="term ">LDAP</span></dt><dd><p>
      LDAP is a protocol optimized for managing directory information. A
      Windows domain controller with Active Directory can use the LDAP protocol to
      exchange directory information with the clients. To learn more about
      LDAP in general and about the open source port of it, OpenLDAP, refer
      to <a class="xref" href="#cha.security.ldap" title="Chapter 5. LDAP—A Directory Service">Chapter 5, <em>LDAP—A Directory Service</em></a>.
     </p></dd><dt id="idm140712069863184"><span class="term ">Kerberos</span></dt><dd><p> Kerberos is a third-party trusted authentication service.
            All its clients trust Kerberos's authorization of another
            client's identity, enabling kerberized single-sign-on (SSO)
            solutions. Windows supports a Kerberos implementation,
            making Kerberos SSO possible even with Linux clients. To
            learn more about Kerberos in Linux, refer to <a class="xref" href="#cha.security.kerberos" title="Chapter 6. Network Authentication with Kerberos">Chapter 6, <em>Network Authentication with Kerberos</em></a>. </p></dd></dl></div><p>
   Depending on which YaST module you use to set up Kerberos authentication,
   different client components process account and authentication data:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069859408"><span class="term ">Solutions Based on SSSD</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
        The <code class="systemitem">sssd</code> daemon is the
        central part of this solution. It handles all communication with the
        Active Directory server.
       </p></li><li class="listitem "><p>
        To gather name service information,
        <code class="systemitem">sssd_nss</code> is used.
       </p></li><li class="listitem "><p>
        To authenticate users, the
        <code class="systemitem">pam_sss</code> module for PAM
        is used. The creation of user homes for the Active Directory users on the Linux
        client is handled by <code class="filename">pam_mkhomedir</code>.
       </p><p>
        For more information about PAM, see <a class="xref" href="#cha.pam" title="Chapter 2. Authentication with PAM">Chapter 2, <em>Authentication with PAM</em></a>.
       </p></li></ul></div></dd><dt id="idm140712069850992"><span class="term ">Solution Based On Winbind (Samba)</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
        The <code class="systemitem">winbindd</code> daemon is the
        central part of this solution. It handles all communication with the
        Active Directory server.
       </p></li><li class="listitem "><p>
        To gather name service information,
        <code class="systemitem">nss_winbind</code> is used.
       </p></li><li class="listitem "><p>
        To authenticate users, the
        <code class="systemitem">pam_winbind</code> module for PAM
        is used. The creation of user homes for the Active Directory users on the Linux
        client is handled by <code class="filename">pam_mkhomedir</code>.
       </p><p>
        For more information about PAM, see <a class="xref" href="#cha.pam" title="Chapter 2. Authentication with PAM">Chapter 2, <em>Authentication with PAM</em></a>.
       </p></li></ul></div><p>
      <a class="xref" href="#fig.ad.schema" title="Schema of Winbind-based Active Directory Authentication">Figure 7.1, “Schema of Winbind-based Active Directory Authentication”</a> highlights the most prominent
      components of Winbind-based Active Directory authentication.
     </p><div class="figure" id="fig.ad.schema"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/sled10_ad_schema.png"><img src="images/sled10_ad_schema.png" width="" alt="Schema of Winbind-based Active Directory Authentication" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.1: </span><span class="name">Schema of Winbind-based Active Directory Authentication </span><a title="Permalink" class="permalink" href="#fig.ad.schema">#</a></h6></div></div></dd></dl></div><p>
   Applications that are PAM-aware, like the login routines and the GNOME
   display manager, interact with the PAM and NSS layer to authenticate
   against the Windows server. Applications supporting Kerberos
   authentication (such as file managers, Web browsers, or e-mail clients)
   use the Kerberos credential cache to access user's Kerberos tickets,
   making them part of the SSO framework.
  </p><div class="sect2 " id="sec.security.ad.background.domain_join"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.background.domain_join"><span class="number">7.2.1 </span><span class="name">Domain Join</span> <a title="Permalink" class="permalink" href="#sec.security.ad.background.domain_join">#</a></h3></div></div></div><p>
    During domain join, the server and the client establish a secure
    relation. On the client, the following tasks need to be performed to
    join the existing LDAP and Kerberos SSO environment provided by the
    Windows domain controller. The entire join process is handled by the
    YaST Domain Membership module, which can be run during installation
    or in the installed system:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      The Windows domain controller providing both LDAP and KDC (Key
      Distribution Center) services is located.
     </p></li><li class="step "><p>
      A machine account for the joining client is created in the directory
      service.
     </p></li><li class="step "><p>
      An initial ticket granting ticket (TGT) is obtained for the client and
      stored in its local Kerberos credential cache. The client needs this
      TGT to get further tickets allowing it to contact other services, like
      contacting the directory server for LDAP queries.
     </p></li><li class="step "><p>
      NSS and PAM configurations are adjusted to enable the client to
      authenticate against the domain controller.
     </p></li></ol></div></div><p>
    During client boot, the winbind daemon is started and retrieves the
    initial Kerberos ticket for the machine account. winbindd automatically
    refreshes the machine's ticket to keep it valid. To keep track of the
    current account policies, winbindd periodically queries the domain
    controller.
   </p></div><div class="sect2 " id="sec.security.ad.background.logon"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.background.logon"><span class="number">7.2.2 </span><span class="name">Domain Login and User Homes</span> <a title="Permalink" class="permalink" href="#sec.security.ad.background.logon">#</a></h3></div></div></div><p>
    The login manager of GNOME (GDM) has been extended to allow the handling
    of Active Directory domain login. Users can choose to log in to the primary domain the
    machine has joined or to one of the trusted domains with which the
    domain controller of the primary domain has established a trust
    relationship.
   </p><p>
    User authentication is mediated by several PAM modules as described
    in <a class="xref" href="#sec.security.ad.background" title="7.2. Background Information for Linux Active Directory Support">Section 7.2, “Background Information for Linux Active Directory Support”</a>. If there are errors, the
    error codes are translated into user-readable error messages that PAM
    gives at login through any of the supported methods (GDM, console, and
    SSH):
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069824096"><span class="term "><code class="literal">Password has expired</code>
     </span></dt><dd><p>
       The user sees a message stating that the password has expired and
       needs to be changed. The system prompts for a new password and
       informs the user if the new password does not comply with corporate
       password policies (for example the password is too short, too simple,
       or already in the history). If a user's password change fails, the
       reason is shown and a new password prompt is given.
      </p></dd><dt id="idm140712069821600"><span class="term "><code class="literal">Account disabled</code>
     </span></dt><dd><p>
       The user sees an error message stating that the account has been
       disabled and to contact the system administrator.
      </p></dd><dt id="idm140712069819392"><span class="term "><code class="literal">Account locked out</code>
     </span></dt><dd><p>
       The user sees an error message stating that the account has been
       locked and to contact the system administrator.
      </p></dd><dt id="idm140712069817200"><span class="term "><code class="literal">Password has to be changed</code>
     </span></dt><dd><p>
       The user can log in but receives a warning that the password needs to
       be changed soon. This warning is sent three days before that password
       expires. After expiration, the user cannot log in.
      </p></dd><dt id="idm140712069814896"><span class="term "><code class="literal">Invalid workstation</code>
     </span></dt><dd><p>
       When a user is restricted to specific workstations and the current
       <span class="productname"><span class="phrase">openSUSE Leap</span></span> machine is not among them, a message appears that
       this user cannot log in from this workstation.
      </p></dd><dt id="idm140712069811536"><span class="term "><code class="literal">Invalid logon hours</code>
     </span></dt><dd><p>
       When a user is only allowed to log in during working hours and tries
       to log in outside working hours, a message informs the user that
       logging in is not possible at that time.
      </p></dd><dt id="idm140712069809264"><span class="term "><code class="literal">Account expired</code>
     </span></dt><dd><p>
       An administrator can set an expiration time for a specific user
       account. If that user tries to log in after expiration, the user gets
       a message that the account has expired and cannot be used to log in.
      </p></dd></dl></div><p>
    During a successful authentication, the client
    acquires a ticket granting ticket (TGT) from the Kerberos server of
    Active Directory and stores it in the user's credential cache. It also
    renews the TGT in the background, requiring no user interaction.
   </p><p>
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> supports local home directories for Active Directory users. If
    configured through YaST as described in
    <a class="xref" href="#sec.security.ad.config" title="7.3. Configuring a Linux Client for Active Directory">Section 7.3, “Configuring a Linux Client for Active Directory”</a>, user home directories are
    created when a Windows/Active Directory user first logs in to the Linux client. These
    home directories look and feel identical to standard Linux user home
    directories and work independently of the Active Directory Domain Controller.
   </p><p>
    Using a
    local user home, it is possible to access a user's data on this machine
    (even when the Active Directory server is disconnected) as long as the Linux client
    has been configured to perform offline authentication.
   </p></div><div class="sect2 " id="sec.security.ad.background.offline"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.background.offline"><span class="number">7.2.3 </span><span class="name">Offline Service and Policy Support</span> <a title="Permalink" class="permalink" href="#sec.security.ad.background.offline">#</a></h3></div></div></div><p>
    Users in a corporate environment must have the ability to become roaming
    users (for example, to switch networks or even work disconnected for
    some time). To enable users to log in to a disconnected machine,
    extensive caching was integrated into the winbind daemon. The winbind
    daemon enforces password policies even in the offline state. It tracks
    the number of failed login attempts and reacts according to the policies
    configured in Active Directory. Offline support is disabled by default
    and must be explicitly enabled in the YaST Domain Membership
    module.
   </p><p>
    When the domain controller has become unavailable, the user can still
    access network resources (other than the Active Directory server itself) with valid
    Kerberos tickets that have been acquired before losing the connection
    (as in Windows). Password changes cannot be processed unless the domain
    controller is online. While disconnected from the Active Directory server, a user
    cannot access any data stored on this server. When a workstation has
    become disconnected from the network entirely and connects to the
    corporate network again later, <span class="productname"><span class="phrase">openSUSE Leap</span></span> acquires a new Kerberos
    ticket when the user has locked and unlocked the desktop (for
    example, using a desktop screen saver).
   </p></div></div><div class="sect1 " id="sec.security.ad.config"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ad.config"><span class="number">7.3 </span><span class="name">Configuring a Linux Client for Active Directory</span> <a title="Permalink" class="permalink" href="#sec.security.ad.config">#</a></h2></div></div></div><p>
   Before your client can join an Active Directory domain, some adjustments must be made
   to your network setup to ensure the flawless interaction of client and
   server.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069795872"><span class="term ">DNS</span></dt><dd><p>
      Configure your client machine to use a DNS server that can forward DNS
      requests to the Active Directory DNS server. Alternatively, configure your machine
      to use the Active Directory DNS server as the name service data source.
     </p></dd><dt id="idm140712069793840"><span class="term ">NTP</span></dt><dd><p>
      To succeed with Kerberos authentication, the client must have its time
      set accurately. It is highly recommended to use a central NTP time
      server for this purpose (this can be also the NTP server running on
      your Active Directory domain controller). If the clock skew between
      your Linux host and the domain controller exceeds a certain limit,
      Kerberos authentication fails and the client is logged in using the
      weaker NTLM (NT LAN Manager) authentication. For more details about
      using Active Directory for time synchronization, see
      <a class="xref" href="#proc.ad.join" title="Joining an Active Directory Domain Using Windows Domain Membership">Procedure 7.2, “
    Joining an Active Directory Domain Using <span class="guimenu">Windows Domain Membership</span>
   ”</a>.
     </p></dd><dt id="idm140712069790912"><span class="term ">Firewall</span></dt><dd><p>
      To browse your network neighborhood, either disable the firewall
      entirely or mark the interface used for browsing as part of the
      internal zone.
     </p><p>
      
      To change the firewall settings on your client, log in as
      <code class="systemitem">root</code> and start the YaST firewall module. Select
      <span class="guimenu">Interfaces</span>. Select your network interface from the
      list of interfaces and click <span class="guimenu">Change</span>. Select
      <span class="guimenu">Internal Zone</span> and apply your settings with
      <span class="guimenu">OK</span>. Leave the firewall settings with <span class="guimenu">Next</span> › <span class="guimenu">Finish</span>. To
      disable the firewall, check the <span class="guimenu">Disable Firewall Automatic
      Starting</span> option, and leave the firewall module with
      <span class="guimenu">Next</span> › <span class="guimenu">Finish</span>.
     </p></dd><dt id="idm140712069782112"><span class="term ">Active Directory Account</span></dt><dd><p>
      You cannot log in to an Active Directory domain unless the Active Directory administrator has
      provided you with a valid user account for that domain. Use the Active Directory
      user name and password to log in to the Active Directory domain from your Linux
      client.
     </p></dd></dl></div><div class="sect2 " id="sec.security.ad.configure.choose"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.configure.choose"><span class="number">7.3.1 </span><span class="name">
    Choosing Which YaST Module to Use for Connecting to Active Directory
   </span> <a title="Permalink" class="permalink" href="#sec.security.ad.configure.choose">#</a></h3></div></div></div><p>
    YaST contains multiple modules that allow connecting to an Active Directory:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">User Logon Management</span>. </span>
    Use both an identity service (usually LDAP) and a user authentication
    service (usually Kerberos). This option is based on SSSD and in the
    majority of cases is best suited for joining Active Directory domains.
   </p><p>
   This module is described in
   <a class="xref" href="#sec.security.ad.sssd" title="7.3.2.  Joining Active Directory Using User Logon Management">Section 7.3.2, “
    Joining Active Directory Using
    <span class="guimenu">User Logon Management</span>
   ”</a>.
  </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Windows Domain Membership</span>. </span>
    Join an Active Directory (which entails use of Kerberos and LDAP). This option is
    based on <code class="command">winbind</code> and is best suited for joining an
    Active Directory domain if support for NTLM or cross-forest trusts is necessary.
   </p><p>
   This module is described in
   <a class="xref" href="#sec.security.ad.winbind" title="7.3.3.  Joining Active Directory Using Windows Domain Membership">Section 7.3.3, “
    Joining Active Directory Using
    <span class="guimenu">Windows Domain Membership</span>
   ”</a>.
  </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">LDAP and Kerberos Authentication</span>. </span>
    Allows setting up LDAP identities and Kerberos authentication
    independently from each other and provides fewer options. While this
    module also uses SSSD, it is not as well suited for connecting to Active Directory
    as the previous two options.
   </p><p>
   This module is described in:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     LDAP: <a class="xref" href="#sec.security.ldap.yast.client" title="5.3. Configuring an LDAP Client with YaST">Section 5.3, “Configuring an LDAP Client with YaST”</a>
    </p></li><li class="listitem "><p>
     Kerberos: <a class="xref" href="#sec.security.kerberos.yast.client" title="6.6. Setting up Kerberos using LDAP and Kerberos Client">Section 6.6, “Setting up Kerberos using <span class="guimenu">LDAP and Kerberos Client</span>”</a>
    </p></li></ul></div></li></ul></div></div><div class="sect2 " id="sec.security.ad.sssd"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.sssd"><span class="number">7.3.2 </span><span class="name">
    Joining Active Directory Using
    <span class="guimenu">User Logon Management</span>
   </span> <a title="Permalink" class="permalink" href="#sec.security.ad.sssd">#</a></h3></div></div></div><p>
    The YaST module <span class="guimenu">User Logon Management</span> supports
    authentication at an Active Directory. Additionally, it also supports the following
    related authentication and identification providers:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069760576"><span class="term ">Identification Providers</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Delegate to third-party software library</span>. </span>
          Support for legacy NSS providers via a proxy.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">FreeIPA</span>. </span>
          FreeIPA and Red Hat Enterprise Identity Management provider.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Generic directory service (LDAP)</span>. </span>
         An LDAP provider. For more information about configuring LDAP, see
         <code class="command">man 5 sssd-ldap</code>.
        </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Local SSSD file database</span>. </span>
          An SSSD-internal provider for local users.
         </p></li></ul></div></dd><dt id="idm140712069750352"><span class="term ">Authentication Providers</span></dt><dd><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Delegate to third-party software library</span>. </span>
          Relay authentication to another PAM target via a proxy.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">FreeIPA</span>. </span>
          FreeIPA and Red Hat Enterprise Identity Management provider.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Generic Kerberos service</span>. </span>
          An LDAP provider.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Generic directory service (LDAP)</span>. </span>
          Kerberos authentication.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">Local SSSD file database</span>. </span>
          An SSSD-internal provider for local users.
         </p></li><li class="listitem "><p><span class="formalpara-title"><span class="guimenu">This domain does not provide authentication service</span>. </span>
          Disables authentication explicitly.
         </p></li></ul></div></dd></dl></div><p>
    To join an Active Directory domain using SSSD and the
    <span class="guimenu">User Logon Management</span> module of YaST, proceed as
    follows:
   </p><div class="procedure " id="pro.security.ad.join.sssd"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 7.1: </span><span class="name">
     Joining an Active Directory Domain Using <span class="guimenu">User Logon Management</span>
     </span><a title="Permalink" class="permalink" href="#pro.security.ad.join.sssd">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Open YaST.
     </p></li><li class="step "><p>
      To be able to use DNS auto-discovery later, set up the Active Directory Domain
      Controller (the Active Directory server) as the name server for your client.
     </p><ol type="a" class="substeps "><li class="step "><p>
        In YaST, click <span class="guimenu">Network Settings</span>.
       </p></li><li class="step "><p>
        Select <span class="guimenu">Hostname/DNS</span>, then enter the IP address of
        the Active Directory Domain Controller into the text box <span class="guimenu">Name Server
        1</span>.
       </p><p>
        Save the setting with <span class="guimenu">OK</span>.
       </p></li></ol></li><li class="step "><p>
      From the YaST main window, start the module <span class="guimenu">User Logon
      Management</span>.
     </p><p>
      The module opens with an overview showing different network properties
      of your computer and the authentication method currently in use.
     </p><div class="figure" id="fig.security.logonmanagement"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ad-overview.png"><img src="images/ad-overview.png" width="" alt="Overview window showing the computer name, IP address, and its authentication setting." /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.2: </span><span class="name">Main Window of <span class="guimenu">User Logon Management</span> </span><a title="Permalink" class="permalink" href="#fig.security.logonmanagement">#</a></h6></div></div></li><li class="step "><p>
      To start editing, click <span class="guimenu">Change Settings</span>.
     </p></li><li class="step "><p>
      Now join the domain.
     </p><ol type="a" class="substeps "><li class="step "><p>
        Click <span class="guimenu">Join Domain</span>.
       </p></li><li class="step "><p>
        In the appearing dialog, specify the correct
        <span class="guimenu">Domain name</span>. Then specify the services to use for
        identity data and authentication: Select <span class="guimenu">Microsoft Active
        Directory</span> for both.
       </p><p>
        Ensure that <span class="guimenu">Enable the domain</span> is activated.
       </p><p>
        Click <span class="guimenu">OK</span>.
       </p></li><li class="step "><p><span class="step-optional">(Optional)</span> 
        Usually, you can keep the default settings in the
        following dialog. However, there are reasons to make changes:
       </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title">
           If the Local Host Name Does Not Match the Host Name Set on the
           Domain Controller. </span>
           
           Find out if the host name of your computer matches what the name
           your computer is known as to the Active Directory Domain Controller. In a
           terminal, run the command <code class="command">hostname</code>, then compare
           its output to the configuration of the Active Directory Domain Controller.
          </p><p>
          If the values differ, specify the host name from the Active Directory
          configuration under <span class="guimenu">AD hostname</span>. Otherwise, leave
          the appropriate text box empty.
         </p></li><li class="listitem "><p><span class="formalpara-title">If You Do Not Want to Use DNS Auto-Discovery. </span>
           Specify the <span class="guimenu">Host names of Active Directory
           servers</span> that you want to use. If there are multiple
           Domain Controllers, separate their host names with commas.
          </p></li></ul></div></li><li class="step "><p>
        To continue, click <span class="guimenu">OK</span>.
       </p><p>
        If not all software is installed already, the computer will now
        install missing software. It will then check whether the configured
        Active Directory Domain Controller is available.
       </p></li><li class="step "><p>
        If everything is correct, the following dialog should now show that
        it has discovered an <span class="guimenu">Active Directory Server</span> but
        that you are <span class="guimenu">Not yet enrolled</span>.
       </p><p>
        In the dialog, specify the <span class="guimenu">Username</span> and
        <span class="guimenu">Password</span> of the Active Directory administrator account
        (usually <code class="literal">Administrator</code>).
       </p><p>
        To make sure that the current domain is enabled for Samba, activate
        <span class="guimenu">Overwrite Samba configuration to work with this AD</span>.
       </p><p>
        To enroll, click <span class="guimenu">OK</span>.
       </p><div class="figure" id="fig.security.logonmanagement.enroll"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ad-enroll.png"><img src="images/ad-enroll.png" width="" alt="Enrolling into a Domain" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.3: </span><span class="name">Enrolling into a Domain </span><a title="Permalink" class="permalink" href="#fig.security.logonmanagement.enroll">#</a></h6></div></div></li><li class="step "><p>
        You should now see a message confirming that you have enrolled
        successfully. Finish with <span class="guimenu">OK</span>.
       </p></li></ol></li><li class="step "><p>
      After enrolling, configure the client using the window
      <span class="guimenu">Manage Domain User Logon</span>.
     </p><div class="figure" id="fig.security.logonmanagement.configure"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ad-config.png"><img src="images/ad-config.png" width="" alt="Configuration Window of User Logon Management" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.4: </span><span class="name">Configuration Window of <span class="guimenu">User Logon Management</span> </span><a title="Permalink" class="permalink" href="#fig.security.logonmanagement.configure">#</a></h6></div></div><ol type="a" class="substeps "><li class="step "><p>
        To allow logging in to the computer using login data provided by Active Directory,
        activate <span class="guimenu">Allow Domain User Logon</span>.
       </p></li><li class="step "><p><span class="step-optional">(Optional)</span> 
        Optionally, under <span class="guimenu">Enable domain data source</span>,
        activate additional data sources such as information on which users are
        allowed to use <code class="command">sudo</code> or which network drives are
        available.
       </p></li><li class="step " id="st.security.sssd_home_dir"><p>
        To allow Active Directory users to have home directories, activate
        <span class="guimenu">Create Home Directories</span>. The path for home
        directories can be set in multiple ways—on the client, on
        the server, or both ways:
       </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
          To configure the home directory paths on the Domain Controller, set
          an appropriate value for the attribute
          <code class="literal">UnixHomeDirectory</code> for each user. Additionally,
          make sure that this attribute replicated to the global catalog. For
          information on achieving that under Windows, see
          <a class="link" href="https://support.microsoft.com/en-us/kb/248717" target="_blank">https://support.microsoft.com/en-us/kb/248717</a>.
         </p></li><li class="listitem "><p>
          To configure home directory paths on the client in such a way that
          precedence will be given to the path set on the domain controller,
          use the option <code class="literal">fallback_homedir</code>.
         </p></li><li class="listitem "><p>
          To configure home directory paths on the client in such a way that
          the client setting will override the server setting, use
          <code class="literal">override_homedir</code>.
         </p></li></ul></div><p>
        As settings on the Domain Controller are outside of the scope of this
        documentation, only the configuration of the client-side options will be
        described in the following.
       </p><p>
        From the side bar, select
        <span class="guimenu">Service Options</span> › <span class="guimenu">Name switch</span>, then click
        <span class="guimenu">Extended Options</span>. From that window, select either
        <code class="literal">fallback_homedir</code> or
        <code class="literal">override_homedir</code>, then click <span class="guimenu">Add</span>.
       </p><p>
        Specify a value. To have home directories follow the format
        <code class="filename">/home/<em class="replaceable ">USER_NAME</em></code>, use
        <code class="literal">/home/%u</code>.
        For more information about possible variables, see the man page
        <code class="literal">sssd.conf</code> (<code class="command">man 5 sssd.conf</code>),
        section
        <em class="citetitle ">override_homedir</em>.
       </p><p>
        Click <span class="guimenu">OK</span>.
       </p></li></ol></li><li class="step "><p>
      Save the changes by clicking <span class="guimenu">OK</span>. Then make sure that
      the values displayed now are correct. To leave the dialog, click
      <span class="guimenu">Cancel</span>.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.security.ad.winbind"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.winbind"><span class="number">7.3.3 </span><span class="name">
    Joining Active Directory Using
    <span class="guimenu">Windows Domain Membership</span>
   </span> <a title="Permalink" class="permalink" href="#sec.security.ad.winbind">#</a></h3></div></div></div><p>
    To join an Active Directory domain using <code class="command">winbind</code> and the
    <span class="guimenu">Windows Domain Membership</span> module of YaST, proceed as
    follows:
   </p><div class="procedure " id="proc.ad.join"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 7.2: </span><span class="name">
    Joining an Active Directory Domain Using <span class="guimenu">Windows Domain Membership</span>
    </span><a title="Permalink" class="permalink" href="#proc.ad.join">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Log in as <code class="systemitem">root</code> and start YaST.
    </p></li><li class="step "><p>
     Start <span class="guimenu">Network Services</span> › <span class="guimenu">Windows
     Domain Membership</span>.
    </p></li><li class="step "><p>
     Enter the domain to join at <span class="guimenu">Domain or Workgroup</span> in
     the <span class="guimenu">Windows Domain Membership</span> screen (see
     <a class="xref" href="#fig.ad.smbclient" title="Determining Windows Domain Membership">Figure 7.5, “Determining Windows Domain Membership”</a>). If the DNS settings on your host
     are properly integrated with the Windows DNS server, enter the Active Directory
     domain name in its DNS format
     (<code class="literal">mydomain.mycompany.com</code>). If you enter the short
     name of your domain (also known as the pre–Windows 2000 domain
     name), YaST must rely on NetBIOS name resolution instead of DNS to
     find the correct domain controller.

    </p><div class="figure" id="fig.ad.smbclient"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ad_sambaclient.png"><img src="images/ad_sambaclient.png" width="" alt="Determining Windows Domain Membership" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.5: </span><span class="name">Determining Windows Domain Membership </span><a title="Permalink" class="permalink" href="#fig.ad.smbclient">#</a></h6></div></div></li><li class="step "><p>
     To use the SMB source for Linux authentication, activate
     <span class="guimenu">Also Use SMB Information for Linux Authentication</span>.
    </p></li><li class="step "><p>
     To automatically create a local home directory for Active Directory users on the
     Linux machine, activate <span class="guimenu">Create Home Directory on
     Login</span>.
    </p></li><li class="step "><p>
     Check <span class="guimenu">Offline Authentication</span> to allow your domain
     users to log in even if the Active Directory server is temporarily unavailable, or if
     you do not have a network connection.
    </p></li><li class="step "><p>
     To change the UID and GID ranges for the Samba users and groups, select
     <span class="guimenu">Expert Settings</span>. Let DHCP retrieve
     the WINS server only if you need it. This is the case when some
     machines are resolved only by the WINS system.
    </p></li><li class="step "><p>
     Configure NTP time synchronization for your Active Directory environment by selecting
     <span class="guimenu">NTP Configuration</span> and entering an appropriate server
     name or IP address. This step is obsolete if you have already entered
     the appropriate settings in the stand-alone YaST NTP configuration
     module.
    </p></li><li class="step "><p>
     Click <span class="guimenu">OK</span> and confirm the domain join when prompted
     for it.
    </p></li><li class="step "><p>
     Provide the password for the Windows administrator on the Active Directory server and
     click <span class="guimenu">OK</span> (see <a class="xref" href="#fig.ad.join1" title="Providing Administrator Credentials">Figure 7.6, “Providing Administrator Credentials”</a>).
    </p><div class="figure" id="fig.ad.join1"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/ad_join1.png"><img src="images/ad_join1.png" width="" alt="Providing Administrator Credentials" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 7.6: </span><span class="name">Providing Administrator Credentials </span><a title="Permalink" class="permalink" href="#fig.ad.join1">#</a></h6></div></div></li></ol></div></div><p>
   After you have joined the Active Directory domain, you can log in to it from your
   workstation using the display manager of your desktop or the console.
  </p><div id="idm140712069622112" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Domain Name</h6><p>
    Joining a domain may not succeed if the domain name ends with
    <code class="literal">.local</code>. Names ending in <code class="literal">.local</code>
    cause conflicts with Multicast DNS (MDNS) where
    <code class="literal">.local</code> is reserved for link-local host names.
   </p></div><div id="idm140712069619296" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Only Administrators Can Enroll a Computer</h6><p>
    Only a domain administrator account, such as
    <code class="literal">Administrator</code>, can join <span class="productname"><span class="phrase">openSUSE Leap</span></span> into Active
    Directory.
   </p></div></div><div class="sect2 " id="sec.security.ad.connection"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.connection"><span class="number">7.3.4 </span><span class="name">Checking Active Directory Connection Status</span> <a title="Permalink" class="permalink" href="#sec.security.ad.connection">#</a></h3></div></div></div><p>
    To check whether you are successfully enrolled in an Active Directory domain,
    use the following commands:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      <code class="command">klist</code> shows whether the current user has a valid
      Kerberos ticket.
     </p></li><li class="listitem "><p>
      <code class="command">getent passwd</code> shows published LDAP data for all
      users.
     </p></li></ul></div></div></div><div class="sect1 " id="sec.security.ad.login"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ad.login"><span class="number">7.4 </span><span class="name">Logging In to an Active Directory Domain</span> <a title="Permalink" class="permalink" href="#sec.security.ad.login">#</a></h2></div></div></div><p>
   Provided your machine has been configured to authenticate against Active
   Directory and you have a valid Windows user identity, you can log in to
   your machine using the Active Directory credentials. Login is supported for GNOME, the
   console, SSH, and any other PAM-aware application.
  </p><div id="idm140712069608960" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Offline Authentication</h6><p>
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> supports offline authentication, allowing you to log in
    to your client machine even when it is offline. See
    <a class="xref" href="#sec.security.ad.background.offline" title="7.2.3. Offline Service and Policy Support">Section 7.2.3, “Offline Service and Policy Support”</a> for details.
   </p></div><div class="sect2 " id="sec.security.ad.login.gui"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.login.gui"><span class="number">7.4.1 </span><span class="name">GDM</span> <a title="Permalink" class="permalink" href="#sec.security.ad.login.gui">#</a></h3></div></div></div><p>
    To authenticate a GNOME client machine against an Active Directory server, proceed as
    follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Click <span class="guimenu">Not listed</span>.
     </p></li><li class="step "><p>
      In the text box <span class="guimenu">Username</span>,
      enter the domain name and the Windows user name in this form:
      <code class="literal"><em class="replaceable ">DOMAIN_NAME</em>\<em class="replaceable ">USER_NAME</em></code>.
     </p></li><li class="step "><p>
      Enter your Windows password.
     </p></li></ol></div></div><p>
    If configured to do so, <span class="productname"><span class="phrase">openSUSE Leap</span></span> creates a user home directory
    on the local machine on the first login of each user authenticated via Active Directory.
    This allows you to benefit from the Active Directory support of <span class="productname"><span class="phrase">openSUSE Leap</span></span> while
    still having a fully functional Linux machine at your disposal.
   </p></div><div class="sect2 " id="sec.security.ad.login.console"><div class="titlepage"><div><div><h3 class="title" id="sec.security.ad.login.console"><span class="number">7.4.2 </span><span class="name">Console Login</span> <a title="Permalink" class="permalink" href="#sec.security.ad.login.console">#</a></h3></div></div></div><p>
    Besides logging in to the Active Directory client machine using a graphical front-end,
    you can log in using the text-based console or even remotely using SSH.
   </p><p>
    To log in to your Active Directory client from a console, enter
    <code class="literal"><em class="replaceable ">DOMAIN_NAME</em>\<em class="replaceable ">USER_NAME</em></code>
    at the <code class="literal">login:</code> prompt and provide the password.
   </p><p>
    To remotely log in to your Active Directory client machine using SSH, proceed as
    follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      At the login prompt, enter:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ssh <em class="replaceable ">DOMAIN_NAME</em>\\<em class="replaceable ">USER_NAME</em>@<em class="replaceable ">HOST_NAME</em></pre></div><p>
      The <code class="literal">\</code> domain and login delimiter is escaped with
      another <code class="literal">\</code> sign.
     </p></li><li class="step "><p>
      Provide the user's password.
     </p></li></ol></div></div></div></div><div class="sect1 " id="sec.security.ad.passwd"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ad.passwd"><span class="number">7.5 </span><span class="name">Changing Passwords</span> <a title="Permalink" class="permalink" href="#sec.security.ad.passwd">#</a></h2></div></div></div><p>
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> helps the user choose a suitable new
   password that meets the corporate security policy. The underlying PAM
   module retrieves the current password policy settings from the domain
   controller, informing the user about the specific password quality
   requirements a user account typically has by means of a message on login.
   Like its Windows counterpart, <span class="productname"><span class="phrase">openSUSE Leap</span></span> presents a message
   describing:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     Password history settings
    </p></li><li class="listitem "><p>
     Minimum password length requirements
    </p></li><li class="listitem "><p>
     Minimum password age
    </p></li><li class="listitem "><p>
     Password complexity
    </p></li></ul></div><p>
   The password change process cannot succeed unless all requirements have
   been successfully met. Feedback about the password status is given both
   through the display managers and the console.
  </p><p>
   GDM provides feedback about password expiration and the prompt for new
   passwords in an interactive mode. To change passwords in the display
   managers, provide the password information when prompted.
  </p><p>
   To change your Windows password, you can use the standard Linux utility,
   <code class="command">passwd</code>, instead of having to manipulate this data on
   the server. To change your Windows password, proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Log in at the console.
    </p></li><li class="step "><p>
     Enter <code class="literal">passwd</code>.
    </p></li><li class="step "><p>
     Enter your current password when prompted.
    </p></li><li class="step "><p>
     Enter the new password.
    </p></li><li class="step "><p>
     Reenter the new password for confirmation. If your new password does
     not comply with the policies on the Windows server, this feedback is
     given to you and you are prompted for another password.
    </p></li></ol></div></div><p>
   To change your Windows password from the GNOME desktop, proceed as
   follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Click the <span class="guimenu">Computer</span> icon on the left edge of the
     panel.
    </p></li><li class="step "><p>
     Select <span class="guimenu">Control Center</span>.
    </p></li><li class="step "><p>
     From the <span class="guimenu">Personal</span> section, select
     <span class="guimenu">About Me</span> › <span class="guimenu">Change
     Password</span>.
    </p></li><li class="step "><p>
     Enter your old password.
    </p></li><li class="step "><p>
     Enter and confirm the new password.
    </p></li><li class="step "><p>
     Leave the dialog with <span class="guimenu">Close</span> to apply your settings.
    </p></li></ol></div></div></div></div></div><div class="part" id="part.local_security"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part II </span><span class="name">Local Security </span><a title="Permalink" class="permalink" href="#part.local_security">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.security.yast_security"><span class="number">8 </span><span class="name">Configuring Security Settings with YaST</span></a></span></dt><dd class="toc-abstract"><p>
    The YaST module <span class="guimenu">Security Center and Hardening</span>
    offers a central clearinghouse to configure security-related settings
    for <span class="productname"><span class="phrase">openSUSE Leap</span></span>. Use it to configure security aspects such as
    settings for the login procedure and for password creation, for boot
    permissions, user creation or for default file permissions. Launch it
    from the YaST control center by <span class="guimenu">Security and Users</span> › <span class="guimenu">Security Center and Hardening</span>. The <span class="guimenu">Security Center</span> dialog always
    starts with the <span class="guimenu">Security Overview</span>, and other
    configuration dialogs are available from the right pane.
   </p></dd><dt><span class="chapter"><a href="#cha.security.policykit"><span class="number">9 </span><span class="name">Authorization with PolKit</span></a></span></dt><dd class="toc-abstract"><p>
    PolKit (formerly known as PolicyKit) is an application framework that
    acts as a negotiator between the unprivileged user session and the
    privileged system context. Whenever a process from the user session
    tries to carry out an action in the system context, PolKit is queried.
    Based on its configuration—specified in a so-called
    <span class="quote">“<span class="quote">policy</span>”</span>—the answer could be <span class="quote">“<span class="quote">yes</span>”</span>,
    <span class="quote">“<span class="quote">no</span>”</span>, or <span class="quote">“<span class="quote">needs authentication</span>”</span>. Unlike
    classical privilege authorization programs such as sudo, PolKit does
    not grant <code class="systemitem">root</code> permissions to an entire session, but only to
    the action in question.
   </p></dd><dt><span class="chapter"><a href="#cha.security.acls"><span class="number">10 </span><span class="name">Access Control Lists in Linux</span></a></span></dt><dd class="toc-abstract"><p>
    POSIX ACLs (access control lists) can be used as an expansion of the
    traditional permission concept for file system objects. With ACLs,
    permissions can be defined more flexibly than with the traditional
    permission concept.
   </p></dd><dt><span class="chapter"><a href="#cha.security.cryptofs"><span class="number">11 </span><span class="name">Encrypting Partitions and Files</span></a></span></dt><dd class="toc-abstract"><p>
  Encrypting files, partitions, and entire disks prevents unauthorized access to your data and protects your confidential files and documents.
 </p></dd><dt><span class="chapter"><a href="#cha.certstore"><span class="number">12 </span><span class="name">Certificate Store</span></a></span></dt><dd class="toc-abstract"><p>
    Certificates play an important role in the authentication of companies
    and individuals. Usually certificates are administered by the
    application itself. In some cases, it makes sense to share certificates
    between applications. The certificate store is a common ground for
    Firefox, Evolution, and NetworkManager. This chapter explains some
    details.
   </p></dd><dt><span class="chapter"><a href="#cha.aide"><span class="number">13 </span><span class="name">Intrusion Detection with AIDE</span></a></span></dt><dd class="toc-abstract"><p>
    Securing your systems is a mandatory task for any mission-critical
    system administrator. Because it is impossible to always guarantee that
    the system is not compromised, it is very important to do extra checks
    regularly (for example with
    <code class="systemitem">cron</code>) to ensure that the system
    is still under your control. This is where AIDE, the
    <span class="emphasis"><em>Advanced Intrusion Detection Environment</em></span>, comes
    into play.
   </p></dd></dl></div><div class="chapter " id="cha.security.yast_security"><div class="titlepage"><div><div><h2 class="title"><span class="number">8 </span><span class="name">Configuring Security Settings with YaST</span> <a title="Permalink" class="permalink" href="#cha.security.yast_security">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_yast2_security.xml</li><li><span class="ds-label">ID: </span>cha.security.yast_security</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712069554400">#</a></h6></div><p>
    The YaST module <span class="guimenu">Security Center and Hardening</span>
    offers a central clearinghouse to configure security-related settings
    for <span class="productname"><span class="phrase">openSUSE Leap</span></span>. Use it to configure security aspects such as
    settings for the login procedure and for password creation, for boot
    permissions, user creation or for default file permissions. Launch it
    from the YaST control center by <span class="guimenu">Security and Users</span> › <span class="guimenu">Security Center and Hardening</span>. The <span class="guimenu">Security Center</span> dialog always
    starts with the <span class="guimenu">Security Overview</span>, and other
    configuration dialogs are available from the right pane.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.yast_security.overview"><span class="number">8.1 </span><span class="name"><span class="guimenu">Security Overview</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.predefined_configs"><span class="number">8.2 </span><span class="name"><span class="guimenu">Predefined Security Configurations</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.password"><span class="number">8.3 </span><span class="name"><span class="guimenu">Password Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.boot"><span class="number">8.4 </span><span class="name"><span class="guimenu">Boot Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.login"><span class="number">8.5 </span><span class="name"><span class="guimenu">Login Settings</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.user"><span class="number">8.6 </span><span class="name"><span class="guimenu">User Addition</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_security.misc"><span class="number">8.7 </span><span class="name"><span class="guimenu">Miscellaneous Settings</span></span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.yast_security.overview"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.overview"><span class="number">8.1 </span><span class="name"><span class="guimenu">Security Overview</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.overview">#</a></h2></div></div></div><p>
   The <span class="guimenu">Security Overview</span> displays a comprehensive list of
   the most important security settings for your system. The security status
   of each entry in the list is clearly visible. A green check mark
   indicates a secure setting while a red cross indicates an entry as being
   insecure. Click <span class="guimenu">Help</span> to open an overview of the
   setting and information on how to make it secure. To change a setting,
   click the corresponding link in the Status column. Depending on the
   setting, the following entries are available:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069545680"><span class="term "><span class="guimenu">Enabled</span>/<span class="guimenu">Disabled</span>
    </span></dt><dd><p>
      Click this entry to toggle the status of the setting to either enabled
      or disabled.
     </p></dd><dt id="idm140712069543072"><span class="term "><span class="guimenu">Configure</span>
    </span></dt><dd><p>
      Click this entry to launch another YaST module for configuration.
      You will return to the Security Overview when leaving the module.
     </p></dd><dt id="idm140712069540864"><span class="term "><span class="guimenu">Unknown</span>
    </span></dt><dd><p>
      A setting's status is set to unknown when the associated service is
      not installed. Such a setting does not represent a potential security
      risk.
     </p></dd></dl></div><div class="figure" id="fig.yast_security.overview"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_security_overview_gtk.png"><img src="images/yast2_security_overview_gtk.png" width="" alt="YaST Security Center and Hardening: Security Overview" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 8.1: </span><span class="name">YaST Security Center and Hardening: Security Overview </span><a title="Permalink" class="permalink" href="#fig.yast_security.overview">#</a></h6></div></div></div><div class="sect1 " id="sec.security.yast_security.predefined_configs"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.predefined_configs"><span class="number">8.2 </span><span class="name"><span class="guimenu">Predefined Security Configurations</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.predefined_configs">#</a></h2></div></div></div><p>
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> comes with three <span class="guimenu">Predefined Security
   Configurations</span>. These configurations affect all the settings
   available in the <span class="guimenu">Security Center</span> module. Each
   configuration can be modified to your needs using the dialogs available
   from the right pane changing its state to <span class="guimenu">Custom
   Settings</span>:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069528288"><span class="term "><span class="guimenu">Workstation</span>
    </span></dt><dd><p>
      A configuration for a workstation with any kind of network connection
      (including a connection to the Internet).
     </p></dd><dt id="idm140712069526096"><span class="term "><span class="guimenu">Roaming Device</span>
    </span></dt><dd><p>
      This setting is designed for a laptop or tablet that connects to
      different networks.
     </p></dd><dt id="idm140712069523936"><span class="term "><span class="guimenu">Network Server</span>
    </span></dt><dd><p>
      Security settings designed for a machine providing network services
      such as a Web server, file server, name server, etc. This set provides
      the most secure configuration of the predefined settings.
     </p></dd><dt id="idm140712069521648"><span class="term "><span class="guimenu">Custom Settings</span>
    </span></dt><dd><p>
      A pre-selected <span class="guimenu">Custom Settings</span> (when opening the
      <span class="guimenu">Predefined Security Configurations</span> dialog)
      indicates that one of the predefined sets has been modified. Actively
      choosing this option does not change the current
      configuration—you will need to change it using the
      <span class="guimenu">Security Overview</span>.
     </p></dd></dl></div></div><div class="sect1 " id="sec.security.yast_security.password"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.password"><span class="number">8.3 </span><span class="name"><span class="guimenu">Password Settings</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.password">#</a></h2></div></div></div><p>
   Passwords that are easy to guess are a major security issue. The
   <span class="guimenu">Password Settings</span> dialog provides the means to ensure
   that only secure passwords can be used.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069515056"><span class="term "><span class="guimenu">Check New Passwords</span>
    </span></dt><dd><p>
      By activating this option, a warning will be issued if new passwords
      appear in a dictionary, or if they are proper names (proper nouns).
     </p></dd><dt id="idm140712069512832"><span class="term "><span class="guimenu">Minimum Acceptable Password Length</span>
    </span></dt><dd><p>
      If the user chooses a password with a length shorter than specified
      here, a warning will be issued.
     </p></dd><dt id="idm140712069510688"><span class="term "><span class="guimenu">Number of Passwords to Remember</span>
    </span></dt><dd><p>
      When password expiration is activated (via <span class="guimenu">Password
      Age</span>), this setting stores the given number of a user's
      previous passwords, preventing their reuse.
     </p></dd><dt id="idm140712069508016"><span class="term "><span class="guimenu">Password Encryption Method</span>
    </span></dt><dd><p>
      Choose a password encryption algorithm. Normally there is no need to
      change the default (Blowfish).
     </p></dd><dt id="idm140712069505824"><span class="term "><span class="guimenu">Password Age</span>
    </span></dt><dd><p>
      Activate password expiration by specifying a minimum and a maximum
      time limit (in days). By setting the minimum age to a value greater
      than <code class="literal">0</code> days, you can prevent users from immediately
      changing their passwords again (and in doing so circumventing the
      password expiration). Use the values <code class="literal">0</code> and
      <code class="literal">99999</code> to deactivate password expiration.
     </p></dd><dt id="idm140712069502080"><span class="term "><span class="guimenu">Days Before Password Expires Warning</span>
    </span></dt><dd><p>
      When a password expires, the user receives a warning in advance.
      Specify the number of days prior to the expiration date that the
      warning should be issued.
     </p></dd></dl></div></div><div class="sect1 " id="sec.security.yast_security.boot"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.boot"><span class="number">8.4 </span><span class="name"><span class="guimenu">Boot Settings</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.boot">#</a></h2></div></div></div><p>
   Configure which users can shut down the machine via the
   graphical login manager in this dialog. You can also specify how
   <span class="keycap">Ctrl</span><span class="key-connector">–</span><span class="keycap">Alt</span><span class="key-connector">–</span><span class="keycap">Del</span> will be interpreted and who
   can hibernate the system.
  </p></div><div class="sect1 " id="sec.security.yast_security.login"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.login"><span class="number">8.5 </span><span class="name"><span class="guimenu">Login Settings</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.login">#</a></h2></div></div></div><p>
   This dialog lets you configure security-related login settings:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069493184"><span class="term "><span class="guimenu">Delay after Incorrect Login Attempt</span>
    </span></dt><dd><p>
      To make it difficult to guess a user's password by repeatedly
      logging in, it is recommended to delay the display of the login prompt
      that follows an incorrect login. Specify the value in seconds. Make
      sure that users who have mistyped their passwords do not need to wait
      too long.
     </p></dd><dt id="idm140712069490832"><span class="term "><span class="guimenu">Allow Remote Graphical Login</span>
    </span></dt><dd><p>
      When checked, the graphical login manager (GDM) can be accessed from
      the network. This is a potential security risk.
     </p></dd></dl></div></div><div class="sect1 " id="sec.security.yast_security.user"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.user"><span class="number">8.6 </span><span class="name"><span class="guimenu">User Addition</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.user">#</a></h2></div></div></div><p>
   Set minimum and maximum values for user and group IDs. These default
   settings would rarely need to be changed.
  </p></div><div class="sect1 " id="sec.security.yast_security.misc"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_security.misc"><span class="number">8.7 </span><span class="name"><span class="guimenu">Miscellaneous Settings</span></span> <a title="Permalink" class="permalink" href="#sec.security.yast_security.misc">#</a></h2></div></div></div><p>
   Other security settings that do not fit the above-mentioned categories are
   listed here:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069484064"><span class="term "><span class="guimenu">File Permissions</span>
    </span></dt><dd><p>
      <span class="productname"><span class="phrase">openSUSE Leap</span></span> comes with three predefined sets of file permissions
      for system files. These permission sets define whether a regular user
      may read log files or start certain programs. <span class="guimenu">Easy</span>
      file permissions are suitable for stand-alone machines. These settings
      allow regular users to, for example, read most system files. See the
      file <code class="filename">/etc/permissions.easy</code> for the complete
      configuration. The <span class="guimenu">Secure</span> file permissions are
      designed for multiuser machines with network access. A thorough
      explanation of these settings can be found in
      <code class="filename">/etc/permissions.secure</code>. The
      <span class="guimenu">Paranoid</span> settings are the most restrictive ones and
      should be used with care. See
      <code class="filename">/etc/permissions.paranoid</code> for more information.
     </p></dd><dt id="idm140712069477664"><span class="term "><span class="guimenu">User Launching updatedb</span>
    </span></dt><dd><p>
      The program <code class="command">updatedb</code> scans the system and creates a
      database of all file locations which can be queried with the command
      <code class="command">locate</code>. When <code class="command">updatedb</code> is run as
      user nobody, only world-readable files will be added to the database.
      When run as user <code class="systemitem">root</code>, almost all files (except the ones root
      is not allowed to read) will be added.
     </p></dd><dt id="idm140712069473248"><span class="term "><span class="guimenu">Enable Magic SysRq Keys</span>
    </span></dt><dd><p>
      The magic SysRq key is a key combination that enables you to have some
      control over the system even when it has crashed. The complete
      documentation can be found at <a class="link" href="https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html" target="_blank">https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html</a>.
     </p></dd></dl></div></div></div><div class="chapter " id="cha.security.policykit"><div class="titlepage"><div><div><h2 class="title"><span class="number">9 </span><span class="name">Authorization with PolKit</span> <a title="Permalink" class="permalink" href="#cha.security.policykit">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_policy_kit.xml</li><li><span class="ds-label">ID: </span>cha.security.policykit</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712069467248">#</a></h6></div><p>
    PolKit (formerly known as PolicyKit) is an application framework that
    acts as a negotiator between the unprivileged user session and the
    privileged system context. Whenever a process from the user session
    tries to carry out an action in the system context, PolKit is queried.
    Based on its configuration—specified in a so-called
    <span class="quote">“<span class="quote">policy</span>”</span>—the answer could be <span class="quote">“<span class="quote">yes</span>”</span>,
    <span class="quote">“<span class="quote">no</span>”</span>, or <span class="quote">“<span class="quote">needs authentication</span>”</span>. Unlike
    classical privilege authorization programs such as sudo, PolKit does
    not grant <code class="systemitem">root</code> permissions to an entire session, but only to
    the action in question.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.policykit.oview"><span class="number">9.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.types"><span class="number">9.2 </span><span class="name">Authorization Types</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.query"><span class="number">9.3 </span><span class="name">Querying Privileges</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.change.modify_config"><span class="number">9.4 </span><span class="name">Modifying Configuration Files</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.policykit.change.defaults"><span class="number">9.5 </span><span class="name">Restoring the Default Privileges</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.policykit.oview"><div class="titlepage"><div><div><h2 class="title" id="sec.security.policykit.oview"><span class="number">9.1 </span><span class="name">Conceptual Overview</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.oview">#</a></h2></div></div></div><p>

   PolKit works by limiting specific actions by users, by group, or by
   name. It then defines how those users are allowed to perform this
   action.
  </p><div class="sect2 " id="sec.security.policykit.agents"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.agents"><span class="number">9.1.1 </span><span class="name">Available Authentication Agents</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.agents">#</a></h3></div></div></div><p>
    When a user starts a session (using the graphical environment or on the
    console), each session consists of the
    <span class="emphasis"><em>authority</em></span> and an <span class="emphasis"><em>authentication
    agent</em></span>. The authority is implemented as a service on the
    system message bus, whereas the authentication agent is used to
    authenticate the current user, which started the session. The current
    user needs to prove their authenticity, for example, using a passphrase.
   </p><p>
    Each desktop environment has its own authentication agent. Usually it is
    started automatically, whatever environment you choose.
   </p></div><div class="sect2 " id="sec.security.policykit.structure"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.structure"><span class="number">9.1.2 </span><span class="name">Structure of PolKit</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.structure">#</a></h3></div></div></div><p>
    PolKit's configuration depends on <span class="emphasis"><em>actions</em></span> and
    <span class="emphasis"><em>authorization rules</em></span>:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069453424"><span class="term ">Actions (file extension <code class="filename">*.policy</code>)</span></dt><dd><p>
       Written as XML files and located in
       <code class="filename">/usr/share/polkit-1/actions</code>. Each file defines
       one or more actions, and each action contains descriptions and
       default permissions. Although a system administrator can write their
       own rules, PolKit's files must not be edited.
      </p></dd><dt id="idm140712069450464"><span class="term ">Authorization Rules (file extension <code class="filename">*.rules</code>)</span></dt><dd><p>
       Written as JavaScript files and located in two places:
       <code class="filename">/usr/share/polkit-1/rules.d </code> is used for third
       party packages and <code class="filename">/etc/polkit-1/rules.d</code> for
       local configurations. Each rule file refers to the action specified
       in the action file. A rule determines what restrictions are allowed
       to a subset of users. For example, a rule file could overrule a
       restrictive permission and allow some users to allow it.
      </p></dd></dl></div></div><div class="sect2 " id="sec.security.policykit.oview.commands"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.oview.commands"><span class="number">9.1.3 </span><span class="name">Available Commands</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.oview.commands">#</a></h3></div></div></div><p>
    PolKit contains several commands for specific tasks (see also the
    specific man page for further details):
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069444592"><span class="term "><code class="command">pkaction</code>
     </span></dt><dd><p>
       Get details about a defined action. See
       <a class="xref" href="#sec.security.policykit.query" title="9.3. Querying Privileges">Section 9.3, “Querying Privileges”</a> for more
       information.
      </p></dd><dt id="idm140712069441936"><span class="term "><code class="command">pkcheck</code>
     </span></dt><dd><p>
       Checks whether a process is authorized, specified by either
       <code class="option">--process</code> or <code class="option">--system-bus-name</code>.
      </p></dd><dt id="idm140712069438896"><span class="term "><code class="command">pkexec</code>
     </span></dt><dd><p>
       Allows an authorized user to execute the specific program as another
       user.
      </p></dd><dt id="idm140712069436736"><span class="term "><code class="command">pkttyagent</code>
     </span></dt><dd><p>
       Starts a textual authentication agent. This agent is used if a
       desktop environment does not have its own authentication agent.
      </p></dd></dl></div></div><div class="sect2 " id="sec.security.policykit.oview.authorizations"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.oview.authorizations"><span class="number">9.1.4 </span><span class="name">Available Policies and Supported Applications</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.oview.authorizations">#</a></h3></div></div></div><p>
    At the moment, not all applications requiring privileges use
    PolKit. Find the most important policies available on
    <span class="productname"><span class="phrase">openSUSE® Leap</span></span> below, sorted into the categories where they are
    used.
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069430992"><span class="term ">PulseAudio</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Set scheduling priorities for the PulseAudio daemon</td></tr></table></dd><dt id="idm140712069428720"><span class="term ">CUPS</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Add, remove, edit, enable or disable printers</td></tr></table></dd><dt id="idm140712069426448"><span class="term ">Backup Manager</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Modify schedule</td></tr></table></dd><dt id="idm140712069423936"><span class="term ">GNOME</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Modify system and mandatory values with GConf</td></tr><tr><td>Change the system time</td></tr></table></dd><dt id="idm140712069421216"><span class="term ">libvirt</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Manage and monitor local virtualized systems</td></tr></table></dd><dt id="idm140712069418672"><span class="term ">NetworkManager</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Apply and modify connections</td></tr></table></dd><dt id="idm140712069416144"><span class="term ">PolKit</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Read and change privileges for other users</td></tr><tr><td>Modify defaults</td></tr></table></dd><dt id="idm140712069413424"><span class="term ">PackageKit</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Update and remove packages</td></tr><tr><td>Change and refresh repositories</td></tr><tr><td>Install local files</td></tr><tr><td>Rollback</td></tr><tr><td>Import repository keys</td></tr><tr><td>Accepting EULAs</td></tr><tr><td>Setting the network proxy</td></tr></table></dd><dt id="idm140712069408448"><span class="term ">System</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Wake on LAN</td></tr><tr><td>Mount or unmount fixed, hotpluggable and encrypted
       devices</td></tr><tr><td>Eject and decrypt removable media</td></tr><tr><td>Enable or disable WLAN</td></tr><tr><td>Enable or disable Bluetooth</td></tr><tr><td>Device access</td></tr><tr><td>Stop, suspend, hibernate and restart the system</td></tr><tr><td>Undock a docking station</td></tr><tr><td>Change power-management settings</td></tr></table></dd><dt id="idm140712069402480"><span class="term ">YaST</span></dt><dd><table border="0" summary="Simple list" class="simplelist "><tr><td>Register product</td></tr><tr><td>Change the system time and language</td></tr></table></dd></dl></div></div></div><div class="sect1 " id="sec.security.policykit.types"><div class="titlepage"><div><div><h2 class="title" id="sec.security.policykit.types"><span class="number">9.2 </span><span class="name">Authorization Types</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.types">#</a></h2></div></div></div><p>
   Every time a PolKit-enabled process carries out a privileged operation,
   PolKit is asked whether this process is entitled to do so. PolKit
   answers according to the policy defined for this process. The answers can
   be <code class="literal">yes</code>, <code class="literal">no</code>, or
   <code class="literal">authentication needed</code>. By default, a policy contains
   <code class="literal">implicit</code> privileges, which automatically apply to all
   users. It is also possible to specify <code class="literal">explicit</code>
   privileges which apply to a specific user.
  </p><div class="sect2 " id="sec.security.policykit.policies.implicit"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.policies.implicit"><span class="number">9.2.1 </span><span class="name">Implicit Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.policies.implicit">#</a></h3></div></div></div><p>
    Implicit privileges can be defined for any active and inactive sessions.
    An active session is the one in which you are currently working. It
    becomes inactive when you switch to another console for example. When
    setting implicit privileges to <span class="quote">“<span class="quote">no</span>”</span>, no user is authorized,
    whereas <span class="quote">“<span class="quote">yes</span>”</span> authorizes all users. However, usually
    it is useful to demand authentication.
   </p><p>
    A user can either authorize by authenticating as <code class="systemitem">root</code> or by
    authenticating as self. Both authentication methods exist in four
    variants:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069390624"><span class="term ">Authentication</span></dt><dd><p>
       The user always needs to authenticate.
      </p></dd><dt id="idm140712069388800"><span class="term ">One Shot Authentication</span></dt><dd><p>
       The authentication is bound to the instance of the program currently
       running. After the program is restarted, the user is required to
       authenticate again.
      </p></dd><dt id="idm140712069386848"><span class="term ">Keep Session Authentication</span></dt><dd><p>
       The authentication dialog offers a check button <span class="guimenu">Remember
       authorization for this session</span>. If checked, the
       authentication is valid until the user logs out.
      </p></dd><dt id="idm140712069384448"><span class="term ">Keep Indefinitely Authentication</span></dt><dd><p>
       The authentication dialog offers a check button <span class="guimenu">Remember
       authorization</span>. If checked, the user needs to authenticate
       only once.
      </p></dd></dl></div></div><div class="sect2 " id="sec.security.policykit.policies.explicit"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.policies.explicit"><span class="number">9.2.2 </span><span class="name">Explicit Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.policies.explicit">#</a></h3></div></div></div><p>
    Explicit privileges can be granted to specific users. They can either be
    granted without limitations, or, when using constraints, limited to an
    active session and/or a local console.
   </p><p>
    It is not only possible to grant privileges to a user, a user can also
    be blocked. Blocked users cannot carry out an action
    requiring authorization, even though the default implicit policy allows
    authorization by authentication.
   </p></div><div class="sect2 " id="sec.security.policykit.policies.default"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.policies.default"><span class="number">9.2.3 </span><span class="name">Default Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.policies.default">#</a></h3></div></div></div><p>
    Each application supporting PolKit comes with a default set of implicit
    policies defined by the application's developers. Those policies are the
    so-called <span class="quote">“<span class="quote">upstream defaults</span>”</span>. The privileges defined by
    the upstream defaults are not necessarily the ones that are activated by
    default on SUSE systems. <span class="productname"><span class="phrase">openSUSE Leap</span></span> comes with a predefined
    set of privileges that override the upstream defaults:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069375168"><span class="term "><code class="filename">/etc/polkit-default-privs.standard</code>
     </span></dt><dd><p>
       Defines privileges suitable for most desktop
       systems
      </p></dd><dt id="idm140712069373056"><span class="term "><code class="filename">/etc/polkit-default-privs.restrictive</code>
     </span></dt><dd><p>
       Designed for machines administrated centrally
      </p></dd></dl></div><p>
    To switch between the two sets of default privileges, adjust the value
    of <code class="varname">POLKIT_DEFAULT_PRIVS</code> to either
    <code class="literal">restrictive</code> or <code class="literal">standard</code> in
    <code class="filename">/etc/sysconfig/security</code>. Then run the command
    <code class="command">set_polkit_default_privs</code> as <code class="systemitem">root</code>.
   </p><p>
    Do not modify the two files in the list above. To define your
    own custom set of privileges, use
    <code class="filename">/etc/polkit-default-privs.local</code>. For details, refer
    to
    <a class="xref" href="#sec.security.policykit.change.modify_config.implicit" title="9.4.3. Modifying Configuration Files for Implicit Privileges">Section 9.4.3, “Modifying Configuration Files for Implicit Privileges”</a>.
   </p></div></div><div class="sect1 " id="sec.security.policykit.query"><div class="titlepage"><div><div><h2 class="title" id="sec.security.policykit.query"><span class="number">9.3 </span><span class="name">Querying Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.query">#</a></h2></div></div></div><p>
   To query privileges use the command <code class="command">pkaction</code> included
   in PolKit.
  </p><p>
   PolKit comes with command line tools for changing privileges and
   executing commands as another user (see
   <a class="xref" href="#sec.security.policykit.oview.commands" title="9.1.3. Available Commands">Section 9.1.3, “Available Commands”</a> for a short
   overview). Each existing policy has a speaking, unique name with which it
   can be identified. List all available policies with the command
   <code class="command">pkaction</code>.
  </p><p>
   When invoked with no parameters, the command <code class="command">pkaction</code>
   lists all policies. By adding the
   <code class="option">--show-overrides</code> option, you can list all policies that
   differ from the default values. To reset the privileges for a given
   action to the (upstream) defaults, use the option
   <code class="option">--reset-defaults <em class="replaceable ">ACTION</em></code>.
   See <code class="command">man pkaction</code> for more information.
  </p><p>
   If you want to display the needed authorization for a given policy (for
   example, <code class="literal">org.freedesktop.login1.reboot</code>) use
   <code class="command">pkaction</code> as follows:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>pkaction -v --action-id org.freedesktop.login1.reboot
org.freedesktop.login1.reboot:
  description:       Reboot the system
  message:           Authentication is required to allow rebooting the system
  vendor:            The systemd Project
  vendor_url:        http://www.freedesktop.org/wiki/Software/systemd
  icon:
  implicit any:      auth_admin_keep
  implicit inactive: auth_admin_keep
  implicit active:   yes</pre></div><p>
   The keyword <code class="literal">auth_admin_keep</code> means that users need to
   enter a passphrase.
  </p><div id="idm140712069355200" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Restrictions of <code class="command">pkaction</code> on <span class="productname"><span class="phrase">openSUSE Leap</span></span></h6><p>
    <code class="command">pkaction</code> always operates on the upstream defaults.
    Therefore it cannot be used to list or restore the defaults shipped with
    <span class="productname"><span class="phrase">openSUSE Leap</span></span>. To do so, refer to
    <a class="xref" href="#sec.security.policykit.change.defaults" title="9.5. Restoring the Default Privileges">Section 9.5, “Restoring the Default Privileges”</a>.
   </p></div></div><div class="sect1 " id="sec.security.policykit.change.modify_config"><div class="titlepage"><div><div><h2 class="title" id="sec.security.policykit.change.modify_config"><span class="number">9.4 </span><span class="name">Modifying Configuration Files</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.change.modify_config">#</a></h2></div></div></div><p>
   Adjusting privileges by modifying configuration files is useful when you
   want to deploy the same set of policies to different machines, for
   example to the computers of a specific team. It is possible to change
   implicit and explicit privileges by modifying configuration files.
  </p><div class="sect2 " id="sec.security.policykit.change.modify_config.actions"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.change.modify_config.actions"><span class="number">9.4.1 </span><span class="name">Adding Action Rules</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.change.modify_config.actions">#</a></h3></div></div></div><p>
    The available actions depend on what additional packages you have
    installed on your system. For a quick overview, use
    <code class="command">pkaction</code> to list all defined rules.
   </p><p>
    To get an idea, the following example describes how the command
    <code class="command">gparted</code> (<span class="quote">“<span class="quote">GNOME Partition Editor</span>”</span>)
    is integrated into PolKit.
   </p><p>
    The file
    <code class="filename">/usr/share/polkit-1/actions/org.opensuse.policykit.gparted.policy</code>
    contains the following content:
   </p><div class="verbatim-wrap"><pre class="screen">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1.0/policyconfig.dtd"&gt;
&lt;policyconfig&gt; <span id="co.polkit.actions.policyconfig"></span><span class="callout">1</span>

  &lt;action id="org.opensuse.policykit.gparted"&gt; <span id="co.polkit.actions.action"></span><span class="callout">2</span>
    &lt;message&gt;Authentication is required to run the GParted Partition Editor&lt;/message&gt;
    &lt;icon_name&gt;gparted&lt;/icon_name&gt;
    &lt;defaults&gt; <span id="co.polkit.actions.defaults"></span><span class="callout">3</span>
      &lt;allow_any&gt;auth_admin&lt;/allow_any&gt;
      &lt;allow_inactive&gt;auth_admin&lt;/allow_inactive&gt;
     &lt; allow_active&gt;auth_admin&lt;/allow_active&gt;
    &lt;/defaults&gt;
    &lt;annotate <span id="co.polkit.actions.annotate"></span><span class="callout">4</span>
      key="org.freedesktop.policykit.exec.path"&gt;/usr/sbin/gparted&lt;/annotate&gt;
    &lt;annotate <a class="xref" href="#co.polkit.actions.annotate"><span class="callout">4</span></a>
      key="org.freedesktop.policykit.exec.allow_gui"&gt;true&lt;/annotate&gt;
  &lt;/action&gt;

&lt;/policyconfig&gt;</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.polkit.actions.policyconfig"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
      Root element of the policy file.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.polkit.actions.action"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
      Contains one single action.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.polkit.actions.defaults"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
      The <code class="literal">defaults</code> element contains several permissions
      used in remote sessions like SSH, VNC (element
      <code class="literal">allow_inactive</code>), when logged directly into the
      machine on a TTY or X display (element
      <code class="literal">allow_active</code>), or for both (element
      <code class="literal">allow_any</code>). The value <code class="literal">auth_admin</code>
      indicates authentication is required as an administrative user.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.polkit.actions.annotate"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
      The <code class="literal">annotate</code> element contains specific information
      regarding how PolKit performs an action. In this case, it contains
      the path to the executable and states whether a GUI is allowed to open
      a X display.
     </p></td></tr></table></div><p>
    To add your own policy, create a <code class="filename">.policy</code> file with
    the structure above, add the appropriate value into the
    <code class="literal">id</code> attribute, and define the default permissions.
   </p></div><div class="sect2 " id="sec.security.policykit.change.modify_config.authrules"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.change.modify_config.authrules"><span class="number">9.4.2 </span><span class="name">Adding Authorization Rules</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.change.modify_config.authrules">#</a></h3></div></div></div><p>
    Your own authorization rules overrule the default settings. To add your
    own settings, store your files under
    <code class="filename">/etc/polkit-1/rules.d/</code>.
   </p><p>
    The files in this directory start with a two-digit number, followed by a
    descriptive name, and end with <code class="filename">.rules</code>. Functions
    inside these files are executed in the order they have been sorted in.
    For example, <code class="filename">00-foo.rules</code> is sorted (and hence
    executed) before <code class="filename">60-bar.rules</code> or even
    <code class="filename">90-default-privs.rules</code>.
   </p><p>
    Inside the file, the script checks for the specified action ID, which is
    defined in the <code class="filename">.policy</code> file. For example, if you
    want to allow the command <code class="command">gparted</code> to be executed by
    any member of the <code class="systemitem">admin</code>
    group, check for the action ID
    <code class="literal">org.opensuse.policykit.gparted</code>:
   </p><div class="verbatim-wrap"><pre class="screen">/* Allow users in admin group to run GParted without authentication */
polkit.addRule(function(action, subject) {
    if (action.id == "org.opensuse.policykit.gparted" &amp;&amp;
        subject.isInGroup("admin")) {
        return polkit.Result.YES;
    }
});</pre></div><p>
    Find the description of all classes and methods of the functions in the
    PolKit API at
    <a class="link" href="http://www.freedesktop.org/software/polkit/docs/latest/ref-api.html" target="_blank">http://www.freedesktop.org/software/polkit/docs/latest/ref-api.html</a>.
   </p></div><div class="sect2 " id="sec.security.policykit.change.modify_config.implicit"><div class="titlepage"><div><div><h3 class="title" id="sec.security.policykit.change.modify_config.implicit"><span class="number">9.4.3 </span><span class="name">Modifying Configuration Files for Implicit Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.change.modify_config.implicit">#</a></h3></div></div></div><p>
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> ships with two sets of default authorizations, located
    in <code class="filename">/etc/polkit-default-privs.standard</code> and
    <code class="filename">/etc/polkit-default-privs.restrictive</code>. For more
    information, refer to
    <a class="xref" href="#sec.security.policykit.policies.default" title="9.2.3. Default Privileges">Section 9.2.3, “Default Privileges”</a>.
   </p><p>
    Custom privileges are defined in
    <code class="filename">/etc/polkit-default-privs.local</code>. Privileges defined
    here will always take precedence over the ones defined in the other
    configuration files. To define your custom set of privileges,
    do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Open <code class="filename">/etc/polkit-default-privs.local</code>. To define a
      privilege, add a line for each policy with the following format:
     </p><div class="verbatim-wrap"><pre class="screen"><em class="replaceable ">&lt;privilege_identifier&gt;</em>     <em class="replaceable ">&lt;any session&gt;</em>:<em class="replaceable ">&lt;inactive session&gt;</em>:<em class="replaceable ">&lt;active session&gt;</em></pre></div><p>
      For example:
     </p><div class="verbatim-wrap"><pre class="screen">org.freedesktop.policykit.modify-defaults     auth_admin_keep_always</pre></div><p>
      The following values are valid for the
      <em class="replaceable ">SESSION</em> placeholders:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069308272"><span class="term "><code class="literal">yes</code>
       </span></dt><dd><p>
         grant privilege
        </p></dd><dt id="idm140712069306176"><span class="term "><code class="literal">no</code>
       </span></dt><dd><p>
         block
        </p></dd><dt id="idm140712069304080"><span class="term "><code class="literal">auth_self</code>
       </span></dt><dd><p>
         user needs to authenticate with own password every time the
         privilege is requested
        </p></dd><dt id="idm140712069301904"><span class="term "><code class="literal">auth_self_keep_session</code>
       </span></dt><dd><p>
         user needs to authenticate with own password once per session,
         privilege is granted for the whole session
        </p></dd><dt id="idm140712069299712"><span class="term "><code class="literal">auth_self_keep_always</code>
       </span></dt><dd><p>
         user needs to authenticate with own password once, privilege is
         granted for the current and for future sessions
        </p></dd><dt id="idm140712069297504"><span class="term "><code class="literal">auth_admin</code>
       </span></dt><dd><p>
         user needs to authenticate with <code class="systemitem">root</code> password every time
         the privilege is requested
        </p></dd><dt id="idm140712069294624"><span class="term "><code class="literal">auth_admin_keep_session</code>
       </span></dt><dd><p>
         user needs to authenticate with <code class="systemitem">root</code> password once per
         session, privilege is granted for the whole session
        </p></dd><dt id="idm140712069291712"><span class="term "><code class="literal">auth_admin_keep_always</code>
       </span></dt><dd><p>
         user needs to authenticate with <code class="systemitem">root</code> password once,
         privilege is granted for the current and for future sessions
        </p></dd></dl></div></li><li class="step "><p>
      Run as <code class="systemitem">root</code> for changes to take effect:
     </p><div class="verbatim-wrap"><pre class="screen"># /sbin/set_polkit_default_privs</pre></div></li><li class="step "><p>
      Optionally check the list of all privilege identifiers with the
      command <code class="command">pkaction</code>.
     </p></li></ol></div></div></div></div><div class="sect1 " id="sec.security.policykit.change.defaults"><div class="titlepage"><div><div><h2 class="title" id="sec.security.policykit.change.defaults"><span class="number">9.5 </span><span class="name">Restoring the Default Privileges</span> <a title="Permalink" class="permalink" href="#sec.security.policykit.change.defaults">#</a></h2></div></div></div><p>
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> comes with a predefined set of privileges that is
   activated by default and thus overrides the upstream defaults. For
   details, refer to
   <a class="xref" href="#sec.security.policykit.policies.default" title="9.2.3. Default Privileges">Section 9.2.3, “Default Privileges”</a>.
  </p><p>
   Since the graphical PolKit tools and the command line tools always
   operate on the upstream defaults, <span class="productname"><span class="phrase">openSUSE Leap</span></span> includes an additional
   command-line tool, <code class="command">set_polkit_default_privs</code>. It resets
   privileges to the values defined in
   <code class="filename">/etc/polkit-default-privs.*</code>. However, the command
   <code class="command">set_polkit_default_privs</code> will only reset policies that
   are set to the upstream defaults.
  </p><div class="procedure " id="idm140712069277824"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 9.1: </span><span class="name">Restoring the <span class="productname"><span class="phrase">openSUSE Leap</span></span> Defaults </span><a title="Permalink" class="permalink" href="#idm140712069277824">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Make sure <code class="filename">/etc/polkit-default-privs.local</code> does not
     contain any overrides of the default policies.
    </p><div id="idm140712069274720" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Custom Policy Configuration</h6><p>
      Policies defined in
      <code class="filename">/etc/polkit-default-privs.local</code> will be applied
      on top of the defaults during the next step.
     </p></div></li><li class="step "><p>
     To reset all policies to the upstream defaults first and then apply the
     <span class="productname"><span class="phrase">openSUSE Leap</span></span> defaults:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> rm -f /var/lib/polkit/* &amp;&amp; set_polkit_default_privs</pre></div></li></ol></div></div></div></div><div class="chapter " id="cha.security.acls"><div class="titlepage"><div><div><h2 class="title"><span class="number">10 </span><span class="name">Access Control Lists in Linux</span> <a title="Permalink" class="permalink" href="#cha.security.acls">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_acls.xml</li><li><span class="ds-label">ID: </span>cha.security.acls</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712069266432">#</a></h6></div><p>
    POSIX ACLs (access control lists) can be used as an expansion of the
    traditional permission concept for file system objects. With ACLs,
    permissions can be defined more flexibly than with the traditional
    permission concept.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.acls.traditional"><span class="number">10.1 </span><span class="name">Traditional File Permissions</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.intro"><span class="number">10.2 </span><span class="name">Advantages of ACLs</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.defs"><span class="number">10.3 </span><span class="name">Definitions</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.handle"><span class="number">10.4 </span><span class="name">Handling ACLs</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.future"><span class="number">10.5 </span><span class="name">ACL Support in Applications</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.acls.info"><span class="number">10.6 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><p>
  The term <span class="emphasis"><em>POSIX ACL</em></span> suggests that this is a true POSIX
  (<span class="emphasis"><em>portable operating system interface</em></span>) standard. The
  respective draft standards POSIX 1003.1e and POSIX 1003.2c have been
  withdrawn for several reasons. Nevertheless, ACLs (as found on many
  systems belonging to the Unix family) are based on these drafts and the
  implementation of file system ACLs (as described in this chapter) follows
  these two standards.
 </p><div class="sect1 " id="sec.security.acls.traditional"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.traditional"><span class="number">10.1 </span><span class="name">Traditional File Permissions</span> <a title="Permalink" class="permalink" href="#sec.security.acls.traditional">#</a></h2></div></div></div><p>
   The permissions of all files included in <span class="productname"><span class="phrase">openSUSE Leap</span></span> are
   carefully chosen. When installing additional software or files,
   take great care when setting the permissions. Always use the
   <code class="option">-l</code> option with the command <code class="command">ls</code>
   to detect any incorrect file permissions immediately. An incorrect
   file attribute does not only mean that files could be changed or
   deleted. Modified files could be executed by <code class="systemitem">root</code> or
   services can be hijacked by modifying configuration files. This
   significantly increases the danger of an attack.
  </p><p>
   An <span class="productname"><span class="phrase">openSUSE® Leap</span></span> system includes the files
   <code class="filename">permissions</code>,
   <code class="filename">permissions.easy</code>,
   <code class="filename">permissions.secure</code>, and
   <code class="filename">permissions.paranoid</code>, all in the directory
   <code class="filename">/etc</code>. The purpose of these files is to define
   special permissions, such as world-writable directories or, for
   files, the setuser ID bit. Programs with the setuser ID bit set do
   not run with the permissions of the user that has launched it, but
   with the permissions of the file owner, usually <code class="systemitem">root</code>. An
   administrator can use the file
   <code class="filename">/etc/permissions.local</code> to add his own
   settings.
  </p><p>
   To define one of the available profiles, select <span class="guimenu">Local
   Security</span> in the <span class="guimenu">Security and Users</span>
   section of YaST. To learn more about the topic, read the
   comments in <code class="filename">/etc/permissions</code> or consult
   <code class="command">man chmod</code>.
  </p><p>
   Find detailed information about the traditional file permissions in the
   GNU Coreutils Info page, Node <span class="emphasis"><em>File permissions</em></span>
   (<code class="command">info coreutils "File permissions"</code>). More advanced
   features are the setuid, setgid, and sticky bit.
  </p><div class="sect2 " id="sec.security.acls.traditional.setuid"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.traditional.setuid"><span class="number">10.1.1 </span><span class="name">The setuid Bit</span> <a title="Permalink" class="permalink" href="#sec.security.acls.traditional.setuid">#</a></h3></div></div></div><p>
    In certain situations, the access permissions may be too restrictive.
    Therefore, Linux has additional settings that enable the temporary
    change of the current user and group identity for a specific action. For
    example, the <code class="command">passwd</code> program normally requires root
    permissions to access <code class="filename">/etc/passwd</code>. This file
    contains some important information, like the home directories of users
    and user and group IDs. Thus, a normal user would not be able to change
    <code class="filename">passwd</code>, because it would be too dangerous to grant
    all users direct access to this file. A possible solution to this
    problem is the <span class="emphasis"><em>setuid</em></span> mechanism. setuid (set user
    ID) is a special file attribute that instructs the system to execute
    programs marked accordingly under a specific user ID. Consider the
    <code class="command">passwd</code> command:
   </p><div class="verbatim-wrap"><pre class="screen">-rwsr-xr-x  1 root shadow 80036 2004-10-02 11:08 /usr/bin/passwd</pre></div><p>
    You can see the <code class="literal">s</code> that denotes that the setuid bit is
    set for the user permission. By means of the setuid bit, all users
    starting the <code class="command">passwd</code> command execute it as
    <code class="systemitem">root</code>.
   </p></div><div class="sect2 " id="sec.security.acls.traditional.setgid"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.traditional.setgid"><span class="number">10.1.2 </span><span class="name">The setgid Bit</span> <a title="Permalink" class="permalink" href="#sec.security.acls.traditional.setgid">#</a></h3></div></div></div><p>
    The setuid bit applies to users. However, there is also an equivalent
    property for groups: the <span class="emphasis"><em>setgid</em></span> bit. A program for
    which this bit was set runs under the group ID under which it was saved,
    no matter which user starts it. Therefore, in a directory with the
    setgid bit, all newly created files and subdirectories are assigned to
    the group to which the directory belongs. Consider the following example
    directory:
   </p><div class="verbatim-wrap"><pre class="screen">drwxrws--- 2 tux archive 48 Nov 19 17:12  backup</pre></div><p>
    You can see the <code class="literal">s</code> that denotes that the setgid bit is
    set for the group permission. The owner of the directory and members of
    the group <code class="systemitem">archive</code> may access
    this directory. Users that are not members of this group are
    <span class="quote">“<span class="quote">mapped</span>”</span> to the respective group. The effective group ID of
    all written files will be
    <code class="systemitem">archive</code>. For example, a
    backup program that runs with the group ID
    <code class="systemitem">archive</code> can access
    this directory even without root privileges.
   </p></div><div class="sect2 " id="sec.security.acls.traditional.sticky"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.traditional.sticky"><span class="number">10.1.3 </span><span class="name">The Sticky Bit</span> <a title="Permalink" class="permalink" href="#sec.security.acls.traditional.sticky">#</a></h3></div></div></div><p>
    There is also the <span class="emphasis"><em>sticky bit</em></span>. It makes a difference
    whether it belongs to an executable program or a directory. If it
    belongs to a program, a file marked in this way is loaded to RAM to
    avoid needing to get it from the hard disk each time it is used. This
    attribute is used rarely, because modern hard disks are fast enough. If
    this bit is assigned to a directory, it prevents users from deleting
    each other's files. Typical examples include the
    <code class="filename">/tmp</code> and <code class="filename">/var/tmp</code> directories:
   </p><div class="verbatim-wrap"><pre class="screen">drwxrwxrwt 2 root root 1160 2002-11-19 17:15 /tmp</pre></div></div></div><div class="sect1 " id="sec.security.acls.intro"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.intro"><span class="number">10.2 </span><span class="name">Advantages of ACLs</span> <a title="Permalink" class="permalink" href="#sec.security.acls.intro">#</a></h2></div></div></div><p>
   Traditionally, three permission sets are defined for each file object on
   a Linux system. These sets include the read (<code class="literal">r</code>), write
   (<code class="literal">w</code>), and execute (<code class="literal">x</code>) permissions
   for each of three types of users—the file owner, the group, and
   other users. In addition to that, it is possible to set the <span class="emphasis"><em>set
   user id</em></span>, the <span class="emphasis"><em>set group id</em></span>, and the
   <span class="emphasis"><em>sticky</em></span> bit. This lean concept is fully adequate for
   most practical cases. However, for more complex scenarios or advanced
   applications, system administrators formerly needed to use several
   workarounds to circumvent the limitations of the traditional permission
   concept.
  </p><p>
   ACLs can be used as an extension of the traditional file permission
   concept. They allow the assignment of permissions to individual users or
   groups even if these do not correspond to the original owner or the
   owning group. Access control lists are a feature of the Linux kernel and
   are currently supported by Ext2, Ext3, Ext4, JFS, and XFS. Using
   ACLs, complex scenarios can be realized without implementing complex
   permission models on the application level.
  </p><p>
   The advantages of ACLs are evident if you want to replace a Windows
   server with a Linux server. Some connected workstations may
   continue to run under Windows even after the migration. The Linux system
   offers file and print services to the Windows clients with Samba. With
   Samba supporting access control lists, user permissions can be configured
   both on the Linux server and in Windows with a graphical user interface
   (only Windows NT and later). With <code class="command">winbindd</code>, part of
   the Samba suite, it is even possible to assign permissions to users only
   existing in the Windows domain without any account on the Linux server.
  </p></div><div class="sect1 " id="sec.security.acls.defs"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.defs"><span class="number">10.3 </span><span class="name">Definitions</span> <a title="Permalink" class="permalink" href="#sec.security.acls.defs">#</a></h2></div></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712069221024"><span class="term ">User Class</span></dt><dd><p>
      The conventional POSIX permission concept uses three
      <span class="emphasis"><em>classes</em></span> of users for assigning permissions in the
      file system: the owner, the owning group, and other users. Three
      permission bits can be set for each user class, giving permission to
      read (<code class="literal">r</code>), write (<code class="literal">w</code>), and execute
      (<code class="literal">x</code>).
     </p></dd><dt id="idm140712069217200"><span class="term ">ACL</span></dt><dd><p>
      The user and group access permissions for all kinds of
      file system objects (files and directories) are determined by means of
      ACLs.
     </p></dd><dt id="idm140712069215264"><span class="term ">Default ACL</span></dt><dd><p>
      Default ACLs can only be applied to directories. They determine the
      permissions a file system object inherits from its parent directory
      when it is created.
     </p></dd><dt id="idm140712069213312"><span class="term ">ACL Entry</span></dt><dd><p>
      Each ACL consists of a set of ACL entries. An ACL entry contains a
      type, a qualifier for the user or group to which the entry refers, and
      a set of permissions. For some entry types, the qualifier for the
      group or users is undefined.
     </p></dd></dl></div></div><div class="sect1 " id="sec.security.acls.handle"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.handle"><span class="number">10.4 </span><span class="name">Handling ACLs</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle">#</a></h2></div></div></div><p>
   <a class="xref" href="#tab.entrytype" title="ACL Entry Types">Table 10.1, “ACL Entry Types”</a> summarizes the six possible types of ACL
   entries, each defining permissions for a user or a group of users. The
   <span class="emphasis"><em>owner</em></span> entry defines the permissions of the user
   owning the file or directory. The <span class="emphasis"><em>owning group</em></span> entry
   defines the permissions of the file's owning group. The superuser can
   change the owner or owning group with <code class="command">chown</code> or
   <code class="command">chgrp</code>, in which case the owner and owning group
   entries refer to the new owner and owning group. Each <span class="emphasis"><em>named
   user</em></span> entry defines the permissions of the user specified in
   the entry's qualifier field. Each <span class="emphasis"><em>named group</em></span> entry
   defines the permissions of the group specified in the entry's qualifier
   field. Only the named user and named group entries have a qualifier field
   that is not empty. The <span class="emphasis"><em>other</em></span> entry defines the
   permissions of all other users.
  </p><p>
   The <span class="emphasis"><em>mask</em></span> entry further limits the permissions
   granted by named user, named group, and owning group entries by defining
   which of the permissions in those entries are effective and which are
   masked. If permissions exist in one of the mentioned entries and
   in the mask, they are effective. Permissions contained only in the mask
   or only in the actual entry are not effective—meaning the
   permissions are not granted. All permissions defined in the owner and
   owning group entries are always effective. The example in
   <a class="xref" href="#tab.mask" title="Masking Access Permissions">Table 10.2, “Masking Access Permissions”</a> demonstrates this mechanism.
  </p><p>
   There are two basic classes of ACLs: A <span class="emphasis"><em>minimum</em></span> ACL
   contains only the entries for the types owner, owning group, and other,
   which correspond to the conventional permission bits for files and
   directories. An <span class="emphasis"><em>extended</em></span> ACL goes beyond this. It
   must contain a mask entry and may contain several entries of the named
   user and named group types.
  </p><div class="table" id="tab.entrytype"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 10.1: </span><span class="name">ACL Entry Types </span><a title="Permalink" class="permalink" href="#tab.entrytype">#</a></h6></div><div class="table-contents"><table summary="ACL Entry Types" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
       <p>
        Type
       </p>
      </th><th>
       <p>
        Text Form
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        owner
       </p>
      </td><td>
       <p>
        <code class="literal">user::rwx</code>
       </p>
      </td></tr><tr><td>
       <p>
        named user
       </p>
      </td><td>
       <p>
        <code class="literal">user:name:rwx</code>
       </p>
      </td></tr><tr><td>
       <p>
        owning group
       </p>
      </td><td>
       <p>
        <code class="literal">group::rwx</code>
       </p>
      </td></tr><tr><td>
       <p>
        named group
       </p>
      </td><td>
       <p>
        <code class="literal">group:name:rwx</code>
       </p>
      </td></tr><tr><td>
       <p>
        mask
       </p>
      </td><td>
       <p>
        <code class="literal">mask::rwx</code>
       </p>
      </td></tr><tr><td>
       <p>
        other
       </p>
      </td><td>
       <p>
        <code class="literal">other::rwx</code>
       </p>
      </td></tr></tbody></table></div></div><div class="table" id="tab.mask"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 10.2: </span><span class="name">Masking Access Permissions </span><a title="Permalink" class="permalink" href="#tab.mask">#</a></h6></div><div class="table-contents"><table summary="Masking Access Permissions" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>
       <p>
        Entry Type
       </p>
      </th><th>
       <p>
        Text Form
       </p>
      </th><th>
       <p>
        Permissions
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        named user
       </p>
      </td><td>
       <p>
        <code class="literal">user:geeko:r-x</code>
       </p>
      </td><td>
       <p>
        <code class="literal">r-x</code>
       </p>
      </td></tr><tr><td>
       <p>
        mask
       </p>
      </td><td>
       <p>
        <code class="literal">mask::rw-</code>
       </p>
      </td><td>
       <p>
        <code class="literal">rw-</code>
       </p>
      </td></tr><tr><td>
       
      </td><td>
       <p>
        effective permissions:
       </p>
      </td><td>
       <p>
        <code class="literal">r--</code>
       </p>
      </td></tr></tbody></table></div></div><div class="sect2 " id="sec.security.acls.handle.fmbits"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.handle.fmbits"><span class="number">10.4.1 </span><span class="name">ACL Entries and File Mode Permission Bits</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.fmbits">#</a></h3></div></div></div><p>
    <a class="xref" href="#fig.acls.map.mini" title="Minimum ACL: ACL Entries Compared to Permission Bits">Figure 10.1, “Minimum ACL: ACL Entries Compared to Permission Bits”</a> and
    <a class="xref" href="#fig.acls.map.ext" title="Extended ACL: ACL Entries Compared to Permission Bits">Figure 10.2, “Extended ACL: ACL Entries Compared to Permission Bits”</a> illustrate the two cases of a minimum
    ACL and an extended ACL. The figures are structured in three
    blocks—the left block shows the type specifications of the ACL
    entries, the center block displays an example ACL, and the right block
    shows the respective permission bits according to the conventional
    permission concept (for example, as displayed by <code class="command">ls</code>
    <code class="option">-l</code>). In both cases, the <span class="emphasis"><em>owner
    class</em></span> permissions are mapped to the ACL entry owner.
    <span class="emphasis"><em>Other class</em></span> permissions are mapped to the
    respective ACL entry. However, the mapping of the <span class="emphasis"><em>group
    class</em></span> permissions is different in the two cases.
   </p><div class="figure" id="fig.acls.map.mini"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/acls_map_mini.png"><img src="images/acls_map_mini.png" width="" alt="Minimum ACL: ACL Entries Compared to Permission Bits" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 10.1: </span><span class="name">Minimum ACL: ACL Entries Compared to Permission Bits </span><a title="Permalink" class="permalink" href="#fig.acls.map.mini">#</a></h6></div></div><p>
    In the case of a minimum ACL—without mask—the group
    class permissions are mapped to the ACL entry owning group. This is
    shown in <a class="xref" href="#fig.acls.map.mini" title="Minimum ACL: ACL Entries Compared to Permission Bits">Figure 10.1, “Minimum ACL: ACL Entries Compared to Permission Bits”</a>. In the case of an extended
    ACL—with mask—the group class permissions are mapped
    to the mask entry. This is shown in <a class="xref" href="#fig.acls.map.ext" title="Extended ACL: ACL Entries Compared to Permission Bits">Figure 10.2, “Extended ACL: ACL Entries Compared to Permission Bits”</a>.
   </p><div class="figure" id="fig.acls.map.ext"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/acls_map_ext.png"><img src="images/acls_map_ext.png" width="" alt="Extended ACL: ACL Entries Compared to Permission Bits" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 10.2: </span><span class="name">Extended ACL: ACL Entries Compared to Permission Bits </span><a title="Permalink" class="permalink" href="#fig.acls.map.ext">#</a></h6></div></div><p>
    This mapping approach ensures the smooth interaction of applications,
    regardless of whether they have ACL support. The access permissions that
    were assigned by means of the permission bits represent the upper limit
    for all other <span class="quote">“<span class="quote">fine adjustments</span>”</span> made with an ACL. Changes
    made to the permission bits are reflected by the ACL and vice versa.
   </p></div><div class="sect2 " id="sec.security.acls.handle.accacl"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.handle.accacl"><span class="number">10.4.2 </span><span class="name">A Directory with an ACL</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.accacl">#</a></h3></div></div></div><p>
    With <code class="command">getfacl</code> and <code class="command">setfacl</code> on the
    command line, you can access ACLs. The usage of these commands is
    demonstrated in the following example.
   </p><p>
    Before creating the directory, use the <code class="command">umask</code> command
    to define which access permissions should be masked each time a file
    object is created. The command <code class="command">umask</code>
    <code class="option">027</code> sets the default permissions by giving the owner
    the full range of permissions (<code class="literal">0</code>), denying the group
    write access (<code class="literal">2</code>), and giving other users no
    permissions (<code class="literal">7</code>). <code class="command">umask</code>
    actually masks the corresponding permission bits or turns them off. For
    details, consult the <code class="command">umask</code> man page.
   </p><p>
    <code class="command">mkdir mydir</code> creates the <code class="filename">mydir</code>
    directory with the default permissions as set by
    <code class="command">umask</code>. Use <code class="command">ls</code> <code class="option">-dl
    mydir</code> to check whether all permissions were assigned correctly.
    The output for this example is:
   </p><div class="verbatim-wrap"><pre class="screen">drwxr-x--- ... tux project3 ... mydir</pre></div><p>
    With <code class="command">getfacl</code> <code class="option">mydir</code>, check the
    initial state of the ACL. This gives information like:
   </p><div class="verbatim-wrap"><pre class="screen"># file: mydir
# owner: tux
# group: project3
user::rwx
group::r-x
other::---</pre></div><p>
    The first three output lines display the name, owner, and
    owning group of the directory. The next three lines contain the three
    ACL entries owner, owning group, and other. In fact, in the case of this
    minimum ACL, the <code class="command">getfacl</code> command does not produce any
    information you could not have obtained with <code class="command">ls</code>.
   </p><p>
    Modify the ACL to assign read, write, and execute permissions to an
    additional user <code class="literal">geeko</code> and an additional group
    <code class="literal">mascots</code> with:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>setfacl -m user:geeko:rwx,group:mascots:rwx mydir</pre></div><p>
    The option <code class="option">-m</code> prompts <code class="command">setfacl</code> to
    modify the existing ACL. The following argument indicates the ACL
    entries to modify (multiple entries are separated by commas). The final
    part specifies the name of the directory to which these modifications
    should be applied. Use the <code class="command">getfacl</code> command to take a
    look at the resulting ACL.
   </p><div class="verbatim-wrap"><pre class="screen"># file: mydir
# owner: tux
# group: project3
user::rwx
user:geeko:rwx
group::r-x
group:mascots:rwx
mask::rwx
other::---</pre></div><p>
    In addition to the entries initiated for the user
    <code class="literal">geeko</code> and the group <code class="literal">mascots</code>, a
    mask entry has been generated. This mask entry is set automatically so
    that all permissions are effective. <code class="command">setfacl</code>
    automatically adapts existing mask entries to the settings modified,
    unless you deactivate this feature with <code class="literal">-n</code>. The mask
    entry defines the maximum effective access permissions for all entries
    in the group class. This includes named user, named group, and owning
    group. The group class permission bits displayed by
    <code class="command">ls</code> <code class="option">-dl mydir</code> now correspond to the
    <code class="literal">mask</code> entry.
   </p><div class="verbatim-wrap"><pre class="screen">drwxrwx---+ ... tux project3 ... mydir</pre></div><p>
    The first column of the output contains an additional
    <code class="literal">+</code> to indicate that there is an
    <span class="emphasis"><em>extended</em></span> ACL for this item.
   </p><p>
    According to the output of the <code class="command">ls</code> command, the
    permissions for the mask entry include write access. Traditionally, such
    permission bits would mean that the owning group (here
    <code class="literal">project3</code>) also has write access to the directory
    <code class="filename">mydir</code>.
   </p><p>
    However, the effective access permissions for the owning group
    correspond to the overlapping portion of the permissions defined for the
    owning group and for the mask—which is <code class="literal">r-x</code>
    in our example (see <a class="xref" href="#tab.mask" title="Masking Access Permissions">Table 10.2, “Masking Access Permissions”</a>). As far as the effective
    permissions of the owning group in this example are concerned, nothing
    has changed even after the addition of the ACL entries.
   </p><p>
    Edit the mask entry with <code class="command">setfacl</code> or
    <code class="command">chmod</code>. For example, use <code class="command">chmod</code>
    <code class="option">g-w mydir</code>. <code class="command">ls</code> <code class="option">-dl
    mydir</code> then shows:
   </p><div class="verbatim-wrap"><pre class="screen">drwxr-x---+ ... tux project3 ... mydir</pre></div><p>
    <code class="command">getfacl</code> <code class="option">mydir</code> provides the following
    output:
   </p><div class="verbatim-wrap"><pre class="screen"># file: mydir
# owner: tux
# group: project3
user::rwx
user:geeko:rwx          # effective: r-x
group::r-x
group:mascots:rwx       # effective: r-x
mask::r-x
other::---</pre></div><p>
    After executing <code class="command">chmod</code> to remove the write
    permission from the group class bits, the output of
    <code class="command">ls</code> is sufficient to see that the mask bits
    must have changed accordingly: write permission is again limited to the
    owner of <code class="filename">mydir</code>. The output of the
    <code class="command">getfacl</code> confirms this. This output includes a comment
    for all those entries in which the effective permission bits do not
    correspond to the original permissions, because they are filtered
    according to the mask entry. The original permissions can be restored at
    any time with <code class="command">chmod g+w mydir</code>.
   </p></div><div class="sect2 " id="sec.security.acls.handle.defacl"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.handle.defacl"><span class="number">10.4.3 </span><span class="name">A Directory with a Default ACL</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.defacl">#</a></h3></div></div></div><p>
    Directories can have a default ACL, which is a special kind of ACL
    defining the access permissions that objects in the directory inherit
    when they are created. A default ACL affects both subdirectories and
    files.
   </p><div class="sect3 " id="sec.security.acls.handle.defacl.eff"><div class="titlepage"><div><div><h4 class="title" id="sec.security.acls.handle.defacl.eff"><span class="number">10.4.3.1 </span><span class="name">Effects of a Default ACL</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.defacl.eff">#</a></h4></div></div></div><p>
     There are two ways in which the permissions of a directory's default
     ACL are passed to the files and subdirectories:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       A subdirectory inherits the default ACL of the parent directory both
       as its default ACL and as an ACL.
      </p></li><li class="listitem "><p>
       A file inherits the default ACL as its ACL.
      </p></li></ul></div><p>
     All system calls that create file system objects use a
     <code class="literal">mode</code> parameter that defines the access permissions
     for the newly created file system object. If the parent directory does
     not have a default ACL, the permission bits as defined by the
     <code class="literal">umask</code> are subtracted from the permissions as passed
     by the <code class="literal">mode</code> parameter, with the result being
     assigned to the new object. If a default ACL exists for the parent
     directory, the permission bits assigned to the new object correspond to
     the overlapping portion of the permissions of the
     <code class="literal">mode</code> parameter and those that are defined in the
     default ACL. The <code class="literal">umask</code> is disregarded in this case.
    </p></div><div class="sect3 " id="sec.security.acls.handle.defacl.prac"><div class="titlepage"><div><div><h4 class="title" id="sec.security.acls.handle.defacl.prac"><span class="number">10.4.3.2 </span><span class="name">Application of Default ACLs</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.defacl.prac">#</a></h4></div></div></div><p>
     The following three examples show the main operations for directories
     and default ACLs:
    </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>
       Add a default ACL to the existing directory
       <code class="filename">mydir</code> with:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>setfacl -d -m group:mascots:r-x mydir</pre></div><p>
       The option <code class="literal">-d</code> of the <code class="command">setfacl</code>
       command prompts <code class="command">setfacl</code> to perform the following
       modifications (option <code class="literal">-m</code>) in the default ACL.
      </p><p>
       Take a closer look at the result of this command:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>getfacl mydir

# file: mydir
# owner: tux
# group: project3
user::rwx
user:geeko:rwx
group::r-x
group:mascots:rwx
mask::rwx
other::---
default:user::rwx
default:group::r-x
default:group:mascots:r-x
default:mask::r-x
default:other::---</pre></div><p>
       <code class="command">getfacl</code> returns both the ACL and the default ACL.
       The default ACL is formed by all lines that start with
       <code class="literal">default</code>. Although you merely executed the
       <code class="command">setfacl</code> command with an entry for the
       <code class="literal">mascots</code> group for the default ACL,
       <code class="command">setfacl</code> automatically copied all other entries
       from the ACL to create a valid default ACL. Default ACLs do not have
       an immediate effect on access permissions. They only come into play
       when file system objects are created. These new objects inherit
       permissions only from the default ACL of their parent directory.
      </p></li><li class="listitem "><p>
       In the next example, use <code class="command">mkdir</code> to create a
       subdirectory in <code class="filename">mydir</code>, which inherits the
       default ACL.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>mkdir mydir/mysubdir

getfacl mydir/mysubdir

# file: mydir/mysubdir
# owner: tux
# group: project3
user::rwx
group::r-x
group:mascots:r-x
mask::r-x
other::---
default:user::rwx
default:group::r-x
default:group:mascots:r-x
default:mask::r-x
default:other::---</pre></div><p>
       As expected, the newly-created subdirectory
       <code class="filename">mysubdir</code> has the permissions from the default
       ACL of the parent directory. The ACL of <code class="filename">mysubdir</code>
       is an exact reflection of the default ACL of
       <code class="filename">mydir</code>. The default ACL that this directory will
       hand down to its subordinate objects is also the same.
      </p></li><li class="listitem "><p>
       Use <code class="command">touch</code> to create a file in the
       <code class="filename">mydir</code> directory, for example,
       <code class="command">touch</code> <code class="option">mydir/myfile</code>.
       <code class="command">ls</code> <code class="option">-l mydir/myfile</code> then shows:
      </p><div class="verbatim-wrap"><pre class="screen">-rw-r-----+ ... tux project3 ... mydir/myfile</pre></div><p>
       The output of <code class="command">getfacl</code>
       <code class="option">mydir/myfile</code> is:
      </p><div class="verbatim-wrap"><pre class="screen"># file: mydir/myfile
# owner: tux
# group: project3
user::rw-
group::r-x          # effective:r--
group:mascots:r-x   # effective:r--
mask::r--
other::---</pre></div><p>
       <code class="command">touch</code> uses a <code class="literal">mode</code> with the
       value <code class="literal">0666</code> when creating new files, which means
       that the files are created with read and write permissions for all
       user classes, provided no other restrictions exist in
       <code class="command">umask</code> or in the default ACL (see
       <a class="xref" href="#sec.security.acls.handle.defacl.eff" title="10.4.3.1. Effects of a Default ACL">Section 10.4.3.1, “Effects of a Default ACL”</a>). In effect,
       this means that all access permissions not contained in the
       <code class="literal">mode</code> value are removed from the respective ACL
       entries. Although no permissions were removed from the ACL entry of
       the group class, the mask entry was modified to mask permissions not
       set in <code class="literal">mode</code>.
      </p><p>
       This approach ensures the smooth interaction of applications (such as
       compilers) with ACLs. You can create files with restricted access
       permissions and subsequently mark them as executable. The
       <code class="command">mask</code> mechanism guarantees that the right users and
       groups can execute them as desired.
      </p></li></ol></div></div></div><div class="sect2 " id="sec.security.acls.handle.alg"><div class="titlepage"><div><div><h3 class="title" id="sec.security.acls.handle.alg"><span class="number">10.4.4 </span><span class="name">The ACL Check Algorithm</span> <a title="Permalink" class="permalink" href="#sec.security.acls.handle.alg">#</a></h3></div></div></div><p>
    A check algorithm is applied before any process or application is
    granted access to an ACL-protected file system object. As a basic rule,
    the ACL entries are examined in the following sequence: owner, named
    user, owning group or named group, and other. The access is handled in
    accordance with the entry that best suits the process. Permissions do
    not accumulate.
   </p><p>
    Things are more complicated if a process belongs to more than one group
    and would potentially suit several group entries. An entry is randomly
    selected from the suitable entries with the required permissions. It is
    irrelevant which of the entries triggers the final result <span class="quote">“<span class="quote">access
    granted</span>”</span>. Likewise, if none of the suitable group entries contain
    the required permissions, a randomly selected entry triggers the final
    result <span class="quote">“<span class="quote">access denied</span>”</span>.
   </p></div></div><div class="sect1 " id="sec.security.acls.future"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.future"><span class="number">10.5 </span><span class="name">ACL Support in Applications</span> <a title="Permalink" class="permalink" href="#sec.security.acls.future">#</a></h2></div></div></div><p>
   ACLs can be used to implement very complex permission scenarios that meet
   the requirements of modern applications. The traditional permission
   concept and ACLs can be combined in a smart manner. The basic file
   commands (<code class="command">cp</code>, <code class="command">mv</code>,
   <code class="command">ls</code>, etc.) support ACLs, as do Samba and Nautilus.
  </p><p>
   Unfortunately, many editors and file managers still lack ACL support.
   When copying files with Emacs, for example, the ACLs of these files are
   lost.
   
   When modifying files with an editor, the ACLs of files are sometimes
   preserved and sometimes not, depending on the backup mode of the editor
   used. If the editor writes the changes to the original file, the ACL is
   preserved. If the editor saves the updated contents to a new file that is
   subsequently renamed to the old file name, the ACLs may be lost, unless
   the editor supports ACLs. Except for the <code class="command">star</code>
   archiver, there are currently no backup applications that preserve ACLs.
  </p></div><div class="sect1 " id="sec.security.acls.info"><div class="titlepage"><div><div><h2 class="title" id="sec.security.acls.info"><span class="number">10.6 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.acls.info">#</a></h2></div></div></div><p>
   For more information about ACLs, see the man pages for
   <code class="command">getfacl(1)</code>, <code class="command">acl(5)</code>, and
   <code class="command">setfacl(1)</code>.
  </p></div></div><div class="chapter " id="cha.security.cryptofs"><div class="titlepage"><div><div><h2 class="title"><span class="number">11 </span><span class="name">Encrypting Partitions and Files</span> <a title="Permalink" class="permalink" href="#cha.security.cryptofs">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_cryptofs.xml</li><li><span class="ds-label">ID: </span>cha.security.cryptofs</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.cryptofs.y2"><span class="number">11.1 </span><span class="name">Setting Up an Encrypted File System with YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.cryptofs.gpg"><span class="number">11.2 </span><span class="name">Encrypting Files with GPG</span></a></span></dt></dl></div></div><p>
  Encrypting files, partitions, and entire disks prevents unauthorized access to your data and protects your confidential files and documents.
 </p><p>
  You can choose between the following encryption options:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712069048368"><span class="term ">Encrypting a Hard Disk Partition</span></dt><dd><p>
     It is possible to create an encrypted partition with YaST during
     installation or in an already installed system. For further info, see
     <a class="xref" href="#sec.security.cryptofs.y2.part_inst" title="11.1.1. Creating an Encrypted Partition during Installation">Section 11.1.1, “Creating an Encrypted Partition during Installation”</a> and
     <a class="xref" href="#sec.security.cryptofs.y2.part_run" title="11.1.2. Creating an Encrypted Partition on a Running System">Section 11.1.2, “Creating an Encrypted Partition on a Running System”</a>. This
     option can also be used for removable media, such as external hard
     disks, as described in
     <a class="xref" href="#sec.security.cryptofs.y2.removables" title="11.1.4. Encrypting the Content of Removable Media">Section 11.1.4, “Encrypting the Content of Removable Media”</a>.
    </p></dd><dt id="idm140712069044608"><span class="term ">Creating an Encrypted Virtual Disk</span></dt><dd><p>
     You can create a file-based encrypted virtual disk on your hard disk or a removable
     medium with YaST. The encrypted virtual disk can then be used
     as a regular folder for storing files or directories. For more
     information, refer to
     <a class="xref" href="#sec.security.cryptofs.y2.vdisk" title="11.1.3. Creating an Encrypted Virtual Disk">Section 11.1.3, “Creating an Encrypted Virtual Disk”</a>.
    </p></dd><dt id="idm140712069041984"><span class="term ">Encrypting Single Files with GPG</span></dt><dd><p>
     To quickly encrypt one or several files, you can use the GPG tool. See
     <a class="xref" href="#sec.security.cryptofs.gpg" title="11.2. Encrypting Files with GPG">Section 11.2, “Encrypting Files with GPG”</a> for more information.
    </p></dd></dl></div><div id="idm140712069039360" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Encryption Offers Limited Protection</h6><p>
   Encryption methods described in this chapter cannot protect your running
   system from being compromised. After the encrypted volume is successfully
   mounted, everybody with appropriate permissions can access it. However,
   encrypted media are useful in case of loss or theft of your computer, or to
   prevent unauthorized individuals from reading your confidential data.
  </p></div><div class="sect1 " id="sec.security.cryptofs.y2"><div class="titlepage"><div><div><h2 class="title" id="sec.security.cryptofs.y2"><span class="number">11.1 </span><span class="name">Setting Up an Encrypted File System with YaST</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.y2">#</a></h2></div></div></div><p>
   Use YaST to encrypt partitions or parts of your file system during
   installation or in an already installed system. However, encrypting a
   partition in an already-installed system is more difficult, because you
   need to resize and change existing partitions. In such cases, it may be
   more convenient to create an encrypted file of a defined size, in which
   to <span class="emphasis"><em>store</em></span> other files or parts of your file system.
   To encrypt an entire partition, dedicate a partition for encryption in
   the partition layout. The standard partitioning proposal as suggested by
   YaST, does not include an encrypted partition by default. Add it
   manually in the partitioning dialog.
  </p><div class="sect2 " id="sec.security.cryptofs.y2.part_inst"><div class="titlepage"><div><div><h3 class="title" id="sec.security.cryptofs.y2.part_inst"><span class="number">11.1.1 </span><span class="name">Creating an Encrypted Partition during Installation</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.y2.part_inst">#</a></h3></div></div></div><div id="idm140712069033584" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Password Input</h6><p>
     Make sure to memorize the password for your encrypted partitions well.
     Without that password, you cannot access or restore the encrypted data.
    </p></div><p>
    The YaST expert dialog for partitioning offers the options needed
    for creating an encrypted partition. To create a new encrypted partition
    proceed as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Run the YaST Expert Partitioner with <span class="guimenu">System</span> › <span class="guimenu">Partitioner</span>.
     </p></li><li class="step "><p>
      Select a hard disk, click <span class="guimenu">Add</span>, and select a primary
      or an extended partition.
     </p></li><li class="step "><p>
      Select the partition size or the region to use on the disk.
     </p></li><li class="step "><p>
      Select the file system, and mount point of this partition.
     </p></li><li class="step "><p>
      Activate the <span class="guimenu">Encrypt device</span> check box.
     </p><div id="idm140712069024800" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Additional Software Required</h6><p>
       After checking <span class="guimenu">Encrypt device</span>, a pop-up window
       asking for installing additional software may appear. Confirm to
       install all the required packages to ensure that the encrypted
       partition works well.
      </p></div></li><li class="step "><p>
      If the encrypted file system needs to be mounted only when necessary,
      enable <span class="guimenu">Do not mount partition</span> in the <span class="guimenu">Fstab
      Options</span>. otherwise enable <span class="guimenu">Mount partition</span>
      and enter the mount point.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Next</span> and enter a password which is used to
      encrypt this partition. This password is not displayed. To prevent
      typing errors, you need to enter the password twice.
     </p></li><li class="step "><p>
      Complete the process by clicking <span class="guimenu">Finish</span>. The
      newly-encrypted partition is now created.
     </p></li></ol></div></div><p>
    During the boot process, the operating system asks for the password
    before mounting any encrypted partition which is set to be auto-mounted
    in <code class="filename">/etc/fstab</code>. Such a partition is then available
    to all users when it has been mounted.
   </p><p>
    To skip mounting the encrypted partition during start-up, press
    <span class="keycap">Enter</span> when prompted for the password. Then decline
    the offer to enter the password again. In this case, the encrypted file
    system is not mounted and the operating system continues booting,
    blocking access to your data.
   </p><p>
    To mount an encrypted partition which is not mounted
    during the boot process, open a file manager and click the partition
    entry in the pane listing common places on your file system. You will be
    prompted for a password and the partition will be mounted.
   </p><p>
    When you are installing your system on a machine where partitions
    already exist, you can also decide to encrypt an existing partition
    during installation. In this case follow the description in
    <a class="xref" href="#sec.security.cryptofs.y2.part_run" title="11.1.2. Creating an Encrypted Partition on a Running System">Section 11.1.2, “Creating an Encrypted Partition on a Running System”</a> and be aware that
    this action destroys all data on the existing partition.
   </p></div><div class="sect2 " id="sec.security.cryptofs.y2.part_run"><div class="titlepage"><div><div><h3 class="title" id="sec.security.cryptofs.y2.part_run"><span class="number">11.1.2 </span><span class="name">Creating an Encrypted Partition on a Running System</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.y2.part_run">#</a></h3></div></div></div><div id="idm140712069011424" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Activating Encryption on a Running System</h6><p>
     It is also possible to create encrypted partitions on a running system.
     However, encrypting an existing partition destroys all data on it, and
     requires re-sizing and restructuring of existing partitions.
    </p></div><p>
    On a running system, select <span class="guimenu">System</span> › <span class="guimenu">Partitioner</span> in the YaST control
    center. Click <span class="guimenu">Yes</span> to proceed. In the <span class="guimenu">Expert
    Partitioner</span>, select the partition to encrypt and click
    <span class="guimenu">Edit</span>. The rest of the procedure is the same as
    described in <a class="xref" href="#sec.security.cryptofs.y2.part_inst" title="11.1.1. Creating an Encrypted Partition during Installation">Section 11.1.1, “Creating an Encrypted Partition during Installation”</a>.
   </p></div><div class="sect2 " id="sec.security.cryptofs.y2.vdisk"><div class="titlepage"><div><div><h3 class="title" id="sec.security.cryptofs.y2.vdisk"><span class="number">11.1.3 </span><span class="name">Creating an Encrypted Virtual Disk</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.y2.vdisk">#</a></h3></div></div></div><p>
     Instead of encrypting an entire disk or partition, you can use YaST to set up a file-based encrypted virtual disk. It will appear as a regular file in the file system, but can be mounted and used like a regular folder. Unlike encrypted partitions, encrypted virtual disks can be created without re-partitioning the hard disk.
   </p><p>
     To set up an encrypted virtual disk, you need to create an empty file
     first (this file is called loop file). In the terminal, switch to the
     desired directory and run the <code class="command">touch
     <em class="replaceable ">FILE</em></code> command (where
     <em class="replaceable ">FILE</em> is the desired name, for example: <code class="filename">secret</code>). It is also recommended to create an empty
     directory that will act as a mount point for the encrypted virtual
     disk. To do this, use the <code class="command">mkdir
     <em class="replaceable ">DIR</em></code> command (replace
     <em class="replaceable ">DIR</em> with the actual path and directory name,
     for example: <code class="filename">~/my_docs</code>).
   </p><p>
     To set up an encrypted virtual disk, launch YaST, switch to the
     <span class="guimenu">System</span> section, and start Partitioner. Switch to
     the <span class="guimenu">Crypt Files</span> section and press <span class="guimenu">Add Crypt
     File</span>. Enter the path to the created loop file into the
     <span class="guimenu">Path Name of Loop File</span> field. Enable the
     <span class="guimenu">Create Loop File</span> option, specify the desired size, and
     press <span class="guimenu">Next</span>. In the <span class="guimenu">Mount Point</span> field,
     enter the path to the directory that serves as a mount point (in this
     example, it is <code class="filename">~/my_docs</code>). Make sure that the
     <span class="guimenu">Encrypt Device</span> option is enabled and press
     <span class="guimenu">Next</span>. Provide the desired password and press
     <span class="guimenu">Finish</span>.
   </p></div><div class="sect2 " id="sec.security.cryptofs.y2.removables"><div class="titlepage"><div><div><h3 class="title" id="sec.security.cryptofs.y2.removables"><span class="number">11.1.4 </span><span class="name">Encrypting the Content of Removable Media</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.y2.removables">#</a></h3></div></div></div><p>
    YaST treats removable media (like external hard disks or flash
    disks) the same as any other storage device. Virtual disks or partitions on
    external media can be encrypted as described above. However, you should disable
    mounting at boot time, because removable media is usually connected only
    when the system is up and running.
   </p><p>
    If you encrypted your removable device with YaST, the GNOME desktop
    automatically recognizes the encrypted partition and prompts for the
    password when the device is detected. If you plug in a FAT-formatted
    removable device when running GNOME, the desktop user entering the
    password automatically becomes the owner of the device.
    For devices with a file system other than FAT, change the
    ownership explicitly for users other than <code class="systemitem">root</code> to give them
    read-write access to the device.
   </p><p>
     If you have created a virtual disk as described in <a class="xref" href="#sec.security.cryptofs.y2.vdisk" title="11.1.3. Creating an Encrypted Virtual Disk">Section 11.1.3, “Creating an Encrypted Virtual Disk”</a> but with the loop file on a
     removable disk, then you need to mount the file manually as follows:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> cryptsetup luksOpen  <em class="replaceable ">FILE</em> <em class="replaceable ">NAME</em>
sudo mount /dev/mapper/<em class="replaceable ">NAME</em> <em class="replaceable ">DIR</em></pre></div><p>
     In the commands above, the <em class="replaceable ">FILE</em> refers to the
     path to the loop file, <em class="replaceable ">NAME</em> is a user-defined
     name, and <em class="replaceable ">DIR</em> is the path to the mount
     point. For example:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> cryptsetup luksOpen /run/media/tux/usbstick/secret my_secret
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> mount /dev/mapper/my_secret /home/tux/my_docs</pre></div></div></div><div class="sect1 " id="sec.security.cryptofs.gpg"><div class="titlepage"><div><div><h2 class="title" id="sec.security.cryptofs.gpg"><span class="number">11.2 </span><span class="name">Encrypting Files with GPG</span> <a title="Permalink" class="permalink" href="#sec.security.cryptofs.gpg">#</a></h2></div></div></div><p>
   The GPG encryption software can be used to encrypt individual files and documents.
  </p><p>
   To encrypt a file with GPG, you need to generate a key pair first. To do
   this, run the <code class="command">gpg --gen-key</code> and follow the on-screen
   instructions. When generating the key pair, GPG creates a user ID (UID) to
   identify the key based on your real name, comments, and email address. You
   need this UID (or just a part of it like your first name or email address)
   to specify the key you want to use to encrypt a file. To find the UID of an
   existing key, use the <code class="command">gpg --list-keys</code> command. To encrypt
   a file use the following command:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>gpg -e -r <em class="replaceable ">UID</em>
  <em class="replaceable ">FILE</em></pre></div><p>
    Replace <em class="replaceable ">UID</em> with part of the UID (for example,
    your first name) and <em class="replaceable ">FILE</em> with the file you want
    to encrypt. For example:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>gpg -e -r Tux secret.txt</pre></div><p>
    This command creates an encrypted version of the specified file
    recognizable by the <code class="filename">.gpg</code> file extension (in
    this example, it is <code class="filename">secret.txt.gpg</code>).
  </p><p>
    To decrypt an encrypted file, use the following command:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>gpg -d -o <em class="replaceable ">DECRYPTED_FILE</em>
  <em class="replaceable ">ENCRYPTED_FILE</em></pre></div><p>
    Replace <em class="replaceable ">DECRYPTED_FILE</em> with the desired name for
    the decrypted file and <em class="replaceable ">ENCRYPTED_FILE</em> with the
    encrypted file you want to decrypt.
  </p><p>
    Keep that the encrypted file can be only decrypted
    using the same key that was used for encryption. If you want to share an
    encrypted file with another person, you have to use that person's public key to
    encrypt the file.
  </p></div></div><div class="chapter " id="cha.certstore"><div class="titlepage"><div><div><h2 class="title"><span class="number">12 </span><span class="name">Certificate Store</span> <a title="Permalink" class="permalink" href="#cha.certstore">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_certificatestore.xml</li><li><span class="ds-label">ID: </span>cha.certstore</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712068966544">#</a></h6></div><p>
    Certificates play an important role in the authentication of companies
    and individuals. Usually certificates are administered by the
    application itself. In some cases, it makes sense to share certificates
    between applications. The certificate store is a common ground for
    Firefox, Evolution, and NetworkManager. This chapter explains some
    details.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.certstore.activate"><span class="number">12.1 </span><span class="name">Activating Certificate Store</span></a></span></dt><dt><span class="sect1"><a href="#sec.certstore.import"><span class="number">12.2 </span><span class="name">Importing Certificates</span></a></span></dt></dl></div></div><p>
  The certificate store is a common database for Firefox, Evolution, and
  NetworkManager at the moment. Other applications that use certificates are
  not covered but may be in the future. If you have such an application, you
  can continue to use its private, separate configuration.
 </p><div class="sect1 " id="sec.certstore.activate"><div class="titlepage"><div><div><h2 class="title" id="sec.certstore.activate"><span class="number">12.1 </span><span class="name">Activating Certificate Store</span> <a title="Permalink" class="permalink" href="#sec.certstore.activate">#</a></h2></div></div></div><p>
   The configuration is mostly done in the background. To activate it,
   proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Decide if you want to activate the certificate store globally (for
     every user on your system) or specifically to a certain user:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p><span class="formalpara-title">For every user. </span>
        Use the file <code class="filename">/etc/profile.local</code>
       </p></li><li class="listitem "><p><span class="formalpara-title">For a specific user. </span>
        Use the file <code class="filename">~/.bashrc</code>
       </p></li></ul></div></li><li class="step "><p>
     Open the file from the previous step and insert the following line:
    </p><div class="verbatim-wrap"><pre class="screen">export NSS_USE_SHARED_DB=1</pre></div><p>
     Save the file
    </p></li><li class="step "><p>
     Log out of and log in to your desktop.
    </p></li></ol></div></div><p>
   All the certificates are stored under
   <code class="filename">$HOME/.local/var/pki/nssdb/</code>.
  </p></div><div class="sect1 " id="sec.certstore.import"><div class="titlepage"><div><div><h2 class="title" id="sec.certstore.import"><span class="number">12.2 </span><span class="name">Importing Certificates</span> <a title="Permalink" class="permalink" href="#sec.certstore.import">#</a></h2></div></div></div><p>
   To import a certificate into the certificate store, do the following:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start Firefox.
    </p></li><li class="step "><p>
     Open the dialog from <span class="guimenu">Edit</span> › <span class="guimenu">Preferences</span>. Change to <span class="guimenu">Advanced</span> › <span class="guimenu">Encryption</span>
     and click <span class="guimenu">View Certificates</span>.
    </p></li><li class="step "><p>
     Import your certificate depending on your type: use
     <span class="guimenu">Servers</span> to import server certificate,
     <span class="guimenu">People</span> to identify other, and <span class="guimenu">Your
     Certificates</span> to identify yourself.
    </p></li></ol></div></div></div></div><div class="chapter " id="cha.aide"><div class="titlepage"><div><div><h2 class="title"><span class="number">13 </span><span class="name">Intrusion Detection with AIDE</span> <a title="Permalink" class="permalink" href="#cha.aide">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_aide.xml</li><li><span class="ds-label">ID: </span>cha.aide</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712068938496">#</a></h6></div><p>
    Securing your systems is a mandatory task for any mission-critical
    system administrator. Because it is impossible to always guarantee that
    the system is not compromised, it is very important to do extra checks
    regularly (for example with
    <code class="systemitem">cron</code>) to ensure that the system
    is still under your control. This is where AIDE, the
    <span class="emphasis"><em>Advanced Intrusion Detection Environment</em></span>, comes
    into play.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.aide.why"><span class="number">13.1 </span><span class="name">Why Use AIDE?</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.setup"><span class="number">13.2 </span><span class="name">Setting Up an AIDE Database</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.check"><span class="number">13.3 </span><span class="name">Local AIDE Checks</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.independent"><span class="number">13.4 </span><span class="name">System Independent Checking</span></a></span></dt><dt><span class="sect1"><a href="#sec.aide.more"><span class="number">13.5 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.aide.why"><div class="titlepage"><div><div><h2 class="title" id="sec.aide.why"><span class="number">13.1 </span><span class="name">Why Use AIDE?</span> <a title="Permalink" class="permalink" href="#sec.aide.why">#</a></h2></div></div></div><p>
   An easy check that often can reveal unwanted changes can be done by means
   of RPM. The package manager has a built-in verify function that checks
   all the managed files in the system for changes. To verify of all files,
   run the command <code class="command">rpm -Va</code>. However, this command will
   also display changes in configuration files and you will need to do some
   filtering to detect important changes.
  </p><p>
   An additional problem to the method with RPM is that an intelligent
   attacker will modify <code class="command">rpm</code> itself to hide any changes
   that might have been done by some kind of root-kit which allows the
   attacker to mask its intrusion and gain root privilege. To solve this,
   you should implement a secondary check that can also be run completely
   independent of the installed system.
  </p></div><div class="sect1 " id="sec.aide.setup"><div class="titlepage"><div><div><h2 class="title" id="sec.aide.setup"><span class="number">13.2 </span><span class="name">Setting Up an AIDE Database</span> <a title="Permalink" class="permalink" href="#sec.aide.setup">#</a></h2></div></div></div><div id="idm140712068929856" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Initialize AIDE Database After Installation</h6><p>
    Before you install your system, verify the checksum of your medium (see
    <span class="intraxref">Book “<em class="citetitle ">Start-Up</em>”, Chapter 4 “Troubleshooting”, Section 4.1 “Checking Media”</span>) to make sure you do not use
    a compromised source. After you have installed the system, initialize
    the AIDE database. To make sure that all went well during and
    after the installation, do an installation directly on the console,
    without any network attached to the computer. Do not leave the computer
    unattended or connected to any network before AIDE creates its
    database.
   </p></div><p>
   AIDE is not installed by default on <span class="productname"><span class="phrase">openSUSE Leap</span></span>. To install it,
   either use <span class="guimenu">Computer</span> › <span class="guimenu">Install
   Software</span>, or enter <code class="literal">zypper install
   aide</code> on the command line as <code class="systemitem">root</code>.
  </p><p>
   To tell AIDE which attributes of which files should be checked, use
   the <code class="filename">/etc/aide.conf</code> configuration file. It must be
   modified to become the actual configuration. The first section handles
   general parameters like the location of the AIDE database file. More
   relevant for local configurations are the <code class="systemitem">Custom
   Rules</code> and the <code class="systemitem">Directories and Files</code>
   sections. A typical rule looks like the following:
  </p><div class="verbatim-wrap"><pre class="screen">Binlib     = p+i+n+u+g+s+b+m+c+md5+sha1</pre></div><p>
   After defining the variable <code class="literal">Binlib</code>, the respective
   check boxes are used in the files section. Important options include the
   following:
  </p><div class="table" id="tab.aide.options"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 13.1: </span><span class="name">Important AIDE Check Boxes </span><a title="Permalink" class="permalink" href="#tab.aide.options">#</a></h6></div><div class="table-contents"><table summary="Important AIDE Check Boxes" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
       <p>
        Option
       </p>
      </th><th>
       <p>
        Description
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        p
       </p>
      </td><td>
       <p>
        Check for the file permissions of the selected files or directories.
       </p>
      </td></tr><tr><td>
       <p>
        i
       </p>
      </td><td>
       <p>
        Check for the inode number. Every file name has a unique inode
        number that should not change.
       </p>
      </td></tr><tr><td>
       <p>
        n
       </p>
      </td><td>
       <p>
        Check for the number of links pointing to the relevant file.
       </p>
      </td></tr><tr><td>
       <p>
        u
       </p>
      </td><td>
       <p>
        Check if the owner of the file has changed.
       </p>
      </td></tr><tr><td>
       <p>
        g
       </p>
      </td><td>
       <p>
        Check if the group of the file has changed.
       </p>
      </td></tr><tr><td>
       <p>
        s
       </p>
      </td><td>
       <p>
        Check if the file size has changed.
       </p>
      </td></tr><tr><td>
       <p>
        b
       </p>
      </td><td>
       <p>
        Check if the block count used by the file has changed.
       </p>
      </td></tr><tr><td>
       <p>
        m
       </p>
      </td><td>
       <p>
        Check if the modification time of the file has changed.
       </p>
      </td></tr><tr><td>
       <p>
        c
       </p>
      </td><td>
       <p>
        Check if the files access time has changed.
       </p>
      </td></tr><tr><td>
       <p>
        md5
       </p>
      </td><td>
       <p>
        Check if the md5 checksum of the file has changed.
       </p>
      </td></tr><tr><td>
       <p>
        sha1
       </p>
      </td><td>
       <p>
        Check if the sha1 (160 Bit) checksum of the file has changed.
       </p>
      </td></tr></tbody></table></div></div><p>
   This is a configuration that checks for all files in
   <code class="filename">/sbin</code> with the options defined in
   <code class="literal">Binlib</code> but omits the
   <code class="filename">/sbin/conf.d/</code> directory:
  </p><div class="verbatim-wrap"><pre class="screen">/sbin  Binlib
!/sbin/conf.d</pre></div><p>
   To create the AIDE database, proceed as follows:
  </p><div class="procedure " id="pro.aide.setup.db"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Open <code class="filename">/etc/aide.conf</code>.
    </p></li><li class="step "><p>
     Define which files should be checked with which check boxes. For a
     complete list of available check boxes, see
     <code class="filename">/usr/share/doc/packages/aide/manual.html</code>. The
     definition of the file selection needs some knowledge about regular
     expressions. Save your modifications.
    </p></li><li class="step "><p>
     To check whether the configuration file is valid, run:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide --config-check</pre></div><p>
     Any output of this command is a hint that the configuration is not
     valid. For example, if you get the following output:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide --config-check
35:syntax error:!
35:Error while reading configuration:!
Configuration error</pre></div><p>
     The error is to be expected in line 36 of
     <code class="filename">/etc/aide.conf</code>. Note that the error message
     contains the last successfully read line of the configuration file.
    </p></li><li class="step "><p>
     Initialize the AIDE database. Run the command:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide -i</pre></div></li><li class="step "><p>
     Copy the generated database to a save location like a CD-R or DVD-R, a
     remote server or a flash disk for later use.
    </p><div id="idm140712068875728" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: </h6><p>
      This step is essential as it avoids compromising your database. It is
      recommended to use a medium which can be written only once to prevent
      the database being modified. <span class="emphasis"><em>Never</em></span> leave the
      database on the computer which you want to monitor.
     </p></div></li></ol></div></div></div><div class="sect1 " id="sec.aide.check"><div class="titlepage"><div><div><h2 class="title" id="sec.aide.check"><span class="number">13.3 </span><span class="name">Local AIDE Checks</span> <a title="Permalink" class="permalink" href="#sec.aide.check">#</a></h2></div></div></div><p>
   To perform a file system check, proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Rename the database:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db</pre></div></li><li class="step "><p>
     After any configuration change, you always need to re-initialize the
     AIDE database and subsequently move the newly generated database.
     It is also a good idea to make a backup of this database. See
     <a class="xref" href="#sec.aide.setup" title="13.2. Setting Up an AIDE Database">Section 13.2, “Setting Up an AIDE Database”</a> for more information.
    </p></li><li class="step "><p>
     Perform the check with the following command:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide --check</pre></div></li></ol></div></div><p>
   If the output is empty, everything is fine. If AIDE found changes,
   it displays a summary of changes, for example:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide --check
AIDE found differences between database and filesystem!!

Summary:
  Total number of files:        1992
  Added files:                  0
  Removed files:                0
  Changed files:                1</pre></div><p>
   To learn about the actual changes, increase the verbose level of the
   check with the parameter <code class="literal">-V</code>. For the previous example,
   this could look like the following:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aide --check -V
AIDE found differences between database and filesystem!!
Start timestamp: 2009-02-18 15:14:10

Summary:
  Total number of files:        1992
  Added files:                  0
  Removed files:                0
  Changed files:                1


---------------------------------------------------
Changed files:
---------------------------------------------------

changed: /etc/passwd

--------------------------------------------------
Detailed information about changes:
---------------------------------------------------


File: /etc/passwd
  Mtime    : 2009-02-18 15:11:02              , 2009-02-18 15:11:47
  Ctime    : 2009-02-18 15:11:02              , 2009-02-18 15:11:47</pre></div><p>
   In this example, the file <code class="filename">/etc/passwd</code> was touched to
   demonstrate the effect.
  </p></div><div class="sect1 " id="sec.aide.independent"><div class="titlepage"><div><div><h2 class="title" id="sec.aide.independent"><span class="number">13.4 </span><span class="name">System Independent Checking</span> <a title="Permalink" class="permalink" href="#sec.aide.independent">#</a></h2></div></div></div><p>
   To avoid risk, it is advisable to also run the AIDE binary from a
   trusted source. This excludes the risk that some attacker also modified
   the aide binary to hide its traces.
  </p><p>
   To accomplish this task, AIDE must be run from a rescue system that
   is independent of the installed system. With <span class="productname"><span class="phrase">openSUSE Leap</span></span> it is
   relatively easy to extend the rescue system with arbitrary programs, and
   thus add the needed functionality.
  </p><p>
   Before you can start using the rescue system, you need to provide two
   packages to the system. These are included with the same syntax as you
   would add a driver update disk to the system. For a detailed description
   about the possibilities of linuxrc that are used for this purpose, see
   <a class="link" href="http://en.opensuse.org/SDB:Linuxrc" target="_blank">http://en.opensuse.org/SDB:Linuxrc</a>. In the
   following, one possible way to accomplish this task is discussed.
  </p><div class="procedure " id="idm140712068855168"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 13.1: </span><span class="name">Starting a Rescue System with AIDE </span><a title="Permalink" class="permalink" href="#idm140712068855168">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Provide an FTP server as a second machine.
    </p></li><li class="step "><p>
     Copy the packages <code class="systemitem">aide</code> and
     <code class="systemitem">mhash</code> to the FTP server directory, in our case
     <code class="filename">/srv/ftp/</code>. Replace the placeholders
     <em class="replaceable ">ARCH</em> and <em class="replaceable ">VERSION</em>
     with the corresponding values:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>cp DVD1/suse/<em class="replaceable ">ARCH</em>/aide<em class="replaceable ">VERSION</em>.<em class="replaceable ">ARCH</em>.rpm /srv/ftp
<code class="prompt root">root # </code>cp DVD1/suse/<em class="replaceable ">ARCH</em>/mhash<em class="replaceable ">VERSION</em>.<em class="replaceable ">ARCH</em>.rpm /srv/ftp</pre></div></li><li class="step "><p>
     Create an info file <code class="filename">/srv/ftp/info.txt</code> that
     provides the needed boot parameters for the rescue system:
    </p><div class="verbatim-wrap"><pre class="screen">dud:ftp://ftp.example.com/aide<em class="replaceable ">VERSION</em>.<em class="replaceable ">ARCH</em>.rpm
dud:ftp://ftp.example.com/mhash<em class="replaceable ">VERSION</em>.<em class="replaceable ">ARCH</em>.rpm</pre></div><p>
     Replace your FTP domain name, <em class="replaceable ">VERSION</em> and
     <em class="replaceable ">ARCH</em> with the values used on your system.
    </p></li><li class="step "><p>
     Restart the server that needs to go through an AIDE check with the
     Rescue system from your DVD. Add the following string to the boot
     parameters:
    </p><div class="verbatim-wrap"><pre class="screen">info=ftp://ftp.example.com/info.txt</pre></div><p>
     This parameter tells <code class="command">linuxrc</code> to also read in all
     information from the <code class="filename">info.txt</code> file.
    </p></li></ol></div></div><p>
   After the rescue system has booted, the AIDE program is ready for
   use.
  </p></div><div class="sect1 " id="sec.aide.more"><div class="titlepage"><div><div><h2 class="title" id="sec.aide.more"><span class="number">13.5 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.aide.more">#</a></h2></div></div></div><p>
   Information about AIDE is available at the following places:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     The home page of AIDE:
     <a class="link" href="http://aide.sourceforge.net" target="_blank">http://aide.sourceforge.net</a>
    </p></li><li class="listitem "><p>
     In the documented template configuration
     <code class="filename">/etc/aide.conf</code>.
    </p></li><li class="listitem "><p>
     In several files below
     <code class="filename">/usr/share/doc/packages/aide</code> after installing the
     <code class="systemitem">aide</code> package.
    </p></li><li class="listitem "><p>
     On the AIDE user mailing list at
     <a class="link" href="https://mailman.cs.tut.fi/mailman/listinfo/aide" target="_blank">https://mailman.cs.tut.fi/mailman/listinfo/aide</a>.
    </p></li></ul></div></div></div></div><div class="part" id="part.network_security"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part III </span><span class="name">Network Security </span><a title="Permalink" class="permalink" href="#part.network_security">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.xauth"><span class="number">14 </span><span class="name">X Window System and X Authentication</span></a></span></dt><dd class="toc-abstract"><p>As mentioned at the beginning, network transparency is one of the central characteristics of a Unix system. X, the windowing system of Unix operating systems, can use this feature in an impressive way. With X, it is no problem to log in to a remote host and start a graphical program that is then sen…</p></dd><dt><span class="chapter"><a href="#cha.ssh"><span class="number">15 </span><span class="name">SSH: Secure Network Operations</span></a></span></dt><dd class="toc-abstract"><p>
    In networked environments, it is often necessary to access hosts from a
    remote location. If a user sends login and password strings for
    authentication purposes as plain text, they could be intercepted and
    misused to gain access to that user account. This would open all the user's files to an attacker
    and the illegal account could be used to obtain administrator or
    <code class="systemitem">root</code> access, or to penetrate
    other systems. In the past, remote connections were established with
    <code class="command">telnet</code>, <code class="command">rsh</code> or
    <code class="command">rlogin</code>, which offered no guards against eavesdropping
    in the form of encryption or other security mechanisms. There are other
    unprotected communication channels, like the traditional FTP protocol
    and some remote copying programs like <code class="command">rcp</code>.
   </p></dd><dt><span class="chapter"><a href="#cha.security.firewall"><span class="number">16 </span><span class="name">Masquerading and Firewalls</span></a></span></dt><dd class="toc-abstract"><p>Whenever Linux is used in a network environment, you can use the kernel functions that allow the manipulation of network packets to maintain a separation between internal and external network areas. The Linux netfilter framework provides the means to establish an effective firewall that keeps differ…</p></dd><dt><span class="chapter"><a href="#cha.security.vpnserver"><span class="number">17 </span><span class="name">Configuring a VPN Server</span></a></span></dt><dd class="toc-abstract"><p>
    Today, Internet connections are cheap and available almost
    everywhere. However, not all connections are secure.
    Using a Virtual Private Network (VPN), you can create a secure network
    within an insecure network such as the Internet or Wi-Fi. It can be
    implemented in different ways and serves several purposes. In this chapter,
    we focus on the
    <a class="link" href="http://www.openvpn.net" target="_blank">OpenVPN</a> implementation
    to link branch offices via secure wide area networks (WANs).

        </p></dd><dt><span class="chapter"><a href="#cha.security.yast_ca"><span class="number">18 </span><span class="name">Managing X.509 Certification</span></a></span></dt><dd class="toc-abstract"><p>
    An increasing number of authentication mechanisms are based on
    cryptographic procedures. Digital certificates that assign cryptographic
    keys to their owners play an important role in this context. These
    certificates are used for communication and can also be found, for
    example, on company ID cards. The generation and administration of
    certificates is mostly handled by official institutions that offer this
    as a commercial service. In some cases, however, it may make sense to
    carry out these tasks yourself. For example, if a company does not want
    to pass personal data to third parties.
   </p><p>
    YaST provides two modules for certification, which offer basic
    management functions for digital X.509 certificates. The following
    sections explain the basics of digital certification and how to use
    YaST to create and administer certificates of this type.
   </p></dd></dl></div><div class="chapter " id="cha.xauth"><div class="titlepage"><div><div><h2 class="title"><span class="number">14 </span><span class="name">X Window System and X Authentication</span> <a title="Permalink" class="permalink" href="#cha.xauth">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_xforwarding.xml</li><li><span class="ds-label">ID: </span>cha.xauth</li></ul></div></div></div></div><div class="line"></div><p>
  As mentioned at the beginning, network transparency is one of the
  central characteristics of a Unix system. X, the windowing system of
  Unix operating systems, can use this feature in an impressive
  way. With X, it is no problem to log in to a remote host and start a
  graphical program that is then sent over the network to be displayed on
  your computer.
 </p><p>
  When an X client needs to be displayed remotely using an X server,
  the latter should protect the resource managed by it (the display)
  from unauthorized access. In more concrete terms, certain permissions
  must be given to the client program. With the X Window System, there
  are two ways to do this, called host-based access control and
  cookie-based access control. The former relies on the IP address of
  the host where the client should run. The program to control this is
  <code class="command">xhost</code>. <code class="command">xhost</code> enters the IP
  address of a legitimate client into a database belonging to the X
  server. However, relying on IP addresses for authentication is not
  very secure. For example, if there were a second user working on the
  host sending the client program, that user would have access to the X
  server as well—like someone spoofing the IP address. Because of
  these shortcomings, this authentication method is not described in
  more detail here, but you can learn about it with
  <code class="command">man</code> <code class="option">xhost</code>.
 </p><p>
  In the case of cookie-based access control, a character string is
  generated that is only known to the X server and to the legitimate
  user, like an ID card of some kind. This cookie is stored on login in
  the file <code class="filename">.Xauthority</code> in the user's home directory
  and is available to any X client wanting to use the X server to display
  a window. The file <code class="filename">.Xauthority</code> can be examined by
  the user with the tool <code class="command">xauth</code>. If you rename
  <code class="filename">.Xauthority</code>, or if you delete the file from your
  home directory by accident, you would not be able to open any new
  windows or X clients.
 </p><p>
  SSH (secure shell) can be used to encrypt a network connection and
  forward it to an X server transparently. This is also called X
  forwarding. X forwarding is achieved by simulating an X server on the
  server side and setting a DISPLAY variable for the shell on the
  remote host. Further details about SSH can be found in <a class="xref" href="#cha.ssh" title="Chapter 15. SSH: Secure Network Operations">Chapter 15, <em>SSH: Secure Network Operations</em></a>.
 </p><div id="idm140712068814432" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: X Forwarding Can Be Insecure</h6><p>
   If you do not consider the computer where you log in to be a secure host,
   do not use X forwarding. If X forwarding is enabled, an attacker could
   authenticate via your SSH connection. The attacker could then intrude
   on your X server and, for example, read your keyboard input.
  </p></div></div><div class="chapter " id="cha.ssh"><div class="titlepage"><div><div><h2 class="title"><span class="number">15 </span><span class="name">SSH: Secure Network Operations</span> <a title="Permalink" class="permalink" href="#cha.ssh">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_ssh.xml</li><li><span class="ds-label">ID: </span>cha.ssh</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712068809968">#</a></h6></div><p>
    In networked environments, it is often necessary to access hosts from a
    remote location. If a user sends login and password strings for
    authentication purposes as plain text, they could be intercepted and
    misused to gain access to that user account. This would open all the user's files to an attacker
    and the illegal account could be used to obtain administrator or
    <code class="systemitem">root</code> access, or to penetrate
    other systems. In the past, remote connections were established with
    <code class="command">telnet</code>, <code class="command">rsh</code> or
    <code class="command">rlogin</code>, which offered no guards against eavesdropping
    in the form of encryption or other security mechanisms. There are other
    unprotected communication channels, like the traditional FTP protocol
    and some remote copying programs like <code class="command">rcp</code>.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.ssh.programm"><span class="number">15.1 </span><span class="name"><code class="command">ssh</code>—Secure Shell</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.copy"><span class="number">15.2 </span><span class="name"><code class="command">scp</code>—Secure Copy</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.sftp"><span class="number">15.3 </span><span class="name"><code class="command">sftp</code>—Secure File Transfer</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.sshdserver"><span class="number">15.4 </span><span class="name">The SSH Daemon (<code class="systemitem">sshd</code>)</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.authentic"><span class="number">15.5 </span><span class="name">SSH Authentication Mechanisms</span></a></span></dt><dt><span class="sect1"><a href="#sec.ssh.port-forwarding"><span class="number">15.6 </span><span class="name">Port Forwarding</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.ssh.moreinfo"><span class="number">15.7 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><p>
  The SSH suite provides the necessary protection by encrypting the
  authentication strings (usually a login name and a password) and all the
  other data exchanged between the hosts. With SSH, the data flow could
  still be recorded by a third party, but the contents are encrypted and
  cannot be reverted to plain text unless the encryption key is known. So
  SSH enables secure communication over insecure networks, such as the
  Internet. The SSH implementation coming with <span class="productname"><span class="phrase">openSUSE Leap</span></span> is OpenSSH.
 </p><p>
  <span class="productname"><span class="phrase">openSUSE Leap</span></span> installs the OpenSSH package by default providing the
  commands <code class="command">ssh</code>, <code class="command">scp</code>, and
  <code class="command">sftp</code>. In the default configuration, remote access of a
  <span class="productname"><span class="phrase">openSUSE Leap</span></span> system is only possible with the OpenSSH utilities, and
  only if the <code class="systemitem">sshd</code> is running and
  the firewall permits access.
 </p><p>
  SSH on <span class="productname"><span class="phrase">openSUSE Leap</span></span> uses cryptographic hardware acceleration
  if available. As a result, the transfer of large quantities of data
  through an SSH connection is considerably faster than without
  cryptographic hardware. As an additional benefit, the CPU will see a
  significant reduction in load.
 </p><div class="sect1 " id="sec.ssh.programm"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.programm"><span class="number">15.1 </span><span class="name"><code class="command">ssh</code>—Secure Shell</span> <a title="Permalink" class="permalink" href="#sec.ssh.programm">#</a></h2></div></div></div><p>
   With <code class="command">ssh</code> it is possible to log in to remote
   systems and to work interactively. To log in to the host
   <code class="literal">sun</code> as user <code class="systemitem">tux</code> enter one of
   the following commands:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ssh tux@sun
<code class="prompt user">tux &gt; </code>ssh -l tux sun</pre></div><p>
   If the user name is the same on both machines, you can omit it. Using
   <code class="command">ssh sun</code> is sufficient. The remote host
   prompts for the remote user's password. After a successful
   authentication, you can work on the remote command line or use
   interactive applications, such as YaST in text mode.
  </p><p>
   Furthermore, <code class="command">ssh</code> offers the possibility to run
   non-interactive commands on remote systems using <code class="command">ssh</code>
   <em class="replaceable ">HOST</em> <em class="replaceable ">COMMAND</em>.
   <em class="replaceable ">COMMAND</em> needs to be properly quoted. Multiple
   commands can be concatenated as on a local shell.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ssh root@sun "dmesg -T | tail -n 25"
<code class="prompt user">tux &gt; </code>ssh root@sun "cat /etc/issue &amp;&amp; uptime"</pre></div><div class="sect2 " id="sec.ssh.programm.x"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.programm.x"><span class="number">15.1.1 </span><span class="name">Starting X Applications on a Remote Host</span> <a title="Permalink" class="permalink" href="#sec.ssh.programm.x">#</a></h3></div></div></div><p>
    SSH also simplifies the use of remote X applications. If you run
    <code class="command">ssh</code> with the <code class="option">-X</code> option, the
    <code class="envar">DISPLAY</code> variable is automatically set on the remote
    machine and all X output is exported to the local machine over the
    existing SSH connection. At the same time, X applications started
    remotely cannot be intercepted by unauthorized individuals.
   </p></div><div class="sect2 " id="sec.ssh.programm.forwarding"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.programm.forwarding"><span class="number">15.1.2 </span><span class="name">Agent Forwarding</span> <a title="Permalink" class="permalink" href="#sec.ssh.programm.forwarding">#</a></h3></div></div></div><p>
    By adding the <code class="option">-A</code> option, the ssh-agent authentication
    mechanism is carried over to the next machine. This way, you can work
    from different machines without having to enter a password, but only if
    you have distributed your public key to the destination hosts and
    properly saved it there. Refer to
    <a class="xref" href="#sec.ssh.authentic.key_copy" title="15.5.2. Copying an SSH Key">Section 15.5.2, “Copying an SSH Key”</a> for details.
   </p><p>
    This mechanism is deactivated in the default settings, but can be
    permanently activated at any time in the systemwide configuration file
    <code class="filename">/etc/ssh/sshd_config</code> by setting
    <code class="literal">AllowAgentForwarding yes</code>.
   </p></div></div><div class="sect1 " id="sec.ssh.copy"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.copy"><span class="number">15.2 </span><span class="name"><code class="command">scp</code>—Secure Copy</span> <a title="Permalink" class="permalink" href="#sec.ssh.copy">#</a></h2></div></div></div><p>
   <code class="command">scp</code> copies files to or from a remote machine.  If
   the user name on jupiter is different than the user name on
   sun, specify the latter using the
   <code class="option"><em class="replaceable ">USER_NAME</em>@host</code> format. If
   the file should be copied into a directory other than the remote
   user's home directory, specify it as
   sun:<em class="replaceable ">DIRECTORY</em>. The following
   examples show how to copy a file from a local to a remote machine and
   vice versa.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>scp ~/MyLetter.tex tux@sun:/tmp <span id="co.scp.local.remote"></span><span class="callout">1</span>
<code class="prompt user">tux &gt; </code>scp tux@sun:/tmp/MyLetter.tex ~ <span id="co.scp.remote.local"></span><span class="callout">2</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.scp.local.remote"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>local to remote</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.scp.remote.local"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>remote to local</p></td></tr></table></div><div id="idm140712068768736" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: The <code class="option">-l</code> Option</h6><p>
    With the <code class="command">ssh</code> command, the option
    <code class="option">-l</code> can be used to specify a remote user (as an
    alternative to the
    <code class="option"><em class="replaceable ">USER_NAME</em>@host</code>
    format). With <code class="command">scp</code> the option <code class="option">-l</code>
    is used to limit the bandwidth consumed by <code class="command">scp</code>.
   </p></div><p>
   After the correct password is entered, <code class="command">scp</code> starts the
   data transfer. It displays a progress bar and the time remaining for each
   file that is copied. Suppress all output with the <code class="option">-q</code>
   option.
  </p><p>
   <code class="command">scp</code> also provides a recursive copying feature for
   entire directories. The command
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>scp -r src/ sun:backup/</pre></div><p>
   copies the entire contents of the directory <code class="filename">src</code>
   including all subdirectories to the <code class="filename">~/backup</code>
   directory on the host sun. If this subdirectory does not
   exist, it is created automatically.
  </p><p>
   The <code class="option">-p</code> option tells <code class="command">scp</code> to leave the
   time stamp of files unchanged. <code class="option">-C</code> compresses the data
   transfer. This minimizes the data volume to transfer, but creates a
   heavier burden on the processors of both machines.
  </p></div><div class="sect1 " id="sec.ssh.sftp"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.sftp"><span class="number">15.3 </span><span class="name"><code class="command">sftp</code>—Secure File Transfer</span> <a title="Permalink" class="permalink" href="#sec.ssh.sftp">#</a></h2></div></div></div><div class="sect2 " id="sec.ssh.sftp.using"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.sftp.using"><span class="number">15.3.1 </span><span class="name">Using <code class="command">sftp</code></span> <a title="Permalink" class="permalink" href="#sec.ssh.sftp.using">#</a></h3></div></div></div><p>
   If you want to copy several files from or to different locations,
   <code class="command">sftp</code> is a convenient alternative to
   <code class="command">scp</code>. It opens a shell with a set of commands similar
   to a regular FTP shell. Type <code class="command">help</code> at the sftp-prompt
   to get a list of available commands. More details are available from the
   <code class="command">sftp</code> man page.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>sftp sun
Enter passphrase for key '/home/tux/.ssh/id_rsa':
Connected to sun.
sftp&gt; help
Available commands:
bye                                Quit sftp
cd path                            Change remote directory to 'path'
[...]</pre></div></div><div class="sect2 " id="sec.ssh.sftp.perms"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.sftp.perms"><span class="number">15.3.2 </span><span class="name">Setting Permissions for File Uploads</span> <a title="Permalink" class="permalink" href="#sec.ssh.sftp.perms">#</a></h3></div></div></div><p>
    As with a regular FTP server, a user cannot only download,
        but also upload files to a remote machine running an SFTP server
        by using the <code class="command">put</code> command. By default the
        files will be uploaded to the remote host with the same
        permissions as on the local host. There are two options to
        automatically alter these permissions:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712068747872"><span class="term ">Setting a umask</span></dt><dd><p>
       A umask works as a filter against the permissions of the original
       file on the local host. It can only withdraw permissions:
      </p><div class="table" id="idm140712068746272"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 15.1: </span><span class="name"> </span><a title="Permalink" class="permalink" href="#idm140712068746272">#</a></h6></div><div class="table-contents"><table summary="" border="1"><colgroup><col class="1" /><col class="2" /><col class="3" /></colgroup><thead><tr><th>
           <p>
            permissions original
           </p>
          </th><th>
           <p>
            umask
           </p>
          </th><th>
           <p>
            permissions uploaded
           </p>
          </th></tr></thead><tbody><tr><td>
           <p>
            0666
           </p>
          </td><td>
           <p>
            0002
           </p>
          </td><td>
           <p>
            0664
           </p>
          </td></tr><tr><td>
           <p>
            0600
           </p>
          </td><td>
           <p>
            0002
           </p>
          </td><td>
           <p>
            0600
           </p>
          </td></tr><tr><td>
           <p>
            0775
           </p>
          </td><td>
           <p>
            0025
           </p>
          </td><td>
           <p>
            0750
           </p>
          </td></tr></tbody></table></div></div><p>
       To apply a umask on an SFTP server, edit the file
       <code class="filename">/etc/ssh/sshd_configuration</code>. Search for the line
       beginning with <code class="literal">Subsystem sftp</code> and add the
       <code class="option">-u</code> parameter with the desired setting, for example:
      </p><div class="verbatim-wrap"><pre class="screen">Subsystem sftp /usr/lib/ssh/sftp-server -u 0002</pre></div></dd><dt id="idm140712068725104"><span class="term ">Explicitly Setting the Permissions</span></dt><dd><p>
       Explicitly setting the permissions sets the same permissions for all
       files uploaded via SFTP. Specify a three-digit pattern such as
       <code class="literal">600</code>, <code class="literal">644</code>, or
       <code class="literal">755</code> with <code class="option">-u</code>. When both
       <code class="option">-m</code> and <code class="option">-u</code> are specified,
       <code class="literal">-u</code> is ignored.
      </p><p>
       To apply explicit permissions for uploaded files on an SFTP server,
       edit the file <code class="filename">/etc/ssh/sshd_configuration</code>.
       Search for the line beginning with <code class="literal">Subsystem sftp</code>
       and add the <code class="option">-m</code> parameter with the desired setting,
       for example:
      </p><div class="verbatim-wrap"><pre class="screen">Subsystem sftp /usr/lib/ssh/sftp-server -m 600</pre></div></dd></dl></div></div></div><div class="sect1 " id="sec.ssh.sshdserver"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.sshdserver"><span class="number">15.4 </span><span class="name">The SSH Daemon (<code class="systemitem">sshd</code>)</span> <a title="Permalink" class="permalink" href="#sec.ssh.sshdserver">#</a></h2></div></div></div><p>
   To work with the SSH client programs <code class="command">ssh</code> and
   <code class="command">scp</code>, a server (the SSH daemon) must be running in the
   background, listening for connections on <code class="literal">TCP/IP port
   22</code>. The daemon generates three key pairs when starting for the
   first time. Each key pair consists of a private and a public key.
   Therefore, this procedure is called public key-based. To
   guarantee the security of the communication via SSH, access to the
   private key files must be restricted to the system administrator. The
   file permissions are set accordingly by the default installation. The
   private keys are only required locally by the SSH daemon and must not be
   given to anyone else. The public key components (recognizable by the name
   extension <code class="filename">.pub</code>) are sent to the client requesting
   the connection. They are readable for all users.
  </p><p>
   A connection is initiated by the SSH client. The waiting SSH daemon and
   the requesting SSH client exchange identification data to compare the
   protocol and software versions, and to prevent connections through the
   wrong port. Because a child process of the original SSH daemon replies to
   the request, several SSH connections can be made simultaneously.
  </p><p>
   For the communication between SSH server and SSH client, OpenSSH supports
   versions 1 and 2 of the SSH protocol. Version 2 of the
   SSH protocol is used by default. Override this to use version 1
   of protocol with the <code class="option">-1</code> option.
  </p><p>
   When using version 1 of SSH, the server sends its public host key
   and a server key, which is regenerated by the SSH daemon every hour. Both
   allow the SSH client to encrypt a freely chosen session key, which is
   sent to the SSH server. The SSH client also tells the server which
   encryption method (cipher) to use. Version 2 of the SSH protocol
   does not require a server key. Both sides use an algorithm according to
   Diffie-Hellman to exchange their keys.
  </p><p>
   The private host and server keys are absolutely required to decrypt the
   session key and cannot be derived from the public parts. Only the
   contacted SSH daemon can decrypt the session key using its private keys.
   This initial connection phase can be watched closely by turning on
   verbose debugging using the <code class="option">-v</code> option of the SSH client.
  </p><div id="idm140712068708240" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Viewing the SSH Daemon Log File</h6><p>
    To watch the log entries from the <code class="systemitem">sshd</code> use the following command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> journalctl -u sshd</pre></div></div><div class="sect2 " id="idm140712068705104"><div class="titlepage"><div><div><h3 class="title" id="idm140712068705104"><span class="number">15.4.1 </span><span class="name">Maintaining SSH Keys</span> <a title="Permalink" class="permalink" href="#idm140712068705104">#</a></h3></div></div></div><p>
   It is recommended to back up the private and public keys stored in
   <code class="filename">/etc/ssh/</code> in a secure, external location. In this
   way, key modifications can be detected or the old ones can be used again
   after having installed a new system.
  </p><div id="idm140712068703264" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Existing SSH Host Keys</h6><p>
    If you install <span class="productname"><span class="phrase">openSUSE Leap</span></span> on a machine with existing Linux
    installations, the installation routine automatically imports the SSH
    host key with the most recent access time from an existing installation.
   </p></div><p>
   When establishing a secure connection with a remote host for the first
   time, the client stores all public host keys in
   <code class="filename">~/.ssh/known_hosts</code>. This prevents any
   man-in-the-middle attacks—attempts by foreign SSH servers to use
   spoofed names and IP addresses. Such attacks are detected either by a
   host key that is not included in <code class="filename">~/.ssh/known_hosts</code>,
   or by the server's inability to decrypt the session key in the absence of
   an appropriate private counterpart.
  </p><p>
   If the public keys of a host have changed (that needs to be verified
   before connecting to such a server), the offending keys can be
   removed with <code class="command">ssh-keygen -r
   <em class="replaceable ">HOSTNAME</em></code>.
  </p></div><div class="sect2 " id="sec.ssh.sshdserver.rotating"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.sshdserver.rotating"><span class="number">15.4.2 </span><span class="name">Rotating Host Keys</span> <a title="Permalink" class="permalink" href="#sec.ssh.sshdserver.rotating">#</a></h3></div></div></div><p>
    As of version 6.8, OpenSSH comes with a protocol extension that
    supports host key rotation.  It makes sense to replace keys, if you
    are still using weak keys such as 1024-bit RSA keys.  It is strongly
    recommended to replace such a key and go for 2048-bit DSA keys or
    something even better.  The client will then use the
    <span class="quote">“<span class="quote">best</span>”</span> host key.
   </p><div id="idm140712068694976" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Restarting sshd</h6><p>
     After installing new host keys on the server, restart sshd.
    </p></div><p>
    This protocol extension can
    inform a client of all the new host keys on the server, if the user
    initiates a connection with <code class="command">ssh</code>.  Then, the
    software on the client updates
    <code class="filename">~/.ssh/known_hosts</code>, and the user is not
    required to accept new keys of previously known and trusted hosts
    manually.  The local <code class="filename">known_hosts</code> file will
    contain all the host keys of the remote hosts, in addition to the
    one that authenticated the host during this session.
   </p><p>
    Once the administrator of the server knows that all the clients have
    fetched the new keys, they can remove the old keys. The protocol
    extension ensures that the obsolete keys will be removed from the
    client's configuration, too. The key removal occurs while initiating
    an <code class="command">ssh</code> session.
   </p><p>
    For more information, see:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      <a class="link" href="http://blog.djm.net.au/2015/02/key-rotation-in-openssh-68.html" target="_blank">http://blog.djm.net.au/2015/02/key-rotation-in-openssh-68.html</a>
     </p></li><li class="listitem "><p>
      <a class="link" href="http://heise.de/-2540907" target="_blank">http://heise.de/-2540907</a>
      (<span class="quote">“<span class="quote">Endlich neue Schlüssel für SSH-Server</span>”</span>, German only)
     </p></li></ul></div></div></div><div class="sect1 " id="sec.ssh.authentic"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.authentic"><span class="number">15.5 </span><span class="name">SSH Authentication Mechanisms</span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic">#</a></h2></div></div></div><p>
   In its simplest form, authentication is done by entering the user's
   password just as if logging in locally. However, having to memorize
   passwords of several users on remote machines is inefficient. What is
   more, these passwords may change. On the other hand—when
   granting <code class="systemitem">root</code> access—an administrator needs to be able
   to quickly revoke such a permission without having to change the
   <code class="systemitem">root</code> password.
  </p><p>
   To accomplish a login that does not require to enter the remote
   user's password, SSH uses another key pair, which needs to be generated
   by the user. It consists of a public (<code class="filename">id_rsa.pub</code> or
   <code class="filename">id_dsa.pub</code>) and a private key
   (<code class="filename">id_rsa</code> or <code class="filename">id_dsa</code>).
  </p><p>
   To be able to log in without having to specify the remote user's
   password, the public key of the <span class="quote">“<span class="quote">SSH user</span>”</span> must be
   in <code class="filename">~/.ssh/authorized_keys</code>. This approach also
   ensures that the remote user has got full control: adding the key
   requires the remote user's password and removing the key revokes the
   permission to log in from remote.
  </p><p>
   For maximum security such a key should be protected by a passphrase which
   needs to be entered every time you use <code class="command">ssh</code>,
   <code class="command">scp</code>, or <code class="command">sftp</code>. Contrary to the
   simple authentication, this passphrase is independent from the remote
   user and therefore always the same.
  </p><p>
   An alternative to the key-based authentication described above, SSH also
   offers a host-based authentication. With host-based authentication, users
   on a trusted host can log in to another host on which this feature is
   enabled using the same user name. <span class="productname"><span class="phrase">openSUSE Leap</span></span> is set up for using
   key-based authentication, covering setting up host-based authentication
   on <span class="productname"><span class="phrase">openSUSE Leap</span></span> is beyond the scope of this manual.
  </p><div id="idm140712068673120" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: File Permissions for Host-Based Authentication</h6><p>
    If the host-based authentication is to be used, the file
    <code class="filename">/usr/lib/ssh/ssh-keysign</code> (32-bit systems) or
    <code class="filename">/usr/lib64/ssh/ssh-keysign</code> (64-bit systems) should
    have the setuid bit set, which is not the default setting in
    <span class="productname"><span class="phrase">openSUSE Leap</span></span>. In such case, set the file permissions manually. You
    should use <code class="filename">/etc/permissions.local</code> for this purpose,
    to make sure that the setuid bit is preserved after security updates of
    <span class="package">openssh</span>.
   </p></div><div class="sect2 " id="sec.ssh.authentic.gen_key"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.authentic.gen_key"><span class="number">15.5.1 </span><span class="name">Generating an SSH Key</span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic.gen_key">#</a></h3></div></div></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      To generate a key with default parameters (RSA, 2048 bits), enter the
      command <code class="command">ssh-keygen</code>.
     </p></li><li class="step "><p>
      Accept the default location to store the key
      (<code class="filename">~/.ssh/id_rsa</code>) by pressing
      <span class="keycap">Enter</span> (strongly recommended) or enter an
      alternative location.
     </p></li><li class="step "><p>
      Enter a passphrase consisting of 10 to 30 characters. The same rules
      as for creating safe passwords apply. It is strongly advised to
      refrain from specifying no passphrase.
     </p></li></ol></div></div><p>
    You should make absolutely sure that the private key is not accessible
    by anyone other than yourself (always set its permissions to
    <code class="literal">0600</code>). The private key must never fall into the hands
    of another person.
   </p><p>
    To change the password of an existing key pair, use the command
    <code class="command">ssh-keygen -p</code>.
   </p></div><div class="sect2 " id="sec.ssh.authentic.key_copy"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.authentic.key_copy"><span class="number">15.5.2 </span><span class="name">Copying an SSH Key</span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic.key_copy">#</a></h3></div></div></div><p>
    To copy a public SSH key to <code class="filename">~/.ssh/authorized_keys</code>
    of a user on a remote machine, use the command
    <code class="command">ssh-copy-id</code>. To copy your personal key
    stored under <code class="filename">~/.ssh/id_rsa.pub</code> you may use the
    short form. To copy DSA keys or keys of other users, you need
    to specify the path:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="prompt user">~/.ssh/id_rsa.pub</code>
ssh-copy-id -i tux@sun

<code class="prompt user">tux &gt; </code><code class="prompt user">~/.ssh/id_dsa.pub</code>
ssh-copy-id -i ~/.ssh/id_dsa.pub  tux@sun

<code class="prompt user">tux &gt; </code><code class="prompt user">~notme/.ssh/id_rsa.pub</code>
ssh-copy-id -i ~notme/.ssh/id_rsa.pub  tux@sun</pre></div><p>
    To successfully copy the key, you need to enter the remote
    user's password. To remove an existing key, manually edit
    <code class="filename">~/.ssh/authorized_keys</code>.
   </p></div><div class="sect2 " id="sec.ssh.authentic.agent"><div class="titlepage"><div><div><h3 class="title" id="sec.ssh.authentic.agent"><span class="number">15.5.3 </span><span class="name">Using the <code class="command">ssh-agent</code></span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic.agent">#</a></h3></div></div></div><p>
    When doing lots of secure shell operations it is cumbersome to type the
    SSH passphrase for each such operation. Therefore, the SSH package
    provides another tool, <code class="command">ssh-agent</code>, which retains the
    private keys for the duration of an X or terminal session. All other
    windows or programs are started as clients to the
    <code class="command">ssh-agent</code>. By starting the agent, a set of
    environment variables is set, which will be used by
    <code class="command">ssh</code>, <code class="command">scp</code>, or
    <code class="command">sftp</code> to locate the agent for automatic login. See
    the <code class="command">ssh-agent</code> man page for details.
   </p><p>
    After the <code class="command">ssh-agent</code> is started, you need to add your
    keys by using <code class="command">ssh-add</code>. It will prompt for the
    passphrase. After the password has been provided once, you can use the
    secure shell commands within the running session without having to
    authenticate again.
   </p><div class="sect3 " id="sec.ssh.authentic.agent.x"><div class="titlepage"><div><div><h4 class="title" id="sec.ssh.authentic.agent.x"><span class="number">15.5.3.1 </span><span class="name">Using <code class="command">ssh-agent</code> in an X Session</span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic.agent.x">#</a></h4></div></div></div><p>
     On <span class="productname"><span class="phrase">openSUSE Leap</span></span>, the <code class="command">ssh-agent</code> is automatically
     started by the GNOME display manager. To also invoke
     <code class="command">ssh-add</code> to add your keys to the agent at the
     beginning of an X session, do the following:
    </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
       Log in as the desired user and check whether the file
       <code class="filename">~/.xinitrc</code> exists.
      </p></li><li class="step "><p>
       If it does not exist, use an existing template or copy it from
       <code class="filename">/etc/skel</code>:
      </p><div class="verbatim-wrap"><pre class="screen">if [ -f ~/.xinitrc.template ]; then mv ~/.xinitrc.template ~/.xinitrc; \
else cp /etc/skel/.xinitrc.template ~/.xinitrc; fi</pre></div></li><li class="step "><p>
       If you have copied the template, search for the following lines and
       uncomment them. If <code class="filename">~/.xinitrc</code> already existed,
       add the following lines (without comment signs).
      </p><div class="verbatim-wrap"><pre class="screen"># if test -S "$SSH_AUTH_SOCK" -a -x "$SSH_ASKPASS"; then
#       ssh-add &lt; /dev/null
# fi</pre></div></li><li class="step "><p>
       When starting a new X session, you will be prompted for your SSH
       passphrase.
      </p></li></ol></div></div></div><div class="sect3 " id="sec.ssh.authentic.agent.terminal"><div class="titlepage"><div><div><h4 class="title" id="sec.ssh.authentic.agent.terminal"><span class="number">15.5.3.2 </span><span class="name">Using <code class="command">ssh-agent</code> in a Terminal Session</span> <a title="Permalink" class="permalink" href="#sec.ssh.authentic.agent.terminal">#</a></h4></div></div></div><p>
     In a terminal session you need to manually start the
     <code class="command">ssh-agent</code> and then call <code class="command">ssh-add</code>
     afterward. There are two ways to start the agent. The first example
     given below starts a new Bash shell on top of your existing shell. The
     second example starts the agent in the existing shell and modifies the
     environment as needed.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>ssh-agent -s /bin/bash
eval $(ssh-agent)</pre></div><p>
     After the agent has been started, run <code class="command">ssh-add</code> to
     provide the agent with your keys.
    </p></div></div></div><div class="sect1 " id="sec.ssh.port-forwarding"><div class="titlepage"><div><div><h2 class="title" id="sec.ssh.port-forwarding"><span class="number">15.6 </span><span class="name">Port Forwarding</span> <a title="Permalink" class="permalink" href="#sec.ssh.port-forwarding">#</a></h2></div></div></div><p>
   <code class="command">ssh</code> can also be used to redirect TCP/IP connections.
   This feature, also called <code class="literal">SSH tunneling</code>, redirects TCP
   connections to a certain port to another machine via an encrypted
   channel.
  </p><p>
   With the following command, any connection directed to jupiter port 25
   (SMTP) is redirected to the SMTP port on sun. This is
   especially useful for those using SMTP servers without SMTP-AUTH or
   POP-before-SMTP features. From any arbitrary location connected to a
   network, e-mail can be transferred to the <span class="quote">“<span class="quote">home</span>”</span> mail server
   for delivery.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>ssh -L 25:sun:25 jupiter</pre></div><p>
   Similarly, all POP3 requests (port 110) on jupiter can be
   forwarded to the POP3 port of sun with this command:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>ssh -L 110:sun:110 jupiter</pre></div><p>
   Both commands must be executed as <code class="systemitem">root</code>, because the connection
   is made to privileged local ports. E-mail is sent and retrieved by
   normal users in an existing SSH connection. The SMTP and POP3 host
   must be set to <code class="literal">localhost</code> for this to
   work. Additional information can be found in the manual pages for
   each of the programs described above and in the OpenSSH package
   documentation under
   <code class="filename">/usr/share/doc/packages/openssh</code>.
  </p></div><div class="sect1 " id="sec.security.ssh.moreinfo"><div class="titlepage"><div><div><h2 class="title" id="sec.security.ssh.moreinfo"><span class="number">15.7 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.ssh.moreinfo">#</a></h2></div></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712068619232"><span class="term "><a class="link" href="http://www.openssh.com" target="_blank">http://www.openssh.com</a>
    </span></dt><dd><p>
      The home page of OpenSSH
     </p></dd><dt id="idm140712068617072"><span class="term "><a class="link" href="http://en.wikibooks.org/wiki/OpenSSH" target="_blank">http://en.wikibooks.org/wiki/OpenSSH</a>
    </span></dt><dd><p>
      The OpenSSH Wikibook
     </p></dd><dt id="idm140712068614848"><span class="term "><code class="command">man sshd</code>
    </span></dt><dd><p>
      The man page of the OpenSSH daemon
     </p></dd><dt id="idm140712068612736"><span class="term "><code class="command">man ssh_config</code>
    </span></dt><dd><p>
      The man page of the OpenSSH SSH client configuration files
     </p></dd><dt id="idm140712068610608"><span class="term "><code class="command">man scp</code>
    , </span><span class="term "><code class="command">man sftp</code>
    , </span><span class="term "><code class="command">man slogin</code>
    , </span><span class="term "><code class="command">man ssh</code>
    , </span><span class="term "><code class="command">man ssh-add</code>
    , </span><span class="term "><code class="command">man ssh-agent</code>
    , </span><span class="term "><code class="command">man ssh-copy-id</code>
    , </span><span class="term "><code class="command">man ssh-keyconvert</code>
    , </span><span class="term "><code class="command">man ssh-keygen</code>
    , </span><span class="term "><code class="command">man ssh-keyscan</code>
    </span></dt><dd><p>
      Man pages of several binary files to securely copy files
      (<code class="command">scp</code>, <code class="command">sftp</code>), to log in
      (<code class="command">slogin</code>, <code class="command">ssh</code>), and to manage
      keys.
     </p></dd><dt id="idm140712068600048"><span class="term ">
     <code class="filename">/usr/share/doc/packages/openssh/README.SUSE</code>
    , </span><span class="term ">
     <code class="filename">/usr/share/doc/packages/openssh/README.FIPS</code>
    </span></dt><dd><p>
      SUSE package specific documentation; changes in defaults with respect to
      upstream, notes on FIPS mode etc.
     </p></dd></dl></div></div></div><div class="chapter " id="cha.security.firewall"><div class="titlepage"><div><div><h2 class="title"><span class="number">16 </span><span class="name">Masquerading and Firewalls</span> <a title="Permalink" class="permalink" href="#cha.security.firewall">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_firewall.xml</li><li><span class="ds-label">ID: </span>cha.security.firewall</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.firewall.iptables"><span class="number">16.1 </span><span class="name">Packet Filtering with iptables</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.masq"><span class="number">16.2 </span><span class="name">Masquerading Basics</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.fw"><span class="number">16.3 </span><span class="name">Firewalling Basics</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.firewalld"><span class="number">16.4 </span><span class="name"><code class="systemitem">firewalld</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.security.firewall.info"><span class="number">16.5 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><p>
  Whenever Linux is used in a network environment, you can use the
  kernel functions that allow the manipulation of network packets to
  maintain a separation between internal and external network areas. The
  Linux <code class="systemitem">netfilter</code> framework provides the means
  to establish an effective firewall that keeps different networks
  apart. Using iptables—a generic table structure for the
  definition of rule sets—precisely controls the packets allowed to
  pass a network interface. Such a packet filter can be set up using
  <code class="systemitem">firewalld</code> and its graphical interface <code class="command">firewall-config</code>.
 </p><div class="sect1 " id="sec.security.firewall.iptables"><div class="titlepage"><div><div><h2 class="title" id="sec.security.firewall.iptables"><span class="number">16.1 </span><span class="name">Packet Filtering with iptables</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.iptables">#</a></h2></div></div></div><p>
   This section discusses the low-level details of packet filtering. The
   components <code class="systemitem">netfilter</code> and
   <code class="systemitem">iptables</code> are responsible for the filtering and
   manipulation of network packets and for network address translation (NAT).
   The filtering criteria and any actions associated with them are stored in
   chains, which must be matched one after another by individual network
   packets as they arrive. The chains to match are stored in tables. The
   <code class="command">iptables</code> command allows you to alter these tables and
   rule sets.
  </p><p>
   The Linux kernel maintains three tables, each for a particular category
   of functions of the packet filter:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712068585584"><span class="term ">filter</span></dt><dd><p>
      This table holds the bulk of the filter rules, because it implements
      the <span class="emphasis"><em>packet filtering</em></span> mechanism in the stricter
      sense, which determines whether packets are let through
      (<code class="literal">ACCEPT</code>) or discarded (<code class="literal">DROP</code>),
      for example.
     </p></dd><dt id="idm140712068582288"><span class="term ">nat</span></dt><dd><p>
      This table defines any changes to the source and target addresses of
      packets. Using these functions also allows you to implement
      <span class="emphasis"><em>masquerading</em></span>, which is a special case of NAT used
      to link a private network with the Internet.
     </p></dd><dt id="idm140712068579840"><span class="term ">mangle</span></dt><dd><p>
      The rules held in this table make it possible to manipulate values
      stored in IP headers (such as the type of service).
     </p></dd></dl></div><p>
   These tables contain several predefined chains to match packets:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712068576976"><span class="term ">PREROUTING</span></dt><dd><p>
      This chain is applied to all incoming packets.
     </p></dd><dt id="idm140712068575136"><span class="term ">INPUT</span></dt><dd><p>
      This chain is applied to packets destined for the system's internal
      processes.
     </p></dd><dt id="idm140712068573264"><span class="term ">FORWARD</span></dt><dd><p>
      This chain is applied to packets that are only routed through the
      system.
     </p></dd><dt id="idm140712068571392"><span class="term ">OUTPUT</span></dt><dd><p>
      This chain is applied to packets originating from the system itself.
     </p></dd><dt id="idm140712068569536"><span class="term ">POSTROUTING</span></dt><dd><p>
      This chain is applied to all outgoing packets.
     </p></dd></dl></div><p>
   <a class="xref" href="#fig.fire.table" title="iptables: A Packet's Possible Paths">Figure 16.1, “iptables: A Packet's Possible Paths”</a> illustrates the paths along which a
   network packet may travel on a given system. For the sake of simplicity,
   the figure lists tables as parts of chains, but in reality these chains
   are held within the tables themselves.
  </p><p>
   In the simplest case, an incoming packet destined for the system itself
   arrives at the <code class="literal">eth0</code> interface. The packet is first
   referred to the <code class="literal">PREROUTING</code> chain of the
   <code class="literal">mangle</code> table then to the <code class="literal">PREROUTING</code>
   chain of the <code class="literal">nat</code> table. The following step, concerning
   the routing of the packet, determines that the actual target of the
   packet is a process of the system itself. After passing the
   <code class="literal">INPUT</code> chains of the <code class="literal">mangle</code> and the
   <code class="literal">filter</code> table, the packet finally reaches its target,
   provided that the rules of the <code class="literal">filter</code> table allow this.
  </p><div class="figure" id="fig.fire.table"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/fire_tables.png"><img src="images/fire_tables.png" width="" alt="iptables: A Packet's Possible Paths" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 16.1: </span><span class="name">iptables: A Packet's Possible Paths </span><a title="Permalink" class="permalink" href="#fig.fire.table">#</a></h6></div></div></div><div class="sect1 " id="sec.security.firewall.masq"><div class="titlepage"><div><div><h2 class="title" id="sec.security.firewall.masq"><span class="number">16.2 </span><span class="name">Masquerading Basics</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.masq">#</a></h2></div></div></div><p>
   Masquerading is the Linux-specific form of NAT (network address
   translation) and can be used to connect a small LAN with the
   Internet.  LAN hosts use IP
   addresses from the private range (see
   <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 13 “Basic Networking”, Section 13.1.2 “Netmasks and Routing”</span>) and on the Internet
   official IP addresses are used. To be able to connect
   to the Internet, a LAN host's private address is translated to an official
   one. This is done on the router, which acts as the gateway between the
   LAN and the Internet. The underlying principle is a simple one: The
   router has more than one network interface, typically a network card and
   a separate interface connecting with the Internet. While the latter links
   the router with the outside world, one or several others link it with the
   LAN hosts. With these hosts in the local network connected to the network
   card (such as <code class="literal">eth0</code>) of the router, they can send any
   packets not destined for the local network to their default gateway or
   router.
  </p><div id="idm140712068552368" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Using the Correct Network Mask</h6><p>
    When configuring your network, make sure both the broadcast address and
    the netmask are the same for all local hosts. Failing to do so prevents
    packets from being routed properly.
   </p></div><p>
   As mentioned, whenever one of the LAN hosts sends a packet destined for
   an Internet address, it goes to the default router. However, the router
   must be configured before it can forward such packets. For security
   reasons, this is not enabled in a default installation. To enable it, add
   the line <code class="literal">net.ipv4.ip_forward = 1</code> in the file
   <code class="filename">/etc/sysctl.conf</code>. Alternatively do this via YaST,
   for example by calling <code class="command">yast routing ip-forwarding on</code>.
  </p><p>
   The target host of the connection can see your router, but knows nothing
   about the host in your internal network where the packets originated.
   This is why the technique is called masquerading. Because of the address
   translation, the router is the first destination of any reply packets.
   The router must identify these incoming packets and translate their
   target addresses, so packets can be forwarded to the correct host in the
   local network.
  </p><p>
   With the routing of inbound traffic depending on the masquerading table,
   there is no way to open a connection to an internal host from the
   outside. For such a connection, there would be no entry in the table. In
   addition, any connection already established has a status entry assigned
   to it in the table, so the entry cannot be used by another connection.
  </p><p>
   As a consequence of all this, you might experience some problems with
   several application protocols, such as ICQ, cucme, IRC (DCC, CTCP), and
   FTP (in PORT mode). Web browsers, the standard FTP program, and many
   other programs use the PASV mode. This passive mode is much less
   problematic as far as packet filtering and masquerading are concerned.
  </p></div><div class="sect1 " id="sec.security.firewall.fw"><div class="titlepage"><div><div><h2 class="title" id="sec.security.firewall.fw"><span class="number">16.3 </span><span class="name">Firewalling Basics</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.fw">#</a></h2></div></div></div><p>
   <span class="emphasis"><em>Firewall</em></span> is probably the term most widely used to
   describe a mechanism that controls the data flow between networks.
   Strictly speaking, the mechanism described in this section is called a
   <span class="emphasis"><em>packet filter</em></span>. A packet filter regulates the data flow
   according to certain criteria, such as protocols, ports, and IP addresses.
   This allows you to block packets that, according to their addresses, are
   not supposed to reach your network. To allow public access to your Web
   server, for example, explicitly open the corresponding port. However, a
   packet filter does not scan the contents of packets with legitimate
   addresses, such as those directed to your Web server. For example, if
   incoming packets were intended to compromise a CGI program on your Web
   server, the packet filter would still let them through.
  </p><p>
   A more effective but more complex mechanism is the combination of several
   types of systems, such as a packet filter interacting with an application
   gateway or proxy. In this case, the packet filter rejects any packets
   destined for disabled ports. Only packets directed to the application
   gateway are accepted. This gateway or proxy pretends to be the actual
   client of the server. In a sense, such a proxy could be considered a
   masquerading host on the protocol level used by the application. One
   example for such a proxy is Squid, an HTTP and FTP proxy server. To use
   Squid, the browser must be configured to communicate via the proxy. Any
   HTTP pages or FTP files requested are served from the proxy cache and
   objects not found in the cache are fetched from the Internet by the
   proxy.
  </p><p>
   The following section focuses on the packet filter that comes with
   <span class="productname"><span class="phrase">openSUSE Leap</span></span>. For further information about packet filtering and
   firewalling, read the <a class="link" href="http://www.tldp.org/HOWTO/Firewall-HOWTO.html" target="_blank">Firewall
   HOWTO</a>.
  </p></div><div class="sect1 " id="sec.security.firewall.firewalld"><div class="titlepage"><div><div><h2 class="title" id="sec.security.firewall.firewalld"><span class="number">16.4 </span><span class="name"><code class="systemitem">firewalld</code></span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld">#</a></h2></div></div></div><p>
   <code class="systemitem">firewalld</code> is a daemon that maintains the system's
   <code class="command">iptables</code> rules and offers a D-Bus interface for
   operating on them. It comes with a command line utility
   <code class="command">firewall-cmd</code> and a graphical user interface
   <code class="command">firewall-config</code> for interacting with it. Since
   <code class="systemitem">firewalld</code> is running in the background and provides a well defined
   interface it allows other applications to request changes to the iptables
   rules, for example to setup virtual machine networking.
  </p><p>
   <code class="systemitem">firewalld</code> implements different security zones. A number of predefined
   zones like <code class="literal">internal</code> or <code class="literal">public</code> exist.
   The administrator can define additional custom zones if desired. Each
   zone contains its own set of iptables rules. Each network interface is
   member of exactly one zone. Individual connections can also be assigned to
   a zone based on the source addresses.
  </p><p>
   Each zone represents a certain level of trust. For example the
   <code class="literal">public</code> zone is not trusted, because other computers in
   this network are not under your control (suitable for Internet or wireless
   hotspot connections). On the other hand the <code class="literal">internal</code>
   zone is used for networks that are under your control like a home or
   company network. By utilizing zones this way a host can offer different
   kinds of services to trusted networks and untrusted networks in a defined
   way.
  </p><p>
   For more information about the predefined zones and their meaning in
   <code class="systemitem">firewalld</code> refer to its manual at
   <a class="link" href="http://www.firewalld.org/documentation/zone/predefined-zones.html" target="_blank">http://www.firewalld.org/documentation/zone/predefined-zones.html</a>.
  </p><div id="idm140712068527728" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: No Zone Assigned Behavior</h6><p>
     The initial state for network interfaces is to be assigned to no zone at
     all. In this case the network interface will be implicitly handled in the
     default zone which can be determined by calling <code class="command">firewall-cmd
      --get-default-zone</code>. If not configured otherwise, the default
     zone is the <code class="literal">public</code> zone.
    </p></div><p>
   The <code class="systemitem">firewalld</code> packet filtering model allows any outgoing connections to
   pass. Outgoing connections are connections that are actively established by
   the local host. Incoming connections that are established by remote hosts are
   blocked, if the respective service is not allowed in the zone in
   question. Therefore, each of the interfaces with incoming traffic must be
   placed into a suitable zone to allow for the desired services to be
   accessible. For each of the zones, define the services or protocols you
   need.
  </p><p>
   An important concept of <code class="systemitem">firewalld</code> is the distinction between two separate
   configurations, the <span class="emphasis"><em>runtime</em></span> and the
   <span class="emphasis"><em>permanent</em></span> configuration. The runtime configuration
   represents the currently active rules, while the permanent configuration
   represents the saved rules that will be applied when restarting
   <code class="systemitem">firewalld</code>. This allows to add temporary rules that will be discarded after
   restart of <code class="systemitem">firewalld</code>, or to experiment with new rules while being able to
   revert back to the original state. When you are changing the configuration
   you need to be aware of which configuration you're editing. How this is
   done is discussed in <a class="xref" href="#sec.security.firewall.firewalld.configurations" title="16.4.1.2. Runtime versus Permanent Configuration">Section 16.4.1.2, “Runtime versus Permanent Configuration”</a>.
  </p><p>
   If you want to perform the <code class="systemitem">firewalld</code> configuration using the graphical user
   interface <code class="command">firewall-config</code> then refer to its documentation
   in
   <a class="link" href="http://www.firewalld.org/documentation/utilities/firewall-config.html" target="_blank">http://www.firewalld.org/documentation/utilities/firewall-config.html</a>.
    In the following section we will be looking at how to perform typical
    <code class="systemitem">firewalld</code> configuration tasks using <code class="command">firewall-cmd</code> on the
    command line.
  </p><div class="sect2 " id="sec.security.firewall.firewalld.cmd"><div class="titlepage"><div><div><h3 class="title" id="sec.security.firewall.firewalld.cmd"><span class="number">16.4.1 </span><span class="name">Configuring the Firewall on the Command Line</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld.cmd">#</a></h3></div></div></div><div class="sect3 " id="idm140712068514080"><div class="titlepage"><div><div><h4 class="title" id="idm140712068514080"><span class="number">16.4.1.1 </span><span class="name">Firewall Startup</span> <a title="Permalink" class="permalink" href="#idm140712068514080">#</a></h4></div></div></div><p>
     <code class="systemitem">firewalld</code> will be installed and enabled by default. It is a regular
     <code class="systemitem">systemd</code> service that can be configured via <code class="command">systemctl</code>
     or the YaST Services Manager.
    </p><div id="idm140712068510960" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Automatic Firewall Configuration</h6><p> After the installation, YaST automatically starts
      <code class="systemitem">firewalld</code> and leaves all interfaces in the default
      <code class="literal">public</code> zone. If a server application is configured
      and activated on the system, YaST can adjust the firewall
      rules via the options <span class="guimenu">Open Ports on Selected Interface in
      Firewall</span> or <span class="guimenu">Open Ports on Firewall</span>
      in the server configuration modules. Some server module dialogs include a
      <span class="guimenu">Firewall Details</span> button for activating additional
      services and ports.
     </p></div></div><div class="sect3 " id="sec.security.firewall.firewalld.configurations"><div class="titlepage"><div><div><h4 class="title" id="sec.security.firewall.firewalld.configurations"><span class="number">16.4.1.2 </span><span class="name">Runtime versus Permanent Configuration</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld.configurations">#</a></h4></div></div></div><p>
     By default all <code class="command">firewall-cmd</code> commands operate on the
     runtime configuration. You can apply most operations to the permanent
     configuration <span class="emphasis"><em>only</em></span> by adding the
     <code class="literal">--permanent</code> parameter. When doing so the change will
     only affect the permanent configuration but will not be effective
     immediatly in the runtime configuration. There is currently no way to add a
     rule to both runtime and permanent configuration in a single invocation.
     To achieve this you can apply all necessary changes to the runtime
     configuration and when all is working as expected issue the following
     command:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --runtime-to-permanent</code></pre></div><p>
     This will write all current runtime rules into the permanent configuration.
     Any temporary modifications you or other programs may have made to the
     firewall in other contexts are made permanent this way. If you're unsure
     about this you can also take the opposite approach to be on the safe side:
     Add new rules to the permanent configuration and reload <code class="systemitem">firewalld</code> to
     make them active.
    </p><div id="idm140712068500320" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
      Some configuration items like the default zone are shared by both the
      runtime and permanent configuration. Changing them will reflect in both
      configurations at once.
     </p></div><p>
     To revert the runtime configuration to the permanent configuration and
     thereby discard any temporary changes there exist two
     possibilities, either via the <code class="systemitem">firewalld</code> command line interface or via
     <code class="systemitem">systemd</code>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --reload</code></pre></div><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">systemctl reload firewalld</code></pre></div><p>
     For brevity the examples in the following sections will always operate on
     the runtime configuration, if applicable. Adjust them accordingly if you
     want to make them permanent.
    </p></div><div class="sect3 " id="idm140712068494112"><div class="titlepage"><div><div><h4 class="title" id="idm140712068494112"><span class="number">16.4.1.3 </span><span class="name">Assignment of Interfaces to Zones</span> <a title="Permalink" class="permalink" href="#idm140712068494112">#</a></h4></div></div></div><p>
     You can list all network interfaces currently assigned to a zone like this:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --zone=public --list-interfaces</code>
eth0</pre></div><p>
     Similarly you can query which zone a specific interface is assigned to:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --get-zone-of-interface=eth0</code>
public</pre></div><p>
     The following command lines assign an interface to a zone. The variant
     using <code class="literal">--add-interface</code> will only work if
     <code class="literal">eth0</code> is not already assigned to another zone. The
     variant using <code class="literal">--change-interface</code> will always work,
     removing <code class="literal">eth0</code> from its current zone if necessary:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --zone=internal --add-interface=eth0</code>
<code class="prompt root">root # </code><code class="command">firewall-cmd --zone=internal --change-interface=eth0</code></pre></div><p>
      Any operations without an explicit <code class="literal">--zone</code> argument will
      impliticly operate on the default zone. This pair of commands can be used
      for getting and setting the default zone assignment:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --get-default-zone</code>
dmz
<code class="prompt root">root # </code><code class="command">firewall-cmd --set-default-zone=public</code></pre></div><div id="idm140712068481856" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important</h6><p>
      Any network interfaces not explicitly assigned to a zone will be
      automatically part of the default zone. Changing the default zone will
      reassign all those network interfaces immediately for the permanent and
      runtime configurations. You should never use a trusted zone like
      <code class="literal">internal</code> as the default zone to avoid unexpected
      exposure to threats. For example hotplugged network interfaces like USB
      ethernet interfaces would automatically become part of the trusted zone in
      such cases.
     </p><p>
      Also note that interfaces that are not explicitly part of any zone will
      not appear in the zone interface list. There is currently no command to
      list unassigned interfaces. Due to this it is best to avoid unassigned
      network interfaces during regular operation.
     </p></div></div><div class="sect3 " id="sec.security.firewall.firewalld.cmd.ports"><div class="titlepage"><div><div><h4 class="title" id="sec.security.firewall.firewalld.cmd.ports"><span class="number">16.4.1.4 </span><span class="name">Making Network Services Accessible</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld.cmd.ports">#</a></h4></div></div></div><p>
     <code class="systemitem">firewalld</code> has a concept of <span class="emphasis"><em>services</em></span>. A service
     consists of definitions of ports and protocols. These definitions
     logically belong together in the context of a given network service like
     a web or mail server protocol. The following commands can be used to get
     information about predefined services and their details:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --get-services</code>
[...] dhcp dhcpv6 dhcpv6-client dns docker-registry [...]
<code class="prompt root">root # </code><code class="command">firewall-cmd --info-service dhcp</code>
dhcp
  ports: 67/udp
  protocols:
  source-ports:
  modules:
  destination:</pre></div><p>
     These service definitions can be used for easily making the associated
     network functionality accessible in a zone. This command line will open the
     http web server port in the internal zone, for example:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --add-service=http --zone=internal</code></pre></div><p>
     The removal of a service from a zone is performed using the counterpart
     command <code class="literal">--remove-service</code>. You can also define custom
     services using the <code class="literal">--new-service</code> sub-command. Refer to
     <a class="link" href="http://www.firewalld.org/documentation/howto/add-a-service.html" target="_blank">http://www.firewalld.org/documentation/howto/add-a-service.html</a>
     for more details on how to do this.
    </p><p>
     If you just want to open a single port by number you can use the following
     approach. This will open TCP port 8000 in the internal zone:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --add-port=8000/tcp --zone=internal</code></pre></div><p>
     For removal use the counterpart command <code class="literal">--remove-port</code>.
    </p><div id="idm140712068466992" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Temporarily Opening a Service or Port</h6><p>
      <code class="systemitem">firewalld</code> supports a <code class="literal">--timeout</code> parameter that allows
      to open a service or port for a limited time duration. This can be helpful
      for quick testing and makes sure that closing the service or port will not
      be forgotten. To allow the <code class="literal">imap</code> service in the
      <code class="literal">internal</code> zone for 5 minutes, you would call
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --add-service=imap --zone=internal --timeout=5m</code></pre></div></div></div><div class="sect3 " id="idm140712068461984"><div class="titlepage"><div><div><h4 class="title" id="idm140712068461984"><span class="number">16.4.1.5 </span><span class="name">Lockdown Mode</span> <a title="Permalink" class="permalink" href="#idm140712068461984">#</a></h4></div></div></div><p>
     <code class="systemitem">firewalld</code> offers a <span class="emphasis"><em>lockdown mode</em></span> that prevents
     changes to the firewall rules while being active. Since applications can
     automatically change the firewall rules via the D-Bus interface and
     depending on the PolicyKit rules regular users may be able to do the same
     it can be helpful to prevent changes in some situations. You can find more
     information about this in
     <a class="link" href="https://fedoraproject.org/wiki/Features/FirewalldLockdown" target="_blank">https://fedoraproject.org/wiki/Features/FirewalldLockdown</a>.
    </p><p>
     It is important to understand that the lockdown mode feature
     provides no real security but merely protection against accidental or
     benign attempts to change the firewall. The way the lockdown mode is
     currently implemented in <code class="systemitem">firewalld</code> provides no security against malicious
     intent as is pointed out in
     <a class="link" href="http://seclists.org/oss-sec/2017/q3/139" target="_blank">http://seclists.org/oss-sec/2017/q3/139</a>.
    </p></div><div class="sect3 " id="idm140712068456480"><div class="titlepage"><div><div><h4 class="title" id="idm140712068456480"><span class="number">16.4.1.6 </span><span class="name">Adding Custom <code class="command">iptables</code> Rules</span> <a title="Permalink" class="permalink" href="#idm140712068456480">#</a></h4></div></div></div><p>
     <code class="systemitem">firewalld</code> claims exclusive control over the host's
     <code class="systemitem">netfilter</code> rules. You should never modify
     firewall rules using other tools like <code class="command">iptables</code>. Doing
     so could confuse <code class="systemitem">firewalld</code> and break security or functionality.
    </p><p>
     If you need to add custom firewall rules that aren't covered by
     <code class="systemitem">firewalld</code> features then there are two ways to do so. To directly pass
     raw <code class="command">iptables</code> syntax you can use the
     <code class="literal">--direct</code> option. It expects the table, chain and
     priority as initial arguments and the rest of the command line is passed
     as is to <code class="command">iptables</code>. The following example adds a
     connection tracking rule for the forwarding filter table:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd  --direct --add-rule ipv4 filter FORWARD 0 -i eth0 -o eth1 \
    -p tcp --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT</code></pre></div><p>
     Additionally, <code class="systemitem">firewalld</code> implements so called <span class="emphasis"><em>rich
     rules</em></span>, an extended syntax for specifying
     <code class="command">iptables</code> rules in an easier way. You can find the
     syntax specification in
     <a class="link" href="http://www.firewalld.org/documentation/man-pages/firewalld.richlanguage.html" target="_blank">http://www.firewalld.org/documentation/man-pages/firewalld.richlanguage.html</a>.
     the following example drops all IPv4 packets originating from a certain
     source address:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --zone=public --add-rich-rule='rule family="ipv4" \
    source address="192.168.2.4" drop'</code></pre></div></div><div class="sect3 " id="idm140712068444016"><div class="titlepage"><div><div><h4 class="title" id="idm140712068444016"><span class="number">16.4.1.7 </span><span class="name">Routing, Forwarding and Masquerading</span> <a title="Permalink" class="permalink" href="#idm140712068444016">#</a></h4></div></div></div><p>
     <code class="systemitem">firewalld</code> is not designed to run as a fully fledged router. The
     basic functionality for typical home router setups is available. For a
     corporate production router you should not use <code class="systemitem">firewalld</code>, however, but
     use dedicated router and firewall devices instead. The following provides
     just a few pointers what to look for to utilize routing in <code class="systemitem">firewalld</code>:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       First of all IP forwarding needs to be enabled as outlined in
       <a class="xref" href="#sec.security.firewall.masq" title="16.2. Masquerading Basics">Section 16.2, “Masquerading Basics”</a>.
      </p></li><li class="listitem "><p>
       To enable IPv4 masquerading, for example in the
       <code class="literal">internal</code> zone, issue the following command
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --zone=internal --add-masquerade</code></pre></div></li><li class="listitem "><p>
       <code class="systemitem">firewalld</code> can also enable port forwarding. The following command will
       forward local TCP connections on port 80 to another host:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --zone=public \
    --add-forward-port=port=80:proto=tcp:toport=80:toaddr=192.168.1.10</code></pre></div></li></ul></div></div></div><div class="sect2 " id="sec.security.firewall.firewalld.rpcports"><div class="titlepage"><div><div><h3 class="title" id="sec.security.firewall.firewalld.rpcports"><span class="number">16.4.2 </span><span class="name">Accessing Services Listening on Dynamic Ports</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld.rpcports">#</a></h3></div></div></div><p>
    Some network services do not listen on predefined port numbers. Instead
    they operate based on the <code class="literal">portmapper</code> or
    <code class="literal">rpcbind</code> protocol. We will use the term
    <code class="literal">rpcbind</code> from here on. When one of these services
    starts, it chooses a random local port and talks to
    <code class="literal">rpcbind</code> to make the port number known.
    <code class="literal">rpcbind</code> itself is listening on a well known port.
    Remote systems can then query <code class="literal">rpcbind</code> about the network
    services it knows about and on which ports they are listening. Not many
    programs use this approach any more today. Popular examples are
    Network Information Services (NIS; <code class="command">ypserv</code> and
    <code class="command">ypbind</code>) and the Network File System (NFS) version 3.
   </p><div id="idm140712068426176" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: About NFSv4</h6><p>
     The newer NFSv4 only requires the single well known
     TCP port 2049 any more. For protocol version 4.0 the kernel parameter
     <code class="literal">fs.nfs.nfs_callback_tcpport</code> may need to be set
     to a static port (see <a class="xref" href="#ex.security.firewall.nfscallback" title="callback port configuration for the nfs kernel module in /etc/modprobe.d/60-nfs.conf">Example 16.1, “callback port configuration for the <code class="literal">nfs</code> kernel module in <code class="filename">/etc/modprobe.d/60-nfs.conf</code>”</a>).
     Starting with protocol version 4.1 this setting has also become
     unnecessary.
    </p></div><p>
    The dynamic nature of the <code class="literal">rpcbind</code> protocol makes
    it difficult to make the affected services behind the firewall accessible.
    <code class="systemitem">firewalld</code> does not support these services by itself. In the following
    section an approach to handle this case is discussed.
   </p><div class="sect3 " id="sec.security.firewall.firewalld.rpcports.static"><div class="titlepage"><div><div><h4 class="title" id="sec.security.firewall.firewalld.rpcports.static"><span class="number">16.4.2.1 </span><span class="name">Configuring Static Ports</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.firewalld.rpcports.static">#</a></h4></div></div></div><p>
     One possibility is to configure all involved network services to use
     fixed port numbers. Once this is done, the fixed ports can be opened in
     <code class="systemitem">firewalld</code> and everything should work. The actual port numbers used are
     at your discretion but should not clash with any well known port numbers
     assigned to other services. See <a class="xref" href="#tab.security.firewall.sysconfigports" title="Important Sysconfig Variables for Static Port Configuration">Table 16.1, “Important Sysconfig Variables for Static Port Configuration”</a>
     for a list of the available configuration items for NIS and NFSv3
     services. Note that depending on your actual NIS or NFS configuration
     not all of these ports may be required for your setup.
    </p><div class="table" id="tab.security.firewall.sysconfigports"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 16.1: </span><span class="name">Important Sysconfig Variables for Static Port Configuration </span><a title="Permalink" class="permalink" href="#tab.security.firewall.sysconfigports">#</a></h6></div><div class="table-contents"><table summary="Important Sysconfig Variables for Static Port Configuration" border="1"><colgroup><col class="1" /><col class="2" /><col class="3" /></colgroup><thead><tr><th>
         <p>
          File Path
         </p>
        </th><th>
         <p>
          Variable Name
         </p>
        </th><th>
         <p>
          Example Value
         </p>
        </th></tr></thead><tbody><tr><td rowspan="5">
         <code class="filename">
          /etc/sysconfig/nfs
         </code>
        </td><td>
         MOUNTD_PORT
        </td><td>
         21001
        </td></tr><tr><td>
         STATD_PORT
        </td><td>
         21002
        </td></tr><tr><td>
         LOCKD_TCPPORT
        </td><td>
         21003
        </td></tr><tr><td>
         LOCKD_UDPPORT
        </td><td>
         21003
        </td></tr><tr><td>
         RQUOTAD_PORT
        </td><td>
         21004
        </td></tr><tr><td>
         <code class="filename">
          /etc/sysconfig/ypbind
         </code>
        </td><td>
         YPBIND_OPTIONS
        </td><td>
         -p 24500
        </td></tr><tr><td rowspan="3">
         <code class="filename">
          /etc/sysconfig/ypserv
         </code>
        </td><td>
         YPXFRD_ARGS
        </td><td>
         -p 24501
        </td></tr><tr><td>
         YPSERV_ARGS
        </td><td>
         -p 24502
        </td></tr><tr><td>
         YPPASSWDD_ARGS
        </td><td>
         --port 24503
        </td></tr></tbody></table></div></div><p>
     You will need to restart any related services that are affected by these
     static port configurations for the changes to take effect. You can see
     the currently assigned rpcbind ports by using the command
     <code class="command">rpcinfo -p</code>. On success only the statically configured
     ports should show up there any more.
    </p><p>
     Apart from the port configuration for network services running in
     userspace there are also ports that are used by the Linux kernel directly
     when it comes to NFS. One of these ports is the
     <code class="literal">nfs_callback_tcpport</code>. It is only required for the NFS
     protocol older than version 4.1. There is a sysctl named
     <code class="literal">fs.nfs.nfs_callback_tcpport</code> to configure this port.
     This sysctl node only appears dynamically when NFS mounts are active.
     Therefore it is best to configure the port via kernel module
     parameters. This can be achieved by creating a file like shown in
     <a class="xref" href="#ex.security.firewall.nfscallback" title="callback port configuration for the nfs kernel module in /etc/modprobe.d/60-nfs.conf">Example 16.1, “callback port configuration for the <code class="literal">nfs</code> kernel module in <code class="filename">/etc/modprobe.d/60-nfs.conf</code>”</a>.
    </p><div class="example" id="ex.security.firewall.nfscallback"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 16.1: </span><span class="name">callback port configuration for the <code class="literal">nfs</code> kernel module in <code class="filename">/etc/modprobe.d/60-nfs.conf</code> </span><a title="Permalink" class="permalink" href="#ex.security.firewall.nfscallback">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">options nfs callback_tcpport=21005</pre></div></div></div><p>
     To make this change effective it is easiest to reboot the machine.
     Otherwise all NFS services need to be stopped and the
     <code class="literal">nfs</code> kernel module needs to be reloaded. To verify the
     active NFS callback port check the output of
     <code class="command">cat /sys/module/nfs/parameters/callback_tcpport</code>.
    </p><p>
     For easy handling of the now statically configured RPC ports it is useful
     to create a new <code class="systemitem">firewalld</code> service definition. This service definition
     will group all related ports and for example makes it easy to make them
     accessible in a specific zone. In
     <a class="xref" href="#ex.security.firewall.newrpcservice" title="Commands to Define a new firewalld RPC Service for NFS">Example 16.2, “Commands to Define a new <code class="systemitem">firewalld</code> RPC Service for NFS”</a> this is done for the
     NFS ports as they have been configured in the accompanying examples.
    </p><div class="example" id="ex.security.firewall.newrpcservice"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 16.2: </span><span class="name">Commands to Define a new <code class="systemitem">firewalld</code> RPC Service for NFS </span><a title="Permalink" class="permalink" href="#ex.security.firewall.newrpcservice">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code><code class="command">firewall-cmd --permanent --new-service=nfs-rpc</code>
<code class="prompt root">root # </code><code class="command">firewall-cmd --permanent --service=nfs-rpc --set-description="NFS related, statically configured RPC ports"</code>
# add UDP and TCP ports for the given sequence
<code class="prompt root">root # </code><code class="command">for port in 21001 21002 21003 21004; do
    firewall-cmd --permanent --service=nfs-rpc --add-port ${port}/udp --add-port ${port}/tcp
done</code>
# the callback port is TCP only
<code class="prompt root">root # </code><code class="command">firewall-cmd --permanent --service=nfs-rpc --add-port 21005/tcp</code>

# show the complete definition of the new custom service
<code class="prompt root">root # </code><code class="command">firewall-cmd --info-service=nfs-rpc --permanent -v</code>
nfs-rpc
  summary:
  description: NFS and related, statically configured RPC ports
  ports: 4711/tcp 21001/udp 21001/tcp 21002/udp 21002/tcp 21003/udp 21003/tcp 21004/udp 21004/tcp
  protocols:
  source-ports:
  modules:
  destination:

# reload firewalld to make the new service definition available
<code class="prompt root">root # </code><code class="command">firewall-cmd --reload</code>

# the new service definition can now be used to open the ports e.g. in the internal zone
<code class="prompt root">root # </code><code class="command">firewall-cmd --add-service=nfs-rpc --zone=internal</code></pre></div></div></div></div></div></div><div class="sect1 " id="sec.security.firewall.info"><div class="titlepage"><div><div><h2 class="title" id="sec.security.firewall.info"><span class="number">16.5 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.firewall.info">#</a></h2></div></div></div><p>
   The most up-to-date information and other documentation about <code class="systemitem">firewalld</code>
   package is found in <code class="filename">/usr/share/doc/packages/firewalld</code>.
   The home page of the netfilter and iptables project, <a class="link" href="http://www.netfilter.org" target="_blank">http://www.netfilter.org</a>, provides a large collection of
   documents about iptables in general in many languages.
  </p></div></div><div class="chapter " id="cha.security.vpnserver"><div class="titlepage"><div><div><h2 class="title"><span class="number">17 </span><span class="name">Configuring a VPN Server</span> <a title="Permalink" class="permalink" href="#cha.security.vpnserver">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_vpnserver.xml</li><li><span class="ds-label">ID: </span>cha.security.vpnserver</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712068365952">#</a></h6></div><p>
    Today, Internet connections are cheap and available almost
    everywhere. However, not all connections are secure.
    Using a Virtual Private Network (VPN), you can create a secure network
    within an insecure network such as the Internet or Wi-Fi. It can be
    implemented in different ways and serves several purposes. In this chapter,
    we focus on the
    <a class="link" href="http://www.openvpn.net" target="_blank">OpenVPN</a> implementation
    to link branch offices via secure wide area networks (WANs).

        </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.vpn.overview"><span class="number">17.1 </span><span class="name">Conceptual Overview</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.simplest"><span class="number">17.2 </span><span class="name">Setting Up a Simple Test Scenario</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.ca"><span class="number">17.3 </span><span class="name">Setting Up Your VPN Server Using a Certificate Authority</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yastvpn"><span class="number">17.4 </span><span class="name">Setting Up a VPN Server or Client Using YaST</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.vpn.moreinfo"><span class="number">17.5 </span><span class="name">For More Information</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.vpn.overview"><div class="titlepage"><div><div><h2 class="title" id="sec.security.vpn.overview"><span class="number">17.1 </span><span class="name">Conceptual Overview</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.overview">#</a></h2></div></div></div><p>
   This section defines some terms regarding VPN and gives a brief overview
   of some scenarios.
  </p><div class="sect2 " id="sec.security.vpn.terminology"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.terminology"><span class="number">17.1.1 </span><span class="name">Terminology</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.terminology">#</a></h3></div></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712068359504"><span class="term ">Endpoint</span></dt><dd><p>
       The two <span class="quote">“<span class="quote">ends</span>”</span> of a tunnel, the source or destination
       client.
      </p></dd><dt id="idm140712068357216"><span class="term ">Tap Device</span></dt><dd><p>
       A tap device simulates an Ethernet device (layer 2 packets in the OSI
       model, such as IP packets). A tap device is used for creating a
       network bridge. It works with Ethernet frames.
      </p></dd><dt id="idm140712068355232"><span class="term ">Tun Device</span></dt><dd><p>
       A tun device simulates a point-to-point network (layer 3 packets in
       the OSI model, such as Ethernet frames). A tun device is used with
       routing and works with IP frames.
      </p></dd><dt id="idm140712068353264"><span class="term ">Tunnel</span></dt><dd><p>
       Linking two locations through a primarily public network. From a more
       technical viewpoint, it is a connection between the client's device
       and the server's device. Usually a tunnel is encrypted, but it does
       need to be by definition.
      </p></dd></dl></div></div><div class="sect2 " id="sec.security.vpn.scenarios"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.scenarios"><span class="number">17.1.2 </span><span class="name">VPN Scenarios</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.scenarios">#</a></h3></div></div></div><p>
    Whenever you set up a VPN connection, your IP packets are transferred
    over a secured <span class="emphasis"><em>tunnel</em></span>. A tunnel can use either a
    <span class="emphasis"><em>tun</em></span> or <span class="emphasis"><em>tap</em></span> device. They are
    virtual network kernel drivers which implement the transmission of
    Ethernet frames or IP frames/packets.
   </p><p>
    Any user space program, such as OpenVPN, can attach itself to a tun or tap
    device to receive packets sent by your operating system. The program is
    also able to write packets to the device.
   </p><p>
    There are many solutions to set up and build a VPN connection. This
    section focuses on the OpenVPN package. Compared to other VPN software,
    OpenVPN can be operated in two modes:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712068346256"><span class="term ">Routed VPN</span></dt><dd><p>
       Routing is an easy solution to set up. It is more efficient and
       scales better than a bridged VPN. Furthermore, it allows the user to
       tune MTU (Maximum Transfer Unit) to raise efficiency. However, in a
       heterogeneous environment, if you do not have a Samba server on the
       gateway, NetBIOS broadcasts do not work. If you need IPv6, the drivers
       for the tun devices on both ends must support this protocol explicitly.
       This scenario is depicted in <a class="xref" href="#fig.vpn.scenario-routed-1" title="Routed VPN">Figure 17.1, “Routed VPN”</a>.
      </p><div class="figure" id="fig.vpn.scenario-routed-1"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vpn_routed1.png"><img src="images/vpn_routed1.png" width="" alt="Routed VPN" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 17.1: </span><span class="name">Routed VPN </span><a title="Permalink" class="permalink" href="#fig.vpn.scenario-routed-1">#</a></h6></div></div></dd><dt id="idm140712068337808"><span class="term ">Bridged VPN</span></dt><dd><p>
       Bridging is a more complex solution. It is recommended when you need
       to browse Windows file shares across the VPN without setting up a
       Samba or WINS server. Bridged VPN is also needed to use
       non-IP protocols (such as IPX) or applications relying on network
       broadcasts. However, it is less efficient than routed VPN. Another
       disadvantage is that it does not scale well. This scenario is
       depicted in the following figures.
      </p><div class="figure" id="fig.vpn.scenario-briged-1"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vpn_bridged1.png"><img src="images/vpn_bridged1.png" width="" alt="Bridged VPN - Scenario 1" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 17.2: </span><span class="name">Bridged VPN - Scenario 1 </span><a title="Permalink" class="permalink" href="#fig.vpn.scenario-briged-1">#</a></h6></div></div><div class="figure" id="fig.vpn.scenario-briged-2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vpn_bridged2.png"><img src="images/vpn_bridged2.png" width="" alt="Bridged VPN - Scenario 2" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 17.3: </span><span class="name">Bridged VPN - Scenario 2 </span><a title="Permalink" class="permalink" href="#fig.vpn.scenario-briged-2">#</a></h6></div></div><div class="figure" id="fig.vpn.scenario-briged-3"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vpn_bridged3.png"><img src="images/vpn_bridged3.png" width="" alt="Bridged VPN - Scenario 3" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 17.4: </span><span class="name">Bridged VPN - Scenario 3 </span><a title="Permalink" class="permalink" href="#fig.vpn.scenario-briged-3">#</a></h6></div></div></dd></dl></div><p>
    The major difference between bridging and routing is that a routed VPN
    cannot IP-broadcast while a bridged VPN can.
   </p></div></div><div class="sect1 " id="sec.security.vpn.simplest"><div class="titlepage"><div><div><h2 class="title" id="sec.security.vpn.simplest"><span class="number">17.2 </span><span class="name">Setting Up a Simple Test Scenario</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.simplest">#</a></h2></div></div></div><p>
   In the following example, we will create a point-to-point VPN tunnel. The
   example demonstrates how to create a VPN tunnel between one client and a
   server. It is assumed that your VPN server will use private IP addresses
   like <code class="systemitem"><em class="replaceable ">IP_OF_SERVER</em></code>
   and your client will use the IP address
   <code class="systemitem"><em class="replaceable ">IP_OF_CLIENT</em></code>.
   Make sure you select addresses which do not conflict with other IP addresses.
  </p><div id="idm140712068316224" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Use Only for Testing</h6><p>
    This following scenario is provided as an example meant for familiarizing
    yourself with VPN technology. <span class="emphasis"><em>Do not</em></span> use this as a
    real world scenario, as it can compromise the security and safety of your IT
    infrastructure!
   </p></div><div id="idm140712068313696" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Names for Configuration File</h6><p>
    To simplify working with OpenVPN configuration files, we recommend the
    following:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Place your OpenVPN configuration files in the directory
      <code class="filename">/etc/openvpn</code>.
     </p></li><li class="listitem "><p>
      Name your configuration files
      <code class="filename"><em class="replaceable ">MY_CONFIGURATION</em>.conf</code>.
     </p></li><li class="listitem "><p>
      If there are multiple files that belong to the same configuration, place
      them in a subdirectory like
      <code class="filename">/etc/openvpn/<em class="replaceable ">MY_CONFIGURATION</em></code>.
     </p></li></ul></div></div><div class="sect2 " id="sec.security.vpn.simplest.vpnserv"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.simplest.vpnserv"><span class="number">17.2.1 </span><span class="name">Configuring the VPN Server</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.simplest.vpnserv">#</a></h3></div></div></div><p>
    To configure a VPN server, proceed as follows:
   </p><div class="procedure " id="pro.security.vpn.simplest.vpnserv"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 17.1: </span><span class="name">VPN Server Configuration </span><a title="Permalink" class="permalink" href="#pro.security.vpn.simplest.vpnserv">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Install the package <code class="systemitem">openvpn</code>
      on the machine that will later become your VPN server.
     </p></li><li class="step "><p>
      Open a shell, become <code class="systemitem">root</code> and create the VPN secret key:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>openvpn --genkey --secret /etc/openvpn/secret.key</pre></div></li><li class="step "><p>
      Copy the secret key to your client:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>scp /etc/openvpn/secret.key root@<em class="replaceable ">IP_OF_CLIENT</em>:/etc/openvpn/</pre></div></li><li class="step "><p>
      Create the file <code class="filename">/etc/openvpn/server.conf</code> with the
      following content:
     </p><div class="verbatim-wrap"><pre class="screen">dev tun
ifconfig <em class="replaceable ">IP_OF_SERVER</em> <em class="replaceable ">IP_OF_CLIENT</em>
secret secret.key</pre></div></li><li class="step "><p>
      Set up a tun device configuration by creating a file called
      <code class="filename">/etc/sysconfig/network/ifcfg-tun0</code> with the following
      content:
     </p><div class="verbatim-wrap"><pre class="screen">STARTMODE='manual'
BOOTPROTO='static'
TUNNEL='tun'
TUNNEL_SET_OWNER='nobody'
TUNNEL_SET_GROUP='nobody'
LINK_REQUIRED=no
PRE_UP_SCRIPT='systemd:openvpn@server'
PRE_DOWN_SCRIPT='systemd:openvpn@service'</pre></div><p>
      The notation <code class="literal">openvpn@server</code> points to the OpenVPN
      server configuration file located at
      <code class="filename">/etc/openvpn/server.conf</code>. For more information, see
      <code class="filename">/usr/share/doc/packages/openvpn/README.SUSE</code>.
     </p></li><li class="step " id="st.security.vpn.simplest.vpnserv.yast"><p>
      If you use a firewall, start YaST and open UDP port 1194
      (<span class="guimenu">Security and
      Users</span> › <span class="guimenu">Firewall</span> › <span class="guimenu">Allowed
      Services</span>).
     </p></li><li class="step "><p>
      Start the OpenVPN server service by setting the tun device to
      <code class="literal">up</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">wicked ifup tun0</code></pre></div><p>
      You should see the confirmation:
     </p><div class="verbatim-wrap"><pre class="screen">tun0            up</pre></div></li></ol></div></div></div><div class="sect2 " id="sec.security.vpn.simplest.vpnclient"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.simplest.vpnclient"><span class="number">17.2.2 </span><span class="name">Configuring the VPN Clients</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.simplest.vpnclient">#</a></h3></div></div></div><p>
    To configure the VPN client, do the following:
   </p><div class="procedure " id="idm140712068282528"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 17.2: </span><span class="name">VPN Client Configuration </span><a title="Permalink" class="permalink" href="#idm140712068282528">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Install the package <code class="systemitem">openvpn</code>
      on your client VPN machine.
     </p></li><li class="step "><p>
      Create <code class="filename">/etc/openvpn/client.conf</code> with the
      following content:
     </p><div class="verbatim-wrap"><pre class="screen">remote <em class="replaceable ">DOMAIN_OR_PUBLIC_IP_OF_SERVER</em>
dev tun
ifconfig <em class="replaceable ">IP_OF_CLIENT</em> <em class="replaceable ">IP_OF_SERVER</em>
secret secret.key</pre></div><p>
      Replace the placeholder <em class="replaceable ">IP_OF_CLIENT</em> in the
      first line with either the domain name, or the public IP address of
      your server.
     </p></li><li class="step "><p>
      Set up a tun device configuration by creating a file called
      <code class="filename">/etc/sysconfig/network/ifcfg-tun0</code> with the following
      content:
     </p><div class="verbatim-wrap"><pre class="screen">STARTMODE='manual'
BOOTPROTO='static'
TUNNEL='tun'
TUNNEL_SET_OWNER='nobody'
TUNNEL_SET_GROUP='nobody'
LINK_REQUIRED=no
PRE_UP_SCRIPT='systemd:openvpn@client'
PRE_DOWN_SCRIPT='systemd:openvpn@client'</pre></div></li><li class="step "><p>
      If you use a firewall, start YaST and open UDP port 1194 as
      described in <a class="xref" href="#st.security.vpn.simplest.vpnserv.yast" title="Step 6">Step 6</a>
      of <a class="xref" href="#pro.security.vpn.simplest.vpnserv" title="VPN Server Configuration">Procedure 17.1, “VPN Server Configuration”</a>.
     </p></li><li class="step "><p>
      Start the OpenVPN server service by setting the tun device to
      <code class="literal">up</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">wicked ifup tun0</code></pre></div><p>
      You should see the confirmation:
     </p><div class="verbatim-wrap"><pre class="screen">tun0            up</pre></div></li></ol></div></div></div><div class="sect2 " id="sec.security.vpn.simplest.use"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.simplest.use"><span class="number">17.2.3 </span><span class="name">Testing the VPN Example Scenario</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.simplest.use">#</a></h3></div></div></div><p>
    After OpenVPN has successfully started, test the availability of the tun
    device with the following command:
   </p><div class="verbatim-wrap"><pre class="screen">ip addr show tun0</pre></div><p>
    To verify the VPN connection, use <code class="command">ping</code> on both client
    and server side to see if they can reach each other. Ping the server
    from the client:
   </p><div class="verbatim-wrap"><pre class="screen">ping -I tun0 <em class="replaceable ">IP_OF_SERVER</em></pre></div><p>
    Ping the client from the server:
   </p><div class="verbatim-wrap"><pre class="screen">ping -I tun0 <em class="replaceable ">IP_OF_CLIENT</em></pre></div></div></div><div class="sect1 " id="sec.security.vpn.ca"><div class="titlepage"><div><div><h2 class="title" id="sec.security.vpn.ca"><span class="number">17.3 </span><span class="name">Setting Up Your VPN Server Using a Certificate Authority</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.ca">#</a></h2></div></div></div><p>
   The example in
   <a class="xref" href="#sec.security.vpn.simplest" title="17.2. Setting Up a Simple Test Scenario">Section 17.2</a>
   is useful for testing, but not for daily work. This section explains how
   to build a VPN server that allows more than one connection at the same
   time. This is done with a public key infrastructure (PKI). A PKI consists
   of a pair of public and private keys for the server and each client, and
   a master certificate authority (CA), which is used to sign every server
   and client certificate.
  </p><p>
   This setup involves the following basic steps:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     <a class="xref" href="#sec.security.vpn.certs" title="17.3.1. Creating Certificates">Section 17.3.1, “Creating Certificates”</a>
    </p></li><li class="step "><p>
     <a class="xref" href="#sec.security.vpn.config-server" title="17.3.2. Configuring the VPN Server">Section 17.3.2, “Configuring the VPN Server”</a>
    </p></li><li class="step "><p>
     <a class="xref" href="#sec.security.vpn.config-clients" title="17.3.3. Configuring the VPN Clients">Section 17.3.3, “Configuring the VPN Clients”</a>
    </p></li></ol></div></div><div class="sect2 " id="sec.security.vpn.certs"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.certs"><span class="number">17.3.1 </span><span class="name">Creating Certificates</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.certs">#</a></h3></div></div></div><p>
    Before a VPN connection can be established, the client must authenticate
    the server certificate. Conversely, the server must also authenticate
    the client certificate. This is called <span class="emphasis"><em>mutual
    authentication</em></span>. To create such certificates, use the
    YaST CA module. See <a class="xref" href="#cha.security.yast_ca" title="Chapter 18. Managing X.509 Certification">Chapter 18, <em>Managing X.509 Certification</em></a> for more
    details.
   </p><p>
    To create a VPN root, server, and client CA, proceed as follows:
   </p><div class="procedure " id="pro.security.vpn.serverca"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 17.3: </span><span class="name">Creating a VPN Server Certificate </span><a title="Permalink" class="permalink" href="#pro.security.vpn.serverca">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step " id="st.security.vpn.serverca.vpnrootca"><p>
      Prepare a common VPN Certificate Authority (CA):
     </p><ol type="a" class="substeps "><li class="step "><p>
        Start the YaST CA module.
       </p></li><li class="step "><p>
        Click <span class="guimenu">Create Root CA</span>.
       </p></li><li class="step "><p>
        Enter a <span class="guimenu">CA Name</span> and a <span class="guimenu">Common
        Name</span>, for example <code class="literal">VPN-Server-CA</code>.
       </p></li><li class="step "><p>
        Fill out the other boxes like e-mail addresses, organization, etc.
        and proceed with <span class="guimenu">Next</span>.
       </p></li><li class="step "><p>
        Enter your password twice and proceed with <span class="guimenu">Next</span>.
       </p></li><li class="step "><p>
        Review the summary. YaST displays the current settings for
        confirmation. Click <span class="guimenu">Create</span>. The root CA is
        created and displayed in the overview.
       </p></li></ol></li><li class="step " id="st.security.vpn.serverca.vpnserverca"><p>
      Create a VPN server certificate:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Select the root CA you created in
        <a class="xref" href="#st.security.vpn.serverca.vpnrootca" title="Step 1">Step 1</a> and click
        <span class="guimenu">Enter CA</span>.
       </p></li><li class="step "><p>
        When prompted, enter the <span class="guimenu">CA Password</span>.
       </p></li><li class="step "><p>
        Click the <span class="guimenu">Certificate</span> tab and click <span class="guimenu">Add</span> › <span class="guimenu">Add Server Certificate</span>.
       </p></li><li class="step "><p>
        Specify a <span class="guimenu">Common Name</span>, for example,
        <code class="systemitem">openvpn.example.com</code>
        and proceed with <span class="guimenu">Next</span>.
       </p></li><li class="step "><p>
        Specify your password and confirm it. Then click <span class="guimenu">Advanced
        options</span>.
       </p><p>
        Switch to the <span class="guimenu">Advanced Settings</span> › <span class="guimenu">Key Usage</span> list and check one of the
        following sets:
       </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
          <code class="option">digitalSignature</code> and
          <code class="option">keyEncipherment</code>, or,
         </p></li><li class="listitem "><p>
          <code class="option">digitalSignature</code> and
          <code class="option">keyAgreement</code>
         </p></li></ul></div><p>
        Switch to the <span class="guimenu">Advanced Settings</span> › <span class="guimenu">extendedKeyUsage</span> and type
        <code class="option">serverAuth</code> for a server certificate.
       </p><div id="idm140712068218496" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Avoiding Man-in-the-Middle Attacks</h6><p>
         If you are using the method <code class="option">remote-cert-tls server</code> or
         <code class="option">remote-cert-tls client</code> to verify certificates, limit
         the number of times a key can be used. This mitigates
         man-in-the-middle attacks.
        </p><p>
         For more information, see
         <a class="link" href="http://openvpn.net/index.php/open-source/documentation/howto.html#mitm" target="_blank">http://openvpn.net/index.php/open-source/documentation/howto.html#mitm</a>.
        </p></div><p>
        Finish with <span class="guimenu">Ok</span> and proceed with
        <span class="guimenu">Next</span>.
       </p></li><li class="step "><p>
        Review the summary. YaST displays the current settings for
        confirmation. Click <span class="guimenu">Create</span>. When the VPN server
        certificate is created, it is displayed in the
        <span class="guimenu">Certificates</span> tab.
       </p></li></ol></li><li class="step " id="st.security.vpn.serverca.vpnclientca"><p>
      Create VPN client certificates:
     </p><ol type="a" class="substeps "><li class="step "><p>
        Make sure you are on the <span class="guimenu">Certificates</span> tab.
       </p></li><li class="step "><p>
        Click <span class="guimenu">Add</span> › <span class="guimenu">Add Client
        Certificate</span>.
       </p></li><li class="step "><p>
        Enter a <span class="guimenu">Common Name</span>, for example,
        <code class="systemitem">client1.example.com</code>.
       </p></li><li class="step "><p>
        Enter the e-mail addresses for your client, for example,
        <code class="systemitem">user1@client1.example.com</code>,
        and click <span class="guimenu">Add</span>. Proceed with
        <span class="guimenu">Next</span>.
       </p></li><li class="step "><p>
        Enter your password twice and click <span class="guimenu">Advanced
        options</span>.
       </p><p> Switch to <span class="guimenu">Advanced Settings</span> › <span class="guimenu">Key Usage</span> list and check one of the following flags: </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
          <code class="option">digitalSignature</code> or,
         </p></li><li class="listitem "><p>
          <code class="option">keyAgreement</code> or,
         </p></li><li class="listitem "><p>
          <code class="option">digitalSignature</code> and
          <code class="option">keyAgreement</code>.
         </p></li></ul></div><p>
        Switch to the <span class="guimenu">Advanced Settings</span> › <span class="guimenu">extendedKeyUsage</span> and type
        <code class="option">clientAuth</code> for a server certificate.
       </p></li><li class="step "><p>
        Review the summary. YaST displays the current settings for
        confirmation. Click <span class="guimenu">Create</span>. The VPN client
        certificate is created and is displayed in the
        <span class="guimenu">Certificates</span> tab.
       </p></li><li class="step "><p>
        If you need certificates for more clients, repeat
        <a class="xref" href="#st.security.vpn.serverca.vpnclientca" title="Step 3">Step 3</a>.
       </p></li></ol></li></ol></div></div><p>
    After you have successfully finished
    <a class="xref" href="#pro.security.vpn.serverca" title="Creating a VPN Server Certificate">Procedure 17.3, “Creating a VPN Server Certificate”</a> you have a VPN root CA, a
    VPN server CA, and one or more VPN client CAs. To finish the task,
    proceed with the following procedure:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Choose the <span class="guimenu">Certificates</span> tab.
     </p></li><li class="step "><p>
      Export the VPN server certificate in two formats: PEM and unencrypted
      key in PEM.
     </p><ol type="a" class="substeps "><li class="step " id="st.security.vpn.selectserverca"><p>
        Select your VPN server certificate
        (<code class="systemitem">openvpn.example.com</code>
        in our example) and choose <span class="guimenu">Export</span> › <span class="guimenu">Export to File</span>.
       </p></li><li class="step " id="st.security.vpn.selectsaveca"><p>
        Select <span class="guimenu">Only the Certificate in PEM Format</span>, enter
        your VPN server certificate password and save the file to
        <code class="filename">/etc/openvpn/server_crt.pem</code>.
       </p></li><li class="step "><p>
        Repeat <a class="xref" href="#st.security.vpn.selectserverca" title="Step 2.a">Step 2.a</a> and
        <a class="xref" href="#st.security.vpn.selectsaveca" title="Step 2.b">Step 2.b</a>, but choose the
        format <span class="guimenu">Only the Key Unencrypted in PEM Format</span>.

        Save the file to <code class="filename">/etc/openvpn/server_key.pem</code>.
       </p></li></ol></li><li class="step "><p>
      Export the VPN client certificates and choose an export format, PEM or
      PKCS12 (preferred). For each client:
     </p><ol type="a" class="substeps "><li class="step " id="st.security.vpn.selectclient.ca"><p>
        Select your VPN client certificate
        (<code class="systemitem">client1.example.com</code>
        in our example) and choose <span class="guimenu">Export</span> › <span class="guimenu">Export to File</span>.
       </p></li><li class="step "><p> Select <span class="guimenu">Like PKCS12 and Include the CA
                  Chain</span>, enter your VPN client certificate key
                password and provide a PKCS12 password. Enter a
                  <span class="guimenu">File Name</span>, click
                  <span class="guimenu">Browse</span> and save the file to
                  <code class="filename">/etc/openvpn/client1.p12</code>. </p></li></ol></li><li class="step "><p>
      Copy the files to your client (in our example,
      <code class="systemitem">client1.example.com</code>).
     </p></li><li class="step "><p>
      Export the VPN CA (in our example
      <code class="systemitem">VPN-Server-CA</code>):
     </p><ol type="a" class="substeps "><li class="step "><p>
        Switch to the <span class="guimenu">Description</span> tab.
       </p></li><li class="step "><p>
        Select <span class="guimenu">Advanced</span> › <span class="guimenu">Export to
        File</span>.
       </p></li><li class="step "><p>
        Mark <span class="guimenu">Only the Certificate in PEM Format</span> and save
        the file to <code class="filename">/etc/openvpn/vpn_ca.pem</code>.
       </p></li></ol></li></ol></div></div><p>
    If desired, the client PKCS12 file can be converted into the PEM format
    using this command:
   </p><div class="verbatim-wrap"><pre class="screen">openssl pkcs12 -in client1.p12 -out client1.pem</pre></div><p>
    Enter your client password to create the
    <code class="filename">client1.pem</code> file. The PEM file contains the client
    certificate, client key, and the CA certificate. You can split this
    combined file using a text editor and create three separate files. The
    file names can be used for the <code class="option">ca</code>,
    <code class="option">cert</code>, and <code class="option">key</code> options in the OpenVPN
    configuration file (see <a class="xref" href="#ex.vpn.serv-config" title="VPN Server Configuration File">Example 17.1, “VPN Server Configuration File”</a>).
   </p></div><div class="sect2 " id="sec.security.vpn.config-server"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.config-server"><span class="number">17.3.2 </span><span class="name">Configuring the VPN Server</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.config-server">#</a></h3></div></div></div><p>
    As the basis of your configuration file, copy
    <code class="filename">/usr/share/doc/packages/openvpn/sample-config-files/server.conf</code>
    to <code class="filename">/etc/openvpn/</code>. Then customize it to your needs.
   </p><div class="example" id="ex.vpn.serv-config"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 17.1: </span><span class="name">VPN Server Configuration File </span><a title="Permalink" class="permalink" href="#ex.vpn.serv-config">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"># /etc/openvpn/server.conf
port 1194 <span id="co.vpn.servconfig.port"></span><span class="callout">1</span>
proto udp <span id="co.vpn.servconfig.proto"></span><span class="callout">2</span>
dev tun0 <span id="co.vpn.servconfig.dev"></span><span class="callout">3</span>

# Security <span id="co.vpn.servconfig.security"></span><span class="callout">4</span>

ca    vpn_ca.pem
cert  server_crt.pem
key   server_key.pem

# ns-cert-type server 
remote-cert-tls client <span id="co.vpn.servconfig.remote-cert-tls"></span><span class="callout">5</span>
dh   server/dh2048.pem <span id="co.vpn.servconfig.dh"></span><span class="callout">6</span>

server 192.168.1.0 255.255.255.0 <span id="co.vpn.servconfig.server"></span><span class="callout">7</span>
ifconfig-pool-persist /var/run/openvpn/ipp.txt <span id="co.vpn.servconfig.pool"></span><span class="callout">8</span>

# Privileges <span id="co.vpn.serverconf.privilege"></span><span class="callout">9</span>
user nobody
group nobody

# Other configuration <span id="co.vpn.servconfig.misc"></span><span class="callout">10</span>
keepalive 10 120
comp-lzo
persist-key
persist-tun
# status      /var/log/openvpn-status.tun0.log <span id="co.vpn.serverconfig.status"></span><span class="callout">11</span>
# log-append  /var/log/openvpn-server.log <span id="co.vpn.serverconfig.log-append"></span><span class="callout">12</span>
verb 4</pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.port"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
      The TCP/UDP port on which OpenVPN listens. You need to open the port
      in the firewall, see <a class="xref" href="#cha.security.firewall" title="Chapter 16. Masquerading and Firewalls">Chapter 16, <em>Masquerading and Firewalls</em></a>. The
      standard port for VPN is 1194, so you can usually leave that as
      it is.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.proto"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
      The protocol, either UDP or TCP.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.dev"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
      The tun or tap device. For the difference between these, see
      <a class="xref" href="#sec.security.vpn.terminology" title="17.1.1. Terminology">Section 17.1.1, “Terminology”</a>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.security"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
      The following lines contain the relative or absolute path to the root
      server CA certificate (<code class="literal">ca</code>), the root CA key
      (<code class="literal">cert</code>), and the private server key
      (<code class="literal">key</code>). These were generated in
      <a class="xref" href="#sec.security.vpn.certs" title="17.3.1. Creating Certificates">Section 17.3.1, “Creating Certificates”</a>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.remote-cert-tls"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p> Require that peer certificates have been signed with an
            explicit key usage and extended key usage based on RFC3280
            TLS rules. There is a description of how to make a server
            use this explicit key in <a class="xref" href="#pro.security.vpn.serverca" title="Creating a VPN Server Certificate">Procedure 17.3, “Creating a VPN Server Certificate”</a>. </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.dh"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p> The Diffie-Hellman parameters. Create the required file with
            the following command: </p><div class="verbatim-wrap"><pre class="screen">openssl dhparam -out /etc/openvpn/dh2048.pem 2048</pre></div></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.server"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
      Supplies a VPN subnet. The server can be reached by
      <code class="systemitem">192.168.1.1</code>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.pool"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>
      Records a mapping of clients and its virtual IP address in the given
      file. Useful when the server goes down and (after the restart) the
      clients get their previously assigned IP address.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.serverconf.privilege"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>
      For security reasons, run the OpenVPN daemon with reduced privileges. To
      do so, specify that it should use the group and user
      <code class="systemitem">nobody</code>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.servconfig.misc"><span class="callout">10</span></a> </p></td><td valign="top" align="left"><p> Several other configuration options—see the comment in the
            example configuration file:
              <code class="filename">/usr/share/doc/packages/openvpn/sample-config-files</code>. </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.serverconfig.status"><span class="callout">11</span></a> </p></td><td valign="top" align="left"><p>
      Enable this option to write short status updates with statistical data
      (<span class="quote">“<span class="quote">operational status dump</span>”</span>) to the named file.
      By default, this is not enabled.
     </p><p>
      All output is written to syslog. If you have more than one
      configuration file (for example, one for home and another for work), it
      is recommended to include the device name into the file name. This
      avoids overwriting output files accidentally. In this case,
      it is <code class="systemitem">tun0</code>, taken from the
      <code class="option">dev</code> directive—see
      <a class="xref" href="#co.vpn.servconfig.dev"><span class="callout">3</span></a>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.serverconfig.log-append"><span class="callout">12</span></a> </p></td><td valign="top" align="left"><p>
      By default, log messages go to syslog. Overwrite this behavior by
      removing the hash character. In that case, all messages go to
      <code class="filename">/var/log/openvpn-server.log</code>. Do not forget to
      configure a logrotate service. See <code class="command">man 8 logrotate</code>
      for further details.
     </p></td></tr></table></div><p>
    After having completed this configuration, you can see log messages of
    your OpenVPN server under <code class="filename">/var/log/openvpn.log</code>.
    After having started it for the first time, it should finish with:
   </p><div class="verbatim-wrap"><pre class="screen">... Initialization Sequence Completed</pre></div><p>
    If you do not see this message, check the log carefully for any hints of
    what is wrong in your configuration file.
   </p></div><div class="sect2 " id="sec.security.vpn.config-clients"><div class="titlepage"><div><div><h3 class="title" id="sec.security.vpn.config-clients"><span class="number">17.3.3 </span><span class="name">Configuring the VPN Clients</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.config-clients">#</a></h3></div></div></div><p>
    As the basis of your configuration file, copy
    <code class="filename">/usr/share/doc/packages/openvpn/sample-config-files/client.conf</code>
    to <code class="filename">/etc/openvpn/</code>. Then customize it to your needs.
   </p><div class="example" id="idm140712068107424"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 17.2: </span><span class="name">VPN Client Configuration File </span><a title="Permalink" class="permalink" href="#idm140712068107424">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"># /etc/openvpn/client.conf
client <span id="co.vpn.clientconf.client"></span><span class="callout">1</span>
dev tun <span id="co.vpn.clientconf.dev"></span><span class="callout">2</span>
proto udp <span id="co.vpn.clientconf.proto"></span><span class="callout">3</span>
remote <em class="replaceable ">IP_OR_HOST_NAME</em> 1194 <span id="co.vpn.clientconf.remote"></span><span class="callout">4</span>
resolv-retry infinite
nobind

remote-cert-tls server <span id="co.vpn.clientconf.remote-cert-tls"></span><span class="callout">5</span>

# Privileges <span id="co.vpn.clientconf.privileges"></span><span class="callout">6</span>
user nobody
group nobody

# Try to preserve some state across restarts.
persist-key
persist-tun

# Security <span id="co.vpn.clientconf.security"></span><span class="callout">7</span>
pkcs12 client1.p12

comp-lzo <span id="co.vpn.clientconf.compr"></span><span class="callout">8</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.client"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
       Specifies that this machine is a client.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.dev"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
       The network device. Both clients and server must use the same device.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.proto"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
       The protocol. Use the same settings as on the server.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.remote-cert-tls"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
       This is security option for clients which ensures that the host
       they connect to is a designated server.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.remote"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
       Replace the placeholder <em class="replaceable ">IP_OR_HOST_NAME</em>
       with the respective host name or IP address of your VPN server. After
       the host name, the port of the server is given. You can have multiple
       lines of <code class="literal">remote</code> entries pointing to different VPN
       servers. This is useful for load balancing between different VPN
       servers.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.privileges"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
       For security reasons, run the OpenVPN daemon with reduced privileges. To
       do so, specify that it should use the group and user
       <code class="systemitem">nobody</code>.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.security"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
       Contains the client files. For security reasons, use a separate pair of
       files for each client.
      </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.vpn.clientconf.compr"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>
       Turn on compression. Only use this parameter if compression is enabled
       on the server as well.
      </p></td></tr></table></div></div></div></div></div><div class="sect1 " id="sec.security.yastvpn"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yastvpn"><span class="number">17.4 </span><span class="name">Setting Up a VPN Server or Client Using YaST</span> <a title="Permalink" class="permalink" href="#sec.security.yastvpn">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_vpnserver_yast.xml</li><li><span class="ds-label">ID: </span>sec.security.yastvpn</li></ul></div></div></div></div><p>
  You can also use YaST to set up a VPN server. However, the YaST module
  does not support OpenVPN. Instead, it provides support for the IPsec protocol
  (as implemented in the software
  <span class="productname">StrongSwan</span>). Like OpenVPN, IPsec
  is a widely supported VPN scheme.
 </p><div class="procedure " id="pro.security.yastvpn.server"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 17.4: </span><span class="name">Setting Up an IPsec Server </span><a title="Permalink" class="permalink" href="#pro.security.yastvpn.server">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     To start the YaST VPN module, select
     <span class="guimenu">Applications</span> › <span class="guimenu">VPN Gateways and Clients</span>.
    </p></li><li class="step "><p>
     Under <span class="guimenu">Global Configuration</span>, activate
     <span class="guimenu">Enable VPN Daemon</span>.
    </p></li><li class="step "><p>
     To create a new VPN, click <span class="guimenu">New VPN</span>, then enter a name
     for the connection.
    </p></li><li class="step "><p>
     Under <span class="guimenu">Type</span>, select <span class="guimenu">Gateway (Server)</span>.
    </p></li><li class="step "><p>
     Then choose the scenario:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       The scenarios <span class="guimenu">Secure communication with a pre-shared
       key</span> and <span class="guimenu">Secure communication with a
       certificate</span> are best suited to Linux client setups.
      </p></li><li class="listitem "><p>
       The scenario <span class="guimenu">Provide access to Android, iOS, Mac OS X
       clients</span> sets up a configuration that is natively supported by
       modern versions of Android, iOS, and macOS. It is based on a pre-shared
       key setup with an additional user name and password authentication.
      </p></li><li class="listitem "><p>
       The scenario <span class="guimenu">Provide access to Windows 7, Windows 8
       clients</span> is a configuration that is natively supported by
       Windows and BlackBerry devices. It is based on a certificate setup
       with an additional user name and password authentication.
      </p></li></ul></div><p>
     For this example, choose <span class="guimenu">Secure communication with a pre-shared
     key</span>.
    </p></li><li class="step "><p>
     To specify the key, click <span class="guimenu">Edit Credentials</span>. Activate
     <span class="guimenu">Show key</span>, then type the secret key. Confirm with
     <span class="guimenu">OK</span>.
    </p></li><li class="step "><p>
     Choose whether and how to limit access within your VPN under
     <span class="guimenu">Provide VPN clients access to</span>. To enable only certain
     IP ranges, specify these in CIDR format, separated by commas in
     <span class="guimenu">Limited CIDRs</span>. For more information about the CIDR
     format, see
     <a class="link" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank">https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing</a>.
    </p></li><li class="step "><p>
     Under <span class="guimenu">Clients' address pool</span>, specify the format of IP
     addresses your VPN should provide to its clients.
    </p></li><li class="step "><p>
     To finish, click <span class="guimenu">OK</span>. The YaST VPN module will now
     automatically add and enable firewall rules to allow clients to connect to
     the new VPN.
    </p><p>
     To view the connection status,
     in the following confirmation window, click <span class="guimenu">Yes</span>.
     You will then see the output of
     <code class="command">systemctl status</code> for your VPN, which allows you to check
     if the VPN is running and configured correctly.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.security.vpn.moreinfo"><div class="titlepage"><div><div><h2 class="title" id="sec.security.vpn.moreinfo"><span class="number">17.5 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.security.vpn.moreinfo">#</a></h2></div></div></div><p>
   For more information on setting up a VPN connection using NetworkManager, see
   <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 28 “Using NetworkManager”, Section 28.3.4 “NetworkManager and VPN”</span>.
  </p><p>
   For more information about VPN in general, see:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <a class="link" href="http://www.openvpn.net" target="_blank">http://www.openvpn.net</a>: the OpenVPN home page
    </p></li><li class="listitem "><p>
     <code class="command">man</code> <code class="option">openvpn</code>
    </p></li><li class="listitem "><p>
     <code class="filename">/usr/share/doc/packages/openvpn/sample-config-files/</code>:
     example configuration files for different scenarios.
    </p></li><li class="listitem "><p>
     <code class="filename">/usr/src/linux/Documentation/networking/tuntap.txt</code>,
     to install the <code class="systemitem">kernel-source</code>
     package.
    </p></li></ul></div></div></div><div class="chapter " id="cha.security.yast_ca"><div class="titlepage"><div><div><h2 class="title"><span class="number">18 </span><span class="name">Managing X.509 Certification</span> <a title="Permalink" class="permalink" href="#cha.security.yast_ca">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>security_yast2_ca.xml</li><li><span class="ds-label">ID: </span>cha.security.yast_ca</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712068044880">#</a></h6></div><p>
    An increasing number of authentication mechanisms are based on
    cryptographic procedures. Digital certificates that assign cryptographic
    keys to their owners play an important role in this context. These
    certificates are used for communication and can also be found, for
    example, on company ID cards. The generation and administration of
    certificates is mostly handled by official institutions that offer this
    as a commercial service. In some cases, however, it may make sense to
    carry out these tasks yourself. For example, if a company does not want
    to pass personal data to third parties.
   </p><p>
    YaST provides two modules for certification, which offer basic
    management functions for digital X.509 certificates. The following
    sections explain the basics of digital certification and how to use
    YaST to create and administer certificates of this type.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.security.yast_ca.intro"><span class="number">18.1 </span><span class="name">The Principles of Digital Certification</span></a></span></dt><dt><span class="sect1"><a href="#sec.security.yast_ca.module"><span class="number">18.2 </span><span class="name">YaST Modules for CA Management</span></a></span></dt></dl></div></div><div class="sect1 " id="sec.security.yast_ca.intro"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_ca.intro"><span class="number">18.1 </span><span class="name">The Principles of Digital Certification</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro">#</a></h2></div></div></div><p>
   Digital certification uses cryptographic processes to encrypt and protect
   data from access by unauthorized people. The user data is encrypted using
   a second data record, or <span class="emphasis"><em>key</em></span>. The key is applied to
   the user data in a mathematical process, producing an altered data record
   in which the original content can no longer be identified. Asymmetrical
   encryption is now in general use (<span class="emphasis"><em>public key
   method</em></span>). Keys always occur in pairs:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712068038256"><span class="term ">Private Key</span></dt><dd><p>
      The private key must be kept safely by the key owner. Accidental
      publication of the private key compromises the key pair and renders it
      useless.
     </p></dd><dt id="idm140712068036304"><span class="term ">Public Key</span></dt><dd><p>
      The key owner circulates the public key for use by third parties.
     </p></dd></dl></div><div class="sect2 " id="sec.security.yast_ca.intro.keyauth"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.intro.keyauth"><span class="number">18.1.1 </span><span class="name">Key Authenticity</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro.keyauth">#</a></h3></div></div></div><p>
    Because the public key process is in widespread use, there are many
    public keys in circulation. Successful use of this system requires that
    every user be sure that a public key actually belongs to the assumed
    owner. The assignment of users to public keys is confirmed by
    trustworthy organizations with public key certificates. Such
    certificates contain the name of the key owner, the corresponding public
    key, and the electronic signature of the person issuing the certificate.
   </p><p>
    Trustworthy organizations that issue and sign public key certificates
    are usually part of a certification infrastructure.  This is
    responsible for the other aspects of certificate management, such as
    publication, withdrawal, and renewal of certificates. An infrastructure
    of this kind is generally called a <span class="emphasis"><em>public key
    infrastructure</em></span> or <span class="emphasis"><em>PKI</em></span>. One familiar PKI
    is the <span class="emphasis"><em>OpenPGP</em></span> standard in which users publish
    their certificates themselves without central authorization points.
    These certificates become trustworthy when signed by other parties in
    the <span class="quote">“<span class="quote">web of trust.</span>”</span>
   </p><p>
    The <span class="emphasis"><em>X.509 Public Key Infrastructure</em></span> (PKIX) is an
    alternative model defined by the <span class="emphasis"><em>IETF</em></span> (Internet
    Engineering Task Force) that serves as a model for almost all
    publicly-used PKIs today. In this model, authentication is made by
    <span class="emphasis"><em>certificate authorities</em></span> (CA) in a hierarchical tree
    structure. The root of the tree is the root CA, which certifies all
    sub-CAs. The lowest level of sub-CAs issue user certificates. The user
    certificates are trustworthy by certification that can be traced to the
    root CA.
   </p><p>
    The security of such a PKI depends on the trustworthiness of the CA
    certificates. To make certification practices clear to PKI customers,
    the PKI operator defines a <span class="emphasis"><em>certification practice
    statement</em></span> (CPS) that defines the procedures for certificate
    management. This should ensure that the PKI only issues trustworthy
    certificates.
   </p></div><div class="sect2 " id="sec.security.yast_ca.intro.x509"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.intro.x509"><span class="number">18.1.2 </span><span class="name">X.509 Certificates</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro.x509">#</a></h3></div></div></div><p>
    An X.509 certificate is a data structure with several fixed fields and,
    optionally, additional extensions. The fixed fields mainly contain the
    name of the key owner, the public key, and the data relating to the
    issuing CA (name and signature). For security reasons, a certificate
    should only have a limited period of validity, so a field is also
    provided for this date. The CA guarantees the validity of the
    certificate in the specified period. The CPS usually requires the PKI
    (the issuing CA) to create and distribute a new certificate before
    expiration.
   </p><p>
    The extensions can contain any additional information. An application is
    only required to be able to evaluate an extension if it is identified as
    <span class="emphasis"><em>critical</em></span>. If an application does not recognize a
    critical extension, it must reject the certificate. Some extensions are
    only useful for a specific application, such as signature or encryption.
   </p><p>
    <a class="xref" href="#tab.yast.ca.intro.x509" title="X.509v3 Certificate">Table 18.1</a>
    shows the fields of a basic X.509 certificate in version 3.
   </p><div class="table" id="tab.yast.ca.intro.x509"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 18.1: </span><span class="name">X.509v3 Certificate </span><a title="Permalink" class="permalink" href="#tab.yast.ca.intro.x509">#</a></h6></div><div class="table-contents"><table summary="X.509v3 Certificate" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
        <p>
         Field
        </p>
       </th><th>
        <p>
         Content
        </p>
       </th></tr></thead><tbody><tr><td>
        <p>
         Version
        </p>
       </td><td>
        <p>
         The version of the certificate, for example, v3
        </p>
       </td></tr><tr><td>
        <p>
         Serial Number
        </p>
       </td><td>
        <p>
         Unique certificate ID (an integer)
        </p>
       </td></tr><tr><td>
        <p>
         Signature
        </p>
       </td><td>
        <p>
         The ID of the algorithm used to sign the certificate
        </p>
       </td></tr><tr><td>
        <p>
         Issuer
        </p>
       </td><td>
        <p>
         Unique name (DN) of the issuing authority (CA)
        </p>
       </td></tr><tr><td>
        <p>
         Validity
        </p>
       </td><td>
        <p>
         Period of validity
        </p>
       </td></tr><tr><td>
        <p>
         Subject
        </p>
       </td><td>
        <p>
         Unique name (DN) of the owner
        </p>
       </td></tr><tr><td>
        <p>
         Subject Public Key Info
        </p>
       </td><td>
        <p>
         Public key of the owner and the ID of the algorithm
        </p>
       </td></tr><tr><td>
        <p>
         Issuer Unique ID
        </p>
       </td><td>
        <p>
         Unique ID of the issuing CA (optional)
        </p>
       </td></tr><tr><td>
        <p>
         Subject Unique ID
        </p>
       </td><td>
        <p>
         Unique ID of the owner (optional)
        </p>
       </td></tr><tr><td>
        <p>
         Extensions
        </p>
       </td><td>
        <p>
         Optional additional information, such as <span class="quote">“<span class="quote">KeyUsage</span>”</span> or
         <span class="quote">“<span class="quote">BasicConstraints</span>”</span>
        </p>
       </td></tr></tbody></table></div></div></div><div class="sect2 " id="sec.security.yast_ca.intro.crl"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.intro.crl"><span class="number">18.1.3 </span><span class="name">Blocking X.509 Certificates</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro.crl">#</a></h3></div></div></div><p>
    If a certificate becomes untrustworthy before it has expired, it must be
    blocked immediately. This can become necessary if, for example, the
    private key has accidentally been made public. Blocking certificates is
    especially important if the private key belongs to a CA rather than a
    user certificate. In this case, all user certificates issued by the
    relevant CA must be blocked immediately. If a certificate is blocked,
    the PKI (the responsible CA) must make this information available to all
    those involved using a <span class="emphasis"><em>certificate revocation list</em></span>
    (CRL).
   </p><p>
    These lists are supplied by the CA to public CRL distribution points
    (CDPs) at regular intervals. The CDP can optionally be named as an
    extension in the certificate, so a checker can fetch a current CRL for
    validation purposes. One way to do this is the <span class="emphasis"><em>online
    certificate status protocol</em></span> (OCSP). The authenticity of the
    CRLs is ensured with the signature of the issuing CA.
    <a class="xref" href="#tab.yast.ca.intro.crl" title="X.509 Certificate Revocation List (CRL)">Table 18.2</a>
    shows the basic parts of a X.509 CRL.
   </p><div class="table" id="tab.yast.ca.intro.crl"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 18.2: </span><span class="name">X.509 Certificate Revocation List (CRL) </span><a title="Permalink" class="permalink" href="#tab.yast.ca.intro.crl">#</a></h6></div><div class="table-contents"><table summary="X.509 Certificate Revocation List (CRL)" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
        <p>
         Field
        </p>
       </th><th>
        <p>
         Content
        </p>
       </th></tr></thead><tbody><tr><td>
        <p>
         Version
        </p>
       </td><td>
        <p>
         The version of the CRL, such as v2
        </p>
       </td></tr><tr><td>
        <p>
         Signature
        </p>
       </td><td>
        <p>
         The ID of the algorithm used to sign the CRL
        </p>
       </td></tr><tr><td>
        <p>
         Issuer
        </p>
       </td><td>
        <p>
         Unique name (DN) of the publisher of the CRL (usually the issuing
         CA)
        </p>
       </td></tr><tr><td>
        <p>
         This Update
        </p>
       </td><td>
        <p>
         Time of publication (date, time) of this CRL
        </p>
       </td></tr><tr><td>
        <p>
         Next Update
        </p>
       </td><td>
        <p>
         Time of publication (date, time) of the next CRL
        </p>
       </td></tr><tr><td>
        <p>
         List of revoked certificates
        </p>
       </td><td>
        <p>
         Every entry contains the serial number of the certificate, the time
         of revocation, and optional extensions (CRL entry extensions)
        </p>
       </td></tr><tr><td>
        <p>
         Extensions
        </p>
       </td><td>
        <p>
         Optional CRL extensions
        </p>
       </td></tr></tbody></table></div></div></div><div class="sect2 " id="sec.security.yast_ca.intro.repository"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.intro.repository"><span class="number">18.1.4 </span><span class="name">Repository for Certificates and CRLs</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro.repository">#</a></h3></div></div></div><p>
    The certificates and CRLs for a CA must be made publicly accessible using
    a <span class="emphasis"><em>repository</em></span>. Because the signature protects the
    certificates and CRLs from being forged, the repository itself does not
    need to be secured in a special way. Instead, it tries to grant the
    simplest and fastest access possible. For this reason, certificates are
    often provided on an LDAP or HTTP server. Find explanations about LDAP in
    <a class="xref" href="#cha.security.ldap" title="Chapter 5. LDAP—A Directory Service">Chapter 5, <em>LDAP—A Directory Service</em></a>.  <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 24 “The Apache HTTP Server”</span> contains information about the HTTP server.
   </p></div><div class="sect2 " id="sec.security.yast_ca.intro.ldap"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.intro.ldap"><span class="number">18.1.5 </span><span class="name">Proprietary PKI</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.intro.ldap">#</a></h3></div></div></div><p>
    YaST contains modules for the basic management of X.509
    certificates. This mainly involves the creation of CAs, sub-CAs, and
    their certificates. The services of a PKI go far beyond simply creating
    and distributing certificates and CRLs. The operation of a PKI requires
    a well-conceived administrative infrastructure allowing continuous
    update of certificates and CRLs. This infrastructure is provided by
    commercial PKI products and can also be partly automated. YaST
    provides tools for creating and distributing CAs and certificates, but
    cannot currently offer this background infrastructure. To set up a small
    PKI, you can use the available YaST modules. However, you should
    use commercial products to set up an <span class="quote">“<span class="quote">official</span>”</span> or
    commercial PKI.
   </p></div></div><div class="sect1 " id="sec.security.yast_ca.module"><div class="titlepage"><div><div><h2 class="title" id="sec.security.yast_ca.module"><span class="number">18.2 </span><span class="name">YaST Modules for CA Management</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module">#</a></h2></div></div></div><p>
   YaST provides two modules for basic CA management. The primary
   management tasks with these modules are explained here.
  </p><div class="sect2 " id="sec.security.yast_ca.module.rootca"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.rootca"><span class="number">18.2.1 </span><span class="name">Creating a Root CA</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.rootca">#</a></h3></div></div></div><p>
     The first step when setting up a
    PKI is to create a root CA. Do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and go to <span class="guimenu">Security and
      Users</span> › <span class="guimenu">CA Management</span>.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Create Root CA</span>.
     </p></li><li class="step "><p>
      Enter the basic data for the CA in the first dialog, shown in
      <a class="xref" href="#fig.yast.ca.ca_basic" title="YaST CA Module—Basic Data for a Root CA">Figure 18.1</a>.
      The text boxes have the following meanings:
     </p><div class="figure" id="fig.yast.ca.ca_basic"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_ca_basic.png"><img src="images/yast2_ca_basic.png" width="" alt="YaST CA Module—Basic Data for a Root CA" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 18.1: </span><span class="name">YaST CA Module—Basic Data for a Root CA </span><a title="Permalink" class="permalink" href="#fig.yast.ca.ca_basic">#</a></h6></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712067943888"><span class="term "><span class="guimenu">CA Name</span>
       </span></dt><dd><p>
         Enter the technical name of the CA. Directory names, among other
         things, are derived from this name, which is why only the
         characters listed in the help can be used. The technical name is
         also displayed in the overview when the module is started.
        </p></dd><dt id="idm140712067941536"><span class="term "><span class="guimenu">Common Name</span>
       </span></dt><dd><p>
         Enter the name for use in referring to the CA.
        </p></dd><dt id="idm140712067939408"><span class="term "><span class="guimenu">E-Mail Addresses</span>
       </span></dt><dd><p>
         Several e-mail addresses can be entered that can be seen by the CA
         user. This can be helpful for inquiries.
        </p></dd><dt id="idm140712067937216"><span class="term "><span class="guimenu">Country</span>
       </span></dt><dd><p>
         Select the country where the CA is operated.
        </p></dd><dt id="idm140712067935088"><span class="term "><span class="guimenu">Organization</span>, <span class="guimenu">Organizational Unit</span>,
         <span class="guimenu">Locality</span>, <span class="guimenu">State</span>
       </span></dt><dd><p>
         Optional values
        </p></dd></dl></div><p>
      Proceed with <span class="guimenu">Next</span>.
     </p></li><li class="step "><p>
      Enter a password in the second dialog. This password is always
      required when using the CA—when creating a sub-CA or
      generating certificates. The text boxes have the following meaning:
     </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067929216"><span class="term "><span class="guimenu">Key Length</span>
       </span></dt><dd><p>
         <span class="guimenu">Key Length</span> contains a meaningful default and
         does not generally need to be changed unless an application cannot
         deal with this key length. The higher the number the more secure
         your password is.
        </p></dd><dt id="idm140712067926480"><span class="term "><span class="guimenu">Valid Period (days)</span>
       </span></dt><dd><p>
         The <span class="guimenu">Valid Period</span> in the case of a CA defaults to
         3650 days (roughly ten years). This long period makes sense because
         the replacement of a deleted CA involves an enormous administrative
         effort.
        </p></dd></dl></div><p>
      Clicking <span class="guimenu">Advanced Options</span> opens a dialog for
      setting different attributes from the X.509 extensions
      (<a class="xref" href="#fig.yast.ca.extensions" title="YaST CA Module—Extended Settings">Figure 18.4, “YaST CA Module—Extended Settings”</a>). These values have rational
      default settings and should only be changed if you are really sure of
      what you are doing. Proceed with <span class="guimenu">Next</span>.
     </p></li><li class="step "><p>
      Review the summary. YaST displays the current settings for
      confirmation. Click <span class="guimenu">Create</span>. The root CA is created
      then appears in the overview.
     </p></li></ol></div></div><div id="idm140712067919696" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     In general, it is best not to allow user certificates to be issued by
     the root CA. It is better to create at least one sub-CA and create the
     user certificates from there. This has the advantage that the root CA
     can be kept isolated and secure, for example, on an isolated computer
     on secure premises. This makes it very difficult to attack the root CA.
    </p></div></div><div class="sect2 " id="sec.security.yast_ca.module.changepw"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.changepw"><span class="number">18.2.2 </span><span class="name">Changing Password</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.changepw">#</a></h3></div></div></div><p>
    If you need to change your password for your CA, proceed as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Select the required root CA and click <span class="guimenu">Enter CA</span>.
     </p></li><li class="step "><p>
      Enter the password if you entered a CA the first time. YaST
      displays the CA key information in the <span class="guimenu">Description</span>
      tab (see
      <a class="xref" href="#fig.yast.ca.usage" title="YaST CA Module—Using a CA">Figure 18.2</a>).
     </p></li><li class="step "><p>
      Click <span class="guimenu">Advanced</span> and select <span class="guimenu">Change CA
      Password</span>. A dialog opens.
     </p></li><li class="step "><p>
      Enter the old and the new password.
     </p></li><li class="step "><p>
      Finish with <span class="guimenu">OK</span>
     </p></li></ol></div></div></div><div class="sect2 " id="sec.security.yast_ca.module.subca"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.subca"><span class="number">18.2.3 </span><span class="name">Creating or Revoking a Sub-CA</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.subca">#</a></h3></div></div></div><p>
    A sub-CA is created in the same way as a root CA.
   </p><div id="idm140712067905648" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     The validity period for a sub-CA must be fully within the validity
     period of the <span class="quote">“<span class="quote">parent</span>”</span> CA. A sub-CA is always created
     after the <span class="quote">“<span class="quote">parent</span>”</span> CA, therefore, the default value leads
     to an error message. To avoid this, enter a permissible value for the
     period of validity.
    </p></div><p>
    Do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Select the required root CA and click <span class="guimenu">Enter CA</span>.
     </p></li><li class="step "><p>
      Enter the password if you are entering a CA for the first time.
      YaST displays the CA key information in the tab
      <span class="guimenu">Description</span> (see
      <a class="xref" href="#fig.yast.ca.usage" title="YaST CA Module—Using a CA">Figure 18.2</a>).
     </p><div class="figure" id="fig.yast.ca.usage"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_ca_usage.png"><img src="images/yast2_ca_usage.png" width="" alt="YaST CA Module—Using a CA" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 18.2: </span><span class="name">YaST CA Module—Using a CA </span><a title="Permalink" class="permalink" href="#fig.yast.ca.usage">#</a></h6></div></div></li><li class="step "><p>
      Click <span class="guimenu">Advanced</span> and select <span class="guimenu">Create
      SubCA</span>. This opens the same dialog as for creating a root CA.
     </p></li><li class="step "><p>
      Proceed as described in
      <a class="xref" href="#sec.security.yast_ca.module.rootca" title="18.2.1. Creating a Root CA">Section 18.2.1, “Creating a Root CA”</a>.
     </p><p>
      It is possible to use one password for all your CAs. Enable
      <span class="guimenu">Use CA Password as Certificate Password</span> to give
      your sub-CAs the same password as your root CA. This helps to reduce
      the amount of passwords for your CAs.
     </p><div id="idm140712067888576" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Check your Valid Period</h6><p>
       Take into account that the valid period must be lower than the valid
       period in the root CA.
      </p></div></li><li class="step "><p>
      Select the <span class="guimenu">Certificates</span> tab. Reset compromised or
      otherwise unwanted sub-CAs here, using <span class="guimenu">Revoke</span>.
      Revocation alone is not enough to deactivate a sub-CA. You must also
      publish revoked sub-CAs in a CRL. The creation of CRLs is described in
      <a class="xref" href="#sec.security.yast_ca.module.crl" title="18.2.6. Creating Certificate Revocation Lists (CRLs)">Section 18.2.6, “Creating Certificate Revocation Lists (CRLs)”</a>.
     </p></li><li class="step "><p>
      Finish with <span class="guimenu">OK</span>.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.security.yast_ca.module.clientserver"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.clientserver"><span class="number">18.2.4 </span><span class="name">Creating or Revoking User Certificates</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.clientserver">#</a></h3></div></div></div><p>
    Creating client and server certificates is very similar to creating CAs
    in <a class="xref" href="#sec.security.yast_ca.module.rootca" title="18.2.1. Creating a Root CA">Section 18.2.1, “Creating a Root CA”</a>. The same
    principles apply here. In certificates intended for e-mail signature,
    the e-mail address of the sender (the private key owner) should be
    contained in the certificate to enable the e-mail program to assign the
    correct certificate.
   </p><p>
    For certificate assignment during encryption, it is necessary for the
    e-mail address of the recipient (the public key owner) to be included in
    the certificate. In the case of server and client certificates, the host
    name of the server must be entered in the <span class="guimenu">Common Name</span>
    field. The default validity period for certificates is 365 days.
   </p><p>
    To create client and server certificates, do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Select the required root CA and click <span class="guimenu">Enter CA</span>.
     </p></li><li class="step "><p>
      Enter the password if you are entering a CA for the first time.
      YaST displays the CA key information in the
      <span class="guimenu">Description</span> tab.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Certificates</span> (see
      <a class="xref" href="#fig.yast.ca.cert" title="Certificates of a CA">Figure 18.3</a>).
     </p><div class="figure" id="fig.yast.ca.cert"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_ca_cert.png"><img src="images/yast2_ca_cert.png" width="" alt="Certificates of a CA" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 18.3: </span><span class="name">Certificates of a CA </span><a title="Permalink" class="permalink" href="#fig.yast.ca.cert">#</a></h6></div></div></li><li class="step "><p>
      Click <span class="guimenu">Add</span> › <span class="guimenu">Add Server
      Certificate</span> and create a server certificate.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Add</span> › <span class="guimenu">Add Client
      Certificate</span> and create a client certificate.
      Do not forget to enter an e-mail address.
     </p></li><li class="step "><p>
      Finish with <span class="guimenu">OK</span>
     </p></li></ol></div></div><p>
    To revoke compromised or otherwise unwanted certificates, do the
    following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Select the required root CA and click <span class="guimenu">Enter CA</span>.
     </p></li><li class="step "><p>
      Enter the password if you are entering a CA for the first time.
      YaST displays the CA key information in the
      <span class="guimenu">Description</span> tab.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Certificates</span> (see
      <a class="xref" href="#sec.security.yast_ca.module.subca" title="18.2.3. Creating or Revoking a Sub-CA">Section 18.2.3, “Creating or Revoking a Sub-CA”</a>).
     </p></li><li class="step "><p>
      Select the certificate to revoke and click <span class="guimenu">Revoke</span>.
     </p></li><li class="step "><p>
      Choose a reason to revoke this certificate.
     </p></li><li class="step "><p>
      Finish with <span class="guimenu">OK</span>.
     </p></li></ol></div></div><div id="idm140712067850512" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     Revocation alone is not enough to deactivate a certificate. Also
     publish revoked certificates in a CRL.
     <a class="xref" href="#sec.security.yast_ca.module.crl" title="18.2.6. Creating Certificate Revocation Lists (CRLs)">Section 18.2.6, “Creating Certificate Revocation Lists (CRLs)”</a> explains how to
     create CRLs. Revoked certificates can be completely removed after
     publication in a CRL with <span class="guimenu">Delete</span>.
    </p></div></div><div class="sect2 " id="sec.security.yast_ca.module.defaults"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.defaults"><span class="number">18.2.5 </span><span class="name">Changing Default Values</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.defaults">#</a></h3></div></div></div><p>
    The previous sections explained how to create sub-CAs, client
    certificates, and server certificates. Special settings are used in the
    extensions of the X.509 certificate. These settings have been given
    rational defaults for every certificate type and do not normally need to
    be changed. However, it may be that you have special requirements for
    these extensions. In this case, it may make sense to adjust the
    defaults. Otherwise, start from scratch every time you create a
    certificate.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Enter the required root CA, as described in
      <a class="xref" href="#sec.security.yast_ca.module.subca" title="18.2.3. Creating or Revoking a Sub-CA">Section 18.2.3, “Creating or Revoking a Sub-CA”</a>.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Advanced</span> › <span class="guimenu">Edit
      Default</span>.
     </p></li><li class="step "><p>
      Choose type of certificate to change and proceed with
      <span class="guimenu">Next</span>.
     </p></li><li class="step "><p>
      The dialog for changing the defaults as shown in
      <a class="xref" href="#fig.yast.ca.extensions" title="YaST CA Module—Extended Settings">Figure 18.4, “YaST CA Module—Extended Settings”</a> opens.
     </p><div class="figure" id="fig.yast.ca.extensions"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/yast2_ca_extensions.png"><img src="images/yast2_ca_extensions.png" width="" alt="YaST CA Module—Extended Settings" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 18.4: </span><span class="name">YaST CA Module—Extended Settings </span><a title="Permalink" class="permalink" href="#fig.yast.ca.extensions">#</a></h6></div></div></li><li class="step "><p>
      Change the associated value on the right side and set or delete the
      critical setting with <span class="guimenu">critical</span>.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Next</span> to see a short summary.
     </p></li><li class="step "><p>
      Finish your changes with <span class="guimenu">Save</span>.
     </p></li></ol></div></div><div id="idm140712067828672" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     All changes to the defaults only affect objects created after this
     point. Already-existing CAs and certificates remain unchanged.
    </p></div></div><div class="sect2 " id="sec.security.yast_ca.module.crl"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.crl"><span class="number">18.2.6 </span><span class="name">Creating Certificate Revocation Lists (CRLs)</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.crl">#</a></h3></div></div></div><p>
    If compromised or otherwise unwanted certificates need to be excluded
    from further use, they must first be revoked. The procedure for this is
    explained in <a class="xref" href="#sec.security.yast_ca.module.subca" title="18.2.3. Creating or Revoking a Sub-CA">Section 18.2.3, “Creating or Revoking a Sub-CA”</a> (for
    sub-CAs) and <a class="xref" href="#sec.security.yast_ca.module.clientserver" title="18.2.4. Creating or Revoking User Certificates">Section 18.2.4, “Creating or Revoking User Certificates”</a>
    (for user certificates). After this, a CRL must be created and published
    with this information.
   </p><p>
    The system maintains only one CRL for each CA. To create or update this
    CRL, do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open the CA module.
     </p></li><li class="step "><p>
      Enter the required CA, as described in
      <a class="xref" href="#sec.security.yast_ca.module.subca" title="18.2.3. Creating or Revoking a Sub-CA">Section 18.2.3, “Creating or Revoking a Sub-CA”</a>.
     </p></li><li class="step "><p>
      Click <span class="guimenu">CRL</span>. The dialog that opens displays a summary
      of the last CRL of this CA.
     </p></li><li class="step "><p>
      Create a new CRL with <span class="guimenu">Generate CRL</span> if you have
      revoked new sub-CAs or certificates since its creation.
     </p></li><li class="step "><p>
      Specify the period of validity for the new CRL (default: 30 days).
     </p></li><li class="step "><p>
      Click <span class="guimenu">OK</span> to create and display the CRL. Afterward,
      you must publish this CRL.
     </p></li></ol></div></div><div id="idm140712067815760" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     Applications that evaluate CRLs reject every certificate if the CRL is
     not available or has expired. As a PKI provider, it is your duty always
     to create and publish a new CRL before the current CRL expires (period
     of validity). YaST does not provide a function for automating this
     procedure.
    </p></div></div><div class="sect2 " id="sec.security.yast_ca.module.exportldap"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.exportldap"><span class="number">18.2.7 </span><span class="name">Exporting CA Objects to LDAP</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.exportldap">#</a></h3></div></div></div><p>
    The executing computer should be configured with the YaST LDAP
    client for LDAP export. This provides LDAP server information at runtime
    that can be used when completing dialog fields. Otherwise (although
    export may be possible), all LDAP data must be entered manually. You
    must always enter several passwords (see
    <a class="xref" href="#tab.yast.ca.ldap.password" title="Passwords during LDAP Export">Table 18.3, “Passwords during LDAP Export”</a>).
   </p><div class="table" id="tab.yast.ca.ldap.password"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 18.3: </span><span class="name">Passwords during LDAP Export </span><a title="Permalink" class="permalink" href="#tab.yast.ca.ldap.password">#</a></h6></div><div class="table-contents"><table summary="Passwords during LDAP Export" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
        <p>
         Password
        </p>
       </th><th>
        <p>
         Meaning
        </p>
       </th></tr></thead><tbody><tr><td>
        <p>
         LDAP Password
        </p>
       </td><td>
        <p>
         Authorizes the user to make entries in the LDAP tree.
        </p>
       </td></tr><tr><td>
        <p>
         Certificate Password
        </p>
       </td><td>
        <p>
         Authorizes the user to export the certificate.
        </p>
       </td></tr><tr><td>
        <p>
         New Certificate Password
        </p>
       </td><td>
        <p>
         The PKCS12 format is used during LDAP export. This format forces
         the assignment of a new password for the exported certificate.
        </p>
       </td></tr></tbody></table></div></div><p>
    Certificates, CAs, and CRLs can be exported to LDAP.
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067798816"><span class="term ">Exporting a CA to LDAP</span></dt><dd><p>
       To export a CA, enter the CA as described in
       <a class="xref" href="#sec.security.yast_ca.module.subca" title="18.2.3. Creating or Revoking a Sub-CA">Section 18.2.3, “Creating or Revoking a Sub-CA”</a>. Select
       <span class="guimenu">Extended</span> › <span class="guimenu">Export to
       LDAP</span> in the subsequent dialog, which opens the
       dialog for entering LDAP data. If your system has been configured
       with the YaST LDAP client, the fields are already partly
       completed. Otherwise, enter all the data manually. Entries are made
       in LDAP in a separate tree with the attribute
       <span class="quote">“<span class="quote">caCertificate</span>”</span>.
      </p></dd><dt id="idm140712067794624"><span class="term ">Exporting a Certificate to LDAP</span></dt><dd><p>
       Enter the CA containing the certificate to export then select
       <span class="guimenu">Certificates</span>. Select the required certificate from
       the certificate list in the upper part of the dialog and select
       <span class="guimenu">Export</span> › <span class="guimenu">Export to
       LDAP</span>. The LDAP data is entered here in the
       same way as for CAs. The certificate is saved with the corresponding
       user object in the LDAP tree with the attributes
       <span class="quote">“<span class="quote">userCertificate</span>”</span> (PEM format) and
       <span class="quote">“<span class="quote">userPKCS12</span>”</span> (PKCS12 format).
      </p></dd><dt id="idm140712067790096"><span class="term ">Exporting a CRL to LDAP</span></dt><dd><p>
       Enter the CA containing the CRL to export and select
       <span class="guimenu">CRL</span>. If desired, create a new CRL and click
       <span class="guimenu">Export</span>. The dialog that opens displays the export
       parameters. You can export the CRL for this CA either once or in
       periodical time intervals. Activate the export by selecting
       <span class="guimenu">Export to LDAP</span> and enter the respective LDAP data.
       To do this at regular intervals, select the <span class="guimenu">Repeated
       Recreation and Export</span> radio button and change the interval,
       if appropriate.
      </p></dd></dl></div></div><div class="sect2 " id="sec.security.yast_ca.module.exportfile"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.exportfile"><span class="number">18.2.8 </span><span class="name">Exporting CA Objects as a File</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.exportfile">#</a></h3></div></div></div><p>
    If you have set up a repository on the computer for administering CAs,
    you can use this option to create the CA objects directly as a file at
    the correct location. Different output formats are available, such as
    PEM, DER, and PKCS12. In the case of PEM, it is also possible to choose
    whether a certificate should be exported with or without key and whether
    the key should be encrypted. In the case of PKCS12, it is also possible
    to export the certification path.
   </p><p>
    Export a file in the same way for certificates, CAs as with LDAP,
    described in <a class="xref" href="#sec.security.yast_ca.module.exportldap" title="18.2.7. Exporting CA Objects to LDAP">Section 18.2.7, “Exporting CA Objects to LDAP”</a>,
    except you should select <span class="guimenu">Export as File</span> instead of
    <span class="guimenu">Export to LDAP</span>. This then takes you to a dialog for
    selecting the required output format and entering the password and file
    name. The certificate is stored at the required location after clicking
    <span class="guimenu">OK</span>.
   </p><p>
    For CRLs click <span class="guimenu">Export</span>, select <span class="guimenu">Export to
    file</span>, choose the export format (PEM or DER) and enter the
    path. Proceed with <span class="guimenu">OK</span> to save it to the respective
    location.
   </p><div id="idm140712067779184" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     You can select any storage location in the file system. This option can
     also be used to save CA objects on a transport medium, such as a flash
     disk. The <code class="filename">/media</code> directory generally holds any
     type of drive except the hard disk of your system.
    </p></div></div><div class="sect2 " id="sec.security.yast_ca.module.import"><div class="titlepage"><div><div><h3 class="title" id="sec.security.yast_ca.module.import"><span class="number">18.2.9 </span><span class="name">Importing Common Server Certificates</span> <a title="Permalink" class="permalink" href="#sec.security.yast_ca.module.import">#</a></h3></div></div></div><p>
    If you have exported a server certificate with YaST to your media
    on an isolated CA management computer, you can import this certificate
    on a server as a <span class="emphasis"><em>common server certificate</em></span>. Do this
    during installation or at a later point with YaST.
   </p><div id="idm140712067775184" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     You need one of the PKCS12 formats to import your certificate
     successfully.
    </p></div><p>
    The general server certificate is stored in
    <code class="command">/etc/ssl/servercerts</code> and can be used there by any
    CA-supported service. When this certificate expires, it can easily be
    replaced using the same mechanisms. To get things functioning with the
    replaced certificate, restart the participating services.
   </p><div id="idm140712067773056" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     If you select <span class="guimenu">Import</span> here, you can select the source
     in the file system. This option can also be used to import certificates
     from removable media, such as a flash disk.
    </p></div><p>
    To import a common server certificate, do the following:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST and open <span class="guimenu">Common Server Certificate</span>
      under <span class="guimenu">Security and Users</span>
     </p></li><li class="step "><p>
      View the data for the current certificate in the description field
      after YaST has been started.
     </p></li><li class="step "><p>
      Select <span class="guimenu">Import</span> and the certificate file.
     </p></li><li class="step "><p>
      Enter the password and click <span class="guimenu">Next</span>. The certificate
      is imported then displayed in the description field.
     </p></li><li class="step "><p>
      Close YaST with <span class="guimenu">Finish</span>.
     </p></li></ol></div></div></div></div></div></div><div class="part" id="part.apparmor"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part IV </span><span class="name">Confining Privileges with <span class="phrase">AppArmor</span> </span><a title="Permalink" class="permalink" href="#part.apparmor">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.apparmor.intro"><span class="number">19 </span><span class="name">Introducing <span class="phrase">AppArmor</span></span></a></span></dt><dd class="toc-abstract"><p>
  Many security vulnerabilities result from bugs in
  <span class="emphasis"><em>trusted</em></span> programs. A trusted program runs with
  privileges that attackers want to possess. The program fails to keep that
  trust if there is a bug in the program that allows the attacker to acquire
  said privilege.
 </p></dd><dt><span class="chapter"><a href="#cha.apparmor.start"><span class="number">20 </span><span class="name">Getting Started</span></a></span></dt><dd class="toc-abstract"><p>
  Prepare a successful deployment of <span class="phrase">AppArmor</span> on your system by carefully
  considering the following items:
 </p></dd><dt><span class="chapter"><a href="#cha.apparmor.concept"><span class="number">21 </span><span class="name">Immunizing Programs</span></a></span></dt><dd class="toc-abstract"><p>Effective hardening of a computer system requires minimizing the number of programs that mediate privilege, then securing the programs as much as possible. With AppArmor, you only need to profile the programs that are exposed to attack in your environment, which drastically reduces the amount of wor…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.profiles"><span class="number">22 </span><span class="name">Profile Components and Syntax</span></a></span></dt><dd class="toc-abstract"><p>Building AppArmor profiles to confine an application is very straightforward and intuitive. AppArmor ships with several tools that assist in profile creation. It does not require you to do any programming or script handling. The only task that is required of the administrator is to determine a polic…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.repos"><span class="number">23 </span><span class="name"><span class="phrase">AppArmor</span> Profile Repositories</span></a></span></dt><dd class="toc-abstract"><p>AppArmor ships with a set of profiles enabled by default. These are created by the AppArmor developers, and are stored in /etc/apparmor.d. In addition to these profiles, openSUSE Leap ships profiles for individual applications together with the relevant application. These profiles are not enabled by…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.yast"><span class="number">24 </span><span class="name">Building and Managing Profiles with YaST</span></a></span></dt><dd class="toc-abstract"><p>YaST provides a basic way to build profiles and manage AppArmor® profiles. It provides two interfaces: a graphical one and a text-based one. The text-based interface consumes less resources and bandwidth, making it a better choice for remote administration, or for times when a local graphical enviro…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.commandline"><span class="number">25 </span><span class="name">Building Profiles from the Command Line</span></a></span></dt><dd class="toc-abstract"><p>
  <span class="phrase">AppArmor®</span> provides the user the ability to use a command line interface
  rather than a graphical interface to manage and configure the system
  security. Track the status of <span class="phrase">AppArmor</span> and create, delete, or modify
  <span class="phrase">AppArmor</span> profiles using the <span class="phrase">AppArmor</span> command line tools.
 </p></dd><dt><span class="chapter"><a href="#cha.apparmor.hat"><span class="number">26 </span><span class="name">Profiling Your Web Applications Using ChangeHat</span></a></span></dt><dd class="toc-abstract"><p>An AppArmor® profile represents the security policy for an individual program instance or process. It applies to an executable program, but if a portion of the program needs different access permissions than other portions, the program can “change hats” to use a different security context, distincti…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.pam"><span class="number">27 </span><span class="name">Confining Users with <code class="systemitem">pam_apparmor</code></span></a></span></dt><dd class="toc-abstract"><p>An AppArmor profile applies to an executable program; if a portion of the program needs different access permissions than other portions need, the program can change hats via change_hat to a different role, also known as a subprofile. The pam_apparmor PAM module allows applications to confine authen…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.managing"><span class="number">28 </span><span class="name">Managing Profiled Applications</span></a></span></dt><dd class="toc-abstract"><p>After creating profiles and immunizing your applications, openSUSE® Leap becomes more efficient and better protected as long as you perform AppArmor® profile maintenance (which involves analyzing log files, refining your profiles, backing up your set of profiles and keeping it up-to-date). You can d…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.support"><span class="number">29 </span><span class="name">Support</span></a></span></dt><dd class="toc-abstract"><p>This chapter outlines maintenance-related tasks. Learn how to update AppArmor® and get a list of available man pages providing basic help for using the command line tools provided by AppArmor. Use the troubleshooting section to learn about some common problems encountered with AppArmor and their sol…</p></dd><dt><span class="chapter"><a href="#cha.apparmor.glossary"><span class="number">30 </span><span class="name"><span class="phrase">AppArmor</span> Glossary</span></a></span></dt></dl></div><div class="chapter " id="cha.apparmor.intro"><div class="titlepage"><div><div><h2 class="title"><span class="number">19 </span><span class="name">Introducing <span class="phrase">AppArmor</span></span> <a title="Permalink" class="permalink" href="#cha.apparmor.intro">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_intro.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.intro</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#idm140712067753712"><span class="number">19.1 </span><span class="name"><span class="phrase">AppArmor</span> Components</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.intro.background"><span class="number">19.2 </span><span class="name">Background Information on <span class="phrase">AppArmor</span> Profiling</span></a></span></dt></dl></div></div><p>
  Many security vulnerabilities result from bugs in
  <span class="emphasis"><em>trusted</em></span> programs. A trusted program runs with
  privileges that attackers want to possess. The program fails to keep that
  trust if there is a bug in the program that allows the attacker to acquire
  said privilege.
 </p><p>
  <span class="phrase">AppArmor®</span> is an application security solution designed specifically to
  apply privilege confinement to suspect programs. <span class="phrase">AppArmor</span> allows the
  administrator to specify the domain of activities the program can perform
  by developing a security <span class="emphasis"><em>profile</em></span>.  A security profile
  is a listing of files that the program may access and the operations the
  program may perform. <span class="phrase">AppArmor</span> secures applications by enforcing good
  application behavior without relying on attack signatures, so it can
  prevent attacks even if previously unknown vulnerabilities are being
  exploited.
 </p><div class="sect1 " id="idm140712067753712"><div class="titlepage"><div><div><h2 class="title" id="idm140712067753712"><span class="number">19.1 </span><span class="name"><span class="phrase">AppArmor</span> Components</span> <a title="Permalink" class="permalink" href="#idm140712067753712">#</a></h2></div></div></div><p>
  <span class="phrase">AppArmor</span> consists of:
 </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    A library of <span class="phrase">AppArmor</span> profiles for common Linux* applications, describing
    what files the program needs to access.
   </p></li><li class="listitem "><p>
    A library of <span class="phrase">AppArmor</span> profile foundation classes (profile building
    blocks) needed for common application activities, such as DNS lookup and
    user authentication.
   </p></li><li class="listitem "><p>
    A tool suite for developing and enhancing <span class="phrase">AppArmor</span> profiles, so that you
    can change the existing profiles to suit your needs and create new
    profiles for your own local and custom applications.
   </p></li><li class="listitem "><p>
    Several specially modified applications that are <span class="phrase">AppArmor</span> enabled to
    provide enhanced security in the form of unique subprocess confinement
    (including Apache).
   </p></li><li class="listitem "><p>
    The <span class="phrase">AppArmor</span>-related kernel code and associated control scripts to
    enforce <span class="phrase">AppArmor</span> policies on your <span class="productname"><span class="phrase">openSUSE® Leap</span></span> system.
   </p></li></ul></div></div><div class="sect1 " id="sec.apparmor.intro.background"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.intro.background"><span class="number">19.2 </span><span class="name">Background Information on <span class="phrase">AppArmor</span> Profiling</span> <a title="Permalink" class="permalink" href="#sec.apparmor.intro.background">#</a></h2></div></div></div><p>
   For more information about the science and security of <span class="phrase">AppArmor</span>, refer to
   the following papers:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067738944"><span class="term "><em class="citetitle ">SubDomain: Parsimonious Server Security</em> by
     Crispin Cowan, Steve Beattie, Greg Kroah-Hartman, Calton Pu, Perry Wagle,
     and Virgil Gligor</span></dt><dd><p>
      Describes the initial design and implementation of <span class="phrase">AppArmor</span>. Published
      in the proceedings of the USENIX LISA Conference, December 2000, New
      Orleans, LA. This paper is now out of date, describing syntax and
      features that are different from the current <span class="phrase">AppArmor</span> product. This
      paper should be used only for background, and not for technical
      documentation.
     </p></dd><dt id="idm140712067735520"><span class="term "><em class="citetitle ">Defcon Capture the Flag: Defending Vulnerable Code from Intense Attack</em>
     by Crispin Cowan, Seth Arnold, Steve Beattie, Chris Wright, and John Viega</span></dt><dd><p>
      A good guide to strategic and tactical use of <span class="phrase">AppArmor</span> to solve severe
      security problems in a very short period of time. Published in the
      Proceedings of the DARPA Information Survivability Conference and Expo
      (DISCEX III), April 2003, Washington, DC.
     </p></dd><dt id="idm140712067732640"><span class="term "><em class="citetitle ">AppArmor for Geeks</em> by Seth Arnold</span></dt><dd><p>
      This document tries to convey a better understanding of the technical
      details of <span class="phrase">AppArmor</span>. It is available at
      <a class="link" href="http://en.opensuse.org/SDB:AppArmor_geeks" target="_blank">http://en.opensuse.org/SDB:AppArmor_geeks</a>.
     </p></dd></dl></div></div></div><div class="chapter " id="cha.apparmor.start"><div class="titlepage"><div><div><h2 class="title"><span class="number">20 </span><span class="name">Getting Started</span> <a title="Permalink" class="permalink" href="#cha.apparmor.start">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_start.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.start</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.start.install"><span class="number">20.1 </span><span class="name">Installing <span class="phrase">AppArmor</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.enable"><span class="number">20.2 </span><span class="name">Enabling and Disabling <span class="phrase">AppArmor</span></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.choose"><span class="number">20.3 </span><span class="name">Choosing Applications to Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.build"><span class="number">20.4 </span><span class="name">Building and Modifying Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.start.update"><span class="number">20.5 </span><span class="name">Updating Your Profiles</span></a></span></dt></dl></div></div><p>
  Prepare a successful deployment of <span class="phrase">AppArmor</span> on your system by carefully
  considering the following items:
 </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
    Determine the applications to profile. Read more on this in
    <a class="xref" href="#sec.apparmor.start.choose" title="20.3. Choosing Applications to Profile">Section 20.3, “Choosing Applications to Profile”</a>.
   </p></li><li class="step "><p>
    Build the needed profiles as roughly outlined in
    <a class="xref" href="#sec.apparmor.start.build" title="20.4. Building and Modifying Profiles">Section 20.4, “Building and Modifying Profiles”</a>. Check the results and adjust
    the profiles when necessary.
   </p></li><li class="step "><p>
    Update your profiles whenever your environment changes or you need to
    react to security events logged by the reporting tool of <span class="phrase">AppArmor</span>. Refer
    to <a class="xref" href="#sec.apparmor.start.update" title="20.5. Updating Your Profiles">Section 20.5, “Updating Your Profiles”</a>.
   </p></li></ol></div></div><div class="sect1 " id="sec.apparmor.start.install"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.start.install"><span class="number">20.1 </span><span class="name">Installing <span class="phrase">AppArmor</span></span> <a title="Permalink" class="permalink" href="#sec.apparmor.start.install">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> is installed and running on any installation of
   <span class="productname"><span class="phrase">openSUSE® Leap</span></span> by default, regardless of what patterns are
   installed. The packages listed below are needed for a fully-functional
   instance of <span class="phrase">AppArmor</span>:
  </p><div class="itemizedlist "><ul class="itemizedlist compact"><li class="listitem "><p>
     <code class="systemitem">apparmor-docs</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor-parser</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor-profiles</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor-utils</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">audit</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">libapparmor1</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">perl-libapparmor</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">yast2-apparmor</code>
    </p></li></ul></div><div id="idm140712067700544" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
    If <span class="phrase">AppArmor</span> is not installed on your system, install the pattern
    <code class="systemitem">apparmor</code> for a complete
    <span class="phrase">AppArmor</span> installation. Either use the YaST Software Management
    module for installation, or use Zypper on the command line:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> zypper in -t pattern apparmor</pre></div></div></div><div class="sect1 " id="sec.apparmor.start.enable"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.start.enable"><span class="number">20.2 </span><span class="name">Enabling and Disabling <span class="phrase">AppArmor</span></span> <a title="Permalink" class="permalink" href="#sec.apparmor.start.enable">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> is configured to run by default on any fresh installation of

   <span class="productname"><span class="phrase">openSUSE Leap</span></span>. There are two ways of toggling the status of <span class="phrase">AppArmor</span>:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067692416"><span class="term ">Using YaST Services Manager</span></dt><dd><p>
      Disable or enable <span class="phrase">AppArmor</span> by removing or adding its boot script to the
      sequence of scripts executed on system boot. Status changes are
      applied on reboot.
     </p></dd><dt id="idm140712067690064"><span class="term ">Using <span class="phrase">AppArmor</span> Configuration Window</span></dt><dd><p>
      Toggle the status of <span class="phrase">AppArmor</span> in a running system by switching it off
      or on using the YaST <span class="phrase">AppArmor</span> Control Panel. Changes made here are
      applied instantaneously. The Control Panel triggers a stop or start
      event for <span class="phrase">AppArmor</span> and removes or adds its boot script in the system's
      boot sequence.
     </p></dd></dl></div><p>
   To disable <span class="phrase">AppArmor</span> permanently (by removing it from the sequence of
   scripts executed on system boot) proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start YaST.
    </p></li><li class="step "><p>
     Select <span class="guimenu">System</span> › <span class="guimenu">Services
     Manager</span>.
    </p></li><li class="step "><p>
     Mark <code class="literal">apparmor</code> by clicking its row in the list of
     services, then click <span class="guimenu">Enable/Disable</span> in the lower
     part of the window. Check that <span class="guimenu">Enabled</span> changed to
     <span class="guimenu">Disabled</span> in the <code class="literal">apparmor</code> row.
    </p></li><li class="step "><p>
     Confirm with <span class="guimenu">OK</span>.
    </p></li></ol></div></div><p>
   <span class="phrase">AppArmor</span> will not be initialized on reboot, and stays inactive until you
   re-enable it. Re-enabling a service using the YaST
   <span class="guimenu">Services Manager</span> tool is similar to disabling it.
  </p><p>
   Toggle the status of <span class="phrase">AppArmor</span> in a running system by using the <span class="phrase">AppArmor</span>
   Configuration window. These changes take effect when you apply them
   and survive a reboot of the system. To toggle the status of <span class="phrase">AppArmor</span>,
   proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
     click <span class="guimenu">Settings</span> in the main window.
    </p></li><li class="step "><p>
     Enable <span class="phrase">AppArmor</span> by checking <span class="guimenu">Enable <span class="phrase">AppArmor</span></span> or disable
     <span class="phrase">AppArmor</span> by deselecting it.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Done</span> in the <span class="guimenu"><span class="phrase">AppArmor</span>
     Configuration</span> window.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.apparmor.start.choose"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.start.choose"><span class="number">20.3 </span><span class="name">Choosing Applications to Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.start.choose">#</a></h2></div></div></div><p>
   You only need to protect the programs that are exposed to attacks in your
   particular setup, so only use profiles for those applications you
   actually run. Use the following list to determine the most likely
   candidates:
  </p><table border="0" summary="Simple list" class="simplelist "><tr><td>Network Agents</td></tr><tr><td>Web Applications</td></tr><tr><td>Cron Jobs</td></tr></table><p>
   To find out which processes are currently running with open network ports
   and might need a profile to confine them, run
   <code class="command">aa-unconfined</code> as <code class="systemitem">root</code>.
  </p><div class="example" id="ex.unconfined"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 20.1: </span><span class="name">Output of <code class="command">aa-unconfined</code> </span><a title="Permalink" class="permalink" href="#ex.unconfined">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">19848 /usr/sbin/cupsd not confined
19887 /usr/sbin/sshd not confined
19947 /usr/lib/postfix/master not confined
1328 /usr/sbin/smbd confined by '/usr/sbin/smbd (enforce)'</pre></div></div></div><p>
   Each of the processes in the above example labeled <code class="literal">not
   confined</code> might need a custom profile to confine it. Those
   labeled <code class="literal">confined by</code> are already protected by <span class="phrase">AppArmor</span>.
  </p><div id="idm140712067656656" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: For More Information</h6><p>
    For more information about choosing the right applications to profile,
    refer to <a class="xref" href="#sec.apparmor.concept.determine" title="21.2. Determining Programs to Immunize">Section 21.2, “Determining Programs to Immunize”</a>.
   </p></div></div><div class="sect1 " id="sec.apparmor.start.build"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.start.build"><span class="number">20.4 </span><span class="name">Building and Modifying Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.start.build">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> on <span class="productname"><span class="phrase">openSUSE Leap</span></span> ships with a preconfigured set of profiles
   for the most important applications. In addition, you can use <span class="phrase">AppArmor</span> to
   create your own profiles for any application you want.
  </p><p>
   There are two ways of managing profiles. One is to use the graphical
   front-end provided by the YaST <span class="phrase">AppArmor</span> modules and the other is to
   use the command line tools provided by the <span class="phrase">AppArmor</span> suite itself. The main
   difference is that YaST supports only basic functionality for
   <span class="phrase">AppArmor</span> profiles, while the command line tools let you update/tune the
   profiles in a more fine-grained way.
  </p><p>
   For each application, perform the following steps to create a profile:
  </p><div class="procedure " id="proc.genprof"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step " id="st.genprof1"><p>
     As <code class="systemitem">root</code>, let <span class="phrase">AppArmor</span> create a rough outline of the
     application's profile by running <code class="command">aa-genprof</code>
     <em class="replaceable ">PROGRAM_NAME</em>.
    </p><p>
     <span class="emphasis"><em>or</em></span>
    </p><p>

     Outline the basic profile by running <span class="guimenu">YaST</span> › <span class="guimenu">Security and Users</span> › <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span> › <span class="guimenu">Manually Add
     Profile</span> and specifying the complete path to the
     application you want to profile.
    </p><p>
     A new basic profile is outlined and put into learning mode, which means
     that it logs any activity of the program you are executing, but does
     not yet restrict it.
    </p></li><li class="step " id="st.genprof2"><p>
     Run the full range of the application's actions to let <span class="phrase">AppArmor</span> get a
     very specific picture of its activities.
    </p></li><li class="step " id="st.genprof3"><p>
     Let <span class="phrase">AppArmor</span> analyze the log files generated in
     <a class="xref" href="#st.genprof2" title="Step 2">Step 2</a> by typing <span class="keycap">S</span> in
     aa-genprof.
    </p><p>
     <span class="phrase">AppArmor</span> scans the logs it recorded during the application's run and
     asks you to set the access rights for each event that was logged.
     Either set them for each file or use globbing.
    </p></li><li class="step "><p>
     Depending on the complexity of your application, it might be necessary
     to repeat <a class="xref" href="#st.genprof2" title="Step 2">Step 2</a> and
     <a class="xref" href="#st.genprof3" title="Step 3">Step 3</a>. Confine the application, exercise it
     under the confined conditions, and process any new log events. To
     properly confine the full range of an application's capabilities, you
     might be required to repeat this procedure often.
    </p></li><li class="step " id="st.genprof4"><p>
     When you finish <code class="command">aa-genprof</code>, your profile is set to
     enforce mode. The profile is applied and <span class="phrase">AppArmor</span> restricts the
     application according to it.
    </p><p>
     If you started <code class="command">aa-genprof</code> on an application that had
     an existing profile that was in complain mode, this profile remains in
     learning mode upon exit of this learning cycle. For more information
     about changing the mode of a profile, refer to
     <a class="xref" href="#sec.apparmor.commandline.profiling.summary.complain" title="25.7.3.2. aa-complain—Entering Complain or Learning Mode">Section 25.7.3.2, “aa-complain—Entering Complain or Learning Mode”</a>
     and
     <a class="xref" href="#sec.apparmor.commandline.profiling.summary.enforce" title="25.7.3.6. aa-enforce—Entering Enforce Mode">Section 25.7.3.6, “aa-enforce—Entering Enforce Mode”</a>.
    </p></li></ol></div></div><p>
   Test your profile settings by performing every task you need with the
   application you confined. Normally, the confined program runs smoothly
   and you do not notice <span class="phrase">AppArmor</span> activities. However, if you notice
   certain misbehavior with your application, check the system logs and see
   if <span class="phrase">AppArmor</span> is too tightly confining your application. Depending on the
   log mechanism used on your system, there are several places to look for
   <span class="phrase">AppArmor</span> log entries:
  </p><table border="0" summary="Simple list" class="simplelist "><tr><td><code class="filename">/var/log/audit/audit.log</code>
   </td></tr><tr><td>The command <code class="command">journalctl | grep -i apparmor</code>
   </td></tr><tr><td>The command <code class="command">dmesg -T</code>
   </td></tr></table><p>
   To adjust the profile, analyze the log messages relating to this
   application again as described in
   <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>.
   Determine the access rights or restrictions when prompted.
  </p><div id="idm140712067620240" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: For More Information</h6><p>
    For more information about profile building and modification, refer to
    <a class="xref" href="#cha.apparmor.profiles" title="Chapter 22. Profile Components and Syntax">Chapter 22, <em>Profile Components and Syntax</em></a>,
    <a class="xref" href="#cha.apparmor.yast" title="Chapter 24. Building and Managing Profiles with YaST">Chapter 24, <em>Building and Managing Profiles with YaST</em></a>, and
    <a class="xref" href="#cha.apparmor.commandline" title="Chapter 25. Building Profiles from the Command Line">Chapter 25, <em>Building Profiles from the Command Line</em></a>.
   </p></div></div><div class="sect1 " id="sec.apparmor.start.update"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.start.update"><span class="number">20.5 </span><span class="name">Updating Your Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.start.update">#</a></h2></div></div></div><p>
   Software and system configurations change over time. As a result, your
   profile setup for <span class="phrase">AppArmor</span> might need some fine-tuning from time to time.
   <span class="phrase">AppArmor</span> checks your system log for policy violations or other <span class="phrase">AppArmor</span>
   events and lets you adjust your profile set accordingly. Any application
   behavior that is outside of any profile definition can be addressed by
   <code class="command">aa-logprof</code>. For more information, see
   <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>.
  </p></div></div><div class="chapter " id="cha.apparmor.concept"><div class="titlepage"><div><div><h2 class="title"><span class="number">21 </span><span class="name">Immunizing Programs</span> <a title="Permalink" class="permalink" href="#cha.apparmor.concept">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_whatimmunize.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.concept</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.concept.tools"><span class="number">21.1 </span><span class="name">Introducing the <span class="phrase">AppArmor</span> Framework</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.determine"><span class="number">21.2 </span><span class="name">Determining Programs to Immunize</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.cron"><span class="number">21.3 </span><span class="name">Immunizing <code class="systemitem">cron</code> Jobs</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.concept.network"><span class="number">21.4 </span><span class="name">Immunizing Network Applications</span></a></span></dt></dl></div></div><p>
  Effective hardening of a computer system requires minimizing the number of
  programs that mediate privilege, then securing the programs as much as
  possible. With <span class="phrase">AppArmor</span>, you only need to profile the programs that are
  exposed to attack in your environment, which drastically reduces the
  amount of work required to harden your computer. <span class="phrase">AppArmor</span> profiles enforce
  policies to make sure that programs do what they are supposed to do, but
  nothing else.
 </p><p>
  <span class="phrase">AppArmor</span> provides immunization technologies that protect applications from
  the inherent vulnerabilities they possess. After installing <span class="phrase">AppArmor</span>,
  setting up <span class="phrase">AppArmor</span> profiles, and rebooting the computer, your system
  becomes immunized because it begins to enforce the <span class="phrase">AppArmor</span> security
  policies. Protecting programs with <span class="phrase">AppArmor</span> is called
  <span class="emphasis"><em>immunizing</em></span>.
 </p><p>
  Administrators need only concern themselves with the applications that are
  vulnerable to attacks, and generate profiles for these. Hardening a system
  thus comes down to building and maintaining the <span class="phrase">AppArmor</span> profile set and
  monitoring any policy violations or exceptions logged by <span class="phrase">AppArmor</span>'s
  reporting facility.
 </p><p>
  Users should not notice <span class="phrase">AppArmor</span>. It runs <span class="quote">“<span class="quote">behind the
  scenes</span>”</span> and does not require any user interaction. Performance is
  not noticeably affected by <span class="phrase">AppArmor</span>. If some activity of the application is
  not covered by an <span class="phrase">AppArmor</span> profile or if some activity of the application
  is prevented by <span class="phrase">AppArmor</span>, the administrator needs to adjust the profile of
  this application.
 </p><p>
  <span class="phrase">AppArmor</span> sets up a collection of default application profiles to protect
  standard Linux services. To protect other applications, use the <span class="phrase">AppArmor</span>
  tools to create profiles for the applications that you want protected.
  This chapter introduces the philosophy of immunizing programs. Proceed to
  <a class="xref" href="#cha.apparmor.profiles" title="Chapter 22. Profile Components and Syntax">Chapter 22, <em>Profile Components and Syntax</em></a>,
  <a class="xref" href="#cha.apparmor.yast" title="Chapter 24. Building and Managing Profiles with YaST">Chapter 24, <em>Building and Managing Profiles with YaST</em></a>, or
  <a class="xref" href="#cha.apparmor.commandline" title="Chapter 25. Building Profiles from the Command Line">Chapter 25, <em>Building Profiles from the Command Line</em></a> if you are ready to build and
  manage <span class="phrase">AppArmor</span> profiles.
 </p><p>
  <span class="phrase">AppArmor</span> provides streamlined access control for network services by
  specifying which files each program is allowed to read, write, and
  execute, and which type of network it is allowed to access. This ensures
  that each program does what it is supposed to do, and nothing else.
  <span class="phrase">AppArmor</span> quarantines programs to protect the rest of the system from being
  damaged by a compromised process.
 </p><p>
  <span class="phrase">AppArmor</span> is a host intrusion prevention or mandatory access control scheme.
  Previously, access control schemes were centered around users because they
  were built for large timeshare systems. Alternatively, modern network
  servers largely do not permit users to log in, but instead provide a
  variety of network services for users (such as Web, mail, file, and print
  servers). <span class="phrase">AppArmor</span> controls the access given to network services and other
  programs to prevent weaknesses from being exploited.
 </p><div id="idm140712067591536" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Background Information for <span class="phrase">AppArmor</span></h6><p>
   To get a more in-depth overview of <span class="phrase">AppArmor</span> and the overall concept behind
   it, refer to <a class="xref" href="#sec.apparmor.intro.background" title="19.2. Background Information on AppArmor Profiling">Section 19.2, “Background Information on <span class="phrase">AppArmor</span> Profiling”</a>.
  </p></div><div class="sect1 " id="sec.apparmor.concept.tools"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.concept.tools"><span class="number">21.1 </span><span class="name">Introducing the <span class="phrase">AppArmor</span> Framework</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.tools">#</a></h2></div></div></div><p>
   This section provides a very basic understanding of what is happening
   <span class="quote">“<span class="quote">behind the scenes</span>”</span> (and under the hood of the YaST
   interface) when you run <span class="phrase">AppArmor</span>.
  </p><p>
   An <span class="phrase">AppArmor</span> profile is a plain text file containing path entries and
   access permissions. See <a class="xref" href="#sec.apparmor.profiles.parts" title="22.1. Breaking an AppArmor Profile into Its Parts">Section 22.1, “Breaking an <span class="phrase">AppArmor</span> Profile into Its Parts”</a> for
   a detailed reference profile. The directives contained in this text file
   are then enforced by the <span class="phrase">AppArmor</span> routines to quarantine the process or
   program.
  </p><p>
   The following tools interact in the building and enforcement of <span class="phrase">AppArmor</span>
   profiles and policies:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067582352"><span class="term "><code class="command">aa-status</code>
    </span></dt><dd><p>
      <code class="command">aa-status</code> reports various aspects of the current
      state of the running <span class="phrase">AppArmor</span> confinement.
     </p></dd><dt id="idm140712067579328"><span class="term "><code class="command">aa-unconfined</code>
    </span></dt><dd><p>
      <code class="command">aa-unconfined</code> detects any application running on
      your system that listens for network connections and is not protected
      by an <span class="phrase">AppArmor</span> profile. Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.unconfined" title="25.7.3.12. aa-unconfined—Identifying Unprotected Processes">Section 25.7.3.12, “aa-unconfined—Identifying Unprotected Processes”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067575600"><span class="term "><code class="command">aa-autodep</code>
    </span></dt><dd><p>
      <code class="command">aa-autodep</code> creates a basic framework of a profile
      that needs to be fleshed out before it is put to use in production.
      The resulting profile is loaded and put into complain mode, reporting
      any behavior of the application that is not (yet) covered by <span class="phrase">AppArmor</span>
      rules. Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.autodep" title="25.7.3.1. aa-autodep—Creating Approximate Profiles">Section 25.7.3.1, “aa-autodep—Creating Approximate Profiles”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067571744"><span class="term "><code class="command">aa-genprof</code>
    </span></dt><dd><p>
      <code class="command">aa-genprof</code> generates a basic profile and asks you
      to refine this profile by executing the application and generating log
      events that need to be taken care of by <span class="phrase">AppArmor</span> policies. You are
      guided through a series of questions to deal with the log events that
      have been triggered during the application's execution. After the
      profile has been generated, it is loaded and put into enforce mode.
      Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.genprof" title="25.7.3.8. aa-genprof—Generating Profiles">Section 25.7.3.8, “aa-genprof—Generating Profiles”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067567760"><span class="term "><code class="command">aa-logprof</code>
    </span></dt><dd><p>
      <code class="command">aa-logprof</code> interactively scans and reviews the log
      entries generated by an application that is confined by an <span class="phrase">AppArmor</span>
      profile in both complain and enforced modes. It assists you in
      generating new entries in the profile concerned. Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067563936"><span class="term "><code class="command">aa-easyprof</code>
    </span></dt><dd><p>
      <code class="command">aa-easyprof</code> provides an easy-to-use interface for
      <span class="phrase">AppArmor</span> profile generation. <code class="command">aa-easyprof</code> supports
      the use of templates and policy groups to quickly profile an
      application. Note that while this tool can help with policy
      generation, its utility is dependent on the quality of the templates,
      policy groups and abstractions used. <code class="command">aa-easyprof</code>
      may create a profile that is less restricted than creating the profile
      with <code class="command">aa-genprof</code> and <code class="command">aa-logprof</code>.
     </p></dd><dt id="idm140712067558816"><span class="term "><code class="command">aa-complain</code>
    </span></dt><dd><p>
      <code class="command">aa-complain</code> toggles the mode of an <span class="phrase">AppArmor</span> profile
      from enforce to complain. Violations to rules set in a profile are
      logged, but the profile is not enforced. Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.complain" title="25.7.3.2. aa-complain—Entering Complain or Learning Mode">Section 25.7.3.2, “aa-complain—Entering Complain or Learning Mode”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067555072"><span class="term "><code class="command">aa-enforce</code>
    </span></dt><dd><p>
      <code class="command">aa-enforce</code> toggles the mode of an <span class="phrase">AppArmor</span> profile
      from complain to enforce. Violations to rules set in a profile are
      logged and not permitted—the profile is enforced. Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.enforce" title="25.7.3.6. aa-enforce—Entering Enforce Mode">Section 25.7.3.6, “aa-enforce—Entering Enforce Mode”</a>
      for detailed information about this tool.
     </p></dd><dt id="idm140712067551312"><span class="term "><code class="command">aa-disable</code>
    </span></dt><dd><p>
      <code class="command">aa-disable</code> disables the enforcement mode for one or
      more <span class="phrase">AppArmor</span> profiles. This command will unload the profile from the
      kernel and prevent it from being loaded on <span class="phrase">AppArmor</span> start-up. The
      <code class="command">aa-enforce</code> and <code class="command">aa-complain</code>
      utilities may be used to change this behavior.
     </p></dd><dt id="idm140712067546816"><span class="term "><code class="command">aa-exec</code>
    </span></dt><dd><p>
      <code class="command">aa-exec</code> launches a program confined by the
      specified <span class="phrase">AppArmor</span> profile and/or namespace. If both a profile and
      namespace are specified, the command will be confined by the profile
      in the new policy namespace. If only a namespace is specified, the
      profile name of the current confinement will be used. If neither a
      profile or namespace is specified, the command will be run using
      standard profile attachment—as if run without
      <code class="command">aa-exec</code>.
     </p></dd><dt id="idm140712067542976"><span class="term "><code class="command">aa-notify</code>
    </span></dt><dd><p>
      <code class="command">aa-notify</code> is a handy utility that displays <span class="phrase">AppArmor</span>
      notifications in your desktop environment. You can also configure it
      to display a summary of notifications for the specified number of
      recent days. For more information, see
      <a class="xref" href="#commandline.profiling.summary.aa-notify" title="25.7.3.13. aa-notify">Section 25.7.3.13, “aa-notify”</a>.
     </p></dd></dl></div></div><div class="sect1 " id="sec.apparmor.concept.determine"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.concept.determine"><span class="number">21.2 </span><span class="name">Determining Programs to Immunize</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.determine">#</a></h2></div></div></div><p>
   Now that you have familiarized yourself with <span class="phrase">AppArmor</span>, start selecting the
   applications for which to build profiles. Programs that need profiling
   are those that mediate privilege. The following programs have access to
   resources that the person using the program does not have, so they grant
   the privilege to the user when used:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067536208"><span class="term "><code class="systemitem">cron</code> Jobs</span></dt><dd><p>
      Programs that are run periodically by
      <code class="systemitem">cron</code>. Such programs read input
      from a variety of sources and can run with special privileges,
      sometimes with as much as <code class="systemitem">root</code> privilege. For example,
      <code class="systemitem">cron</code> can run
      <code class="command">/usr/sbin/logrotate</code> daily to rotate, compress, or
      even mail system logs. For instructions for finding these types of
      programs, refer to
      <a class="xref" href="#sec.apparmor.concept.cron" title="21.3. Immunizing cron Jobs">Section 21.3, “Immunizing <code class="systemitem">cron</code> Jobs”</a>.
     </p></dd><dt id="idm140712067530128"><span class="term ">Web Applications</span></dt><dd><p>
      Programs that can be invoked through a Web browser, including CGI Perl
      scripts, PHP pages, and more complex Web applications. For
      instructions for finding these types of programs, refer to
      <a class="xref" href="#sec.apparmor.concept.network.web" title="21.4.1. Immunizing Web Applications">Section 21.4.1, “Immunizing Web Applications”</a>.
     </p></dd><dt id="idm140712067527296"><span class="term ">Network Agents</span></dt><dd><p>
      Programs (servers and clients) that have open network ports. User
      clients, such as mail clients and Web browsers mediate privilege.
      These programs run with the privilege to write to the user's home
      directory and they process input from potentially hostile remote
      sources, such as hostile Web sites and e-mailed malicious code. For
      instructions for finding these types of programs, refer to
      <a class="xref" href="#sec.apparmor.concept.network.agents" title="21.4.2. Immunizing Network Agents">Section 21.4.2, “Immunizing Network Agents”</a>.
     </p></dd></dl></div><p>
   Conversely, unprivileged programs do not need to be profiled. For
   example, a shell script might invoke the <code class="command">cp</code>
   program to copy a file. Because <code class="command">cp</code> does not by
   default have its own profile or subprofile, it inherits the profile
   of the parent shell script.  Thus <code class="command">cp</code> can copy any
   files that the parent shell script's profile can read and write.
  </p></div><div class="sect1 " id="sec.apparmor.concept.cron"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.concept.cron"><span class="number">21.3 </span><span class="name">Immunizing <code class="systemitem">cron</code> Jobs</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.cron">#</a></h2></div></div></div><p>
   To find programs that are run by
   <code class="systemitem">cron</code>, inspect your local
   <code class="systemitem">cron</code> configuration.
   Unfortunately, <code class="systemitem">cron</code> configuration
   is rather complex, so there are numerous files to inspect. Periodic
   <code class="systemitem">cron</code> jobs are run from these
   files:
  </p><div class="verbatim-wrap"><pre class="screen">/etc/crontab
/etc/cron.d/*
/etc/cron.daily/*
/etc/cron.hourly/*
/etc/cron.monthly/*
/etc/cron.weekly/*</pre></div><p>
   
   The <code class="command">crontab</code> command lists/edits the current user's
   crontab. To manipulate <code class="systemitem">root</code>'s
   <code class="systemitem">cron</code> jobs, first become
   <code class="systemitem">root</code>, and then edit the tasks with <code class="command">crontab -e</code>
   or list them with <code class="command">crontab -l</code>.
  </p></div><div class="sect1 " id="sec.apparmor.concept.network"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.concept.network"><span class="number">21.4 </span><span class="name">Immunizing Network Applications</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.network">#</a></h2></div></div></div><p>
   An automated method for finding network server daemons that should be
   profiled is to use the <code class="command">aa-unconfined</code> tool.

  </p><p>
   The <code class="command">aa-unconfined</code> tool uses the command
   <code class="command">netstat -nlp</code> to inspect open ports from inside your
   computer, detect the programs associated with those ports, and inspect
   the set of <span class="phrase">AppArmor</span> profiles that you have loaded.
   <code class="command">aa-unconfined</code> then reports these programs along with
   the <span class="phrase">AppArmor</span> profile associated with each program, or reports
   <span class="quote">“<span class="quote">none</span>”</span> (if the program is not confined).
  </p><div id="idm140712067505680" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
    If you create a new profile, you must restart the program that has been
    profiled to have it be effectively confined by <span class="phrase">AppArmor</span>.
   </p></div><p>
   Below is a sample <code class="command">aa-unconfined</code> output:
  </p><div class="verbatim-wrap"><pre class="screen">3702<span id="co.apparmor.concept.network.id"></span><span class="callout">1</span> /usr/sbin/sshd<span id="co.apparmor.concept.network.string"></span><span class="callout">2</span> confined
   by '/usr/sbin/sshd<span id="co.apparmor.concept.network.confine"></span><span class="callout">3</span> (enforce)'
4040 /usr/sbin/smbd confined by '/usr/sbin/smbd (enforce)'
4373 /usr/lib/postfix/master confined by '/usr/lib/postfix/master (enforce)'
4505 /usr/sbin/httpd2-prefork confined by '/usr/sbin/httpd2-prefork (enforce)'
646 /usr/lib/wicked/bin/wickedd-dhcp4 not confined
647 /usr/lib/wicked/bin/wickedd-dhcp6 not confined
5592 /usr/bin/ssh not confined
7146 /usr/sbin/cupsd confined by '/usr/sbin/cupsd (complain)'</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.concept.network.id"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     The first portion is a number. This number is the process ID number
     (PID) of the listening program.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.concept.network.string"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     The second portion is a string that represents the absolute path of the
     listening program
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.concept.network.confine"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     The final portion indicates the profile confining the program, if any.
    </p></td></tr></table></div><div id="idm140712067495952" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
    <code class="command">aa-unconfined</code> requires <code class="systemitem">root</code> privileges and
    should not be run from a shell that is confined by an <span class="phrase">AppArmor</span> profile.
   </p></div><p>
   <code class="command">aa-unconfined</code> does not distinguish between one network
   interface and another, so it reports all unconfined processes, even those
   that might be listening to an internal LAN interface.
  </p><p>
   Finding user network client applications is dependent on your user
   preferences. The <code class="command">aa-unconfined</code> tool detects and
   reports network ports opened by client applications, but only those
   client applications that are running at the time the
   <code class="command">aa-unconfined</code> analysis is performed. This is a problem
   because network services tend to be running all the time, while network
   client applications tend only to be running when the user is interested
   in them.
  </p><p>
   Applying <span class="phrase">AppArmor</span> profiles to user network client applications is also
   dependent on user preferences. Therefore, we leave the profiling of user
   network client applications as an exercise for the user.
  </p><p>
   To aggressively confine desktop applications, the
   <code class="command">aa-unconfined</code> command supports a
   <code class="option">--paranoid</code> option, which reports all processes running
   and the corresponding <span class="phrase">AppArmor</span> profiles that might or might not be
   associated with each process. The user can then decide whether each of
   these programs needs an <span class="phrase">AppArmor</span> profile.
  </p><p>
   If you have new or modified profiles, you can submit them to the
   &lt;<a class="email" href="mailto:apparmor@lists.ubuntu.com">apparmor@lists.ubuntu.com</a>&gt; mailing list along with a use
   case for the application behavior that you exercised. The <span class="phrase">AppArmor</span> team
   reviews and may submit the work into <span class="productname"><span class="phrase">openSUSE Leap</span></span>. We cannot
   guarantee that every profile will be included, but we make a sincere
   effort to include as much as possible.
  </p><div class="sect2 " id="sec.apparmor.concept.network.web"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.concept.network.web"><span class="number">21.4.1 </span><span class="name">Immunizing Web Applications</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.network.web">#</a></h3></div></div></div><p>
    To find Web applications, investigate your Web server configuration. The
    Apache Web server is highly configurable and Web applications can be
    stored in many directories, depending on your local configuration.
    <span class="productname"><span class="phrase">openSUSE Leap</span></span>, by default, stores Web applications in
    <code class="filename">/srv/www/cgi-bin/</code>. To the maximum extent possible,
    each Web application should have an <span class="phrase">AppArmor</span> profile.
   </p><p>
    Once you find these programs, you can use the
    <code class="command">aa-genprof</code> and <code class="command">aa-logprof</code> tools to
    create or update their <span class="phrase">AppArmor</span> profiles.
   </p><p>
    Because CGI programs are executed by the Apache Web server, the profile
    for Apache itself, <code class="filename">usr.sbin.httpd2-prefork</code> for
    Apache2 on <span class="productname"><span class="phrase">openSUSE Leap</span></span>, must be modified to add execute permissions
    to each of these programs. For example, adding the line
    <code class="literal">/srv/www/cgi-bin/my_hit_counter.pl rPx</code> grants Apache
    permission to execute the Perl script
    <code class="filename">my_hit_counter.pl</code> and requires that there be a
    dedicated profile for <code class="filename">my_hit_counter.pl</code>. If
    <code class="filename">my_hit_counter.pl</code> does not have a dedicated profile
    associated with it, the rule should say
    <code class="literal">/srv/www/cgi-bin/my_hit_counter.pl rix</code> to cause
    <code class="filename">my_hit_counter.pl</code> to inherit the
    <code class="filename">usr.sbin.httpd2-prefork</code> profile.
   </p><p>
    Some users might find it inconvenient to specify execute permission for
    every CGI script that Apache might invoke. Instead, the administrator
    can grant controlled access to collections of CGI scripts. For example,
    adding the line <code class="literal">/srv/www/cgi-bin/*.{pl,py,pyc} rix</code>
    allows Apache to execute all files in
    <code class="literal">/srv/www/cgi-bin/</code> ending in <code class="filename">.pl</code>
    (Perl scripts) and <code class="filename">.py</code> or <code class="filename">.pyc</code>
    (Python scripts). As above, the <code class="literal">ix</code> part of the rule
    causes Python scripts to inherit the Apache profile, which is
    appropriate if you do not want to write individual profiles for each CGI
    script.
   </p><div id="idm140712067469392" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     If you want the subprocess confinement module
     (<code class="filename">apache2-mod-apparmor</code>) functionality when Web
     applications handle Apache modules (<code class="filename">mod_perl</code> and
     <code class="filename">mod_php</code>), use the ChangeHat features when you add
     a profile in YaST or at the command line. To take advantage of the
     subprocess confinement, refer to
     <a class="xref" href="#sec.apparmor.hat.apache.managing" title="26.2. Managing ChangeHat-Aware Applications">Section 26.2, “Managing ChangeHat-Aware Applications”</a>.
    </p></div><p>
    Profiling Web applications that use <code class="filename">mod_perl</code> and
    <code class="filename">mod_php</code> requires slightly different handling. In
    this case, the <span class="quote">“<span class="quote">program</span>”</span> is a script interpreted directly
    by the module within the Apache process, so no exec happens. Instead,
    the <span class="phrase">AppArmor</span> version of Apache calls <code class="command">change_hat()</code>
    using a subprofile (a <span class="quote">“<span class="quote">hat</span>”</span>) corresponding to the name of
    the URI requested.
   </p><div id="idm140712067462672" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     The name presented for the script to execute might not be the URI,
     depending on how Apache has been configured for where to look for
     module scripts. If you have configured your Apache to place scripts in
     a different place, the different names appear in the log file when
     <span class="phrase">AppArmor</span> complains about access violations. See
     <a class="xref" href="#cha.apparmor.managing" title="Chapter 28. Managing Profiled Applications">Chapter 28, <em>Managing Profiled Applications</em></a>.
    </p></div><p>
    For <code class="filename">mod_perl</code> and <code class="filename">mod_php</code>
    scripts, this is the name of the Perl script or the PHP page requested.
    For example, adding this subprofile allows the
    <code class="filename">localtime.php</code> page to execute and access to the
    local system time and locale files:
   </p><div class="verbatim-wrap"><pre class="screen">/usr/bin/httpd2-prefork {
  # ...
  ^/cgi-bin/localtime.php {
    /etc/localtime                  r,
    /srv/www/cgi-bin/localtime.php  r,
    /usr/lib/locale/**              r,
  }
}</pre></div><p>
    If no subprofile has been defined, the <span class="phrase">AppArmor</span> version of Apache applies
    the <code class="systemitem">DEFAULT_URI</code> hat. This subprofile is
    sufficient to display a Web page. The
    <code class="systemitem">DEFAULT_URI</code> hat that <span class="phrase">AppArmor</span> provides by
    default is the following:
   </p><div class="verbatim-wrap"><pre class="screen">^DEFAULT_URI {
    /usr/sbin/suexec2                  mixr,
    /var/log/apache2/**                rwl,
    @{HOME}/public_html                r,
    @{HOME}/public_html/**             r,
    /srv/www/htdocs                    r,
    /srv/www/htdocs/**                 r,
    /srv/www/icons/*.{gif,jpg,png}     r,
    /srv/www/vhosts                    r,
    /srv/www/vhosts/**                 r,
    /usr/share/apache2/**              r,
    /var/lib/php/sess_*                rwl
}</pre></div><p>
    To use a single <span class="phrase">AppArmor</span> profile for all Web pages and CGI scripts served
    by Apache, a good approach is to edit the
    <code class="systemitem">DEFAULT_URI</code> subprofile. For more information on
    confining Web applications with Apache, see
    <a class="xref" href="#cha.apparmor.hat" title="Chapter 26. Profiling Your Web Applications Using ChangeHat">Chapter 26, <em>Profiling Your Web Applications Using ChangeHat</em></a>.
   </p></div><div class="sect2 " id="sec.apparmor.concept.network.agents"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.concept.network.agents"><span class="number">21.4.2 </span><span class="name">Immunizing Network Agents</span> <a title="Permalink" class="permalink" href="#sec.apparmor.concept.network.agents">#</a></h3></div></div></div><p>
    To find network server daemons and network clients (such as
    <code class="command">fetchmail</code> or Firefox) that need to be profiled,
    you should inspect the open ports on your machine.  Also consider
    the programs that are answering on those ports, and provide profiles
    for as many of those programs as possible. If you provide profiles
    for all programs with open network ports, an attacker cannot get to
    the file system on your machine without passing through an <span class="phrase">AppArmor</span>
    profile policy.
   </p><p>
    Scan your server for open network ports manually from outside the
    machine using a scanner (such as nmap), or from inside the machine using
    the <code class="command">netstat --inet -n -p</code> command as <code class="systemitem">root</code>.
    Then, inspect the machine to determine which programs are answering on
    the discovered open ports.
   </p><div id="idm140712067447552" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     Refer to the man page of the <code class="command">netstat</code> command for a
     detailed reference of all possible options.
    </p></div></div></div></div><div class="chapter " id="cha.apparmor.profiles"><div class="titlepage"><div><div><h2 class="title"><span class="number">22 </span><span class="name">Profile Components and Syntax</span> <a title="Permalink" class="permalink" href="#cha.apparmor.profiles">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_profiles.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.profiles</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.profiles.parts"><span class="number">22.1 </span><span class="name">Breaking an <span class="phrase">AppArmor</span> Profile into Its Parts</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.types"><span class="number">22.2 </span><span class="name">Profile Types</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.includes"><span class="number">22.3 </span><span class="name">Include Statements</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.capabilities"><span class="number">22.4 </span><span class="name">Capability Entries (POSIX.1e)</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.nac"><span class="number">22.5 </span><span class="name">Network Access Control</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.glob"><span class="number">22.6 </span><span class="name">Profile Names, Flags, Paths, and Globbing</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.perm"><span class="number">22.7 </span><span class="name">File Permission Access Modes</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.exec"><span class="number">22.8 </span><span class="name">Execute Modes</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.rlimit"><span class="number">22.9 </span><span class="name">Resource Limit Control</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.profiles.audit"><span class="number">22.10 </span><span class="name">Auditing Rules</span></a></span></dt></dl></div></div><p>
  Building <span class="phrase">AppArmor</span> profiles to confine an application is very
  straightforward and intuitive. <span class="phrase">AppArmor</span> ships with several tools that
  assist in profile creation. It does not require you to do any programming
  or script handling. The only task that is required of the administrator is
  to determine a policy of strictest access and execute permissions for each
  application that needs to be hardened.
 </p><p>
  Updates or modifications to the application profiles are only required if
  the software configuration or the desired range of activities changes.
  <span class="phrase">AppArmor</span> offers intuitive tools to handle profile updates and
  modifications.
 </p><p>
  You are ready to build <span class="phrase">AppArmor</span> profiles after you select the programs to
  profile. To do so, it is important to understand the components and syntax
  of profiles. <span class="phrase">AppArmor</span> profiles contain several building blocks that help
  build simple and reusable profile code:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067437152"><span class="term ">Include Files</span></dt><dd><p>
     Include statements are used to pull in parts of other <span class="phrase">AppArmor</span> profiles
     to simplify the structure of new profiles.
    </p></dd><dt id="idm140712067434816"><span class="term ">Abstractions</span></dt><dd><p>
     Abstractions are include statements grouped by common application
     tasks.
    </p></dd><dt id="idm140712067432944"><span class="term ">Program Chunks</span></dt><dd><p>
     Program chunks are include statements that contain chunks of profiles
     that are specific to program suites.
    </p></dd><dt id="idm140712067431040"><span class="term ">Capability Entries</span></dt><dd><p>
     Capability entries are profile entries for any of the POSIX.1e
     <a class="link" href="http://en.wikipedia.org/wiki/POSIX#POSIX.1" target="_blank">http://en.wikipedia.org/wiki/POSIX#POSIX.1</a> Linux
     capabilities allowing a fine-grained control over what a confined
     process is allowed to do through system calls that require privileges.
    </p></dd><dt id="idm140712067428448"><span class="term ">Network Access Control Entries</span></dt><dd><p>
     Network Access Control Entries mediate network access based on the
     address type and family.
    </p></dd><dt id="idm140712067426544"><span class="term ">Local Variable Definitions</span></dt><dd><p>
     Local variables define shortcuts for paths.
    </p></dd><dt id="idm140712067424704"><span class="term ">File Access Control Entries</span></dt><dd><p>
     File Access Control Entries specify the set of files an application can
     access.
    </p></dd><dt id="idm140712067422816"><span class="term ">rlimit Entries</span></dt><dd><p>
     rlimit entries set and control an application's resource limits.
    </p></dd></dl></div><p>
  For help determining the programs to profile, refer to
  <a class="xref" href="#sec.apparmor.concept.determine" title="21.2. Determining Programs to Immunize">Section 21.2, “Determining Programs to Immunize”</a>.
  To start building <span class="phrase">AppArmor</span> profiles with YaST, proceed to
  <a class="xref" href="#cha.apparmor.yast" title="Chapter 24. Building and Managing Profiles with YaST">Chapter 24, <em>Building and Managing Profiles with YaST</em></a>. To build profiles using the <span class="phrase">AppArmor</span>
  command line interface, proceed to
  <a class="xref" href="#cha.apparmor.commandline" title="Chapter 25. Building Profiles from the Command Line">Chapter 25, <em>Building Profiles from the Command Line</em></a>.
 </p><div class="sect1 " id="sec.apparmor.profiles.parts"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.parts"><span class="number">22.1 </span><span class="name">Breaking an <span class="phrase">AppArmor</span> Profile into Its Parts</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.parts">#</a></h2></div></div></div><p>
   The easiest way of explaining what a profile consists of and how to
   create one is to show the details of a sample profile, in this case for a
   hypothetical application called <code class="command">/usr/bin/foo</code>:
  </p><div class="verbatim-wrap"><pre class="screen">#include &lt;tunables/global&gt;<span id="co.apparmor.profiles.vardef"></span><span class="callout">1</span>

# a comment naming the application to confine
/usr/bin/foo<span id="co.apparmor.profiles.path"></span><span class="callout">2</span> {<span id="co.apparmor.profiles.brack"></span><span class="callout">3</span>
   #include &lt;abstractions/base&gt;<span id="co.apparmor.profiles.incl"></span><span class="callout">4</span>

   capability setgid<span id="co.apparmor.profiles.capent"></span><span class="callout">5</span>,
   network inet tcp<span id="co.apparmor.profiles.netd"></span><span class="callout">6</span>,

   link /etc/sysconfig/foo -&gt; /etc/foo.conf,<span id="co.apparmor.profiles.lp"></span><span class="callout">7</span>
   /bin/mount            ux,
   /dev/{,u}<span id="co.apparmor.profiles.ext"></span><span class="callout">8</span>random     r,
   /etc/ld.so.cache      r,
   /etc/foo/*            r,
   /lib/ld-*.so*         mr,
   /lib/lib*.so*         mr,
   /proc/[0-9]**         r,
   /usr/lib/**           mr,
   /tmp/                 r,<span id="co.apparmor.profiles.pathent"></span><span class="callout">9</span>
   /tmp/foo.pid          wr,
   /tmp/foo.*            lrw,
   /@{HOME}<span id="co.apparmor.profiles.variable"></span><span class="callout">10</span>/.foo_file   rw,
   /@{HOME}/.foo_lock    kw,
   owner<span id="co.apparmor.profiles.owner"></span><span class="callout">11</span> /shared/foo/** rw,
   /usr/bin/foobar       Cx,<span id="co.apparmor.profiles.cx"></span><span class="callout">12</span>
   /bin/**               Px -&gt; bin_generic,<span id="co.apparmor.profiles.named"></span><span class="callout">13</span>

   # a comment about foo's local (children) profile for /usr/bin/foobar.

   profile /usr/bin/foobar<span id="co.apparmor.profiles.local"></span><span class="callout">14</span> {
      /bin/bash          rmix,
      /bin/cat           rmix,
      /bin/more          rmix,
      /var/log/foobar*   rwl,
      /etc/foobar        r,
   }

  # foo's hat, bar.
   ^bar<span id="co.apparmor.profiles.hat"></span><span class="callout">15</span> {
    /lib/ld-*.so*         mr,
    /usr/bin/bar          px,
    /var/spool/*          rwl,
   }
}</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.vardef"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     This loads a file containing variable definitions.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.path"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     The normalized path to the program that is confined.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.brack"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     The curly braces (<code class="literal">{}</code>) serve as a container for
     include statements, subprofiles, path entries, capability entries, and
     network entries.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.incl"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     This directive pulls in components of <span class="phrase">AppArmor</span> profiles to simplify
     profiles.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.capent"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     Capability entry statements enable each of the 29 POSIX.1e draft
     capabilities.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.netd"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     A directive determining the kind of network access allowed to the
     application. For details, refer to
     <a class="xref" href="#sec.apparmor.profiles.nac" title="22.5. Network Access Control">Section 22.5, “Network Access Control”</a>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.lp"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
     A link pair rule specifying the source and the target of a link. See
     <a class="xref" href="#sec.apparmor.profiles.perm.link_pair" title="22.7.6. Link Pair">Section 22.7.6, “Link Pair”</a> for more
     information.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.ext"><span class="callout">8</span></a> </p></td><td valign="top" align="left"><p>
     The curly braces (<code class="literal">{}</code>) here allow for each of the
     listed possibilities, one of which is the empty string.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.pathent"><span class="callout">9</span></a> </p></td><td valign="top" align="left"><p>
     A path entry specifying what areas of the file system the program can
     access. The first part of a path entry specifies the absolute path of a
     file (including regular expression globbing) and the second part
     indicates permissible access modes (for example <code class="literal">r</code>
     for read, <code class="literal">w</code> for write, and <code class="literal">x</code> for
     execute). A whitespace of any kind (spaces or tabs) can precede the
     path name, but must separate the path name and the mode specifier.
     Spaces between the access mode and the trailing comma are optional.
     Find a comprehensive overview of the available access modes in
     <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.variable"><span class="callout">10</span></a> </p></td><td valign="top" align="left"><p>
     This variable expands to a value that can be changed without changing
     the entire profile.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.owner"><span class="callout">11</span></a> </p></td><td valign="top" align="left"><p>
     An owner conditional rule, granting read and write permission on files
     owned by the user. Refer to
     <a class="xref" href="#sec.apparmor.profiles.perm.owner" title="22.7.8. Owner Conditional Rules">Section 22.7.8, “Owner Conditional Rules”</a> for more
     information.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.cx"><span class="callout">12</span></a> </p></td><td valign="top" align="left"><p>
     This entry defines a transition to the local profile
     <code class="literal">/usr/bin/foobar</code>. Find a comprehensive overview of
     the available execute modes in
     <a class="xref" href="#sec.apparmor.profiles.exec" title="22.8. Execute Modes">Section 22.8, “Execute Modes”</a>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.named"><span class="callout">13</span></a> </p></td><td valign="top" align="left"><p>
     A named profile transition to the profile bin_generic located in the
     global scope. See <a class="xref" href="#sec.apparmor.profiles.exec.named" title="22.8.7. Named Profile Transitions">Section 22.8.7, “Named Profile Transitions”</a>
     for details.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.local"><span class="callout">14</span></a> </p></td><td valign="top" align="left"><p>
     The local profile <code class="literal">/usr/bin/foobar</code> is defined in this
     section.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.hat"><span class="callout">15</span></a> </p></td><td valign="top" align="left"><p>
     This section references a <span class="quote">“<span class="quote">hat</span>”</span> subprofile of the
     application. For more details on <span class="phrase">AppArmor</span>'s ChangeHat feature, refer to
     <a class="xref" href="#cha.apparmor.hat" title="Chapter 26. Profiling Your Web Applications Using ChangeHat">Chapter 26, <em>Profiling Your Web Applications Using ChangeHat</em></a>.
    </p></td></tr></table></div><p>
   When a profile is created for a program, the program can access only the
   files, modes, and POSIX capabilities specified in the profile. These
   restrictions are in addition to the native Linux access controls.
  </p><p><span class="formalpara-title">Example: </span>
    To gain the capability <code class="systemitem">CAP_CHOWN</code>, the
    program must have both access to <code class="systemitem">CAP_CHOWN</code>
    under conventional Linux access controls (typically, be a
    <code class="systemitem">root</code>-owned process) and have the capability
    <code class="systemitem">chown</code> in its profile. Similarly, to be able
    to write to the file <code class="filename">/foo/bar</code> the program must
    have both the correct user ID and mode bits set in the files
    attributes and have <code class="literal">/foo/bar w</code> in its profile.
   </p><p>
   Attempts to violate <span class="phrase">AppArmor</span> rules are recorded in
   <code class="filename">/var/log/audit/audit.log</code> if the
   <code class="systemitem">audit</code> package is installed, or
   in <code class="filename">/var/log/messages</code>, or only in
   <code class="systemitem">journalctl</code> if no traditional syslog is
   installed. Often <span class="phrase">AppArmor</span> rules prevent an attack from working
   because necessary files are not accessible and, in all cases, <span class="phrase">AppArmor</span>
   confinement restricts the damage that the attacker can do to the set of
   files permitted by <span class="phrase">AppArmor</span>.
  </p></div><div class="sect1 " id="sec.apparmor.profiles.types"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.types"><span class="number">22.2 </span><span class="name">Profile Types</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> knows four different types of profiles: standard profiles,
   unattached profiles, local profiles and hats. Standard and unattached
   profiles are stand-alone profiles, each stored in a file under
   <code class="filename">/etc/apparmor.d/</code>. Local profiles and hats are
   children profiles embedded inside of a parent profile used to provide
   tighter or alternate confinement for a subtask of an application.
  </p><div class="sect2 " id="sec.apparmor.profiles.types.attached"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.types.attached"><span class="number">22.2.1 </span><span class="name">Standard Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types.attached">#</a></h3></div></div></div><p>
    The default <span class="phrase">AppArmor</span> profile is attached to a program by its name, so a
    profile name must match the path to the application it is to confine.
   </p><div class="verbatim-wrap"><pre class="screen">/usr/bin/foo {
...
}</pre></div><p>
    This profile will be automatically used whenever an unconfined process
    executes <code class="filename">/usr/bin/foo</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.types.unattached"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.types.unattached"><span class="number">22.2.2 </span><span class="name">Unattached Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types.unattached">#</a></h3></div></div></div><p>
    Unattached profiles do not reside in the file system namespace and
    therefore are not automatically attached to an application. The name of
    an unattached profile is preceded by the keyword
    <code class="literal">profile</code>. You can freely choose a profile name, except
    for the following limitations: the name must not begin with a
    <code class="literal">:</code> or <code class="literal">.</code> character. If it contains a
    whitespace, it must be quoted. If the name begins with a
    <code class="literal">/</code>, the profile is considered to be a standard
    profile, so the following two profiles are identical:
   </p><div class="verbatim-wrap"><pre class="screen">profile /usr/bin/foo {
...
}
/usr/bin/foo {
...
}</pre></div><p>
    Unattached profiles are never used automatically, nor can they be
    transitioned to through a <code class="literal">Px</code> rule. They need to be
    attached to a program by either using a named profile transition (see
    <a class="xref" href="#sec.apparmor.profiles.exec.named" title="22.8.7. Named Profile Transitions">Section 22.8.7, “Named Profile Transitions”</a>) or with the
    <code class="literal">change_profile</code> rule (see
    <a class="xref" href="#sec.apparmor.profiles.types.change" title="22.2.5. Change rules">Section 22.2.5, “Change rules”</a>).
   </p><p>
    Unattached profiles are useful for specialized profiles for system
    utilities that generally should not be confined by a system-wide profile
    (for example, <code class="literal">/bin/bash</code>). They can also be used to
    set up roles or to confine a user.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.types.local"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.types.local"><span class="number">22.2.3 </span><span class="name">Local Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types.local">#</a></h3></div></div></div><p>
    Local profiles provide a convenient way to provide specialized
    confinement for utility programs launched by a confined application.
    They are specified like standard profiles, except that they are embedded
    in a parent profile and begin with the <code class="literal">profile</code>
    keyword:
   </p><div class="verbatim-wrap"><pre class="screen">/parent/profile {
   ...
   profile /local/profile {
      ...
   }
}</pre></div><p>
    To transition to a local profile, either use a <code class="literal">cx</code>
    rule (see <a class="xref" href="#sec.apparmor.profiles.exec.cx" title="22.8.2. Discrete Local Profile Execute Mode (Cx)">Section 22.8.2, “Discrete Local Profile Execute Mode (Cx)”</a>) or a named
    profile transition (see
    <a class="xref" href="#sec.apparmor.profiles.exec.named" title="22.8.7. Named Profile Transitions">Section 22.8.7, “Named Profile Transitions”</a>).
   </p></div><div class="sect2 " id="sec.apparmor.profiles.types.hat"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.types.hat"><span class="number">22.2.4 </span><span class="name">Hats</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types.hat">#</a></h3></div></div></div><p>
    <span class="phrase">AppArmor</span> "hats" are a local profiles with some additional restrictions
    and an implicit rule allowing for <code class="literal">change_hat</code> to be
    used to transition to them. Refer to <a class="xref" href="#cha.apparmor.hat" title="Chapter 26. Profiling Your Web Applications Using ChangeHat">Chapter 26, <em>Profiling Your Web Applications Using ChangeHat</em></a>
    for a detailed description.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.types.change"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.types.change"><span class="number">22.2.5 </span><span class="name">Change rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.types.change">#</a></h3></div></div></div><p>
    <span class="phrase">AppArmor</span> provides <code class="literal">change_hat</code> and
    <code class="literal">change_profile</code> rules that control domain
    transitioning. <code class="literal">change_hat</code> are specified by defining
    hats in a profile, while <code class="literal">change_profile</code> rules refer
    to another profile and start with the keyword
    <code class="literal">change_profile</code>:
   </p><div class="verbatim-wrap"><pre class="screen">change_profile -&gt; /usr/bin/foobar,</pre></div><p>
    Both <code class="literal">change_hat</code> and <code class="literal">change_profile</code>
    provide for an application directed profile transition, without having
    to launch a separate application. <code class="literal">change_profile</code>
    provides a generic one way transition between any of the loaded
    profiles. <code class="literal">change_hat</code> provides for a returnable parent
    child transition where an application can switch from the parent profile
    to the hat profile and if it provides the correct secret key return to
    the parent profile at a later time.
   </p><p>
    <code class="literal">change_profile</code> is best used in situations where an
    application goes through a trusted setup phase and then can lower its
    privilege level. Any resources mapped or opened during the start-up
    phase may still be accessible after the profile change, but the new
    profile will restrict the opening of new resources, and will even limit
    some  resources opened before the switch. Specifically, memory
    resources will still be available while capability and file resources
    (as long as they are not memory mapped) can be limited.
   </p><p>
    <code class="literal">change_hat</code> is best used in situations where an
    application runs a virtual machine or an interpreter that does not
    provide direct access to the applications resources (for example
    Apache's <code class="literal">mod_php</code>). Since
    <code class="literal">change_hat</code> stores the return secret key in the
    application's memory the phase of reduced privilege should not have
    direct access to memory. It is also important that file access is
    properly separated, since the hat can restrict accesses to a file handle
    but does not close it. If an application does buffering and provides
    access to the open files with buffering, the accesses to these files
    might not be seen by the kernel and hence not restricted by the new
    profile.
   </p><div id="idm140712067329296" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Safety of Domain Transitions</h6><p>
     The <code class="literal">change_hat</code> and <code class="literal">change_profile</code>
     domain transitions are less secure than a domain transition done
     through an exec because they do not affect a process's memory mappings,
     nor do they close resources that have already been opened.
    </p></div></div></div><div class="sect1 " id="sec.apparmor.profiles.includes"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.includes"><span class="number">22.3 </span><span class="name">Include Statements</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.includes">#</a></h2></div></div></div><p>
   Include statements are directives that pull in components of other
   <span class="phrase">AppArmor</span> profiles to simplify profiles. Include files retrieve access
   permissions for programs. By using an include, you can give the program
   access to directory paths or files that are also required by other
   programs. Using includes can reduce the size of a profile.
  </p><p>
   Include statements normally begin with a hash (<code class="literal">#</code>)
   sign. This is confusing because the same hash sign is used for comments
   inside profile files. Because of this, <code class="literal">#include</code> is
   treated as an include only if there is no preceding #
   (<code class="literal">##include</code> is a comment) and there is no whitespace
   between <code class="literal">#</code> and <code class="literal">include</code> (<code class="literal">#
   include</code> is a comment).
  </p><p>
   You can also use <code class="literal">include</code> without the leading
   <code class="literal">#</code>.
  </p><div class="verbatim-wrap"><pre class="screen">include "/etc/apparmor.d/abstractions/foo"</pre></div><p>
   is the same as using
  </p><div class="verbatim-wrap"><pre class="screen">#include "/etc/apparmor.d/abstractions/foo"</pre></div><div id="idm140712067317968" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: No Trailing ','</h6><p>
    Note that because includes follow the C pre-processor syntax, they do
    not have a trailing ',' like most <span class="phrase">AppArmor</span> rules.
   </p></div><p>
   By slight changes in syntax, you can modify the behavior of
   <code class="literal">include</code>. If you use <code class="literal">""</code> around the
   including path, you instruct the parser to do an absolute or relative
   path lookup.
  </p><div class="verbatim-wrap"><pre class="screen">include "/etc/apparmor.d/abstractions/foo"   # absolute path
include "abstractions/foo"   # relative path to the directory of current file</pre></div><p>
   Note that when using relative path includes, when the file is included,
   it is considered the new current file for its includes. For example,
   suppose you are in the <code class="filename">/etc/apparmor.d/bar</code> file,
   then
  </p><div class="verbatim-wrap"><pre class="screen">include "abstractions/foo"</pre></div><p>
   includes the file <code class="filename">/etc/apparmor.d/abstractions/foo</code>.
   If then there is
  </p><div class="verbatim-wrap"><pre class="screen">include "example"</pre></div><p>
   inside the <code class="filename">/etc/apparmor.d/abstractions/foo</code> file, it
   includes <code class="filename">/etc/apparmor.d/abstractions/example</code>.
  </p><p>
   The use of <code class="literal">&lt;&gt;</code> specifies to try the include
   path (specified by <code class="option">-I</code>, defaults to the
   <code class="filename">/etc/apparmor.d</code> directory) in an ordered way. So
   assuming the include path is
  </p><div class="verbatim-wrap"><pre class="screen">-I /etc/apparmor.d/ -I /usr/share/apparmor/</pre></div><p>
   then the include statement
  </p><div class="verbatim-wrap"><pre class="screen">include &lt;abstractions/foo&gt;</pre></div><p>
   will try <code class="filename">/etc/apparmor.d/abstractions/foo</code>, and if
   that file does not exist, the next try is
   <code class="filename">/usr/share/apparmor/abstractions/foo</code>.
  </p><div id="idm140712067305056" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
    The default include path can be overridden manually by passing
    <code class="option">-I</code> to the <code class="command">apparmor_parser</code>, or by
    setting the include paths in
    <code class="filename">/etc/apparmor/parser.conf</code>:
   </p><div class="verbatim-wrap"><pre class="screen">Include /usr/share/apparmor/
Include /etc/apparmor.d/</pre></div><p>
    Multiple entries are allowed, and they are taken in the same order as
    when they are when using <code class="option">-I</code> or
    <code class="option">--Include</code> from the <code class="command">apparmor_parser</code>
    command line.
   </p></div><p>
   If an include ends with '/', this is considered a directory include, and
   all files within the directory are included.
  </p><p>
   To assist you in profiling your applications, <span class="phrase">AppArmor</span> provides three
   classes of includes: abstractions, program chunks and tunables.
  </p><div class="sect2 " id="sec.apparmor.profiles.includes.abstractions"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.includes.abstractions"><span class="number">22.3.1 </span><span class="name">Abstractions</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.includes.abstractions">#</a></h3></div></div></div><p>
    Abstractions are includes that are grouped by common application tasks.
    These tasks include access to authentication mechanisms, access to name
    service routines, common graphics requirements, and system accounting.
    Files listed in these abstractions are specific to the named task.
    Programs that require one of these files usually also require
    other files listed in the abstraction file (depending on the local
    configuration and the specific requirements of the program). Find
    abstractions in <code class="filename">/etc/apparmor.d/abstractions</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.includes.chunks"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.includes.chunks"><span class="number">22.3.2 </span><span class="name">Program Chunks</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.includes.chunks">#</a></h3></div></div></div><p>
    The program-chunks directory
    (<code class="filename">/etc/apparmor.d/program-chunks</code>) contains some
    chunks of profiles that are specific to program suites and not generally
    useful outside of the suite, thus are never suggested for use in
    profiles by the profile wizards (<code class="command">aa-logprof</code> and
    <code class="command">aa-genprof</code>). Currently, program chunks are only
    available for the postfix program suite.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.includes.tunables"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.includes.tunables"><span class="number">22.3.3 </span><span class="name">Tunables</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.includes.tunables">#</a></h3></div></div></div><p>
    The tunables directory (<code class="filename">/etc/apparmor.d/tunables</code>)
    contains global variable definitions. When used in a profile, these
    variables expand to a value that can be changed without changing the
    entire profile. Add all the tunables definitions that should be
    available to every profile to
    <code class="filename">/etc/apparmor.d/tunables/global</code>.
   </p></div></div><div class="sect1 " id="sec.apparmor.profiles.capabilities"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.capabilities"><span class="number">22.4 </span><span class="name">Capability Entries (POSIX.1e)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.capabilities">#</a></h2></div></div></div><p>
   Capability rules are simply the word <code class="literal">capability</code>
   followed by the name of the POSIX.1e capability as defined in the
   <code class="systemitem">capabilities(7)</code> man page. You can list multiple
   capabilities in a single rule, or grant all implemented capabilities with
   the bare keyword <code class="literal">capability</code>.
  </p><div class="verbatim-wrap"><pre class="screen">capability dac_override sys_admin,   # multiple capabilities
capability,                          # grant all capabilities</pre></div></div><div class="sect1 " id="sec.apparmor.profiles.nac"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.nac"><span class="number">22.5 </span><span class="name">Network Access Control</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.nac">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> allows mediation of network access based on the address type and
   family. The following illustrates the network access rule syntax:
  </p><div class="verbatim-wrap"><pre class="screen">network [[&lt;domain&gt;<span id="co.apparmor.profiles.nac.dom"></span><span class="callout">1</span>][&lt;type<span id="co.apparmor.profiles.nac.type"></span><span class="callout">2</span>&gt;][&lt;protocol<span id="co.apparmor.profiles.nac.proto"></span><span class="callout">3</span>&gt;]]</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.dom"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Supported domains: <code class="literal">inet</code>, <code class="literal">ax25</code>,
     <code class="literal">ipx</code>, <code class="literal">appletalk</code>,
     <code class="literal">netrom</code>, <code class="literal">bridge</code>,
     <code class="literal">x25</code>, <code class="literal">inet6</code>,
     <code class="literal">rose</code>, <code class="literal">netbeui</code>,
     <code class="literal">security</code>, <code class="literal">key</code>,
     <code class="literal">packet</code>, <code class="literal">ash</code>,
     <code class="literal">econet</code>, <code class="literal">atmsvc</code>,
     <code class="literal">sna</code>,
     <code class="literal">pppox</code>, <code class="literal">wanpipe</code>,
     <code class="literal">bluetooth</code>, <code class="literal">unix</code>,
     <code class="literal">atmpvc</code>,<code class="literal">netlink</code>,
     <code class="literal">llc</code>, <code class="literal">can</code>,
     <code class="literal">tipc</code>, <code class="literal">iucv</code>,
     <code class="literal">rxrpc</code>, <code class="literal">isdn</code>,
     <code class="literal">phonet</code>, <code class="literal">ieee802154</code>,
     <code class="literal">caif</code>, <code class="literal">alg</code>,
     <code class="literal">nfc</code>, <code class="literal">vsock</code>
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.type"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Supported types: <code class="literal">stream</code>, <code class="literal">dgram</code>,
     <code class="literal">seqpacket</code>, <code class="literal">rdm</code>,
     <code class="literal">raw</code>, <code class="literal">packet</code>
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.proto"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Supported protocols: <code class="literal">tcp</code>, <code class="literal">udp</code>,
     <code class="literal">icmp</code>
    </p></td></tr></table></div><p>
   The <span class="phrase">AppArmor</span> tools support only family and type specification. The <span class="phrase">AppArmor</span>
   module emits only <code class="literal">network <em class="replaceable ">DOMAIN</em>
   <em class="replaceable ">TYPE</em></code> in <span class="quote">“<span class="quote">ACCESS DENIED</span>”</span>
   messages. And only these are output by the profile generation tools, both
   YaST and command line.
  </p><p>
   The following examples illustrate possible network-related rules to be
   used in <span class="phrase">AppArmor</span> profiles. Note that the syntax of the last two are not
   currently supported by the <span class="phrase">AppArmor</span> tools.
  </p><div class="verbatim-wrap"><pre class="screen">network<span id="co.apparmor.profiles.nac.nw"></span><span class="callout">1</span>,
network inet<span id="co.apparmor.profiles.nac.inet"></span><span class="callout">2</span>,
network inet6<span id="co.apparmor.profiles.nac.inet6"></span><span class="callout">3</span>,
network inet stream<span id="co.apparmor.profiles.nac.istream"></span><span class="callout">4</span>,
network inet tcp<span id="co.apparmor.profiles.nac.itcp"></span><span class="callout">5</span>,
network tcp<span id="co.apparmor.profiles.nac.tcp"></span><span class="callout">6</span>,</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.nw"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Allow all networking. No restrictions applied with regard to domain,
     type, or protocol.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.inet"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Allow general use of IPv4 networking.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.inet6"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Allow general use of IPv6 networking.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.istream"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     Allow the use of IPv4 TCP networking.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.itcp"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     Allow the use of IPv4 TCP networking, paraphrasing the rule above.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.apparmor.profiles.nac.tcp"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     Allow the use of both IPv4 and IPv6 TCP networking.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.apparmor.profiles.glob"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.glob"><span class="number">22.6 </span><span class="name">Profile Names, Flags, Paths, and Globbing</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.glob">#</a></h2></div></div></div><p>
   A profile is usually attached to a program by specifying a full path to
   the program's executable. For example in the case of a standard profile
   (see <a class="xref" href="#sec.apparmor.profiles.types.attached" title="22.2.1. Standard Profiles">Section 22.2.1, “Standard Profiles”</a>), the profile
   is defined by
  </p><div class="verbatim-wrap"><pre class="screen">/usr/bin/foo { ... }</pre></div><p>
   The following sections describe several useful techniques that can be
   applied when naming a profile or putting a profile in the context of
   other existing ones, or specifying file paths.
  </p><p>
   <span class="phrase">AppArmor</span> explicitly distinguishes directory path names from file path
   names. Use a trailing <code class="literal">/</code> for any directory path that
   needs to be explicitly distinguished:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712067234176"><span class="term "><code class="filename">/some/random/example/* r</code>
    </span></dt><dd><p>
      Allow read access to files in the
      <code class="filename">/some/random/example</code> directory.
     </p></dd><dt id="idm140712067231600"><span class="term "><code class="filename">/some/random/example/ r</code>
    </span></dt><dd><p>
      Allow read access to the directory only.
     </p></dd><dt id="idm140712067229488"><span class="term "><code class="filename">/some/**/ r</code>
    </span></dt><dd><p>
      Give read access to any directories below <code class="filename">/some</code>
      (but not /some/ itself).
     </p></dd><dt id="idm140712067226912"><span class="term "><code class="filename">/some/random/example/** r</code>
    </span></dt><dd><p>
      Give read access to files and directories under
      <code class="filename">/some/random/example</code> (but not
      /some/random/example/ itself).
     </p></dd><dt id="idm140712067224288"><span class="term "><code class="filename">/some/random/example/**[^/] r</code>
    </span></dt><dd><p>
      Give read access to files under
      <code class="filename">/some/random/example</code>. Explicitly exclude
      directories (<code class="literal">[^/]</code>).
     </p></dd></dl></div><p>
   Globbing (or regular expression matching) is when you modify the
   directory path using wild cards to include a group of files or
   subdirectories. File resources can be specified with a globbing syntax
   similar to that used by popular shells, such as csh, Bash, and zsh.
  </p><div class="informaltable"><table border="1"><colgroup><col /><col /></colgroup><tbody><tr><td>
       <p>
        <code class="literal">*</code>
       </p>
      </td><td>
       <p>
        Substitutes for any number of any characters, except
        <code class="literal">/</code>.
       </p>
       <p>
        Example: An arbitrary number of file path elements.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">**</code>
       </p>
      </td><td>
       <p>
        Substitutes for any number of characters, including
        <code class="literal">/</code>.
       </p>
       <p>
        Example: An arbitrary number of path elements, including entire
        directories.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">?</code>
       </p>
      </td><td>
       <p>
        Substitutes for any single character, except <code class="literal">/</code>.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">[abc]</code>
       </p>
      </td><td>
       <p>
        Substitutes for the single character <code class="literal">a</code>,
        <code class="literal">b</code>, or <code class="literal">c</code>.
       </p>
       <p>
        Example: a rule that matches <code class="literal">/home[01]/*/.plan</code>
        allows a program to access <code class="filename">.plan</code> files for
        users in both <code class="filename">/home0</code> and
        <code class="filename">/home1</code>.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">[a-c]</code>
       </p>
      </td><td>
       <p>
        Substitutes for the single character <code class="literal">a</code>,
        <code class="literal">b</code>, or <code class="literal">c</code>.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">{ab,cd}</code>
       </p>
      </td><td>
       <p>
        Expands to one rule to match <code class="literal">ab</code> and one rule to
        match <code class="literal">cd</code>.
       </p>
       <p>
        Example: a rule that matches <code class="literal">/{usr,www}/pages/**</code>
        grants access to Web pages in both <code class="filename">/usr/pages</code>
        and <code class="filename">/www/pages</code>.
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">[^a]</code>
       </p>
      </td><td>
       <p>
        Substitutes for any character except <code class="literal">a</code>.
       </p>
      </td></tr></tbody></table></div><div class="sect2 " id="sec.apparmor.profiles.flags"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.flags"><span class="number">22.6.1 </span><span class="name">Profile Flags</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.flags">#</a></h3></div></div></div><p>
    Profile flags control the behavior of the related profile. You can add
    profile flags to the profile definition by editing it manually, see the
    following syntax:
   </p><div class="verbatim-wrap"><pre class="screen">/path/to/profiled/binary flags=(list_of_flags) {
  [...]
}</pre></div><p>
    You can use multiple flags separated by a comma ',' or space ' '. There
    are three basic types of profile flags: mode, relative, and attach
    flags.
   </p><p>
    <span class="emphasis"><em>Mode</em></span> flag is <code class="literal">complain</code> (illegal
    accesses are allowed and logged). If it is omitted, the profile is in
    <code class="literal">enforce</code> mode (enforces the policy).
   </p><div id="idm140712067181088" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     A more flexible way of setting the whole profile into complain mode is
     to create a symbolic link from the profile file inside the
     <code class="filename">/etc/apparmor.d/force-complain/</code> directory.
    </p><div class="verbatim-wrap"><pre class="screen">ln -s /etc/apparmor.d/bin.ping /etc/apparmor.d/force-complain/bin.ping</pre></div></div><p>
    <span class="emphasis"><em>Relative</em></span> flags are
    <code class="literal">chroot_relative</code> (states that the profile is relative
    to the chroot instead of namespace) or
    <code class="literal">namespace_relative</code> (the default, with the path being
    relative to outside the chroot). They are mutually exclusive.
   </p><p>
    <span class="emphasis"><em>Attach</em></span> flags consist of two pairs of mutually
    exclusive flags: <code class="literal">attach_disconnected</code> or
    <code class="literal">no_attach_disconnected</code> (determine if path names
    resolved to be outside of the namespace are attached to the root, which
    means they have the '/' character at the beginning), and
    <code class="literal">chroot_attach</code> or <code class="literal">chroot_no_attach</code>
    (control path name generation when in a chroot environment while a file
    is accessed that is external to the chroot but within the namespace).
   </p></div><div class="sect2 " id="sec.apparmor.profiles.glob.variables"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.glob.variables"><span class="number">22.6.2 </span><span class="name">Using Variables in Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.glob.variables">#</a></h3></div></div></div><p>
    <span class="phrase">AppArmor</span> allows to use variables holding paths in profiles. Use global
    variables to make your profiles portable and local variables to create
    shortcuts for paths.
   </p><p>
    A typical example of when global variables come in handy are network
    scenarios in which user home directories are mounted in different
    locations. Instead of rewriting paths to home directories in all
    affected profiles, you only need to change the value of a variable.
    Global variables are defined under
    <code class="filename">/etc/apparmor.d/tunables</code> and need to be made
    available via an include statement. Find the variable definitions for
    this use case (<code class="envar">@{HOME}</code> and <code class="envar">@{HOMEDIRS}</code>) in
    the <code class="filename">/etc/apparmor.d/tunables/home</code> file.
   </p><p>
    Local variables are defined at the head of a profile. This is useful to
    provide the base of for a chrooted path, for example:
   </p><div class="verbatim-wrap"><pre class="screen">@{CHROOT_BASE}=/tmp/foo
/sbin/rsyslogd {
...
# chrooted applications
@{CHROOT_BASE}/var/lib/*/dev/log w,
@{CHROOT_BASE}/var/log/** w,
...
}</pre></div><p>
    In the following example, while @{HOMEDIRS} lists where all the user
    home directories are stored, @{HOME} is a space-separated list of home
    directories. Later on, @{HOMEDIRS} is expanded by two new specific
    places where user home directories are stored.
   </p><div class="verbatim-wrap"><pre class="screen">@{HOMEDIRS}=/home/
@{HOME}=@{HOMEDIRS}/*/ /root/
[...]
@{HOMEDIRS}+=/srv/nfs/home/ /mnt/home/</pre></div><div id="idm140712067166704" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     With the current <span class="phrase">AppArmor</span> tools, variables can only be used when
     manually editing and maintaining a profile.
    </p></div></div><div class="sect2 " id="sec.apparmor.profiles.pattern_matching"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.pattern_matching"><span class="number">22.6.3 </span><span class="name">Pattern Matching</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.pattern_matching">#</a></h3></div></div></div><p>
    Profile names can contain globbing expressions allowing the profile to
    match against multiple binaries.
   </p><p>
    The following example is valid for systems where the
    <code class="command">foo</code> binary resides either in
    <code class="filename">/usr/bin</code> or <code class="filename">/bin</code>.
   </p><div class="verbatim-wrap"><pre class="screen">/{usr/,}bin/foo { ... }</pre></div><p>
    In the following example, when matching against the executable
    <code class="filename">/bin/foo</code>, the <code class="literal">/bin/foo</code> profile
    is an exact match so it is chosen. For the executable
    <code class="filename">/bin/fat</code>, the profile <code class="literal">/bin/foo</code>
    does not match, and because the <code class="literal">/bin/f*</code> profile is
    more specific (less general) than <code class="literal">/bin/**</code>, the
    <code class="literal">/bin/f*</code> profile is chosen.
   </p><div class="verbatim-wrap"><pre class="screen">/bin/foo { ... }

/bin/f*  { ... }

/bin/**  { ... }</pre></div><p>
    For more information on profile name globbing examples, see the man page
    of <span class="phrase">AppArmor</span>, <code class="command">man 5 apparmor.d,</code>, section
    <code class="literal">Globbing</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.namespaces"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.namespaces"><span class="number">22.6.4 </span><span class="name">Namespaces</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.namespaces">#</a></h3></div></div></div><p>
    Namespaces are used to provide different profiles sets. Say one for the
    system, another for a chroot environment or container. Namespaces are
    hierarchical—a namespace can see its children but a child
    cannot see its parent. Namespace names start with a colon
    <code class="literal">:</code> followed by an alphanumeric string, a trailing
    colon <code class="literal">:</code> and an optional double slash
    <code class="literal">//</code>, such as
   </p><div class="verbatim-wrap"><pre class="screen">:childNameSpace://</pre></div><p>
    Profiles loaded to a child namespace will be prefixed with their
    namespace name (viewed from a parent's perspective):
   </p><div class="verbatim-wrap"><pre class="screen">:childNameSpace://apache</pre></div><p>
    Namespaces can be entered via the <code class="literal">change_profile</code> API,
    or named profile transitions:
   </p><div class="verbatim-wrap"><pre class="screen">/path/to/executable px -&gt; :childNameSpace://apache</pre></div></div><div class="sect2 " id="sec.apparmor.profiles.naming_attachment"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.naming_attachment"><span class="number">22.6.5 </span><span class="name">Profile Naming and Attachment Specification</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.naming_attachment">#</a></h3></div></div></div><p>
    Profiles can have a name, and an attachment specification. This allows
    for profiles with a logical name that can be more meaningful to
    users/administrators than a profile name that contains pattern matching
    (see <a class="xref" href="#sec.apparmor.profiles.pattern_matching" title="22.6.3. Pattern Matching">Section 22.6.3, “Pattern Matching”</a>). For example,
    the default profile
   </p><div class="verbatim-wrap"><pre class="screen">/** { ... }</pre></div><p>
    can be named
   </p><div class="verbatim-wrap"><pre class="screen">profile default /** { ... }</pre></div><p>
    Also, a profile with pattern matching can be named. For example:
   </p><div class="verbatim-wrap"><pre class="screen">/usr/lib/firefox-3.*/firefox-*bin { ... }</pre></div><p>
    can be named
   </p><div class="verbatim-wrap"><pre class="screen">profile firefox /usr/lib/firefox-3.*/firefox-*bin { ... }</pre></div></div><div class="sect2 " id="sec.apparmor.profiles.glob.alias"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.glob.alias"><span class="number">22.6.6 </span><span class="name">Alias Rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.glob.alias">#</a></h3></div></div></div><p>
    Alias rules provide an alternative way to manipulate profile path
    mappings to site specific layouts. They are an alternative form of path
    rewriting to using variables, and are done post variable resolution. The
    alias rule says to treat rules that have the same source prefix as if
    the rules are at target prefix.
   </p><div class="verbatim-wrap"><pre class="screen">alias /home/ -&gt; /usr/home/</pre></div><p>
    All the rules that have a prefix match to <code class="filename">/home/</code>
    will provide access to <code class="filename">/usr/home/</code>. For example
   </p><div class="verbatim-wrap"><pre class="screen">/home/username/** r,</pre></div><p>
    allows as well access to
   </p><div class="verbatim-wrap"><pre class="screen">/usr/home/username/** r,</pre></div><p>
    Aliases provide a quick way of remapping rules without the need to
    rewrite them. They keep the source path still accessible—in our
    example, the alias rule keeps the paths under
    <code class="filename">/home/</code> still accessible.
   </p><p>
    With the <code class="literal">alias</code> rule, you can point to multiple
    targets at the same time.
   </p><div class="verbatim-wrap"><pre class="screen">alias /home/ -&gt; /usr/home/
alias /home/ -&gt; /mnt/home/</pre></div><div id="idm140712067134928" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     With the current <span class="phrase">AppArmor</span> tools, alias rules can only be used when
     manually editing and maintaining a profile.
    </p></div><div id="idm140712067133504" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     Insert global alias definitions in the file
     <code class="filename">/etc/apparmor.d/tunables/alias</code>.
    </p></div></div></div><div class="sect1 " id="sec.apparmor.profiles.perm"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.perm"><span class="number">22.7 </span><span class="name">File Permission Access Modes</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm">#</a></h2></div></div></div><p>
   File permission access modes consist of combinations of the following
   modes:
  </p><div class="informaltable"><table border="1"><colgroup><col /><col /></colgroup><tbody><tr><td>
       <p>
        <code class="literal">r</code>
       </p>
      </td><td>
       <p>
        Read mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">w</code>
       </p>
      </td><td>
       <p>
        Write mode (mutually exclusive to <code class="literal">a</code>)
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">a</code>
       </p>
      </td><td>
       <p>
        Append mode (mutually exclusive to <code class="literal">w</code>)
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">k</code>
       </p>
      </td><td>
       <p>
        File locking mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">l</code>
       </p>
      </td><td>
       <p>
        Link mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">link <em class="replaceable ">FILE</em> -&gt;
        <em class="replaceable ">TARGET</em></code>
       </p>
      </td><td>
       <p>
        Link pair rule (cannot be combined with other access modes)
       </p>
      </td></tr></tbody></table></div><div class="sect2 " id="sec.apparmor.profiles.perm.r"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.r"><span class="number">22.7.1 </span><span class="name">Read Mode (r)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.r">#</a></h3></div></div></div><p>
    Allows the program to have read access to the resource. Read access is
    required for shell scripts and other interpreted content and determines
    if an executing process can core dump.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.perm.w"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.w"><span class="number">22.7.2 </span><span class="name">Write Mode (w)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.w">#</a></h3></div></div></div><p>
    Allows the program to have write access to the resource. Files must have
    this permission if they are to be unlinked (removed).
   </p></div><div class="sect2 " id="sec.apparmor.profiles.perm.a"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.a"><span class="number">22.7.3 </span><span class="name">Append Mode (a)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.a">#</a></h3></div></div></div><p>
    Allows a program to write to the end of a file. In contrast to the
    <code class="literal">w</code> mode, the append mode does not include the ability
    to overwrite data, to rename, or to remove a file. The append permission
    is typically used with applications who need to be able to write to log
    files, but which should not be able to manipulate any existing data in
    the log files. As the append permission is a subset of the permissions
    associated with the write mode, the <code class="literal">w</code> and
    <code class="literal">a</code> permission flags cannot be used together and are
    mutually exclusive.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.perm.k"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.k"><span class="number">22.7.4 </span><span class="name">File Locking Mode (k)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.k">#</a></h3></div></div></div><p>
    The application can take file locks. Former versions of <span class="phrase">AppArmor</span> allowed
    files to be locked if an application had access to them. By using a
    separate file locking mode, <span class="phrase">AppArmor</span> makes sure locking is restricted
    only to those files which need file locking and tightens security as
    locking can be used in several denial of service attack scenarios.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.perm.link"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.link"><span class="number">22.7.5 </span><span class="name">Link Mode (l)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.link">#</a></h3></div></div></div><p>
    The link mode mediates access to hard links. When a link is created, the
    target file must have the same access permissions as the link created
    (but the destination does not need link access).
   </p></div><div class="sect2 " id="sec.apparmor.profiles.perm.link_pair"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.link_pair"><span class="number">22.7.6 </span><span class="name">Link Pair</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.link_pair">#</a></h3></div></div></div><p>
    The link mode grants permission to link to arbitrary files, provided the
    link has a subset of the permissions granted by the target (subset
    permission test).
   </p><div class="verbatim-wrap"><pre class="screen">/srv/www/htdocs/index.html rl,</pre></div><p>
    By specifying origin and destination, the link pair rule provides
    greater control over how hard links are created. Link pair rules by
    default do not enforce the link subset permission test that the standard
    rules link permission requires.
   </p><div class="verbatim-wrap"><pre class="screen">link /srv/www/htdocs/index.html -&gt; /var/www/index.html</pre></div><p>
    To force the rule to require the test, the <code class="literal">subset</code>
    keyword is used. The following rules are equivalent:
   </p><div class="verbatim-wrap"><pre class="screen">/var/www/index.html l,
link subset /var/www/index.html -&gt; /**,</pre></div><div id="idm140712067092928" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
     Currently link pair rules are not supported by YaST and the
     command line tools. Manually edit your profiles to use them. Updating
     such profiles using the tools is safe, because the link pair entries
     will not be touched.
    </p></div></div><div class="sect2 " id="sec.apparmor.profiles.perm.file_allow"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.file_allow"><span class="number">22.7.7 </span><span class="name">Optional <code class="literal">allow</code> and <code class="literal">file</code> Rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.file_allow">#</a></h3></div></div></div><p>
    The <code class="literal">allow</code> prefix is optional, and it is idiomatically
    implied if not specified and the <code class="literal">deny</code> (see
    <a class="xref" href="#sec.apparmor.profiles.perm.deny" title="22.7.9. Deny Rules">Section 22.7.9, “Deny Rules”</a>) keyword is not used.
   </p><div class="verbatim-wrap"><pre class="screen">allow file /example r,
allow /example r,
allow network,</pre></div><p>
    You can also use the optional <code class="literal">file</code> keyword. If you
    omit it and there are no other rule types that start with a keyword,
    such as <code class="literal">network</code> or <code class="literal">mount</code>, it is
    automatically implied.
   </p><div class="verbatim-wrap"><pre class="screen">file /example/rule r,</pre></div><p>
    is equivalent to
   </p><div class="verbatim-wrap"><pre class="screen">/example/rule r,</pre></div><p>
    The following rule grants access to all files:
   </p><div class="verbatim-wrap"><pre class="screen">file,</pre></div><p>
    which is equal to
   </p><div class="verbatim-wrap"><pre class="screen">/** rwmlk,</pre></div><p>
    File rules can use leading or trailing permissions. The permissions
    should not be specified as a trailing permission, but rather used at the
    start of the rule. This is important in that it makes file rules behave
    like any other rule types.
   </p><div class="verbatim-wrap"><pre class="screen">/path rw,            # old style
rw /path,            # leading permission
file rw /path,       # with explicit 'file' keyword
allow file rw /path, # optional 'allow' keyword added</pre></div></div><div class="sect2 " id="sec.apparmor.profiles.perm.owner"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.owner"><span class="number">22.7.8 </span><span class="name">Owner Conditional Rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.owner">#</a></h3></div></div></div><p>
    The file rules can be extended so that they can be conditional upon
    the user being the owner of the file (the fsuid needs to match the
    file's uid). For this purpose the <code class="literal">owner</code> keyword
    is put in front of the rule. Owner conditional rules accumulate like
    regular file rules do.
   </p><div class="verbatim-wrap"><pre class="screen">owner /home/*/** rw</pre></div><p>
    When using file ownership conditions with link rules the ownership test
    is done against the target file so the user must own the file to be able
    to link to it.
   </p><div id="idm140712067077104" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Precedence of Regular File Rules</h6><p>
     Owner conditional rules are considered a subset of regular file rules.
     If a regular file rule overlaps with an owner conditional file rule,
     the rules are merged. Consider the following example.
    </p><div class="verbatim-wrap"><pre class="screen">/foo r,
owner /foo rw,  # or w,</pre></div><p>
     The rules are merged—it results in <code class="literal">r</code> for
     everybody, and <code class="literal">w</code> for the owner only.
    </p></div><div id="idm140712067073728" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     To address everybody <span class="emphasis"><em>but</em></span> the owner of the file,
     use the keyword <code class="literal">other</code>.
    </p><div class="verbatim-wrap"><pre class="screen">owner /foo rw,
other /foo r,</pre></div></div></div><div class="sect2 " id="sec.apparmor.profiles.perm.deny"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.perm.deny"><span class="number">22.7.9 </span><span class="name">Deny Rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.perm.deny">#</a></h3></div></div></div><p>
    Deny rules can be used to annotate or quiet known rejects. The
    profile generating tools will not ask about a known reject treated
    with a deny rule. Such a reject will also not show up in the audit
    logs when denied, keeping the log files lean. If this is not
    desired, put the keyword <code class="literal">audit</code> in front of the
    deny entry.
   </p><p>
    It is also possible to use deny rules in combination with allow rules.
    This allows you to specify a broad allow rule, and then subtract a few
    known files that should not be allowed. Deny rules can also be combined
    with owner rules, to deny files owned by the user. The following example
    allows read/write access to everything in a users directory except write
    access to the <code class="filename">.ssh/</code> files:
   </p><div class="verbatim-wrap"><pre class="screen">deny /home/*/.ssh/** w,
owner /home/*/** rw,</pre></div><p>
    The extensive use of deny rules is generally not encouraged, because it
    makes it much harder to understand what a profile does. However a
    judicious use of deny rules can simplify profiles. Therefore the tools
    only generate profiles denying specific files and will not use
    globbing in deny rules. Manually edit your profiles to add deny rules
    using globbing. Updating such profiles using the tools is safe, because
    the deny entries will not be touched.
   </p></div></div><div class="sect1 " id="sec.apparmor.profiles.exec"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.exec"><span class="number">22.8 </span><span class="name">Execute Modes</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec">#</a></h2></div></div></div><p>
   Execute modes, also named profile transitions, consist of the following
   modes:
  </p><div class="informaltable"><table border="1"><colgroup><col /><col /></colgroup><tbody><tr><td>
       <p>
        <code class="literal">Px</code>
       </p>
      </td><td>
       <p>
        Discrete profile execute mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">Cx</code>
       </p>
      </td><td>
       <p>
        Discrete local profile execute mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">Ux</code>
       </p>
      </td><td>
       <p>
        Unconfined execute mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">ix</code>
       </p>
      </td><td>
       <p>
        Inherit execute mode
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">m</code>
       </p>
      </td><td>
       <p>
        Allow <code class="literal">PROT_EXEC</code> with <code class="command">mmap(2)</code>
        calls
       </p>
      </td></tr></tbody></table></div><div class="sect2 " id="sec.apparmor.profiles.exec.px"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.px"><span class="number">22.8.1 </span><span class="name">Discrete Profile Execute Mode (Px)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.px">#</a></h3></div></div></div><p>
    This mode requires that a discrete security profile is defined for a
    resource executed at an <span class="phrase">AppArmor</span> domain transition. If there is no
    profile defined, the access is denied.
   </p><p>
    Incompatible with <code class="literal">Ux</code>, <code class="literal">ux</code>,
    <code class="literal">px</code>, and <code class="literal">ix</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.cx"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.cx"><span class="number">22.8.2 </span><span class="name">Discrete Local Profile Execute Mode (Cx)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.cx">#</a></h3></div></div></div><p>
    As <code class="literal">Px</code>, but instead of searching the global profile
    set, <code class="literal">Cx</code> only searches the local profiles of the
    current profile. This profile transition provides a way for an
    application to have alternate profiles for helper applications.
   </p><div id="idm140712067040608" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Limitations of the Discrete Local Profile Execute Mode (Cx)</h6><p>
     Currently, Cx transitions are limited to top level profiles and cannot
     be used in hats and children profiles. This restriction will be removed
     in the future.
    </p></div><p>
    Incompatible with <code class="literal">Ux</code>, <code class="literal">ux</code>,
    <code class="literal">Px</code>, <code class="literal">px</code>, <code class="literal">cx</code>, and
    <code class="literal">ix</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.ux"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.ux"><span class="number">22.8.3 </span><span class="name">Unconfined Execute Mode (Ux)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.ux">#</a></h3></div></div></div><p>
    Allows the program to execute the resource without any <span class="phrase">AppArmor</span> profile
    applied to the executed resource. This mode is useful when a confined
    program needs to be able to perform a privileged operation, such as
    rebooting the machine. By placing the privileged section in another
    executable and granting unconfined execution rights, it is possible to
    bypass the mandatory constraints imposed on all confined processes.
    Allowing a root process to go unconfined means it can change <span class="phrase">AppArmor</span>
    policy itself. For more information about what is constrained, see the
    <code class="systemitem">apparmor(7)</code> man page.
   </p><p>
    This mode is incompatible with <code class="literal">ux</code>,
    <code class="literal">px</code>, <code class="literal">Px</code>, and <code class="literal">ix</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.clean"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.clean"><span class="number">22.8.4 </span><span class="name">Unsafe Exec Modes</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.clean">#</a></h3></div></div></div><p>
    Use the lowercase versions of exec modes—<code class="literal">px</code>,
    <code class="literal">cx</code>, <code class="literal">ux</code>—only in very
    special cases. They do not scrub the environment of variables such as
    <code class="envar">LD_PRELOAD</code>. As a result, the calling domain may have an
    undue amount of influence over the called resource. Use these modes only
    if the child absolutely <span class="emphasis"><em>must</em></span> be run unconfined and
    <code class="envar">LD_PRELOAD</code> must be used. Any profile using such modes
    provides negligible security. Use at your own risk.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.ix"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.ix"><span class="number">22.8.5 </span><span class="name">Inherit Execute Mode (ix)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.ix">#</a></h3></div></div></div><p>
    <code class="literal">ix</code> prevents the normal <span class="phrase">AppArmor</span> domain transition on
    <code class="command">execve(2)</code> when the profiled program executes the
    named program. Instead, the executed resource inherits the current
    profile.
   </p><p>
    This mode is useful when a confined program needs to call another
    confined program without gaining the permissions of the target's profile
    or losing the permissions of the current profile. There is no version to
    scrub the environment because <code class="literal">ix</code> executions do not
    change privileges.
   </p><p>
    Incompatible with <code class="literal">cx</code>, <code class="literal">ux</code>, and
    <code class="literal">px</code>. Implies <code class="literal">m</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.m"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.m"><span class="number">22.8.6 </span><span class="name">Allow Executable Mapping (m)</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.m">#</a></h3></div></div></div><p>
    This mode allows a file to be mapped into memory using
    <code class="command">mmap(2)</code>'s <code class="envar">PROT_EXEC</code> flag. This flag
    marks the pages executable. It is used on some architectures to provide
    non executable data pages, which can complicate exploit attempts.
    <span class="phrase">AppArmor</span> uses this mode to limit which files a well-behaved program (or
    all programs on architectures that enforce non executable memory access
    controls) may use as libraries, to limit the effect of invalid
    <code class="option">-L</code> flags given to <code class="command">ld(1)</code> and
    <code class="envar">LD_PRELOAD</code>, <code class="envar">LD_LIBRARY_PATH</code>, given to
    <code class="command">ld.so(8)</code>.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.named"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.named"><span class="number">22.8.7 </span><span class="name">Named Profile Transitions</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.named">#</a></h3></div></div></div><p>
    By default, the <code class="literal">px</code> and <code class="literal">cx</code> (and
    their clean exec variants, too) transition to a profile whose name
    matches the executable name. With named profile transitions, you can
    specify a profile to be transitioned to. This is useful if multiple
    binaries need to share a single profile, or if they need to use a
    different profile than their name would specify. Named profile
    transitions can be used with <code class="literal">cx</code>,
    <code class="literal">Cx</code>, <code class="literal">px</code> and <code class="literal">Px</code>.
    Currently there is a limit of twelve named profile transitions per
    profile.
   </p><p>
    Named profile transitions use <code class="literal">-&gt;</code> to indicate the
    name of the profile that needs to be transitioned to:
   </p><div class="verbatim-wrap"><pre class="screen">/usr/bin/foo
{
  /bin/** px -&gt; shared_profile,
  ...
  /usr/*bash cx -&gt; local_profile,
  ...
  profile local_profile
  {
    ...
  }
}</pre></div><div id="idm140712067005680" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Difference Between Normal and Named Transitions</h6><p>
     When used with globbing, normal transitions provide a <span class="quote">“<span class="quote">one to
     many</span>”</span> relationship—<code class="literal">/bin/** px</code> will
     transition to <code class="filename">/bin/ping</code>,
     <code class="filename">/bin/cat</code>, etc, depending on the program being run.
    </p><p>
     Named transitions provide a <span class="quote">“<span class="quote">many to one</span>”</span>
     relationship—all programs that match the rule regardless of
     their name will transition to the specified profile.
    </p><p>
     Named profile transitions show up in the log as having the mode
     <code class="literal">Nx</code>. The name of the profile to be changed to is
     listed in the <code class="literal">name2</code> field.
    </p></div></div><div class="sect2 " id="sec.apparmor.profiles.exec.fallback"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.fallback"><span class="number">22.8.8 </span><span class="name">Fallback Modes for Profile Transitions</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.fallback">#</a></h3></div></div></div><p>
    The <code class="literal">px</code> and <code class="literal">cx</code> transitions specify
    a hard dependency—if the specified profile does not exist, the
    exec will fail. With the inheritance fallback, the execution will
    succeed but inherit the current profile. To specify inheritance
    fallback, <code class="literal">ix</code> is combined with <code class="literal">cx</code>,
    <code class="literal">Cx</code>, <code class="literal">px</code> and <code class="literal">Px</code>
    into the modes <code class="literal">cix</code>, <code class="literal">Cix</code>,
    <code class="literal">pix</code> and <code class="literal">Pix</code>.
   </p><div class="verbatim-wrap"><pre class="screen">/path Cix -&gt; profile_name,</pre></div><p>
    or
   </p><div class="verbatim-wrap"><pre class="screen">Cix /path -&gt; profile_name,</pre></div><p>
    where <code class="literal">-&gt; profile_name</code> is optional.
   </p><p>
    The same applies if you add the unconfined <code class="literal">ux</code> mode,
    where the resulting modes are <code class="literal">cux</code>,
    <code class="literal">CUx</code>, <code class="literal">pux</code> and
    <code class="literal">PUx</code>. These modes allow falling back to
    <span class="quote">“<span class="quote">unconfined</span>”</span> when the specified profile is not found.
   </p><div class="verbatim-wrap"><pre class="screen">/path PUx -&gt; profile_name,</pre></div><p>
    or
   </p><div class="verbatim-wrap"><pre class="screen">PUx /path -&gt; profile_name,</pre></div><p>
    where <code class="literal">-&gt; profile_name</code> is optional.
   </p><p>
    The fallback modes can be used with named profile transitions, too.
   </p></div><div class="sect2 " id="sec.apparmor.profiles.exec.variables"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.variables"><span class="number">22.8.9 </span><span class="name">Variable Settings in Execution Modes</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.variables">#</a></h3></div></div></div><p>
    When choosing one of the Px, Cx or Ux execution modes, take into account
    that the following environment variables are removed from the
    environment before the child process inherits it. As a consequence,
    applications or processes relying on any of these variables do not work
    anymore if the profile applied to them carries Px, Cx or Ux flags:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      <code class="envar">GCONV_PATH</code>
     </p></li><li class="listitem "><p>
      <code class="envar">GETCONF_DIR</code>
     </p></li><li class="listitem "><p>
      <code class="envar">HOSTALIASES</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_AUDIT</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_DEBUG</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_DEBUG_OUTPUT</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_DYNAMIC_WEAK</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_LIBRARY_PATH</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_ORIGIN_PATH</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_PRELOAD</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_PROFILE</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_SHOW_AUXV</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LD_USE_LOAD_BIAS</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LOCALDOMAIN</code>
     </p></li><li class="listitem "><p>
      <code class="envar">LOCPATH</code>
     </p></li><li class="listitem "><p>
      <code class="envar">MALLOC_TRACE</code>
     </p></li><li class="listitem "><p>
      <code class="envar">NLSPATH</code>
     </p></li><li class="listitem "><p>
      <code class="envar">RESOLV_HOST_CONF</code>
     </p></li><li class="listitem "><p>
      <code class="envar">RES_OPTIONS</code>
     </p></li><li class="listitem "><p>
      <code class="envar">TMPDIR</code>
     </p></li><li class="listitem "><p>
      <code class="envar">TZDIR</code>
     </p></li></ul></div></div><div class="sect2 " id="sec.apparmor.profiles.exec.clean.keywords"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.profiles.exec.clean.keywords"><span class="number">22.8.10 </span><span class="name"><code class="literal">safe</code> and <code class="literal">unsafe</code> Keywords</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.exec.clean.keywords">#</a></h3></div></div></div><p>
    You can use the <code class="literal">safe</code> and <code class="literal">unsafe</code>
    keywords for rules instead of using the case modifier of execution
    modes. For example
   </p><div class="verbatim-wrap"><pre class="screen">/example_rule Px,</pre></div><p>
    is the same as any of the following
   </p><div class="verbatim-wrap"><pre class="screen">safe /example_rule px,
safe /example_rule Px,
safe px /example_rule,
safe Px /example_rule,</pre></div><p>
    and the rule
   </p><div class="verbatim-wrap"><pre class="screen">/example_rule px,</pre></div><p>
    is the same as any of
   </p><div class="verbatim-wrap"><pre class="screen">unsafe /example_rule px,
unsafe /example_rule Px,
unsafe px /example_rule,
unsafe Px /example_rule,</pre></div><p>
    The <code class="literal">safe</code>/<code class="literal">unsafe</code> keywords are
    mutually exclusive and can be used in a file rule after the
    <code class="literal">owner</code> keyword, so the order of rule keywords is
   </p><div class="verbatim-wrap"><pre class="screen">[audit] [deny] [owner] [safe|unsafe] file_rule</pre></div></div></div><div class="sect1 " id="sec.apparmor.profiles.rlimit"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.rlimit"><span class="number">22.9 </span><span class="name">Resource Limit Control</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.rlimit">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> can set and control an application's resource
   limits (rlimits, also known as ulimits). By default, <span class="phrase">AppArmor</span> does not
   control application's rlimits, and it will only control those limits
   specified in the confining profile. For more information about resource
   limits, refer to the <code class="systemitem">setrlimit(2)</code>,
   <code class="systemitem">ulimit(1)</code>, or <code class="systemitem">ulimit(3)</code>
   man pages.
  </p><p>
   <span class="phrase">AppArmor</span> leverages the system's rlimits and as such does not provide an
   additional auditing that would normally occur. It also cannot raise
   rlimits set by the system, <span class="phrase">AppArmor</span> rlimits can only reduce an
   application's current resource limits.
  </p><p>
   The values will be inherited by the children of a process and will remain
   even if a new profile is transitioned to or the application becomes
   unconfined. So when an application transitions to a new profile, that
   profile can further reduce the application's rlimits.
  </p><p>
   <span class="phrase">AppArmor</span>'s rlimit rules will also provide mediation of setting an
   application's hard limits, should it try to raise them. The application
   cannot raise its hard limits any further than specified in
   the profile. The mediation of raising hard limits is not inherited as the
   set value is, so that when the application transitions to a new profile
   it is free to raise its limits as specified in the profile.
  </p><p>
   <span class="phrase">AppArmor</span>'s rlimit control does not affect an application's soft limits
   beyond ensuring that they are less than or equal to the application's
   hard limits.
  </p><p>
   <span class="phrase">AppArmor</span>'s hard limit rules have the general form of:
  </p><div class="verbatim-wrap"><pre class="screen">set rlimit <em class="replaceable ">RESOURCE</em> &lt;= <em class="replaceable ">value</em>,</pre></div><p>
   where <em class="replaceable ">RESOURCE</em> and
   <em class="replaceable ">VALUE</em> are to be replaced with the following
   values:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066931200"><span class="term "><code class="literal">cpu</code>
    </span></dt><dd><p>
      CPU time limit in seconds.
     </p></dd><dt id="idm140712066929152"><span class="term "><code class="literal">fsize</code>, <code class="literal">data</code>, <code class="literal">stack</code>,
      <code class="literal">core</code>, <code class="literal">rss</code>, <code class="literal">as</code>,
      <code class="literal">memlock</code>, <code class="literal">msgqueue</code>
    </span></dt><dd><p>
      a number in bytes, or a number with a suffix where the suffix can be
      K/KB (kilobytes), M/MB (megabytes), G/GB (gigabytes), for example
     </p><div class="verbatim-wrap"><pre class="screen">rlimit data &lt;= 100M,</pre></div></dd><dt id="idm140712066923344"><span class="term "><code class="literal">fsize</code>, <code class="literal">nofile</code>, <code class="literal">locks</code>,
      <code class="literal">sigpending</code>, <code class="literal">nproc</code><sup>*</sup>,
      <code class="literal">rtprio</code>
    </span></dt><dd><p>
      a number greater or equal to 0
     </p></dd><dt id="idm140712066918704"><span class="term "><code class="literal">nice</code>
    </span></dt><dd><p>
      a value between -20 and 19
     </p></dd></dl></div><p>
   <sup>*</sup>The nproc rlimit is handled different than
   all the other rlimits. Instead of indicating the standard process rlimit
   it controls the maximum number of processes that can be running under the
   profile at any time. When the limit is exceeded the creation of new
   processes under the profile will fail until the number of currently
   running processes is reduced.
  </p><div id="idm140712066915200" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
    Currently the tools cannot be used to add rlimit rules to profiles. The
    only way to add rlimit controls to a profile is to manually edit the
    profile with a text editor. The tools will still work with profiles
    containing rlimit rules and will not remove them, so it is safe to use
    the tools to update profiles containing them.
   </p></div></div><div class="sect1 " id="sec.apparmor.profiles.audit"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.profiles.audit"><span class="number">22.10 </span><span class="name">Auditing Rules</span> <a title="Permalink" class="permalink" href="#sec.apparmor.profiles.audit">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> provides the ability to audit given rules so that when they are
   matched an audit message will appear in the audit log. To enable audit
   messages for a given rule, the <code class="literal">audit</code> keyword is
   put in front of the rule:
  </p><div class="verbatim-wrap"><pre class="screen">audit /etc/foo/*        rw,</pre></div><p>
   If it is desirable to audit only a given permission the rule can be split
   into two rules. The following example will result in audit messages when
   files are opened for writing, but not when they are opened for reading:
  </p><div class="verbatim-wrap"><pre class="screen">audit /etc/foo/*  w,
/etc/foo/*        r,</pre></div><div id="idm140712066909536" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
    Audit messages are not generated for every read or write of a file but
    only when a file is opened for reading or writing.
   </p></div><p>
   Audit control can be combined with
   <code class="literal">owner</code>/<code class="literal">other</code> conditional file rules
   to provide auditing when users access files they own/do not own:
  </p><div class="verbatim-wrap"><pre class="screen">audit owner /home/*/.ssh/**       rw,
audit other /home/*/.ssh/**       r,</pre></div></div></div><div class="chapter " id="cha.apparmor.repos"><div class="titlepage"><div><div><h2 class="title"><span class="number">23 </span><span class="name"><span class="phrase">AppArmor</span> Profile Repositories</span> <a title="Permalink" class="permalink" href="#cha.apparmor.repos">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_repositories.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.repos</li></ul></div></div></div></div><div class="line"></div><p>
  <span class="phrase">AppArmor</span> ships with a set of profiles enabled by default. These are created
  by the <span class="phrase">AppArmor</span> developers, and are stored in
  <code class="filename">/etc/apparmor.d</code>. In addition to these profiles,

  <span class="productname"><span class="phrase">openSUSE Leap</span></span> ships profiles for individual applications together with
  the relevant application. These profiles are not enabled by default, and
  reside under another directory than the standard <span class="phrase">AppArmor</span> profiles,
  <code class="filename">/etc/apparmor/profiles/extras</code>.
 </p><p>
   The <span class="phrase">AppArmor</span> tools (YaST, <code class="command">aa-genprof</code> and
   <code class="command">aa-logprof</code>) support the use of a local repository.
   Whenever you start to create a new profile from scratch, and there
   already is an inactive profile in your local repository, you are asked
   whether you want to use the existing inactive one from
   <code class="filename">/etc/apparmor/profiles/extras</code> and whether you want
   to base your efforts on it. If you decide to use this profile, it gets
   copied over to the directory of profiles enabled by default
   (<code class="filename">/etc/apparmor.d</code>) and loaded whenever <span class="phrase">AppArmor</span> is
   started. Any further adjustments will be done to the active profile under
   <code class="filename">/etc/apparmor.d</code>.
  </p></div><div class="chapter " id="cha.apparmor.yast"><div class="titlepage"><div><div><h2 class="title"><span class="number">24 </span><span class="name">Building and Managing Profiles with YaST</span> <a title="Permalink" class="permalink" href="#cha.apparmor.yast">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_profiles_yast.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.yast</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.yast.add"><span class="number">24.1 </span><span class="name">Manually Adding a Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.edit"><span class="number">24.2 </span><span class="name">Editing Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.del"><span class="number">24.3 </span><span class="name">Deleting a Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.yast.manage"><span class="number">24.4 </span><span class="name">Managing <span class="phrase">AppArmor</span></span></a></span></dt></dl></div></div><p>
  YaST provides a basic way to build profiles and manage <span class="phrase">AppArmor®</span>
  profiles. It provides two interfaces: a graphical one and a text-based
  one. The text-based interface consumes less resources and bandwidth,
  making it a better choice for remote administration, or for times when a
  local graphical environment is inconvenient. Although the interfaces have
  differing appearances, they offer the same functionality in similar ways.
  Another alternative is to use <span class="phrase">AppArmor</span> commands, which can control <span class="phrase">AppArmor</span>
  from a terminal window or through remote connections. The command line
  tools are described in <a class="xref" href="#cha.apparmor.commandline" title="Chapter 25. Building Profiles from the Command Line">Chapter 25, <em>Building Profiles from the Command Line</em></a>.
 </p><p>
  Start YaST from the main menu and enter your <code class="systemitem">root</code> password
  when prompted for it. Alternatively, start YaST by opening a terminal
  window, logging in as <code class="systemitem">root</code>, and entering <code class="command">yast2</code>
  for the graphical mode or <code class="command">yast</code> for the text-based mode.
 </p><p>
  In the <span class="guimenu">Security and Users</span> section, there is an
  <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span> icon. Click it to launch the
  <span class="phrase">AppArmor</span> YaST module.
 </p><div class="sect1 " id="sec.apparmor.yast.add"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.yast.add"><span class="number">24.1 </span><span class="name">Manually Adding a Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.add">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> enables you to create an <span class="phrase">AppArmor</span> profile by manually adding
   entries into the profile. Select the application for which to create a
   profile, then add entries.
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
     click <span class="guimenu">Manually Add Profile</span> in the main window.
    </p></li><li class="step "><p>
     Browse your system to find the application for which to create a
     profile.
    </p></li><li class="step "><p>
     When you find the application, select it and click
     <span class="guimenu">Open</span>. A basic, empty profile appears in the
     <span class="guimenu"><span class="phrase">AppArmor</span> Profile Dialog</span> window.
    </p></li><li class="step "><p>
     In <span class="guimenu"><span class="phrase">AppArmor</span> Profile Dialog</span>, add, edit, or delete
     <span class="phrase">AppArmor</span> profile entries by clicking the corresponding buttons and
     referring to
     <a class="xref" href="#sec.apparmor.yast.edit.add" title="24.2.1. Adding an Entry">Section 24.2.1, “Adding an Entry”</a>,
     <a class="xref" href="#sec.apparmor.yast.edit.edit" title="24.2.2. Editing an Entry">Section 24.2.2, “Editing an Entry”</a>,
     or
     <a class="xref" href="#sec.apparmor.yast.edit.del" title="24.2.3. Deleting an Entry">Section 24.2.3, “Deleting an Entry”</a>.
    </p></li><li class="step "><p>
     When finished, click <span class="guimenu">Done</span>.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.apparmor.yast.edit"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.yast.edit"><span class="number">24.2 </span><span class="name">Editing Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.edit">#</a></h2></div></div></div><div id="idm140712066865984" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
    YaST offers basic manipulation for <span class="phrase">AppArmor</span> profiles, such
    as creating or editing. However, the most straightforward way
    to edit an <span class="phrase">AppArmor</span>
    profile is to use a text editor such as <code class="command">vi</code>:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> vi /etc/apparmor.d/usr.sbin.httpd2-prefork</pre></div></div><div id="idm140712066862544" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
    The <code class="command">vi</code> editor also includes syntax (error)
    highlighting and syntax error highlighting, which visually warns you
    when the syntax of the edited <span class="phrase">AppArmor</span> profile is wrong.
   </p></div><p>
   <span class="phrase">AppArmor</span> enables you to edit <span class="phrase">AppArmor</span> profiles manually by adding, editing,
   or deleting entries. To edit a profile, proceed as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
     click <span class="guimenu">Manage Existing Profiles</span> in the main window.
    </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/edit_1.png"><img src="images/edit_1.png" width="" alt="Choose the profile to edit" /></a></div></div></li><li class="step "><p>
     From the list of profiled applications, select the profile to edit.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Edit</span>. The <span class="guimenu"><span class="phrase">AppArmor</span> Profile
     Dialog</span> window displays the profile.
    </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/edit_2.png"><img src="images/edit_2.png" width="" alt="AppArmor profile dialog" /></a></div></div></li><li class="step "><p>
     In the <span class="guimenu"><span class="phrase">AppArmor</span> Profile Dialog</span> window, add, edit, or
     delete <span class="phrase">AppArmor</span> profile entries by clicking the corresponding buttons
     and referring to
     <a class="xref" href="#sec.apparmor.yast.edit.add" title="24.2.1. Adding an Entry">Section 24.2.1, “Adding an Entry”</a>,
     <a class="xref" href="#sec.apparmor.yast.edit.edit" title="24.2.2. Editing an Entry">Section 24.2.2, “Editing an Entry”</a>,
     or
     <a class="xref" href="#sec.apparmor.yast.edit.del" title="24.2.3. Deleting an Entry">Section 24.2.3, “Deleting an Entry”</a>.
    </p></li><li class="step "><p>
     When you are finished, click <span class="guimenu">Done</span>.
    </p></li><li class="step "><p>
     In the pop-up that appears, click <span class="guimenu">Yes</span> to confirm
     your changes to the profile and reload the <span class="phrase">AppArmor</span> profile set.
    </p></li></ol></div></div><div id="idm140712066834752" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Syntax Checking in <span class="phrase">AppArmor</span></h6><p>
    <span class="phrase">AppArmor</span> contains a syntax check that notifies you of any syntax errors
    in profiles you are trying to process with the YaST <span class="phrase">AppArmor</span> tools.
    If an error occurs, edit the profile manually as <code class="systemitem">root</code> and
    reload the profile set with <code class="command">systemctl reload
    apparmor</code>.
   </p></div><div class="sect2 " id="sec.apparmor.yast.edit.add"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.yast.edit.add"><span class="number">24.2.1 </span><span class="name">Adding an Entry</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.edit.add">#</a></h3></div></div></div><p>
    The <span class="guimenu">Add Entry</span> button in the <span class="guimenu"><span class="phrase">AppArmor</span> Profile
    Window</span> lists types of entries you can add to the
    <span class="phrase">AppArmor</span> profile.
   </p><p>
    From the list, select one of the following:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066826736"><span class="term ">File</span></dt><dd><p>
       In the pop-up window, specify the absolute path of a file, including
       the type of access permitted. When finished, click
       <span class="guimenu">OK</span>.
      </p><p>
       You can use globbing if necessary. For globbing information, refer to
       <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>.
       For file access permission information, refer to
       <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
      </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/add_2_addentry_file.png"><img src="images/add_2_addentry_file.png" width="" alt="Select a file to add" /></a></div></div></dd><dt id="idm140712066816608"><span class="term ">Directory</span></dt><dd><p>
       In the pop-up window, specify the absolute path of a directory,
       including the type of access permitted. You can use globbing if
       necessary. When finished, click <span class="guimenu">OK</span>.
      </p><p>
       For globbing information, refer to
       <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>.
       For file access permission information, refer to
       <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
      </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/add_2_addentry_file.png"><img src="images/add_2_addentry_file.png" width="" alt="Select a directory to add" /></a></div></div></dd><dt id="idm140712066806416"><span class="term ">Network Rule</span></dt><dd><p>
       In the pop-up window, select the appropriate network family and the
       socket type. For more information, refer to
       <a class="xref" href="#sec.apparmor.profiles.nac" title="22.5. Network Access Control">Section 22.5, “Network Access Control”</a>.
      </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/add_2_addentry_network.png"><img src="images/add_2_addentry_network.png" width="" alt="Select capabilities" /></a></div></div></dd><dt id="idm140712066798080"><span class="term ">Capability</span></dt><dd><p>
       In the pop-up window, select the appropriate capabilities. These are
       statements that enable each of the 32 POSIX.1e capabilities. Refer to
       <a class="xref" href="#sec.apparmor.profiles.capabilities" title="22.4. Capability Entries (POSIX.1e)">Section 22.4, “Capability Entries (POSIX.1e)”</a>
       for more information about capabilities. When finished making your
       selections, click <span class="guimenu">OK</span>.
      </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/add_2_addentry_capability.png"><img src="images/add_2_addentry_capability.png" width="" alt="Select capabilities" /></a></div></div></dd><dt id="idm140712066789456"><span class="term ">Include File</span></dt><dd><p>
       In the pop-up window, browse to the files to use as includes.
       Includes are directives that pull in components of other <span class="phrase">AppArmor</span>
       profiles to simplify profiles. For more information, refer to
       <a class="xref" href="#sec.apparmor.profiles.includes" title="22.3. Include Statements">Section 22.3, “Include Statements”</a>.
      </p></dd><dt id="idm140712066786192"><span class="term ">Hat</span></dt><dd><p>
       In the pop-up window, specify the name of the subprofile
       (<span class="emphasis"><em>hat</em></span>) to add to your current profile and click
       <span class="guimenu">Create Hat</span>. For more information, refer to
       <a class="xref" href="#cha.apparmor.hat" title="Chapter 26. Profiling Your Web Applications Using ChangeHat">Chapter 26, <em>Profiling Your Web Applications Using ChangeHat</em></a>.
      </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/add_2_addentry_hat.png"><img src="images/add_2_addentry_hat.png" width="" /></a></div></div></dd></dl></div></div><div class="sect2 " id="sec.apparmor.yast.edit.edit"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.yast.edit.edit"><span class="number">24.2.2 </span><span class="name">Editing an Entry</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.edit.edit">#</a></h3></div></div></div><p>
    When you select <span class="guimenu">Edit Entry</span>, a pop-up window opens.
    From here, edit the selected entry.
   </p><p>
    In the pop-up window, edit the entry you need to modify. You can use
    globbing if necessary. When finished, click <span class="guimenu">OK</span>.
   </p><p>
    For globbing information, refer to
    <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>. For access permission
    information, refer to <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
   </p></div><div class="sect2 " id="sec.apparmor.yast.edit.del"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.yast.edit.del"><span class="number">24.2.3 </span><span class="name">Deleting an Entry</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.edit.del">#</a></h3></div></div></div><p>
    To delete an entry in a given profile, select <span class="guimenu">Delete
    Entry</span>. <span class="phrase">AppArmor</span> removes the selected profile entry.
   </p></div></div><div class="sect1 " id="sec.apparmor.yast.del"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.yast.del"><span class="number">24.3 </span><span class="name">Deleting a Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.del">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> enables you to delete an <span class="phrase">AppArmor</span> profile manually. Simply select
   the application for which to delete a profile then delete it as follows:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
     click <span class="guimenu">Manage Existing Profiles</span> in the main window.
    </p></li><li class="step "><p>
     Select the profile to delete.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Delete</span>.
    </p></li><li class="step "><p>
     In the pop-up that opens, click <span class="guimenu">Yes</span> to delete the
     profile and reload the <span class="phrase">AppArmor</span> profile set.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.apparmor.yast.manage"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.yast.manage"><span class="number">24.4 </span><span class="name">Managing <span class="phrase">AppArmor</span></span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.manage">#</a></h2></div></div></div><p>
   You can change the status of <span class="phrase">AppArmor</span> by enabling or disabling it.
   Enabling <span class="phrase">AppArmor</span> protects your system from potential program
   exploitation. Disabling <span class="phrase">AppArmor</span>, even if your profiles have been set up,
   removes protection from your system. To change the status of <span class="phrase">AppArmor</span>,
   start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
   click <span class="guimenu">Settings</span> in the main window.
  </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/sd_controlpanel_1.png"><img src="images/sd_controlpanel_1.png" width="" alt="The AppArmor control panel" /></a></div></div><p>
   To change the status of <span class="phrase">AppArmor</span>, continue as described in
   <a class="xref" href="#sec.apparmor.yast.manage.status" title="24.4.1. Changing AppArmor Status">Section 24.4.1, “Changing <span class="phrase">AppArmor</span> Status”</a>.
   To change the mode of individual profiles, continue as described in
   <a class="xref" href="#sec.apparmor.yast.manage.profmodes" title="24.4.2. Changing the Mode of Individual Profiles">Section 24.4.2, “Changing the Mode of Individual Profiles”</a>.
  </p><div class="sect2 " id="sec.apparmor.yast.manage.status"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.yast.manage.status"><span class="number">24.4.1 </span><span class="name">Changing <span class="phrase">AppArmor</span> Status</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.manage.status">#</a></h3></div></div></div><p>
    When you change the status of <span class="phrase">AppArmor</span>, set it to enabled or disabled.
    When <span class="phrase">AppArmor</span> is enabled, it is installed, running, and enforcing the
    <span class="phrase">AppArmor</span> security policies.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
      click <span class="guimenu">Settings</span> in the main window.
     </p></li><li class="step "><p>
      Enable <span class="phrase">AppArmor</span> by checking <span class="guimenu">Enable <span class="phrase">AppArmor</span></span> or
      disable <span class="phrase">AppArmor</span> by deselecting it.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Done</span> in the <span class="guimenu"><span class="phrase">AppArmor</span>
      Configuration</span> window.
     </p></li></ol></div></div><div id="idm140712066736704" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
     You always need to restart running programs to apply the profiles to
     them.
    </p></div></div><div class="sect2 " id="sec.apparmor.yast.manage.profmodes"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.yast.manage.profmodes"><span class="number">24.4.2 </span><span class="name">Changing the Mode of Individual Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.yast.manage.profmodes">#</a></h3></div></div></div><p>
    <span class="phrase">AppArmor</span> can apply profiles in two different modes. In
    <span class="emphasis"><em>complain</em></span> mode, violations of <span class="phrase">AppArmor</span> profile rules,
    such as the profiled program accessing files not permitted by the
    profile, are detected. The violations are permitted, but also logged.
    This mode is convenient for developing profiles and is used by the
    <span class="phrase">AppArmor</span> tools for generating profiles. Loading a profile in
    <span class="emphasis"><em>enforce</em></span> mode enforces the policy defined in the
    profile, and reports policy violation attempts to
    <code class="systemitem">rsyslogd</code> (or
    <code class="systemitem">auditd</code> or
    <code class="systemitem">journalctl</code>, depending on system
    configuration).
   </p><p>
    The <span class="guimenu">Profile Mode Configuration</span> dialog allows you to
    view and edit the mode of currently loaded <span class="phrase">AppArmor</span> profiles. This
    feature is useful for determining the status of your system during
    profile development. During systemic profiling (see
    <a class="xref" href="#sec.apparmor.commandline.profiling.systemic" title="25.7.2. Systemic Profiling">Section 25.7.2, “Systemic Profiling”</a>), you can
    use this tool to adjust and monitor the scope of the profiles for which
    you are learning behavior.
   </p><p>
    To edit an application's profile mode, proceed as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Start YaST, select <span class="guimenu"><span class="phrase">AppArmor</span> Configuration</span>, and
      click <span class="guimenu">Settings</span> in the main window.
     </p></li><li class="step "><p>
      In the <span class="guimenu">Configure Profile Modes</span> section, select
      <span class="guimenu">Configure</span>.
     </p></li><li class="step "><p>
      Select the profile for which to change the mode.
     </p></li><li class="step "><p>
      Select <span class="guimenu">Toggle Mode</span> to set this profile to
      <span class="emphasis"><em>complain</em></span> mode or to <span class="emphasis"><em>enforce</em></span>
      mode.
     </p></li><li class="step "><p>
      Apply your settings and leave YaST with <span class="guimenu">Done</span>.
     </p></li></ol></div></div><p>
    To change the mode of all profiles, use <span class="guimenu">Set All to
    Enforce</span> or <span class="guimenu">Set All to Complain</span>.
   </p><div id="idm140712066716032" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Listing the Profiles Available</h6><p>
     By default, only active profiles are listed (any profile that has a
     matching application installed on your system). To set up a profile
     before installing the respective application, click <span class="guimenu">Show All
     Profiles</span> and select the profile to configure from the list
     that appears.
    </p></div></div></div></div><div class="chapter " id="cha.apparmor.commandline"><div class="titlepage"><div><div><h2 class="title"><span class="number">25 </span><span class="name">Building Profiles from the Command Line</span> <a title="Permalink" class="permalink" href="#cha.apparmor.commandline">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_profiles_man.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.commandline</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.commandline.status"><span class="number">25.1 </span><span class="name">Checking the <span class="phrase">AppArmor</span> Status</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.build"><span class="number">25.2 </span><span class="name">Building <span class="phrase">AppArmor</span> Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.add"><span class="number">25.3 </span><span class="name">Adding or Creating an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.edit"><span class="number">25.4 </span><span class="name">Editing an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.unload"><span class="number">25.5 </span><span class="name">Unloading Unknown <span class="phrase">AppArmor</span> Profiles</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.del"><span class="number">25.6 </span><span class="name">Deleting an <span class="phrase">AppArmor</span> Profile</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.profiling"><span class="number">25.7 </span><span class="name">Two Methods of Profiling</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.commandline.filenames"><span class="number">25.8 </span><span class="name">Important File Names and Directories</span></a></span></dt></dl></div></div><p>
  <span class="phrase">AppArmor®</span> provides the user the ability to use a command line interface
  rather than a graphical interface to manage and configure the system
  security. Track the status of <span class="phrase">AppArmor</span> and create, delete, or modify
  <span class="phrase">AppArmor</span> profiles using the <span class="phrase">AppArmor</span> command line tools.
 </p><div id="idm140712066706896" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Background Information</h6><p>
   Before starting to manage your profiles using the <span class="phrase">AppArmor</span> command line
   tools, check out the general introduction to <span class="phrase">AppArmor</span> given in
   <a class="xref" href="#cha.apparmor.concept" title="Chapter 21. Immunizing Programs">Chapter 21, <em>Immunizing Programs</em></a> and
   <a class="xref" href="#cha.apparmor.profiles" title="Chapter 22. Profile Components and Syntax">Chapter 22, <em>Profile Components and Syntax</em></a>.
  </p></div><div class="sect1 " id="sec.apparmor.commandline.status"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.status"><span class="number">25.1 </span><span class="name">Checking the <span class="phrase">AppArmor</span> Status</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.status">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> can be in any one of three states:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066700608"><span class="term ">Unloaded</span></dt><dd><p>
      <span class="phrase">AppArmor</span> is not activated in the kernel.
     </p></dd><dt id="idm140712066698352"><span class="term ">Running</span></dt><dd><p>
      <span class="phrase">AppArmor</span> is activated in the kernel and is enforcing <span class="phrase">AppArmor</span> program
      policies.
     </p></dd><dt id="idm140712066695616"><span class="term ">Stopped</span></dt><dd><p>
      <span class="phrase">AppArmor</span> is activated in the kernel, but no policies are enforced.
     </p></dd></dl></div><p>
   Detect the state of <span class="phrase">AppArmor</span> by inspecting
   <code class="filename">/sys/kernel/security/apparmor/profiles</code>. If
   <code class="command">cat /sys/kernel/security/apparmor/profiles</code> reports a
   list of profiles, <span class="phrase">AppArmor</span> is running. If it is empty and returns nothing,
   <span class="phrase">AppArmor</span> is stopped. If the file does not exist, <span class="phrase">AppArmor</span> is unloaded.
  </p><p>
   Manage <span class="phrase">AppArmor</span> with <code class="command">systemctl</code>. It lets you perform the
   following operations:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066688224"><span class="term "><code class="command">sudo systemctl start apparmor</code>
    </span></dt><dd><p>
      Behavior depends on the state of <span class="phrase">AppArmor</span>. If it is not activated,
      <code class="option">start</code> activates and starts it, putting it in the
      running state. If it is stopped, <code class="option">start</code> causes the
      re-scan of <span class="phrase">AppArmor</span> profiles usually found in
      <code class="filename">/etc/apparmor.d</code> and puts <span class="phrase">AppArmor</span> in the running
      state. If <span class="phrase">AppArmor</span> is already running, <code class="option">start</code> reports a
      warning and takes no action.
     </p><div id="idm140712066682672" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Already Running Processes</h6><p>
       Already running processes need to be restarted to apply the <span class="phrase">AppArmor</span>
       profiles on them.
      </p></div></dd><dt id="idm140712066680480"><span class="term "><code class="command">sudo systemctl stop apparmor</code>
    </span></dt><dd><p>
      Stops <span class="phrase">AppArmor</span> if it is running by removing all profiles from kernel
      memory, effectively disabling all access controls, and putting <span class="phrase">AppArmor</span>
      into the stopped state. If the <span class="phrase">AppArmor</span> is already stopped,
      <code class="option">stop</code> tries to unload the profiles again, but nothing
      happens.
     </p></dd><dt id="idm140712066676400"><span class="term "><code class="command">sudo systemctl reload apparmor</code>
    </span></dt><dd><p>
      Causes the <span class="phrase">AppArmor</span> module to re-scan the profiles in
      <code class="filename">/etc/apparmor.d</code> without unconfining running
      
      processes. Freshly created profiles are enforced and recently deleted
      ones are removed from the <code class="filename">/etc/apparmor.d</code>
      directory.
     </p></dd></dl></div></div><div class="sect1 " id="sec.apparmor.commandline.build"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.build"><span class="number">25.2 </span><span class="name">Building <span class="phrase">AppArmor</span> Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.build">#</a></h2></div></div></div><p>
   The <span class="phrase">AppArmor</span> module profile definitions are stored in the
   <code class="filename">/etc/apparmor.d</code> directory as plain text files. For a
   detailed description of the syntax of these files, refer to
   <a class="xref" href="#cha.apparmor.profiles" title="Chapter 22. Profile Components and Syntax">Chapter 22, <em>Profile Components and Syntax</em></a>.
  </p><p>
   All files in the <code class="filename">/etc/apparmor.d</code> directory are
   interpreted as profiles and are loaded as such. Renaming files in that
   directory is not an effective way of preventing profiles from being
   loaded. You must remove profiles from this directory to prevent them from
   being read and evaluated effectively, or call
   <code class="command">aa-disable</code> on the profile, which will create a
   symbolic link in <code class="filename">/etc/apparmor.d/disabled/</code>.
  </p><p>
   You can use a text editor, such as <code class="command">vi</code>, to access and
   make changes to these profiles. The following sections contain detailed
   steps for building profiles:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066664768"><span class="term ">Adding or Creating <span class="phrase">AppArmor</span> Profiles</span></dt><dd><p>
      Refer to <a class="xref" href="#sec.apparmor.commandline.add" title="25.3. Adding or Creating an AppArmor Profile">Section 25.3, “Adding or Creating an <span class="phrase">AppArmor</span> Profile”</a>
     </p></dd><dt id="idm140712066661952"><span class="term ">Editing <span class="phrase">AppArmor</span> Profiles</span></dt><dd><p>
      Refer to <a class="xref" href="#sec.apparmor.commandline.edit" title="25.4. Editing an AppArmor Profile">Section 25.4, “Editing an <span class="phrase">AppArmor</span> Profile”</a>
     </p></dd><dt id="idm140712066659136"><span class="term ">Deleting <span class="phrase">AppArmor</span> Profiles</span></dt><dd><p>
      Refer to
      <a class="xref" href="#sec.apparmor.commandline.del" title="25.6. Deleting an AppArmor Profile">Section 25.6, “Deleting an <span class="phrase">AppArmor</span> Profile”</a>
     </p></dd></dl></div></div><div class="sect1 " id="sec.apparmor.commandline.add"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.add"><span class="number">25.3 </span><span class="name">Adding or Creating an <span class="phrase">AppArmor</span> Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.add">#</a></h2></div></div></div><p>
   To add or create an <span class="phrase">AppArmor</span> profile for an application, you can use a
   systemic or stand-alone profiling method, depending on your needs. Learn
   more about these two approaches in
   <a class="xref" href="#sec.apparmor.commandline.profiling" title="25.7. Two Methods of Profiling">Section 25.7, “Two Methods of Profiling”</a>.
  </p></div><div class="sect1 " id="sec.apparmor.commandline.edit"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.edit"><span class="number">25.4 </span><span class="name">Editing an <span class="phrase">AppArmor</span> Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.edit">#</a></h2></div></div></div><p>
   The following steps describe the procedure for editing an <span class="phrase">AppArmor</span>
   profile:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     If you are not currently logged in as <code class="systemitem">root</code>, enter
     <code class="command">su</code> in a terminal window.
    </p></li><li class="step "><p>
     Enter the <code class="systemitem">root</code> password when prompted.
    </p></li><li class="step "><p>
     Go to the profile directory with <code class="command">cd
     /etc/apparmor.d/</code>.
    </p></li><li class="step "><p>
     Enter <code class="command">ls</code> to view all profiles currently installed.
    </p></li><li class="step "><p>
     Open the profile to edit in a text editor, such as vim.
    </p></li><li class="step "><p>
     Make the necessary changes, then save the profile.
    </p></li><li class="step "><p>
     Restart <span class="phrase">AppArmor</span> by entering <code class="command">systemctl reload
     apparmor</code> in a terminal window.
    </p></li></ol></div></div></div><div class="sect1 " id="sec.apparmor.commandline.unload"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.unload"><span class="number">25.5 </span><span class="name">Unloading Unknown <span class="phrase">AppArmor</span> Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.unload">#</a></h2></div></div></div><div id="idm140712066637376" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Danger of Unloading Wanted Profiles</h6><p>
    <code class="command">aa-remove-unkown</code> will unload all profiles that
    are not stored in <code class="filename">/etc/apparmor.d</code>, for example
    automatically generated LXD profiles. This may compromise the
    security of the system. Use the <code class="option">-n</code> parameter to
    list all profiles that will be unloaded.
   </p></div><p>
   To unload all profiles that are not longer in
   <code class="filename">/etc/apparmor.d/</code> <span class="phrase">AppArmor</span> profiles, run:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aa-remove-unknown</code></pre></div><p>
   You can print a list of profiles that will be removed:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aa-remove-unknown -n</code></pre></div></div><div class="sect1 " id="sec.apparmor.commandline.del"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.del"><span class="number">25.6 </span><span class="name">Deleting an <span class="phrase">AppArmor</span> Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.del">#</a></h2></div></div></div><p>
   The following steps describe the procedure for deleting an <span class="phrase">AppArmor</span>
   profile.
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Remove the <span class="phrase">AppArmor</span> definition from the kernel:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">apparmor_parser -R /etc/apparmor.d/<em class="replaceable ">PROFILE</em></code></pre></div></li><li class="step "><p>
     Remove the definition file:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">rm /etc/apparmor.d/<em class="replaceable ">PROFILE</em></code>
    <code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">rm /var/lib/apparmor/cache/<em class="replaceable ">PROFILE</em></code></pre></div></li></ol></div></div></div><div class="sect1 " id="sec.apparmor.commandline.profiling"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.profiling"><span class="number">25.7 </span><span class="name">Two Methods of Profiling</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling">#</a></h2></div></div></div><p>
   Given the syntax for <span class="phrase">AppArmor</span> profiles in
   <a class="xref" href="#cha.apparmor.profiles" title="Chapter 22. Profile Components and Syntax">Chapter 22, <em>Profile Components and Syntax</em></a>, you
   could create profiles without using the tools. However, the effort
   involved would be substantial. To avoid such a situation, use the <span class="phrase">AppArmor</span>
   tools to automate the creation and refinement of profiles.
  </p><p>
   There are two ways to approach <span class="phrase">AppArmor</span> profile creation. Tools are
   available for both methods.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066614944"><span class="term ">Stand-Alone Profiling</span></dt><dd><p>
      A method suitable for profiling small applications that have a finite
      runtime, such as user client applications like mail clients. For more
      information, refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.stand-alone" title="25.7.1. Stand-Alone Profiling">Section 25.7.1, “Stand-Alone Profiling”</a>.
     </p></dd><dt id="idm140712066612384"><span class="term ">Systemic Profiling</span></dt><dd><p>
      A method suitable for profiling many programs at once
      and for profiling applications that may run for days, weeks, or
      continuously across reboots, such as network server applications like
      Web servers and mail servers. For more information, refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.systemic" title="25.7.2. Systemic Profiling">Section 25.7.2, “Systemic Profiling”</a>.
     </p></dd></dl></div><p>
   Automated profile development becomes more manageable with the <span class="phrase">AppArmor</span>
   tools:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Decide which profiling method suits your needs.
    </p></li><li class="step "><p>
     Perform a static analysis. Run either <code class="command">aa-genprof</code> or
     <code class="command">aa-autodep</code>, depending on the profiling method
     chosen.
    </p></li><li class="step "><p>
     Enable dynamic learning. Activate learning mode for all profiled
     programs.
    </p></li></ol></div></div><div class="sect2 " id="sec.apparmor.commandline.profiling.stand-alone"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.commandline.profiling.stand-alone"><span class="number">25.7.1 </span><span class="name">Stand-Alone Profiling</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.stand-alone">#</a></h3></div></div></div><p>
    Stand-alone profile generation and improvement is managed by a program
    called <code class="command">aa-genprof</code>. This method is easy because
    <code class="command">aa-genprof</code> takes care of everything, but is limited
    because it requires <code class="command">aa-genprof</code> to run for the entire
    duration of the test run of your program (you cannot reboot the machine
    while you are still developing your profile).
   </p><p>
    To use <code class="command">aa-genprof</code> for the stand-alone method of
    profiling, refer to
    <a class="xref" href="#sec.apparmor.commandline.profiling.summary.genprof" title="25.7.3.8. aa-genprof—Generating Profiles">Section 25.7.3.8, “aa-genprof—Generating Profiles”</a>.
   </p></div><div class="sect2 " id="sec.apparmor.commandline.profiling.systemic"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.commandline.profiling.systemic"><span class="number">25.7.2 </span><span class="name">Systemic Profiling</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.systemic">#</a></h3></div></div></div><p>
    This method is called <span class="emphasis"><em>systemic profiling</em></span> because it
    updates all of the profiles on the system at once, rather than focusing
    on the one or few targeted by <code class="command">aa-genprof</code> or
    stand-alone profiling. With systemic profiling, profile construction and
    improvement are somewhat less automated, but more flexible. This method
    is suitable for profiling long-running applications whose behavior
    continues after rebooting, or many programs at once.
   </p><p>
    Build an <span class="phrase">AppArmor</span> profile for a group of applications as follows:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Create profiles for the individual programs that make up your
      application.
     </p><p>
      Although this approach is systemic, <span class="phrase">AppArmor</span> only monitors those
      programs with profiles and their children. To get <span class="phrase">AppArmor</span> to consider
      a program, you must at least have <code class="command">aa-autodep</code> create
      an approximate profile for it. To create this approximate profile,
      refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.autodep" title="25.7.3.1. aa-autodep—Creating Approximate Profiles">Section 25.7.3.1, “aa-autodep—Creating Approximate Profiles”</a>.
     </p></li><li class="step "><p>
      Put relevant profiles into learning or complain mode.
     </p><p>
      Activate learning or complain mode for all profiled programs by
      entering
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-complain /etc/apparmor.d/*</pre></div><p>
      in a terminal window while logged in as <code class="systemitem">root</code>. This
      functionality is also available through the YaST Profile Mode
      module, described in
      <a class="xref" href="#sec.apparmor.yast.manage.profmodes" title="24.4.2. Changing the Mode of Individual Profiles">Section 24.4.2, “Changing the Mode of Individual Profiles”</a>.
     </p><p>
      When in learning mode, access requests are not blocked, even if the
      profile dictates that they should be. This enables you to run through
      several tests (as shown in
      <a class="xref" href="#st.apparmor.commandline.profiling.systemic.exec" title="Step 3">Step 3</a>) and
      learn the access needs of the program so it runs properly. With this
      information, you can decide how secure to make the profile.
     </p><p>
      Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.complain" title="25.7.3.2. aa-complain—Entering Complain or Learning Mode">Section 25.7.3.2, “aa-complain—Entering Complain or Learning Mode”</a>
      for more detailed instructions for using learning or complain mode.
     </p></li><li class="step " id="st.apparmor.commandline.profiling.systemic.exec"><p>
      Exercise your application.
     </p><p>
      Run your application and exercise its functionality. How much to
      exercise the program is up to you, but you need the program to access
      each file representing its access needs. Because the execution is not
      being supervised by <code class="command">aa-genprof</code>, this step can go on
      for days or weeks and can span complete system reboots.
     </p></li><li class="step " id="st.apparmor.commandline.profiling.systemic.log"><p>
      Analyze the log.
     </p><p>
      In systemic profiling, run <code class="command">aa-logprof</code> directly
      instead of letting <code class="command">aa-genprof</code> run it (as in
      stand-alone profiling). The general form of
      <code class="command">aa-logprof</code> is:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-logprof [ -d <em class="replaceable ">/path/to/profiles</em> ] [ -f <em class="replaceable ">/path/to/logfile</em> ]</pre></div><p>
      Refer to
      <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>
      for more information about using <code class="command">aa-logprof</code>.
     </p></li><li class="step "><p>
      Repeat
      <a class="xref" href="#st.apparmor.commandline.profiling.systemic.exec" title="Step 3">Step 3</a> and
      <a class="xref" href="#st.apparmor.commandline.profiling.systemic.log" title="Step 4">Step 4</a>.
     </p><p>
      This generates optimal profiles. An iterative approach captures
      smaller data sets that can be trained and reloaded into the policy
      engine. Subsequent iterations generate fewer messages and run faster.
     </p></li><li class="step "><p>
      Edit the profiles.
     </p><p>
      You should review the profiles that have been generated. You
      can open and edit the profiles in
      <code class="filename">/etc/apparmor.d/</code> using a text editor.
     </p></li><li class="step "><p>
      Return to enforce mode.
     </p><p>
      This is when the system goes back to enforcing the rules of the
      profiles, not only logging information. This can be done manually by
      removing the <code class="literal">flags=(complain)</code> text from the

      profiles or automatically by using the <code class="command">aa-enforce</code>
      command, which works identically to the <code class="command">aa-complain</code>
      command, except it sets the profiles to enforce mode. This
      functionality is also available through the YaST Profile Mode
      module, described in
      <a class="xref" href="#sec.apparmor.yast.manage.profmodes" title="24.4.2. Changing the Mode of Individual Profiles">Section 24.4.2, “Changing the Mode of Individual Profiles”</a>.
     </p><p>
      To ensure that all profiles are taken out of complain mode and put
      into enforce mode, enter <code class="command">aa-enforce
      /etc/apparmor.d/*</code>.
     </p></li><li class="step "><p>
      Re-scan all profiles.
     </p><p>
      To have <span class="phrase">AppArmor</span> re-scan all of the profiles and change the enforcement
      mode in the kernel, enter <code class="command">systemctl reload
      apparmor</code>.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.apparmor.commandline.profiling.summary"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.commandline.profiling.summary"><span class="number">25.7.3 </span><span class="name">Summary of Profiling Tools</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary">#</a></h3></div></div></div><p>
    All of the <span class="phrase">AppArmor</span> profiling utilities are provided by the
    <code class="systemitem">apparmor-utils</code> RPM package and are stored in
    <code class="filename">/usr/sbin</code>. Each tool has a different purpose.
   </p><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.autodep"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.autodep"><span class="number">25.7.3.1 </span><span class="name">aa-autodep—Creating Approximate Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.autodep">#</a></h4></div></div></div><p>
     This creates an approximate profile for the program or application
     selected. You can generate approximate profiles for binary executables
     and interpreted script programs. The resulting profile is called
     <span class="quote">“<span class="quote">approximate</span>”</span> because it does not necessarily contain all
     of the profile entries that the program needs to be properly confined
     by <span class="phrase">AppArmor</span>. The minimum <code class="command">aa-autodep</code> approximate
     profile has, at minimum, a base include directive, which contains basic
     profile entries needed by most programs. For certain types of programs,
     <code class="command">aa-autodep</code> generates a more expanded profile. The
     profile is generated by recursively calling <code class="command">ldd(1)</code>
     on the executables listed on the command line.
    </p><p>
     To generate an approximate profile, use the
     <code class="command">aa-autodep</code> program. The program argument can be
     either the simple name of the program, which
     <code class="command">aa-autodep</code> finds by searching your shell's path
     variable, or it can be a fully qualified path. The program itself can
     be of any type (ELF binary, shell script, Perl script, etc.).
     <code class="command">aa-autodep</code> generates an approximate profile to
     improve through the dynamic profiling that follows.
    </p><p>
     The resulting approximate profile is written to the
     <code class="filename">/etc/apparmor.d</code> directory using the <span class="phrase">AppArmor</span>
     profile naming convention of naming the profile after the absolute path
     of the program, replacing the forward slash (<code class="literal">/</code>)
     characters in the path with period (<code class="literal">.</code>) characters.
     The general syntax of <code class="command">aa-autodep</code> is to enter the
     following in a terminal window:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-autodep [ -d <em class="replaceable ">/PATH/TO/PROFILES</em> ] [<em class="replaceable ">PROGRAM1</em> <em class="replaceable ">PROGRAM2</em>...]</pre></div><p>
     If you do not enter the program name or names, you are prompted for
     them. <em class="replaceable ">/path/to/profiles</em> overrides the
     default location of <code class="filename">/etc/apparmor.d</code>, should you
     keep profiles in a location other than the default.
    </p><p>
     To begin profiling, you must create profiles for each main executable
     service that is part of your application (anything that might start
     without being a child of another program that already has a profile).
     Finding all such programs depends on the application in question. Here
     are several strategies for finding such programs:
    </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066545920"><span class="term ">Directories</span></dt><dd><p>
        If all the programs to profile are in one directory and there are no
        other programs in that directory, the simple command
        <code class="command">aa-autodep</code>
        <em class="replaceable ">/path/to/your/programs/*</em> creates basic
        profiles for all programs in that directory.
       </p></dd><dt id="idm140712066543024"><span class="term ">pstree -p</span></dt><dd><p>
        You can run your application and use the standard Linux
        <code class="command">pstree</code> command to find all processes running.
        Then manually hunt down the location of these programs and run the
        <code class="command">aa-autodep</code> for each one. If the programs are in
        your path, <code class="command">aa-autodep</code> finds them for you. If they
        are not in your path, the standard Linux command
        <code class="command">find</code> might be helpful in finding your programs.
        Execute <code class="command">find / -name '</code>
        <em class="replaceable ">MY_APPLICATION</em>' -print to determine an
        application's path (<em class="replaceable ">MY_APPLICATION</em> being
        an example application). You may use wild cards if appropriate.
       </p></dd></dl></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.complain"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.complain"><span class="number">25.7.3.2 </span><span class="name">aa-complain—Entering Complain or Learning Mode</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.complain">#</a></h4></div></div></div><p>
     The complain or learning mode tool (<code class="command">aa-complain</code>)
     detects violations of <span class="phrase">AppArmor</span> profile rules, such as the profiled
     program accessing files not permitted by the profile. The violations
     are permitted, but also logged. To improve the profile, turn complain
     mode on, run the program through a suite of tests to generate log
     events that characterize the program's access needs, then postprocess
     the log with the <span class="phrase">AppArmor</span> tools to transform log events into improved
     profiles.
    </p><p>
     Manually activating complain mode (using the command line) adds a flag
     to the top of the profile so that <code class="literal">/bin/foo</code> becomes
     <code class="literal">/bin/foo flags=(complain)</code>. To use complain mode,

     open a terminal window and enter one of the following lines as
     <code class="systemitem">root</code>:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       If the example program (<em class="replaceable ">PROGRAM1</em>) is in
       your path, use:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-complain [<em class="replaceable ">PROGRAM1</em> <em class="replaceable ">PROGRAM2</em> ...]</pre></div></li><li class="listitem "><p>
       If the program is not in your path, specify the entire path as
       follows:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-complain /sbin/<em class="replaceable ">PROGRAM1</em></pre></div></li><li class="listitem "><p>
       If the profiles are not in <code class="filename">/etc/apparmor.d</code>, use
       the following to override the default location:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-complain <em class="replaceable ">/path/to/profiles/</em><em class="replaceable ">PROGRAM1</em></pre></div></li><li class="listitem "><p>
       Specify the profile for <em class="replaceable ">/sbin/program1</em> as
       follows:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-complain /etc/apparmor.d/sbin.<em class="replaceable ">PROGRAM1</em></pre></div></li></ul></div><p>
     Each of the above commands activates the complain mode for the profiles
     or programs listed. If the program name does not include its entire
     path, <code class="command">aa-complain</code> searches <code class="envar">$PATH</code> for
     the program. For example, <code class="command">aa-complain /usr/sbin/*</code>
     finds profiles associated with all of the programs in
     <code class="filename">/usr/sbin</code> and puts them into complain mode.
     <code class="command">aa-complain /etc/apparmor.d/*</code> puts all of the
     profiles in <code class="filename">/etc/apparmor.d</code> into complain mode.
    </p><div id="idm140712066515936" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Toggling Profile Mode with YaST</h6><p>
      YaST offers a graphical front-end for toggling complain and
      enforce mode. See <a class="xref" href="#sec.apparmor.yast.manage.profmodes" title="24.4.2. Changing the Mode of Individual Profiles">Section 24.4.2, “Changing the Mode of Individual Profiles”</a>
      for information.
     </p></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.decode"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.decode"><span class="number">25.7.3.3 </span><span class="name">aa-decode—Decoding Hex-encoded Strings in <span class="phrase">AppArmor</span> Log Files</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.decode">#</a></h4></div></div></div><p>
     <code class="command">aa-decode</code> will decode hex-encoded strings in the
     <span class="phrase">AppArmor</span> log output. It can also process the audit log on standard
     input, convert any hex-encoded <span class="phrase">AppArmor</span> log entries, and display them on
     standard output.
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.disable"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.disable"><span class="number">25.7.3.4 </span><span class="name">aa-disable—Disabling an <span class="phrase">AppArmor</span> Security Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.disable">#</a></h4></div></div></div><p>
     Use <code class="command">aa-disable</code> to disable the enforcement mode for
     one or more <span class="phrase">AppArmor</span> profiles. This command will unload the profile from
     the kernel, and prevent the profile from being loaded on <span class="phrase">AppArmor</span>
     start-up. Use <code class="command">aa-enforce</code> or
     <code class="command">aa-complain</code> utilities to change this behavior.
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.easyprof"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.easyprof"><span class="number">25.7.3.5 </span><span class="name">aa-easyprof—Easy Profile Generation</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.easyprof">#</a></h4></div></div></div><p>
     <code class="command">aa-easyprof</code> provides an easy-to-use interface for
     <span class="phrase">AppArmor</span> profile generation. <code class="command">aa-easyprof</code> supports the
     use of templates and profile groups to quickly profile an application.
     While <code class="command">aa-easyprof</code> can help with profile generation,
     its utility is dependent on the quality of the templates, profile
     groups and abstractions used. Also, this tool may create a profile that
     is less restricted than when creating a profile manually or with
     <code class="command">aa-genprof</code> and <code class="command">aa-logprof</code>.
    </p><p>
     For more information, see the man page of
     <code class="command">aa-easyprof</code> (8).
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.enforce"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.enforce"><span class="number">25.7.3.6 </span><span class="name">aa-enforce—Entering Enforce Mode</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.enforce">#</a></h4></div></div></div><p>
     The enforce mode detects violations of <span class="phrase">AppArmor</span> profile rules, such as
     the profiled program accessing files not permitted by the profile. The
     violations are logged and not permitted. The default is for enforce
     mode to be enabled. To log the violations only, but still permit them,
     use complain mode.
    </p><p>
     Manually activating enforce mode (using the command line) removes the
     complain flag from the top of the profile so that <code class="literal">/bin/foo
     flags=(complain)</code> becomes <code class="literal">/bin/foo</code>. To use
     enforce mode, open a terminal window and enter one of the following
     lines.
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       If the example program (<em class="replaceable ">PROGRAM1</em>) is in
       your path, use:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-enforce [<em class="replaceable ">PROGRAM1</em> <em class="replaceable ">PROGRAM2</em> ...]</pre></div></li><li class="listitem "><p>
       If the program is not in your path, specify the entire path, as
       follows:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-enforce /sbin/<em class="replaceable ">PROGRAM1</em></pre></div></li><li class="listitem "><p>
       If the profiles are not in
       <em class="replaceable ">/etc/apparmor.d</em>, use the following to
       override the default location:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-enforce -d <em class="replaceable ">/path/to/profiles/     program1</em></pre></div></li><li class="listitem "><p>
       Specify the profile for <em class="replaceable ">/sbin/program1</em> as
       follows:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-enforce /etc/apparmor.d/sbin.<em class="replaceable ">PROGRAM1</em></pre></div></li></ul></div><p>
     Each of the above commands activates the enforce mode for the profiles
     and programs listed.
    </p><p>
     If you do not enter the program or profile names, you are prompted to
     enter one. <em class="replaceable ">/path/to/profiles</em> overrides the
     default location of <code class="filename">/etc/apparmor.d</code>.
    </p><p>
     The argument can be either a list of programs or a list of profiles. If
     the program name does not include its entire path,
     <code class="command">aa-enforce</code> searches <code class="envar">$PATH</code> for the
     program.
    </p><div id="idm140712066479952" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Toggling Profile Mode with YaST</h6><p>
      YaST offers a graphical front-end for toggling complain and
      enforce mode. See <a class="xref" href="#sec.apparmor.yast.manage.profmodes" title="24.4.2. Changing the Mode of Individual Profiles">Section 24.4.2, “Changing the Mode of Individual Profiles”</a>
      for information.
     </p></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.exec"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.exec"><span class="number">25.7.3.7 </span><span class="name">aa-exec—Confining a Program with the Specified Profile</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.exec">#</a></h4></div></div></div><p>
     Use <code class="command">aa-exec</code> to launch a program confined by a
     specified profile and/or profile namespace. If both a profile and
     namespace are specified, the program will be confined by the profile in
     the new namespace. If only a profile namespace is specified, the
     profile name of the current confinement will be used. If neither a
     profile nor namespace is specified, the command will be run using the
     standard profile attachment—as if you did not use the
     <code class="command">aa-exec</code> command.
    </p><p>
     For more information on the command's options, see its manual page
     <code class="command">man 8 aa-exec</code>.
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.genprof"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.genprof"><span class="number">25.7.3.8 </span><span class="name">aa-genprof—Generating Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.genprof">#</a></h4></div></div></div><p>
     <code class="command">aa-genprof</code> is <span class="phrase">AppArmor</span>'s profile generating utility.
     It runs <code class="command">aa-autodep</code> on the specified program,
     creating an approximate profile (if a profile does not already exist
     for it), sets it to complain mode, reloads it into <span class="phrase">AppArmor</span>, marks the
     log, and prompts the user to execute the program and exercise its
     functionality. Its syntax is as follows:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-genprof [ -d <em class="replaceable ">/path/to/profiles</em> ]  <em class="replaceable ">PROGRAM</em></pre></div><p>
     To create a profile for the Apache Web server program httpd2-prefork,
     do the following as <code class="systemitem">root</code>:
    </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
       Enter <code class="command">systemctl stop apache2</code>.
      </p></li><li class="step "><p>
       Next, enter <code class="command">aa-genprof httpd2-prefork</code>.
      </p><p>
       Now <code class="command">aa-genprof</code> does the following:
      </p><div class="orderedlist "><ol class="orderedlist" type="1"><li class="listitem "><p>
         Resolves the full path of httpd2-prefork using your shell's path
         variables. You can also specify a full path. On <span class="productname"><span class="phrase">openSUSE Leap</span></span>,
         the default full path is
         <span class="phrase"><code class="filename">/usr/sbin/httpd2-prefork</code></span>.
        </p></li><li class="listitem "><p>
         Checks to see if there is an existing profile for httpd2-prefork.
         If there is one, it updates it. If not, it creates one using the
         <code class="command">aa-autodep</code> as described in
         <a class="xref" href="#sec.apparmor.commandline.profiling.summary" title="25.7.3. Summary of Profiling Tools">Section 25.7.3, “Summary of Profiling Tools”</a>.
        </p></li><li class="listitem "><p>
         Puts the profile for this program into learning or complain mode so
         that profile violations are logged, but are permitted to proceed. A
         log event looks like this (see
         <code class="filename">/var/log/audit/audit.log</code>):
        </p><div class="verbatim-wrap"><pre class="screen">type=APPARMOR_ALLOWED msg=audit(1189682639.184:20816): \
apparmor="DENIED" operation="file_mmap" parent=2692 \
profile="/usr/sbin/httpd2-prefork//HANDLING_UNTRUSTED_INPUT" \
name="/var/log/apache2/access_log-20140116" pid=28730 comm="httpd2-prefork" \
requested_mask="::r" denied_mask="::r" fsuid=30 ouid=0</pre></div><p>
         If you are not running the audit daemon, the <span class="phrase">AppArmor</span> events are
         logged directly to <code class="systemitem">systemd</code> journal (see
         <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 11 “<code class="command">journalctl</code>: Query the <code class="systemitem">systemd</code> Journal”</span>):
        </p><div class="verbatim-wrap"><pre class="screen">Sep 13 13:20:30 K23 kernel: audit(1189682430.672:20810): \
apparmor="DENIED" operation="file_mmap" parent=2692 \
profile="/usr/sbin/httpd2-prefork//HANDLING_UNTRUSTED_INPUT" \
name="/var/log/apache2/access_log-20140116" pid=28730 comm="httpd2-prefork" \
requested_mask="::r" denied_mask="::r" fsuid=30 ouid=0</pre></div><p>
         They also can be viewed using the <code class="command">dmesg</code> command:
        </p><div class="verbatim-wrap"><pre class="screen">audit(1189682430.672:20810): apparmor="DENIED" \
operation="file_mmap" parent=2692 \
profile="/usr/sbin/httpd2-prefork//HANDLING_UNTRUSTED_INPUT" \
name="/var/log/apache2/access_log-20140116" pid=28730 comm="httpd2-prefork" \
requested_mask="::r" denied_mask="::r" fsuid=30 ouid=0</pre></div></li><li class="listitem "><p>
         Marks the log with a beginning marker of log events to consider.
         For example:
        </p><div class="verbatim-wrap"><pre class="screen">Sep 13 17:48:52 figwit root: GenProf: e2ff78636296f16d0b5301209a04430d</pre></div></li></ol></div></li><li class="step "><p>
       When prompted by the tool, run the application to profile in another
       terminal window and perform as many of the application functions as
       possible. Thus, the learning mode can log the files and directories
       to which the program requires access to function properly.
       For example, in a new terminal window, enter <code class="command">systemctl start
       apache2</code>.
      </p></li><li class="step "><p>
       Select from the following options that are available in the
       <code class="command">aa-genprof</code> terminal window after you have executed
       the program function:
      </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
         <span class="keycap">S</span> runs <code class="command">aa-genprof</code> on the system
         log from where it was marked when <code class="command">aa-genprof</code> was
         started and reloads the profile. If system events exist in the log,
         <span class="phrase">AppArmor</span> parses the learning mode log files. This generates a series
         of questions that you must answer to guide
         <code class="command">aa-genprof</code> in generating the security profile.
        </p></li><li class="listitem "><p>
         <span class="keycap">F</span> exits the tool.
        </p></li></ul></div><div id="idm140712066440144" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
        If requests to add hats appear, proceed to
        <a class="xref" href="#cha.apparmor.hat" title="Chapter 26. Profiling Your Web Applications Using ChangeHat">Chapter 26, <em>Profiling Your Web Applications Using ChangeHat</em></a>.
       </p></div></li><li class="step "><p>
       Answer two types of questions:
      </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
         A resource is requested by a profiled program that is not in the
         profile (see
         <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.learn" title="Learning Mode Exception: Controlling Access to Specific Resources">Example 25.1, “Learning Mode Exception: Controlling Access to Specific Resources”</a>).
        </p></li><li class="listitem "><p>
         A program is executed by the profiled program and the security
         domain transition has not been defined (see
         <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.perms" title="Learning Mode Exception: Defining Permissions for an Entry">Example 25.2, “Learning Mode Exception: Defining Permissions for an Entry”</a>).
        </p></li></ul></div><p>
       Each of these categories results in a series of questions that you
       must answer to add the resource or program to the profile.
       <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.learn" title="Learning Mode Exception: Controlling Access to Specific Resources">Example 25.1, “Learning Mode Exception: Controlling Access to Specific Resources”</a>
       and
       <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.perms" title="Learning Mode Exception: Defining Permissions for an Entry">Example 25.2, “Learning Mode Exception: Defining Permissions for an Entry”</a>
       provide examples of each one. Subsequent steps describe your options
       in answering these questions.
      </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
         Dealing with execute accesses is complex. You must decide how to
         proceed with this entry regarding which execute permission type to
         grant to this entry:
        </p><div class="example" id="ex.apparmor.commandline.profiling.summary.genprof.learn"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 25.1: </span><span class="name">Learning Mode Exception: Controlling Access to Specific Resources </span><a title="Permalink" class="permalink" href="#ex.apparmor.commandline.profiling.summary.genprof.learn">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">Reading log entries from /var/log/audit/audit.log.
Updating AppArmor profiles in /etc/apparmor.d.

Profile:  /usr/sbin/cupsd
Program:  cupsd
Execute:  /usr/lib/cups/daemon/cups-lpd
Severity: unknown

(I)nherit / (P)rofile / (C)hild / (N)ame / (U)nconfined / (X)ix / (D)eny / Abo(r)t / (F)inish</pre></div></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712066427472"><span class="term ">Inherit (ix)</span></dt><dd><p>
            The child inherits the parent's profile, running with the same
            access controls as the parent. This mode is useful when a
            confined program needs to call another confined program without
            gaining the permissions of the target's profile or losing the
            permissions of the current profile. This mode is often used when
            the child program is a <span class="emphasis"><em>helper application</em></span>,
            such as the <code class="command">/usr/bin/mail</code> client using
            <code class="command">less</code> as a pager.
           </p></dd><dt id="idm140712066423888"><span class="term ">Profile (px/Px)</span></dt><dd><p>
            The child runs using its own profile, which must be loaded into
            the kernel. If the profile is not present, attempts to execute
            the child fail with permission denied. This is most useful if
            the parent program is invoking a global service, such as DNS
            lookups or sending mail with your system's MTA.
           </p><p>
            Choose the <span class="guimenu">profile with clean exec</span> (Px)
            option to scrub the environment of environment variables that
            could modify execution behavior when passed to the child
            process.
           </p></dd><dt id="idm140712066420672"><span class="term ">Child (cx/Cx)</span></dt><dd><p>
            Sets up a transition to a subprofile. It is like px/Px
            transition, except to a child profile.
           </p><p>
            Choose the <span class="guimenu">profile with clean exec</span> (Cx)
            option to scrub the environment of environment variables that
            could modify execution behavior when passed to the child
            process.
           </p></dd><dt id="idm140712066417696"><span class="term ">Unconfined (ux/Ux)</span></dt><dd><p>
            The child runs completely unconfined without any <span class="phrase">AppArmor</span> profile
            applied to the executed resource.
           </p><p>
            Choose the <span class="guimenu">unconfined with clean exec</span> (Ux)
            option to scrub the environment of environment variables that
            could modify execution behavior when passed to the child
            process. Note that running unconfined profiles introduces a
            security vulnerability that could be used to evade <span class="phrase">AppArmor</span>. Only
            use it as a last resort.
           </p></dd><dt id="idm140712066413744"><span class="term ">mmap (m)</span></dt><dd><p>
            This permission denotes that the program running under the
            profile can access the resource using the mmap system call with
            the flag <code class="envar">PROT_EXEC</code>. This means that the data
            mapped in it can be executed. You are prompted to include this
            permission if it is requested during a profiling run.
           </p></dd><dt id="idm140712066411184"><span class="term ">Deny</span></dt><dd><p>
            Adds a <code class="literal">deny</code> rule to the profile, and
            permanently prevents the program from accessing the specified
            directory path entries. <span class="phrase">AppArmor</span> then continues to the next
            event.
           </p></dd><dt id="idm140712066408320"><span class="term ">Abort</span></dt><dd><p>
            Aborts <code class="command">aa-logprof</code>, losing all rule changes
            entered so far and leaving all profiles unmodified.
           </p></dd><dt id="idm140712066406000"><span class="term ">Finish</span></dt><dd><p>
            Closes <code class="command">aa-logprof</code>, saving all rule changes
            entered so far and modifying all profiles.
           </p></dd></dl></div></li><li class="listitem "><p>
         <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.perms" title="Learning Mode Exception: Defining Permissions for an Entry">Example 25.2, “Learning Mode Exception: Defining Permissions for an Entry”</a>
         shows <span class="phrase">AppArmor</span> suggest allowing a globbing pattern
         <code class="filename">/var/run/nscd/*</code> for reading, then using an
         abstraction to cover common Apache-related access rules.
        </p><div class="example" id="ex.apparmor.commandline.profiling.summary.genprof.perms"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 25.2: </span><span class="name">Learning Mode Exception: Defining Permissions for an Entry </span><a title="Permalink" class="permalink" href="#ex.apparmor.commandline.profiling.summary.genprof.perms">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">Profile:  /usr/sbin/httpd2-prefork
Path:     /var/run/nscd/dbSz9CTr
Mode:     r
Severity: 3

  1 - /var/run/nscd/dbSz9CTr
 [2 - /var/run/nscd/*]

(A)llow / [(D)eny] / (G)lob / Glob w/(E)xt / (N)ew / Abo(r)t / (F)inish / (O)pts
Adding /var/run/nscd/* r to profile.

Profile:  /usr/sbin/httpd2-prefork
Path:     /proc/11769/attr/current
Mode:     w
Severity: 9

 [1 - #include &lt;abstractions/apache2-common&gt;]
  2 - /proc/11769/attr/current
  3 - /proc/*/attr/current

(A)llow / [(D)eny] / (G)lob / Glob w/(E)xt / (N)ew / Abo(r)t / (F)inish / (O)pts
Adding #include &lt;abstractions/apache2-common&gt; to profile.</pre></div></div></div><p>
         <span class="phrase">AppArmor</span> provides one or more paths or includes. By entering the
         option number, select the desired options then proceed to the next
         step.
        </p><div id="idm140712066397504" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
          Not all of these options are always presented in the <span class="phrase">AppArmor</span> menu.
         </p></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712066395824"><span class="term "><code class="literal">#include</code>
          </span></dt><dd><p>
            This is the section of an <span class="phrase">AppArmor</span> profile that refers to an
            include file, which procures access permissions for programs. By
            using an include, you can give the program access to directory
            paths or files that are also required by other programs. Using
            includes can reduce the size of a profile. It is good practice
            to select includes when suggested.
           </p></dd><dt id="idm140712066392912"><span class="term ">Globbed Version</span></dt><dd><p>
            This is accessed by selecting <span class="guimenu">Glob</span> as
            described in the next step. For information about globbing
            syntax, refer to <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>.
           </p></dd><dt id="idm140712066390032"><span class="term ">Actual Path</span></dt><dd><p>
            This is the literal path to which the program needs access so
            that it can run properly.
           </p></dd></dl></div><p>
         After you select the path or include, process it as an entry into
         the <span class="phrase">AppArmor</span> profile by selecting <span class="guimenu">Allow</span> or
         <span class="guimenu">Deny</span>. If you are not satisfied with the
         directory path entry as it is displayed, you can also
         <span class="guimenu">Glob</span> it.
        </p><p>
         The following options are available to process the learning mode
         entries and build the profile:
        </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066384704"><span class="term ">Select <span class="keycap">Enter</span>
          </span></dt><dd><p>
            Allows access to the selected directory path.
           </p></dd><dt id="idm140712066382304"><span class="term ">Allow</span></dt><dd><p>
            Allows access to the specified directory path entries. <span class="phrase">AppArmor</span>
            suggests file permission access. For more information, refer to
            <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
           </p></dd><dt id="idm140712066379360"><span class="term ">Deny</span></dt><dd><p>
            Prevents the program from accessing the specified directory path
            entries. <span class="phrase">AppArmor</span> then continues to the next event.
           </p></dd><dt id="idm140712066377008"><span class="term ">New</span></dt><dd><p>
            Prompts you to enter your own rule for this event, allowing you
            to specify a regular expression. If the expression does not
            actually satisfy the event that prompted the question in the
            first place, <span class="phrase">AppArmor</span> asks for confirmation and lets you reenter
            the expression.
           </p></dd><dt id="idm140712066374480"><span class="term ">Glob</span></dt><dd><p>
            Select a specific path or create a general rule using wild cards
            that match a broader set of paths. To select any of the offered
            paths, enter the number that is printed in front of the path
            then decide how to proceed with the selected item.
           </p><p>
            For more information about globbing syntax, refer to
            <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>.
           </p></dd><dt id="idm140712066371312"><span class="term ">Glob w/Ext</span></dt><dd><p>
            This modifies the original directory path while retaining the
            file name extension. For example,
            <code class="filename">/etc/apache2/file.ext</code> becomes
            <code class="filename">/etc/apache2/*.ext</code>, adding the wild card
            (asterisk) in place of the file name. This allows the program to
            access all files in the suggested directory that end with the
            <code class="literal">.ext</code> extension.
           </p></dd><dt id="idm140712066367888"><span class="term ">Abort</span></dt><dd><p>
            Aborts <code class="command">aa-logprof</code>, losing all rule changes
            entered so far and leaving all profiles unmodified.
           </p></dd><dt id="idm140712066365568"><span class="term ">Finish</span></dt><dd><p>
            Closes <code class="command">aa-logprof</code>, saving all rule changes
            entered so far and modifying all profiles.
           </p></dd></dl></div></li></ul></div></li><li class="step "><p>
       To view and edit your profile using <code class="command">vi</code>, enter
       <code class="command">vi /etc/apparmor.d/</code>
       <em class="replaceable ">PROFILENAME</em> in a terminal window. To
       enable syntax highlighting when editing an <span class="phrase">AppArmor</span> profile in vim,
       use the commands <code class="command">:syntax on</code> then <code class="command">:set
       syntax=apparmor</code>. For more information about vim and syntax
       highlighting, refer to
       <a class="xref" href="#sec.apparmor.commandline.profiling.summary.vim" title="25.7.3.14. apparmor.vim">Section 25.7.3.14, “apparmor.vim”</a>.
      </p></li><li class="step "><p>
       Restart <span class="phrase">AppArmor</span> and reload the profile set including the newly
       created one using the <code class="command">systemctl reload
       apparmor</code> command.
      </p></li></ol></div></div><p>
     Like the graphical front-end for building <span class="phrase">AppArmor</span> profiles, the
     YaST Add Profile Wizard, <code class="command">aa-genprof</code> also
     supports the use of the local profile repository under
     <code class="filename">/etc/apparmor/profiles/extras</code>

     and the remote <span class="phrase">AppArmor</span> profile repository.
    </p><p>
     To use a profile from the local repository, proceed as follows:
    </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
       Start <code class="command">aa-genprof</code> as described above.
      </p><p>
       If <code class="command">aa-genprof</code> finds an inactive local profile, the
       following lines appear on your terminal window:
      </p><div class="verbatim-wrap"><pre class="screen">Profile: /usr/bin/opera

 [1 - Inactive local profile for /usr/bin/opera]

[(V)iew Profile] / (U)se Profile / (C)reate New Profile / Abo(r)t / (F)inish</pre></div></li><li class="step "><p>
       To use this profile, press <span class="keycap">U</span>
       (<span class="guimenu">Use Profile</span>) and follow the profile generation
       procedure outlined above.
      </p><p>
       To examine the profile before activating it, press
       <span class="keycap">V</span> (<span class="guimenu">View Profile</span>).
      </p><p>
       To ignore the existing profile, press <span class="keycap">C</span>
       (<span class="guimenu">Create New Profile</span>) and follow the profile
       generation procedure outlined above to create the profile from
       scratch.
      </p></li><li class="step "><p>
       Leave <code class="command">aa-genprof</code> by pressing <span class="keycap">F</span>
       (<span class="guimenu">Finish</span>) when you are done and save your changes.
      </p></li></ol></div></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.logprof"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.logprof"><span class="number">25.7.3.9 </span><span class="name">aa-logprof—Scanning the System Log</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.logprof">#</a></h4></div></div></div><p>
     <code class="command">aa-logprof</code> is an interactive tool used to review the
     complain and enforce mode events found in the log entries in
     <code class="filename">/var/log/audit/audit.log</code>, or directly in the
     <code class="systemitem">systemd</code> journal (see <span class="intraxref">Book “<em class="citetitle ">Reference</em>”, Chapter 11 “<code class="command">journalctl</code>: Query the <code class="systemitem">systemd</code> Journal”</span>), and
     generate new entries in <span class="phrase">AppArmor</span> security profiles.
    </p><p>
     When you run <code class="command">aa-logprof</code>, it begins to scan the log
     files produced in complain and enforce mode and, if there are new
     security events that are not covered by the existing profile set, it
     gives suggestions for modifying the profile.
     <code class="command">aa-logprof</code> uses this information to observe program
     behavior.
    </p><p>
     If a confined program forks and executes another program,
     <code class="command">aa-logprof</code> sees this and asks the user which
     execution mode should be used when launching the child process. The
     execution modes <span class="emphasis"><em>ix</em></span>, <span class="emphasis"><em>px</em></span>,
     <span class="emphasis"><em>Px</em></span>, <span class="emphasis"><em>ux</em></span>,
     <span class="emphasis"><em>Ux</em></span>, <span class="emphasis"><em>cx</em></span>,
     <span class="emphasis"><em>Cx</em></span>, and named profiles, are options for starting
     the child process. If a separate profile exists for the child process,
     the default selection is <span class="emphasis"><em>Px</em></span>. If one does not
     exist, the profile defaults to <span class="emphasis"><em>ix</em></span>. Child processes
     with separate profiles have <code class="command">aa-autodep</code> run on them
     and are loaded into <span class="phrase">AppArmor</span>, if it is running.
    </p><p>
     When <code class="command">aa-logprof</code> exits, profiles are updated with the
     changes. If <span class="phrase">AppArmor</span> is active, the updated profiles are reloaded and,
     if any processes that generated security events are still running in
     the null-XXXX profiles (unique profiles temporarily created in complain
     mode), those processes are set to run under their proper profiles.
    </p><p>
     To run <code class="command">aa-logprof</code>, enter
     <code class="command">aa-logprof</code> into a terminal window while logged in as
     <code class="systemitem">root</code>. The following options can be used for
     <code class="command">aa-logprof</code>:
    </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066325968"><span class="term "><code class="command">aa-logprof -d</code><em class="replaceable ">/path/to/profile/directory/</em>
      </span></dt><dd><p>
        Specifies the full path to the location of the profiles if the
        profiles are not located in the standard directory,
        <code class="filename">/etc/apparmor.d/</code>.
       </p></dd><dt id="idm140712066323008"><span class="term "><code class="command">aa-logprof -f</code><em class="replaceable ">/path/to/logfile/</em>
      </span></dt><dd><p>
        Specifies the full path to the location of the log file if the log
        file is not located in the default directory or
        <code class="filename">/var/log/audit/audit.log</code>.
       </p></dd><dt id="idm140712066320048"><span class="term "><code class="command">aa-logprof -m "string marker in logfile"</code>
      </span></dt><dd><p>
        Marks the starting point for <code class="command">aa-logprof</code> to look
        in the system log. <code class="command">aa-logprof</code> ignores all events
        in the system log before the specified mark. If the mark contains
        spaces, it must be surrounded by quotes to work correctly. For
        example:
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aa-logprof -m "17:04:21"</pre></div><p>
        or
       </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>aa-logprof -m e2ff78636296f16d0b5301209a04430d</pre></div></dd></dl></div><p>
     <code class="command">aa-logprof</code> scans the log, asking you how to handle
     each logged event. Each question presents a numbered list of <span class="phrase">AppArmor</span>
     rules that can be added by pressing the number of the item on the list.
    </p><p>
     By default, <code class="command">aa-logprof</code> looks for profiles in
     <code class="filename">/etc/apparmor.d/</code>. Often running
     <code class="command">aa-logprof</code> as <code class="systemitem">root</code> is enough to update the
     profile. However, there might be times when you need to search archived
     log files, such as if the program exercise period exceeds the log
     rotation window (when the log file is archived and a new log file is
     started). If this is the case, you can enter <code class="command">zcat -f `ls
     -1tr</code> <em class="replaceable ">/path/to/logfile*</em>` |
     aa-logprof -f -.
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.logprof_ex1"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.logprof_ex1"><span class="number">25.7.3.10 </span><span class="name">aa-logprof Example 1</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.logprof_ex1">#</a></h4></div></div></div><p>
     The following is an example of how <code class="command">aa-logprof</code>
     addresses httpd2-prefork accessing the file
     <code class="filename">/etc/group</code>. <code class="literal">[]</code> indicates the
     default option.
    </p><p>
     In this example, the access to <code class="command">/etc/group</code> is part of
     httpd2-prefork accessing name services. The appropriate response is
     <code class="literal">1</code>, which includes a predefined set of <span class="phrase">AppArmor</span> rules.
     Selecting <code class="literal">1</code> to <code class="literal">#include</code> the name
     service package resolves all of the future questions pertaining to DNS
     lookups and makes the profile less brittle in that any changes to
     DNS configuration and the associated name service profile package can
     be made once, rather than needing to revise many profiles.
    </p><div class="verbatim-wrap"><pre class="screen">Profile:  /usr/sbin/httpd2-prefork
Path:     /etc/group
New Mode: r

[1 - #include &lt;abstractions/nameservice&gt;]
 2 - /etc/group
[(A)llow] / (D)eny / (N)ew / (G)lob / Glob w/(E)xt / Abo(r)t / (F)inish</pre></div><p>
     Select one of the following responses:
    </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066301152"><span class="term ">Select <span class="keycap">Enter</span>
      </span></dt><dd><p>
        Triggers the default action, which is, in this example, allowing
        access to the specified directory path entry.
       </p></dd><dt id="idm140712066298688"><span class="term ">Allow</span></dt><dd><p>
        Allows access to the specified directory path entries. <span class="phrase">AppArmor</span>
        suggests file permission access. For more information about this,
        refer to <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
       </p></dd><dt id="idm140712066295744"><span class="term ">Deny</span></dt><dd><p>
        Permanently prevents the program from accessing the specified
        directory path entries. <span class="phrase">AppArmor</span> then continues to the next event.
       </p></dd><dt id="idm140712066293392"><span class="term ">New</span></dt><dd><p>
        Prompts you to enter your own rule for this event, allowing you to
        specify whatever form of regular expression you want. If the
        expression entered does not actually satisfy the event that prompted
        the question in the first place, <span class="phrase">AppArmor</span> asks for confirmation and
        lets you reenter the expression.
       </p></dd><dt id="idm140712066290848"><span class="term ">Glob</span></dt><dd><p>
        Select either a specific path or create a general rule using wild
        cards that matches on a broader set of paths. To select any of the
        offered paths, enter the number that is printed in front of the
        paths then decide how to proceed with the selected item.
       </p><p>
        For more information about globbing syntax, refer to
        <a class="xref" href="#sec.apparmor.profiles.glob" title="22.6. Profile Names, Flags, Paths, and Globbing">Section 22.6, “Profile Names, Flags, Paths, and Globbing”</a>.
       </p></dd><dt id="idm140712066287712"><span class="term ">Glob w/Ext</span></dt><dd><p>
        This modifies the original directory path while retaining the file
        name extension. For example,
        <code class="filename">/etc/apache2/file.ext</code> becomes
        <code class="filename">/etc/apache2/*.ext</code>, adding the wild card
        (asterisk) in place of the file name. This allows the program to
        access all files in the suggested directory that end with the
        <code class="literal">.ext</code> extension.
       </p></dd><dt id="idm140712066284304"><span class="term ">Abort</span></dt><dd><p>
        Aborts <code class="command">aa-logprof</code>, losing all rule changes
        entered so far and leaving all profiles unmodified.
       </p></dd><dt id="idm140712066281984"><span class="term ">Finish</span></dt><dd><p>
        Closes <code class="command">aa-logprof</code>, saving all rule changes
        entered so far and modifying all profiles.
       </p></dd></dl></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.logprof_ex2"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.logprof_ex2"><span class="number">25.7.3.11 </span><span class="name">aa-logprof Example 2</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.logprof_ex2">#</a></h4></div></div></div><p>
     For example, when profiling vsftpd, see this question:
    </p><div class="verbatim-wrap"><pre class="screen">Profile:  /usr/sbin/vsftpd
Path:     /y2k.jpg

New Mode: r

[1 - /y2k.jpg]

(A)llow / [(D)eny] / (N)ew / (G)lob / Glob w/(E)xt / Abo(r)t / (F)inish</pre></div><p>
     Several items of interest appear in this question. First, note that
     vsftpd is asking for a path entry at the top of the tree, even though
     vsftpd on <span class="productname"><span class="phrase">openSUSE Leap</span></span>

     serves FTP files from <code class="filename">/srv/ftp</code> by default. This is
     because vsftpd uses chroot and, for the portion of the code inside the
     chroot jail, <span class="phrase">AppArmor</span> sees file accesses in terms of the chroot
     environment rather than the global absolute path.
    </p><p>
     The second item of interest is that you should grant FTP read
     access to all JPEG files in the directory, so you could use
     <span class="guimenu">Glob w/Ext</span> and use the suggested path of
     <code class="literal">/*.jpg</code>. Doing so collapses all previous rules
     granting access to individual <code class="literal">.jpg</code> files and
     forestalls any future questions pertaining to access to
     <code class="filename">.jpg</code> files.
    </p><p>
     Finally, you should grant more general access to FTP files. If
     you select <span class="guimenu">Glob</span> in the last entry,
     <code class="command">aa-logprof</code> replaces the suggested path of
     <code class="filename">/y2k.jpg</code> with <code class="filename">/*</code>.
     Alternatively, you should grant even more access to the entire
     directory tree, in which case you could use the <span class="guimenu">New</span>
     path option and enter <code class="literal">/**.jpg</code> (which would grant
     access to all <code class="literal">.jpg</code> files in the entire directory
     tree) or <code class="filename">/**</code> (which would grant access to all
     files in the directory tree).
    </p><p>
     These items deal with read accesses. Write accesses are similar, except
     that it is good policy to be more conservative in your use of regular
     expressions for write accesses. Dealing with execute accesses is more
     complex. Find an example in
     <a class="xref" href="#ex.apparmor.commandline.profiling.summary.genprof.learn" title="Learning Mode Exception: Controlling Access to Specific Resources">Example 25.1, “Learning Mode Exception: Controlling Access to Specific Resources”</a>.
    </p><p>
     In the following example, the <code class="filename">/usr/bin/mail</code> mail
     client is being profiled and <code class="command">aa-logprof</code> has
     discovered that <code class="command">/usr/bin/mail</code> executes
     <code class="command">/usr/bin/less</code> as a helper application to
     <span class="quote">“<span class="quote">page</span>”</span> long mail messages. Consequently, it presents this
     prompt:
    </p><div class="verbatim-wrap"><pre class="screen">/usr/bin/nail -&gt; /usr/bin/less
(I)nherit / (P)rofile / (C)hild / (N)ame / (U)nconfined / (X)ix / (D)eny</pre></div><div id="idm140712066262720" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
      The actual executable file for <code class="filename">/usr/bin/mail</code>
      turns out to be <code class="filename">/usr/bin/nail</code>, which is not a
      typographical error.
     </p></div><p>
     The program <code class="filename">/usr/bin/less</code> appears to be a
     simple one for scrolling through text that is more than one screen
     long and that is in fact what <code class="filename">/usr/bin/mail</code> is
     using it for. However, <code class="command">less</code> is actually a large
     and powerful program that uses many other helper applications, such
     as <code class="command">tar</code> and <code class="command">rpm</code>.
    </p><div id="idm140712066257984" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
      Run <code class="command">less</code> on a tar file or an RPM file and it shows
      you the inventory of these containers.
     </p></div><p>
     You do not want to run <code class="command">rpm</code> automatically when
     reading mail messages (that leads directly to a Microsoft*
     Outlook–style virus attack, because RPM has the power to
     install and modify system programs), so, in this case, the best choice
     is to use <span class="guimenu">Inherit</span>. This results in the less program
     executed from this context running under the profile for
     <code class="filename">/usr/bin/mail</code>. This has two consequences:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       You need to add all of the basic file accesses for
       <code class="filename">/usr/bin/less</code> to the profile for
       <code class="filename">/usr/bin/mail</code>.
      </p></li><li class="listitem "><p>
       You can avoid adding the helper applications, such as
       <code class="command">tar</code> and <code class="command">rpm</code>, to the
       <code class="filename">/usr/bin/mail</code> profile so that when
       <code class="filename">/usr/bin/mail</code> runs
       <code class="filename">/usr/bin/less</code> in this context, the less program
       is far less dangerous than it would be without <span class="phrase">AppArmor</span> protection.
       Another option is to use the Cx execute modes. For more information
       on execute modes, see <a class="xref" href="#sec.apparmor.profiles.exec" title="22.8. Execute Modes">Section 22.8, “Execute Modes”</a>.
      </p></li></ul></div><p>
     In other circumstances, you might instead want to use the
     <span class="guimenu">Profile</span> option. This has the following effects on
     <code class="command">aa-logprof</code>:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       The rule written into the profile uses px/Px, which forces the
       transition to the child's own profile.
      </p></li><li class="listitem "><p>
       <code class="command">aa-logprof</code> constructs a profile for the child and
       starts building it, in the same way that it built the parent profile,
       by assigning events for the child process to the child's profile and
       asking the <code class="command">aa-logprof</code> user questions. The profile
       will also be applied if you run the child as a stand-alone program.
      </p></li></ul></div><p>
     If a confined program forks and executes another program,
     <code class="command">aa-logprof</code> sees this and asks the user which
     execution mode should be used when launching the child process. The
     execution modes of inherit, profile, unconfined, child, named profile,
     or an option to deny the execution are presented.
    </p><p>
     If a separate profile exists for the child process, the default
     selection is profile. If a profile does not exist, the default is
     inherit. The inherit option, or <code class="literal">ix</code>, is described in
     <a class="xref" href="#sec.apparmor.profiles.perm" title="22.7. File Permission Access Modes">Section 22.7, “File Permission Access Modes”</a>.
    </p><p>
     The profile option indicates that the child program should run in its
     own profile. A secondary question asks whether to sanitize the
     environment that the child program inherits from the parent. If you
     choose to sanitize the environment, this places the execution modifier
     <code class="literal">Px</code> in your <span class="phrase">AppArmor</span> profile. If you select not to
     sanitize, <code class="literal">px</code> is placed in the profile and no
     environment sanitizing occurs. The default for the execution mode is
     <code class="literal">Px</code> if you select profile execution mode.
    </p><p>
     The unconfined execution mode is not recommended and should only be
     used in cases where there is no other option to generate a profile for
     a program reliably. Selecting unconfined opens a warning dialog asking
     for confirmation of the choice. If you are sure and choose
     <span class="guimenu">Yes</span>, a second dialog ask whether to sanitize the
     environment. To use the execution mode <code class="literal">Ux</code> in your
     profile, select <span class="guimenu">Yes</span>. To use the execution mode
     <code class="literal">ux</code> in your profile instead, select
     <span class="guimenu">No</span>. The default value selected is
     <code class="literal">Ux</code> for unconfined execution mode.
    </p><div id="idm140712066232624" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Running Unconfined</h6><p>
      Selecting <code class="literal">ux or Ux</code> is very dangerous and provides
      no enforcement of policy (from a security perspective) of the
      resulting execution behavior of the child program.
     </p></div></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.unconfined"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.unconfined"><span class="number">25.7.3.12 </span><span class="name">aa-unconfined—Identifying Unprotected Processes</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.unconfined">#</a></h4></div></div></div><p>
     The <code class="command">aa-unconfined</code> command examines open network
     ports on your system, compares that to the set of profiles loaded on
     your system, and reports network services that do not have <span class="phrase">AppArmor</span>
     profiles. It requires <code class="systemitem">root</code> privileges and that it not be
     confined by an <span class="phrase">AppArmor</span> profile.
    </p><p>
     <code class="command">aa-unconfined</code> must be run as <code class="systemitem">root</code> to
     retrieve the process executable link from the
     <code class="filename">/proc</code> file system. This program is susceptible to
     the following race conditions:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       An unlinked executable is mishandled
      </p></li><li class="listitem "><p>
       A process that dies between <code class="command">netstat(8)</code> and further
       checks is mishandled
      </p></li></ul></div><div id="idm140712066221056" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note</h6><p>
      This program lists processes using TCP and UDP only. In short, this
      program is unsuitable for forensics use and is provided only as an aid
      to profiling all network-accessible processes in the lab.
     </p></div></div><div class="sect3 " id="commandline.profiling.summary.aa-notify"><div class="titlepage"><div><div><h4 class="title" id="commandline.profiling.summary.aa-notify"><span class="number">25.7.3.13 </span><span class="name">aa-notify</span> <a title="Permalink" class="permalink" href="#commandline.profiling.summary.aa-notify">#</a></h4></div></div></div><p>
     <code class="command">aa-notify</code> is a handy utility that displays <span class="phrase">AppArmor</span>
     notifications in your desktop environment. This is very convenient if
     you do not want to inspect the <span class="phrase">AppArmor</span> log file, but rather let the
     desktop inform you about events that violate the policy. To enable
     <span class="phrase">AppArmor</span> desktop notifications, run <code class="command">aa-notify</code>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-notify -p -u <em class="replaceable ">USERNAME</em> --display <em class="replaceable ">DISPLAY_NUMBER</em></pre></div><p>
     where <em class="replaceable ">USERNAME</em> is your user name under which
     you are logged in, and <em class="replaceable ">DISPLAY_NUMBER</em> is the
     X Window display number you are currently using, such as
     <code class="literal">:0</code>. The process is run in the background, and shows
     a notification each time a deny event happens.
    </p><div id="idm140712066211984" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
      The active X Window display number is saved in the
      <code class="literal">$DISPLAY</code> variable, so you can use
      <code class="literal">--display $DISPLAY</code> to avoid finding out the current
      display number.
     </p></div><div class="figure" id="idm140712066210080"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/aa-notify.png"><img src="images/aa-notify.png" width="" alt="aa-notify Message in GNOME" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 25.1: </span><span class="name"><code class="command">aa-notify Message in GNOME</code> </span><a title="Permalink" class="permalink" href="#idm140712066210080">#</a></h6></div></div><p>
     With the <code class="option">-s <em class="replaceable ">DAYS</em></code> option,
     you can also configure <code class="command">aa-notify</code> to display a
     summary of notifications for the specified number of past days. For
     more information on <code class="command">aa-notify</code>, see its man page
     <code class="command">man 8 aa-notify</code>.
    </p></div><div class="sect3 " id="sec.apparmor.commandline.profiling.summary.vim"><div class="titlepage"><div><div><h4 class="title" id="sec.apparmor.commandline.profiling.summary.vim"><span class="number">25.7.3.14 </span><span class="name">apparmor.vim</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.profiling.summary.vim">#</a></h4></div></div></div><p>
     A syntax highlighting file for the vim text editor highlights various
     features of an <span class="phrase">AppArmor</span> profile with colors. Using vim and the <span class="phrase">AppArmor</span>
     syntax mode for vim, you can see the semantic implications of your
     profiles with color highlighting. Use vim to view and edit your profile
     by typing vim at a terminal window.
    </p><p>
     To enable the syntax coloring when you edit an <span class="phrase">AppArmor</span> profile in vim,
     use the commands <code class="literal">:syntax on</code> then <code class="literal">:set
     syntax=apparmor</code>. To make sure vim recognizes the edited file
     type correctly as an <span class="phrase">AppArmor</span> profile, add
    </p><div class="verbatim-wrap"><pre class="screen"># vim:ft=apparmor</pre></div><p>
     at the end of the profile.
    </p><div id="idm140712066195984" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
      <code class="command">vim</code> comes with <span class="phrase">AppArmor</span> highlighting automatically
      enabled for files in <code class="filename">/etc/apparmor.d/</code>.
     </p></div><p>
     When you enable this feature, vim colors the lines of the profile for
     you:
    </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066192896"><span class="term ">Blue</span></dt><dd><p>
        Comments
       </p></dd><dt id="idm140712066191088"><span class="term ">White</span></dt><dd><p>
        Ordinary read access lines
       </p></dd><dt id="idm140712066189264"><span class="term ">Brown</span></dt><dd><p>
        Capability statements and complain flags
       </p></dd><dt id="idm140712066187424"><span class="term ">Yellow</span></dt><dd><p>
        Lines that grant write access
       </p></dd><dt id="idm140712066185600"><span class="term ">Green</span></dt><dd><p>
        Lines that grant execute permission (either ix or px)
       </p></dd><dt id="idm140712066183760"><span class="term ">Red</span></dt><dd><p>
        Lines that grant unconfined access (ux)
       </p></dd><dt id="idm140712066181920"><span class="term ">Red background</span></dt><dd><p>
        Syntax errors that will not load properly into the <span class="phrase">AppArmor</span> modules
       </p></dd></dl></div><p>
     Use the <code class="systemitem">apparmor.vim</code> and
     <code class="systemitem">vim</code> man pages and the <code class="option">:help
     syntax</code> from within the vim editor for further vim help about
     syntax highlighting. The <span class="phrase">AppArmor</span> syntax is stored in
     <code class="filename">/usr/share/vim/current/syntax/apparmor.vim.</code>
    </p></div></div></div><div class="sect1 " id="sec.apparmor.commandline.filenames"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.commandline.filenames"><span class="number">25.8 </span><span class="name">Important File Names and Directories</span> <a title="Permalink" class="permalink" href="#sec.apparmor.commandline.filenames">#</a></h2></div></div></div><p>
   The following list contains the most important files and directories used
   by the <span class="phrase">AppArmor</span> framework. If you intend to manage and troubleshoot your
   profiles manually, make sure that you know about these files and
   directories:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712066173648"><span class="term "><code class="filename">/sys/kernel/security/apparmor/profiles</code>
    </span></dt><dd><p>
      Virtualized file representing the currently loaded set of profiles.
     </p></dd><dt id="idm140712066171488"><span class="term "><code class="filename">/etc/apparmor/</code>
    </span></dt><dd><p>
      Location of <span class="phrase">AppArmor</span> configuration files.
     </p></dd><dt id="idm140712066168944"><span class="term "><code class="filename">/etc/apparmor/profiles/extras/</code>
    </span></dt><dd><p>
      A local repository of profiles shipped with <span class="phrase">AppArmor</span>, but not enabled
      by default.
     </p></dd><dt id="idm140712066166336"><span class="term "><code class="filename">/etc/apparmor.d/</code>
    </span></dt><dd><p>
      Location of profiles, named with the convention of replacing the
      <code class="literal">/</code> in paths with <code class="literal">.</code> (not for the
      root <code class="literal">/</code>) so profiles are easier to manage. For
      example, the profile for the program
      <code class="filename">/usr/sbin/smbd</code> is named
      <code class="filename">usr.sbin.smbd</code>.
     </p></dd><dt id="idm140712066161856"><span class="term "><code class="filename">/etc/apparmor.d/abstractions/</code>
    </span></dt><dd><p>
      Location of abstractions.
     </p></dd><dt id="idm140712066159744"><span class="term "><code class="filename">/etc/apparmor.d/program-chunks/</code>
    </span></dt><dd><p>
      Location of program chunks.
     </p></dd><dt id="idm140712066157616"><span class="term "><code class="filename">/proc/*/attr/current</code>
    </span></dt><dd><p>
      Check this file to review the confinement status of a process and the
      profile that is used to confine the process. The <code class="command">ps</code>
      <code class="option">auxZ</code> command retrieves this information
      automatically.
     </p></dd></dl></div></div></div><div class="chapter " id="cha.apparmor.hat"><div class="titlepage"><div><div><h2 class="title"><span class="number">26 </span><span class="name">Profiling Your Web Applications Using ChangeHat</span> <a title="Permalink" class="permalink" href="#cha.apparmor.hat">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_changehat.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.hat</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.hat.config"><span class="number">26.1 </span><span class="name">Configuring Apache for <code class="systemitem">mod_apparmor</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.hat.apache.managing"><span class="number">26.2 </span><span class="name">Managing ChangeHat-Aware Applications</span></a></span></dt></dl></div></div><p>
  An <span class="phrase">AppArmor®</span> profile represents the security policy for an individual
  program instance or process. It applies to an executable program, but if a
  portion of the program needs different access permissions than other
  portions, the program can <span class="quote">“<span class="quote">change hats</span>”</span> to use a different
  security context, distinctive from the access of the main program. This is
  known as a <span class="emphasis"><em>hat</em></span> or <span class="emphasis"><em>subprofile</em></span>.
 </p><p>
  ChangeHat enables programs to change to or from a <span class="emphasis"><em>hat</em></span>
  within an <span class="phrase">AppArmor</span> profile. It enables you to define security at a finer
  level than the process. This feature requires that each application be
  made <span class="quote">“<span class="quote">ChangeHat-aware</span>”</span>, meaning that it is modified to make a
  request to the <span class="phrase">AppArmor</span> module to switch security domains at specific times
  during the application execution. One example of a ChangeHat-aware
  application is the Apache Web server.
 </p><p>
  A profile can have an arbitrary number of subprofiles, but there are only
  two levels: a subprofile cannot have further child profiles. A subprofile
  is written as a separate profile. Its name consists of the name of the
  containing profile followed by the subprofile name, separated by a
  <code class="literal">^</code>.
 </p><p>
  Subprofiles are either stored in the same file as the parent profile, or
  in a separate file. The latter case is recommended on sites with many
  hats—it allows the policy caching to handle changes at
  the per hat level. If all the hats are in the same file as the parent
  profile, then the parent profile and all hats must be recompiled.
 </p><p>
  An external subprofile that is going to be used as a hat, must begin with
  the word <code class="literal">hat</code> or the <code class="literal">^</code> character.
 </p><p>
  The following two subprofiles <span class="emphasis"><em>cannot</em></span> be used as a
  hat:
 </p><div class="verbatim-wrap"><pre class="screen">/foo//bar { }</pre></div><p>
  or
 </p><div class="verbatim-wrap"><pre class="screen">profile /foo//bar { }</pre></div><p>
  While the following two are treated as hats:
 </p><div class="verbatim-wrap"><pre class="screen">^/foo//bar { }</pre></div><p>
  or
 </p><div class="verbatim-wrap"><pre class="screen">hat /foo//bar { } # this syntax is not highlighted in vim</pre></div><p>
  Note that the security of hats is considerably weaker than that of full
  profiles. Using certain types of bugs in a program, an attacker may be
  able to escape from a hat into the containing profile. This is because the
  security of hats is determined by a secret key handled by the containing
  process, and the code running in the hat must not have access to the key.
  Thus, change_hat is most useful with application servers,
  where a language interpreter (such as PERL, PHP, or Java) is isolating
  pieces of code such that they do not have direct access to the memory of
  the containing process.
 </p><p>
  The rest of this chapter describes using change_hat with
  Apache, to contain Web server components run using <code class="literal">mod_perl</code> and <code class="literal">mod_php</code>.
  Similar approaches can be used with any application server by providing an
  application module similar to the <code class="literal">mod_apparmor</code> described next in
  <a class="xref" href="#sec.apparmor.hat.config.directives" title="26.1.2. Location and Directory Directives">Section 26.1.2, “Location and Directory Directives”</a>.
 </p><div id="idm140712066133856" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: For More Information</h6><p>
   For more information, see the <code class="command">change_hat</code> man page.
  </p></div><div class="sect1 " id="sec.apparmor.hat.config"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.hat.config"><span class="number">26.1 </span><span class="name">Configuring Apache for <code class="systemitem">mod_apparmor</code></span> <a title="Permalink" class="permalink" href="#sec.apparmor.hat.config">#</a></h2></div></div></div><p>
   <span class="phrase">AppArmor</span> provides a <code class="literal">mod_apparmor</code> module (package <code class="systemitem">apache2-mod-apparmor</code>) for the Apache
   program. This module
   makes the Apache Web server ChangeHat aware. Install it along with Apache.
  </p><p>
   When Apache is ChangeHat-aware, it checks for the following customized
   <span class="phrase">AppArmor</span> security profiles in the order given for every URI request that
   it receives.
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     URI-specific hat. For example,
     <code class="filename">^www_app_name/templates/classic/images/bar_left.gif</code>
    </p></li><li class="listitem "><p>
     <code class="literal">DEFAULT_URI</code>
    </p></li><li class="listitem "><p>
     <code class="literal">HANDLING_UNTRUSTED_INPUT</code>
    </p></li></ul></div><div id="idm140712066122016" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Apache Configuration</h6><p>
    If you install
    <code class="systemitem">apache2-mod-apparmor</code>, make
    sure the module is enabled, and then restart Apache by executing the
    following command:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>a2enmod apparmor &amp;&amp; sudo systemctl reload apache2</pre></div></div><p>
   Apache is configured by placing directives in plain text configuration
   files. The main configuration file is usually
   <code class="filename">/etc/apache2/httpd.conf</code>. When you compile Apache,
   you can indicate the location of this file. Directives can be placed in
   any of these configuration files to alter the way Apache behaves. When
   you make changes to the main configuration files, you need to reload
   Apache with <code class="command">sudo systemctl reload apache2</code>, so
   the changes are recognized.
  </p><div class="sect2 " id="sec.apparmor.hat.config.vhost"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.hat.config.vhost"><span class="number">26.1.1 </span><span class="name">Virtual Host Directives</span> <a title="Permalink" class="permalink" href="#sec.apparmor.hat.config.vhost">#</a></h3></div></div></div><p>
    &lt;VirtualHost&gt; and &lt;/VirtualHost&gt; directives are used
    to enclose a group of directives that will apply only to a particular
    virtual host. For more information on Apache virtual host directives,
    refer to
    <a class="link" href="http://httpd.apache.org/docs/2.4/en/mod/core.html#virtualhost" target="_blank">http://httpd.apache.org/docs/2.4/en/mod/core.html#virtualhost</a>.
   </p><p>
    The ChangeHat-specific configuration keyword is
    <code class="literal">AADefaultHatName</code>. It is used similarly to
    <code class="literal">AAHatName</code>, for example, <code class="literal">AADefaultHatName
    My_Funky_Default_Hat</code>.
   </p><p>
    It allows you to specify a default hat to be used for virtual hosts and
    other Apache server directives, so that you can have different defaults
    for different virtual hosts. This can be overridden by the
    <code class="literal">AAHatName</code> directive and is checked for only if there
    is not a matching <code class="literal">AAHatName</code> or hat named by the URI.
    If the <code class="literal">AADefaultHatName</code> hat does not exist, it falls
    back to the <code class="literal">DEFAULT_URI</code> hat if it exists/
   </p><p>
    If none of those are matched, it goes back to the <span class="quote">“<span class="quote">parent</span>”</span>
    Apache hat.
   </p></div><div class="sect2 " id="sec.apparmor.hat.config.directives"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.hat.config.directives"><span class="number">26.1.2 </span><span class="name">Location and Directory Directives</span> <a title="Permalink" class="permalink" href="#sec.apparmor.hat.config.directives">#</a></h3></div></div></div><p>
    Location and directory directives specify hat names in the program
    configuration file so the Apache calls the hat regarding its security.
    For Apache, you can find documentation about the location and directory
    directives at
    <a class="link" href="http://httpd.apache.org/docs/2.4/en/sections.html" target="_blank">http://httpd.apache.org/docs/2.4/en/sections.html</a>.
   </p><p>
    The location directive example below specifies that, for a given
    location, <code class="literal">mod_apparmor</code> should use a specific hat:
   </p><div class="verbatim-wrap"><pre class="screen">&lt;Location /foo/&gt;
  AAHatName MY_HAT_NAME
&lt;/Location&gt;</pre></div><p>
    This tries to use <code class="literal">MY_HAT_NAME</code> for any URI beginning
    with <code class="filename">/foo/</code> (<code class="filename">/foo/</code>,
    <code class="filename">/foo/bar</code>,
    <code class="filename">/foo/cgi/path/blah_blah/blah</code>, etc.).
   </p><p>
    The directory directive works similarly to the location directive,
    except it refers to a path in the file system as in the following
    example:
   </p><div class="verbatim-wrap"><pre class="screen">&lt;Directory "/srv/www/www.example.org/docs"&gt;
  # Note lack of trailing slash
  AAHatName example.org
&lt;/Directory&gt;</pre></div></div></div><div class="sect1 " id="sec.apparmor.hat.apache.managing"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.hat.apache.managing"><span class="number">26.2 </span><span class="name">Managing ChangeHat-Aware Applications</span> <a title="Permalink" class="permalink" href="#sec.apparmor.hat.apache.managing">#</a></h2></div></div></div><p>
   In the previous section you learned about <code class="literal">mod_apparmor</code>
   and the way it helps you to secure a specific Web application. This
   section walks you through a real-life example of creating a hat for a Web
   application, and using <span class="phrase">AppArmor</span>'s change_hat feature to secure it.
   Note that this chapter focuses on <span class="phrase">AppArmor</span>'s command line tools, as
   YaST's <span class="phrase">AppArmor</span> module has limited functionality.
  </p><div class="sect2 " id="idm140712066097632"><div class="titlepage"><div><div><h3 class="title" id="idm140712066097632"><span class="number">26.2.1 </span><span class="name">With <span class="phrase">AppArmor</span>'s Command Line Tools</span> <a title="Permalink" class="permalink" href="#idm140712066097632">#</a></h3></div></div></div><p>
   For illustration purposes, let us choose the Web application called
   <span class="emphasis"><em>Adminer</em></span>
   (<a class="link" href="http://www.adminer.org/en/" target="_blank">http://www.adminer.org/en/</a>). It is a full-featured
   SQL database management tool written in PHP, yet consisting of a single
   PHP file. For Adminer to work, you need to set up an Apache Web server,
   PHP and its Apache module, and one of the database drivers available for
   PHP—MariaDB in this example. You can install the required
   packages with
  </p><div class="verbatim-wrap"><pre class="screen">zypper in apache2 apache2-mod_apparmor apache2-mod_php5 php5 php5-mysql</pre></div><p>
   To set up the Web environment for running Adminer, follow these steps:
  </p><div class="procedure " id="idm140712066093568"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 26.1: </span><span class="name">Setting Up a Web Server Environment </span><a title="Permalink" class="permalink" href="#idm140712066093568">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Make sure <code class="literal">apparmor</code> and <code class="literal">php5</code>
     modules are enabled for Apache. To enable the modules in any case, use:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>a2enmod apparmor php5</pre></div><p>
     and then restart Apache with
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl restart apache2</pre></div></li><li class="step "><p>
     Make sure MariaDB is running. If unsure, restart it with
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl restart mysql</pre></div></li><li class="step "><p>
     Download Adminer from <a class="link" href="http://www.adminer.org" target="_blank">http://www.adminer.org</a>, copy
     it to <code class="filename">/srv/www/htdocs/adminer/</code>, and rename it to
     <code class="filename">adminer.php</code>, so that its full path is
     <code class="filename">/srv/www/htdocs/adminer/adminer.php</code>.
    </p></li><li class="step "><p>
     Test Adminer in your Web browser by entering
     <code class="literal">http://localhost/adminer/adminer.php</code> in its URI
     address field. If you installed Adminer to a remote server, replace
     <code class="literal">localhost</code> with the real host name of the server.
    </p><div class="figure" id="idm140712066081408"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/aa_changehat_adminer.png"><img src="images/aa_changehat_adminer.png" width="" alt="Adminer Login Page" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 26.1: </span><span class="name">Adminer Login Page </span><a title="Permalink" class="permalink" href="#idm140712066081408">#</a></h6></div></div><div id="idm140712066076384" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p> If you encounter problems viewing the Adminer login page,
            try to look for help in the Apache error log
              <code class="filename">/var/log/apache2/error.log</code>. Another
            reason you cannot access the Web page may be
            that your Apache is already under <span class="phrase">AppArmor</span> control and its <span class="phrase">AppArmor</span>
            profile is too tight to permit viewing Adminer. Check it
            with <code class="command">aa-status</code>, and if needed, set Apache
            temporarily in complain mode with </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root">root # </code>sudo aa-complain usr.sbin.httpd2-prefork</pre></div></div></li></ol></div></div><p>
   After the Web environment for Adminer is ready, you need to configure
   Apache's <code class="literal">mod_apparmor</code>, so that <span class="phrase">AppArmor</span> can detect accesses to Adminer and
   change to the specific <span class="quote">“<span class="quote">hat</span>”</span>.
  </p><div class="procedure " id="idm140712066070080"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 26.2: </span><span class="name">Configuring <code class="literal">mod_apparmor</code> </span><a title="Permalink" class="permalink" href="#idm140712066070080">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Apache has several configuration files under
     <code class="filename">/etc/apache2/</code> and
     <code class="filename">/etc/apache2/conf.d/</code>. Choose your preferred one
     and open it in a text editor. In this example, the
     <code class="command">vim</code> editor is used to create a new configuration
     file <code class="filename">/etc/apache2/conf.d/apparmor.conf</code>.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> vim /etc/apache2/conf.d/apparmor.conf</pre></div></li><li class="step "><p>
     Copy the following snippet into the edited file.
    </p><div class="verbatim-wrap"><pre class="screen">&lt;Directory /srv/www/htdocs/adminer&gt;
  AAHatName adminer
&lt;/Directory&gt;</pre></div><p>
     It tells Apache to let <span class="phrase">AppArmor</span> know about a change_hat event when the
     Web user accesses the directory <code class="filename">/adminer</code> (and any
     file/directory inside) in Apache's document root. Remember, we placed
     the <code class="filename">adminer.php</code> application there.
    </p></li><li class="step "><p>
     Save the file, close the editor, and restart Apache with
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl restart apache2</pre></div></li></ol></div></div><p>
   Apache now knows about our Adminer and changing a <span class="quote">“<span class="quote">hat</span>”</span> for
   it. It is time to create the related hat for Adminer in the <span class="phrase">AppArmor</span>
   configuration. If you do not have an <span class="phrase">AppArmor</span> profile yet, create one
   before proceeding. Remember that if your Apache's main binary is
   <code class="filename">/usr/sbin/httpd2-prefork</code>, then the related profile
   is named <code class="filename">/etc/apparmor.d/usr.sbin.httpd2-prefork</code>.
  </p><div class="procedure " id="idm140712066056656"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 26.3: </span><span class="name">Creating a Hat for Adminer </span><a title="Permalink" class="permalink" href="#idm140712066056656">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Open (or create one if it does not exist) the file
     <code class="filename">/etc/apparmor.d/usr.sbin.httpd2-prefork</code> in a text
     editor. Its contents should be similar to the following:
    </p><div class="verbatim-wrap"><pre class="screen">#include &lt;tunables/global&gt;

/usr/sbin/httpd2-prefork {
  #include &lt;abstractions/apache2-common&gt;
  #include &lt;abstractions/base&gt;
  #include &lt;abstractions/php5&gt;

  capability kill,
  capability setgid,
  capability setuid,

  /etc/apache2/** r,
  /run/httpd.pid rw,
  /usr/lib{,32,64}/apache2*/** mr,
  /var/log/apache2/** rw,

  ^DEFAULT_URI {
    #include &lt;abstractions/apache2-common&gt;
    /var/log/apache2/** rw,
  }

  ^HANDLING_UNTRUSTED_INPUT {
    #include &lt;abstractions/apache2-common&gt;
    /var/log/apache2/** w,
  }
}</pre></div></li><li class="step "><p>
     Before the last closing curly bracket (<code class="literal">}</code>), insert
     the following section:
    </p><div class="verbatim-wrap"><pre class="screen">^adminer flags=(complain) {
}</pre></div><p>
     Note the <code class="literal">(complain)</code> addition after the hat
     name—it tells <span class="phrase">AppArmor</span> to leave the
     <code class="systemitem">adminer</code> hat in complain mode. That is because
     we need to learn the hat profile by accessing Adminer later on.
     
    </p></li><li class="step "><p>
     Save the file, and then restart <span class="phrase">AppArmor</span>, then Apache.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl reload apparmor apache2</pre></div></li><li class="step "><p>
     Check if the <code class="systemitem">adminer</code> hat really is in complain
     mode.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-status
apparmor module is loaded.
39 profiles are loaded.
37 profiles are in enforce mode.
[...]
   /usr/sbin/httpd2-prefork
   /usr/sbin/httpd2-prefork//DEFAULT_URI
   /usr/sbin/httpd2-prefork//HANDLING_UNTRUSTED_INPUT
[...]
2 profiles are in complain mode.
   /usr/bin/getopt
   /usr/sbin/httpd2-prefork//adminer
[...]</pre></div><p>
     As we can see, the <code class="literal">httpd2-prefork//adminer</code> is loaded
     in complain mode.
    </p></li></ol></div></div><p>
   Our last task is to find out the right set of rules for the
   <code class="systemitem">adminer</code> hat. That is why we set the
   <code class="systemitem">adminer</code> hat into complain mode—the
   logging facility collects useful information about the access
   requirements of <code class="filename">adminer.php</code> as we use it via the Web
   browser. <code class="command">aa-logprof</code> then helps us with creating the
   hat's profile.
  </p><div class="procedure " id="idm140712066040544"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 26.4: </span><span class="name">Generating Rules for the <code class="systemitem">adminer</code> Hat </span><a title="Permalink" class="permalink" href="#idm140712066040544">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Open Adminer in the Web browser. If you installed it locally, then the
     URI is <code class="literal">http://localhost/adminer/adminer.php</code>.
    </p></li><li class="step "><p>
     Choose the database engine you want to use (MariaDB in our case),
     and log in to Adminer using the existing database user name and
     password. You do not need to specify the database name as you can do so
     after logging in. Perform any operations with Adminer you
     like—create a new database, create a new table for it, set
     user privileges, and so on.
    </p></li><li class="step "><p>
     After the short testing of Adminer's user interface, switch back to
     console and examine the log for collected data.
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-logprof
Reading log entries from /var/log/messages.
Updating AppArmor profiles in /etc/apparmor.d.
Complain-mode changes:

Profile:  /usr/sbin/httpd2-prefork^adminer
Path:     /dev/urandom
Mode:     r
Severity: 3

  1 - #include &lt;abstractions/apache2-common&gt;
[...]
 [8 - /dev/urandom]

[(A)llow] / (D)eny / (G)lob / Glob w/(E)xt / (N)ew / Abo(r)t / (F)inish / (O)pts</pre></div><p>
     From the <code class="command">aa-logprof</code> message, it is clear that our
     new <code class="systemitem">adminer</code> hat was correctly detected:
    </p><div class="verbatim-wrap"><pre class="screen">Profile:  /usr/sbin/httpd2-prefork^adminer</pre></div><p>
     The <code class="command">aa-logprof</code> command will ask you to pick the
     right rule for each discovered <span class="phrase">AppArmor</span> event. Specify the one you want
     to use, and confirm with <span class="guimenu">Allow</span>. For more information
     on working with the <code class="command">aa-genprof</code> and
     <code class="command">aa-logprof</code> interface, see
     <a class="xref" href="#sec.apparmor.commandline.profiling.summary.genprof" title="25.7.3.8. aa-genprof—Generating Profiles">Section 25.7.3.8, “aa-genprof—Generating Profiles”</a>.
    </p><div id="idm140712066029136" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
      <code class="command">aa-logprof</code> usually offers several valid rules for
      the examined event. Some are
      <span class="emphasis"><em>abstractions</em></span>—predefined sets of rules
      affecting a specific common group of targets. Sometimes it is useful
      to include such an abstraction instead of a direct URI rule:
     </p><div class="verbatim-wrap"><pre class="screen"> 1 - #include &lt;abstractions/php5&gt;
 [2 - /var/lib/php5/sess_3jdmii9cacj1e3jnahbtopajl7p064ai242]</pre></div><p>
      In the example above, it is recommended hitting <span class="guimenu">1</span>
      and confirming with <span class="guimenu">A</span> to allow the abstraction.
     </p></div></li><li class="step "><p>
     After the last change, you will be asked to save the changed profile.
    </p><div class="verbatim-wrap"><pre class="screen">The following local profiles were changed. Would you like to save them?
 [1 - /usr/sbin/httpd2-prefork]

 (S)ave Changes / [(V)iew Changes] / Abo(r)t</pre></div><p>
     Hit <span class="guimenu">S</span> to save the changes.
    </p></li><li class="step "><p>
     Set the profile to enforce mode with <code class="command">aa-enforce</code>
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-enforce usr.sbin.httpd2-prefork</pre></div><p>
     and check its status with <code class="command">aa-status</code>
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aa-status
apparmor module is loaded.
39 profiles are loaded.
38 profiles are in enforce mode.
[...]
   /usr/sbin/httpd2-prefork
   /usr/sbin/httpd2-prefork//DEFAULT_URI
   /usr/sbin/httpd2-prefork//HANDLING_UNTRUSTED_INPUT
   /usr/sbin/httpd2-prefork//adminer
[...]</pre></div><p>
     As you can see, the <code class="literal">//adminer</code> hat jumped from
     <span class="emphasis"><em>complain</em></span> to <span class="emphasis"><em>enforce</em></span> mode.
    </p></li><li class="step "><p>
     Try to run Adminer in the Web browser, and if you encounter problems
     running it, switch it to the complain mode, repeat the steps that
     previously did not work well, and update the profile with
     <code class="command">aa-logprof</code> until you are satisfied with the
     application's functionality.
    </p></li></ol></div></div><div id="idm140712066014400" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Hat and Parent Profile Relationship</h6><p>
    The profile <code class="filename">^adminer</code> is only available in the
    context of a process running under the parent profile
    <code class="filename">usr.sbin.httpd2-prefork</code>.
   </p></div></div><div class="sect2 " id="sec.apparmor.hat.apache.managing.add"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.hat.apache.managing.add"><span class="number">26.2.2 </span><span class="name">Adding Hats and Entries to Hats in YaST</span> <a title="Permalink" class="permalink" href="#sec.apparmor.hat.apache.managing.add">#</a></h3></div></div></div><p>
    When you use the <span class="guimenu">Edit Profile</span> dialog (for
    instructions, refer to
    <a class="xref" href="#sec.apparmor.yast.edit" title="24.2. Editing Profiles">Section 24.2, “Editing Profiles”</a>) or
    when you add a new profile using <span class="guimenu">Manually Add Profile</span>
    (for instructions, refer to
    <a class="xref" href="#sec.apparmor.yast.add" title="24.1. Manually Adding a Profile">Section 24.1, “Manually Adding a Profile”</a>),
    you are given the option of adding hats (subprofiles) to your <span class="phrase">AppArmor</span>
    profiles. Add a ChangeHat subprofile from the <span class="guimenu"><span class="phrase">AppArmor</span> Profile
    Dialog</span> window as in the following.
   </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/hats_in_profiles.png"><img src="images/hats_in_profiles.png" width="" alt="AppArmor profile dialog" /></a></div></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      From the <span class="guimenu"><span class="phrase">AppArmor</span> Profile Dialog</span> window, click
      <span class="guimenu">Add Entry</span> then select <span class="guimenu">Hat</span>. The
      <span class="guimenu">EnterHat Name</span> dialog opens:
     </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/hat_createhat.png"><img src="images/hat_createhat.png" width="" alt="Enter hat name" /></a></div></div></li><li class="step "><p>
      Enter the name of the hat to add to the <span class="phrase">AppArmor</span> profile. The name is
      the URI that, when accessed, receives the permissions set in the hat.
     </p></li><li class="step "><p>
      Click <span class="guimenu">Create Hat</span>. You are returned to the
      <span class="guimenu"><span class="phrase">AppArmor</span> Profile Dialog</span> screen.
     </p></li><li class="step "><p>
      After adding the new hat, click <span class="guimenu">Done</span>.
     </p></li></ol></div></div></div></div></div><div class="chapter " id="cha.apparmor.pam"><div class="titlepage"><div><div><h2 class="title"><span class="number">27 </span><span class="name">Confining Users with <code class="systemitem">pam_apparmor</code></span> <a title="Permalink" class="permalink" href="#cha.apparmor.pam">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_pam.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.pam</li></ul></div></div></div></div><div class="line"></div><p>
  An <span class="phrase">AppArmor</span> profile applies to an executable program; if a portion of the
  program needs different access permissions than other portions need, the
  program can change hats via change_hat to a different role, also known as
  a subprofile. The <code class="systemitem">pam_apparmor</code> PAM module allows
  applications to confine authenticated users into subprofiles based on
  group names, user names, or a default profile. To accomplish this,
  <code class="systemitem">pam_apparmor</code> needs to be registered as a PAM
  session module.
 </p><p>
  The package <code class="systemitem">pam_apparmor</code> is not installed by
  default, you can install it using YaST or <code class="command">zypper</code>.
  Details about how to set up and configure
  <code class="systemitem">pam_apparmor</code> can be found in
  <code class="filename">/usr/share/doc/packages/pam_apparmor/README</code> after the
  package has been installed. For details on PAM, refer to
  <a class="xref" href="#cha.pam" title="Chapter 2. Authentication with PAM">Chapter 2, <em>Authentication with PAM</em></a>.
 </p></div><div class="chapter " id="cha.apparmor.managing"><div class="titlepage"><div><div><h2 class="title"><span class="number">28 </span><span class="name">Managing Profiled Applications</span> <a title="Permalink" class="permalink" href="#cha.apparmor.managing">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_managing.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.managing</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.managing.react"><span class="number">28.1 </span><span class="name">Reacting to Security Event Rejections</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.managing.maintain"><span class="number">28.2 </span><span class="name">Maintaining Your Security Profiles</span></a></span></dt></dl></div></div><p>
  After creating profiles and immunizing your applications,
  <span class="productname"><span class="phrase">openSUSE® Leap</span></span> becomes more efficient and better protected as long as
  you perform <span class="phrase">AppArmor®</span> profile maintenance (which involves analyzing log
  files, refining your profiles, backing up your set of profiles and keeping
  it up-to-date). You can deal with these issues before they become a
  problem by setting up event notification by e-mail, updating profiles from
  system log entries by running the aa-logprof tool, and dealing with
  maintenance issues.
 </p><div class="sect1 " id="sec.apparmor.managing.react"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.managing.react"><span class="number">28.1 </span><span class="name">Reacting to Security Event Rejections</span> <a title="Permalink" class="permalink" href="#sec.apparmor.managing.react">#</a></h2></div></div></div><p>
   When you receive a security event rejection, examine the access violation
   and determine if that event indicated a threat or was part of normal
   application behavior. Application-specific knowledge is required to make
   the determination. If the rejected action is part of normal application
   behavior, run <code class="command">aa-logprof</code> at the command line.
  </p><p>
   If the rejected action is not part of normal application behavior, this
   access should be considered a possible intrusion attempt (that was
   prevented) and this notification should be passed to the person
   responsible for security within your organization.
  </p></div><div class="sect1 " id="sec.apparmor.managing.maintain"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.managing.maintain"><span class="number">28.2 </span><span class="name">Maintaining Your Security Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.managing.maintain">#</a></h2></div></div></div><p>
   In a production environment, you should plan on maintaining profiles for
   all of the deployed applications. The security policies are an integral
   part of your deployment. You should plan on taking steps to back up and
   restore security policy files, plan for software changes, and allow any
   needed modification of security policies that your environment dictates.
  </p><div class="sect2 " id="sec.apparmor.managing.maintain.backup"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.managing.maintain.backup"><span class="number">28.2.1 </span><span class="name">Backing Up Your Security Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.managing.maintain.backup">#</a></h3></div></div></div><p>
    Backing up profiles might save you from having to re-profile all your
    programs after a disk crash. Also, if profiles are changed, you can
    easily restore previous settings by using the backed up files.
   </p><p>
    Back up profiles by copying the profile files to a specified directory.
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      You should first archive the files into one file. To do this, open a
      terminal window and enter the following as <code class="systemitem">root</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> tar zclpf profiles.tgz /etc/apparmor.d</pre></div><p>
      The simplest method to ensure that your security policy files are
      regularly backed up is to include the directory
      <code class="filename">/etc/apparmor.d</code> in the list of directories that
      your backup system archives.
     </p></li><li class="step "><p>
      You can also use <code class="command">scp</code> or a file manager like
      Nautilus to store the files on some kind of storage media, the
      network, or another computer.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.apparmor.managing.maintain.change"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.managing.maintain.change"><span class="number">28.2.2 </span><span class="name">Changing Your Security Profiles</span> <a title="Permalink" class="permalink" href="#sec.apparmor.managing.maintain.change">#</a></h3></div></div></div><p>
    Maintenance of security profiles includes changing them if you decide
    that your system requires more or less security for its applications. To
    change your profiles in <span class="phrase">AppArmor</span>, refer to
    <a class="xref" href="#sec.apparmor.yast.edit" title="24.2. Editing Profiles">Section 24.2, “Editing Profiles”</a>.
   </p></div><div class="sect2 " id="sec.apparmor.managing.maintain.change.new_software"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.managing.maintain.change.new_software"><span class="number">28.2.3 </span><span class="name">Introducing New Software into Your Environment</span> <a title="Permalink" class="permalink" href="#sec.apparmor.managing.maintain.change.new_software">#</a></h3></div></div></div><p>
    When you add a new application version or patch to your system, you
    should always update the profile to fit your needs. You have several
    options, depending on your company's software deployment strategy. You
    can deploy your patches and upgrades into a test or production
    environment. The following explains how to do this with each method.
   </p><p>
    If you intend to deploy a patch or upgrade in a test environment, the
    best method for updating your profiles is to run
    <code class="command">aa-logprof</code> in a terminal as <code class="systemitem">root</code>. For
    detailed instructions, refer to
    <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>.
   </p><p>
    If you intend to deploy a patch or upgrade directly into a production
    environment, the best method for updating your profiles is to monitor
    the system frequently to determine if any new rejections should be added
    to the profile and update as needed using <code class="command">aa-logprof</code>.
    For detailed instructions, refer to
    <a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>.
   </p></div></div></div><div class="chapter " id="cha.apparmor.support"><div class="titlepage"><div><div><h2 class="title"><span class="number">29 </span><span class="name">Support</span> <a title="Permalink" class="permalink" href="#cha.apparmor.support">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_support.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.support</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.apparmor.support.updating"><span class="number">29.1 </span><span class="name">Updating <span class="phrase">AppArmor</span> Online</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.man"><span class="number">29.2 </span><span class="name">Using the Man Pages</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.info"><span class="number">29.3 </span><span class="name">For More Information</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.trouble"><span class="number">29.4 </span><span class="name">Troubleshooting</span></a></span></dt><dt><span class="sect1"><a href="#sec.apparmor.support.bugs"><span class="number">29.5 </span><span class="name">Reporting Bugs for <span class="phrase">AppArmor</span></span></a></span></dt></dl></div></div><p>
  This chapter outlines maintenance-related tasks. Learn how to update
  <span class="phrase">AppArmor®</span> and get a list of available man pages providing basic help for
  using the command line tools provided by <span class="phrase">AppArmor</span>. Use the troubleshooting
  section to learn about some common problems encountered with <span class="phrase">AppArmor</span> and
  their solutions. Report defects or enhancement requests for <span class="phrase">AppArmor</span>
  following the instructions in this chapter.
 </p><div class="sect1 " id="sec.apparmor.support.updating"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.support.updating"><span class="number">29.1 </span><span class="name">Updating <span class="phrase">AppArmor</span> Online</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.updating">#</a></h2></div></div></div><p>
   Updates for <span class="phrase">AppArmor</span> packages are provided in the same way as any other
   update for <span class="productname"><span class="phrase">openSUSE Leap</span></span>. Retrieve and apply them exactly like for any
   other package that ships as part of <span class="productname"><span class="phrase">openSUSE Leap</span></span>.
  </p></div><div class="sect1 " id="sec.apparmor.support.man"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.support.man"><span class="number">29.2 </span><span class="name">Using the Man Pages</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.man">#</a></h2></div></div></div><p>
   There are man pages available for your use. In a terminal, enter
   <code class="command">man apparmor</code> to open the <span class="phrase">AppArmor</span> man page. Man pages
   are distributed in sections numbered 1 through 8. Each section is
   specific to a category of documentation:
  </p><div class="table" id="idm140712065932192"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 29.1: </span><span class="name">Man Pages: Sections and Categories </span><a title="Permalink" class="permalink" href="#idm140712065932192">#</a></h6></div><div class="table-contents"><table summary="Man Pages: Sections and Categories" border="1"><colgroup><col /><col /></colgroup><thead><tr><th>
       <p>
        Section
       </p>
      </th><th>
       <p>
        Category
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        1
       </p>
      </td><td>
       <p>
        User commands
       </p>
      </td></tr><tr><td>
       <p>
        2
       </p>
      </td><td>
       <p>
        System calls
       </p>
      </td></tr><tr><td>
       <p>
        3
       </p>
      </td><td>
       <p>
        Library functions
       </p>
      </td></tr><tr><td>
       <p>
        4
       </p>
      </td><td>
       <p>
        Device driver information
       </p>
      </td></tr><tr><td>
       <p>
        5
       </p>
      </td><td>
       <p>
        Configuration file formats
       </p>
      </td></tr><tr><td>
       <p>
        6
       </p>
      </td><td>
       <p>
        Games
       </p>
      </td></tr><tr><td>
       <p>
        7
       </p>
      </td><td>
       <p>
        High level concepts
       </p>
      </td></tr><tr><td>
       <p>
        8
       </p>
      </td><td>
       <p>
        Administrator commands
       </p>
      </td></tr></tbody></table></div></div><p>
   The section numbers are used to distinguish man pages from each other.
   For example, <code class="systemitem">exit(2)</code> describes the exit system
   call, while <code class="systemitem">exit(3)</code> describes the exit C library
   function.
  </p><p>
   The <span class="phrase">AppArmor</span> man pages are:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <code class="systemitem">aa-audit(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-autodep(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-complain(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-decode(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-disable(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-easyprof(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-enforce(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-enxec(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-genprof(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-logprof(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-notify(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-status(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa-unconfined(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">aa_change_hat(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">logprof.conf(5)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor.d(5)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor.vim(5)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor(7)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor_parser(8)</code>
    </p></li><li class="listitem "><p>
     <code class="systemitem">apparmor_status(8)</code>
    </p></li></ul></div></div><div class="sect1 " id="sec.apparmor.support.info"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.support.info"><span class="number">29.3 </span><span class="name">For More Information</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.info">#</a></h2></div></div></div><p>
   Find more information about the <span class="phrase">AppArmor</span> product at:
   <a class="link" href="http://wiki.apparmor.net" target="_blank">http://wiki.apparmor.net</a>. Find the product
   documentation for <span class="phrase">AppArmor</span> in the installed system at
   <code class="filename">/usr/share/doc/manual</code>.
  </p><p>
   There is a mailing list for <span class="phrase">AppArmor</span> that users can post to or join to
   communicate with developers. See
   <a class="link" href="https://lists.ubuntu.com/mailman/listinfo/apparmor" target="_blank">https://lists.ubuntu.com/mailman/listinfo/apparmor</a>
   for details.
  </p></div><div class="sect1 " id="sec.apparmor.support.trouble"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.support.trouble"><span class="number">29.4 </span><span class="name">Troubleshooting</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble">#</a></h2></div></div></div><p>
   This section lists the most common problems and error messages that may
   occur using <span class="phrase">AppArmor</span>.
  </p><div class="sect2 " id="sec.apparmor.support.trouble.odd"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.odd"><span class="number">29.4.1 </span><span class="name">How to React to odd Application Behavior?</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.odd">#</a></h3></div></div></div><p>
    If you notice odd application behavior or any other type of application
    problem, you should first check the reject messages in the log files to
    see if <span class="phrase">AppArmor</span> is too closely constricting your application. If you
    detect reject messages that indicate that your application or service is
    too closely restricted by <span class="phrase">AppArmor</span>, update your profile to properly
    handle your use case of the application. Do this with
    <code class="command">aa-logprof</code>
    (<a class="xref" href="#sec.apparmor.commandline.profiling.summary.logprof" title="25.7.3.9. aa-logprof—Scanning the System Log">Section 25.7.3.9, “aa-logprof—Scanning the System Log”</a>).
   </p><p>
    If you decide to run your application or service without <span class="phrase">AppArmor</span>
    protection, remove the application's profile from
    <code class="filename">/etc/apparmor.d</code> or move it to another location.
   </p></div><div class="sect2 " id="sec.apparmor.support.trouble.dirpath"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.dirpath"><span class="number">29.4.2 </span><span class="name">My Profiles Do not Seem to Work Anymore …</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.dirpath">#</a></h3></div></div></div><p>
    If you have been using previous versions of <span class="phrase">AppArmor</span> and have updated
    your system (but kept your old set of profiles) you might notice some
    applications which seemed to work perfectly before you updated behaving
    strangely, or not working.
   </p><p>
    This version of <span class="phrase">AppArmor</span> introduces a set of new features to the profile
    syntax and the <span class="phrase">AppArmor</span> tools that might cause trouble with older
    versions of the <span class="phrase">AppArmor</span> profiles. Those features are:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      File Locking
     </p></li><li class="listitem "><p>
      Network Access Control
     </p></li><li class="listitem "><p>
      The <code class="literal">SYS_PTRACE</code> Capability
     </p></li><li class="listitem "><p>
      Directory Path Access
     </p></li></ul></div><p>
    The current version of <span class="phrase">AppArmor</span> mediates file locking and introduces a
    new permission mode (<code class="literal">k</code>) for this. Applications
    requesting file locking permission might misbehave or fail altogether if
    confined by older profiles which do not explicitly contain permissions
    to lock files. If you suspect this being the case, check the log file
    under <code class="filename">/var/log/audit/audit.log</code> for entries like the
    following:
   </p><div class="verbatim-wrap"><pre class="screen">type=AVC msg=audit(1389862802.727:13939): apparmor="DENIED" \
operation="file_lock" parent=2692 profile="/usr/bin/opera" \
name="/home/tux/.qt/.qtrc.lock" pid=28730 comm="httpd2-prefork" \
requested_mask="::k" denied_mask="::k" fsuid=30 ouid=0</pre></div><p>
    Update the profile using the <code class="command">aa-logprof</code> command as
    outlined below.
   </p><p>
    The new network access control syntax based on the network family and
    type specification, described in
    <a class="xref" href="#sec.apparmor.profiles.nac" title="22.5. Network Access Control">Section 22.5, “Network Access Control”</a>, might cause application
    misbehavior or even stop applications from working. If you notice a
    network-related application behaving strangely, check the log file under
    <code class="filename">/var/log/audit/audit.log</code> for entries like the
    following:
   </p><div class="verbatim-wrap"><pre class="screen">type=AVC msg=audit(1389864332.233:13947): apparmor="DENIED" \
operation="socket_create" family="inet" parent=29985 profile="/bin/ping" \
sock_type="raw" pid=30251 comm="ping"</pre></div><p>
    This log entry means that our example application,
    <code class="command">/bin/ping</code> in this case, failed to get <span class="phrase">AppArmor</span>'s
    permission to open a network connection. This permission needs to be
    explicitly stated to make sure that an application has network access.
    To update the profile to the new syntax, use the
    <code class="command">aa-logprof</code> command as outlined below.
   </p><p>
    The current kernel requires the <code class="literal">SYS_PTRACE</code>
    capability, if a process tries to access files in
    <code class="filename">/proc/<em class="replaceable ">PID</em>/fd/*</code>. New
    profiles need an entry for the file and the capability, where old
    profiles only needed the file entry. For example:
   </p><div class="verbatim-wrap"><pre class="screen">/proc/*/fd/**  rw,</pre></div><p>
    in the old syntax would translate to the following rules in the new
    syntax:
   </p><div class="verbatim-wrap"><pre class="screen">capability SYS_PTRACE,
/proc/*/fd/**  rw,</pre></div><p>
    To update the profile to the new syntax, use the YaST Update
    Profile Wizard or the <code class="command">aa-logprof</code> command as outlined
    below.
   </p><p>
    With this version of <span class="phrase">AppArmor</span>, a few changes have been made to the
    profile rule syntax to better distinguish directory from file access.
    Therefore, some rules matching both file and directory paths in the
    previous version might now match a file path only. This could lead to
    <span class="phrase">AppArmor</span> not being able to access a crucial directory, and thus
    trigger misbehavior of your application and various log messages. The
    following examples highlight the most important changes to the path
    syntax.
   </p><p>
    Using the old syntax, the following rule would allow access to files and
    directories in <code class="filename">/proc/net</code>. It would allow directory
    access only to read the entries in the directory, but not give access to
    files or directories under the directory, for example
    <code class="filename">/proc/net/dir/foo</code> would be matched by the asterisk
    (*), but as <code class="filename">foo</code> is a file or directory under
    <code class="filename">dir</code>, it cannot be accessed.
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/*  r,</pre></div><p>
    To get the same behavior using the new syntax, you need two rules
    instead of one. The first allows access to the file under
    <code class="filename">/proc/net</code> and the second allows access to
    directories under <code class="filename">/proc/net</code>. Directory access can
    only be used for listing the contents, not actually accessing files or
    directories underneath the directory.
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/*  r,
/proc/net/*/  r,</pre></div><p>
    The following rule works similarly both under the old and the new
    syntax, and allows access to both files and directories under
    <code class="filename">/proc/net</code> (but does not allow a directory listing
    of <code class="filename">/proc/net/</code> itself):
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/**  r,</pre></div><p>
    To distinguish file access from directory access using the above
    expression in the new syntax, use the following two rules. The first one
    only allows to recursively access directories under
    <code class="filename">/proc/net</code> while the second one explicitly allows
    for recursive file access only.
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/**/  r,
/proc/net/**[^/]  r,</pre></div><p>
    The following rule works similarly both under the old and the new syntax
    and allows access to both files and directories beginning with
    <code class="literal">foo</code> under <code class="filename">/proc/net</code>:
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/foo**  r,</pre></div><p>
    To distinguish file access from directory access in the new syntax and
    use the <code class="literal">**</code> globbing pattern, use the following two
    rules. The first one would have matched both files and directories in
    the old syntax, but only matches files in the new syntax because of the
    missing trailing slash. The second rule matched neither file nor
    directory in the old syntax, but matches directories only in the new
    syntax:
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/**foo  r,
/proc/net/**foo/  r,</pre></div><p>
    The following rules illustrate how the use of the <code class="literal">?</code>
    globbing pattern has changed. In the old syntax, the first rule would
    have matched both files and directories (four characters, last character
    could be any but a slash). In the new syntax, it matches only files
    (trailing slash is missing). The second rule would match nothing in the
    old profile syntax, but matches directories only in the new syntax. The
    last rule matches explicitly matches a file called
    <code class="filename">bar</code> under <code class="filename">/proc/net/foo?</code>.
    Using the old syntax, this rule would have applied to both files and
    directories:
   </p><div class="verbatim-wrap"><pre class="screen">/proc/net/foo?  r,
/proc/net/foo?/  r,
/proc/net/foo?/bar  r,</pre></div><p>
    To find and resolve issues related to syntax changes, take some time
    after the update to check the profiles you want to keep and proceed as
    follows for each application you kept the profile for:
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Put the application's profile into complain mode:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aa-complain</code> <code class="option"><em class="replaceable ">/path/to/application</em></code></pre></div><p>
      Log entries are made for any actions violating the current profile,
      but the profile is not enforced and the application's behavior not
      restricted.
     </p></li><li class="step "><p>
      Run the application covering all the tasks you need this application
      to be able to perform.
     </p></li><li class="step "><p>
      Update the profile according to the log entries made while running the
      application:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aa-logprof</code> <code class="option"><em class="replaceable ">/path/to/application</em></code></pre></div></li><li class="step "><p>
      Put the resulting profile back into enforce mode:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aa-enforce</code> <code class="option"><em class="replaceable ">/path/to/application</em></code></pre></div></li></ol></div></div></div><div class="sect2 " id="sec.apparmor.support.trouble.apache"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.apache"><span class="number">29.4.3 </span><span class="name">Resolving Issues with Apache</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.apache">#</a></h3></div></div></div><p>
    After installing additional Apache modules (like
    <code class="literal">apache2-mod_apparmor</code>) or making configuration changes
    to Apache, profile Apache again to find out if additional rules need to
    be added to the profile. If you do not profile Apache again, it could be
    unable to start properly or be unable to serve Web pages.
   </p></div><div class="sect2 " id="sec.apparmor.support.trouble.ex"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.ex"><span class="number">29.4.4 </span><span class="name">How to Exclude Certain Profiles from the List of Profiles Used?</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.ex">#</a></h3></div></div></div><p>
    Run <code class="command">aa-disable</code>
    <code class="option"><em class="replaceable ">PROGRAMNAME</em></code> to disable the
    profile for <em class="replaceable ">PROGRAMNAME</em>. This command creates
    a symbolic link to the profile in
    <code class="filename">/etc/apparmor.d/disable/</code>. To reactivate
    the profile, delete the link, and run <code class="command">systemctl reload
    apparmor</code>.
   </p></div><div class="sect2 " id="sec.apparmor.support.trouble.remote"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.remote"><span class="number">29.4.5 </span><span class="name">Can I Manage Profiles for Applications not Installed on my System?</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.remote">#</a></h3></div></div></div><p>
    Managing profiles with <span class="phrase">AppArmor</span> requires you to have access to the log of
    the system on which the application is running. So you do not need to
    run the application on your profile build host as long as you have
    access to the machine that runs the application. You can run the
    application on one system, transfer the logs
    (<code class="filename">/var/log/audit.log</code> or, if
    <code class="filename">audit</code> is not installed, <code class="command">journalctl | grep
    -i apparmor &gt; path_to_logfile</code>) to your profile build host
    and run <code class="command">aa-logprof -f</code>
    <em class="replaceable ">PATH_TO_LOGFILE</em>.
   </p></div><div class="sect2 " id="sec.apparmor.support.trouble.syntax"><div class="titlepage"><div><div><h3 class="title" id="sec.apparmor.support.trouble.syntax"><span class="number">29.4.6 </span><span class="name">How to Spot and fix <span class="phrase">AppArmor</span> Syntax Errors?</span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.trouble.syntax">#</a></h3></div></div></div><p>
    Manually editing <span class="phrase">AppArmor</span> profiles can introduce syntax errors. If you
    attempt to start or restart <span class="phrase">AppArmor</span> with syntax errors in your profiles,
    error results are shown. This example shows the syntax of the entire
    parser error.
   </p><div class="verbatim-wrap"><pre class="screen">localhost:~ # rcapparmor start
Loading AppArmor profiles AppArmor parser error in /etc/apparmor.d/usr.sbin.squid at line 410: syntax error, unexpected TOK_ID, expecting TOK_MODE
 Profile /etc/apparmor.d/usr.sbin.squid failed to load</pre></div><p>
    Using the <span class="phrase">AppArmor</span> YaST tools, a graphical error message indicates
    which profile contained the error and requests you to fix it.
   </p><div class="informalfigure"><div class="mediaobject"><a xmlns="" href="images/aa_syncheck.png"><img src="images/aa_syncheck.png" width="" /></a></div></div><p>
    To fix a syntax error, log in to a terminal window as <code class="systemitem">root</code>,
    open the profile, and correct the syntax. Reload the profile set with
    <code class="command">systemctl reload apparmor</code>.
   </p><div id="idm140712065792224" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: <span class="phrase">AppArmor</span> Syntax Highlighting in <code class="literal">vi</code></h6><p>
     The editor <code class="literal">vi</code> on <span class="productname"><span class="phrase">openSUSE Leap</span></span> supports syntax
     highlighting for <span class="phrase">AppArmor</span> profiles. Lines containing syntax errors will
     be displayed with a red background.
    </p></div></div></div><div class="sect1 " id="sec.apparmor.support.bugs"><div class="titlepage"><div><div><h2 class="title" id="sec.apparmor.support.bugs"><span class="number">29.5 </span><span class="name">Reporting Bugs for <span class="phrase">AppArmor</span></span> <a title="Permalink" class="permalink" href="#sec.apparmor.support.bugs">#</a></h2></div></div></div><p>
   The developers of <span class="phrase">AppArmor</span> are eager to deliver products of the highest
   quality. Your feedback and your bug reports help us keep the quality
   high. Whenever you encounter a bug in <span class="phrase">AppArmor</span>, file a bug report against
   this product:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Use your Web browser to go to <a class="link" href="http://bugzilla.opensuse.org/" target="_blank">http://bugzilla.opensuse.org/</a> and click <span class="guimenu">Log
     In</span>.
    </p></li><li class="step "><p>
     Enter the account data of your SUSE account and click
     <span class="guimenu">Login</span>. If you do not have a SUSE account, click
     <span class="guimenu">Create Account</span> and provide the required data.
    </p></li><li class="step "><p>
     If your problem has already been reported, check this bug report and
     add extra information to it, if necessary.
    </p></li><li class="step "><p>
     If your problem has not been reported yet, select
     <span class="guimenu">New</span> from the top navigation bar and proceed to the
     <span class="guimenu">Enter Bug</span> page.
    </p></li><li class="step "><p>
     Select the product against which to file the bug. In your case, this
     would be your product's release. Click <span class="guimenu">Submit</span>.
    </p></li><li class="step "><p>
     Select the product version, component (<span class="phrase">AppArmor</span> in this case), hardware
     platform, and severity.
    </p></li><li class="step "><p>
     Enter a brief headline describing your problem and add a more elaborate
     description including log files. You may create attachments to your bug
     report for screenshots, log files, or test cases.
    </p></li><li class="step "><p>
     Click <span class="guimenu">Submit</span> after you have entered all the details
     to send your report to the developers.
    </p></li></ol></div></div></div></div><div class="chapter " id="cha.apparmor.glossary"><div class="titlepage"><div><div><h2 class="title"><span class="number">30 </span><span class="name"><span class="phrase">AppArmor</span> Glossary</span> <a title="Permalink" class="permalink" href="#cha.apparmor.glossary">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>apparmor_glossary.xml</li><li><span class="ds-label">ID: </span>cha.apparmor.glossary</li></ul></div></div></div></div><div class="line"></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712065767808"><span class="term ">Abstraction</span></dt><dd><p>
     See <span class="emphasis"><em>profile foundation classes</em></span> below.
    </p></dd><dt id="idm140712065765552"><span class="term ">Apache</span></dt><dd><p>
     Apache is a freely-available Unix-based Web server. It is currently the
     most commonly used Web server on the Internet. Find more information
     about Apache at the Apache Web site at
     <a class="link" href="http://www.apache.org" target="_blank">http://www.apache.org</a>.
    </p></dd><dt id="idm140712065763008"><span class="term ">application fire-walling</span></dt><dd><p>
     <span class="phrase">AppArmor</span> confines applications and limits the actions they are permitted
     to take. It uses privilege confinement to prevent attackers from using
     malicious programs on the protected server and even using trusted
     applications in unintended ways.
    </p></dd><dt id="idm140712065760512"><span class="term ">attack signature</span></dt><dd><p>
     Pattern in system or network activity that alerts of a possible virus
     or hacker attack. Intrusion detection systems might use attack
     signatures to distinguish between legitimate and potentially malicious
     activity.
    </p><p>
     By not relying on attack signatures, <span class="phrase">AppArmor</span> provides "proactive"
     instead of "reactive" defense from attacks. This is better because
     there is no window of vulnerability where the attack signature must be
     defined for <span class="phrase">AppArmor</span> as it does for products using attack signatures.
    </p></dd><dt id="idm140712065756912"><span class="term ">GUI</span></dt><dd><p>
     Graphical user interface. Refers to a software front-end meant to
     provide an attractive and easy-to-use interface between a computer user
     and application. Its elements include windows, icons, buttons, cursors,
     and scrollbars.
    </p></dd><dt id="idm140712065754880"><span class="term ">globbing</span></dt><dd><p>
     File name substitution. Instead of specifying explicit file name paths,
     you can use helper characters <code class="literal">*</code> (substitutes any
     number of characters except special ones such as <code class="literal">/</code>
     or <code class="literal">?</code>) and <code class="literal">?</code> (substitutes exactly
     one character) to address multiple files/directories at once.
     <code class="literal">**</code> is a special substitution that matches any file
     or directory below the current directory.
    </p></dd><dt id="idm140712065750528"><span class="term ">HIP</span></dt><dd><p>
     Host intrusion prevention. Works with the operating system kernel to
     block abnormal application behavior in the expectation that the
     abnormal behavior represents an unknown attack. Blocks malicious
     packets on the host at the network level before they can
     <span class="quote">“<span class="quote">hurt</span>”</span> the application they target.
    </p></dd><dt id="idm140712065748000"><span class="term ">mandatory access control</span></dt><dd><p>
     A means of restricting access to objects that is based on fixed
     security attributes assigned to users, files, and other objects. The
     controls are mandatory in the sense that they cannot be modified by
     users or their programs.
    </p></dd><dt id="idm140712065745952"><span class="term ">profile</span></dt><dd><p>
     <span class="phrase">AppArmor</span> profile completely defines what system resources an individual
     application can access, and with what privileges.
    </p></dd><dt id="idm140712065743600"><span class="term ">profile foundation classes</span></dt><dd><p>
     Profile building blocks needed for common application activities, such
     as DNS lookup and user authentication.
    </p></dd><dt id="idm140712065741680"><span class="term ">RPM</span></dt><dd><p>
     The RPM Package Manager. An open packaging system available for anyone
     to use. It works on Red Hat Linux, <span class="productname"><span class="phrase">openSUSE Leap</span></span>, and other Linux
     and Unix systems. It is capable of installing, uninstalling, verifying,
     querying, and updating computer software packages. See
     <a class="link" href="http://www.rpm.org/" target="_blank">http://www.rpm.org/</a> for more information.
    </p></dd><dt id="idm140712065737952"><span class="term ">SSH</span></dt><dd><p>
     Secure Shell. A service that allows you to access your server from a
     remote computer and issue text commands through a secure connection.
    </p></dd><dt id="idm140712065736016"><span class="term ">streamlined access control</span></dt><dd><p>
     <span class="phrase">AppArmor</span> provides streamlined access control for network services by
     specifying which files each program is allowed to read, write, and
     execute. This ensures that each program does what it is supposed to do
     and nothing else.
    </p></dd><dt id="idm140712065733536"><span class="term ">URI</span></dt><dd><p>
     Universal resource identifier. The generic term for all types of names
     and addresses that refer to objects on the World Wide Web. A URL is one
     kind of URI.
    </p></dd><dt id="idm140712065731584"><span class="term ">URL</span></dt><dd><p>
     Uniform Resource Locator. The global address of documents and other
     resources on the Web.
    </p><p>
     The first part of the address indicates what protocol to use and the
     second part specifies the IP address or the domain name where the
     resource is located.
    </p><p>
     For example, when you visit <span class="phrase"><code class="literal">http://www.opensuse.org</code></span>, you are
     using the HTTP protocol, as the beginning of the URL indicates.
    </p></dd><dt id="idm140712065727712"><span class="term ">vulnerabilities</span></dt><dd><p>
     An aspect of a system or network that leaves it open to attack.
     Characteristics of computer systems that allow an individual to keep it
     from correctly operating or that allows unauthorized users to take
     control of the system. Design, administrative, or implementation
     weaknesses or flaws in hardware, firmware, or software. If exploited, a
     vulnerability could lead to an unacceptable impact in the form of
     unauthorized access to information or the disruption of critical
     processing.
    </p></dd></dl></div></div></div><div class="part" id="part.selinux"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part V </span><span class="name">SELinux </span><a title="Permalink" class="permalink" href="#part.selinux">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.selinux"><span class="number">31 </span><span class="name">Configuring SELinux</span></a></span></dt><dd class="toc-abstract"><p>
  In this chapter, you will learn how to set up and manage SELinux on
  <span class="productname"><span class="phrase">openSUSE Leap</span></span>. The following topics are covered:
 </p></dd></dl></div><div class="chapter " id="cha.selinux"><div class="titlepage"><div><div><h2 class="title"><span class="number">31 </span><span class="name">Configuring SELinux</span> <a title="Permalink" class="permalink" href="#cha.selinux">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>selinux.xml</li><li><span class="ds-label">ID: </span>cha.selinux</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.selinux.why"><span class="number">31.1 </span><span class="name">Why Use SELinux?</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.policy"><span class="number">31.2 </span><span class="name">Policy</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.install"><span class="number">31.3 </span><span class="name">Installing SELinux Packages and Modifying GRUB 2</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.compilepolicy"><span class="number">31.4 </span><span class="name">SELinux Policy</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.configure"><span class="number">31.5 </span><span class="name">Configuring SELinux</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.manage"><span class="number">31.6 </span><span class="name">Managing SELinux</span></a></span></dt><dt><span class="sect1"><a href="#sec.selinux.troubleshoot"><span class="number">31.7 </span><span class="name">Troubleshooting</span></a></span></dt></dl></div></div><p>
  In this chapter, you will learn how to set up and manage SELinux on
  <span class="productname"><span class="phrase">openSUSE Leap</span></span>. The following topics are covered:
 </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    Why Use SELinux?
   </p></li><li class="listitem "><p>
    Understanding SELinux
   </p></li><li class="listitem "><p>
    Setting Up SELinux
   </p></li><li class="listitem "><p>
    Managing SELinux
   </p></li></ul></div><div class="sect1 " id="sec.selinux.why"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.why"><span class="number">31.1 </span><span class="name">Why Use SELinux?</span> <a title="Permalink" class="permalink" href="#sec.selinux.why">#</a></h2></div></div></div><p>
   SELinux was developed as an additional Linux security solution that uses
   the security framework in the Linux kernel. The purpose was to allow for
   a more granular security policy that goes beyond what is offered by the
   default existing permissions of Read, Write, and Execute, and beyond
   assigning permissions to the different capabilities that are available on
   Linux. SELinux does this by trapping all system calls that reach the
   kernel, and denying them by default. This means that on a system that has
   SELinux enabled and nothing else configured, nothing will work. To allow
   your system to do anything, as an administrator you will need to write
   rules and put them in a policy.
  </p><p>
   An example explains why a solution such as SELinux (or its counterpart
   <span class="phrase">AppArmor</span>) is needed:
  </p><p>
   <span class="quote">“<span class="quote">One morning, I found out that my server was hacked. The server was
   running a fully patched SLES installation. A firewall was configured on
   it and no unnecessary services were offered by this server. Further
   analysis revealed that the hacker had come in through a vulnerable PHP script
   that was a part of one of the Apache virtual hosts that were running on
   this server. The intruder had managed to get access to a shell, using the
   <code class="systemitem">wwwrun</code> account that was used by
   the Apache Web server. As this
   <code class="systemitem">wwwrun</code> user, the intruder had
   created several scripts in the <code class="filename">/var/tmp</code> and the
   <code class="filename">/tmp</code> directories, which were a part of a botnet that
   was launching a Distributed Denial of Service attack against several
   servers.</span>”</span>
  </p><p>
   The interesting thing about this hack is that it occurred on a server
   where nothing was really wrong. All permissions where set OK, but the
   intruder had managed to get into the system. What becomes clearly evident
   from this example is that in some cases additional security is
   needed—a security that goes beyond what is offered by using
   SELinux. As a less complete and less complex alternative, <span class="phrase">AppArmor</span> can be
   used.
  </p><p>
   <span class="phrase">AppArmor</span> confines specific processes in their abilities to read/write and
   execute files (and other things). Its view is mostly that things that
   happen inside a process cannot escape.
  </p><p>
   SELinux instead uses labels attached to objects (for example, files, binaries,
   network sockets) and uses them to determine privilege boundaries, thereby
   building up a level of confinement that can span more than a process or
   even the whole system.
  </p><p>
   SELinux was developed by the US National Security Agency (NSA), and since
   the beginning Red Hat has been heavily involved in its development. The
   first version of SELinux was offered in the era of <span class="trademark">Red Hat
   Enterprise Linux 4</span>™, around the year 2006. In the beginning it
   offered support for essential services only, but over the years it has
   developed into a system that offers many rules that are collected in
   policies to offer protection to a broad range of services.
  </p><p>
   SELinux was developed in accordance with some certification standards
   like Common Criteria and FIPS 140. Because some customers specifically
   requested solutions that met these standards, SELinux rapidly became
   relatively popular.
  </p><p>
   As an alternative to SELinux, Immunix, a company that was purchased by
   Novell in 2005, had developed <span class="phrase">AppArmor</span>. <span class="phrase">AppArmor</span> was built on top of the same
   security principles as SELinux, but took a completely different approach,
   where it was possible to restrict services to exactly what they needed to
   do by using an easy to use wizard-driven procedure. Nevertheless, <span class="phrase">AppArmor</span>
   has never reached the same status as SELinux, even if there are some good
   arguments to secure a server with <span class="phrase">AppArmor</span> rather than with SELinux.
  </p><p>
   Because many organizations are requesting SELinux to be in the
   Linux distributions they are using, SUSE is offering support for the
   SELinux framework in <span class="productname"><span class="phrase">openSUSE Leap</span></span>. This does not mean that the default
   installation of <span class="productname"><span class="phrase">openSUSE Leap</span></span> will switch from <span class="phrase">AppArmor</span> to SELinux in the
   near future.
  </p><div class="sect2 " id="sec.selinux.support"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.support"><span class="number">31.1.1 </span><span class="name">Support Status</span> <a title="Permalink" class="permalink" href="#sec.selinux.support">#</a></h3></div></div></div><p>
    The SELinux framework is supported on <span class="productname"><span class="phrase">openSUSE Leap</span></span>. This means that
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> offers all binaries and libraries you need to be able
    to use SELinux on your server. You may however miss some software that
    you may be familiar with from other Linux distributions.
   </p><p>
    SELinux support is at a fairly early stage in <span class="productname"><span class="phrase">openSUSE Leap</span></span>, which means
    that unexpected behavior may occur. To limit this risk as much as
    possible, it is best to use only the binaries that have been provided by
    default on <span class="productname"><span class="phrase">openSUSE Leap</span></span>.
   </p></div><div class="sect2 " id="sec.selinux.component"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.component"><span class="number">31.1.2 </span><span class="name">Understanding SELinux Components</span> <a title="Permalink" class="permalink" href="#sec.selinux.component">#</a></h3></div></div></div><p>
    Before starting the configuration of SELinux, you should know a bit
    about how SELinux is organized. Three components play a role:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      The security framework in the Linux kernel
     </p></li><li class="listitem "><p>
      The SELinux libraries and binaries
     </p></li><li class="listitem "><p>
      The SELinux policy
     </p></li></ul></div><p>
    The default kernel of <span class="productname"><span class="phrase">openSUSE Leap</span></span> supports SELinux and the tools that
    are needed to manage it. The most important part of the work of the
    administrator with regard to SELinux is managing the policy.
   </p><p>
    In the SELinux policy, security labels are applied to different objects
    on a Linux server. These objects typically are users, ports, processes
    and files. Using these security labels, rules are created that define
    what is and what is not allowed on a server. Remember, by default
    SELinux denies everything, and by creating the appropriate rules you can
    allow the access that is strictly necessary. Rules should therefore
    exist for all programs that you want to use on a system. Alternatively,
    you should configure parts of a system to run in unconfined mode, which
    means that specific ports, programs, users, files and directories are
    not protected by SELinux. This mode is useful if you only want to use
    SELinux to protect some essential services, while you are not
    specifically worried about other services. To get a really secure
    system, you should avoid this.
   </p><p>
    To ensure the appropriate protection of your system, you need an SELinux
    policy. This must be a tailor-made policy in which all files are
    provided with a label, and all services and users have a security label
    as well to express which files and directories can be accessed by which
    user and processed on the server. Developing such a policy is a
    tremendous amount of work.
   </p><p>
    The complexity of SELinux is also one of the main arguments against
    using it. Because a typical Linux system is so very complex, it is easy
    to overlook something and leave an opening that intruders can abuse to
    get into your system. And even if it is set up completely the way it
    should be, it still is very hard for an administrator to overlook all
    aspects with SELinux. With regard to the complexity, <span class="phrase">AppArmor</span> takes a
    completely different approach and works with automated procedures that
    allow the administrator to set up <span class="phrase">AppArmor</span> protection and understand exactly
    what is happening.
   </p><p>
    Note that a freely available SELinux policy might work on your server,
    but is unlikely to offer the same protection as a custom policy. SUSE
    also does not support third-party policies.
   </p></div></div><div class="sect1 " id="sec.selinux.policy"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.policy"><span class="number">31.2 </span><span class="name">Policy</span> <a title="Permalink" class="permalink" href="#sec.selinux.policy">#</a></h2></div></div></div><p>
   As mentioned, the policy is the key component in SELinux. It defines
   rules that specify which objects can access which files, directories,
   ports and processes on a system. To do this, a security context is
   defined for all of these. On an SELinux system where the policy has been
   applied to label the file system, you can use the <code class="command">ls
   -Z</code> command on any directory to find the security context for
   the files in that directory.
   <a class="xref" href="#ex.selnx.con.set" title="Security Context Settings Using ls -Z">Example 31.1: “Security Context Settings Using <code class="command">ls -Z</code>”</a>
   shows the security context settings for the directories in the
   <code class="filename">/</code> directory of a <span class="productname"><span class="phrase">openSUSE Leap</span></span> system with an
   SELinux-labeled file system.
  </p><div class="example" id="ex.selnx.con.set"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.1: </span><span class="name">Security Context Settings Using <code class="command">ls -Z</code> </span><a title="Permalink" class="permalink" href="#ex.selnx.con.set">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">ls -Z
system_u:object_r:bin_t bin
system_u:object_r:boot_t boot
system_u:object_r:device_t dev
system_u:object_r:etc_t etc
system_u:object_r:home_root_t home
system_u:object_r:lib_t lib
system_u:object_r:lib_t lib64
system_u:object_r:lost_found_t lost+found
system_u:object_r:mnt_t media
system_u:object_r:mnt_t mnt
system_u:object_r:usr_t opt
system_u:object_r:proc_t proc
system_u:object_r:default_t root
system_u:object_r:bin_t sbin
system_u:object_r:security_t selinux
system_u:object_r:var_t srv
system_u:object_r:sysfs_t sys
system_u:object_r:tmp_t tmp
system_u:object_r:usr_t usr
system_u:object_r:var_t var</pre></div></div></div><p>
   The most important line in the security context is the context type. This
   is the part of the security context that ends in _t. It tells SELinux
   which kind of access the object is allowed. In the policy, rules are
   specified to define which type of user or which type of role has access
   to which type of context. For example, this can happen by using a rule
   like the following:
  </p><div class="verbatim-wrap"><pre class="screen">allow user_t bin_t:file {read execute gettattr};</pre></div><p>
   This example rule states that the user who has the context type
   <code class="systemitem">user_t</code> (this user is called
   the source object) is allowed to access objects of class "file"
   with the context type <code class="filename">bin_t</code> (the target), using the
   permissions read, execute and getattr.
  </p><p>
   The standard policy that you are going to use contains a huge amount of
   rules. To make it more manageable, policies are often split into modules.
   This allows administrator to switch protection on or off for different
   parts of the system.
  </p><p>
   When compiling the policy for your system, you will have a choice to
   either work with a modular policy, or a monolithic policy, where one huge
   policy is used to protect everything on your system. It is strongly
   recommended to use a modular policy and not a monolithic policy. Modular
   policies are much easier to manage.
  </p></div><div class="sect1 " id="sec.selinux.install"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.install"><span class="number">31.3 </span><span class="name">Installing SELinux Packages and Modifying GRUB 2</span> <a title="Permalink" class="permalink" href="#sec.selinux.install">#</a></h2></div></div></div><p>
   The easiest way to make sure that all SELinux components are installed is
   by using YaST. The procedure described below shows what to do on an
   installed <span class="productname"><span class="phrase">openSUSE Leap</span></span>:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Log in to your server as <code class="systemitem">root</code>
     and start YaST.
    </p></li><li class="step "><p>
     Select <span class="guimenu">Software</span> › <span class="guimenu">Software
     Management</span>
    </p></li><li class="step "><p>
     <span class="guimenu">Select View</span> › <span class="guimenu">Patterns</span> and select the entire C<span class="guimenu">/C++ Development</span> category for installation.
    </p></li><li class="step "><p>
     <span class="guimenu">Select View</span> › <span class="guimenu">Search</span> and make sure that <span class="guimenu">Search in Name</span>,
     <span class="guimenu">Keywords</span> and <span class="guimenu">Summary</span> are
     selected. Now enter the keyword <code class="literal">selinux</code> and click
     <span class="guimenu">Search</span>. You now see a list of packages.
    </p></li><li class="step "><p>
     Make sure that all the packages you have found are selected and click
     <span class="guimenu">Accept</span> to install them.
    </p></li></ol></div></div><div class="figure" id="fig.packages.yast"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/selnx_policy_compiler.png"><img src="images/selnx_policy_compiler.png" width="" alt="Selecting all SELinux Packages in YaST" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 31.1: </span><span class="name">Selecting all SELinux Packages in YaST </span><a title="Permalink" class="permalink" href="#fig.packages.yast">#</a></h6></div></div><p>
   After installing the SELinux packages, you need to modify the GRUB 2 boot
   loader. Do this from YaST, select <span class="guimenu">System</span> › <span class="guimenu">Boot Loader</span> › <span class="guimenu">Kernel
   Parameters</span>. Now add the following parameters to
   the <span class="guimenu">Optional Kernel Command Line Parameters</span>:
  </p><div class="verbatim-wrap"><pre class="screen">security=selinux selinux=1 enforcing=0</pre></div><p>
   These options are used for the following purposes:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065638720"><span class="term "><code class="literal">security=selinux</code>
    </span></dt><dd><p>
      This option tells the kernel to use SELinux and not <span class="phrase">AppArmor</span>
     </p></dd><dt id="idm140712065636144"><span class="term "><code class="literal">selinux=1</code>
    </span></dt><dd><p>
      This option switches on SELinux
     </p></dd><dt id="idm140712065634032"><span class="term "><code class="literal">enforcing=0</code>
    </span></dt><dd><p>
      This option puts SELinux in permissive mode. In this mode, SELinux is
      fully functional, but does not enforce any of the security settings in
      the policy. Use this mode for configuring your system. To switch on
      SELinux protection, when the system is fully operational, change the
      option to <code class="literal">enforcing=1</code> and add
      <code class="literal">SELINUX=enforcing</code> in
      <code class="filename">/etc/selinux/config</code>.
     </p></dd></dl></div><p>
   After installing the SELinux packages and enabling the SELinux GRUB 2
   boot parameters, reboot your server to activate the configuration.
  </p></div><div class="sect1 " id="sec.selinux.compilepolicy"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.compilepolicy"><span class="number">31.4 </span><span class="name">SELinux Policy</span> <a title="Permalink" class="permalink" href="#sec.selinux.compilepolicy">#</a></h2></div></div></div><p>
   The policy is an essential component of SELinux. <span class="productname"><span class="phrase">openSUSE Leap</span></span> <span class="productnumber"><span class="phrase">42.3</span></span>
   includes the <span class="emphasis"><em>minimum</em></span> SELinux reference policy in the
   package <span class="package">selinux-policy-minimum</span>. The examples in
   this chapter refer to this policy if not stated otherwise.
  </p><div id="idm140712065624512" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
    To install a different policy, you need to download it from
    <a class="link" href="https://build.opensuse.org/package/binaries/security:SELinux/selinux-policy?repository=SLE_12" target="_blank">https://build.opensuse.org/package/binaries/security:SELinux/selinux-policy?repository=SLE_12</a>
    and install:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> zypper in selinux-policy-targeted-<em class="replaceable ">VERSION_NUMBER</em>.noarch.rpm</pre></div></div><p>
   After installing the policy, you are ready to start file system labeling.
   Run
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> restorecon -Rp /</pre></div><p>
   to start the <code class="command">/sbin/setfiles</code> command to label all files
   on your system. The
   <code class="filename">/etc/selinux/minimum/contexts/files/file_contexts</code>
   input file is used. The <code class="filename">file_contexts</code> file needs to
   match your actual file system as much as possible. Otherwise, it can lead
   to a completely unbootable system. If that happens, modify the records in
   <code class="filename">file_contexts</code> with the <code class="command">semanage
   fcontext</code> command to match the real structure of the file system
   your server is using. For example
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -a -t samba_share_t /etc/example_file</pre></div><p>
   changes the file type from the default <code class="literal">etc_t</code> to
   <code class="literal">samba_share_t</code> and adds the following record to the
   related <code class="filename">file_contexts.local</code> file:
  </p><div class="verbatim-wrap"><pre class="screen">/etc/example_file    unconfined_u:object_r:samba_share_t:s0</pre></div><p>
   Then run
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> restorecon -v /etc/example_file</pre></div><p>
   for the type change to take effect.
  </p><p>
   Before doing this, make sure to read the rest of this chapter, so you
   fully understand how context type is applied to files and directories. Do
   not forget to make a backup of the <code class="filename">file_contexts</code>
   file before starting.
  </p><div id="idm140712065610464" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: The User <code class="systemitem">nobody</code></h6><p>
    While using <code class="command">semanage</code>, you may get a message that
    complains about the home directory of
    <code class="systemitem">nobody</code>. In this case, change
    the login shell of user <code class="systemitem">nobody</code>
    to <code class="filename">/sbin/nologin</code>. Then the settings of
    <code class="systemitem">nobody</code> match the current
    policy settings.
   </p></div><p>
   After another reboot SELinux should be operational. To verify this, use
   the command <code class="command">sestatus -v</code>. It should give you an output
   similar to
   <a class="xref" href="#ex.selnx.sestatus" title="Verifying that SELinux is functional">Example 31.2: “Verifying that SELinux is functional”</a>.
  </p><div class="example" id="ex.selnx.sestatus"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.2: </span><span class="name">Verifying that SELinux is functional </span><a title="Permalink" class="permalink" href="#ex.selnx.sestatus">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> sestatus -v
SELinux status:                 enabled
SELinuxfs mount:                /selinux
Current mode:                   permissive
Mode from config file:          permissive
Policy version:                 26
Policy from config file:        minimum

Process contexts:
Current context:                root:staff_r:staff_t
Init context:                   system_u:system_r:init_t
/sbin/mingetty                  system_u:system_r:sysadm_t
/usr/sbin/sshd                  system_u:system_r:sshd_t

File contexts:
Controlling term:               root:object_r:user_devpts_t
/etc/passwd                     system_u:object_r:etc_t
/etc/shadow                     system_u:object_r:shadow_t
/bin/bash                       system_u:object_r:shell_exec_t
/bin/login                      system_u:object_r:login_exec_t
/bin/sh                         system_u:object_r:bin_t -&gt; system_u:object_r:shell_exec_t
/sbin/agetty                    system_u:object_r:getty_exec_t
/sbin/init                      system_u:object_r:init_exec_t
/sbin/mingetty                  system_u:object_r:getty_exec_t
/usr/sbin/sshd                  system_u:object_r:sshd_exec_t
/lib/libc.so.6                  system_u:object_r:lib_t -&gt; system_u:object_r:lib_t
/lib/ld-linux.so.2              system_u:object_r:lib_t -&gt; system_u:object_r:ld_so_t</pre></div></div></div></div><div class="sect1 " id="sec.selinux.configure"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.configure"><span class="number">31.5 </span><span class="name">Configuring SELinux</span> <a title="Permalink" class="permalink" href="#sec.selinux.configure">#</a></h2></div></div></div><p>
   At this point you have a completely functional SELinux system and it is
   time to further configure it. In the current status, SELinux is
   operational but not in enforcing mode. This means that it does not limit
   you in doing anything, it logs everything that it should be doing if it
   were in enforcing mode. This is good, because based on the log files you
   can find what it is that it would prevent you from doing. As a first
   test, put SELinux in enforcing mode and find out if you can still use
   your server after doing so: check that the option
   <code class="option">enforcing=1</code> is set in the GRUB 2 configuration file,
   while <code class="option">SELINUX=enforcing</code> is set in
   <code class="filename">/etc/selinux/config</code>. Reboot your server and see if
   it still comes up the way you expect it to. If it does, leave it like
   that and start modifying the server in a way that everything works as
   expected. However, you may not even be able to boot the server properly.
   In that case, switch back to the mode where SELinux is not enforcing and
   start tuning your server.
  </p><p>
    Before you start tuning your server, verify the SELinux installation.
    You have already used the command <code class="command">sestatus -v</code> to view
    the current mode, process, and file contexts. Next, run
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage boolean -l</pre></div><p>
    which lists all Boolean switches that are available, and at
    the same time verifies that you can access the policy.
    <a class="xref" href="#ex.selnx.ls.bool" title="Getting a List of Booleans and Verifying Policy Access">Example 31.3, “Getting a List of Booleans and Verifying Policy Access”</a> shows part of the output of this
    command.
   </p><div class="complex-example"><div class="example" id="ex.selnx.ls.bool"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.3: </span><span class="name">Getting a List of Booleans and Verifying Policy Access </span><a title="Permalink" class="permalink" href="#ex.selnx.ls.bool">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage boolean -l
SELinux boolean                          Description
ftp_home_dir                   -&gt; off   ftp_home_dir
mozilla_read_content           -&gt; off   mozilla_read_content
spamassassin_can_network       -&gt; off   spamassassin_can_network
httpd_can_network_relay        -&gt; off   httpd_can_network_relay
openvpn_enable_homedirs        -&gt; off   openvpn_enable_homedirs
gpg_agent_env_file             -&gt; off   gpg_agent_env_file
allow_httpd_awstats_script_anon_write -&gt; off   allow_httpd_awstats_script_anon_write
httpd_can_network_connect_db   -&gt; off   httpd_can_network_connect_db
allow_ftpd_full_access         -&gt; off   allow_ftpd_full_access
samba_domain_controller        -&gt; off   samba_domain_controller
httpd_enable_cgi               -&gt; off   httpd_enable_cgi
virt_use_nfs                   -&gt; off   virt_use_nfs</pre></div><p>
     Another command that outputs useful information at this stage is
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -l</pre></div><p>
     It shows the default file context settings as provided by the policy
     (see
     <a class="xref" href="#ex.selnx.fcon" title="Getting File Context Information">Example 31.4: “Getting File Context Information”</a>
     for partial output of this command).
    </p></div></div></div><div class="example" id="ex.selnx.fcon"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.4: </span><span class="name">Getting File Context Information </span><a title="Permalink" class="permalink" href="#ex.selnx.fcon">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -l
/var/run/usb(/.*)?                                 all files          system_u:object_r:hotplug_var_run_t
/var/run/utmp                                      regular file       system_u:object_r:initrc_var_run_t
/var/run/vbe.*                                     regular file       system_u:object_r:hald_var_run_t
/var/run/vmnat.*                                   socket             system_u:object_r:vmware_var_run_t
/var/run/vmware.*                                  all files          system_u:object_r:vmware_var_run_t
/var/run/watchdog\.pid                             regular file       system_u:object_r:watchdog_var_run_t
/var/run/winbindd(/.*)?                            all files          system_u:object_r:winbind_var_run_t
/var/run/wnn-unix(/.*)                             all files          system_u:object_r:canna_var_run_t
/var/run/wpa_supplicant(/.*)?                      all files          system_u:object_r:NetworkManager_var_run_t
/var/run/wpa_supplicant-global                     socket             system_u:object_r:NetworkManager_var_run_t
/var/run/xdmctl(/.*)?                              all files          system_u:object_r:xdm_var_run_t
/var/run/yiff-[0-9]+\.pid                          regular file       system_u:object_r:soundd_var_run_t</pre></div></div></div></div><div class="sect1 " id="sec.selinux.manage"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.manage"><span class="number">31.6 </span><span class="name">Managing SELinux</span> <a title="Permalink" class="permalink" href="#sec.selinux.manage">#</a></h2></div></div></div><p>
   The base SELinux configuration is now operational and it can now be
   configured to secure your server. In SELinux, an additional set of rules
   is used to define exactly which process or user can access which files,
   directories, or ports. To do this, SELinux applies a context to every
   file, directory, process, and port. This context is a security label that
   defines how this file, directory, process, or port should be treated.
   These context labels are used by the SELinux policy, which defines
   exactly what should be done with the context labels. By default, the
   policy blocks all non-default access, which means that, as an
   administrator, you need to enable all features that are non-default on
   your server.
  </p><div class="sect2 " id="sec.selinux.viewcontext"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.viewcontext"><span class="number">31.6.1 </span><span class="name">Viewing the Security Context</span> <a title="Permalink" class="permalink" href="#sec.selinux.viewcontext">#</a></h3></div></div></div><p>
    As already mentioned, files, directories, and ports can be labeled.
    Within each label, different contexts are used. To be able to perform
    your daily administration work, the type context is what you are most
    interested in. As an administrator, you will mostly work with the type
    context. Many commands allow you to use the <code class="option">-Z</code> option
    to list current context settings. In
    <a class="xref" href="#ex.selnx.def.con" title="The default context for directories in the root directory">Example 31.5: “The default context for directories in the root directory”</a>
    you can see what the context settings are for the directories in the
    root directory.
   </p><div class="example" id="ex.selnx.def.con"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.5: </span><span class="name">The default context for directories in the root directory </span><a title="Permalink" class="permalink" href="#ex.selnx.def.con">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> ls -Z
dr-xr-xr-x. root root system_u:object_r:bin_t:s0       bin
dr-xr-xr-x. root root system_u:object_r:boot_t:s0      boot
drwxr-xr-x. root root system_u:object_r:cgroup_t:s0    cgroup
drwxr-xr-x+ root root unconfined_u:object_r:default_t:s0 data
drwxr-xr-x. root root system_u:object_r:device_t:s0    dev
drwxr-xr-x. root root system_u:object_r:etc_t:s0       etc
drwxr-xr-x. root root system_u:object_r:home_root_t:s0 home
dr-xr-xr-x. root root system_u:object_r:lib_t:s0       lib
dr-xr-xr-x. root root system_u:object_r:lib_t:s0       lib64
drwx------. root root system_u:object_r:lost_found_t:s0 lost+found
drwxr-xr-x. root root system_u:object_r:mnt_t:s0       media
drwxr-xr-x. root root system_u:object_r:autofs_t:s0    misc
drwxr-xr-x. root root system_u:object_r:mnt_t:s0       mnt
drwxr-xr-x. root root unconfined_u:object_r:default_t:s0 mnt2
drwxr-xr-x. root root unconfined_u:object_r:default_t:s0 mounts
drwxr-xr-x. root root system_u:object_r:autofs_t:s0    net
drwxr-xr-x. root root system_u:object_r:usr_t:s0       opt
dr-xr-xr-x. root root system_u:object_r:proc_t:s0      proc
drwxr-xr-x. root root unconfined_u:object_r:default_t:s0 repo
dr-xr-x---. root root system_u:object_r:admin_home_t:s0 root
dr-xr-xr-x. root root system_u:object_r:bin_t:s0       sbin
drwxr-xr-x. root root system_u:object_r:security_t:s0  selinux
drwxr-xr-x. root root system_u:object_r:var_t:s0       srv
-rw-r--r--. root root unconfined_u:object_r:swapfile_t:s0 swapfile
drwxr-xr-x. root root system_u:object_r:sysfs_t:s0     sys
drwxrwxrwt. root root system_u:object_r:tmp_t:s0       tmp
-rw-r--r--. root root unconfined_u:object_r:etc_runtime_t:s0 tmp2.tar
-rw-r--r--. root root unconfined_u:object_r:etc_runtime_t:s0 tmp.tar
drwxr-xr-x. root root system_u:object_r:usr_t:s0       usr
drwxr-xr-x. root root system_u:object_r:var_t:s0       var</pre></div></div></div><p>
    In the listing above, you can see the complete context for all
    directories. It consists of a user, a role, and a type. The s0 setting
    indicates the security level in Multi Level Security environments. These
    environments are not discussed here. In such an environment, make sure
    that s0 is set. The Context Type defines what kind of activity is
    permitted in the directory. Compare, for example, the
    <code class="filename">/root</code> directory, which has the
    <code class="filename">admin_home_t</code> context type, and the
    <code class="filename">/home</code> directory, which has the
    <code class="filename">home_root_t</code> context type. In the SELinux policy,
    different kinds of access are defined for these context types.
   </p><p>
    Security labels are not only associated with files, but also with other
    items, such as ports and processes. In
    <a class="xref" href="#ex.selnx.set.proc" title="Showing SELinux settings for processes with ps Zaux">Example 31.6: “Showing SELinux settings for processes with <code class="command">ps Zaux</code>”</a>
    for example you can see the context settings for processes on your
    server.
   </p><div class="example" id="ex.selnx.set.proc"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.6: </span><span class="name">Showing SELinux settings for processes with <code class="command">ps Zaux</code> </span><a title="Permalink" class="permalink" href="#ex.selnx.set.proc">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> ps Zaux
LABEL                           USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
system_u:system_r:init_t        root         1  0.0  0.0  10640   808 ?        Ss   05:31   0:00 init [5]
system_u:system_r:kernel_t      root         2  0.0  0.0      0     0 ?        S    05:31   0:00 [kthreadd]
system_u:system_r:kernel_t      root         3  0.0  0.0      0     0 ?        S    05:31   0:00 [ksoftirqd/0]
system_u:system_r:kernel_t      root         6  0.0  0.0      0     0 ?        S    05:31   0:00 [migration/0]
system_u:system_r:kernel_t      root         7  0.0  0.0      0     0 ?        S    05:31   0:00 [watchdog/0]
system_u:system_r:sysadm_t      root      2344  0.0  0.0  27640   852 ?        Ss   05:32   0:00 /usr/sbin/mcelog --daemon --config-file /etc/mcelog/mcelog.conf
system_u:system_r:sshd_t        root      3245  0.0  0.0  69300  1492 ?        Ss   05:32   0:00 /usr/sbin/sshd -o PidFile=/var/run/sshd.init.pid
system_u:system_r:cupsd_t       root      3265  0.0  0.0  68176  2852 ?        Ss   05:32   0:00 /usr/sbin/cupsd
system_u:system_r:nscd_t        root      3267  0.0  0.0 772876  1380 ?        Ssl  05:32   0:00 /usr/sbin/nscd
system_u:system_r:postfix_master_t root   3334  0.0  0.0  38320  2424 ?        Ss   05:32   0:00 /usr/lib/postfix/master
system_u:system_r:postfix_qmgr_t postfix  3358  0.0  0.0  40216  2252 ?        S    05:32   0:00 qmgr -l -t fifo -u
system_u:system_r:crond_t       root      3415  0.0  0.0  14900   800 ?        Ss   05:32   0:00 /usr/sbin/cron
system_u:system_r:fsdaemon_t    root      3437  0.0  0.0  16468  1040 ?        S    05:32   0:00 /usr/sbin/smartd
system_u:system_r:sysadm_t      root      3441  0.0  0.0  66916  2152 ?        Ss   05:32   0:00 login -- root
system_u:system_r:sysadm_t      root      3442  0.0  0.0   4596   800 tty2     Ss+  05:32   0:00 /sbin/mingetty tty2</pre></div></div></div></div><div class="sect2 " id="sec.selinux.selectmode"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.selectmode"><span class="number">31.6.2 </span><span class="name">Selecting the SELinux Mode</span> <a title="Permalink" class="permalink" href="#sec.selinux.selectmode">#</a></h3></div></div></div><p>
    In SELinux, three different modes can be used:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065561824"><span class="term ">Enforcing:</span></dt><dd><p>
       This is the default mode. SELinux protects your server according to
       the rules in the policy, and SELinux logs all of its activity to the
       audit log.
      </p></dd><dt id="idm140712065559872"><span class="term ">Permissive:</span></dt><dd><p>
       This mode is useful for troubleshooting. If set to Permissive,
       SELinux does not protect your server, but it still logs everything
       that happens to the log files.
      </p></dd><dt id="idm140712065557904"><span class="term ">Disabled:</span></dt><dd><p>
       In this mode, SELinux is switched off completely and no logging
       occurs. The file system labels however are not removed from the file
       system.
      </p></dd></dl></div><p>
    You have already read how you can set the current SELinux mode from
    GRUB 2 while booting using the enforcing boot parameter.
   </p></div><div class="sect2 " id="sec.selinux.modifycontext"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.modifycontext"><span class="number">31.6.3 </span><span class="name">Modifying SELinux Context Types</span> <a title="Permalink" class="permalink" href="#sec.selinux.modifycontext">#</a></h3></div></div></div><p>
    An important part of the work of an administrator is setting context
    types on files to ensure appropriate working of SELinux.
   </p><p>
    If a file is created within a specific directory, it inherits the
    context type of the parent directory by default. If, however, a file is
    moved from one location to another location, it retains the context type
    that it had in the old location.
   </p><p>
    To set the context type for files, you can use the <code class="command">semanage
    fcontext</code> command. With this command, you write the new context
    type to the policy, but it does not change the actual context type
    immediately! To apply the context types that are in the policy, you need
    to run the <code class="command">restorecon</code> command afterward.
   </p><p>
    The challenge when working with <code class="command">semanage fcontext</code> is
    to find out which context you actually need. You can use
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -l</pre></div><p>
    to list all contexts in the policy, but it may be a bit hard
    to find out the actual context you need from that list as it is rather
    long (see
    <a class="xref" href="#ex.selnx.semanage" title="Viewing Default File Contexts">Example 31.7: “Viewing Default File Contexts”</a>).
   </p><div class="example" id="ex.selnx.semanage"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.7: </span><span class="name">Viewing Default File Contexts </span><a title="Permalink" class="permalink" href="#ex.selnx.semanage">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -l | less
SELinux fcontext                                   type               Context

/                                                  directory          system_u:object_r:root_t:s0
/.*                                                all files          system_u:object_r:default_t:s0
/[^/]+                                             regular file       system_u:object_r:etc_runtime_t:s0
/\.autofsck                                        regular file       system_u:object_r:etc_runtime_t:s0
/\.autorelabel                                     regular file       system_u:object_r:etc_runtime_t:s0
/\.journal                                         all files          X:&gt;&gt;None&gt;&gt;
/\.suspended                                       regular file       system_u:object_r:etc_runtime_t:s0
/a?quota\.(user|group)                             regular file       system_u:object_r:quota_db_t:s0
/afs                                               directory          system_u:object_r:mnt_t:s0
/bin                                               directory          system_u:object_r:bin_t:s0
/bin/.*                                            all files          system_u:object_r:bin_t:s0</pre></div></div></div><p>
    There are three ways to find out which context settings are available
    for your services:
   </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
      Install the service and look at the default context settings that are
      used. This is the easiest and recommended option.
     </p></li><li class="listitem "><p>
      Consult the man page for the specific service. Some services have a
      man page that ends in <code class="literal">_selinux</code>, which contains all
      the information you need to find the correct context settings.
     </p><p>
      When you have found the right context setting, apply it using
      <code class="command">semanage fcontext</code>. This command takes
      <code class="option">-t</code> context type as its first argument, followed by
      the name of the directory or file to which you want to apply the
      context settings. To apply the context to everything that already
      exists in the directory where you want to apply the context, you add
      the regular expression <code class="literal">(/.*)?</code> to the name of the
      directory. This means: optionally, match a slash followed by any
      character. The examples section of the <code class="command">semanage</code> man
      page has some useful usage examples for <code class="command">semanage</code>.
      For more information on regular expressions, see for example the
      tutorial at <a class="link" href="http://www.regular-expressions.info/" target="_blank">http://www.regular-expressions.info/</a>.
     </p></li><li class="listitem "><p>
      Display a list of all context types that are available on your system:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> seinfo -t</pre></div><p>
      Since the command by itself outputs an overwhelming amount of
      information, it should be used in combination with
      <code class="command">grep</code> or a similar command for filtering.
     </p></li></ul></div></div><div class="sect2 " id="sec.selinux.applyfilecontext"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.applyfilecontext"><span class="number">31.6.4 </span><span class="name">Applying File Contexts</span> <a title="Permalink" class="permalink" href="#sec.selinux.applyfilecontext">#</a></h3></div></div></div><p> To help you apply the SELinux context properly, the following
        procedure shows how to set a context using <code class="command">semanage
          fcontext</code> and <code class="command">restorecon</code>. You will
        notice that at first attempt, the Web server with a non-default
        document root does not work. After changing the SELinux context,
        it will:</p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      Create the <code class="filename">/web</code> directory and then change to it:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> mkdir /web  &amp;&amp; cd /web</pre></div></li><li class="step "><p>
      Use a text editor to create the file
      <code class="filename">/web/index.html</code> that contains the text welcome to
      my Web site.
     </p></li><li class="step "><p>
      Open the file <code class="filename">/etc/apache2/default-server.conf</code>
      with an editor, and change the DocumentRoot line to
      <code class="literal">DocumentRoot /web</code>
     </p></li><li class="step "><p>
      Start the Apache Web server:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl start apache2</pre></div></li><li class="step "><p>
      Open a session to your local Web server:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>w3m localhost</pre></div><p>
      You will receive a <span class="emphasis"><em>Connection refused</em></span> message.
      Press <span class="keycap">Enter</span>, and then <code class="command">q</code> to
      quit w3m.
     </p></li><li class="step "><p>
      Find the current context type for the default Apache
      <code class="literal">DocumentRoot</code>, which is
      <code class="filename">/srv/www/htdocs</code>. It should be set to
      <code class="filename">httpd_sys_content_t</code>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> ls -Z /srv/www</pre></div></li><li class="step "><p>
      Set the new context in the policy and press
      <span class="keycap">Enter</span>:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage fcontext -a -f "" -t httpd_sys_content_t '/web(/.*) ?'</pre></div></li><li class="step "><p>
      Apply the new context type:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> restorecon /web</pre></div></li><li class="step "><p>
      Show the context of the files in the directory
      <code class="filename">/web</code>. You will see that the new context type has
      been set properly to the <code class="filename">/web</code> directory, but not
      to its contents.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> ls -Z /web</pre></div></li><li class="step "><p>
      Apply the new context recursively to the <code class="filename">/web</code>
      directory. The type context has now been set correctly.
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> restorecon -R /web</pre></div></li><li class="step "><p>
      Restart the Web server:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl restart apache2</pre></div><p>
      You should now be able to access the contents of the
      <code class="filename">/web</code> directory.
     </p></li></ol></div></div></div><div class="sect2 " id="sec.selinux.configurepolicy"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.configurepolicy"><span class="number">31.6.5 </span><span class="name">Configuring SELinux Policies</span> <a title="Permalink" class="permalink" href="#sec.selinux.configurepolicy">#</a></h3></div></div></div><p>
    The easiest way to change the behavior of the policy is by working with
    Booleans. These are on-off switches that you can use to change the
    settings in the policy. To find out which Booleans are available, run
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage boolean -l</pre></div><p>
    It will show a long list of Booleans, with a short description of
    what each of these Booleans will do for you. When you have found the
    Boolean you want to set, you can use <code class="command">setsebool -P</code>,
    followed by the name of the Boolean that you want to change. It is
    important to use the <code class="option">-P</code> option at all times when using
    <code class="command">setsebool</code>. This option writes the setting to the
    policy file on disk, and this is the only way to make sure that the
    Boolean is applied automatically after a reboot.
   </p><p>
    The procedure below gives an example of changing Boolean settings
   </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
      List Booleans that are related to FTP servers.</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage boolean -l | grep ftp</pre></div></li><li class="step "><p>
      Turn the Boolean off:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> setsebool allow_ftpd_anon_write off</pre></div><p>
      Note that it does not take much time to write the change. Then verify
      that the Boolean is indeed turned off:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semanage boolean -l|grep ftpd_anon</pre></div></li><li class="step "><p>
      Reboot your server.
     </p></li><li class="step "><p>
      Check again to see if the <code class="literal">allow_ftpd_anon_write</code>
      Boolean is still turned on. As it has not yet been written to the
      policy, you will notice that it is off.
     </p></li><li class="step "><p>
      Switch the Boolean and write the setting to the policy:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> setsebool -P allow_ftpd_anon_write</pre></div></li></ol></div></div></div><div class="sect2 " id="sec.selinux.module"><div class="titlepage"><div><div><h3 class="title" id="sec.selinux.module"><span class="number">31.6.6 </span><span class="name">Working with SELinux Modules</span> <a title="Permalink" class="permalink" href="#sec.selinux.module">#</a></h3></div></div></div><p>
    By default, SELinux uses a modular policy. This means that the
    policy that implements SELinux features is not just one huge policy, but
    it consists of many smaller modules. Each module covers a specific part
    of the SELinux configuration. The concept of the SELinux module was
    introduced to make it easier for third party vendors to make their
    services compatible with SELinux. To get an overview of the SELinux
    modules, you can use the <code class="command">semodule -l</code> command. This
    command lists all current modules in use by SELinux and their
    version numbers.
   </p><p>
    As an administrator, you can switch modules on or off. This can be
    useful if you want to disable only a part of SELinux and not everything
    to run a specific service without SELinux protection. Especially in the
    case of <span class="productname"><span class="phrase">openSUSE Leap</span></span>, where there is not a completely supported SELinux
    policy yet, it can make sense to switch off all modules that you do not
    need so that you can focus on the services that really do need SELinux
    protection. To switch off an SELinux module, use
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semodule -d <em class="replaceable ">MODULENAME</em></pre></div><p>
    To switch it on again, you can use
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> semodule -e modulename</pre></div><p>
    As an administrator, you do not typically change the contents of the
    policy files that come from the SELinux Policy RPM. You would rather use
    <code class="command">semanage fcontext</code> to change file contexts. If you are
    using <code class="command">audit2allow</code> to generate policies for your
    server, you should change the policy files after all.
   </p><p>
    To change the contents of any of the policy module files,
    compile the changes into a new policy module file. To do this,
    first install the <code class="systemitem">selinux-policy-devel</code> package.
    Then, in the directory where the files created by
    <code class="command">audit2allow</code> are located, run:
   </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>make -f /usr/share/selinux/devel/Makefile</pre></div><p>
    When <code class="command">make</code> has completed, you can manually load the
    modules into the system, using <code class="command">semodule -i</code>.
   </p></div></div><div class="sect1 " id="sec.selinux.troubleshoot"><div class="titlepage"><div><div><h2 class="title" id="sec.selinux.troubleshoot"><span class="number">31.7 </span><span class="name">Troubleshooting</span> <a title="Permalink" class="permalink" href="#sec.selinux.troubleshoot">#</a></h2></div></div></div><p>
   By default, if SELinux is the reason something is not working, a log
   message to this effect is sent to the
   <code class="filename">/var/log/audit/audit.log</code> file. That is, if the
   auditd service is running. If you see an empty
   <code class="filename">/var/log/audit</code>, start the auditd service using
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl start auditd</pre></div><p>
   and enable it in the targets of your system, using
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl enable auditd</pre></div><p>
   In
   <a class="xref" href="#ex.selnx.li.auditlog" title="Example Lines from /etc/audit/audit.log">Example 31.8: “Example Lines from <code class="filename">/etc/audit/audit.log</code>”</a>
   you can see a partial example of the contents of
   <code class="filename">/var/log/audit/audit.log</code>
  </p><div class="example" id="ex.selnx.li.auditlog"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.8: </span><span class="name">Example Lines from <code class="filename">/etc/audit/audit.log</code> </span><a title="Permalink" class="permalink" href="#ex.selnx.li.auditlog">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">type=DAEMON_START msg=audit(1348173810.874:6248): auditd start, ver=1.7.7 format=raw kernel=3.0.13-0.27-default auid=0 pid=4235 subj=system_u:system_r:auditd_t res=success
type=AVC msg=audit(1348173901.081:292): avc:  denied  { write } for  pid=3426 comm="smartd" name="smartmontools" dev=sda6 ino=581743 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=dir
type=AVC msg=audit(1348173901.081:293): avc:  denied  { remove_name } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state~" dev=sda6 ino=582390 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=dir
type=AVC msg=audit(1348173901.081:294): avc:  denied  { unlink } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state~" dev=sda6 ino=582390 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=file
type=AVC msg=audit(1348173901.081:295): avc:  denied  { rename } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state" dev=sda6 ino=582373 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=file
type=AVC msg=audit(1348173901.081:296): avc:  denied  { add_name } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state~" scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=dir
type=AVC msg=audit(1348173901.081:297): avc:  denied  { create } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state" scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=file
type=AVC msg=audit(1348173901.081:298): avc:  denied  { write open } for  pid=3426 comm="smartd" name="smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state" dev=sda6 ino=582390 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=file
type=AVC msg=audit(1348173901.081:299): avc:  denied  { getattr } for  pid=3426 comm="smartd" path="/var/lib/smartmontools/smartd.WDC_WD2500BEKT_75PVMT0-WD_WXC1A21E0454.ata.state" dev=sda6 ino=582390 scontext=system_u:system_r:fsdaemon_t tcontext=system_u:object_r:var_lib_t tclass=file
type=AVC msg=audit(1348173901.309:300): avc:  denied  { append } for  pid=1316</pre></div></div></div><p>
   At first look, the lines in <code class="filename">audit.log</code> are a bit hard
   to read. However, on closer examination they are not that hard to
   understand. Every line can be broken down into sections. For example, the
   sections in the last line are:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065460128"><span class="term "><code class="literal">type=AVC</code>:</span></dt><dd><p>
      every SELinux-related audit log line starts with the type
      identification <code class="literal">type=AVC</code>
     </p></dd><dt id="idm140712065457536"><span class="term "><code class="literal">msg=audit(1348173901.309:300)</code>: </span></dt><dd><p>
      This is the time stamp, which unfortunately is written in epoch time,
      the number of seconds that have passed since Jan 1, 1970. You can use
      <code class="command">date -d</code> on the part up to the dot in the epoch time
      notation to find out when the event has happened:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code>date -d @1348173901
Thu Sep 20 16:45:01 EDT 2012</pre></div></dd><dt id="idm140712065453984"><span class="term "><code class="literal">avc: denied { append }</code>:</span></dt><dd><p>
      the specific action that was denied. In this case the system has
      denied the appending of data to a file. While browsing through the
      audit log file, you can see other system actions, such as write open,
      getattr and more.
     </p></dd><dt id="idm140712065451664"><span class="term "><code class="literal">for pid=1316</code>:</span></dt><dd><p>
      the process ID of the command or process that initiated the action
     </p></dd><dt id="idm140712065449520"><span class="term "><code class="literal">comm="rsyslogd"</code>:</span></dt><dd><p>
      the specific command that was associated with that PID
     </p></dd><dt id="idm140712065447392"><span class="term "><code class="literal">name="smartmontools"</code>:</span></dt><dd><p>
      the name of the subject of the action
     </p></dd><dt id="idm140712065445280"><span class="term "><code class="literal">dev=sda6 ino=582296</code>:</span></dt><dd><p>
      the block device and inode number of the file that was involved
     </p></dd><dt id="idm140712065443136"><span class="term "><code class="literal">scontext=system_u:system_r:syslogd_t</code>:</span></dt><dd><p>
      the source context, which is the context of the initiator of the
      action
     </p></dd><dt id="idm140712065440960"><span class="term "><code class="literal">tclass=file</code>:</span></dt><dd><p>
      a class identification of the subject
     </p></dd></dl></div><p>
   Instead of interpreting the events in audit.log yourself, there is
   another approach. You can use the <code class="command">audit2allow</code> command,
   which helps analyze the cryptic log messages in
   <code class="filename">/var/log/audit/audit.log</code>. An audit2allow
   troubleshooting session always consists of three different commands.
   First, you would use <code class="command">audit2allow -w -a</code> to present the
   audit information in a more readable way. The <code class="command">audit2allow -w
   -a</code> by default works on the audit.log file. If you want to
   analyze a specific message in the audit.log file, copy it to a temporary
   file and analyze the file with:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow -w -i <em class="replaceable ">FILENAME</em></pre></div><div class="example" id="idm140712065434672"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.9: </span><span class="name">Analyzing Audit Messages </span><a title="Permalink" class="permalink" href="#idm140712065434672">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow -w -i testfile
type=AVC msg=audit(1348173901.309:300): avc:  denied  { append } for  pid=1316
comm="rsyslogd" name="acpid" dev=sda6 ino=582296
scontext=system_u:system_r:syslogd_t tcontext=system_u:object_r:apmd_log_t tclass=file</pre></div></div></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712065432224"><span class="term ">This was caused by:</span></dt><dd><p>
      Missing type enforcement (TE) allow rule.
     </p><p>
      To generate a loadable module to allow this access, run
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow</pre></div></dd></dl></div><p>
   To find out which specific rule has denied access, you can use
   <code class="command">audit2allow -a</code> to show the enforcing rules from all
   events that were logged to the <code class="filename">audit.log </code> file, or
   <code class="command">audit2allow -i <em class="replaceable ">FILENAME</em></code> to
   show it for messages that you have stored in a specific file:
  </p><div class="example" id="idm140712065426480"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.10: </span><span class="name">Viewing Which Lines Deny Access </span><a title="Permalink" class="permalink" href="#idm140712065426480">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow -i testfile
#============= syslogd_t ==============
allow syslogd_t apmd_log_t:file append;</pre></div></div></div><p>
   To create an SELinux module with the name <code class="literal">mymodule</code>
   that you can load to allow the access that was previously denied, run
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow -a -R -M mymodule</pre></div><p>
   If you want to do this for all events that have been logged to the
   audit.log, use the <code class="option">-a -M</code> command arguments. To do it
   only for specific messages that are in a specific file, use <code class="option">-i
   -M</code> as in the example below:
  </p><div class="example" id="idm140712065420896"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 31.11: </span><span class="name">Creating a Policy Module Allowing an Action Previously Denied </span><a title="Permalink" class="permalink" href="#idm140712065420896">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> audit2allow -i testfile -M example
******************** IMPORTANT ***********************
To make this policy package active, execute:

semodule -i example.pp</pre></div></div></div><p>
   As indicated by the <code class="command">audit2allow</code> command, you can now
   run this module by using the <code class="command">semodule -i</code> command,
   followed by the name of the module that <code class="command">audit2allow</code>
   has created for you (<code class="filename">example.pp</code> in the above
   example).
  </p></div></div></div><div class="part" id="part.audit"><div class="titlepage"><div><div><h1 class="title"><span class="number">Part VI </span><span class="name"><em class="citetitle ">The Linux Audit Framework</em> </span><a title="Permalink" class="permalink" href="#part.audit">#</a></h1></div></div></div><div class="toc"><dl><dt><span class="chapter"><a href="#cha.audit.comp"><span class="number">32 </span><span class="name">Understanding Linux Audit</span></a></span></dt><dd class="toc-abstract"><p>
    The Linux audit framework as shipped with this version of
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> provides a CAPP-compliant (Controlled Access Protection
    Profiles) auditing system that reliably collects information about any
    security-relevant event. The audit records can be examined to determine
    whether any violation of the security policies has been committed, and
    by whom.
   </p><p>
    Providing an audit framework is an important requirement for a
    CC-CAPP/EAL (Common Criteria-Controlled Access Protection
    Profiles/Evaluation Assurance Level) certification. Common Criteria (CC)
    for Information Technology Security Information is an international
    standard for independent security evaluations. Common Criteria helps
    customers judge the security level of any IT product they intend to
    deploy in mission-critical setups.
   </p><p>
    Common Criteria security evaluations have two sets of evaluation
    requirements, functional and assurance requirements. Functional
    requirements describe the security attributes of the product under
    evaluation and are summarized under the Controlled Access Protection
    Profiles (CAPP). Assurance requirements are summarized under the
    Evaluation Assurance Level (EAL). EAL describes any activities that must
    take place for the evaluators to be confident that security attributes
    are present, effective, and implemented. Examples for activities of this
    kind include documenting the developers' search for security
    vulnerabilities, the patch process, and testing.
   </p><p>
    This guide provides a basic understanding of how audit works and how it
    can be set up. For more information about Common Criteria itself, refer
    to <a class="link" href="http://www.commoncriteriaportal.org/" target="_blank">the Common
    Criteria Web site</a>.
   </p></dd><dt><span class="chapter"><a href="#cha.audit.setup"><span class="number">33 </span><span class="name">Setting Up the Linux Audit Framework</span></a></span></dt><dd class="toc-abstract"><p>
  This chapter shows how to set up a simple audit scenario. Every step
  involved in configuring and enabling audit is explained in detail. After
  you have learned to set up audit, consider a real-world example scenario
  in <a class="xref" href="#cha.audit.scenarios" title="Chapter 34. Introducing an Audit Rule Set">Chapter 34, <em>Introducing an Audit Rule Set</em></a>.
 </p></dd><dt><span class="chapter"><a href="#cha.audit.scenarios"><span class="number">34 </span><span class="name">Introducing an Audit Rule Set</span></a></span></dt><dd class="toc-abstract"><p>
  The following example configuration illustrates how audit can be used to
  monitor your system. It highlights the most important items that need to
  be audited to cover the list of auditable events specified by Controlled
  Access Protection Profile (CAPP).
 </p></dd><dt><span class="chapter"><a href="#cha.audit.moreinfo"><span class="number">35 </span><span class="name">Useful Resources</span></a></span></dt><dd class="toc-abstract"><p>
  There are other resources available containing valuable information about
  the Linux audit framework:
 </p></dd></dl></div><div class="chapter " id="cha.audit.comp"><div class="titlepage"><div><div><h2 class="title"><span class="number">32 </span><span class="name">Understanding Linux Audit</span> <a title="Permalink" class="permalink" href="#cha.audit.comp">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>audit_components.xml</li><li><span class="ds-label">ID: </span>cha.audit.comp</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="#idm140712065411744">#</a></h6></div><p>
    The Linux audit framework as shipped with this version of
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> provides a CAPP-compliant (Controlled Access Protection
    Profiles) auditing system that reliably collects information about any
    security-relevant event. The audit records can be examined to determine
    whether any violation of the security policies has been committed, and
    by whom.
   </p><p>
    Providing an audit framework is an important requirement for a
    CC-CAPP/EAL (Common Criteria-Controlled Access Protection
    Profiles/Evaluation Assurance Level) certification. Common Criteria (CC)
    for Information Technology Security Information is an international
    standard for independent security evaluations. Common Criteria helps
    customers judge the security level of any IT product they intend to
    deploy in mission-critical setups.
   </p><p>
    Common Criteria security evaluations have two sets of evaluation
    requirements, functional and assurance requirements. Functional
    requirements describe the security attributes of the product under
    evaluation and are summarized under the Controlled Access Protection
    Profiles (CAPP). Assurance requirements are summarized under the
    Evaluation Assurance Level (EAL). EAL describes any activities that must
    take place for the evaluators to be confident that security attributes
    are present, effective, and implemented. Examples for activities of this
    kind include documenting the developers' search for security
    vulnerabilities, the patch process, and testing.
   </p><p>
    This guide provides a basic understanding of how audit works and how it
    can be set up. For more information about Common Criteria itself, refer
    to <a class="link" href="http://www.commoncriteriaportal.org/" target="_blank">the Common
    Criteria Web site</a>.
   </p></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.audit.bigpicture"><span class="number">32.1 </span><span class="name">Introducing the Components of Linux Audit</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auditd"><span class="number">32.2 </span><span class="name">Configuring the Audit Daemon</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auditctl"><span class="number">32.3 </span><span class="name">Controlling the Audit System Using <code class="command">auditctl</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.rules"><span class="number">32.4 </span><span class="name">Passing Parameters to the Audit System</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aureport"><span class="number">32.5 </span><span class="name">Understanding the Audit Logs and Generating Reports</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.ausearch"><span class="number">32.6 </span><span class="name">Querying the Audit Daemon Logs with <code class="command">ausearch</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.autrace"><span class="number">32.7 </span><span class="name">Analyzing Processes with <code class="command">autrace</code></span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.auviz"><span class="number">32.8 </span><span class="name">Visualizing Audit Data</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.audisp"><span class="number">32.9 </span><span class="name">Relaying Audit Event Notifications</span></a></span></dt></dl></div></div><p>
  Linux audit helps make your system more secure by providing you with a
  means to analyze what is happening on your system in great detail. It does
  not, however, provide additional security itself—it does not
  protect your system from code malfunctions or any kind of exploits.
  Instead, audit is useful for tracking these issues and helps you take
  additional security measures, like <span class="phrase">AppArmor</span>, to prevent them.
 </p><p>
  Audit consists of several components, each contributing crucial
  functionality to the overall framework. The audit kernel module intercepts
  the system calls and records the relevant events. The
  <code class="systemitem">auditd</code> daemon writes the audit
  reports to disk. Various command line utilities take care of displaying,
  querying, and archiving the audit trail.
 </p><p>
  Audit enables you to do the following:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065401280"><span class="term ">Associate Users with Processes</span></dt><dd><p>
     Audit maps processes to the user ID that started them. This makes it
     possible for the administrator or security officer to exactly trace
     which user owns which process and is potentially doing malicious
     operations on the system.
    </p><div id="idm140712065399552" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Renaming User IDs</h6><p>
      Audit does not handle the renaming of UIDs. Therefore avoid renaming
      UIDs (for example, changing <code class="literal">tux</code> from
      <code class="literal">uid=1001</code> to <code class="literal">uid=2000</code>) and
      obsolete UIDs rather than renaming them. Otherwise you would need to
      change <code class="command">auditctl</code> data (audit rules) and would have
      problems retrieving old data correctly.
     </p></div></dd><dt id="idm140712065395856"><span class="term ">Review the Audit Trail</span></dt><dd><p>
     Linux audit provides tools that write the audit reports to disk and
     translate them into human readable format.
    </p></dd><dt id="idm140712065393952"><span class="term ">Review Particular Audit Events</span></dt><dd><p>
     Audit provides a utility that allows you to filter the audit reports
     for certain events of interest. You can filter for:
    </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
       User
      </p></li><li class="listitem "><p>
       Group
      </p></li><li class="listitem "><p>
       Audit ID
      </p></li><li class="listitem "><p>
       Remote Host Name
      </p></li><li class="listitem "><p>
       Remote Host Address
      </p></li><li class="listitem "><p>
       System Call
      </p></li><li class="listitem "><p>
       System Call Arguments
      </p></li><li class="listitem "><p>
       File
      </p></li><li class="listitem "><p>
       File Operations
      </p></li><li class="listitem "><p>
       Success or Failure
      </p></li></ul></div></dd><dt id="idm140712065381968"><span class="term ">Apply a Selective Audit</span></dt><dd><p>
     Audit provides the means to filter the audit reports for events of
     interest and to tune audit to record only selected events. You can
     create your own set of rules and have the audit daemon record only
     those of interest to you.
    </p></dd><dt id="idm140712065379936"><span class="term ">Guarantee the Availability of the Report Data</span></dt><dd><p>
     Audit reports are owned by <code class="systemitem">root</code> and therefore only removable
     by <code class="systemitem">root</code>. Unauthorized users cannot remove the audit logs.
    </p></dd><dt id="idm140712065376608"><span class="term ">Prevent Audit Data Loss</span></dt><dd><p>
     If the kernel runs out of memory, the audit daemon's backlog is
     exceeded, or its rate limit is exceeded, audit can trigger a shutdown
     of the system to keep events from escaping audit's control. This
     shutdown would be an immediate halt of the system triggered by the
     audit kernel component without synchronizing the latest logs to disk.
     The default configuration is to log a warning to syslog rather than to
     halt the system.
    </p><p>
     If the system runs out of disk space when logging, the audit system can
     be configured to perform clean shutdown. The default configuration
     tells the audit daemon to stop logging when it runs out of disk space.
    </p></dd></dl></div><div class="sect1 " id="sec.audit.bigpicture"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.bigpicture"><span class="number">32.1 </span><span class="name">Introducing the Components of Linux Audit</span> <a title="Permalink" class="permalink" href="#sec.audit.bigpicture">#</a></h2></div></div></div><p>
   The following figure illustrates how the various components of audit
   interact with each other:
  </p><div class="figure" id="fig.audit.components"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/audit_components.png"><img src="images/audit_components.png" width="" alt="Introducing the Components of Linux Audit" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 32.1: </span><span class="name">Introducing the Components of Linux Audit </span><a title="Permalink" class="permalink" href="#fig.audit.components">#</a></h6></div></div><p>
   Straight arrows represent the data flow between components while dashed
   arrows represent lines of control between components.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065365504"><span class="term ">auditd</span></dt><dd><p>
      The audit daemon is responsible for writing the audit messages that
      were generated through the audit kernel interface and triggered by
      application and system activity to disk. The way the audit daemon is
      started is controlled by <code class="systemitem">systemd</code>. The audit system functions
      (when started) are controlled by
      <code class="filename">/etc/audit/auditd.conf</code>. For more information
      about <code class="systemitem">auditd</code> and its
      configuration, refer to <a class="xref" href="#sec.audit.auditd" title="32.2. Configuring the Audit Daemon">Section 32.2, “Configuring the Audit Daemon”</a>.
     </p></dd><dt id="idm140712065360928"><span class="term "><code class="command">auditctl</code>
    </span></dt><dd><p>
      The <code class="command">auditctl</code> utility controls the audit system. It
      controls the log generation parameters and kernel settings of the
      audit interface and the rule sets that determine which events
      are tracked. For more information about <code class="command">auditctl</code>,
      refer to <a class="xref" href="#sec.audit.auditctl" title="32.3. Controlling the Audit System Using auditctl">Section 32.3, “Controlling the Audit System Using <code class="command">auditctl</code>”</a>.
     </p></dd><dt id="idm140712065357184"><span class="term ">audit rules</span></dt><dd><p>
      The file <code class="filename">/etc/audit/audit.rules</code> contains a
      sequence of <code class="command">auditctl</code> commands that are loaded at
      system boot time immediately after the audit daemon is started. For
      more information about audit rules, refer to
      <a class="xref" href="#sec.audit.rules" title="32.4. Passing Parameters to the Audit System">Section 32.4, “Passing Parameters to the Audit System”</a>.
     </p></dd><dt id="idm140712065353776"><span class="term ">aureport</span></dt><dd><p>
      The <code class="command">aureport</code> utility allows you to create custom
      reports from the audit event log. This report generation can easily be
      scripted, and the output can be used by various other applications,
      for example, to plot these results. For more information about
      <code class="command">aureport</code>, refer to
      <a class="xref" href="#sec.audit.aureport" title="32.5. Understanding the Audit Logs and Generating Reports">Section 32.5, “Understanding the Audit Logs and Generating Reports”</a>.
     </p></dd><dt id="idm140712065350288"><span class="term ">ausearch</span></dt><dd><p>
      The <code class="command">ausearch</code> utility can search the audit log file
      for certain events using various keys or other characteristics of the
      logged format. For more information about <code class="command">ausearch</code>,
      refer to <a class="xref" href="#sec.audit.ausearch" title="32.6. Querying the Audit Daemon Logs with ausearch">Section 32.6, “Querying the Audit Daemon Logs with <code class="command">ausearch</code>”</a>.
     </p></dd><dt id="idm140712065346896"><span class="term ">audispd</span></dt><dd><p>
      The audit dispatcher daemon
      (<code class="systemitem">audispd</code>) can be used to relay
      event notifications to other applications instead of (or in addition
      to) writing them to disk in the audit log. For more information about
      <code class="systemitem">audispd</code>, refer to
      <a class="xref" href="#sec.audit.audisp" title="32.9. Relaying Audit Event Notifications">Section 32.9, “Relaying Audit Event Notifications”</a>.
     </p></dd><dt id="idm140712065342912"><span class="term ">autrace</span></dt><dd><p>
      The <code class="command">autrace</code> utility traces individual processes in
      a fashion similar to <code class="command">strace</code>. The output of
      <code class="command">autrace</code> is logged to the audit log. For more
      information about <code class="command">autrace</code>, refer to
      <a class="xref" href="#sec.audit.autrace" title="32.7. Analyzing Processes with autrace">Section 32.7, “Analyzing Processes with <code class="command">autrace</code>”</a>.
     </p></dd><dt id="idm140712065338672"><span class="term ">aulast</span></dt><dd><p>
      Prints a list of the last logged-in users, similarly to
      <code class="command">last</code>. <code class="command">aulast</code> searches back
      through the audit logs (or the given audit log file) and displays a
      list of all users logged in and out based on the range of time in the
      audit logs.
     </p></dd><dt id="idm140712065335760"><span class="term ">aulastlog</span></dt><dd><p>
      Prints the last login for all users of a machine similar to the way
      <code class="command">lastlog</code> does. The login name, port, and last login
      time will be printed.
     </p></dd></dl></div></div><div class="sect1 " id="sec.audit.auditd"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.auditd"><span class="number">32.2 </span><span class="name">Configuring the Audit Daemon</span> <a title="Permalink" class="permalink" href="#sec.audit.auditd">#</a></h2></div></div></div><p>
   Before you can actually start generating audit logs and processing them,
   configure the audit daemon itself.


   The <code class="filename">/etc/audit/auditd.conf</code> configuration file
   determines how the audit system functions when the daemon has been
   started. For most use cases, the default settings shipped with
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> should suffice. For CAPP environments, most of these
   parameters need tweaking. The following list briefly introduces the
   parameters available:
  </p><div class="verbatim-wrap"><pre class="screen">log_file = /var/log/audit/audit.log
log_format = RAW
log_group = root
priority_boost = 4
flush = INCREMENTAL
freq = 20
num_logs = 5
disp_qos = lossy
dispatcher = /sbin/audispd
name_format = NONE
##name = mydomain
max_log_file = 6
max_log_file_action = ROTATE
space_left = 75
space_left_action = SYSLOG
action_mail_acct = root
admin_space_left = 50
admin_space_left_action = SUSPEND
disk_full_action = SUSPEND
disk_error_action = SUSPEND
##tcp_listen_port =
tcp_listen_queue = 5
tcp_max_per_addr = 1
##tcp_client_ports = 1024-65535
tcp_client_max_idle = 0
cp_client_max_idle = 0</pre></div><p>
   Depending on whether you want your environment to satisfy the
   requirements of CAPP, you need to be extra restrictive when configuring
   the audit daemon. Where you need to use particular settings to meet the
   CAPP requirements, a <span class="quote">“<span class="quote">CAPP Environment</span>”</span> note tells you how
   to adjust the configuration.
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065327024"><span class="term "><code class="literal">log_file</code>, <code class="literal">log_format</code> and
      <code class="literal">log_group</code>
    </span></dt><dd><p>
      <code class="literal">log_file</code> specifies the location where the audit
      logs should be stored. <code class="literal">log_format</code> determines how
      the audit information is written to disk and
      <code class="literal">log_group</code> defines the group that owns the log
      files. Possible values for <code class="literal">log_format</code> are
      <code class="literal">raw</code> (messages are stored exactly as the kernel
      sends them) or <code class="literal">nolog</code> (messages are discarded and
      not written to disk). The data sent to the audit dispatcher is not
      affected if you use the <code class="literal">nolog</code> mode. The default
      setting is <code class="literal">raw</code> and you should keep it if you want
      to be able to create reports and queries against the audit logs using
      the <code class="command">aureport</code> and <code class="command">ausearch</code> tools.
      The value for <code class="literal">log_group</code> can either be specified
      literally or using the group's ID.
     </p><div id="idm140712065318928" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       In a CAPP environment, have the audit log reside on its own
       partition. By doing so, you can be sure that the space detection of
       the audit daemon is accurate and that you do not have other processes
       consuming this space.
      </p></div></dd><dt id="idm140712065317024"><span class="term "><code class="literal">priority_boost</code>
    </span></dt><dd><p>
      Determine how much of a priority boost the audit daemon should get.
      Possible values are 0 to 20. The resulting nice value calculates like
      this: 0 - priority_boost
     </p></dd><dt id="idm140712065314768"><span class="term "><code class="literal">flush</code> and <code class="literal">freq</code>
    </span></dt><dd><p>
      Specifies whether, how, and how often the audit logs should be written
      to disk. Valid values for <code class="literal">flush</code> are
      <code class="literal">none</code>, <code class="literal">incremental</code>,
      <code class="literal">data</code>, and <code class="literal">sync</code>.
      <code class="literal">none</code> tells the audit daemon not to make any special
      effort to write the audit data to disk. <code class="literal">incremental</code>
      tells the audit daemon to explicitly flush the data to disk. A
      frequency must be specified if <code class="literal">incremental</code> is used.
      A <code class="literal">freq</code> value of <code class="literal">20</code> tells the
      audit daemon to request that the kernel flush the data to disk after
      every 20 records. The <code class="literal">data</code> option keeps the data
      portion of the disk file synchronized at all times while the
      <code class="literal">sync</code> option takes care of both metadata and data.
     </p><div id="idm140712065306704" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       In a CAPP environment, make sure that the audit trail is always fully
       up to date and complete. Therefore, use <code class="literal">sync</code> or
       <code class="literal">data</code> with the <code class="literal">flush</code> parameter.
      </p></div></dd><dt id="idm140712065303584"><span class="term "><code class="literal">num_logs</code>
    </span></dt><dd><p>
      Specify the number of log files to keep if you have given
      <code class="literal">rotate</code> as the
      <code class="literal">max_log_file_action</code>. Possible values range from
      <code class="literal">0</code> to <code class="literal">99</code>. A value less than
      <code class="literal">2</code> means that the log files are not rotated.
      As you increase the number of files to rotate, you increase the amount
      of work required of the audit daemon. While doing this rotation,
      <code class="systemitem">auditd</code> cannot always service
      new data arriving from the kernel as quickly, which can result
      in a backlog condition (triggering
      <code class="systemitem">auditd</code> to react according to
      the failure flag, described in <a class="xref" href="#sec.audit.auditctl" title="32.3. Controlling the Audit System Using auditctl">Section 32.3, “Controlling the Audit System Using <code class="command">auditctl</code>”</a>).
      In this situation, increasing the backlog limit is recommended. Do so
      by changing the value of the <code class="literal">-b</code> parameter in the
      <code class="filename">/etc/audit/audit.rules</code> file.
     </p></dd><dt id="idm140712065295824"><span class="term "><code class="literal">disp_qos</code> and <code class="literal">dispatcher</code>
    </span></dt><dd><p>
      The dispatcher is started by the audit daemon during its start. The
      audit daemon relays the audit messages to the application specified in
      <code class="literal">dispatcher</code>. This application must be a highly
      trusted one, because it needs to run as <code class="systemitem">root</code>.
      <code class="literal">disp_qos</code> determines whether you allow for
      <code class="literal">lossy</code> or <code class="literal">lossless</code> communication
      between the audit daemon and the dispatcher.
     </p><p>
      If you select <code class="literal">lossy</code>, the audit daemon might discard
      some audit messages when the message queue is full. These events still
      get written to disk if <code class="literal">log_format</code> is set to
      <code class="literal">raw</code>, but they might not get through to the
      dispatcher. If you select <code class="literal">lossless</code> the audit
      logging to disk is blocked until there is an empty spot in the message
      queue. The default value is <code class="literal">lossy</code>.
     </p></dd><dt id="idm140712065287504"><span class="term "><code class="literal">name_format</code> and <code class="literal">name</code>
    </span></dt><dd><p>
      <code class="literal">name_format</code> controls how computer names are
      resolved. Possible values are <code class="literal">none</code> (no name will be
      used), <code class="literal">hostname</code> (value returned by gethostname),
      <code class="literal">fqd</code> (fully qualified host name as received through
      a DNS lookup), <code class="literal">numeric</code> (IP address) and
      <code class="literal">user</code>. <code class="literal">user</code> is a custom string
      that needs to be defined with the <code class="literal">name</code> parameter.
     </p></dd><dt id="idm140712065281184"><span class="term "><code class="literal">max_log_file</code> and <code class="literal">max_log_file_action</code>
    </span></dt><dd><p>
      <code class="literal">max_log_file</code> takes a numerical value that specifies
      the maximum file size in megabytes that the log file can reach before
      a configurable action is triggered. The action to be taken is
      specified in <code class="literal">max_log_file_action</code>. Possible values
      for <code class="literal">max_log_file_action</code> are
      <code class="literal">ignore</code>, <code class="literal">syslog</code>,
      <code class="literal">suspend</code>, <code class="literal">rotate</code>, and
      <code class="literal">keep_logs</code>. <code class="literal">ignore</code> tells the
      audit daemon to do nothing when the size limit is reached,
      <code class="literal">syslog</code> tells it to issue a warning and send it to
      syslog, and <code class="literal">suspend</code> causes the audit daemon to stop
      writing logs to disk, leaving the daemon itself still alive.
      <code class="literal">rotate</code> triggers log rotation using the
      <code class="literal">num_logs</code> setting. <code class="literal">keep_logs</code> also
      triggers log rotation, but does not use the <code class="literal">num_log</code>
      setting, so always keeps all logs.
     </p><div id="idm140712065271744" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       To keep a complete audit trail in CAPP environments, the
       <code class="literal">keep_logs</code> option should be used. If using a
       separate partition to hold your audit logs, adjust
       <code class="literal">max_log_file</code> and <code class="literal">num_logs</code> to
       use the entire space available on that partition. Note that the more
       files that need to be rotated, the longer it takes to get back to
       receiving audit events.
      </p></div></dd><dt id="var.audit.auditd.space_left"><span class="term "><code class="literal">space_left</code> and <code class="literal">space_left_action</code>
    </span></dt><dd><p>
      <code class="literal">space_left</code> takes a numerical value in megabytes of
      remaining disk space that triggers a configurable action by the audit
      daemon. The action is specified in
      <code class="literal">space_left_action</code>. Possible values for this
      parameter are <code class="literal">ignore</code>, <code class="literal">syslog</code>,
      <code class="literal">email</code>, <code class="literal">exec</code>,
      <code class="literal">suspend</code>, <code class="literal">single</code>, and
      <code class="literal">halt</code>. <code class="literal">ignore</code> tells the audit
      daemon to ignore the warning and do nothing, <code class="literal">syslog</code>
      has it issue a warning to syslog, and <code class="literal">email</code> sends
      an e-mail to the account specified under
      <code class="literal">action_mail_acct</code>. <code class="literal">exec</code> plus a
      path to a script executes the given script. Note that it is not
      possible to pass parameters to the script. <code class="literal">suspend</code>
      tells the audit daemon to stop writing to disk but remain alive while
      <code class="literal">single</code> triggers the system to be brought down to
      single user mode. <code class="literal">halt</code> triggers a full shutdown of
      the system.
     </p><div id="idm140712065257520" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       Make sure that <code class="literal">space_left</code> is set to a value that
       gives the administrator enough time to react to the alert and allows
       it to free enough disk space for the audit daemon to continue to
       work. Freeing disk space would involve calling <code class="command">aureport
       -t</code> and archiving the oldest logs on a separate archiving
       partition or resource. The actual value for
       <code class="literal">space_left</code> depends on the size of your deployment.
       Set <code class="literal">space_left_action</code> to <code class="literal">email</code>.
      </p></div></dd><dt id="idm140712065253280"><span class="term "><code class="literal">action_mail_acct</code>
    </span></dt><dd><p>
      Specify an e-mail address or alias to which any alert messages should
      be sent. The default setting is <code class="literal">root</code>, but you can
      enter any local or remote account as long as e-mail and the network
      are properly configured on your system and
      <code class="filename">/usr/lib/sendmail</code> exists.
     </p></dd><dt id="idm140712065250080"><span class="term "><code class="literal">admin_space_left</code> and <code class="literal">admin_space_left_action</code>
    </span></dt><dd><p>
      <code class="literal">admin_space_left</code> takes a numerical value in
      megabytes of remaining disk space. The system is already running low
      on disk space when this limit is reached and the administrator has one
      last chance to react to this alert and free disk space for the audit
      logs. The value of <code class="literal">admin_space_left</code> should be lower
      than the value for <code class="literal">space_left</code>. The possible values
      for <code class="literal">admin_space_left_action</code> are the same as for
      <code class="literal">space_left_action</code>.
     </p><div id="idm140712065245344" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       Set <code class="literal">admin_space_left</code> to a value that would allow
       the administrator's actions to be recorded. The action should be set
       to <code class="literal">single</code>.
      </p></div></dd><dt id="idm140712065242688"><span class="term "><code class="literal">disk_full_action</code>
    </span></dt><dd><p>
      Specify which action to take when the system runs out of disk space for
      the audit logs. Valid values are <code class="literal">ignore</code>,
      <code class="literal">syslog</code>, <code class="literal">rotate</code>,
      <code class="literal">exec</code>, <code class="literal">suspend</code>,
      <code class="literal">single</code>, and <code class="literal">halt</code>. For an
      explanation of these values refer to <a class="xref" href="#var.audit.auditd.space_left"><code class="literal">space_left</code> and <code class="literal">space_left_action</code>
    </a>.
     </p><div id="idm140712065237088" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       As the <code class="literal">disk_full_action</code> is triggered when there is
       absolutely no more room for any audit logs, you should bring the
       system down to single-user mode (<code class="literal">single</code>) or shut
       it down completely (<code class="literal">halt</code>).
      </p></div></dd><dt id="idm140712065233936"><span class="term "><code class="literal">disk_error_action</code>
    </span></dt><dd><p>
      Specify which action to take when the audit daemon encounters any kind
      of disk error while writing the logs to disk or rotating the logs. The
      possible value are the same as for
      <code class="literal">space_left_action</code>.
     </p><div id="idm140712065231536" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: CAPP Environment</h6><p>
       Use <code class="literal">syslog</code>, <code class="literal">single</code>, or
       <code class="literal">halt</code> depending on your site's policies regarding
       the handling of any kind of hardware failure.
      </p></div></dd><dt id="idm140712065228432"><span class="term "><code class="literal">tcp_listen_port</code>, <code class="literal">tcp_listen_queue</code>,
      <code class="literal">tcp_client_ports</code>, <code class="literal">tcp_client_max_idle</code>, and
<code class="literal">tcp_max_per_addr</code>
    </span></dt><dd><p>
      The audit daemon can receive audit events from other audit daemons.
      The tcp parameters let you control incoming connections. Specify a
      port between 1 and 65535 with <code class="literal">tcp_listen_port</code> on
      which the <code class="systemitem">auditd</code> will listen.
      <code class="literal">tcp_listen_queue</code> lets you configure a maximum value
      for pending connections. Make sure not to set a value too small, since
      the number of pending connections may be high under certain
      circumstances, such as after a power outage.
      <code class="literal">tcp_client_ports</code> defines which client ports are
      allowed. Either specify a single port or a port range with numbers
      separated by a dash (for example 1-1023 for all privileged ports).
     </p><p>
      Specifying a single allowed client port may make it difficult for the
      client to restart their audit subsystem, as it will be unable to
      re-create a connection with the same host addresses and ports until
      the connection closure TIME_WAIT state times out. If a client does not
      respond anymore, <code class="systemitem">auditd</code>
      complains. Specify the number of seconds after which this will happen
      with <code class="literal">tcp_client_max_idle</code>. Keep in mind that this
      setting is valid for all clients and therefore should be higher than
      any individual client heartbeat setting, preferably by a factor of
      two. <code class="literal">tcp_max_per_addr</code> is a numeric value
      representing how many concurrent connections from one IP address are
      allowed.
     </p><div id="idm140712065219536" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
       We recommend using privileged ports for client and server to prevent
       non-root (CAP_NET_BIND_SERVICE) programs from binding to those ports.
      </p></div></dd></dl></div><p>
   When the daemon configuration in
   <code class="filename">/etc/audit/auditd.conf</code> is complete, the next step is
   to focus on controlling the amount of auditing the daemon does, and to
   assign sufficient resources and limits to the daemon so it can operate
   smoothly.
  </p></div><div class="sect1 " id="sec.audit.auditctl"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.auditctl"><span class="number">32.3 </span><span class="name">Controlling the Audit System Using <code class="command">auditctl</code></span> <a title="Permalink" class="permalink" href="#sec.audit.auditctl">#</a></h2></div></div></div><p>
   <code class="command">auditctl</code> is responsible for controlling the status and
   some basic system parameters of the audit daemon. It controls the amount
   of auditing performed on the system. Using audit rules,
   <code class="command">auditctl</code> controls which components of your system are
   subjected to the audit and to what extent they are audited. Audit rules
   can be passed to the audit daemon on the <code class="command">auditctl</code>
   command line or by composing a rule set and instructing the audit
   daemon to process this file. By default, the
   <code class="systemitem">auditd</code> daemon is configured to
   check for audit rules under <code class="filename">/etc/audit/audit.rules</code>.
   For more details on audit rules, refer to
   <a class="xref" href="#sec.audit.rules" title="32.4. Passing Parameters to the Audit System">Section 32.4, “Passing Parameters to the Audit System”</a>.
  </p><p>
   The main <code class="command">auditctl</code> commands to control basic audit
   system parameters are:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     <code class="command">auditctl</code> <code class="option">-e</code> to enable or disable
     audit
    </p></li><li class="listitem "><p>
     <code class="command">auditctl</code> <code class="option">-f</code> to control the failure
     flag
    </p></li><li class="listitem "><p>
     <code class="command">auditctl</code> <code class="option">-r</code> to control the rate
     limit for audit messages
    </p></li><li class="listitem "><p>
     <code class="command">auditctl</code> <code class="option">-b</code> to control the backlog
     limit
    </p></li><li class="listitem "><p>
     <code class="command">auditctl</code> <code class="option">-s</code> to query the current
     status of the audit daemon
    </p><div id="idm140712065200544" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip</h6><p>
      Before running <code class="command">auditctl -S</code> on your system, add
      <code class="option">-F arch=b64</code> to prevent the architecture mismatch
      warning.
     </p></div></li></ul></div><p>
   The <code class="option">-e</code>, <code class="option">-f</code>, <code class="option">-r</code>, and
   <code class="option">-b</code> options can also be specified in the
   <code class="filename">audit.rules</code> file to avoid having to enter them each
   time the audit daemon is started.
  </p><p>
   Any time you query the status of the audit daemon with
   <code class="command">auditctl</code> <code class="option">-s</code> or change the status flag
   with <code class="command">auditctl</code>
   <code class="option">-e<em class="replaceable ">FLAG</em></code>, a status message
   (including information on each of the above-mentioned parameters) is
   printed. The following example highlights the typical audit status
   message.
  </p><div class="example" id="ex.auditctl.status"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.1: </span><span class="name">Example output of <code class="command">auditctl</code> <code class="option">-s</code> </span><a title="Permalink" class="permalink" href="#ex.auditctl.status">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">AUDIT_STATUS: enabled=1 flag=2 pid=3105 rate_limit=0 backlog_limit=8192 lost=0 backlog=0</pre></div></div></div><div class="table" id="tab.audit.auditctl"><div class="table-title-wrap"><h6 class="table-title"><span class="number">Table 32.1: </span><span class="name">Audit Status Flags </span><a title="Permalink" class="permalink" href="#tab.audit.auditctl">#</a></h6></div><div class="table-contents"><table summary="Audit Status Flags" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th>
       <p>
        Flag
       </p>
      </th><th>
       <p>
        Meaning [Possible Values]
       </p>
      </th><th>
       <p>
        Command
       </p>
      </th></tr></thead><tbody><tr><td>
       <p>
        <code class="literal">enabled</code>
       </p>
      </td><td>
       <p>
        Set the enable flag. [0..2] 0=disable, 1=enable, 2=enable and lock
        down the configuration
       </p>
      </td><td>
       <p>
        <code class="command">auditctl</code> <code class="option">-e [0|1|2]</code>
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">flag</code>
       </p>
      </td><td>
       <p>
        Set the failure flag. [0..2] 0=silent, 1=printk, 2=panic (immediate
        halt without synchronizing pending data to disk)
       </p>
      </td><td>
       <p>
        <code class="command">auditctl</code> <code class="option">-f [0|1|2]</code>
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">pid</code>
       </p>
      </td><td>
       <p>
        Process ID under which
        <code class="systemitem">auditd</code> is running.
       </p>
      </td><td>
       <p>
        —
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">rate_limit</code>
       </p>
      </td><td>
       <p>
        Set a limit in messages per second. If the rate is not zero and is
        exceeded, the action specified in the failure flag is triggered.
       </p>
      </td><td>
       <p>
        <code class="command">auditctl</code> <code class="option">-r
        <em class="replaceable ">RATE</em></code>
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">backlog_limit</code>
       </p>
      </td><td>
       <p>
        Specify the maximum number of outstanding audit buffers allowed. If
        all buffers are full, the action specified in the failure flag is
        triggered.
       </p>
      </td><td>
       <p>
        <code class="command">auditctl</code> <code class="option">-b
        <em class="replaceable ">BACKLOG</em></code>
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">lost</code>
       </p>
      </td><td>
       <p>
        Count the current number of lost audit messages.
       </p>
      </td><td>
       <p>
        —
       </p>
      </td></tr><tr><td>
       <p>
        <code class="literal">backlog</code>
       </p>
      </td><td>
       <p>
        Count the current number of outstanding audit buffers.
       </p>
      </td><td>
       <p>
        —
       </p>
      </td></tr></tbody></table></div></div></div><div class="sect1 " id="sec.audit.rules"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.rules"><span class="number">32.4 </span><span class="name">Passing Parameters to the Audit System</span> <a title="Permalink" class="permalink" href="#sec.audit.rules">#</a></h2></div></div></div><p>
   Commands to control the audit system can be invoked individually from the
   shell using <code class="command">auditctl</code> or batch read from a file using
   <code class="command">auditctl -</code> <code class="option">R</code>. This latter method is
   used by the init scripts to load rules from the file
   <code class="filename">/etc/audit/audit.rules</code> after the audit daemon has
   been started. The rules are executed in order from top to bottom. Each of
   these rules would expand to a separate <code class="command">auditctl</code>
   command. The syntax used in the rules file is the same as that used for
   the <code class="command">auditctl</code> command.
  </p><p>
   Changes made to the running audit system by executing
   <code class="command">auditctl</code> on the command line are not persistent across
   system restarts. For changes to persist, add them to the
   <code class="filename">/etc/audit/audit.rules</code> file and, if they are not
   currently loaded into audit, restart the audit system to load the
   modified rule set by using the <code class="command">systemctl restart
   auditd</code> command.
  </p><div class="example" id="ex.audit.rules.sysparam"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.2: </span><span class="name">Example Audit Rules—Audit System Parameters </span><a title="Permalink" class="permalink" href="#ex.audit.rules.sysparam">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">-b 1000<span id="co.aurules.b"></span><span class="callout">1</span>
-f 1<span id="co.aurules.f"></span><span class="callout">2</span>
-r 10<span id="co.aurules.r"></span><span class="callout">3</span>
-e 1<span id="co.aurules.e"></span><span class="callout">4</span></pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.b"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Specify the maximum number of outstanding audit buffers. Depending on
     the level of logging activity, you might need to adjust the number of
     buffers to avoid causing too heavy an audit load on your system.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.f"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Specify the failure flag to use. See
     <a class="xref" href="#tab.audit.auditctl" title="Audit Status Flags">Table 32.1, “Audit Status Flags”</a> for possible values.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.r"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Specify the maximum number of messages per second that may be issued by
     the kernel. See <a class="xref" href="#tab.audit.auditctl" title="Audit Status Flags">Table 32.1, “Audit Status Flags”</a> for details.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.e"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     Enable or disable the audit subsystem.
    </p></td></tr></table></div><p>
   Using audit, you can track any kind of file system access to important
   files, configurations or resources. You can add watches on these and
   assign keys to each kind of watch for better identification in the logs.
  </p><div class="example" id="ex.audit.rules.fs"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.3: </span><span class="name">Example Audit Rules—File System Auditing </span><a title="Permalink" class="permalink" href="#ex.audit.rules.fs">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">-w /etc/shadow<span id="co.aurules.fs"></span><span class="callout">1</span>
-w /etc -p rx<span id="co.aurules.fsmode"></span><span class="callout">2</span>
-w /etc/passwd -k fk_passwd -p rwxa<span id="co.aurules.fskey"></span><span class="callout">3</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.fs"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
      The <code class="literal">-w</code> option tells audit to add a watch to the
      file specified, in this case <code class="filename">/etc/shadow</code>. All
      system calls requesting access permissions to this file are analyzed.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.fsmode"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
      This rule adds a watch to the <code class="filename">/etc</code> directory and
      applies permission filtering for read and execute access to this
      directory (<code class="literal">-p rx</code>). Any system call requesting any
      of these two permissions is analyzed. Only the creation of new files
      and the deletion of existing ones are logged as directory-related
      events. To get more specific events for files located under this
      particular directory, you should add a separate rule for each file. A
      file must exist before you add a rule containing a watch on it.
      Auditing files as they are created is not supported.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.fskey"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
      This rule adds a file watch to <code class="filename">/etc/passwd</code>.
      Permission filtering is applied for read, write, execute, and
      attribute change permissions. The <code class="literal">-k</code> option allows
      you to specify a key to use to filter the audit logs for this
      particular event later (for example with <code class="command">ausearch</code>).
      You may use the same key on different rules to be able to
      group rules when searching for them. It is also possible to apply
      multiple keys to a rule.
     </p></td></tr></table></div></div></div><p>
   System call auditing lets you track your system's behavior on a level
   even below the application level. When designing these rules, consider
   that auditing a great many system calls may increase your system load and
   cause you to run out of disk space. Consider carefully which events need
   tracking and how they can be filtered to be even more specific.
  </p><div class="example" id="ex.audit.rules.syscall"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.4: </span><span class="name">Example Audit Rules—System Call Auditing </span><a title="Permalink" class="permalink" href="#ex.audit.rules.syscall">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">-a exit,always -S mkdir<span id="co.aurules.scalladd"></span><span class="callout">1</span>
-a exit,always -S access -F a1=4<span id="co.aurules.scallfilter"></span><span class="callout">2</span>
-a exit,always -S ipc -F a0=2<span id="co.aurules.scallipc"></span><span class="callout">3</span>
-a exit,always -S open -F success!=0<span id="co.aurules.scalls"></span><span class="callout">4</span>
-a task,always -F auid=0<span id="co.aurules.scalltask"></span><span class="callout">5</span>
-a task,always -F uid=0 -F auid=501 -F gid=wheel<span id="co.aurules.scallsu"></span><span class="callout">6</span></pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scalladd"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     This rule activates auditing for the <code class="systemitem">mkdir</code>
     system call. The <code class="literal">-a</code> option adds system call rules.
     This rule triggers an event whenever the <code class="systemitem">mkdir</code>
     system call is entered (<code class="literal">exit</code>,
     <code class="literal">always</code>). The <code class="literal">-S</code> option specifies
     the system call to which this rule should be applied.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scallfilter"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     This rule adds auditing to the access system call, but only if the
     second argument of the system call (<code class="literal">mode</code>) is
     <code class="literal">4</code> (<code class="literal">R_OK</code>).
     <code class="literal">exit,always</code> tells audit to add an audit context to
     this system call when entering it, and to write out a report when
     it gets audited.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scallipc"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     This rule adds an audit context to the IPC multiplexed system call. The
     specific <code class="literal">ipc</code> system call is passed as the first
     syscall argument and can be selected using <code class="option">-F
     a0=<em class="replaceable ">IPC_CALL_NUMBER</em></code>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scalls"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     This rule audits failed attempts to call open.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scalltask"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     This rule is an example of a task rule (keyword:
     <code class="literal">task</code>). It is different from the other rules above in
     that it applies to processes that are forked or cloned. To filter these
     kind of events, you can only use fields that are known at fork time,
     such as UID, GID, and AUID. This example rule filters for all tasks
     carrying an audit ID of <code class="literal">0</code>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scallsu"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     This last rule makes heavy use of filters. All filter options are
     combined with a logical AND operator, meaning that this rule applies to
     all tasks that carry the audit ID of <code class="literal">501</code>, run as
     <code class="systemitem">root</code>, and have <code class="literal">wheel</code> as the group. A
     process is given an audit ID on user login. This ID is then handed down
     to any child process started by the initial process of the user. Even
     if the user changes his identity, the audit ID stays the same and
     allows tracing actions to the original user.
    </p></td></tr></table></div><div id="idm140712065099600" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Filtering System Call Arguments</h6><p>
    For more details on filtering system call arguments, refer to
    <a class="xref" href="#sec.audit.scenipc" title="34.6. Filtering System Call Arguments">Section 34.6, “Filtering System Call Arguments”</a>.
   </p></div><p>
   You cannot only add rules to the audit system, but also remove them.
   There are different methods for deleting the entire rule set at once or
   for deleting system call rules or file and directory watches:
  </p><div class="example" id="ex.audit.ruledel"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.5: </span><span class="name">Deleting Audit Rules and Events </span><a title="Permalink" class="permalink" href="#ex.audit.ruledel">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">-D<span id="co.aurules.d"></span><span class="callout">1</span>
-d exit,always -S mkdir<span id="co.aurules.scalldel"></span><span class="callout">2</span>
-W /etc<span id="co.aurules.fsdel"></span><span class="callout">3</span></pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.d"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Clear the queue of audit rules and delete any preexisting rules. This
     rule is used as the first rule in
     <code class="filename">/etc/audit/audit.rules</code> files to make sure that the
     rules that are about to be added do not clash with any preexisting
     ones. The <code class="command">auditctl</code> <code class="option">-D</code> command is
     also used before doing an <code class="command">autrace</code> to avoid having
     the trace rules clash with any rules present in the
     <code class="filename">audit.rules</code> file.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.scalldel"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     This rule deletes a system call rule. The <code class="literal">-d</code> option
     must precede any system call rule that needs to be deleted from the
     rule queue, and must match exactly.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.aurules.fsdel"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     This rule tells audit to discard the rule with the directory watch on
     <code class="filename">/etc</code> from the rules queue. This rule deletes any
     rule containing a directory watch on <code class="filename">/etc</code>,
     regardless of any permission filtering or key options.
    </p></td></tr></table></div><p>
   To get an overview of which rules are currently in use in your audit
   setup, run <code class="command">auditctl</code> <code class="option">-l</code>. This command
   displays all rules with one rule per line.
  </p><div class="example" id="idm140712065083760"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.6: </span><span class="name">Listing Rules with <code class="command">auditctl</code> <code class="option">-l</code> </span><a title="Permalink" class="permalink" href="#idm140712065083760">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">exit,always watch=/etc perm=rx
exit,always watch=/etc/passwd perm=rwxa key=fk_passwd
exit,always watch=/etc/shadow perm=rwxa
exit,always syscall=mkdir
exit,always a1=4 (0x4) syscall=access
exit,always a0=2 (0x2) syscall=ipc
exit,always success!=0 syscall=open</pre></div></div></div><div id="idm140712065081440" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Creating Filter Rules</h6><p>
    You can build very sophisticated audit rules by using the various filter
    options. Refer to the <code class="command">auditctl(8)</code> man page for more
    information about the options available for building audit filter rules,
    and audit rules in general.
   </p></div></div><div class="sect1 " id="sec.audit.aureport"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.aureport"><span class="number">32.5 </span><span class="name">Understanding the Audit Logs and Generating Reports</span> <a title="Permalink" class="permalink" href="#sec.audit.aureport">#</a></h2></div></div></div><p>
   To understand what the <code class="command">aureport</code> utility does, it is
   vital to know how the logs generated by the audit daemon are structured,
   and what exactly is recorded for an event. Only then can you decide which
   report types are most appropriate for your needs.
  </p><div class="sect2 " id="sec.audit.aureport.ustand"><div class="titlepage"><div><div><h3 class="title" id="sec.audit.aureport.ustand"><span class="number">32.5.1 </span><span class="name">Understanding the Audit Logs</span> <a title="Permalink" class="permalink" href="#sec.audit.aureport.ustand">#</a></h3></div></div></div><p>
    The following examples highlight two typical events that are logged by
    audit and how their trails in the audit log are read. The audit log or
    logs (if log rotation is enabled) are stored in the
    <code class="filename">/var/log/audit</code> directory. The first example is a
    simple <code class="command">less</code> command. The second example covers a
    great deal of PAM activity in the logs when a user tries to remotely log
    in to a machine running audit.
   </p><div class="example" id="ex.audit.aureport.logtrail"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.7: </span><span class="name">A Simple Audit Event—Viewing the Audit Log </span><a title="Permalink" class="permalink" href="#ex.audit.aureport.logtrail">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">type=SYSCALL msg=audit(1234874638.599:5207): arch=c000003e syscall=2 success=yes exit=4 a0=62fb60 a1=0 a2=31 a3=0 items=1 ppid=25400 pid
=25616 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts1 ses=1164 comm="less" exe="/usr/bin/less" key="doc_log"
type=CWD msg=audit(1234874638.599:5207):  cwd="/root"
type=PATH msg=audit(1234874638.599:5207): item=0 name="/var/log/audit/audit.log" inode=1219041 dev=08:06 mode=0100644 ouid=0 ogid=0 rdev=00:00</pre></div></div></div><p>
    The above event, a simple <code class="command">less
    /var/log/audit/audit.log</code>, wrote three messages to the log. All
    of them are closely linked together and you would not be able to make
    sense of one of them without the others. The first message reveals the
    following information:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712065070384"><span class="term "><code class="literal">type</code>
     </span></dt><dd><p>
       The type of event recorded. In this case, it assigns the
       <code class="literal">SYSCALL</code> type to an event triggered by a system
       call. The <code class="literal">CWD</code> event was recorded to record the
       current working directory at the time of the syscall. A
       <code class="literal">PATH</code> event is generated for each path passed to
       the system call. The open system call takes only one path argument,
       so only generates one <code class="literal">PATH</code> event. It is important
       to understand that the <code class="literal">PATH</code> event reports the path
       name string argument without any further interpretation, so a
       relative path requires manual combination with the path reported by
       the <code class="literal">CWD</code> event to determine the object accessed.
      </p></dd><dt id="idm140712065065056"><span class="term "><code class="literal">msg</code>
     </span></dt><dd><p>
       A message ID enclosed in brackets. The ID splits into two parts. All
       characters before the <code class="literal">:</code> represent a Unix epoch
       time stamp. The number after the colon represents the actual event
       ID. All events that are logged from one application's system call
       have the same event ID. If the application makes a second system
       call, it gets another event ID.
      </p></dd><dt id="idm140712065062160"><span class="term "><code class="literal">arch</code>
     </span></dt><dd><p>
       References the CPU architecture of the system call. Decode this
       information using the <code class="option">-i</code> option on any of your
       <code class="command">ausearch</code> commands when searching the logs.
      </p></dd><dt id="idm140712065059056"><span class="term "><code class="literal">syscall</code>
     </span></dt><dd><p>
       The type of system call as it would have been printed by an strace on
       this particular system call. This data is taken from the list of
       system calls under <code class="filename">/usr/include/asm/unistd.h</code> and
       may vary depending on the architecture. In this case,
       <code class="literal">syscall=2</code> refers to the open system call (see
       <code class="command">man open(2)</code>) invoked by the less application.
      </p></dd><dt id="idm140712065055328"><span class="term "><code class="literal">success</code>
     </span></dt><dd><p>
       Whether the system call succeeded or failed.
      </p></dd><dt id="idm140712065053200"><span class="term "><code class="literal">exit</code>
     </span></dt><dd><p>
       The exit value returned by the system call. For the
       <code class="command">open</code> system call used in this example, this is the
       file descriptor number. This varies by system call.
      </p></dd><dt id="idm140712065050528"><span class="term "><code class="literal">a0</code> to <code class="literal">a3</code>
     </span></dt><dd><p>
       The first four arguments to the system call in numeric form. The
       values of these are system call dependent. In this example (an
       <code class="command">open</code> system call), the following are used:
      </p><div class="verbatim-wrap"><pre class="screen">a0=62fb60 a1=8000 a2=31 a3=0</pre></div><p>
       <code class="literal">a0</code> is the start address of the passed path name.
       <code class="literal">a1</code> is the flags. <code class="literal">8000</code> in hex
       notation translates to <code class="literal">100000</code> in octal notation,
       which in turn translates to <code class="literal">O_LARGEFILE</code>.
       <code class="literal">a2</code> is the mode, which, because
       <code class="literal">O_CREAT</code> was not specified, is unused.
       
       <code class="literal">a3</code> is not passed by the <code class="command">open</code>
       system call. Check the manual page of the relevant system call to
       find out which arguments are used with it.
      </p></dd><dt id="idm140712065041744"><span class="term "><code class="literal">items</code>
     </span></dt><dd><p>
       The number of strings passed to the application.
      </p></dd><dt id="idm140712065039616"><span class="term "><code class="literal">ppid</code>
     </span></dt><dd><p>
       The process ID of the parent of the process analyzed.
      </p></dd><dt id="idm140712065037488"><span class="term "><code class="literal">pid</code>
     </span></dt><dd><p>
       The process ID of the process analyzed.
      </p></dd><dt id="idm140712065035376"><span class="term "><code class="literal">auid</code>
     </span></dt><dd><p>
       The audit ID. A process is given an audit ID on user login. This ID
       is then handed down to any child process started by the initial
       process of the user. Even if the user changes his identity (for
       example, becomes <code class="systemitem">root</code>), the audit ID stays the same. Thus
       you can always trace actions to the original user who logged in.
      </p></dd><dt id="idm140712065032256"><span class="term "><code class="literal">uid</code>
     </span></dt><dd><p>
       The user ID of the user who started the process. In this case,
       <code class="literal">0</code> for <code class="systemitem">root</code>.
      </p></dd><dt id="idm140712065028944"><span class="term "><code class="literal">gid</code>
     </span></dt><dd><p>
       The group ID of the user who started the process. In this case,
       <code class="literal">0</code> for <code class="systemitem">root</code>.
      </p></dd><dt id="idm140712065025632"><span class="term "><code class="literal">euid</code>, <code class="literal">suid</code>, <code class="literal">fsuid</code>
     </span></dt><dd><p>
       Effective user ID, set user ID, and file system user ID of the user
       that started the process.
      </p></dd><dt id="idm140712065022560"><span class="term "><code class="literal">egid</code>, <code class="literal">sgid</code>, <code class="literal">fsgid</code>
     </span></dt><dd><p>
       Effective group ID, set group ID, and file system group ID of the
       user that started the process.
      </p></dd><dt id="idm140712065019488"><span class="term "><code class="literal">tty</code>
     </span></dt><dd><p>
       The terminal from which the application was started. In this case, a
       pseudo-terminal used in an SSH session.
      </p></dd><dt id="idm140712065017296"><span class="term "><code class="literal">ses</code>
     </span></dt><dd><p>
       The login session ID. This process attribute is set when a user logs
       in and can tie any process to a particular user login.
      </p></dd><dt id="idm140712065015088"><span class="term "><code class="literal">comm</code>
     </span></dt><dd><p>
       The application name under which it appears in the task list.
      </p></dd><dt id="idm140712065012944"><span class="term "><code class="literal">exe</code>
     </span></dt><dd><p>
       The resolved path name to the binary program.
      </p></dd><dt id="idm140712065010816"><span class="term "><code class="literal">subj</code>
     </span></dt><dd><p>
       <code class="systemitem">auditd</code> records whether the
       process is subject to any security context, such as <span class="phrase">AppArmor</span>.
       <code class="literal">unconstrained</code>, as in this case, means that the
       process is not confined with <span class="phrase">AppArmor</span>. If the process had been
       confined, the binary path name plus the <span class="phrase">AppArmor</span> profile mode would
       have been logged.
      </p></dd><dt id="idm140712065005536"><span class="term "><code class="literal">key</code>
     </span></dt><dd><p>
       If you are auditing many directories or files, assign
       key strings to each of these watches. You can use these keys with
       <code class="command">ausearch</code> to search the logs for events of this
       type only.
      </p></dd></dl></div><p>
    The second message triggered by the example <code class="command">less</code> call
    does not reveal anything apart from the current working directory when
    the <code class="command">less</code> command was executed.
   </p><p>
    The third message reveals the following (the <code class="literal">type</code> and
    <code class="literal">message</code> flags have already been introduced):
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064999504"><span class="term "><code class="literal">item</code>
     </span></dt><dd><p>
       In this example, <code class="literal">item</code> references the
       <code class="literal">a0</code> argument—a path—that is
       associated with the original <code class="literal">SYSCALL</code> message. Had
       the original call had more than one path argument (such as a
       <code class="command">cp</code> or <code class="command">mv</code> command), an
       additional <code class="literal">PATH</code> event would have been logged for
       the second path argument.
      </p></dd><dt id="idm140712064994512"><span class="term "><code class="literal">name</code>
     </span></dt><dd><p>
       Refers to the path name passed as an argument to the open system
       call.
      </p></dd><dt id="idm140712064992352"><span class="term "><code class="literal">inode</code>
     </span></dt><dd><p>
       Refers to the inode number corresponding to <code class="literal">name</code>.
      </p></dd><dt id="idm140712064989792"><span class="term "><code class="literal">dev</code>
     </span></dt><dd><p>
       Specifies the device on which the file is stored. In this case,
       <code class="literal">08:06</code>, which stands for
       <code class="literal">/dev/sda1</code> or <span class="quote">“<span class="quote">first partition on the first
       IDE device.</span>”</span>
      </p></dd><dt id="idm140712064986256"><span class="term "><code class="literal">mode</code>
     </span></dt><dd><p>
       Numerical representation of the file's access permissions. In this
       case, <code class="systemitem">root</code> has read and write permissions and his group
       (<code class="systemitem">root</code>) has read access while the entire rest of the world
       cannot access the file.
      </p></dd><dt id="idm140712064982544"><span class="term "><code class="literal">ouid</code> and <code class="literal">ogid</code>
     </span></dt><dd><p>
       Refer to the UID and GID of the inode itself.
      </p></dd><dt id="idm140712064979968"><span class="term "><code class="literal">rdev</code>
     </span></dt><dd><p>
       Not applicable for this example. The <code class="literal">rdev</code> entry
       only applies to block or character devices, not to files.
      </p></dd></dl></div><p>
    <a class="xref" href="#ex.audit.aureport.sshd" title="An Advanced Audit Event—Login via SSH">Example 32.8, “An Advanced Audit Event—Login via SSH”</a> highlights the audit events
    triggered by an incoming SSH connection. Most of the messages are
    related to the PAM stack and reflect the different stages of the SSH PAM
    process. Several of the audit messages carry nested PAM messages in them
    that signify that a particular stage of the PAM process has been
    reached. Although the PAM messages are logged by audit, audit assigns
    its own message type to each event:
   </p><div class="example" id="ex.audit.aureport.sshd"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.8: </span><span class="name">An Advanced Audit Event—Login via SSH </span><a title="Permalink" class="permalink" href="#ex.audit.aureport.sshd">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">type=USER_AUTH msg=audit(1234877011.791:7731): user pid=26127 uid=0 <span id="co.audit.sshd.auth"></span><span class="callout">1</span>
auid=4294967295 ses=4294967295 msg='op=PAM:authentication acct="root" exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=ssh res=success)'
type=USER_ACCT msg=audit(1234877011.795:7732): user pid=26127 uid=0 <span id="co.audit.sshd.acct"></span><span class="callout">2</span>
auid=4294967295 ses=4294967295 msg='op=PAM:accounting acct="root" exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=ssh res=success)'
type=CRED_ACQ msg=audit(1234877011.799:7733): user pid=26125 uid=0 <span id="co.audit.sshd.acq"></span><span class="callout">3</span>
auid=4294967295 ses=4294967295 msg='op=PAM:setcred acct="root" exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=/dev/pts/0 res=success)'
type=LOGIN msg=audit(1234877011.799:7734): login pid=26125 uid=0
old auid=4294967295 new auid=0 old ses=4294967295 new ses=1172
type=USER_START msg=audit(1234877011.799:7735): user pid=26125 uid=0 <span id="co.audit.sshd.start"></span><span class="callout">4</span>
auid=0 ses=1172 msg='op=PAM:session_open acct="root" exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=/dev/pts/0 res=success)'
type=USER_LOGIN msg=audit(1234877011.823:7736): user pid=26128 uid=0 <span id="co.audit.sshd.login"></span><span class="callout">5</span>
auid=0 ses=1172 msg='uid=0: exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=/dev/pts/0 res=success)'
type=CRED_REFR msg=audit(1234877011.828:7737): user pid=26128 uid=0 <span id="co.audit.sshd.refr"></span><span class="callout">6</span>
auid=0 ses=1172 msg='op=PAM:setcred acct="root" exe="/usr/sbin/sshd"
(hostname=jupiter.example.com, addr=192.168.2.100, terminal=/dev/pts/0 res=success)'</pre></div></div></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.auth"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
      PAM reports that is has successfully requested user authentication for
      <code class="systemitem">root</code> from a remote host (jupiter.example.com, 192.168.2.100). The
      terminal where this is happening is <code class="literal">ssh</code>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.acct"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
      PAM reports that it has successfully determined whether the user is
      authorized to log in.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.acq"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
      PAM reports that the appropriate credentials to log in have been
      acquired and that the terminal changed to a normal terminal
      (<code class="literal">/dev/pts0</code>).
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.start"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
      PAM reports that it has successfully opened a session for
      <code class="systemitem">root</code>.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.login"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
      The user has successfully logged in. This event is the one used by
      <code class="command">aureport</code> <code class="option">-l</code> to report about user
      logins.
     </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sshd.refr"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
      PAM reports that the credentials have been successfully reacquired.
     </p></td></tr></table></div></div><div class="sect2 " id="sec.audit.aureport.gen"><div class="titlepage"><div><div><h3 class="title" id="sec.audit.aureport.gen"><span class="number">32.5.2 </span><span class="name">Generating Custom Audit Reports</span> <a title="Permalink" class="permalink" href="#sec.audit.aureport.gen">#</a></h3></div></div></div><p>
    The raw audit reports stored in the <code class="filename">/var/log/audit</code>
    directory tend to become very bulky and hard to understand. To more
    easily find relevant messages, use the <code class="command">aureport</code>
    utility and create custom reports.
   </p><p>
    The following use cases highlight a few of the possible report types
    that you can generate with <code class="command">aureport</code>:
   </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064953104"><span class="term ">Read Audit Logs from Another File</span></dt><dd><p>
       When the audit logs have moved to another machine or when you want to
       analyze the logs of several machines on your local machine
       without wanting to connect to each of these individually, move the
       logs to a local file and have <code class="command">aureport</code> analyze
       them locally:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -if myfile</code>

Summary Report
======================
Range of time in logs: 03/02/09 14:13:38.225 - 17/02/09 14:52:27.971
Selected time for report: 03/02/09 14:13:38 - 17/02/09 14:52:27.971
Number of changes in configuration: 13
Number of changes to accounts, groups, or roles: 0
Number of logins: 6
Number of failed logins: 13
Number of authentications: 7
Number of failed authentications: 573
Number of users: 1
Number of terminals: 9
Number of host names: 4
Number of executables: 17
Number of files: 279
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 994
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 0
Number of keys: 2
Number of process IDs: 1211
Number of events: 5320</pre></div><p>
       The above command, <code class="command">aureport</code> without any arguments,
       provides only the standard general summary report generated from the
       logs contained in <code class="filename">myfile</code>. To create more
       detailed reports, combine the <code class="option">-if</code> option with any of
       the options below. For example, generate a login report that is
       limited to a certain time frame:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -l -ts 14:00 -te 15:00 -if myfile</code>

Login Report
============================================
# date time auid host term exe success event
============================================
1. 17/02/09 14:21:09 root: 192.168.2.100 sshd /usr/sbin/sshd no 7718
2. 17/02/09 14:21:15 0 jupiter /dev/pts/3 /usr/sbin/sshd yes 7724</pre></div></dd><dt id="idm140712064944544"><span class="term ">Convert Numeric Entities to Text</span></dt><dd><p>
       Some information, such as user IDs, are printed in numeric form. To
       convert these into a human-readable text format, add the
       <code class="option">-i</code> option to your <code class="command">aureport</code>
       command.
      </p></dd><dt id="idm140712064941712"><span class="term ">Create a Rough Summary Report</span></dt><dd><p>
       If you are interested in the current audit statistics (events,
       logins, processes, etc.), run <code class="command">aureport</code> without any
       other option.
      </p></dd><dt id="idm140712064939328"><span class="term ">Create a Summary Report of Failed Events</span></dt><dd><p>
       If you want to break down the overall statistics of plain
       <code class="command">aureport</code> to the statistics of failed events, use
       <code class="command">aureport</code> <code class="option">--failed</code>:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport --failed</code>

Failed Summary Report
======================
Range of time in logs: 03/02/09 14:13:38.225 - 17/02/09 14:57:35.183
Selected time for report: 03/02/09 14:13:38 - 17/02/09 14:57:35.183
Number of changes in configuration: 0
Number of changes to accounts, groups, or roles: 0
Number of logins: 0
Number of failed logins: 13
Number of authentications: 0
Number of failed authentications: 574
Number of users: 1
Number of terminals: 5
Number of host names: 4
Number of executables: 11
Number of files: 77
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 994
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 0
Number of keys: 2
Number of process IDs: 708
Number of events: 1583</pre></div></dd><dt id="idm140712064933872"><span class="term ">Create a Summary Report of Successful Events</span></dt><dd><p>
       If you want to break down the overall statistics of a plain
       <code class="command">aureport</code> to the statistics of successful events,
       use <code class="command">aureport</code> <code class="option">--success</code>:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport --success</code>

Success Summary Report
======================
Range of time in logs: 03/02/09 14:13:38.225 - 17/02/09 15:00:01.535
Selected time for report: 03/02/09 14:13:38 - 17/02/09 15:00:01.535
Number of changes in configuration: 13
Number of changes to accounts, groups, or roles: 0
Number of logins: 6
Number of failed logins: 0
Number of authentications: 7
Number of failed authentications: 0
Number of users: 1
Number of terminals: 7
Number of host names: 3
Number of executables: 16
Number of files: 215
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 0
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 0
Number of keys: 2
Number of process IDs: 558
Number of events: 3739</pre></div></dd><dt id="idm140712064928416"><span class="term ">Create Summary Reports</span></dt><dd><p>
       In addition to the dedicated summary reports (main summary and failed
       and success summary), use the <code class="option">--summary</code> option with
       most of the other options to create summary reports for a particular
       area of interest only. Not all reports support this option, however.
       This example creates a summary report for user login events:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -u -i --summary</code>

User Summary Report
===========================
total  auid
===========================
5640  root
13  tux
3  wilber</pre></div></dd><dt id="idm140712064924272"><span class="term ">Create a Report of Events</span></dt><dd><p>
       To get an overview of the events logged by audit, use the
       <code class="command">aureport</code> <code class="option">-e</code> command. This command
       generates a numbered list of all events including date, time, event
       number, event type, and audit ID.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -e -ts 14:00 -te 14:21

Event Report
===================================
# date time event type auid success
===================================
1. 17/02/09 14:20:27 7462 DAEMON_START 0 yes
2. 17/02/09 14:20:27 7715 CONFIG_CHANGE 0 yes
3. 17/02/09 14:20:57 7716 USER_END 0 yes
4. 17/02/09 14:20:57 7717 CRED_DISP 0 yes
5. 17/02/09 14:21:09 7718 USER_LOGIN -1 no
6. 17/02/09 14:21:15 7719 USER_AUTH -1 yes
7. 17/02/09 14:21:15 7720 USER_ACCT -1 yes
8. 17/02/09 14:21:15 7721 CRED_ACQ -1 yes
9. 17/02/09 14:21:15 7722 LOGIN 0 yes
10. 17/02/09 14:21:15 7723 USER_START 0 yes
11. 17/02/09 14:21:15 7724 USER_LOGIN 0 yes
12. 17/02/09 14:21:15 7725 CRED_REFR 0 yes</pre></div></dd><dt id="idm140712064919696"><span class="term ">Create a Report from All Process Events</span></dt><dd><p>
       To analyze the log from a process's point of view, use the
       <code class="command">aureport</code> <code class="option">-p</code> command. This command
       generates a numbered list of all process events including date, time,
       process ID, name of the executable, system call, audit ID, and event
       number.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="command">aureport -p</code>

Process ID Report
======================================
# date time pid exe syscall auid event
======================================
1. 13/02/09 15:30:01 32742 /usr/sbin/cron 0 0 35
2. 13/02/09 15:30:01 32742 /usr/sbin/cron 0 0 36
3. 13/02/09 15:38:34 32734 /usr/lib/gdm/gdm-session-worker 0 -1 37</pre></div></dd><dt id="idm140712064915728"><span class="term ">Create a Report from All System Call Events</span></dt><dd><p>
       To analyze the audit log from a system call's point of view, use the
       <code class="command">aureport</code> <code class="option">-s</code> command. This command
       generates a numbered list of all system call events including date,
       time, number of the system call, process ID, name of the command that
       used this call, audit ID, and event number.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -s</code>

Syscall Report
=======================================
# date time syscall pid comm auid event
=======================================
1. 16/02/09 17:45:01 2 20343 cron -1 2279
2. 16/02/09 17:45:02 83 20350 mktemp 0 2284
3. 16/02/09 17:45:02 83 20351 mkdir 0 2285</pre></div></dd><dt id="idm140712064910992"><span class="term ">Create a Report from All Executable Events</span></dt><dd><p>
       To analyze the audit log from an executable's point of view, use the
       <code class="command">aureport</code> <code class="option">-x</code> command. This command
       generates a numbered list of all executable events including date,
       time, name of the executable, the terminal it is run in, the host
       executing it, the audit ID, and event number.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="command">aureport -x</code>

Executable Report
====================================
# date time exe term host auid event
====================================
1. 13/02/09 15:08:26 /usr/sbin/sshd sshd 192.168.2.100 -1 12
2. 13/02/09 15:08:28 /usr/lib/gdm/gdm-session-worker :0 ? -1 13
3. 13/02/09 15:08:28 /usr/sbin/sshd ssh 192.168.2.100 -1 14</pre></div></dd><dt id="idm140712064906960"><span class="term ">Create a Report about Files</span></dt><dd><p>
       To generate a report from the audit log that focuses on file access,
       use the <code class="command">aureport</code> <code class="option">-f</code> command. This
       command generates a numbered list of all file-related events
       including date, time, name of the accessed file, number of the system
       call accessing it, success or failure of the command, the executable
       accessing the file, audit ID, and event number.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -f</code>

File Report
===============================================
# date time file syscall success exe auid event
===============================================
1. 16/02/09 17:45:01 /etc/shadow 2 yes /usr/sbin/cron -1 2279
2. 16/02/09 17:45:02 /tmp/ 83 yes /bin/mktemp 0 2284
3. 16/02/09 17:45:02 /var 83 no /bin/mkdir 0 2285</pre></div></dd><dt id="idm140712064902112"><span class="term ">Create a Report about Users</span></dt><dd><p>
       To generate a report from the audit log that illustrates which users
       are running what executables on your system, use the
       <code class="command">aureport</code> <code class="option">-u</code> command. This command
       generates a numbered list of all user-related events including date,
       time, audit ID, terminal used, host, name of the executable, and an
       event ID.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="command">aureport -u</code>

User ID Report
====================================
# date time auid term host exe event
====================================
1. 13/02/09 15:08:26 -1 sshd 192.168.2.100 /usr/sbin/sshd 12
2. 13/02/09 15:08:28 -1 :0 ? /usr/lib/gdm/gdm-session-worker 13
3. 14/02/09 08:25:39 -1 ssh 192.168.2.101 /usr/sbin/sshd 14</pre></div></dd><dt id="idm140712064898064"><span class="term ">Create a Report about Logins</span></dt><dd><p>
       To create a report that focuses on login attempts to your machine,
       run the <code class="command">aureport</code> <code class="option">-l</code> command. This
       command generates a numbered list of all login-related events
       including date, time, audit ID, host and terminal used, name of the
       executable, success or failure of the attempt, and an event ID.
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -l -i</code>

Login Report
============================================
# date time auid host term exe success event
============================================
1. 13/02/09 15:08:31 tux: 192.168.2.100 sshd /usr/sbin/sshd no 19
2. 16/02/09 12:39:05 root: 192.168.2.101 sshd /usr/sbin/sshd no 2108
3. 17/02/09 15:29:07 geeko: ? tty3 /bin/login yes 7809</pre></div></dd><dt id="idm140712064893264"><span class="term ">Limit a Report to a Certain Time Frame</span></dt><dd><p>
       To analyze the logs for a particular time frame, such as only the
       working hours of Feb 16, 2009, first find out whether this data is
       contained in the current <code class="filename">audit.log</code> or whether
       the logs have been rotated in by running <code class="command">aureport</code>
       <code class="option">-t</code>:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="command">aureport -t</code>

Log Time Range Report
=====================
/var/log/audit/audit.log: 03/02/09 14:13:38.225 - 17/02/09 15:30:01.636</pre></div><p>
       The current <code class="filename">audit.log</code> contains all the desired
       data. Otherwise, use the <code class="option">-if</code> option to point the
       <code class="command">aureport</code> commands to the log file that contains
       the needed data.
      </p><p>
       Then, specify the start date and time and the end date and time of
       the desired time frame and combine it with the report option needed.
       This example focuses on login attempts:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -ts 02/16/09 8:00 -te 02/16/09 18:00 -l</code>

Login Report
============================================
# date time auid host term exe success event
============================================
1. 16/02/09 12:39:05 root: 192.168.2.100 sshd /usr/sbin/sshd no 2108
2. 16/02/09 12:39:12 0 192.168.2.100 /dev/pts/1 /usr/sbin/sshd yes 2114
3. 16/02/09 13:09:28 root: 192.168.2.100 sshd /usr/sbin/sshd no 2131
4. 16/02/09 13:09:32 root: 192.168.2.100 sshd /usr/sbin/sshd no 2133
5. 16/02/09 13:09:37 0 192.168.2.100 /dev/pts/2 /usr/sbin/sshd yes 2139</pre></div><p>
       The start date and time are specified with the <code class="option">-ts</code>
       option. Any event that has a time stamp equal to or after your given
       start time appears in the report. If you omit the date,
       <code class="command">aureport</code> assumes that you meant
       <span class="emphasis"><em>today</em></span>. If you omit the time, it assumes that the
       start time should be midnight of the date specified.


      </p><p>
       Specify the end date and time with the <code class="option">-te</code> option.
       Any event that has a time stamp equal to or before your given event
       time appears in the report. If you omit the date,
       <code class="command">aureport</code> assumes that you meant today. If you omit
       the time, it assumes that the end time should be now. Use the same
       format for the date and time as for <code class="option">-ts</code>.
      </p></dd></dl></div><p>
    All reports except the summary ones are printed in column format and
    sent to STDOUT, which means that this data can be written to other
    commands very easily. The visualization scripts introduced in
    <a class="xref" href="#sec.audit.auviz" title="32.8. Visualizing Audit Data">Section 32.8, “Visualizing Audit Data”</a> are examples of how to further process
    the data generated by audit.
   </p></div></div><div class="sect1 " id="sec.audit.ausearch"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.ausearch"><span class="number">32.6 </span><span class="name">Querying the Audit Daemon Logs with <code class="command">ausearch</code></span> <a title="Permalink" class="permalink" href="#sec.audit.ausearch">#</a></h2></div></div></div><p>
   The <code class="command">aureport</code> tool helps you to create overall
   summaries of what is happening on the system, but if you are interested
   in the details of a particular event, <code class="command">ausearch</code> is the
   tool to use.
  </p><p>
   <code class="command">ausearch</code> allows you to search the audit logs using
   special keys and search phrases that relate to most of the flags that
   appear in event messages in
   <code class="filename">/var/log/audit/audit.log</code>. Not all record types
   contain the same search phrases. There are no <code class="literal">hostname</code>
   or <code class="literal">uid</code> entries in a <code class="literal">PATH</code> record,
   for example.
  </p><p>
   When searching, make sure that you choose appropriate search criteria to
   catch all records you need. On the other hand, you could be searching for
   a specific type of record and still get various other related records
   along with it. This is caused by different parts of the kernel
   contributing additional records for events that are related to the one to
   find. For example, you would always get a <code class="literal">PATH</code> record
   along with the <code class="literal">SYSCALL</code> record for an
   <code class="command">open</code> system call.
  </p><div id="idm140712064870624" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Using Multiple Search Options</h6><p>
    Any of the command line options can be combined with logical AND
    operators to narrow down your search.
   </p></div><div class="variablelist "><dl class="variablelist"><dt id="idm140712064868880"><span class="term ">Read Audit Logs from Another File</span></dt><dd><p>
      When the audit logs have moved to another machine or when you want to
      analyze the logs of several machines on your local machine without
      wanting to connect to each of these individually, move the logs to a
      local file and have <code class="command">ausearch</code> search them locally:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">ausearch -</code> <em class="replaceable ">option</em> -if <em class="replaceable ">myfile</em></pre></div></dd><dt id="idm140712064864160"><span class="term ">Convert Numeric Results into Text</span></dt><dd><p>
      Some information, such as user IDs are printed in numeric form. To
      convert these into human readable text format, add the
      <code class="option">-i</code> option to your <code class="command">ausearch</code>
      command.
     </p></dd><dt id="idm140712064861328"><span class="term ">Search by Audit Event ID</span></dt><dd><p>
      If you have previously run an audit report or done an
      <code class="command">autrace</code>, you should analyze the trail of a
      particular event in the log. Most of the report types described in
      <a class="xref" href="#sec.audit.aureport" title="32.5. Understanding the Audit Logs and Generating Reports">Section 32.5, “Understanding the Audit Logs and Generating Reports”</a> include audit event IDs in their
      output. An audit event ID is the second part of an audit message ID,
      which consists of a Unix epoch time stamp and the audit event ID
      separated by a colon. All events that are logged from one
      application's system call have the same event ID. Use this event ID
      with <code class="command">ausearch</code> to retrieve this event's trail from
      the log.
     </p><p>
      Use a command similar to the following:
     </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">ausearch -a 5207</code>
----
time-&gt;Tue Feb 17 13:43:58 2009
type=PATH msg=audit(1234874638.599:5207): item=0 name="/var/log/audit/audit.log" inode=1219041 dev=08:06 mode=0100644 ouid=0 ogid=0 rdev=00:00
type=CWD msg=audit(1234874638.599:5207):  cwd="/root"
type=SYSCALL msg=audit(1234874638.599:5207): arch=c000003e syscall=2 success=yes exit=4 a0=62fb60 a1=0 a2=31 a3=0 items=1 ppid=25400 pid=25616 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts1 ses=1164 comm="less" exe="/usr/bin/less" key="doc_log"</pre></div><p>
      The <code class="command">ausearch</code> <code class="option">-a</code> command grabs all
      records in the logs that are related to the audit event ID provided
      and displays them. This option can be combined with any other option.
     </p></dd><dt id="idm140712064853616"><span class="term ">Search by Message Type</span></dt><dd><p>
      To search for audit records of a particular message type, use the
      <code class="command">ausearch</code> <code class="option">-m
      <em class="replaceable ">MESSAGE_TYPE</em></code> command. Examples of
      valid message types include <code class="literal">PATH</code>,
      <code class="literal">SYSCALL</code>, and <code class="literal">USER_LOGIN</code>. Running
      <code class="command">ausearch</code> <code class="option">-m</code> without a message type
      displays a list of all message types.
     </p></dd><dt id="idm140712064848224"><span class="term ">Search by Login ID</span></dt><dd><p>
      To view records associated with a particular login user ID, use the
      <code class="command">ausearch</code> <code class="option">-ul</code> command. It displays
      any records related to the user login ID specified provided that user
      had been able to log in successfully.
     </p></dd><dt id="idm140712064845344"><span class="term ">Search by User ID</span></dt><dd><p>
      View records related to any of the user IDs (both user ID and
      effective user ID) with <code class="command">ausearch</code>
      <code class="option">-ua</code>. View reports related to a particular user ID
      with <code class="command">ausearch</code> <code class="option">-ui
      <em class="replaceable ">UID</em></code>. Search for records related to
      a particular effective user ID, use the <code class="command">ausearch</code>
      <code class="option">-ue <em class="replaceable ">EUID</em></code>. Searching for a
      user ID means the user ID of the user creating a process. Searching
      for an effective user ID means the user ID and privileges that are
      required to run this process.
     </p></dd><dt id="idm140712064839904"><span class="term ">Search by Group ID</span></dt><dd><p>
      View records related to any of the group IDs (both group ID and
      effective group ID) with the <code class="command">ausearch</code>
      <code class="option">-ga</code> command. View reports related to a particular
      user ID with <code class="command">ausearch</code> <code class="option">-gi
      <em class="replaceable ">GID</em></code>. Search for records related to
      a particular effective group ID, use <code class="command">ausearch</code>
      <code class="option">-ge <em class="replaceable ">EGID</em></code>.
     </p></dd><dt id="idm140712064834640"><span class="term ">Search by Command Line Name</span></dt><dd><p>
      View records related to a certain command, using the
      <code class="command">ausearch</code> <code class="option">-c
      <em class="replaceable ">COMM_NAME</em></code> command, for example,
      <code class="command">ausearch</code> <code class="option">-c less</code> for all records
      related to the <code class="command">less</code> command.
     </p></dd><dt id="idm140712064830224"><span class="term ">Search by Executable Name</span></dt><dd><p>
      View records related to a certain executable with the
      <code class="command">ausearch</code> <code class="option">-x
      <em class="replaceable ">EXE</em></code> command, for example
      <code class="command">ausearch</code> <code class="option">-x /usr/bin/less</code> for all
      records related to the <code class="command">/usr/bin/less</code> executable.
     </p></dd><dt id="idm140712064825808"><span class="term ">Search by System Call Name</span></dt><dd><p>
      View records related to a certain system call with the
      <code class="command">ausearch</code> <code class="option">-sc
      <em class="replaceable ">SYSCALL</em></code> command, for example,
      <code class="command">ausearch -sc open</code> for all records related to the
      <code class="command">open</code> system call.
     </p></dd><dt id="idm140712064821840"><span class="term ">Search by Process ID</span></dt><dd><p>
      View records related to a certain process ID with the
      <code class="command">ausearch</code> <code class="option">-p
      <em class="replaceable ">PID</em></code> command, for example
      <code class="command">ausearch</code> <code class="option">-p 13368</code> for all records
      related to this process ID.
     </p></dd><dt id="idm140712064817856"><span class="term ">Search by Event or System Call Success Value</span></dt><dd><p>
      View records containing a certain system call success value with
      <code class="command">ausearch</code> <code class="option">-sv
      <em class="replaceable ">SUCCESS_VALUE</em></code>, for example,
      <code class="command">ausearch</code> <code class="option">-sv yes</code> for all
      successful system calls.
     </p></dd><dt id="idm140712064813856"><span class="term ">Search by File Name</span></dt><dd><p>
      View records containing a certain file name with
      <code class="command">ausearch</code> <code class="option">-f
      <em class="replaceable ">FILE_NAME</em></code>, for example,
      <code class="command">ausearch</code> <code class="option">-f /foo/bar</code> for all
      records related to the <code class="filename">/foo/bar</code> file. Using the
      file name alone would work as well, but using relative paths does not
      work.
     </p></dd><dt id="idm140712064809376"><span class="term ">Search by Terminal</span></dt><dd><p>
      View records of events related to a certain terminal only with
      <code class="command">ausearch</code> <code class="option">-tm
      <em class="replaceable ">TERM</em></code>, for example,
      <code class="command">ausearch</code> <code class="option">-tm ssh</code> to view all
      records related to events on the SSH terminal and
      <code class="command">ausearch</code> <code class="option">-tm tty</code> to view all
      events related to the console.
     </p></dd><dt id="idm140712064804448"><span class="term ">Search by Host Name</span></dt><dd><p>
      View records related to a certain remote host name with
      <code class="command">ausearch</code> <code class="option">-hn
      <em class="replaceable ">HOSTNAME</em></code>, for example,
      <code class="command">ausearch</code> <code class="option">-hn jupiter.example.com</code>. You can
      use a host name, fully qualified domain name, or numeric network
      address.
     </p></dd><dt id="idm140712064800448"><span class="term ">Search by Key Field</span></dt><dd><p>
      View records that contain a certain key assigned in the audit rule set
      to identify events of a particular type. Use the
      <code class="command">ausearch</code> <code class="option">-k
      <em class="replaceable ">KEY_FIELD</em></code>, for example,
      <code class="command">ausearch</code> <code class="option">-k CFG_etc</code> to display any
      records containing the <code class="literal">CFG_etc</code> key.
     </p></dd><dt id="idm140712064795968"><span class="term ">Search by Word</span></dt><dd><p>
      View records that contain a certain string assigned in the audit rule
      set to identify events of a particular type. The whole string will be
      matched on file name, host name, and terminal. Use the
      <code class="command">ausearch</code> <code class="option">-w
      <em class="replaceable ">WORD</em></code>.
     </p></dd><dt id="idm140712064792304"><span class="term ">Limit a Search to a Certain Time Frame</span></dt><dd><p>
      Use <code class="option">-ts</code> and <code class="option">-te</code> to limit the scope
      of your searches to a certain time frame. The <code class="option">-ts</code>
      option is used to specify the start date and time and the
      <code class="option">-te</code> option is used to specify the end date and time.
      These options can be combined with any of the above. The use of these
      options is similar to use with <code class="command">aureport</code>.
     </p></dd></dl></div></div><div class="sect1 " id="sec.audit.autrace"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.autrace"><span class="number">32.7 </span><span class="name">Analyzing Processes with <code class="command">autrace</code></span> <a title="Permalink" class="permalink" href="#sec.audit.autrace">#</a></h2></div></div></div><p>
   In addition to monitoring your system using the rules you set up, you can
   also perform dedicated audits of individual processes using the
   <code class="command">autrace</code> command. <code class="command">autrace</code> works
   similarly to the <code class="command">strace</code> command, but gathers slightly
   different information. The output of <code class="command">autrace</code> is
   written to <code class="filename">/var/log/audit/audit.log</code> and does not
   look any different from the standard audit log entries.
  </p><p>
   When performing an <code class="command">autrace</code> on a process, make sure
   that any audit rules are purged from the queue to avoid these rules
   clashing with the ones <code class="command">autrace</code> adds itself. Delete the
   audit rules with the <code class="command">auditctl</code> <code class="option">-D</code>
   command. This stops all normal auditing.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">auditctl -D</code>

No rules

<code class="command">autrace /usr/bin/less</code>

Waiting to execute: /usr/bin/less
Cleaning up...
No rules
Trace complete. You can locate the records with 'ausearch -i -p 7642'</pre></div><p>
   Always use the full path to the executable to track with
   <code class="command">autrace</code>. After the trace is complete,
   <code class="command">autrace</code> provides the event ID of the trace, so you can
   analyze the entire data trail with <code class="command">ausearch</code>. To
   restore the audit system to use the audit rule set again, restart the
   audit daemon with <code class="command">systemctl restart auditd</code>.
  </p></div><div class="sect1 " id="sec.audit.auviz"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.auviz"><span class="number">32.8 </span><span class="name">Visualizing Audit Data</span> <a title="Permalink" class="permalink" href="#sec.audit.auviz">#</a></h2></div></div></div><p>
   Neither the data trail in <code class="filename">/var/log/audit/audit.log</code>
   nor the different report types generated by <code class="command">aureport</code>,
   described in <a class="xref" href="#sec.audit.aureport.gen" title="32.5.2. Generating Custom Audit Reports">Section 32.5.2, “Generating Custom Audit Reports”</a>, provide an
   intuitive reading experience to the user. The <code class="command">aureport</code>
   output is formatted in columns and thus easily available to any sed,
   Perl, or awk scripts that users might connect to the audit framework to
   visualize the audit data.
  </p><p>
   The visualization scripts (see <a class="xref" href="#sec.audit.viz" title="33.6. Configuring Log Visualization">Section 33.6, “Configuring Log Visualization”</a>) are one
   example of how to use standard Linux tools available with
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> or any other Linux distribution to create easy-to-read
   audit output. The following examples help you understand how the plain
   audit reports can be transformed into human readable graphics.
  </p><p>
   The first example illustrates the relationship of programs and system
   calls. To get to this kind of data, you need to determine the appropriate
   <code class="command">aureport</code> command that delivers the source data from
   which to generate the final graphic:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -s -i</code>

Syscall Report
=======================================
# date time syscall pid comm auid event
=======================================
1. 16/02/09 17:45:01 open 20343 cron unset 2279
2. 16/02/09 17:45:02 mkdir 20350 mktemp root 2284
3. 16/02/09 17:45:02 mkdir 20351 mkdir root 2285
...</pre></div><p>
   The first thing that the visualization script needs to do on this report
   is to extract only those columns that are of interest, in this example,
   the <code class="literal">syscall</code> and the <code class="literal">comm</code> columns.
   The output is sorted and duplicates removed then the final output is
   written into the visualization program itself:
  </p><div class="verbatim-wrap"><pre class="screen">LC_ALL=C aureport -s -i | awk '/^[0-9]/ { print $6" "$4 }' | sort | uniq | mkgraph</pre></div><div class="figure" id="fig.audit.mkgraph"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/audit_mkgraph.png"><img src="images/audit_mkgraph.png" width="" alt="Flow Graph—Program versus System Call Relationship" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 32.2: </span><span class="name">Flow Graph—Program versus System Call Relationship </span><a title="Permalink" class="permalink" href="#fig.audit.mkgraph">#</a></h6></div></div><p>
   The second example illustrates the different types of events and how many
   of each type have been logged. The appropriate
   <code class="command">aureport</code> command to extract this kind of information
   is <code class="command">aureport -e</code>:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -e -i --summary

Event Summary Report
======================
total  type
======================
2434  SYSCALL
816  USER_START
816  USER_ACCT
814  CRED_ACQ
810  LOGIN
806  CRED_DISP
779  USER_END
99  CONFIG_CHANGE
52  USER_LOGIN</pre></div><p>
   Because this type of report already contains a two column output, it is
   only fed into the visualization script and transformed into a bar chart.
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -e -i --summary  | mkbar events</pre></div><div class="figure" id="fig.audit.mkbar"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/audit_mkbar.png"><img src="images/audit_mkbar.png" width="" alt="Bar Chart—Common Event Types" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 32.3: </span><span class="name">Bar Chart—Common Event Types </span><a title="Permalink" class="permalink" href="#fig.audit.mkbar">#</a></h6></div></div><p>
   For background information about the visualization of audit data, refer
   to the Web site of the audit project at
   <a class="link" href="http://people.redhat.com/sgrubb/audit/visualize/index.html" target="_blank">http://people.redhat.com/sgrubb/audit/visualize/index.html</a>.
  </p></div><div class="sect1 " id="sec.audit.audisp"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.audisp"><span class="number">32.9 </span><span class="name">Relaying Audit Event Notifications</span> <a title="Permalink" class="permalink" href="#sec.audit.audisp">#</a></h2></div></div></div><p>
   The auditing system also allows external applications to access and
   use the <code class="systemitem">auditd</code> daemon in real
   time. This feature is provided by so called <span class="emphasis"><em>audit
   dispatcher</em></span> which allows, for example, intrusion detection
   systems to use <code class="systemitem">auditd</code> to receive
   enhanced detection information.
  </p><p>
   <code class="systemitem">audispd</code> is a daemon which
   controls the audit dispatcher. It is normally started by
   <code class="systemitem">auditd</code>.
   <code class="systemitem">audispd</code> takes audit events and
   distributes them to the programs which want to analyze them in real time.
   Configuration of <code class="systemitem">auditd</code> is stored
   in <code class="filename">/etc/audisp/audispd.conf</code>. The file has the
   following options:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064740560"><span class="term "><code class="literal">q_depth</code>
    </span></dt><dd><p>
      Specifies the size of the event dispatcher internal queue. If syslog
      complains about audit events getting dropped, increase this value.
      Default is 80.
     </p></dd><dt id="idm140712064738320"><span class="term "><code class="literal">overflow_action</code>
    </span></dt><dd><p>
      Specifies the way the audit daemon will react to the internal queue
      overflow. Possible values are <code class="option">ignore</code> (nothing
      happens), <code class="option">syslog</code> (issues a warning to syslog),
      <code class="option">suspend</code> (audispd will stop processing events),
      <code class="option">single</code> (the computer system will be put in single
      user mode), or <code class="option">halt</code> (shuts the system down).
     </p></dd><dt id="idm140712064733776"><span class="term "><code class="literal">priority_boost</code>
    </span></dt><dd><p>
      Specifies the priority for the audit event dispatcher (in addition to
      the audit daemon priority itself). Default is 4 which means no change
      in priority.
     </p></dd><dt id="idm140712064731536"><span class="term "><code class="literal">name_format</code>
    </span></dt><dd><p>
      Specifies the way the computer node name is inserted into the audit
      event. Possible values are <code class="option">none</code> (no computer name is
      inserted), <code class="option">hostname</code> (name returned by the
      <code class="systemitem">gethostname</code> system call),
      <code class="option">fqd</code> (fully qualified domain name of the machine),
      <code class="option">numeric</code> (IP address of the machine), or
      <code class="option">user</code> (user defined string from the
      <code class="option">name</code> option). Default is <code class="option">none</code>.
     </p></dd><dt id="idm140712064725680"><span class="term "><code class="literal">name</code>
    </span></dt><dd><p>
      Specifies a user defined string which identifies the machine. The
      <code class="option">name_format</code> option must be set to
      <code class="option">user</code>, otherwise this option is ignored.
     </p></dd><dt id="idm140712064722592"><span class="term "><code class="literal">max_restarts</code>
    </span></dt><dd><p>
      A non-negative number that tells the audit event dispatcher how many
      times it can try to restart a crashed plug-in. The default is 10.
     </p></dd></dl></div><div class="example" id="idm140712064720208"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.9: </span><span class="name">Example /etc/audisp/audispd.conf </span><a title="Permalink" class="permalink" href="#idm140712064720208">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">  q_depth = 80
  overflow_action = SYSLOG
  priority_boost = 4
  name_format = HOSTNAME
  #name = mydomain</pre></div></div></div><p>
   The plug-in programs install their configuration files in a special
   directory dedicated to <code class="systemitem">audispd</code>
   plug-ins. It is <code class="filename">/etc/audisp/plugins.d</code> by default.
   The plug-in configuration files have the following options:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064716704"><span class="term "><code class="literal">active</code>
    </span></dt><dd><p>
      Specifies if the program will use
      <code class="systemitem">audispd</code>. Possible values are
      <code class="option">yes</code> or <code class="option">no</code>.
     </p></dd><dt id="idm140712064712960"><span class="term "><code class="literal">direction</code>
    </span></dt><dd><p>
      Specifies the way the plug-in was designed to communicate with audit.
      It informs the event dispatcher in which directions the events flow.
      Possible values are <code class="option">in</code> or <code class="option">out</code>.
     </p></dd><dt id="idm140712064709824"><span class="term "><code class="literal">path</code>
    </span></dt><dd><p>
      Specifies the absolute path to the plug-in executable. In case of
      internal plug-ins, this option specifies the plug-in name.
     </p></dd><dt id="idm140712064707616"><span class="term "><code class="literal">type</code>
    </span></dt><dd><p>
      Specifies the way the plug-in is to be run. Possible values are
      <code class="option">builtin</code> or <code class="option">always</code>. Use
      <code class="option">builtin</code> for internal plug-ins
      (<code class="literal">af_unix</code> and <code class="literal">syslog</code>) and
      <code class="option">always</code> for most (if not all) other plug-ins. Default
      is <code class="option">always</code>.
     </p></dd><dt id="idm140712064702272"><span class="term "><code class="literal">args</code>
    </span></dt><dd><p>
      Specifies the argument that is passed to the plug-in program.
      Normally, plug-in programs read their arguments from their
      configuration file and do not need to receive any arguments. There is
      a limit of 2 arguments.
     </p></dd><dt id="idm140712064699968"><span class="term "><code class="literal">format</code>
    </span></dt><dd><p>
      Specifies the format of data that the audit dispatcher passes to the
      plug-in program. Valid options are <code class="option">binary</code> or
      <code class="option">string</code>. <code class="option">binary</code> passes the data
      exactly as the event dispatcher receives them from the audit daemon.
      <code class="option">string</code> instructs the dispatcher to change the event
      into a string that is parseable by the audit parsing library. Default
      is <code class="option">string</code>.
     </p></dd></dl></div><div class="example" id="idm140712064695200"><div class="example-title-wrap"><h6 class="example-title"><span class="number">Example 32.10: </span><span class="name">Example /etc/audisp/plugins.d/syslog.conf </span><a title="Permalink" class="permalink" href="#idm140712064695200">#</a></h6></div><div class="example-contents"><div class="verbatim-wrap"><pre class="screen">  active = no
  direction = out
  path = builtin_syslog
  type = builtin
  args = LOG_INFO
  format = string</pre></div></div></div></div></div><div class="chapter " id="cha.audit.setup"><div class="titlepage"><div><div><h2 class="title"><span class="number">33 </span><span class="name">Setting Up the Linux Audit Framework</span> <a title="Permalink" class="permalink" href="#cha.audit.setup">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>audit_setup.xml</li><li><span class="ds-label">ID: </span>cha.audit.setup</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.audit.choose"><span class="number">33.1 </span><span class="name">Determining the Components to Audit</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.config"><span class="number">33.2 </span><span class="name">Configuring the Audit Daemon</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.syscall"><span class="number">33.3 </span><span class="name">Enabling Audit for System Calls</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aurules"><span class="number">33.4 </span><span class="name">Setting Up Audit Rules</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.aurepo"><span class="number">33.5 </span><span class="name">Configuring Audit Reports</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.viz"><span class="number">33.6 </span><span class="name">Configuring Log Visualization</span></a></span></dt></dl></div></div><p>
  This chapter shows how to set up a simple audit scenario. Every step
  involved in configuring and enabling audit is explained in detail. After
  you have learned to set up audit, consider a real-world example scenario
  in <a class="xref" href="#cha.audit.scenarios" title="Chapter 34. Introducing an Audit Rule Set">Chapter 34, <em>Introducing an Audit Rule Set</em></a>.
 </p><p>
  To set up audit on <span class="productname"><span class="phrase">openSUSE Leap</span></span>, you need to complete the following
  steps:
 </p><div class="procedure " id="idm140712064686720"><div class="procedure-title-wrap"><h6 class="procedure-title"><span class="number">Procedure 33.1: </span><span class="name">Setting Up the Linux Audit Framework </span><a title="Permalink" class="permalink" href="#idm140712064686720">#</a></h6></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
    Make sure that all required packages are installed:
    <code class="systemitem">audit</code>,
    <code class="systemitem">audit-libs</code>, and optionally
    <code class="systemitem">audit-libs-python</code>. To use the
    log visualization as described in <a class="xref" href="#sec.audit.viz" title="33.6. Configuring Log Visualization">Section 33.6, “Configuring Log Visualization”</a>,
    install <code class="systemitem">gnuplot</code> and
    <code class="systemitem">graphviz</code> from the
    <span class="productname"><span class="phrase">openSUSE Leap</span></span> media.
   </p></li><li class="step "><p>
    Determine the components to audit. Refer to
    <a class="xref" href="#sec.audit.choose" title="33.1. Determining the Components to Audit">Section 33.1, “Determining the Components to Audit”</a> for details.
   </p></li><li class="step "><p>
    Check or modify the basic audit daemon configuration. Refer to
    <a class="xref" href="#sec.audit.config" title="33.2. Configuring the Audit Daemon">Section 33.2, “Configuring the Audit Daemon”</a> for details.
   </p></li><li class="step "><p>
    Enable auditing for system calls. Refer to
    <a class="xref" href="#sec.audit.syscall" title="33.3. Enabling Audit for System Calls">Section 33.3, “Enabling Audit for System Calls”</a> for details.
   </p></li><li class="step "><p>
    Compose audit rules to suit your scenario. Refer to
    <a class="xref" href="#sec.audit.aurules" title="33.4. Setting Up Audit Rules">Section 33.4, “Setting Up Audit Rules”</a> for details.
   </p></li><li class="step "><p>
    Generate logs and configure tailor-made reports. Refer to
    <a class="xref" href="#sec.audit.aurepo" title="33.5. Configuring Audit Reports">Section 33.5, “Configuring Audit Reports”</a> for details.
   </p></li><li class="step "><p>
    Configure optional log visualization. Refer to
    <a class="xref" href="#sec.audit.viz" title="33.6. Configuring Log Visualization">Section 33.6, “Configuring Log Visualization”</a> for details.
   </p></li></ol></div></div><div id="idm140712064670544" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Controlling the Audit Daemon</h6><p>
   Before configuring any of the components of the audit system, make sure
   that the audit daemon is not running by entering <code class="command">systemctl
   status auditd</code> as <code class="systemitem">root</code>. On a default
   <span class="productname"><span class="phrase">openSUSE Leap</span></span> system, audit is started on boot, so you need to turn it
   off by entering <code class="command">systemctl stop auditd</code>. Start
   the daemon after configuring it with <code class="command">systemctl start
   auditd</code>.
  </p></div><div class="sect1 " id="sec.audit.choose"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.choose"><span class="number">33.1 </span><span class="name">Determining the Components to Audit</span> <a title="Permalink" class="permalink" href="#sec.audit.choose">#</a></h2></div></div></div><p>
   Before starting to create your own audit configuration, determine to
   which degree you want to use it. Check the following general rules to
   determine which use case best applies to you and your requirements:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     If you require a full security audit for CAPP/EAL certification, enable
     full audit for system calls and configure watches on various
     configuration files and directories, similar to the rule set featured
     in <a class="xref" href="#cha.audit.scenarios" title="Chapter 34. Introducing an Audit Rule Set">Chapter 34, <em>Introducing an Audit Rule Set</em></a>.
    </p></li><li class="listitem "><p>
     If you need to trace a process based on the audit rules, use
     <code class="command">autrace</code>.
    </p></li><li class="listitem "><p>
     If you require file and directory watches to track access to important
     or security-sensitive data, create a rule set matching these
     requirements. Enable audit as described in
     <a class="xref" href="#sec.audit.syscall" title="33.3. Enabling Audit for System Calls">Section 33.3, “Enabling Audit for System Calls”</a> and proceed to
     <a class="xref" href="#sec.audit.aurules" title="33.4. Setting Up Audit Rules">Section 33.4, “Setting Up Audit Rules”</a>.
    </p></li></ul></div></div><div class="sect1 " id="sec.audit.config"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.config"><span class="number">33.2 </span><span class="name">Configuring the Audit Daemon</span> <a title="Permalink" class="permalink" href="#sec.audit.config">#</a></h2></div></div></div><p>
   The basic setup of the audit daemon is done by editing
   <code class="filename">/etc/audit/auditd.conf</code>. You may also use YaST
   to configure the basic settings by calling <span class="guimenu">YaST</span> › <span class="guimenu">Security and Users</span> › <span class="guimenu">Linux Audit Framework (LAF)</span>. Use the
   tabs <span class="guimenu">Log File</span> and <span class="guimenu">Disk Space</span> for
   configuration.
  </p><div class="verbatim-wrap"><pre class="screen">log_file = /var/log/audit/audit.log
log_format = RAW
log_group = root
priority_boost = 4
flush = INCREMENTAL
freq = 20
num_logs = 5
disp_qos = lossy
dispatcher = /sbin/audispd
name_format = NONE
##name = mydomain
max_log_file = 6
max_log_file_action = ROTATE
space_left = 75
space_left_action = SYSLOG
action_mail_acct = root
admin_space_left = 50
admin_space_left_action = SUSPEND
disk_full_action = SUSPEND
disk_error_action = SUSPEND
##tcp_listen_port =
tcp_listen_queue = 5
tcp_max_per_addr = 1
##tcp_client_ports = 1024-65535
tcp_client_max_idle = 0
cp_client_max_idle = 0</pre></div><p>
   The default settings work reasonably well for many setups. Some values,
   such as <code class="literal">num_logs</code>, <code class="literal">max_log_file</code>,
   <code class="literal">space_left</code>, and <code class="literal">admin_space_left</code>
   depend on the size of your deployment. If disk space is limited, you
   should reduce the number of log files to keep if they are rotated
   and you should get an earlier warning if disk space is running out.
   For a CAPP-compliant setup, adjust the values for
   <code class="literal">log_file</code>, <code class="literal">flush</code>,
   <code class="literal">max_log_file</code>, <code class="literal">max_log_file_action</code>,
   <code class="literal">space_left</code>, <code class="literal">space_left_action</code>,
   <code class="literal">admin_space_left</code>,
   <code class="literal">admin_space_left_action</code>,
   <code class="literal">disk_full_action</code>, and
   <code class="literal">disk_error_action</code>, as described in
   <a class="xref" href="#sec.audit.auditd" title="32.2. Configuring the Audit Daemon">Section 32.2, “Configuring the Audit Daemon”</a>. An example CAPP-compliant
   configuration looks like this:
  </p><div class="verbatim-wrap"><pre class="screen">log_file = <em class="replaceable ">PATH_TO_SEPARATE_PARTITION</em>/audit.log
log_format = RAW
priority_boost = 4
flush = SYNC                       ### or DATA
freq = 20
num_logs = 4
dispatcher = /sbin/audispd
disp_qos = lossy
max_log_file = 5
max_log_file_action = KEEP_LOGS
space_left = 75
space_left_action = EMAIL
action_mail_acct = root
admin_space_left = 50
admin_space_left_action = SINGLE   ### or HALT
disk_full_action = SUSPEND         ### or HALT
disk_error_action = SUSPEND        ### or HALT</pre></div><p>
   The <code class="literal">###</code> precedes comments where you can choose from
   several options. Do not add the comments to your actual configuration
   files.
  </p><div id="idm140712064641616" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: For More Information</h6><p>
    Refer to <a class="xref" href="#sec.audit.auditd" title="32.2. Configuring the Audit Daemon">Section 32.2, “Configuring the Audit Daemon”</a> for detailed background
    information about the <code class="filename">auditd.conf</code> configuration
    parameters.
   </p></div></div><div class="sect1 " id="sec.audit.syscall"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.syscall"><span class="number">33.3 </span><span class="name">Enabling Audit for System Calls</span> <a title="Permalink" class="permalink" href="#sec.audit.syscall">#</a></h2></div></div></div><p>
   If the audit framework is not installed, install the
   <code class="systemitem">audit</code> package. A standard <span class="productname"><span class="phrase">openSUSE Leap</span></span>
   system does not have auditd running by default. Enable it with:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> systemctl enable auditd</pre></div><p>
   There are different levels of auditing activity available:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064633936"><span class="term ">Basic Logging</span></dt><dd><p>
      Out of the box (without any further configuration) auditd logs only
      events concerning its own configuration changes to
      <code class="filename">/var/log/audit/audit.log</code>. No events (file access,
      system call, etc.) are generated by the kernel audit component until
      requested by <code class="command">auditctl</code>. However, other kernel
      components and modules may log audit events outside of the control of
      <code class="command">auditctl</code> and these appear in the audit log. By
      default, the only module that generates audit events is <span class="phrase">AppArmor</span>.
     </p></dd><dt id="idm140712064629920"><span class="term ">Advanced Logging with System Call Auditing</span></dt><dd><p>
      To audit system calls and get meaningful file watches, you need to
      enable audit contexts for system calls.
     </p></dd></dl></div><p>
   As you need system call auditing capabilities even when you are
   configuring plain file or directory watches, you need to enable audit
   contexts for system calls. To enable audit contexts for the duration of
   the current session only, execute <code class="command">auditctl -e 1</code> as
   <code class="systemitem">root</code>. To disable this feature, execute <code class="command">auditctl -e
   0</code> as <code class="systemitem">root</code>.
  </p><p>
   The audit contexts are enabled by default. To turn this feature off
   temporarily, use <code class="command">auditctl -e 0</code>.
  </p></div><div class="sect1 " id="sec.audit.aurules"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.aurules"><span class="number">33.4 </span><span class="name">Setting Up Audit Rules</span> <a title="Permalink" class="permalink" href="#sec.audit.aurules">#</a></h2></div></div></div><p>
   Using audit rules, determine which aspects of the system should be
   analyzed by audit. Normally this includes important databases and
   security-relevant configuration files. You may also analyze various
   system calls in detail if a broad analysis of your system is required. A
   very detailed example configuration that includes most of the rules that
   are needed in a CAPP compliant environment is available in
   <a class="xref" href="#cha.audit.scenarios" title="Chapter 34. Introducing an Audit Rule Set">Chapter 34, <em>Introducing an Audit Rule Set</em></a>.
  </p><p>
   Audit rules can be passed to the audit daemon on the
   <code class="command">auditctl</code> command line and by composing a rule
   set in <code class="filename">/etc/audit/audit.rules</code> which is processed
   whenever the audit daemon is started. To customize
   <code class="filename">/etc/audit/audit.rules</code> either edit it directly, or
   use YaST: <span class="guimenu">Security and Users</span> › <span class="guimenu">Linux Audit Framework (LAF)</span> › <span class="guimenu">Rules for
   'auditctl'</span>. Rules passed on the command line are
   not persistent and need to be re-entered when the audit daemon is
   restarted.
  </p><p>
   A simple rule set for very basic auditing on a few important files and
   directories could look like this:
  </p><div class="verbatim-wrap"><pre class="screen"># basic audit system parameters
-D
-b 8192
-f 1
-e 1

# some file and directory watches with keys
-w /var/log/audit/ -k LOG_audit
-w /etc/audit/auditd.conf -k CFG_audit_conf -p rxwa
-w /etc/audit/audit.rules -k CFG_audit_rules -p rxwa

-w /etc/passwd -k CFG_passwd -p rwxa
-w /etc/sysconfig/ -k CFG_sysconfig

# an example system call rule
-a entry,always -S umask

### add your own rules</pre></div><p>
   When configuring the basic audit system parameters (such as the backlog
   parameter <code class="literal">-b</code>) test these settings with your intended
   audit rule set to determine whether the backlog size is appropriate for
   the level of logging activity caused by your audit rule set. If your
   chosen backlog size is too small, your system might not be able to handle
   the audit load and consult the failure flag (<code class="literal">-f</code>) when
   the backlog limit is exceeded.
  </p><div id="idm140712064614048" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Choosing the Failure Flag</h6><p>
    When choosing the failure flag, note that <code class="option">-f 2</code> tells
    your system to perform an immediate shutdown without flushing any
    pending data to disk when the limits of your audit system are exceeded.
    Because this shutdown is not a clean shutdown, restrict the use of
    <code class="option">-f 2</code> to only the most security-conscious environments
    and use <code class="option">-f 1</code> (system continues to run, issues a warning
    and audit stops) for any other setup to avoid loss of data or data
    corruption.
   </p></div><p>
   Directory watches produce less verbose output than separate file watches
   for the files under these directories. To get detailed logging for your
   system configuration in <code class="filename">/etc/sysconfig</code>, for example,
   add watches for each file. Audit does not support globbing,
   which means you cannot create a rule that says <code class="literal">-w
   /etc/*</code> and watches all files and directories below
   <code class="filename">/etc</code>.
  </p><p>
   For better identification in the log file, a key has been added to each
   of the file and directory watches. Using the key, it is easier to comb
   the logs for events related to a certain rule. When creating keys,
   distinguish between mere log file watches and configuration file watches
   by using an appropriate prefix with the key, in this case
   <code class="literal">LOG</code> for a log file watch and <code class="literal">CFG</code>
   for a configuration file watch. Using the file name as part of the key
   also makes it easier for you to identify events of this type in the log
   file.
  </p><p>
   Another thing to keep in mind when creating file and directory watches is
   that audit cannot deal with files that do not exist when the rules are
   created. Any file that is added to your system while audit is already
   running is not watched unless you extend the rule set to watch this new
   file.
  </p><p>
   For more information about creating custom rules, refer to
   <a class="xref" href="#sec.audit.rules" title="32.4. Passing Parameters to the Audit System">Section 32.4, “Passing Parameters to the Audit System”</a>.
  </p><div id="idm140712064604672" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Changing Audit Rules</h6><p>
    After you change audit rules, always restart the audit daemon with
    <code class="command">systemctl restart auditd</code> to reread the
    changed rules.
   </p></div></div><div class="sect1 " id="sec.audit.aurepo"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.aurepo"><span class="number">33.5 </span><span class="name">Configuring Audit Reports</span> <a title="Permalink" class="permalink" href="#sec.audit.aurepo">#</a></h2></div></div></div><p>
   To avoid having to dig through the raw audit logs to get an impression of
   what your system is currently doing, run custom audit reports at certain
   intervals. Custom audit reports enable you to focus on areas of interest
   and get meaningful statistics on the nature and frequency of the events
   you are monitoring. To analyze individual events in detail, use the
   ausearch tool.
  </p><p>
   Before setting up audit reporting, consider the following:
  </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
     What types of events do you want to monitor by generating regular
     reports? Select the appropriate aureport command lines as described in
     <a class="xref" href="#sec.audit.aureport.gen" title="32.5.2. Generating Custom Audit Reports">Section 32.5.2, “Generating Custom Audit Reports”</a>.
    </p></li><li class="listitem "><p>
     What do you want to do with the audit reports? Decide whether to create
     graphical charts from the data accumulated or whether it should be
     transferred into any sort of spreadsheet or database. Set up the
     aureport command line and further processing similar to the examples
     shown in <a class="xref" href="#sec.audit.viz" title="33.6. Configuring Log Visualization">Section 33.6, “Configuring Log Visualization”</a> if you want to visualize your
     reports.
    </p></li><li class="listitem "><p>
     When and at which intervals should the reports run? Set up appropriate
     automated reporting using cron.
    </p></li></ul></div><p>
   For this example, assume that you are interested in finding out about any
   attempts to access your audit, PAM, and system configuration. Proceed as
   follows to find out about file events on your system:
  </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Generate a full summary report of all events and check for any
     anomalies in the summary report, for example, have a look at the
     <span class="quote">“<span class="quote">failed syscalls</span>”</span> record, because these might have failed
     because of insufficient permissions to access a file or a file not
     being there:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport</code>

Summary Report
======================
Range of time in logs: 03/02/09 14:13:38.225 - 17/02/09 16:30:10.352
Selected time for report: 03/02/09 14:13:38 - 17/02/09 16:30:10.352
Number of changes in configuration: 24
Number of changes to accounts, groups, or roles: 0
Number of logins: 9
Number of failed logins: 15
Number of authentications: 19
Number of failed authentications: 578
Number of users: 3
Number of terminals: 15
Number of host names: 4
Number of executables: 20
Number of files: 279
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 994
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 0
Number of keys: 2
Number of process IDs: 1238
Number of events: 5435</pre></div></li><li class="step "><p>
     Run a summary report for failed events and check the
     <span class="quote">“<span class="quote">files</span>”</span> record for the number of failed file access
     events:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport</code> <code class="option">--failed</code>

Failed Summary Report
======================
Range of time in logs: 03/02/09 14:13:38.225 - 17/02/09 16:30:10.352
Selected time for report: 03/02/09 14:13:38 - 17/02/09 16:30:10.352
Number of changes in configuration: 0
Number of changes to accounts, groups, or roles: 0
Number of logins: 0
Number of failed logins: 15
Number of authentications: 0
Number of failed authentications: 578
Number of users: 1
Number of terminals: 7
Number of host names: 4
Number of executables: 12
Number of files: 77
Number of AVC's: 0
Number of MAC events: 0
Number of failed syscalls: 994
Number of anomaly events: 0
Number of responses to anomaly events: 0
Number of crypto events: 0
Number of keys: 2
Number of process IDs: 713
Number of events: 1589</pre></div></li><li class="step "><p>
     To list the files that could not be accessed, run a summary report of
     failed file events:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport</code> <code class="option">-f -i --failed --summary</code>

Failed File Summary Report
===========================
total  file
===========================
80  /var
80  spool
80  cron
80  lastrun
46  /usr/lib/locale/en_GB.UTF-8/LC_CTYPE
45  /usr/lib/locale/locale-archive
38  /usr/lib/locale/en_GB.UTF-8/LC_IDENTIFICATION
38  /usr/lib/locale/en_GB.UTF-8/LC_MEASUREMENT
38  /usr/lib/locale/en_GB.UTF-8/LC_TELEPHONE
38  /usr/lib/locale/en_GB.UTF-8/LC_ADDRESS
38  /usr/lib/locale/en_GB.UTF-8/LC_NAME
38  /usr/lib/locale/en_GB.UTF-8/LC_PAPER
38  /usr/lib/locale/en_GB.UTF-8/LC_MESSAGES
38  /usr/lib/locale/en_GB.UTF-8/LC_MONETARY
38  /usr/lib/locale/en_GB.UTF-8/LC_COLLATE
38  /usr/lib/locale/en_GB.UTF-8/LC_TIME
38  /usr/lib/locale/en_GB.UTF-8/LC_NUMERIC
8  /etc/magic.mgc
...</pre></div><p>
     To focus this summary report on a few files or directories of interest
     only, such as <code class="filename">/etc/audit/auditd.conf</code>,
     <code class="filename">/etc/pam.d</code>, and
     <code class="filename">/etc/sysconfig</code>, use a command similar to the
     following:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -f -i --failed --summary |grep -e "/etc/audit/auditd.conf" -e "/etc/pam.d/" -e "/etc/sysconfig"</code>

1  /etc/sysconfig/displaymanager</pre></div></li><li class="step "><p>
     From the summary report, then proceed to isolate these items of
     interest from the log and find out their event IDs for further
     analysis:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">aureport -f -i --failed |grep -e "/etc/audit/auditd.conf" -e "/etc/pam.d/" -e "/etc/sysconfig"</code>

993. 17/02/09 16:47:34 /etc/sysconfig/displaymanager readlink no /bin/vim-normal root 7887
994. 17/02/09 16:48:23 /etc/sysconfig/displaymanager getxattr no /bin/vim-normal root 7889</pre></div></li><li class="step "><p>
     Use the event ID to get a detailed record for each item of interest:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> <code class="command">ausearch -a</code> <em class="replaceable ">7887</em> -i
----
time-&gt;Tue Feb 17 16:48:23 2009
type=PATH msg=audit(1234885703.090:7889): item=0 name="/etc/sysconfig/displaymanager" inode=369282 dev=08:06 mode=0100644 ouid=0 ogid=0 rdev=00:00
type=CWD msg=audit(1234885703.090:7889):  cwd="/root"
type=SYSCALL msg=audit(1234885703.090:7889): arch=c000003e syscall=191 success=no exit=-61 a0=7e1e20 a1=7f90e4cf9187 a2=7fffed5b57d0 a3=84 items=1 ppid=25548 pid=23045 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=1166 comm="vim" exe="/bin/vim-normal" key=(null)</pre></div></li></ol></div></div><div id="idm140712064572544" class="admonition tip normal"><img class="symbol" alt="Tip" title="Tip" src="static/images/icon-tip.png" /><h6>Tip: Focusing on a Certain Time Frame</h6><p>
    If you are interested in events during a particular period of time, trim
    down the reports by using start and end dates and times with your
    <code class="command">aureport</code> commands (<code class="option">-ts</code> and
    <code class="option">-te</code>). For more information, refer to
    <a class="xref" href="#sec.audit.aureport.gen" title="32.5.2. Generating Custom Audit Reports">Section 32.5.2, “Generating Custom Audit Reports”</a>.
   </p></div><p>
   All steps (except for the last one) can be run automatically and would
   easily be scriptable and configured as cron jobs. Any of the
   <code class="literal">--failed --summary</code> reports could be transformed easily
   into a bar chart that plots files versus failed access attempts. For more
   information about visualizing audit report data, refer to
   <a class="xref" href="#sec.audit.viz" title="33.6. Configuring Log Visualization">Section 33.6, “Configuring Log Visualization”</a>.
  </p></div><div class="sect1 " id="sec.audit.viz"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.viz"><span class="number">33.6 </span><span class="name">Configuring Log Visualization</span> <a title="Permalink" class="permalink" href="#sec.audit.viz">#</a></h2></div></div></div><p>
   Using the scripts <code class="command">mkbar</code> and <code class="command">mkgraph</code>
   you can illustrate your audit statistics with various graphs and charts.
   As with any other <code class="command">aureport</code> command, the plotting
   commands are scriptable and can easily be configured to run as cron jobs.
  </p><p>
   <code class="command">mkbar</code> and <code class="command">mkgraph</code> were created by
   Steve Grubb at Red Hat. They are available from
   <a class="link" href="http://people.redhat.com/sgrubb/audit/visualize/" target="_blank">http://people.redhat.com/sgrubb/audit/visualize/</a>.
   Because the current version of audit in <span class="productname"><span class="phrase">openSUSE Leap</span></span> does not ship
   with these scripts, proceed as follows to make them available on your
   system:
  </p><div id="idm140712064560864" class="admonition warning normal"><img class="symbol" alt="Warning" title="Warning" src="static/images/icon-warning.png" /><h6>Warning: Downloaded Content Is Dangerous</h6><p>
    Use <code class="command">mkbar</code> and <code class="command">mkgraph</code> at your own
    risk. Any content downloaded from the Web is potentially dangerous
    to your system, even more so when run with <code class="systemitem">root</code> privileges.
   </p></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
     Download the scripts to <code class="systemitem">root</code>'s <code class="filename">~/bin</code>
     directory:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> wget http://people.redhat.com/sgrubb/audit/visualize/mkbar -O ~/bin/mkbar
<code class="prompt user">tux &gt; </code><code class="command">sudo</code> wget http://people.redhat.com/sgrubb/audit/visualize/mkgraph -O ~/bin/mkgraph</pre></div></li><li class="step "><p>
     Adjust the file permissions to read, write, and execute for
     <code class="systemitem">root</code>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> chmod 744 ~/bin/mk{bar,graph}</pre></div></li></ol></div></div><p>
   To plot summary reports, such as the ones discussed in
   <a class="xref" href="#sec.audit.aurepo" title="33.5. Configuring Audit Reports">Section 33.5, “Configuring Audit Reports”</a>, use the script
   <code class="command">mkbar</code>. Some example commands could look like the
   following:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064548816"><span class="term ">Create a Summary of Events</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -e -i --summary | mkbar events</pre></div></dd><dt id="idm140712064546400"><span class="term ">Create a Summary of File Events</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -f -i --summary | mkbar files</pre></div></dd><dt id="idm140712064544000"><span class="term ">Create a Summary of Login Events</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -l -i --summary | mkbar login</pre></div></dd><dt id="idm140712064541600"><span class="term ">Create a Summary of User Events</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -u -i --summary | mkbar users</pre></div></dd><dt id="idm140712064539200"><span class="term ">Create a Summary of System Call Events</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> aureport -s -i --summary | mkbar syscalls</pre></div></dd></dl></div><p>
   To create a summary chart of failed events of any of the above event
   types, add the <code class="option">--failed</code> option to the respective
   <code class="command">aureport</code> command. To cover a certain period of time
   only, use the <code class="option">-ts</code> and <code class="option">-te</code> options on
   aureport. Any of these commands can be tweaked further by narrowing down
   its scope using grep or egrep and regular expressions. See the comments
   in the <code class="command">mkbar</code> script for an example. Any of the above
   commands produces a PNG file containing a bar chart of the requested
   data.
  </p><p>
   To illustrate the relationship between different kinds of audit objects,
   such as users and system calls, use the script
   <code class="command">mkgraph</code>. Some example commands could look like the
   following:
  </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064532176"><span class="term ">Users versus Executables</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> LC_ALL=C aureport -u -i | awk '/^[0-9]/ { print $4" "$7 }' | sort | uniq | mkgraph users_vs_exec</pre></div></dd><dt id="idm140712064529712"><span class="term ">Users versus Files</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> LC_ALL=C aureport -f -i | awk '/^[0-9]/ { print $8" "$4 }' | sort | uniq | mkgraph users_vs_files</pre></div></dd><dt id="idm140712064527264"><span class="term ">System Calls versus Commands</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> LC_ALL=C aureport -s -i | awk '/^[0-9]/ { print $4" "$6 }' | sort | uniq | mkgraph syscall_vs_com</pre></div></dd><dt id="idm140712064524800"><span class="term ">System Calls versus Files</span></dt><dd><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">tux &gt; </code><code class="command">sudo</code> LC_ALL=C aureport -s -i | awk '/^[0-9]/ { print $5" "$4 }' | sort | uniq | mkgraph | syscall_vs_file</pre></div></dd></dl></div><p>
   Graphs can also be combined to illustrate complex relationships. See the
   comments in the <code class="command">mkgraph</code> script for further information
   and an example. The graphs produced by this script are created in
   PostScript format by default, but you can change the output format by
   changing the <code class="envar">EXT</code> variable in the script from
   <code class="literal">ps</code> to <code class="literal">png</code> or
   <code class="literal">jpg</code>.
  </p></div></div><div class="chapter " id="cha.audit.scenarios"><div class="titlepage"><div><div><h2 class="title"><span class="number">34 </span><span class="name">Introducing an Audit Rule Set</span> <a title="Permalink" class="permalink" href="#cha.audit.scenarios">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>audit_scenarios.xml</li><li><span class="ds-label">ID: </span>cha.audit.scenarios</li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#sec.audit.scenbasic"><span class="number">34.1 </span><span class="name">Adding Basic Audit Configuration Parameters</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenauconf"><span class="number">34.2 </span><span class="name">Adding Watches on Audit Log Files and Configuration Files</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenfs"><span class="number">34.3 </span><span class="name">Monitoring File System Objects</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scensecurity"><span class="number">34.4 </span><span class="name">Monitoring Security Configuration Files and Databases</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenmisc"><span class="number">34.5 </span><span class="name">Monitoring Miscellaneous System Calls</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenipc"><span class="number">34.6 </span><span class="name">Filtering System Call Arguments</span></a></span></dt><dt><span class="sect1"><a href="#sec.audit.scenkeys"><span class="number">34.7 </span><span class="name">Managing Audit Event Records Using Keys</span></a></span></dt></dl></div></div><p>
  The following example configuration illustrates how audit can be used to
  monitor your system. It highlights the most important items that need to
  be audited to cover the list of auditable events specified by Controlled
  Access Protection Profile (CAPP).
 </p><p>
  The example rule set is divided into the following sections:
 </p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>
    Basic audit configuration (see <a class="xref" href="#sec.audit.scenbasic" title="34.1. Adding Basic Audit Configuration Parameters">Section 34.1, “Adding Basic Audit Configuration Parameters”</a>)
   </p></li><li class="listitem "><p>
    Watches on audit log files and configuration files (see
    <a class="xref" href="#sec.audit.scenauconf" title="34.2. Adding Watches on Audit Log Files and Configuration Files">Section 34.2, “Adding Watches on Audit Log Files and Configuration Files”</a>)
   </p></li><li class="listitem "><p>
    Monitoring operations on file system objects (see
    <a class="xref" href="#sec.audit.scenfs" title="34.3. Monitoring File System Objects">Section 34.3, “Monitoring File System Objects”</a>)
   </p></li><li class="listitem "><p>
    Monitoring security databases (see
    <a class="xref" href="#sec.audit.scensecurity" title="34.4. Monitoring Security Configuration Files and Databases">Section 34.4, “Monitoring Security Configuration Files and Databases”</a>)
   </p></li><li class="listitem "><p>
    Monitoring miscellaneous system calls
    (<a class="xref" href="#sec.audit.scenmisc" title="34.5. Monitoring Miscellaneous System Calls">Section 34.5, “Monitoring Miscellaneous System Calls”</a>)
   </p></li><li class="listitem "><p>
    Filtering system call arguments (see
    <a class="xref" href="#sec.audit.scenipc" title="34.6. Filtering System Call Arguments">Section 34.6, “Filtering System Call Arguments”</a>)
   </p></li></ul></div><p>
  To transform this example into a configuration file to use in your live
  setup, proceed as follows:
 </p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>
    Choose the appropriate settings for your setup and adjust them.
   </p></li><li class="step "><p>
    Adjust the file <code class="filename">/etc/audit/audit.rules</code> by adding
    rules from the examples below or by modifying existing rules.
   </p></li></ol></div></div><div id="idm140712064500544" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Adjusting the Level of Audit Logging</h6><p>
   Do not copy the example below into your audit setup without adjusting it
   to your needs. Determine what and to what extent to audit.
  </p></div><p>
  The entire <code class="filename">audit.rules</code> is a collection of
  <code class="command">auditctl</code> commands. Every line in this file expands to a
  full <code class="command">auditctl</code> command line. The syntax used in the rule
  set is the same as that of the <code class="command">auditctl</code> command.
 </p><div class="sect1 " id="sec.audit.scenbasic"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenbasic"><span class="number">34.1 </span><span class="name">Adding Basic Audit Configuration Parameters</span> <a title="Permalink" class="permalink" href="#sec.audit.scenbasic">#</a></h2></div></div></div><div class="verbatim-wrap"><pre class="screen">-D<span id="co.auctld"></span><span class="callout">1</span>
-b 8192<span id="co.auctlb"></span><span class="callout">2</span>
-f 2<span id="co.auctlf"></span><span class="callout">3</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctld"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Delete any preexisting rules before starting to define new ones.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlb"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Set the number of buffers to take the audit messages. Depending on the
     level of audit logging on your system, increase or decrease this
     figure.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlf"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Set the failure flag to use when the kernel needs to handle critical
     errors. Possible values are <code class="literal">0</code> (silent),
     <code class="literal">1</code> (printk, print a failure message), and
     <code class="literal">2</code> (panic, halt the system).
    </p></td></tr></table></div><p>
   By emptying the rule queue with the <code class="option">-D</code> option, you make
   sure that audit does not use any other rule set than what you are
   offering it by means of this file. Choosing an appropriate buffer number
   (<code class="option">-b</code>) is vital to avoid having your system fail because
   of too high an audit load. Choosing the panic failure flag <code class="option">-f
   2</code> ensures that your audit records are complete even if the
   system is encountering critical errors. By shutting down the system on a
   critical error, audit makes sure that no process escapes from its control
   as it otherwise might if level 1 (<code class="option">printk</code>) were chosen.
  </p><div id="idm140712064484736" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Choosing the Failure Flag</h6><p>
    Before using your audit rule set on a live system, make sure that the
    setup has been thoroughly evaluated on test systems using the
    <span class="emphasis"><em>worst case production workload</em></span>. It is even more
    critical that you do this when specifying the <code class="option">-f 2</code>
    flag, because this instructs the kernel to panic (perform an immediate
    halt without flushing pending data to disk) if any thresholds are
    exceeded. Consider the use of the <code class="option">-f 2</code> flag for only
    the most security-conscious environments.
   </p></div></div><div class="sect1 " id="sec.audit.scenauconf"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenauconf"><span class="number">34.2 </span><span class="name">Adding Watches on Audit Log Files and Configuration Files</span> <a title="Permalink" class="permalink" href="#sec.audit.scenauconf">#</a></h2></div></div></div><p>
   Adding watches on your audit configuration files and the log files
   themselves ensures that you can track any attempt to tamper with the
   configuration files or detect any attempted accesses to the log files.
  </p><div id="idm140712064479648" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.png" /><h6>Note: Creating Directory and File Watches</h6><p>
    Creating watches on a directory is not necessarily sufficient if you
    need events for file access. Events on directory access are only
    triggered when the directory's inode is updated with metadata changes.
    To trigger events on file access, add watches for each file
    to monitor.
   </p></div><div class="verbatim-wrap"><pre class="screen">-w /var/log/audit/ <span id="co.auctllog"></span><span class="callout">1</span>
-w /var/log/audit/audit.log

-w /var/log/audit/audit_log.1
-w /var/log/audit/audit_log.2
-w /var/log/audit/audit_log.3
-w /var/log/audit/audit_log.4

-w /etc/audit/auditd.conf -p wa<span id="co.auctlconf"></span><span class="callout">2</span>
-w /etc/audit/audit.rules -p wa
-w /etc/libaudit.conf -p wa</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctllog"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Set a watch on the directory where the audit log is located. Trigger an
     event for any type of access attempt to this directory. If you are
     using log rotation, add watches for the rotated logs as well.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlconf"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Set a watch on an audit configuration file. Log all write and attribute
     change attempts to this file.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.audit.scenfs"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenfs"><span class="number">34.3 </span><span class="name">Monitoring File System Objects</span> <a title="Permalink" class="permalink" href="#sec.audit.scenfs">#</a></h2></div></div></div><p>
   Auditing system calls helps track your system's activity well beyond the
   application level. By tracking file system–related system calls,
   get an idea of how your applications are using these system calls and
   determine whether that use is appropriate. By tracking mount and unmount
   operations, track the use of external resources (removable media, remote
   file systems, etc.).
  </p><div id="idm140712064470704" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Auditing System Calls</h6><p>
    Auditing system calls results in a high logging activity. This activity,
    in turn, puts a heavy load on the kernel. With a kernel less responsive
    than usual, the system's backlog and rate limits might be exceeded.
    Carefully evaluate which system calls to include in your audit rule set
    and adjust the log settings accordingly. See
    <a class="xref" href="#sec.audit.auditd" title="32.2. Configuring the Audit Daemon">Section 32.2, “Configuring the Audit Daemon”</a> for details on how to tweak the
    relevant settings.
   </p></div><div class="verbatim-wrap"><pre class="screen">-a entry,always -S chmod -S fchmod -S chown -S chown32 -S fchown -S fchown32 -S lchown -S lchown32<span id="co.auctlfso"></span><span class="callout">1</span>

-a entry,always -S creat -S open -S truncate -S truncate64 -S ftruncate -S ftruncate64<span id="co.auctlmod"></span><span class="callout">2</span>

-a entry,always -S mkdir -S rmdir<span id="co.auctlfsdir"></span><span class="callout">3</span>

-a entry,always -S unlink -S rename -S link -S symlink<span id="co.auctlfsmov"></span><span class="callout">4</span>

-a entry,always -S setxattr<span id="co.auctlfsea"></span><span class="callout">5</span>
-a entry,always -S lsetxattr
-a entry,always -S fsetxattr
-a entry,always -S removexattr
-a entry,always -S lremovexattr
-a entry,always -S fremovexattr

-a entry,always -S mknod<span id="co.auctlfssf"></span><span class="callout">6</span>

-a entry,always -S mount -S umount -S umount2<span id="co.auctlfsfso"></span><span class="callout">7</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfso"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for system calls related to changing file
     ownership and permissions. Depending on the hardware architecture of
     your system, enable or disable the <code class="literal">*32</code> rules. 64-bit
     systems, like AMD64/Intel 64, require the <code class="literal">*32</code> rules
     to be removed.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlmod"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for system calls related to file content
     modification. Depending on the hardware architecture of your system,
     enable or disable the *64 rules. 64-bit systems, like AMD64/Intel 64,
     require the *64 rules to be removed.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfsdir"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for any directory operation, like creating or
     removing a directory.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfsmov"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for any linking operation, such as creating a
     symbolic link, creating a link, unlinking, or renaming.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfsea"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for any operation related to extended file
     system attributes.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfssf"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for the <code class="command">mknod</code> system call,
     which creates special (device) files.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.auctlfsfso"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
     Enable an audit context for any mount or umount operation. For the
     x86 architecture, disable the <code class="literal">umount</code> rule. For
     the Intel 64 architecture, disable the <code class="literal">umount2</code> rule.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.audit.scensecurity"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scensecurity"><span class="number">34.4 </span><span class="name">Monitoring Security Configuration Files and Databases</span> <a title="Permalink" class="permalink" href="#sec.audit.scensecurity">#</a></h2></div></div></div><p>
   To make sure that your system is not made to do undesired things, track
   any attempts to change the <code class="systemitem">cron</code> and
   <code class="systemitem">at</code> configurations or the lists of scheduled
   jobs. Tracking any write access to the user, group, password and login
   databases and logs helps you identify any attempts to manipulate your
   system's user database.
  </p><p>
   Tracking changes to your system configuration (kernel, services, time,
   etc.) helps you spot any attempts of others to manipulate essential
   functionality of your system. Changes to the PAM configuration should
   also be monitored in a secure environment, because changes in the
   authentication stack should not be made by anyone other than the
   administrator, and it should be logged which applications are using PAM
   and how it is used. The same applies to any other configuration files
   related to secure authentication and communication.
  </p><div class="verbatim-wrap"><pre class="screen"><span id="co.audit.at"></span><span class="callout">1</span>
-w /var/spool/atspool
-w /etc/at.allow
-w /etc/at.deny

-w /etc/cron.allow -p wa
-w /etc/cron.deny -p wa
-w /etc/cron.d/ -p wa
-w /etc/cron.daily/ -p wa
-w /etc/cron.hourly/ -p wa
-w /etc/cron.monthly/ -p wa
-w /etc/cron.weekly/ -p wa
-w /etc/crontab -p wa
-w /var/spool/cron/root

<span id="co.audit.security"></span><span class="callout">2</span>
-w /etc/group -p wa
-w /etc/passwd -p wa
-w /etc/shadow

-w /etc/login.defs -p wa
-w /etc/securetty
-w /var/log/lastlog

<span id="co.audit.nw"></span><span class="callout">3</span>
-w /etc/hosts -p wa
-w /etc/sysconfig/
w /etc/init.d/
w /etc/ld.so.conf -p wa
w /etc/localtime -p wa
w /etc/sysctl.conf -p wa
w /etc/modprobe.d/
w /etc/modprobe.conf.local -p wa
w /etc/modprobe.conf -p wa
<span id="co.audit.pam"></span><span class="callout">4</span>
w /etc/pam.d/
<span id="co.audit.pfix"></span><span class="callout">5</span>
-w /etc/aliases -p wa
-w /etc/postfix/ -p wa

<span id="co.audit.ssh"></span><span class="callout">6</span>
-w /etc/ssh/sshd_config

-w /etc/stunnel/stunnel.conf
-w /etc/stunnel/stunnel.pem

-w /etc/vsftpd.ftpusers
-w /etc/vsftpd.conf

<span id="co.audit.misc"></span><span class="callout">7</span>
-a exit,always -S sethostname
-w /etc/issue -p wa
-w /etc/issue.net -p wa</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.at"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Set watches on the <code class="systemitem">at</code> and
     <code class="systemitem">cron</code> configuration and the scheduled jobs and
     assign labels to these events.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.security"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Set watches on the user, group, password, and login databases and logs
     and set labels to better identify any login-related events, such as
     failed login attempts.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.nw"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Set a watch and a label on the static host name configuration in
     <code class="filename">/etc/hosts</code>. Track changes to the system
     configuration directory, <code class="filename">/etc/sysconfig</code>. Enable
     per-file watches if you are interested in file events. Set watches and
     labels for changes to the boot configuration in

     the <code class="filename">/etc/init.d</code> directory. Enable per-file watches
     if you are interested in file events. Set watches and labels for any
     changes to the linker configuration in
     <code class="filename">/etc/ld.so.conf</code>. Set watches and a label for
     <code class="filename">/etc/localtime</code>. Set watches and labels for the
     kernel configuration files <code class="filename">/etc/sysctl.conf</code>,
     <code class="filename">/etc/modprobe.d/</code>,
     <code class="filename">/etc/modprobe.conf.local</code>, and
     <code class="filename">/etc/modprobe.conf</code>.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.pam"><span class="callout">4</span></a> </p></td><td valign="top" align="left"><p>
     Set watches on the PAM configuration directory. If you are interested
     in particular files below the directory level, add explicit watches to
     these files as well.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.pfix"><span class="callout">5</span></a> </p></td><td valign="top" align="left"><p>
     Set watches to the postfix configuration to log any write attempt or
     attribute change and use labels for better tracking in the logs.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.ssh"><span class="callout">6</span></a> </p></td><td valign="top" align="left"><p>
     Set watches and labels on the SSH,
     <code class="command">stunnel</code>, and <code class="command">vsftpd</code> configuration
     files.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.misc"><span class="callout">7</span></a> </p></td><td valign="top" align="left"><p>
     Perform an audit of the <code class="systemitem">sethostname</code> system call and
     set watches and labels on the system identification configuration in
     <code class="filename">/etc/issue</code> and
     <code class="filename">/etc/issue.net</code>.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.audit.scenmisc"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenmisc"><span class="number">34.5 </span><span class="name">Monitoring Miscellaneous System Calls</span> <a title="Permalink" class="permalink" href="#sec.audit.scenmisc">#</a></h2></div></div></div><p>
   Apart from auditing file system related system calls, as described in
   <a class="xref" href="#sec.audit.scenfs" title="34.3. Monitoring File System Objects">Section 34.3, “Monitoring File System Objects”</a>, you can also track various other
   system calls. Tracking task creation helps you understand your
   applications' behavior. Auditing the <code class="systemitem">umask</code>
   system call lets you track how processes modify creation mask. Tracking
   any attempts to change the system time helps you identify anyone or any
   process trying to manipulate the system time.
  </p><div class="verbatim-wrap"><pre class="screen"><span id="co.audit.attrib"></span><span class="callout">1</span>
-a entry,always -S clone -S fork -S vfork

<span id="co.audit.umask"></span><span class="callout">2</span>
-a entry,always -S umask

<span id="co.audit.time"></span><span class="callout">3</span>
-a entry,always -S adjtimex -S settimeofday</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.attrib"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Track task creation.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.umask"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Add an audit context to the umask system call.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.time"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Track attempts to change the system time. <code class="literal">adjtimex</code>
     can be used to skew the time. <code class="literal">settimeofday</code> sets the
     absolute time.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.audit.scenipc"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenipc"><span class="number">34.6 </span><span class="name">Filtering System Call Arguments</span> <a title="Permalink" class="permalink" href="#sec.audit.scenipc">#</a></h2></div></div></div><p>
   In addition to the system call auditing introduced in
   <a class="xref" href="#sec.audit.scenfs" title="34.3. Monitoring File System Objects">Section 34.3, “Monitoring File System Objects”</a> and
   <a class="xref" href="#sec.audit.scenmisc" title="34.5. Monitoring Miscellaneous System Calls">Section 34.5, “Monitoring Miscellaneous System Calls”</a>, you can track application behavior
   to an even higher degree. Applying filters helps you focus audit on areas
   of primary interest to you. This section introduces filtering system call
   arguments for non-multiplexed system calls like access and for
   multiplexed ones like socketcall or ipc. Whether system calls are
   multiplexed depends on the hardware architecture used. Both socketcall
   and ipc are not multiplexed on 64-bit architectures, such as AMD64/Intel 64.
  </p><div id="idm140712064409728" class="admonition important normal"><img class="symbol" alt="Important" title="Important" src="static/images/icon-important.png" /><h6>Important: Auditing System Calls</h6><p>
    Auditing system calls results in high logging activity, which in turn
    puts a heavy load on the kernel. With a kernel less responsive than
    usual, the system's backlog and rate limits might well be exceeded.
    Carefully evaluate which system calls to include in your audit rule set
    and adjust the log settings accordingly. See
    <a class="xref" href="#sec.audit.auditd" title="32.2. Configuring the Audit Daemon">Section 32.2, “Configuring the Audit Daemon”</a> for details on how to tweak the
    relevant settings.
   </p></div><p>
   The access system call checks whether a process would be allowed to read,
   write or test for the existence of a file or file system object. Using
   the <code class="option">-F</code> filter flag, build rules matching specific access
   calls in the format<code class="option">-F
   a1=<em class="replaceable ">ACCESS_MODE</em></code>. Check
   <code class="filename">/usr/include/fcntl.h</code> for a list of possible
   arguments to the access system call.
  </p><div class="verbatim-wrap"><pre class="screen">-a entry,always -S access -F a1=4<span id="co.audit.accessr"></span><span class="callout">1</span>
-a entry,always -S access -F a1=6<span id="co.audit.accessrw"></span><span class="callout">2</span>
-a entry,always -S access -F a1=7<span id="co.audit.accessrwx"></span><span class="callout">3</span></pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.accessr"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Audit the access system call, but only if the second argument of the
     system call (<code class="literal">mode</code>) is <code class="literal">4</code>
     (<code class="literal">R_OK</code>). This rule filters for all access calls
     testing for sufficient read permissions to a file or file system object
     accessed by a user or process.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.accessrw"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Audit the access system call, but only if the second argument of the
     system call (<code class="literal">mode</code>) is <code class="literal">6</code>, meaning
     <code class="literal">4 OR 2</code>, which translates to <code class="literal">R_OK OR
     W_OK</code>. This rule filters for access calls testing for
     sufficient read and write permissions.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.accessrwx"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Audit the access system call, but only if the second argument of the
     system call (<code class="literal">mode</code>) is <code class="literal">7</code>, meaning
     <code class="literal">4 OR 2 OR 1</code>, which translates to <code class="literal">R_OK OR
     W_OK OR X_OK</code>. This rule filters for access calls testing for
     sufficient read, write, and execute permissions.
    </p></td></tr></table></div><p>
   The socketcall system call is a multiplexed system call. Multiplexed
   means that there is only one system call for all possible calls and that
   libc passes the actual system call to use as the first argument
   (<code class="literal">a0</code>). Check the manual page of socketcall for possible
   system calls and refer to
   <code class="filename">/usr/src/linux/include/linux/net.h</code> for a list of
   possible argument values and system call names. Audit supports filtering
   for specific system calls using a <code class="option">-F
   a0=<em class="replaceable ">SYSCALL_NUMBER</em></code>.
  </p><div class="verbatim-wrap"><pre class="screen">-a entry,always -S socketcall -F a0=1 -F a1=10<span id="co.audit.socket1"></span><span class="callout">1</span>
## Use this line on x86_64, ia64 instead
#-a entry,always -S socket -F a0=10

-a entry,always -S socketcall -F a0=5<span id="co.audit.socket2"></span><span class="callout">2</span>
## Use this line on x86_64, ia64 instead
#-a entry, always -S accept</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.socket1"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Audit the socket(PF_INET6) system call. The <code class="option">-F a0=1</code>
     filter matches all socket system calls and the <code class="option">-F
     a1=10</code> filter narrows the matches down to socket system calls
     carrying the IPv6 protocol family domain parameter (PF_INET6). Check
     <code class="filename">/usr/include/linux/net.h</code> for the first argument
     (<code class="literal">a0</code>) and
     <code class="filename">/usr/src/linux/include/linux/socket.h</code> for the
     second parameter (<code class="literal">a1</code>). 64-bit platforms, like
     AMD64/Intel 64, do not use multiplexing on socketcall system calls. For
     these
     platforms, comment the rule and add the plain system call rules with a
     filter on PF_INET6.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.socket2"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Audit the socketcall system call. The filter flag is set to filter for
     <code class="option">a0=5</code> as the first argument to socketcall, which
     translates to the accept system call if you check
     <code class="filename">/usr/include/linux/net.h</code>. 64-bit platforms, like
     AMD64/Intel 64, do not use multiplexing on socketcall system calls.
     For these platforms, comment the rule and add the plain system call
     rule without argument filtering.
    </p></td></tr></table></div><p>
   The ipc system call is another example of multiplexed system calls. The
   actual call to invoke is determined by the first argument passed to the
   ipc system call. Filtering for these arguments helps you focus on those
   IPC calls of interest to you. Check
   <code class="filename">/usr/include/linux/ipc.h</code> for possible argument
   values.
  </p><div class="verbatim-wrap"><pre class="screen"><span id="co.audit.mqueue"></span><span class="callout">1</span>
## msgctl
-a entry,always -S ipc -F a0=14
## msgget
-a entry,always -S ipc -F a0=13
## Use these lines on x86_64, ia64 instead
#-a entry,always -S msgctl
#-a entry,always -S msgget

<span id="co.audit.semaph"></span><span class="callout">2</span>
## semctl
-a entry,always -S ipc -F a0=3
## semget
-a entry,always -S ipc -F a0=2
## semop
-a entry,always -S ipc -F a0=1
## semtimedop
-a entry,always -S ipc -F a0=4
## Use these lines on x86_64, ia64 instead
#-a entry,always -S semctl
#-a entry,always -S semget
#-a entry,always -S semop
#-a entry,always -S semtimedop

<span id="co.audit.sharedmem"></span><span class="callout">3</span>
## shmctl
-a entry,always -S ipc -F a0=24
## shmget
-a entry,always -S ipc -F a0=23
## Use these lines on x86_64, ia64 instead
#-a entry,always -S shmctl
#-a entry,always -S shmget</pre></div><div class="calloutlist "><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.mqueue"><span class="callout">1</span></a> </p></td><td valign="top" align="left"><p>
     Audit system calls related to IPC SYSV message queues. In this case,
     the <code class="literal">a0</code> values specify that auditing is added for the
     msgctl and msgget system calls (<code class="literal">14</code> and
     <code class="literal">13</code>). 64-bit platforms, like AMD64/Intel 64, do not
     use multiplexing on ipc system calls. For these platforms, comment the
     first two rules and add the plain system call rules without argument
     filtering.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.semaph"><span class="callout">2</span></a> </p></td><td valign="top" align="left"><p>
     Audit system calls related to IPC SYSV message semaphores. In this
     case, the <code class="literal">a0</code> values specify that auditing is added
     for the semctl, semget, semop, and semtimedop system calls
     (<code class="literal">3</code>, <code class="literal">2</code>, <code class="literal">1</code>, and
     <code class="literal">4</code>). 64-bit platforms, like AMD64/Intel 64, do not
     use multiplexing on ipc system calls. For these platforms, comment the
     first four rules and add the plain system call rules without argument
     filtering.
    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#co.audit.sharedmem"><span class="callout">3</span></a> </p></td><td valign="top" align="left"><p>
     Audit system calls related to IPC SYSV shared memory. In this case, the
     <code class="literal">a0</code> values specify that auditing is added for the
     shmctl and shmget system calls (<code class="literal">24</code>,
     <code class="literal">23</code>). 64-bit platforms, like AMD64/Intel 64, do not
     use multiplexing on ipc system calls. For these platforms, comment the
     first two rules and add the plain system call rules without argument
     filtering.
    </p></td></tr></table></div></div><div class="sect1 " id="sec.audit.scenkeys"><div class="titlepage"><div><div><h2 class="title" id="sec.audit.scenkeys"><span class="number">34.7 </span><span class="name">Managing Audit Event Records Using Keys</span> <a title="Permalink" class="permalink" href="#sec.audit.scenkeys">#</a></h2></div></div></div><p>
   After configuring a few rules generating events and populating the logs,
   you need to find a way to tell one event from the other. Using the
   <code class="command">ausearch</code> command, you can filter the logs for various
   criteria. Using <code class="command">ausearch</code> <code class="option">-m
   <em class="replaceable ">MESSAGE_TYPE</em></code>, you can at least filter
   for events of a certain type. However, to be able to filter for events
   related to a particular rule, you need to add a key to this rule in the
   <code class="filename">/etc/audit/audit.rules</code> file. This key is then added
   to the event record every time the rule logs an event. To retrieve these
   log entries, simply run <code class="command">ausearch</code> <code class="option">-k
   <em class="replaceable ">YOUR_KEY</em></code> to get a list of records
   related to the rule carrying this particular key.
  </p><p>
   As an example, assume you have added the following rule to your rule
   file:
  </p><div class="verbatim-wrap"><pre class="screen">-w /etc/audit/audit.rules -p wa</pre></div><p>
   Without a key assigned to it, you would probably need to filter for
   <code class="literal">SYSCALL</code> or <code class="literal">PATH</code> events then use
   grep or similar tools to isolate any events related to the above rule.
   Now, add a key to the above rule, using the <code class="option">-k</code> option:
  </p><div class="verbatim-wrap"><pre class="screen">-w /etc/audit/audit.rules -p wa -k CFG_audit.rules</pre></div><p>
   You can specify any text string as key. Distinguish watches related to
   different types of files (configuration files or log files) from one
   another using different key prefixes (<code class="literal">CFG</code>,
   <code class="literal">LOG</code>, etc.) followed by the file name. Finding any
   records related to the above rule now comes down to the following:
  </p><div class="verbatim-wrap"><pre class="screen"><code class="command">ausearch -k CFG_audit.rules</code>
----
time-&gt;Thu Feb 19 09:09:54 2009
type=PATH msg=audit(1235030994.032:8649): item=3 name="audit.rules~" inode=370603 dev=08:06 mode=0100640 ouid=0 ogid=0 rdev=00:00
type=PATH msg=audit(1235030994.032:8649): item=2 name="audit.rules" inode=370603 dev=08:06 mode=0100640 ouid=0 ogid=0 rdev=00:00
type=PATH msg=audit(1235030994.032:8649): item=1  name="/etc/audit" inode=368599 dev=08:06 mode=040750 ouid=0 ogid=0 rdev=00:00
type=PATH msg=audit(1235030994.032:8649): item=0  name="/etc/audit" inode=368599 dev=08:06 mode=040750 ouid=0 ogid=0 rdev=00:00
type=CWD msg=audit(1235030994.032:8649):  cwd="/etc/audit"
type=SYSCALL msg=audit(1235030994.032:8649): arch=c000003e syscall=82 success=yes exit=0 a0=7deeb0 a1=883b30 a2=2 a3=ffffffffffffffff items=4 ppid=25400 pid=32619 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts1 ses=1164 comm="vim" exe="/bin/vim-normal" key="CFG_audit.rules"</pre></div></div></div><div class="chapter " id="cha.audit.moreinfo"><div class="titlepage"><div><div><h2 class="title"><span class="number">35 </span><span class="name">Useful Resources</span> <a title="Permalink" class="permalink" href="#cha.audit.moreinfo">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>audit_moreinfo.xml</li><li><span class="ds-label">ID: </span>cha.audit.moreinfo</li></ul></div></div></div></div><div class="line"></div><p>
  There are other resources available containing valuable information about
  the Linux audit framework:
 </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064350208"><span class="term ">The Audit Manual Pages</span></dt><dd><p>
     There are several man pages installed along with the audit tools that
     provide valuable and very detailed information:
    </p><div class="variablelist "><dl class="variablelist"><dt id="idm140712064348336"><span class="term "><code class="literal">auditd(8)</code>
      </span></dt><dd><p>
        The Linux audit daemon
       </p></dd><dt id="idm140712064346240"><span class="term "><code class="literal">auditd.conf(5)</code>
      </span></dt><dd><p>
        The Linux audit daemon configuration file
       </p></dd><dt id="idm140712064344112"><span class="term "><code class="literal">auditctl(8)</code>
      </span></dt><dd><p>
        A utility to assist controlling the kernel's audit system
       </p></dd><dt id="idm140712064341968"><span class="term "><code class="literal">autrace(8)</code>
      </span></dt><dd><p>
        A program similar to strace
       </p></dd><dt id="idm140712064339856"><span class="term "><code class="literal">ausearch(8)</code>
      </span></dt><dd><p>
        A tool to query audit daemon logs
       </p></dd><dt id="idm140712064337744"><span class="term "><code class="literal">aureport(8)</code>
      </span></dt><dd><p>
        A tool that produces summary reports of audit daemon logs
       </p></dd><dt id="idm140712064335600"><span class="term "><code class="literal">audispd.conf(5)</code>
      </span></dt><dd><p>
        The audit event dispatcher configuration file
       </p></dd><dt id="idm140712064333472"><span class="term "><code class="literal">audispd(8)</code>
      </span></dt><dd><p>
        The audit event dispatcher daemon talking to plug-in programs.
       </p></dd></dl></div></dd><dt id="idm140712064330848"><span class="term "><a class="link" href="http://people.redhat.com/sgrubb/audit/index.html" target="_blank">http://people.redhat.com/sgrubb/audit/index.html</a>
   </span></dt><dd><p>
     The home page of the Linux audit project. This site contains several
     specifications relating to different aspects of Linux audit, and
     a short FAQ.
    </p></dd><dt id="idm140712064328480"><span class="term "><code class="filename">/usr/share/doc/packages/audit </code>
   </span></dt><dd><p>
     The audit package itself contains a README with basic design
     information and sample <code class="filename">.rules </code> files for different
     scenarios:
    </p><table border="0" summary="Simple list" class="simplelist "><tr><td><code class="filename">capp.rules</code>: Controlled Access Protection Profile (CAPP)</td></tr><tr><td><code class="filename">lspp.rules</code>: Labeled Security Protection Profile (LSPP)</td></tr><tr><td><code class="filename">nispom.rules</code>: National Industrial Security Program Operating
      Manual Chapter 8(NISPOM)</td></tr><tr><td><code class="filename">stig.rules</code>: Secure Technical Implementation Guide (STIG)</td></tr></table></dd><dt id="idm140712064322272"><span class="term "><a class="link" href="http://www.commoncriteriaportal.org/" target="_blank">http://www.commoncriteriaportal.org/</a>
   </span></dt><dd><p>
     The official Web site of the Common Criteria project. Learn all about
     the Common Criteria security certification initiative and which role
     audit plays in this framework.
    </p></dd></dl></div></div></div><div class="legal-section"><div class="appendix " id="idm140712064319152"><div class="titlepage"><div><div><h1 class="title"><span class="number">A </span><span class="name">GNU Licenses</span> <a title="Permalink" class="permalink" href="#idm140712064319152">#</a></h1><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>common_legal.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="#idm140712064314512"><span class="number">A.1 </span><span class="name">GNU Free Documentation License</span></a></span></dt></dl></div></div><p>
  This appendix contains the GNU Free Documentation License version 1.2.
 </p><div class="sect1 " id="idm140712064314512"><div class="titlepage"><div><div><h2 class="title legal" id="idm140712064314512"><span class="name">GNU Free Documentation License</span> <a title="Permalink" class="permalink" href="#idm140712064314512">#</a></h2><div class="doc-status"><ul><li><span class="ds-label">Filename: </span>common_gfdl1.2_i.xml</li><li><span class="ds-label">ID: </span><span class="ds-message">no ID found</span></li></ul></div></div></div></div><p>
  Copyright (C) 2000, 2001, 2002 Free Software Foundation, Inc. 51 Franklin St,
  Fifth Floor, Boston, MA 02110-1301 USA. Everyone is permitted to copy and
  distribute verbatim copies of this license document, but changing it is not
  allowed.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064310992"><span class="name">
    0. PREAMBLE
  </span><a title="Permalink" class="permalink" href="#idm140712064310992">#</a></h5></div><p>
  The purpose of this License is to make a manual, textbook, or other
  functional and useful document "free" in the sense of freedom: to assure
  everyone the effective freedom to copy and redistribute it, with or without
  modifying it, either commercially or non-commercially. Secondarily, this
  License preserves for the author and publisher a way to get credit for their
  work, while not being considered responsible for modifications made by
  others.
 </p><p>
  This License is a kind of "copyleft", which means that derivative works of
  the document must themselves be free in the same sense. It complements the
  GNU General Public License, which is a copyleft license designed for free
  software.
 </p><p>
  We have designed this License to use it for manuals for free software,
  because free software needs free documentation: a free program should come
  with manuals providing the same freedoms that the software does. But this
  License is not limited to software manuals; it can be used for any textual
  work, regardless of subject matter or whether it is published as a printed
  book. We recommend this License principally for works whose purpose is
  instruction or reference.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064307792"><span class="name">
    1. APPLICABILITY AND DEFINITIONS
  </span><a title="Permalink" class="permalink" href="#idm140712064307792">#</a></h5></div><p>
  This License applies to any manual or other work, in any medium, that
  contains a notice placed by the copyright holder saying it can be distributed
  under the terms of this License. Such a notice grants a world-wide,
  royalty-free license, unlimited in duration, to use that work under the
  conditions stated herein. The "Document", below, refers to any such manual or
  work. Any member of the public is a licensee, and is addressed as "you". You
  accept the license if you copy, modify or distribute the work in a way
  requiring permission under copyright law.
 </p><p>
  A "Modified Version" of the Document means any work containing the Document
  or a portion of it, either copied verbatim, or with modifications and/or
  translated into another language.
 </p><p>
  A "Secondary Section" is a named appendix or a front-matter section of the
  Document that deals exclusively with the relationship of the publishers or
  authors of the Document to the Document's overall subject (or to related
  matters) and contains nothing that could fall directly within that overall
  subject. (Thus, if the Document is in part a textbook of mathematics, a
  Secondary Section may not explain any mathematics.) The relationship could be
  a matter of historical connection with the subject or with related matters,
  or of legal, commercial, philosophical, ethical or political position
  regarding them.
 </p><p>
  The "Invariant Sections" are certain Secondary Sections whose titles are
  designated, as being those of Invariant Sections, in the notice that says
  that the Document is released under this License. If a section does not fit
  the above definition of Secondary then it is not allowed to be designated as
  Invariant. The Document may contain zero Invariant Sections. If the Document
  does not identify any Invariant Sections then there are none.
 </p><p>
  The "Cover Texts" are certain short passages of text that are listed, as
  Front-Cover Texts or Back-Cover Texts, in the notice that says that the
  Document is released under this License. A Front-Cover Text may be at most 5
  words, and a Back-Cover Text may be at most 25 words.
 </p><p>
  A "Transparent" copy of the Document means a machine-readable copy,
  represented in a format whose specification is available to the general
  public, that is suitable for revising the document straightforwardly with
  generic text editors or (for images composed of pixels) generic paint
  programs or (for drawings) some widely available drawing editor, and that is
  suitable for input to text formatters or for automatic translation to a
  variety of formats suitable for input to text formatters. A copy made in an
  otherwise Transparent file format whose markup, or absence of markup, has
  been arranged to thwart or discourage subsequent modification by readers is
  not Transparent. An image format is not Transparent if used for any
  substantial amount of text. A copy that is not "Transparent" is called
  "Opaque".
 </p><p>
  Examples of suitable formats for Transparent copies include plain ASCII
  without markup, Texinfo input format, LaTeX input format, SGML or XML using a
  publicly available DTD, and standard-conforming simple HTML, PostScript or
  PDF designed for human modification. Examples of transparent image formats
  include PNG, XCF and JPG. Opaque formats include proprietary formats that can
  be read and edited only by proprietary word processors, SGML or XML for which
  the DTD and/or processing tools are not generally available, and the
  machine-generated HTML, PostScript or PDF produced by some word processors
  for output purposes only.
 </p><p>
  The "Title Page" means, for a printed book, the title page itself, plus such
  following pages as are needed to hold, legibly, the material this License
  requires to appear in the title page. For works in formats which do not have
  any title page as such, "Title Page" means the text near the most prominent
  appearance of the work's title, preceding the beginning of the body of the
  text.
 </p><p>
  A section "Entitled XYZ" means a named subunit of the Document whose title
  either is precisely XYZ or contains XYZ in parentheses following text that
  translates XYZ in another language. (Here XYZ stands for a specific section
  name mentioned below, such as "Acknowledgements", "Dedications",
  "Endorsements", or "History".) To "Preserve the Title" of such a section when
  you modify the Document means that it remains a section "Entitled XYZ"
  according to this definition.
 </p><p>
  The Document may include Warranty Disclaimers next to the notice which states
  that this License applies to the Document. These Warranty Disclaimers are
  considered to be included by reference in this License, but only as regards
  disclaiming warranties: any other implication that these Warranty Disclaimers
  may have is void and has no effect on the meaning of this License.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064297856"><span class="name">
    2. VERBATIM COPYING
  </span><a title="Permalink" class="permalink" href="#idm140712064297856">#</a></h5></div><p>
  You may copy and distribute the Document in any medium, either commercially
  or non-commercially, provided that this License, the copyright notices, and
  the license notice saying this License applies to the Document are reproduced
  in all copies, and that you add no other conditions whatsoever to those of
  this License. You may not use technical measures to obstruct or control the
  reading or further copying of the copies you make or distribute. However, you
  may accept compensation in exchange for copies. If you distribute a large
  enough number of copies you must also follow the conditions in section 3.
 </p><p>
  You may also lend copies, under the same conditions stated above, and you may
  publicly display copies.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064295520"><span class="name">
    3. COPYING IN QUANTITY
  </span><a title="Permalink" class="permalink" href="#idm140712064295520">#</a></h5></div><p>
  If you publish printed copies (or copies in media that commonly have printed
  covers) of the Document, numbering more than 100, and the Document's license
  notice requires Cover Texts, you must enclose the copies in covers that
  carry, clearly and legibly, all these Cover Texts: Front-Cover Texts on the
  front cover, and Back-Cover Texts on the back cover. Both covers must also
  clearly and legibly identify you as the publisher of these copies. The front
  cover must present the full title with all words of the title equally
  prominent and visible. You may add other material on the covers in addition.
  Copying with changes limited to the covers, as long as they preserve the
  title of the Document and satisfy these conditions, can be treated as
  verbatim copying in other respects.
 </p><p>
  If the required texts for either cover are too voluminous to fit legibly, you
  should put the first ones listed (as many as fit reasonably) on the actual
  cover, and continue the rest onto adjacent pages.
 </p><p>
  If you publish or distribute Opaque copies of the Document numbering more
  than 100, you must either include a machine-readable Transparent copy along
  with each Opaque copy, or state in or with each Opaque copy a
  computer-network location from which the general network-using public has
  access to download using public-standard network protocols a complete
  Transparent copy of the Document, free of added material. If you use the
  latter option, you must take reasonably prudent steps, when you begin
  distribution of Opaque copies in quantity, to ensure that this Transparent
  copy will remain thus accessible at the stated location until at least one
  year after the last time you distribute an Opaque copy (directly or through
  your agents or retailers) of that edition to the public.
 </p><p>
  It is requested, but not required, that you contact the authors of the
  Document well before redistributing any large number of copies, to give them
  a chance to provide you with an updated version of the Document.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064291024"><span class="name">
    4. MODIFICATIONS
  </span><a title="Permalink" class="permalink" href="#idm140712064291024">#</a></h5></div><p>
  You may copy and distribute a Modified Version of the Document under the
  conditions of sections 2 and 3 above, provided that you release the Modified
  Version under precisely this License, with the Modified Version filling the
  role of the Document, thus licensing distribution and modification of the
  Modified Version to whoever possesses a copy of it. In addition, you must do
  these things in the Modified Version:
 </p><div class="orderedlist "><ol class="orderedlist" type="A"><li class="listitem "><p>
    Use in the Title Page (and on the covers, if any) a title distinct from
    that of the Document, and from those of previous versions (which should, if
    there were any, be listed in the History section of the Document). You may
    use the same title as a previous version if the original publisher of that
    version gives permission.
   </p></li><li class="listitem "><p>
    List on the Title Page, as authors, one or more persons or entities
    responsible for authorship of the modifications in the Modified Version,
    together with at least five of the principal authors of the Document (all
    of its principal authors, if it has fewer than five), unless they release
    you from this requirement.
   </p></li><li class="listitem "><p>
    State on the Title page the name of the publisher of the Modified Version,
    as the publisher.
   </p></li><li class="listitem "><p>
    Preserve all the copyright notices of the Document.
   </p></li><li class="listitem "><p>
    Add an appropriate copyright notice for your modifications adjacent to the
    other copyright notices.
   </p></li><li class="listitem "><p>
    Include, immediately after the copyright notices, a license notice giving
    the public permission to use the Modified Version under the terms of this
    License, in the form shown in the Addendum below.
   </p></li><li class="listitem "><p>
    Preserve in that license notice the full lists of Invariant Sections and
    required Cover Texts given in the Document's license notice.
   </p></li><li class="listitem "><p>
    Include an unaltered copy of this License.
   </p></li><li class="listitem "><p>
    Preserve the section Entitled "History", Preserve its Title, and add to it
    an item stating at least the title, year, new authors, and publisher of the
    Modified Version as given on the Title Page. If there is no section
    Entitled "History" in the Document, create one stating the title, year,
    authors, and publisher of the Document as given on its Title Page, then add
    an item describing the Modified Version as stated in the previous sentence.
   </p></li><li class="listitem "><p>
    Preserve the network location, if any, given in the Document for public
    access to a Transparent copy of the Document, and likewise the network
    locations given in the Document for previous versions it was based on.
    These may be placed in the "History" section. You may omit a network
    location for a work that was published at least four years before the
    Document itself, or if the original publisher of the version it refers to
    gives permission.
   </p></li><li class="listitem "><p>
    For any section Entitled "Acknowledgements" or "Dedications", Preserve the
    Title of the section, and preserve in the section all the substance and
    tone of each of the contributor acknowledgements and/or dedications given
    therein.
   </p></li><li class="listitem "><p>
    Preserve all the Invariant Sections of the Document, unaltered in their
    text and in their titles. Section numbers or the equivalent are not
    considered part of the section titles.
   </p></li><li class="listitem "><p>
    Delete any section Entitled "Endorsements". Such a section may not be
    included in the Modified Version.
   </p></li><li class="listitem "><p>
    Do not retitle any existing section to be Entitled "Endorsements" or to
    conflict in title with any Invariant Section.
   </p></li><li class="listitem "><p>
    Preserve any Warranty Disclaimers.
   </p></li></ol></div><p>
  If the Modified Version includes new front-matter sections or appendices that
  qualify as Secondary Sections and contain no material copied from the
  Document, you may at your option designate some or all of these sections as
  invariant. To do this, add their titles to the list of Invariant Sections in
  the Modified Version's license notice. These titles must be distinct from any
  other section titles.
 </p><p>
  You may add a section Entitled "Endorsements", provided it contains nothing
  but endorsements of your Modified Version by various parties--for example,
  statements of peer review or that the text has been approved by an
  organization as the authoritative definition of a standard.
 </p><p>
  You may add a passage of up to five words as a Front-Cover Text, and a
  passage of up to 25 words as a Back-Cover Text, to the end of the list of
  Cover Texts in the Modified Version. Only one passage of Front-Cover Text and
  one of Back-Cover Text may be added by (or through arrangements made by) any
  one entity. If the Document already includes a cover text for the same cover,
  previously added by you or by arrangement made by the same entity you are
  acting on behalf of, you may not add another; but you may replace the old
  one, on explicit permission from the previous publisher that added the old
  one.
 </p><p>
  The author(s) and publisher(s) of the Document do not by this License give
  permission to use their names for publicity for or to assert or imply
  endorsement of any Modified Version.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064268928"><span class="name">
    5. COMBINING DOCUMENTS
  </span><a title="Permalink" class="permalink" href="#idm140712064268928">#</a></h5></div><p>
  You may combine the Document with other documents released under this
  License, under the terms defined in section 4 above for modified versions,
  provided that you include in the combination all of the Invariant Sections of
  all of the original documents, unmodified, and list them all as Invariant
  Sections of your combined work in its license notice, and that you preserve
  all their Warranty Disclaimers.
 </p><p>
  The combined work need only contain one copy of this License, and multiple
  identical Invariant Sections may be replaced with a single copy. If there are
  multiple Invariant Sections with the same name but different contents, make
  the title of each such section unique by adding at the end of it, in
  parentheses, the name of the original author or publisher of that section if
  known, or else a unique number. Make the same adjustment to the section
  titles in the list of Invariant Sections in the license notice of the
  combined work.
 </p><p>
  In the combination, you must combine any sections Entitled "History" in the
  various original documents, forming one section Entitled "History"; likewise
  combine any sections Entitled "Acknowledgements", and any sections Entitled
  "Dedications". You must delete all sections Entitled "Endorsements".
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064265632"><span class="name">
    6. COLLECTIONS OF DOCUMENTS
  </span><a title="Permalink" class="permalink" href="#idm140712064265632">#</a></h5></div><p>
  You may make a collection consisting of the Document and other documents
  released under this License, and replace the individual copies of this
  License in the various documents with a single copy that is included in the
  collection, provided that you follow the rules of this License for verbatim
  copying of each of the documents in all other respects.
 </p><p>
  You may extract a single document from such a collection, and distribute it
  individually under this License, provided you insert a copy of this License
  into the extracted document, and follow this License in all other respects
  regarding verbatim copying of that document.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064263376"><span class="name">
    7. AGGREGATION WITH INDEPENDENT WORKS
  </span><a title="Permalink" class="permalink" href="#idm140712064263376">#</a></h5></div><p>
  A compilation of the Document or its derivatives with other separate and
  independent documents or works, in or on a volume of a storage or
  distribution medium, is called an "aggregate" if the copyright resulting from
  the compilation is not used to limit the legal rights of the compilation's
  users beyond what the individual works permit. When the Document is included
  in an aggregate, this License does not apply to the other works in the
  aggregate which are not themselves derivative works of the Document.
 </p><p>
  If the Cover Text requirement of section 3 is applicable to these copies of
  the Document, then if the Document is less than one half of the entire
  aggregate, the Document's Cover Texts may be placed on covers that bracket
  the Document within the aggregate, or the electronic equivalent of covers if
  the Document is in electronic form. Otherwise they must appear on printed
  covers that bracket the whole aggregate.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064260800"><span class="name">
    8. TRANSLATION
  </span><a title="Permalink" class="permalink" href="#idm140712064260800">#</a></h5></div><p>
  Translation is considered a kind of modification, so you may distribute
  translations of the Document under the terms of section 4. Replacing
  Invariant Sections with translations requires special permission from their
  copyright holders, but you may include translations of some or all Invariant
  Sections in addition to the original versions of these Invariant Sections.
  You may include a translation of this License, and all the license notices in
  the Document, and any Warranty Disclaimers, provided that you also include
  the original English version of this License and the original versions of
  those notices and disclaimers. In case of a disagreement between the
  translation and the original version of this License or a notice or
  disclaimer, the original version will prevail.
 </p><p>
  If a section in the Document is Entitled "Acknowledgements", "Dedications",
  or "History", the requirement (section 4) to Preserve its Title (section 1)
  will typically require changing the actual title.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064258208"><span class="name">
    9. TERMINATION
  </span><a title="Permalink" class="permalink" href="#idm140712064258208">#</a></h5></div><p>
  You may not copy, modify, sublicense, or distribute the Document except as
  expressly provided for under this License. Any other attempt to copy, modify,
  sublicense or distribute the Document is void, and will automatically
  terminate your rights under this License. However, parties who have received
  copies, or rights, from you under this License will not have their licenses
  terminated so long as such parties remain in full compliance.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064256608"><span class="name">
    10. FUTURE REVISIONS OF THIS LICENSE
  </span><a title="Permalink" class="permalink" href="#idm140712064256608">#</a></h5></div><p>
  The Free Software Foundation may publish new, revised versions of the GNU
  Free Documentation License from time to time. Such new versions will be
  similar in spirit to the present version, but may differ in detail to address
  new problems or concerns. See
  <a class="link" href="http://www.gnu.org/copyleft/" target="_blank">http://www.gnu.org/copyleft/</a>.
 </p><p>
  Each version of the License is given a distinguishing version number. If the
  Document specifies that a particular numbered version of this License "or any
  later version" applies to it, you have the option of following the terms and
  conditions either of that specified version or of any later version that has
  been published (not as a draft) by the Free Software Foundation. If the
  Document does not specify a version number of this License, you may choose
  any version ever published (not as a draft) by the Free Software Foundation.
 </p><div class="sect4 bridgehead"><h5 class="title legal" id="idm140712064253424"><span class="name">
    ADDENDUM: How to use this License for your documents
  </span><a title="Permalink" class="permalink" href="#idm140712064253424">#</a></h5></div><div class="verbatim-wrap"><pre class="screen">Copyright (c) YEAR YOUR NAME.
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.2
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
A copy of the license is included in the section entitled “GNU
Free Documentation License”.</pre></div><p>
  If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts,
  replace the “with...Texts.” line with this:
 </p><div class="verbatim-wrap"><pre class="screen">with the Invariant Sections being LIST THEIR TITLES, with the
Front-Cover Texts being LIST, and with the Back-Cover Texts being LIST.</pre></div><p>
  If you have Invariant Sections without Cover Texts, or some other combination
  of the three, merge those two alternatives to suit the situation.
 </p><p>
  If your document contains nontrivial examples of program code, we recommend
  releasing these examples in parallel under your choice of free software
  license, such as the GNU General Public License, to permit their use in free
  software.
 </p></div></div></div></div></div><div class="page-bottom"><div id="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span id="_share-fb" class="bottom-button">Facebook</span><span class="spacer"> • </span><span id="_share-gp" class="bottom-button">Google+</span><span class="spacer"> • </span><span id="_share-tw" class="bottom-button">Twitter</span></span></div><div class="print"><span id="_print-button" class="bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2018 
        SUSE</p></div></div></body></html>